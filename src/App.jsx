/**
 * ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
 * ‚ïë                              SENTENCIFY AI - √çNDICE DO C√ìDIGO                          ‚ïë
 * ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
 * ‚ïë SE√á√ÉO                                    ‚îÇ LINHAS          ‚îÇ DESCRI√á√ÉO                 ‚ïë
 * ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
 * ‚ïë 1. IMPORTS & CONFIG                      ‚îÇ 1-390           ‚îÇ React, Lucide, constantes ‚ïë
 * ‚ïë    ‚îî‚îÄ APP_VERSION                        ‚îÇ ~141            ‚îÇ Vers√£o atual da app       ‚ïë
 * ‚ïë    ‚îî‚îÄ CHANGELOG                          ‚îÇ src/constants/  ‚îÇ Movido para arquivo separ.‚ïë
 * ‚ïë    ‚îî‚îÄ CSS (classes utilit√°rias)          ‚îÇ 285-330         ‚îÇ Tailwind helpers          ‚ïë
 * ‚ïë                                          ‚îÇ                 ‚îÇ                           ‚ïë
 * ‚ïë 2. UTILIT√ÅRIOS & SERVI√áOS                ‚îÇ 390-1325        ‚îÇ IA Local, Embeddings      ‚ïë
 * ‚ïë    ‚îî‚îÄ AIModelService                     ‚îÇ 460-765         ‚îÇ NER/E5 Web Worker         ‚ïë
 * ‚ïë    ‚îî‚îÄ EmbeddingsService                  ‚îÇ 765-910         ‚îÇ IndexedDB legisla√ß√£o      ‚ïë
 * ‚ïë    ‚îî‚îÄ JurisEmbeddingsService             ‚îÇ 930-1050        ‚îÇ IndexedDB jurisprud√™ncia  ‚ïë
 * ‚ïë    ‚îî‚îÄ EmbeddingsCDNService               ‚îÇ 1050-1140       ‚îÇ Download GitHub CDN       ‚ïë
 * ‚ïë                                          ‚îÇ                 ‚îÇ                           ‚ïë
 * ‚ïë 3. HOOKS CUSTOMIZADOS                    ‚îÇ 1325-8170       ‚îÇ 21 hooks React            ‚ïë
 * ‚ïë    ‚îî‚îÄ useModalManager                    ‚îÇ 1330-1390       ‚îÇ Controle de modais        ‚ïë
 * ‚ïë    ‚îî‚îÄ useAIIntegration                   ‚îÇ 1424-2300       ‚îÇ Claude/Gemini API         ‚ïë
 * ‚ïë    ‚îî‚îÄ useIndexedDB                       ‚îÇ 2750-3165       ‚îÇ Persist√™ncia modelos      ‚ïë
 * ‚ïë    ‚îî‚îÄ usePrimaryTabLock                  ‚îÇ 3165-3525       ‚îÇ Sincroniza√ß√£o abas        ‚ïë
 * ‚ïë    ‚îî‚îÄ useFieldVersioning                 ‚îÇ 3625-3700       ‚îÇ Hist√≥rico de vers√µes      ‚ïë
 * ‚ïë    ‚îî‚îÄ useLocalStorage                    ‚îÇ 3700-4680       ‚îÇ Sess√£o (980 linhas)       ‚ïë
 * ‚ïë    ‚îî‚îÄ useModelLibrary                    ‚îÇ 4680-5375       ‚îÇ CRUD modelos              ‚ïë
 * ‚ïë    ‚îî‚îÄ useProofManager                    ‚îÇ 5615-6000       ‚îÇ Gest√£o de provas          ‚ïë
 * ‚ïë    ‚îî‚îÄ useDocumentManager                 ‚îÇ 6000-6390       ‚îÇ Upload documentos         ‚ïë
 * ‚ïë    ‚îî‚îÄ useTopicManager                    ‚îÇ 6390-6575       ‚îÇ CRUD t√≥picos              ‚ïë
 * ‚ïë    ‚îî‚îÄ useChatAssistant                   ‚îÇ 6575-6690       ‚îÇ Chat interativo           ‚ïë
 * ‚ïë    ‚îî‚îÄ useJurisprudencia                  ‚îÇ 6690-6820       ‚îÇ Busca precedentes         ‚ïë
 * ‚ïë    ‚îî‚îÄ useLegislacao                      ‚îÇ 6820-8170       ‚îÇ 7000+ artigos             ‚ïë
 * ‚ïë                                          ‚îÇ                 ‚îÇ                           ‚ïë
 * ‚ïë 4. COMPONENTES DE UI                     ‚îÇ 8170-9835       ‚îÇ VirtualList, Modais base  ‚ïë
 * ‚ïë    ‚îî‚îÄ VirtualList                        ‚îÇ 8178-8264       ‚îÇ Scroll virtualizado       ‚ïë
 * ‚ïë    ‚îî‚îÄ JurisprudenciaModalContent         ‚îÇ 8930-9355       ‚îÇ Modal de jurisprud√™ncia   ‚ïë
 * ‚ïë    ‚îî‚îÄ LegislacaoModalContent             ‚îÇ 9360-9640       ‚îÇ Modal de legisla√ß√£o       ‚ïë
 * ‚ïë    ‚îî‚îÄ BaseModal                          ‚îÇ 9838-9990       ‚îÇ Template de modal         ‚ïë
 * ‚ïë                                          ‚îÇ                 ‚îÇ                           ‚ïë
 * ‚ïë 5. MODAIS ESPEC√çFICOS                    ‚îÇ 9835-16450      ‚îÇ ~50 modais da aplica√ß√£o   ‚ïë
 * ‚ïë    ‚îî‚îÄ RenameTopicModal                   ‚îÇ 9991            ‚îÇ Renomear t√≥pico           ‚ïë
 * ‚ïë    ‚îî‚îÄ DeleteTopicModal                   ‚îÇ 10021           ‚îÇ Excluir t√≥pico            ‚ïë
 * ‚ïë    ‚îî‚îÄ GlobalEditorModal                  ‚îÇ ~12555          ‚îÇ Editor em tela cheia      ‚ïë
 * ‚ïë    ‚îî‚îÄ ConfigModal                        ‚îÇ ~14055          ‚îÇ Configura√ß√µes IA          ‚ïë
 * ‚ïë                                          ‚îÇ                 ‚îÇ                           ‚ïë
 * ‚ïë 6. QUILL EDITOR                          ‚îÇ 16450-17530     ‚îÇ Rich text editor          ‚ïë
 * ‚ïë    ‚îî‚îÄ QuillEditorBase                    ‚îÇ 16609-16881     ‚îÇ Editor base               ‚ïë
 * ‚ïë    ‚îî‚îÄ QuillModelEditor                   ‚îÇ 16884-17009     ‚îÇ Editor de modelos         ‚ïë
 * ‚ïë    ‚îî‚îÄ QuillDecisionEditor                ‚îÇ 17013-17349     ‚îÇ Editor de fundamenta√ß√£o   ‚ïë
 * ‚ïë    ‚îî‚îÄ QuillMiniRelatorioEditor           ‚îÇ 17448-17521     ‚îÇ Editor mini-relat√≥rio     ‚ïë
 * ‚ïë                                          ‚îÇ                 ‚îÇ                           ‚ïë
 * ‚ïë 7. AI_PROMPTS                            ‚îÇ src/prompts/    ‚îÇ Movido para arquivo separ.‚ïë
 * ‚ïë    ‚îî‚îÄ AI_INSTRUCTIONS                    ‚îÇ system.js       ‚îÇ System prompt para LLM    ‚ïë
 * ‚ïë    ‚îî‚îÄ AI_PROMPTS (object)                ‚îÇ ai-prompts.js   ‚îÇ 20+ prompts estruturados  ‚ïë
 * ‚ïë                                          ‚îÇ                 ‚îÇ                           ‚ïë
 * ‚ïë 8. LEGALDECISIONEDITOR                   ‚îÇ 18425-33700     ‚îÇ Componente principal      ‚ïë
 * ‚ïë    ‚îî‚îÄ reorderTopicsViaLLM                ‚îÇ 22449           ‚îÇ Ordena√ß√£o IA (Art.337)    ‚ïë
 * ‚ïë    ‚îî‚îÄ handleAnalyzeDocuments             ‚îÇ 25045           ‚îÇ An√°lise inicial           ‚ïë
 * ‚ïë    ‚îî‚îÄ analyzeProof                       ‚îÇ 25828           ‚îÇ An√°lise de provas         ‚ïë
 * ‚ïë    ‚îî‚îÄ generateDispositivo                ‚îÇ 26921           ‚îÇ Gerar dispositivo         ‚ïë
 * ‚ïë                                          ‚îÇ                 ‚îÇ                           ‚ïë
 * ‚ïë 9. ERROR BOUNDARY & EXPORT               ‚îÇ 33700-33959     ‚îÇ Tratamento de erros       ‚ïë
 * ‚ïë    ‚îî‚îÄ SentencifyAI (ErrorBoundary)       ‚îÇ 33700           ‚îÇ Wrapper com fallback      ‚ïë
 * ‚ïë    ‚îî‚îÄ export default                     ‚îÇ 33959           ‚îÇ Exporta√ß√£o do componente  ‚ïë
 * ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
 *
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * FLUXOS CR√çTICOS (para navega√ß√£o r√°pida)
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *
 * üìÑ AN√ÅLISE INICIAL DE DOCUMENTOS:
 *    handleAnalyzeDocuments() ‚Üí extractTopics() ‚Üí reorderTopicsViaLLM() ‚Üí setTopics()
 *    Linha inicial: ~24735 | Ordena√ß√£o: ~22170
 *
 * ‚úçÔ∏è GERA√á√ÉO DE SENTEN√áA (por t√≥pico):
 *    generateReportForTopic() ‚Üí callAI() ‚Üí updateTopic()
 *    Linha inicial: ~22795
 *
 * üîç BUSCA SEM√ÇNTICA (IA Local):
 *    AIModelService.getEmbedding() ‚Üí cosineSimilarity() ‚Üí rankResults()
 *    Embeddings: linha ~460 | Busca: linha ~5320
 *
 * üìã AN√ÅLISE DE PROVAS:
 *    analyzeProof() ‚Üí extractText() ‚Üí anonimizar() ‚Üí callAI()
 *    Linha inicial: ~25500
 *
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * HOOKS DISPON√çVEIS (ordem alfab√©tica)
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * useAIIntegration    - Comunica√ß√£o com Claude/Gemini APIs
 * useAPICache         - Cache de respostas da IA
 * useChatAssistant    - Chat interativo com contexto
 * useDocumentManager  - Upload e processamento de documentos
 * useFeatureFlags     - Feature toggles
 * useFieldVersioning  - Hist√≥rico de vers√µes dos campos
 * useFontSizeControl  - Controle de tamanho de fonte
 * useFullscreen       - Modo tela cheia
 * useIndexedDB        - Persist√™ncia de modelos no IndexedDB
 * useJurisprudencia   - Busca de precedentes (TST/STF)
 * useLegislacao       - Busca de legisla√ß√£o (7000+ artigos)
 * useLocalStorage     - Persist√™ncia de sess√£o
 * useModelLibrary     - CRUD de modelos de texto
 * useModelPreview     - Preview de modelos no editor
 * useModalManager     - Controle de abertura/fechamento de modais
 * usePrimaryTabLock   - Sincroniza√ß√£o entre abas do navegador
 * useProofManager     - Gest√£o de provas documentais
 * useSpacingControl   - Controle de espa√ßamento
 * useThrottledBroadcast - Broadcast throttled entre abas
 * useTopicManager     - CRUD de t√≥picos da senten√ßa
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üì¶ SE√á√ÉO 1: IMPORTS & CONFIGURA√á√ÉO
// React, √≠cones Lucide, constantes globais
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

import React, { useState, useEffect, useRef } from 'react';
import { CHANGELOG } from './constants/changelog';
import { Upload, FileText, Plus, Search, Save, Trash2, ChevronDown, ChevronUp, Download, AlertCircle, AlertTriangle, Edit2, Edit3, Merge, Split, PlusCircle, Sparkles, Edit, GripVertical, BookOpen, Book, Zap, Scale, Loader2, Check, X, Clock, RefreshCw, Info, Code, Copy, ArrowRight, Eye, Wand2, LogOut, Share2, Link, Users, Mail } from 'lucide-react';
import LoginScreen, { useAuth } from './components/LoginScreen';

// v1.34.0: Cloud Sync - Magic Link Authentication + SQLite Sync
import useCloudSync from './hooks/useCloudSync';
import LoginMagicModal from './components/LoginMagicModal';
import SyncStatusIndicator from './components/SyncStatusIndicator';

// v1.34.4: Admin Panel - Gerenciamento de emails autorizados
import AdminPanel from './components/AdminPanel';

// v1.35.30: Modal de curadoria de t√≥picos pr√©-gera√ß√£o
import TopicCurationModal from './components/TopicCurationModal';

// v1.35.40: Google Drive - Salvar/Carregar projetos na nuvem
import { GoogleOAuthProvider } from '@react-oauth/google';
import { useGoogleDrive, GOOGLE_CLIENT_ID } from './hooks/useGoogleDrive';
import { GoogleDriveButton, DriveFilesModal } from './components/GoogleDriveButton';
import { VoiceButton } from './components/VoiceButton';
import { ModelGeneratorModal } from './components/ModelGeneratorModal';

// v1.35.26: Prompts de IA movidos para src/prompts/
import { AI_INSTRUCTIONS, AI_PROMPTS } from './prompts';

// v1.33.58: dnd-kit para drag and drop com suporte a wheel scroll
import { DndContext, closestCenter, PointerSensor, useSensor, useSensors } from '@dnd-kit/core';
import { SortableContext, verticalListSortingStrategy, useSortable, arrayMove } from '@dnd-kit/sortable';
import { CSS as DndCSS } from '@dnd-kit/utilities';

// üîß VERS√ÉO DA APLICA√á√ÉO
const APP_VERSION = '1.35.75'; // v1.35.75: Feedback inline no bot√£o Testar API Key (‚úì/‚úó ao inv√©s de toast)

// v1.33.31: URL base da API (detecta host automaticamente: Render, Vercel, ou localhost)
const getApiBase = () => {
  // Desenvolvimento local
  if (!import.meta.env.PROD) {
    return 'http://localhost:3001';
  }
  // Produ√ß√£o: usar mesmo dom√≠nio (funciona tanto no Render quanto no Vercel)
  return '';
};
const API_BASE = getApiBase();

// v1.35.25: CHANGELOG movido para src/constants/changelog.js

const AUTO_SAVE_DEBOUNCE_MS = 5000;

// v1.19.0: Limite de mensagens no chat do assistente IA
const MAX_CHAT_HISTORY_MESSAGES = 20;

// v1.19.3: Instru√ß√£o reformulada - CONSULTAR DOCUMENTOS antes de perguntar
const INSTRUCAO_NAO_PRESUMIR = `üö® REGRA CR√çTICA - CONSULTAR DOCUMENTOS ANTES DE PERGUNTAR:

üìö VOC√ä TEM ACESSO AOS DOCUMENTOS DO PROCESSO (peti√ß√£o inicial, contesta√ß√£o, provas).
SEMPRE consulte os documentos anexados no contexto ANTES de fazer qualquer pergunta.

‚úÖ SE A INFORMA√á√ÉO ESTIVER NOS DOCUMENTOS ANEXADOS:
- Use-a diretamente para fundamentar a decis√£o
- N√ÉO pergunte ao usu√°rio o que j√° est√° documentado
- Cite a fonte: "Conforme narrado na peti√ß√£o inicial..." ou "A contesta√ß√£o alega que..."

‚ùì PERGUNTE AO USU√ÅRIO (REGRA IMPORTANTE):
Sempre que uma informa√ß√£o necess√°ria √† reda√ß√£o N√ÉO estiver EXPRESSAMENTE indicada no contexto, voc√™ DEVE perguntar ao usu√°rio antes de redigir. N√£o presuma, n√£o infira, n√£o deduza.

PERGUNTE QUANDO:
- A informa√ß√£o N√ÉO estiver nos documentos anexados
- Precisar da CONCLUS√ÉO ou INTERPRETA√á√ÉO do juiz sobre uma prova
- O resultado de um pedido n√£o estiver definido (procedente/improcedente)
- Houver ambiguidade que s√≥ o magistrado pode resolver
- O documento mencionar prova que n√£o foi anexada (ex: "conforme per√≠cia...")
- Faltar dado essencial: valor, per√≠odo, percentual, conclus√£o sobre prova

PREFERIR PERGUNTAR a presumir. Na d√∫vida, pergunte.

‚ùå VOC√ä N√ÉO PODE, EM HIP√ìTESE ALGUMA:
1. INVENTAR fatos que N√ÉO est√£o nos documentos (testemunhas, valores, datas, percentuais)
2. PRESUMIR controv√©rsia/incontroversia sem verificar a contesta√ß√£o anexada
3. CONCLUIR o que uma prova "demonstra" sem an√°lise expressa do juiz
4. AFIRMAR autoria de documentos sem essa informa√ß√£o estar no contexto

‚úÖ VOC√ä PODE REDIGIR SEM PERGUNTAR:
- Fatos expressamente narrados nos documentos anexados
- Teses da peti√ß√£o inicial e argumentos da contesta√ß√£o (quando anexadas)
- Fundamenta√ß√£o jur√≠dica (lei, s√∫mulas, OJs, jurisprud√™ncia)
- Conclus√µes de premissas J√Å FORNECIDAS pelo juiz
- Estrutura e formata√ß√£o da decis√£o`;

// v1.25.18: Helper para extrair texto sem criar DOM (memory leak fix)
const extractPlainText = (html) => {
  if (!html) return '';
  return html
    .replace(/<br\s*\/?>/gi, '\n')
    .replace(/<\/p>\s*<p[^>]*>/gi, '\n')
    .replace(/<[^>]*>/g, ' ')
    .replace(/&nbsp;/g, ' ')
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/\s+/g, ' ')
    .replace(/\n\s+/g, '\n')
    .trim();
};

// üé® CSS CLASSES CENTRALIZADAS (v1.12.5 - Classes utilit√°rias consolidadas)
// v1.33.43: Fix tema claro - usa vari√°veis CSS de tema
const CSS = {
  // Modal system - v1.33.43: usa vari√°veis de tema para suportar tema claro/escuro
  modalOverlay: "fixed inset-0 theme-modal-overlay backdrop-blur-sm flex items-center justify-center z-[90] p-4",
  modalContainer: "theme-modal-container backdrop-blur-md rounded-2xl shadow-2xl theme-border-modal border theme-modal-glow",
  modalHeader: "p-5 border-b theme-border-modal",
  modalFooter: "flex gap-3 p-4 border-t theme-border-modal",
  // Input
  inputField: "w-full px-4 py-3 theme-input border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all",
  inputBase: "w-full theme-bg-secondary border theme-border-input rounded-lg theme-text-primary theme-placeholder focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all",
  // Info boxes
  infoBox: "theme-info-box",
  spinner: "w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin",
  // Text
  label: "block text-sm font-medium theme-text-tertiary mb-2",
  textMuted: "text-xs theme-text-muted",
  // Flex
  flexCenter: "flex items-center",
  flexGap1: "flex items-center gap-1",
  flexGap2: "flex items-center gap-2",
  flexGap3: "flex items-center gap-3",
  flexBetween: "flex items-center justify-between",
  flexCenterJustify: "flex items-center justify-center gap-2",
  // Buttons - v1.33.43: cores que funcionam em ambos os temas
  btnBase: "rounded-xl font-medium transition-all",
  btnPrimary: "px-4 py-2.5 rounded-xl font-medium text-white bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 shadow-lg shadow-purple-500/25",
  btnSecondary: "px-4 py-2.5 rounded-xl font-medium theme-bg-secondary theme-hover-bg border theme-border-modal theme-text-primary transition-all",
  btnDanger: "px-4 py-2.5 rounded-xl font-medium bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white shadow-lg shadow-red-500/25",
  btnSuccess: "px-4 py-2.5 rounded-xl font-medium bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white shadow-lg shadow-green-500/25",
  btnBlue: "px-4 py-2.5 rounded-xl font-medium bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white shadow-lg shadow-blue-500/25",
  btnRed: "px-4 py-2.5 rounded-xl font-medium bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white shadow-lg shadow-red-500/25",
  btnGreen: "px-4 py-2.5 rounded-xl font-medium bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white shadow-lg shadow-green-500/25",
  btnSmall: "px-2 py-1 rounded text-xs",
  // Cards
  cardBase: "rounded-lg border theme-border-input theme-bg-secondary",
  // Common
  hoverSlate: "theme-bg-tertiary hover-slate-500",
  roundedLg: "rounded-lg",
  textXs: "text-xs",
  textSm: "text-sm",
};

// ‚öôÔ∏è CONFIGURA√á√ÉO DE ESPA√áAMENTO DE PAR√ÅGRAFOS
const SPACING_PRESETS = {
  compact: {
    label: 'Compacto',
    lineHeight: '1.2',
    paragraphMargin: '0.15em',
    icon: '‚ñº'
  },
  normal: {
    label: 'Normal',
    lineHeight: '1.35',
    paragraphMargin: '0.25em',
    icon: '='
  },
  comfortable: {
    label: 'Confort√°vel',
    lineHeight: '1.6',
    paragraphMargin: '0.5em',
    icon: '‚â°'
  },
  wide: {
    label: 'Amplo',
    lineHeight: '2.0',
    paragraphMargin: '1.0em',
    icon: '‚ò∞'
  }
};

// ‚öôÔ∏è CONFIGURA√á√ÉO DE TAMANHO DE FONTE DOS EDITORES (v1.10.8)
const FONTSIZE_PRESETS = {
  normal: {
    label: 'Normal',
    fontSize: '14px',
    icon: 'A'
  },
  larger: {
    label: 'Maior',
    fontSize: '16px',
    icon: 'A+'
  },
  largest: {
    label: 'Grande',
    fontSize: '18px',
    icon: 'A++'
  }
};

// üé® ESTILOS DE RESULTADO (cores por tipo de decis√£o)
const RESULTADO_STYLES = {
  PROCEDENTE: { borderColor: '#10b981', color: 'var(--result-green)' },
  IMPROCEDENTE: { borderColor: '#ef4444', color: 'var(--result-red)' },
  'PARCIALMENTE PROCEDENTE': { borderColor: '#f59e0b', color: 'var(--result-amber)' },
  ACOLHIDO: { borderColor: '#10b981', color: 'var(--result-green)' },
  REJEITADO: { borderColor: '#ef4444', color: 'var(--result-red)' },
  'SEM RESULTADO': { borderColor: '#64748b', color: 'var(--result-muted)' },
  default: { borderColor: '#64748b', color: 'var(--result-muted)' }
};
const getResultadoStyle = (r) => RESULTADO_STYLES[r] || RESULTADO_STYLES.default;

// v1.32.00: LocalAIProcessingOverlay removido - IA agora roda em Web Worker (n√£o bloqueia UI)

// üîç TF-IDF SIMILARITY ENGINE (v1.13.1 - Detec√ß√£o de modelos similares)
const TFIDFSimilarity = {
  STOPWORDS: new Set(['de','da','do','das','dos','em','na','no','nas','nos','para','por','com','sem','sob','sobre','entre','ate','o','a','os','as','um','uma','uns','umas','e','ou','mas','porem','contudo','todavia','que','qual','quais','quando','onde','como','porque','ser','estar','ter','haver','fazer','ir','vir','foi','era','sido','sendo','seja','foram','sao','ao','aos','pela','pelo','pelas','pelos','este','esta','estes','estas','esse','essa','esses','essas','isso','isto','aquilo','aquele','aquela','se','nao','sim','mais','menos','muito','pouco','art','artigo','paragrafo','inciso','alinea','fls','folhas','pag','pagina','id','processo','autos','requerente','requerido','reclamante','reclamada','autor','reu','parte','partes','assim','ainda','ja','tambem','apenas','mesmo','so','entao','pois']),
  cache: { vectors: new Map(), vocab: new Map(), idf: new Map(), valid: false },
  tokenize(t) {
    return (t||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/<[^>]+>/g,' ').replace(/[^\w\s]/g,' ').replace(/\d+/g,' ').split(/\s+/).filter(w=>w.length>2&&!this.STOPWORDS.has(w));
  },
  buildIndex(models) {
    const df=new Map(), N=models.length;
    models.forEach(m=>{const terms=new Set(this.tokenize(m.content));terms.forEach(t=>df.set(t,(df.get(t)||0)+1));});
    this.cache.vocab.clear();this.cache.idf.clear();let i=0;
    df.forEach((f,t)=>{if(f>=2&&f<N*0.9){this.cache.vocab.set(t,i++);this.cache.idf.set(t,Math.log(N/f)+1);}});
    this.cache.vectors.clear();
    models.forEach(m=>this.cache.vectors.set(m.id,this.computeVector(m.content)));
    this.cache.valid=true;
  },
  computeVector(text) {
    const tokens=this.tokenize(text),tf=new Map();
    tokens.forEach(t=>{if(this.cache.vocab.has(t))tf.set(t,(tf.get(t)||0)+1);});
    const vec=new Map();let norm=0;
    tf.forEach((f,t)=>{const idf=this.cache.idf.get(t);const idx=this.cache.vocab.get(t);if(idf===undefined||idx===undefined)return;const v=(1+Math.log(f))*idf;vec.set(idx,v);norm+=v*v;});
    norm=Math.sqrt(norm);if(norm>0)vec.forEach((v,k)=>vec.set(k,v/norm));
    return vec;
  },
  cosine(a,b){let dot=0;a.forEach((v,k)=>{if(typeof k==='number'&&b.has(k))dot+=v*b.get(k);});return dot;},
  findSimilar(newModel,models,threshold=0.80) {
    if(!this.cache.valid||this.cache.vectors.size!==models.length)this.buildIndex(models);
    const vec=this.computeVector(newModel.content);
    let best=null,bestSim=0;
    models.forEach(m=>{if(m.id===newModel.id)return;const ev=this.cache.vectors.get(m.id);if(!ev)return;const s=this.cosine(vec,ev);if(s>=threshold&&s>bestSim){bestSim=s;best=m;}});
    return best?{hasSimilar:true,similarModel:best,similarity:bestSim}:{hasSimilar:false};
  },
  invalidate(){this.cache.valid=false;this.cache.vectors.clear();}
};

// üß† AI CAPABILITIES DETECTION - v1.31.04
// Detecta suporte a SIMD, multi-threading e WebGPU
// Fonte: https://github.com/nicholaus-miller/wasm-feature-detect
const detectAICapabilities = () => {
  // SIMD detection (97% browsers 2024)
  // Magic bytes que representam um m√≥dulo WASM m√≠nimo com SIMD
  const simdSupported = (() => {
    try {
      return WebAssembly.validate(new Uint8Array([
        0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11
      ]));
    } catch { return false; }
  })();

  // Multi-threading detection
  // Requer SharedArrayBuffer + crossOriginIsolated (headers COOP/COEP)
  const threadsSupported = typeof SharedArrayBuffer !== 'undefined'
    && window.crossOriginIsolated === true;

  // WebGPU detection (~70% browsers 2024)
  const webgpuSupported = 'gpu' in navigator;

  const caps = {
    simd: simdSupported,
    threads: threadsSupported,
    webgpu: webgpuSupported,
    cores: navigator.hardwareConcurrency || 4,
    crossOriginIsolated: !!window.crossOriginIsolated
  };

  if (import.meta.env.DEV) console.log('[AI] Capabilities:', caps);
  return caps;
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üõ†Ô∏è SE√á√ÉO 2: UTILIT√ÅRIOS & SERVI√áOS
// AIModelService (NER/E5), EmbeddingsService, JurisEmbeddingsService, EmbeddingsCDNService
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// üß† AI MODEL SERVICE - IA via Web Worker v1.32.08
// Modelos: NER (Xenova/distilbert-base-multilingual-cased-ner-hrl)
//          Embeddings (Xenova/multilingual-e5-base)
// v1.32.08: Worker thread para n√£o bloquear UI
const AIModelService = {
  worker: null,
  pending: new Map(),
  status: { ner: 'idle', search: 'idle' }, // idle, loading, ready, error
  progress: { ner: 0, search: 0 },
  listeners: new Set(),

  // Obter/criar worker
  getWorker() {
    if (!this.worker) {
      this.worker = new Worker(new URL('./ai-worker.js', import.meta.url), { type: 'module' });
      this.worker.onmessage = (e) => {
        const { id, type, result, error, progress } = e.data;

        // Progresso de download
        if (type === 'progress' && progress) {
          const model = progress.model;
          if (model) {
            this.progress[model] = Math.round(progress.progress || 0);
            this._notify();
          }
          return;
        }

        // Worker pronto
        if (type === 'ready') return;

        // Resposta de chamada
        const pending = this.pending.get(id);
        if (!pending) return;
        this.pending.delete(id);

        if (type === 'error') {
          pending.reject(new Error(error));
        } else {
          pending.resolve(result);
        }
      };

      // v1.35.58: Handler de erro do worker - rejeita promises pendentes
      this.worker.onerror = (err) => {
        console.error('[AI Worker] Error:', err);
        // Rejeitar todas as promises pendentes
        this.pending.forEach(({ reject }) => {
          reject(new Error('Worker error: ' + (err.message || 'Unknown error')));
        });
        this.pending.clear();
        // Reset status para error
        Object.keys(this.status).forEach(key => {
          this.status[key] = 'error';
        });
        this._notify();
      };
    }
    return this.worker;
  },

  // Chamar worker
  // v1.35.58: Adicionado timeout para evitar promises pendentes eternamente
  _call(type, text = null, options = null, timeoutMs = 60000) {
    return new Promise((resolve, reject) => {
      const id = crypto.randomUUID();

      // Timeout para n√£o travar indefinidamente
      const timeout = setTimeout(() => {
        if (this.pending.has(id)) {
          this.pending.delete(id);
          reject(new Error(`Worker timeout: ${type}`));
        }
      }, timeoutMs);

      this.pending.set(id, {
        resolve: (result) => { clearTimeout(timeout); resolve(result); },
        reject: (err) => { clearTimeout(timeout); reject(err); }
      });

      this.getWorker().postMessage({ id, type, text, options });
    });
  },

  // Notificar listeners de mudan√ßa de status
  _notify() {
    this.listeners.forEach(fn => fn({ status: this.status, progress: this.progress }));
  },

  // Adicionar listener de status
  onStatusChange(fn) {
    this.listeners.add(fn);
    return () => this.listeners.delete(fn);
  },

  // Alias para onStatusChange (compatibilidade)
  subscribe(fn) {
    const wrappedFn = ({ status, progress }) => fn(status, progress);
    this.listeners.add(wrappedFn);
    return () => this.listeners.delete(wrappedFn);
  },

  // v1.35.58: Limpar recursos e pending promises
  cleanup() {
    // Rejeitar todas as promises pendentes
    this.pending.forEach(({ reject }) => {
      reject(new Error('AIModelService cleanup'));
    });
    this.pending.clear();

    // Terminar worker
    if (this.worker) {
      this.worker.terminate();
      this.worker = null;
    }

    // Reset status
    Object.keys(this.status).forEach(key => {
      this.status[key] = 'idle';
      this.progress[key] = 0;
    });

    this._notify();
    console.log('[AI] Cleanup completo');
  },

  // Inicializar modelo
  async init(modelType = 'ner') {
    if (this.status[modelType] === 'ready') return true;
    if (this.status[modelType] === 'loading') return false;

    this.status[modelType] = 'loading';
    this.progress[modelType] = 0;
    this._notify();

    const caps = detectAICapabilities();
    if (import.meta.env.DEV) console.log(`[AI] Iniciando ${modelType}...`, caps);

    try {
      await this._call(`init-${modelType}`);
      this.status[modelType] = 'ready';
      this.progress[modelType] = 100;
      this._notify();
      if (import.meta.env.DEV) console.log(`[AI] ${modelType} pronto!`);
      return true;
    } catch (err) {
      this.status[modelType] = 'error';
      this._notify();
      console.error(`[AI] Erro ao iniciar ${modelType}:`, err);
      throw err;
    }
  },

  // Verificar se modelo est√° pronto
  isReady(modelType = 'ner') {
    return this.status[modelType] === 'ready';
  },

  // Descarregar modelo
  async unload(modelType) {
    await this._call('unload', null, { model: modelType });
    this.status[modelType] = 'idle';
    this.progress[modelType] = 0;
    this._notify();
    console.log(`[AI] ${modelType} descarregado`);
  },

  // v1.32.08: Extrair entidades NER via Worker (l√≥gica v1.28 com offsets manuais)
  async extractEntities(text) {
    if (!this.isReady('ner')) await this.init('ner');

    const cleanText = text.replace(/[\r\n\t]+/g, ' ').replace(/\s+/g, ' ').trim();
    const CHUNK_SIZE = 1000;
    const OVERLAP = 200;
    let allRaw = [];

    for (let i = 0; i < cleanText.length; i += (CHUNK_SIZE - OVERLAP)) {
      let chunk = cleanText.slice(i, i + CHUNK_SIZE);
      if (chunk.length < 10) continue;

      // Segment Title Case para ALL CAPS
      chunk = chunk.replace(
        /\b([A-Z√Å√Ä√Ç√É√â√à√ç√è√ì√î√ï√ñ√ö√á√ë]{2,}(?:\s+[A-Z√Å√Ä√Ç√É√â√à√ç√è√ì√î√ï√ñ√ö√á√ë]{2,})+)\b/g,
        (match) => match.toLowerCase().replace(/(?:^|\s)\S/g, a => a.toUpperCase())
      );

      try {
        // v1.32.08: Chamar worker ao inv√©s de pipeline direto
        const chunkEntities = await this._call('ner', chunk, { truncation: true, max_length: 512 });

        // OFFSETS MANUAIS via indexOf (Transformers.js retorna start/end incorretos)
        // v1.33.14: Busca case-insensitive (BERT retorna "Mac" mas texto √© "MACEDO")
        let cursor = 0;
        const chunkLower = chunk.toLowerCase();
        const adjusted = chunkEntities.reduce((acc, e) => {
          if (e.word === '[UNK]' || e.word === '[CLS]' || e.word === '[SEP]') return acc;
          const cleanWord = (e.word || '').replace(/^##/, '');
          if (!cleanWord) return acc;
          const idx = chunkLower.indexOf(cleanWord.toLowerCase(), cursor);
          if (idx !== -1) {
            cursor = idx + cleanWord.length;
            acc.push({ ...e, start: idx + i, end: idx + cleanWord.length + i });
          }
          return acc;
        }, []);

        allRaw = allRaw.concat(adjusted);
      } catch (err) {
        console.warn('[NER] Erro no chunk:', err.message);
      }
    }

    // Deduplicar (v1.33.14: incluir tipo de entidade na key para n√£o confundir Mac/LOC com Mac/PER)
    const seen = new Set();
    const unique = allRaw.filter(e => {
      const entityType = (e.entity || '').replace(/^(B-|I-)/, ''); // PER, LOC, ORG
      const key = `${e.word?.toLowerCase()}-${entityType}-${Math.floor((e.start || 0) / 50)}`;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    const processed = this.processTokens(unique);
    const result = this.mergeOrgLoc(processed, cleanText); // v1.32.10

    // v1.32.17: Liberar mem√≥ria NER ap√≥s uso (modelo ser√° recarregado no pr√≥ximo uso)
    this.unload('ner');

    return result;
  },

  // v1.33.13: Processar tokens NER com healing de subtokens √≥rf√£os
  // Healing: se subtoken (##xxx) √© entidade mas prefixo foi 'O', unir se adjacentes
  processTokens(rawEntities) {
    const sorted = [...rawEntities].sort((a, b) => a.start - b.start);

    // v1.33.13: Log de debug para an√°lise
    console.log('[NER] Tokens brutos:', rawEntities.slice(0, 50).map(t =>
      `${t.word}(${t.entity}:${t.start}-${t.end})`).join(', '));

    const result = [];
    let current = null;
    let pendingPrefix = null; // Token 'O' que pode ser prefixo de subtoken

    for (const token of sorted) {
      const isSubtoken = (token.word || '').startsWith('##');
      const cleanWord = (token.word || '').replace(/^##/, '');
      if (!cleanWord) continue;

      // Se token √© 'O', guardar como poss√≠vel prefixo
      if (token.entity === 'O') {
        pendingPrefix = { word: cleanWord, end: token.end, start: token.start };
        continue;
      }

      const entityType = (token.entity || '').replace(/^(B-|I-)/, '');
      let wordToUse = cleanWord;

      // v1.33.13: HEALING - Se √© subtoken entidade e temos prefixo pendente adjacente
      if (isSubtoken && pendingPrefix && token.start === pendingPrefix.end) {
        // Prefixo ignorado deve ser unido ao subtoken
        wordToUse = pendingPrefix.word + cleanWord;
        console.log(`[NER] Healing: "${pendingPrefix.word}" + "##${cleanWord}" ‚Üí "${wordToUse}"`);
      }
      pendingPrefix = null; // Limpar prefixo ap√≥s usar ou pular

      if (current) {
        const distance = token.start - current.end;

        // FUS√ÉO: mesmo tipo E adjacente (distance 0 ou 1)
        if (current.type === entityType && distance >= 0 && distance <= 1) {
          const separator = distance === 0 ? '' : ' ';
          current.text += separator + wordToUse;
          current.end = token.end;
          current.score = Math.min(current.score, token.score || 1);
          continue;
        }
      }

      // NOVA ENTIDADE
      if (current) result.push(current);
      current = {
        text: wordToUse,
        type: entityType,
        score: token.score || 1,
        start: token.start,
        end: token.end
      };
    }

    if (current) result.push(current);
    return result;
  },

  // v1.32.10: Fundir ORG + LOC quando conectados por "DE/DO/DA"
  // Ex: "COMPANHIA DE TRANSITO E TRANSPORTE" (ORG) + "MACAPA" (LOC) ‚Üí "COMPANHIA DE TRANSITO E TRANSPORTE DE MACAPA" (ORG)
  mergeOrgLoc(entities, originalText) {
    const result = [];
    let i = 0;

    while (i < entities.length) {
      const current = entities[i];
      const next = entities[i + 1];

      // v1.32.12: Padr√£o ORG + (LOC ou ORG curto) com preposi√ß√£o no meio
      // Modelo NER frequentemente classifica cidades como ORG quando parte de nome de empresa
      const isOrgOrLoc = next && (next.type === 'LOC' || next.type === 'ORG');
      const nextIsShort = next && next.text.split(/\s+/).length <= 2; // Max 2 palavras = provavelmente cidade

      if (next && current.type === 'ORG' && isOrgOrLoc && nextIsShort) {
        const gap = originalText.substring(current.end, next.start).trim().toUpperCase();

        if (gap === 'DE' || gap === 'DO' || gap === 'DA' || gap === 'DOS' || gap === 'DAS') {
          // Fundir: ORG absorve LOC
          result.push({
            text: `${current.text} ${gap} ${next.text}`,
            type: 'ORG',
            score: Math.min(current.score, next.score),
            start: current.start,
            end: next.end
          });
          i += 2; // Pular ambos
          continue;
        }
      }

      result.push(current);
      i++;
    }

    return result;
  },

  // v1.32.08: Gerar embedding via Worker
  async getEmbedding(text, type = 'passage') {
    if (!this.isReady('search')) await this.init('search');

    // E5 recomenda prefixos
    const prefixed = type === 'query' ? `query: ${text}` : `passage: ${text}`;
    return this._call('embedding', prefixed);
  },

  // Calcular similaridade de cosseno (roda na main thread - √© r√°pido)
  cosineSimilarity(a, b) {
    if (!a || !b || a.length !== b.length) return 0;
    let dot = 0, normA = 0, normB = 0;
    for (let i = 0; i < a.length; i++) {
      dot += a[i] * b[i];
      normA += a[i] * a[i];
      normB += b[i] * b[i];
    }
    const denom = Math.sqrt(normA) * Math.sqrt(normB);
    return denom === 0 ? 0 : dot / denom;
  }
};

// üîç EMBEDDINGS SERVICE - IndexedDB para busca sem√¢ntica v1.26.00
const EmbeddingsService = {
  DB_NAME: 'sentencify-legislacao-embeddings',
  STORE_NAME: 'embeddings',
  VERSION: 1,

  openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.DB_NAME, this.VERSION);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => resolve(req.result);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
          const store = db.createObjectStore(this.STORE_NAME, { keyPath: 'id' });
          store.createIndex('artigoId', 'artigoId', { unique: false });
          store.createIndex('type', 'type', { unique: false });
          store.createIndex('lei', 'lei', { unique: false });
        }
      };
    });
  },

  async saveEmbedding(item) {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      tx.objectStore(this.STORE_NAME).put(item);
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  },

  async saveEmbeddingsBatch(items) {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      const store = tx.objectStore(this.STORE_NAME);
      items.forEach(item => store.put(item));
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  },

  async getAllEmbeddings() {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  },

  async getEmbeddingsByLei(lei) {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const index = tx.objectStore(this.STORE_NAME).index('lei');
      const req = index.getAll(lei);
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  },

  async getCount() {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).count();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  },

  // v1.26.02: Obter apenas os IDs dos embeddings (para verifica√ß√£o incremental)
  async getAllIds() {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).getAllKeys();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  },

  async clearAll() {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      tx.objectStore(this.STORE_NAME).clear();
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  },

  async clearByLei(lei) {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      const store = tx.objectStore(this.STORE_NAME);
      const index = store.index('lei');
      const req = index.openCursor(lei);
      req.onsuccess = (e) => {
        const cursor = e.target.result;
        if (cursor) {
          store.delete(cursor.primaryKey);
          cursor.continue();
        }
      };
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  },

  // Buscar por similaridade (retorna top N resultados, deduplicado por artigoId)
  async searchBySimilarity(queryEmbedding, threshold = 0.5, limit = 20) {
    const allEmbeddings = await this.getAllEmbeddings();
    const results = allEmbeddings
      .map(item => ({
        ...item,
        similarity: AIModelService.cosineSimilarity(queryEmbedding, item.embedding)
      }))
      .filter(item => item.similarity >= threshold);

    // Deduplicar por artigoId (manter chunk com maior similaridade)
    const deduped = Object.values(
      results.reduce((acc, item) => {
        const key = item.artigoId || item.id;
        if (!acc[key] || item.similarity > acc[key].similarity) {
          acc[key] = item;
        }
        return acc;
      }, {})
    );

    return deduped
      .sort((a, b) => b.similarity - a.similarity)
      .slice(0, limit);
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìö JURIS EMBEDDINGS SERVICE - IndexedDB para busca sem√¢ntica de jurisprud√™ncia
// v1.27.00: Suporte a chunking para textos longos (IRR, IAC)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const JURIS_CHUNK_THRESHOLD = 1500;
const JURIS_CHUNK_SIZE = 1200;
const JURIS_CHUNK_OVERLAP = 200;

const chunkJurisText = (text) => {
  if (!text || text.length < JURIS_CHUNK_THRESHOLD) {
    return [{ text, chunkIndex: 0, totalChunks: 1 }];
  }
  const teseRegex = /(?:^|\n)\s*(?:\d+[¬™¬∫¬∞]?\)|\d+\s*[\.\)]\s)/;
  const parts = text.split(teseRegex).filter(t => t && t.trim().length > 50);
  if (parts.length > 1) {
    return parts.map((t, i) => ({ text: t.trim(), chunkIndex: i, totalChunks: parts.length }));
  }
  const chunks = [];
  let start = 0;
  while (start < text.length) {
    const end = Math.min(start + JURIS_CHUNK_SIZE, text.length);
    chunks.push({ text: text.slice(start, end), chunkIndex: chunks.length, totalChunks: 0 });
    start = end - JURIS_CHUNK_OVERLAP;
    if (start >= text.length - 50) break;
  }
  chunks.forEach(c => c.totalChunks = chunks.length);
  return chunks;
};

const JurisEmbeddingsService = {
  DB_NAME: 'sentencify-juris-embeddings',
  STORE_NAME: 'embeddings',
  VERSION: 1,

  openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.DB_NAME, this.VERSION);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => resolve(req.result);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
          const store = db.createObjectStore(this.STORE_NAME, { keyPath: 'id' });
          store.createIndex('precedenteId', 'precedenteId', { unique: false });
          store.createIndex('tribunal', 'tribunal', { unique: false });
          store.createIndex('tipoProcesso', 'tipoProcesso', { unique: false });
        }
      };
    });
  },

  async saveEmbedding(item) {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      tx.objectStore(this.STORE_NAME).put(item);
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  },

  async saveEmbeddingsBatch(items) {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      const store = tx.objectStore(this.STORE_NAME);
      items.forEach(item => store.put(item));
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  },

  async getAllEmbeddings() {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  },

  async getCount() {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).count();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  },

  async getAllIds() {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).getAllKeys();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  },

  async clearAll() {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      tx.objectStore(this.STORE_NAME).clear();
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  },

  // v1.32.21: Aceita filtros para aplicar ANTES do limit
  async searchBySimilarity(queryEmbedding, threshold = 0.5, limit = 30, filters = {}) {
    const allEmbeddings = await this.getAllEmbeddings();
    let results = allEmbeddings
      .map(item => ({
        ...item,
        similarity: AIModelService.cosineSimilarity(queryEmbedding, item.embedding)
      }))
      .filter(item => item.similarity >= threshold);

    // v1.32.21: Aplicar filtros ANTES de limitar (para ter at√© 30 do tipo desejado)
    if (filters.tipo?.length > 0) {
      const IRR_TYPES = new Set(['IRR', 'RR', 'RRAG', 'INCJULGRREMBREP', 'INCJULGRREPETITIVO']);
      results = results.filter(r => {
        if (filters.tipo.includes('IRR') && IRR_TYPES.has((r.tipoProcesso || '').toUpperCase().replace(/-/g, ''))) return true;
        return filters.tipo.includes(r.tipoProcesso);
      });
    }
    if (filters.tribunal?.length > 0) {
      results = results.filter(r => filters.tribunal.includes(r.tribunal));
    }

    const deduped = Object.values(
      results.reduce((acc, item) => {
        const key = item.precedenteId || item.id;
        if (!acc[key] || item.similarity > acc[key].similarity) {
          acc[key] = item;
        }
        return acc;
      }, {})
    );
    return deduped
      .sort((a, b) => b.similarity - a.similarity)
      .slice(0, limit);
  }
};

// üåê CDN SERVICE para download autom√°tico de embeddings (v1.33.0)
const EmbeddingsCDNService = {
  VERSION: '1.0.0',

  // v1.35.20: Tamanhos estimados para fallback quando Content-Length n√£o dispon√≠vel
  ESTIMATED_SIZES: {
    'legis-embeddings.json': 211_000_000,  // ~211MB
    'juris-embeddings.json': 50_000_000,   // ~50MB
    'legis-data.json': 5_000_000,          // ~5MB
    'juris-data.json': 2_000_000,          // ~2MB
  },

  // Retorna URL do proxy (funciona local e Vercel, resolve CORS)
  getProxyUrl(file) {
    return `${API_BASE}/api/embeddings?file=${file}`;
  },

  // Verifica se precisa baixar embeddings
  async needsDownload(type) {
    try {
      const count = type === 'legislacao'
        ? await EmbeddingsService.getCount()
        : await JurisEmbeddingsService.getCount();
      return count === 0;
    } catch {
      return true;
    }
  },

  // Download com progresso e retry
  // v1.35.20: Usa tamanhos estimados como fallback quando Content-Length n√£o dispon√≠vel
  async downloadFile(url, onProgress, maxRetries = 3) {
    // Extrair nome do arquivo da URL (ex: ?file=legis-embeddings.json)
    const fileMatch = url.match(/[?&]file=([^&]+)/);
    const filename = fileMatch ? fileMatch[1] : null;

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const contentLength = res.headers.get('Content-Length');
        let total = contentLength ? parseInt(contentLength, 10) : 0;

        // v1.35.20: Fallback para tamanho estimado quando Content-Length n√£o dispon√≠vel
        if (!total && filename && this.ESTIMATED_SIZES[filename]) {
          total = this.ESTIMATED_SIZES[filename];
          console.log(`[CDN] Usando tamanho estimado para ${filename}: ${(total / 1_000_000).toFixed(1)}MB`);
        }

        const reader = res.body.getReader();
        const chunks = [];
        let received = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          chunks.push(value);
          received += value.length;
          // v1.35.20: Reportar progresso mesmo com tamanho estimado (cap em 99% at√© done)
          if (onProgress && total) {
            const progress = Math.min(received / total, 0.99);
            onProgress(progress);
          }
        }

        // v1.35.20: Garantir 100% ao finalizar
        if (onProgress) onProgress(1);

        const blob = new Blob(chunks);
        return blob.text();
      } catch (err) {
        if (attempt === maxRetries) throw err;
        // Exponential backoff: 1s, 2s, 4s
        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt - 1)));
      }
    }
  },

  // Baixa e salva embeddings de legisla√ß√£o
  async downloadLegislacao(onProgress, onBatchComplete) {
    const url = this.getProxyUrl('legis-embeddings.json');
    const text = await this.downloadFile(url, onProgress);
    const items = JSON.parse(text);

    // Salvar em batches de 100 para n√£o travar
    const batchSize = 100;
    for (let i = 0; i < items.length; i += batchSize) {
      const batch = items.slice(i, i + batchSize);
      await EmbeddingsService.saveEmbeddingsBatch(batch);
      onBatchComplete?.(Math.min(i + batchSize, items.length), items.length);
      // Yield para UI
      await new Promise(r => setTimeout(r, 0));
    }

    return items.length;
  },

  // Baixa e salva embeddings de jurisprud√™ncia
  async downloadJurisprudencia(onProgress, onBatchComplete) {
    const url = this.getProxyUrl('juris-embeddings.json');
    const text = await this.downloadFile(url, onProgress);
    const items = JSON.parse(text);

    // Salvar em batches de 100
    const batchSize = 100;
    for (let i = 0; i < items.length; i += batchSize) {
      const batch = items.slice(i, i + batchSize);
      await JurisEmbeddingsService.saveEmbeddingsBatch(batch);
      onBatchComplete?.(Math.min(i + batchSize, items.length), items.length);
      await new Promise(r => setTimeout(r, 0));
    }

    return items.length;
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // v1.33.61: AUTO-DOWNLOAD DE DADOS (legisla√ß√£o e jurisprud√™ncia)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Verifica se precisa baixar dados (n√£o embeddings)
  async needsDataDownload(type) {
    try {
      if (type === 'legislacao') {
        const artigos = await loadArtigosFromIndexedDB();
        return artigos.length === 0;
      } else {
        const precedentes = await loadPrecedentesFromIndexedDB();
        return precedentes.length === 0;
      }
    } catch {
      return true;
    }
  },

  // Baixa e salva dados de legisla√ß√£o
  async downloadLegislacaoData(onProgress, onBatchComplete) {
    const url = this.getProxyUrl('legis-data.json');
    const text = await this.downloadFile(url, onProgress);
    const json = JSON.parse(text);
    const items = json.data || json;

    // Salvar em batches de 500 (artigos s√£o menores que embeddings)
    const batchSize = 500;
    for (let i = 0; i < items.length; i += batchSize) {
      const batch = items.slice(i, i + batchSize);
      await saveArtigosToIndexedDB(batch);
      onBatchComplete?.(Math.min(i + batchSize, items.length), items.length);
      await new Promise(r => setTimeout(r, 0));
    }

    return items.length;
  },

  // Baixa e salva dados de jurisprud√™ncia
  async downloadJurisprudenciaData(onProgress, onBatchComplete) {
    const url = this.getProxyUrl('juris-data.json');
    const text = await this.downloadFile(url, onProgress);
    const json = JSON.parse(text);
    const items = json.data || json;

    // Salvar em batches de 200
    const batchSize = 200;
    for (let i = 0; i < items.length; i += batchSize) {
      const batch = items.slice(i, i + batchSize);
      await savePrecedentesToIndexedDB(batch);
      onBatchComplete?.(Math.min(i + batchSize, items.length), items.length);
      await new Promise(r => setTimeout(r, 0));
    }

    return items.length;
  }
};

// üîí ANONIMIZA√á√ÉO DE TEXTO (v1.17.0 - Nomes inseridos pelo usu√°rio)
const anonymizeText = (text, config, nomesUsuario = []) => {
  if (!text || !config?.enabled) return text;

  // Normalizar: juntar d√≠gitos separados por quebras de linha (PDF.js √†s vezes quebra n√∫meros)
  let result = text.replace(/(\d)\s+(\d)/g, '$1$2');
  const encontrados = { cnpj: [], cpf: [], rg: [], pis: [], ctps: [], cep: [], processo: [], oab: [], telefone: [], email: [], conta: [], valor: [], pessoa: [] };

  // CNPJ: 00.000.000/0000-00
  if (config.cnpj !== false) {
    result = result.replace(/\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}/g, (m) => { encontrados.cnpj.push(m); return '[CNPJ]'; });
  }

  // CPF: 000.000.000-00 (ap√≥s CNPJ para evitar conflito)
  if (config.cpf !== false) {
    result = result.replace(/\d{3}\.?\d{3}\.?\d{3}-?\d{2}/g, (m) => { encontrados.cpf.push(m); return '[CPF]'; });
  }

  // RG: 00.000.000-0 ou similar
  if (config.rg !== false) {
    result = result.replace(/\d{1,2}\.?\d{3}\.?\d{3}-?[\dXx]/g, (m) => { encontrados.rg.push(m); return '[RG]'; });
  }

  // PIS/PASEP: 000.00000.00-0
  if (config.pis !== false) {
    result = result.replace(/\d{3}\.?\d{5}\.?\d{2}-?\d/g, (m) => { encontrados.pis.push(m); return '[PIS]'; });
  }

  // CTPS: 0000000/00000 ou similar
  if (config.ctps !== false) {
    result = result.replace(/\d{5,7}[/-]\d{3,5}/g, (m) => { encontrados.ctps.push(m); return '[CTPS]'; });
  }

  // CEP: 00.000-000 ou 00000-000
  if (config.cep !== false) {
    result = result.replace(/\d{2}\.?\d{3}-?\d{3}/g, (m) => { encontrados.cep.push(m); return '[CEP]'; });
  }

  // N√∫mero de processo CNJ: 0000000-00.0000.0.00.0000 (com espa√ßos antes/depois de separadores)
  if (config.processo !== false) {
    result = result.replace(/\d{7}\s*-\s*\d{2}\s*\.\s*\d{4}\s*\.\s*\d\s*\.\s*\d{2}\s*\.\s*\d{4}/g, (m) => { encontrados.processo.push(m); return '[PROCESSO]'; });
  }

  // OAB: OAB/XX 0000
  if (config.oab !== false) {
    result = result.replace(/OAB\/?\s*[A-Z]{2}\s*\d+/gi, (m) => { encontrados.oab.push(m); return '[OAB]'; });
  }

  // Telefone: (00) 00000-0000 ou varia√ß√µes
  if (config.telefone !== false) {
    result = result.replace(/\(?\d{2}\)?\s*\d{4,5}-?\d{4}/g, (m) => { encontrados.telefone.push(m); return '[TELEFONE]'; });
  }

  // E-mail
  if (config.email !== false) {
    result = result.replace(/[\w.-]+@[\w.-]+\.\w{2,}/gi, (m) => { encontrados.email.push(m); return '[EMAIL]'; });
  }

  // Conta banc√°ria: Ag. 0000 C/C 00000-0 ou varia√ß√µes
  if (config.contaBancaria !== false) {
    result = result.replace(/[Aa]g[√™e]?n?c?i?a?\.?\s*:?\s*\d[\d.-]*\s*[Cc]\.?\/?\s*[Cc]\.?\s*:?\s*\d[\d.-]*/g, (m) => { encontrados.conta.push(m); return '[CONTA]'; });
  }

  // Valores monet√°rios R$
  if (config.valores === true) {
    result = result.replace(/R\$\s*[\d.,]+/g, (m) => { encontrados.valor.push(m); return '[VALOR]'; });
  }

  // Nomes inseridos pelo usu√°rio (v1.17.0)
  if (nomesUsuario && nomesUsuario.length > 0) {
    // Helper: escapar caracteres especiais de regex
    const escapeRegex = (str) => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    // Normalizar texto (remover acentos para compara√ß√£o)
    const normalize = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

    // Criar regex flex√≠vel para uma palavra
    const buildFlexRegex = (palavra) => {
      let escaped = escapeRegex(palavra);
      // Permitir espa√ßo opcional antes de caracteres acentuados (PDF.js bug)
      escaped = escaped.replace(/([√Å√Ä√Ç√É√â√à√ä√ç√å√é√ì√í√î√ï√ö√ô√õ√á])/gi, '\\s*$1');
      // Permitir espa√ßo opcional ap√≥s pontos (W.P ‚Üí W. P)
      escaped = escaped.replace(/\\\./g, '\\.\\s*');
      return escaped;
    };

    nomesUsuario.forEach((nome, index) => {
      if (!nome || nome.trim().length < 2) return;
      // Remover anota√ß√µes entre par√™nteses: "EMPRESA LTDA (1¬™ reclamada)" ‚Üí "EMPRESA LTDA"
      let nomeClean = nome.trim().replace(/\s*\([^)]*\)\s*$/, '').trim();
      if (nomeClean.length < 2) return;
      // Limitar tamanho do nome para evitar ReDoS
      if (nomeClean.length > 200) nomeClean = nomeClean.substring(0, 200);

      const placeholder = `[PESSOA ${index + 1}]`;
      let matchCount = 0;

      // TENTATIVA 1: Busca normal (com espa√ßos flex√≠veis)
      // Limitar a 10 palavras para evitar regex muito complexa
      const palavras = nomeClean.split(/\s+/).slice(0, 10).map(buildFlexRegex);
      let regexStr = palavras.join('\\s+');
      regexStr = regexStr.replace(/\\s\+&\\s\+/g, '\\s*[&ÔºÜ]\\s*');
      const nomeRegex = new RegExp(regexStr, 'gi');

      matchCount = (result.match(nomeRegex) || []).length;
      if (matchCount > 0) {
        result = result.replace(nomeRegex, (m) => {
          encontrados.pessoa.push(m);
          return placeholder;
        });
      }

      // TENTATIVA 2: Busca normalizada (sem acentos) se n√£o encontrou
      if (matchCount === 0) {
        const nomeNorm = normalize(nomeClean);
        // Limitar a 10 palavras tamb√©m na busca normalizada
        const palavrasNorm = nomeNorm.split(/\s+/).slice(0, 10).map(buildFlexRegex);
        let regexStrNorm = palavrasNorm.join('\\s+');
        regexStrNorm = regexStrNorm.replace(/\\s\+&\\s\+/g, '\\s*[&ÔºÜ]\\s*');
        const regexNorm = new RegExp(regexStrNorm, 'gi');
        const resultNorm = normalize(result);

        // Encontrar posi√ß√µes no texto normalizado (limitar a 100 matches para evitar loops)
        const matches = [];
        let match;
        let matchLimit = 100;
        while ((match = regexNorm.exec(resultNorm)) !== null && matchLimit-- > 0) {
          matches.push({ start: match.index, len: match[0].length, original: result.substring(match.index, match.index + match[0].length) });
        }

        if (matches.length > 0) {
          // Substituir de tr√°s para frente (para manter √≠ndices)
          for (let i = matches.length - 1; i >= 0; i--) {
            const m = matches[i];
            encontrados.pessoa.push(m.original);
            result = result.substring(0, m.start) + placeholder + result.substring(m.start + m.len);
          }
          matchCount = matches.length;
        }
      }
    });
  }

  return result;
};

// üîß NORMALIZA√á√ÉO HTML (Remove espa√ßamento extra entre tags)
const normalizeHTMLSpacing = (html) => {
  if (!html) return html;
  return html
    .replace(/>\s*\n\s*\n+\s*</g, '><')
    .replace(/>\s*\n\s*</g, '><')
    .trim();
};

// üîß v1.35.29: Remove meta-coment√°rios de revis√£o que a IA pode adicionar ao final do texto
const removeMetaComments = (text) => {
  if (!text) return text;

  // Padr√µes de meta-coment√°rios que a IA pode adicionar
  const patterns = [
    /\n*\**\s*Revis(√£o|ei)[^<]*$/i,
    /\n*\**\s*Identifica(√ß√£o|do)[^<]*alucina√ß[^<]*$/i,
    /\n*\**\s*Confirmo que n√£o houve[^<]*$/i,
    /\n*\**\s*N√£o houve alucina√ß√£o[^<]*$/i,
    /\n*\**\s*REVIS√ÉO[:\s][^<]*$/i,
    /\n*\*{3,}[^<]*$/,  // *** linha final
  ];

  let cleaned = text;
  let removed = false;
  for (const pattern of patterns) {
    if (pattern.test(cleaned)) {
      cleaned = cleaned.replace(pattern, '');
      removed = true;
    }
  }

  // Log quando fallback √© ativado (meta-coment√°rio detectado e removido)
  if (removed) {
    console.warn('[Mini-Relat√≥rio] Meta-coment√°rio de revis√£o removido automaticamente');
  }

  return cleaned.trim();
};

// üîß HELPERS: Verifica√ß√£o de t√≥picos especiais
const SPECIAL_TOPICS = ['RELAT√ìRIO', 'DISPOSITIVO'];
const isSpecialTopic = (topic) => topic && SPECIAL_TOPICS.includes(topic.title?.toUpperCase());
const isRelatorio = (topic) => topic?.title?.toUpperCase() === 'RELAT√ìRIO';
const isDispositivo = (topic) => topic?.title?.toUpperCase() === 'DISPOSITIVO';

// üì¶ HOOKS CUSTOMIZADOS - Ver CLAUDE.md para documenta√ß√£o completa
// ü§ñ v1.35.26: AI_INSTRUCTIONS movido para src/prompts/system.js

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üé£ SE√á√ÉO 3: HOOKS CUSTOMIZADOS
// 21 hooks React para gerenciamento de estado, integra√ß√£o com IA, persist√™ncia e UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// üé£ CUSTOM HOOK: useModalManager
const useModalManager = () => {
  const [modals, setModals] = useState({
    modelForm: false,
    extractModelConfirm: false,
    extractedModelPreview: false,
    export: false,
    import: false,
    exportModels: false,
    deleteModel: false,
    deleteAllModels: false,
    deleteAllPrecedentes: false,
    rename: false,
    merge: false,
    split: false,
    newTopic: false,
    deleteTopic: false,
    aiAssistant: false,
    aiAssistantModel: false,
    analysis: false,
    settings: false,
    dispositivo: false,
    restoreSession: false,
    clearProject: false,
    bulkModel: false,
    bulkReview: false,
    bulkDiscardConfirm: false,
    confirmBulkCancel: false,
    addProofText: false,
    deleteProof: false,
    linkProof: false,
    proofAnalysis: false,
    globalEditor: false,
    jurisIndividual: false,
    proofTextAnonymization: false,
    proofExtractionAnonymization: false,
    sentenceReview: false,
    sentenceReviewResult: false,
    logout: false,  // v1.33.57
    shareLibrary: false  // v1.35.0
  });

  const [textPreview, setTextPreview] = useState({ isOpen: false, title: '', text: '' });

  const openModal = React.useCallback((modalName) => {
    setModals(prev => ({ ...prev, [modalName]: true }));
  }, []);

  const closeModal = React.useCallback((modalName) => {
    setModals(prev => ({ ...prev, [modalName]: false }));
  }, []);

  const closeAllModals = React.useCallback(() => {
    setModals(prev => Object.keys(prev).reduce((acc, key) => ({ ...acc, [key]: false }), {}));
  }, []);

  const isAnyModalOpen = React.useMemo(() => {
    return Object.values(modals).some(value => value === true);
  }, [modals]);

  return { modals, openModal, closeModal, closeAllModals, isAnyModalOpen, textPreview, setTextPreview };
};

// üé£ CUSTOM HOOK: useAIIntegration
// üîß Reducer para estados de gera√ß√£o de IA (consolidado)
const aiGenerationInitialState = {
  generic: { instruction: '', text: '', generating: false },
  model: { instruction: '', text: '', generating: false },
  relatorio: { instruction: '', regenerating: false },
  dispositivo: { instruction: '', text: '', generating: false, regenerating: false },
  keywords: { generating: false },
  title: { generating: false }
};

const aiGenerationReducer = (state, action) => {
  const ctx = action.context;
  const base = state[ctx] || aiGenerationInitialState[ctx] || {};
  switch (action.type) {
    case 'SET_INSTRUCTION':
      return { ...state, [ctx]: { ...base, instruction: action.value } };
    case 'SET_TEXT':
      return { ...state, [ctx]: { ...base, text: action.value } };
    case 'SET_GENERATING':
      return { ...state, [ctx]: { ...base, generating: action.value } };
    case 'SET_REGENERATING':
      return { ...state, [ctx]: { ...base, regenerating: action.value } };
    case 'RESET_CONTEXT':
      return { ...state, [ctx]: aiGenerationInitialState[ctx] };
    case 'RESET_ALL':
      return aiGenerationInitialState;
    default:
      return state;
  }
};

const useAIIntegration = () => {
  const [aiSettings, setAiSettingsState] = React.useState({
    // v1.30: Multi-provider support
    provider: 'claude',  // 'claude' | 'gemini'
    claudeModel: 'claude-sonnet-4-20250514',
    geminiModel: 'gemini-3-flash-preview',  // v1.32.36: Removido suporte a Gemini 2.5
    apiKeys: {
      claude: '',  // Chave Anthropic (sk-ant-...)
      gemini: ''   // Chave Google (AIza...)
    },
    // Gemini 3 specific: thinking_level instead of thinking_budget
    geminiThinkingLevel: 'high',  // 'minimal' | 'low' | 'medium' | 'high'
    // Legacy model field (for backwards compatibility)
    model: 'claude-sonnet-4-20250514',
    useExtendedThinking: false,
    thinkingBudget: '10000',
    customPrompt: '',
    modeloRelatorio: '',
    modeloDispositivo: '',
    modeloTopicoRelatorio: '',
    topicosComplementares: [
      { id: 1, title: 'HONOR√ÅRIOS ADVOCAT√çCIOS', category: 'M√âRITO', enabled: true, ordem: 1 },
      { id: 2, title: 'HONOR√ÅRIOS PERICIAIS', category: 'M√âRITO', enabled: true, ordem: 2 },
      { id: 3, title: 'JUROS E CORRE√á√ÉO MONET√ÅRIA', category: 'M√âRITO', enabled: true, ordem: 3 },
      { id: 4, title: 'DEDU√á√ïES DE NATUREZA PREVIDENCI√ÅRIA E FISCAL', category: 'M√âRITO', enabled: true, ordem: 4 },
      { id: 5, title: 'COMPENSA√á√ÉO/DEDU√á√ÉO/ABATIMENTO', category: 'M√âRITO', enabled: true, ordem: 5 }
    ],
    ocrEngine: 'pdfjs',  // Valores: 'pdfjs' | 'tesseract' | 'pdf-puro' | 'claude-vision'
    ocrLanguage: 'por',
    detailedMiniReports: false,
    topicsPerRequest: 1,
    parallelRequests: 5,  // v1.33.11: Requisi√ß√µes paralelas configur√°veis (3-20)
    // v1.16.0: Anonimiza√ß√£o de dados sens√≠veis (s√≥ funciona com ocrEngine: 'pdfjs')
    anonymization: {
      enabled: false,
      cpf: true,
      rg: true,
      pis: true,
      ctps: true,
      telefone: true,
      email: true,
      contaBancaria: true,
      valores: false,
      nomes: true,
      nomesUsuario: []
    },
    // v1.35.74: IA Local settings (antes em localStorage separado)
    semanticSearchEnabled: false,
    semanticThreshold: 50,
    jurisSemanticEnabled: false,
    jurisSemanticThreshold: 50,
    modelSemanticEnabled: false,
    modelSemanticThreshold: 40,
    useLocalAIForSuggestions: false,
    useLocalAIForJuris: false,
    // v1.20.0: Prompts r√°pidos para o Assistente IA
    quickPrompts: [
      {
        id: 'qp-1',
        name: 'Avaliar Decis√£o',
        prompt: 'Avalie criticamente a qualidade da decis√£o/fundamenta√ß√£o que redigi. IMPORTANTE: N√£o me bajule nem seja condescendente - quero uma avalia√ß√£o genuinamente cr√≠tica que me ajude a melhorar efetivamente. Seja direto ao apontar problemas. Considere: (1) coer√™ncia com os fatos narrados nos documentos, (2) adequa√ß√£o jur√≠dica aos pedidos, (3) clareza e objetividade da reda√ß√£o, (4) poss√≠veis lacunas ou inconsist√™ncias. Priorize apontar o que precisa melhorar, n√£o o que est√° bom.',
        icon: '‚öñÔ∏è'
      },
      {
        id: 'qp-2',
        name: 'Sugerir Melhorias',
        prompt: 'Sugira melhorias espec√≠ficas para o texto da decis√£o que redigi, mantendo o mesmo entendimento jur√≠dico mas aprimorando a reda√ß√£o, clareza e fundamenta√ß√£o.',
        icon: '‚ú®'
      },
      {
        id: 'qp-3',
        name: 'Verificar Omiss√µes',
        prompt: 'Verifique se h√° pedidos, argumentos ou provas relevantes nos documentos que n√£o foram adequadamente abordados na minha decis√£o. Liste qualquer omiss√£o encontrada.',
        icon: 'üîç'
      },
      {
        id: 'qp-4',
        name: 'An√°lise de Prova Oral',
        prompt: '**INSTRU√á√ÉO CR√çTICA**: Analise a prova oral EXCLUSIVAMENTE sobre "{TOPICO}".\n\nREGRAS OBRIGAT√ìRIAS:\n1. IGNORE 100% de qualquer trecho que N√ÉO trate de "{TOPICO}"\n2. N√ÉO mencione outros assuntos discutidos nos depoimentos\n3. Se um depoente falou sobre m√∫ltiplos temas, extraia APENAS o que se refere a "{TOPICO}"\n4. Se n√£o houver NENHUMA men√ß√£o a "{TOPICO}", responda: "N√£o h√° men√ß√£o a {TOPICO} nesta prova oral."\n\nProduza um resumo estruturado APENAS com trechos relevantes a "{TOPICO}", com minutagem quando dispon√≠vel:\n\nAUTOR: [afirma√ß√£o sobre {TOPICO}] (mm:ss);\nPREPOSTO: [afirma√ß√£o sobre {TOPICO}] (mm:ss);\nTestemunha [nome]: [afirma√ß√£o sobre {TOPICO}] (mm:ss);\n\n‚ö†Ô∏è LEMBRE-SE: Analise SOMENTE "{TOPICO}". Outros assuntos devem ser COMPLETAMENTE ignorados.',
        icon: 'üé§',
        proofFilter: 'oral'
      }
    ]
  });

  // v1.20.3: Contador de tokens persistente por projeto
  const [tokenMetrics, setTokenMetrics] = React.useState({
    totalInput: 0,
    totalOutput: 0,
    totalCacheRead: 0,
    totalCacheCreation: 0,
    requestCount: 0,
    lastUpdated: null
  });

  // üîß Estado consolidado de gera√ß√£o de IA (useReducer)
  const [aiGeneration, dispatchAI] = React.useReducer(aiGenerationReducer, aiGenerationInitialState);

  // v1.35.9: Todos os setters memoizados com useCallback para evitar re-renders
  // (createSetter retornava nova fun√ß√£o a cada render, causando lag em inputs)

  // Gen√©rica
  const aiInstruction = aiGeneration.generic.instruction;
  const setAiInstruction = React.useCallback(
    (value) => dispatchAI({ type: 'SET_INSTRUCTION', context: 'generic', value }),
    []
  );
  const aiGeneratedText = aiGeneration.generic.text;
  const setAiGeneratedText = React.useCallback(
    (value) => dispatchAI({ type: 'SET_TEXT', context: 'generic', value }),
    []
  );
  const generatingAi = aiGeneration.generic.generating;
  const setGeneratingAi = React.useCallback(
    (value) => dispatchAI({ type: 'SET_GENERATING', context: 'generic', value }),
    []
  );

  // Modelo
  const aiInstructionModel = aiGeneration.model.instruction;
  const setAiInstructionModel = React.useCallback(
    (value) => dispatchAI({ type: 'SET_INSTRUCTION', context: 'model', value }),
    []
  );
  const aiGeneratedTextModel = aiGeneration.model.text;
  const setAiGeneratedTextModel = React.useCallback(
    (value) => dispatchAI({ type: 'SET_TEXT', context: 'model', value }),
    []
  );
  const generatingAiModel = aiGeneration.model.generating;
  const setGeneratingAiModel = React.useCallback(
    (value) => dispatchAI({ type: 'SET_GENERATING', context: 'model', value }),
    []
  );

  // Keywords e Title
  const generatingKeywords = aiGeneration.keywords.generating;
  const setGeneratingKeywords = React.useCallback(
    (value) => dispatchAI({ type: 'SET_GENERATING', context: 'keywords', value }),
    []
  );
  const generatingTitle = aiGeneration.title.generating;
  const setGeneratingTitle = React.useCallback(
    (value) => dispatchAI({ type: 'SET_GENERATING', context: 'title', value }),
    []
  );

  // Relat√≥rio
  const relatorioInstruction = aiGeneration.relatorio.instruction;
  const setRelatorioInstruction = React.useCallback(
    (value) => dispatchAI({ type: 'SET_INSTRUCTION', context: 'relatorio', value }),
    []
  );
  const regeneratingRelatorio = aiGeneration.relatorio.regenerating;
  const setRegeneratingRelatorio = React.useCallback(
    (value) => dispatchAI({ type: 'SET_REGENERATING', context: 'relatorio', value }),
    []
  );
  const regenerating = aiGeneration.relatorio.regenerating;
  const setRegenerating = React.useCallback(
    (value) => dispatchAI({ type: 'SET_REGENERATING', context: 'relatorio', value }),
    []
  );

  // Dispositivo
  const dispositivoText = aiGeneration.dispositivo.text;
  const setDispositivoText = React.useCallback(
    (value) => dispatchAI({ type: 'SET_TEXT', context: 'dispositivo', value }),
    []
  );
  const generatingDispositivo = aiGeneration.dispositivo.generating;
  const setGeneratingDispositivo = React.useCallback(
    (value) => dispatchAI({ type: 'SET_GENERATING', context: 'dispositivo', value }),
    []
  );
  const dispositivoInstruction = aiGeneration.dispositivo.instruction;
  const setDispositivoInstruction = React.useCallback(
    (value) => dispatchAI({ type: 'SET_INSTRUCTION', context: 'dispositivo', value }),
    []
  );
  const regeneratingDispositivo = aiGeneration.dispositivo.regenerating;
  const setRegeneratingDispositivo = React.useCallback(
    (value) => dispatchAI({ type: 'SET_REGENERATING', context: 'dispositivo', value }),
    []
  );

  // Load AI Settings
  React.useEffect(() => {
    const loadAiSettings = () => {
      try {
        const saved = localStorage.getItem('sentencify-ai-settings');
        if (saved) {
          const parsed = JSON.parse(saved);

          // v1.30: Migra√ß√£o para multi-provider (garante defaults para campos novos)
          if (!parsed.provider) parsed.provider = 'claude';
          if (!parsed.claudeModel) parsed.claudeModel = parsed.model || 'claude-sonnet-4-20250514';
          // v1.32.36: Migrar Gemini 2.5 ‚Üí Gemini 3
          if (!parsed.geminiModel || parsed.geminiModel.includes('2.5')) {
            parsed.geminiModel = 'gemini-3-flash-preview';
          }
          if (!parsed.apiKeys) parsed.apiKeys = { claude: '', gemini: '' };
          if (!parsed.geminiThinkingLevel) parsed.geminiThinkingLevel = 'high';

          // v1.16.0: Deep merge para anonymization (preserva defaults para usu√°rios antigos)
          if (parsed.anonymization) {
            parsed.anonymization = {
              enabled: false, cpf: true, rg: true, pis: true, ctps: true,
              telefone: true, email: true, contaBancaria: true, valores: false, nomes: true, processo: true,
              nomesUsuario: [],
              ...parsed.anonymization
            };
          }

          // v1.35.74: Adicionar defaults para campos novos de IA Local
          const iaLocalDefaults = {
            semanticSearchEnabled: false,
            semanticThreshold: 50,
            jurisSemanticEnabled: false,
            jurisSemanticThreshold: 50,
            modelSemanticEnabled: false,
            modelSemanticThreshold: 40,
            useLocalAIForSuggestions: false,
            useLocalAIForJuris: false
          };
          // Merge: defaults primeiro, depois valores salvos sobrescrevem
          Object.keys(iaLocalDefaults).forEach(key => {
            if (parsed[key] === undefined) {
              parsed[key] = iaLocalDefaults[key];
            }
          });

          // v1.21.2: Merge inteligente de quickPrompts
          // - Preserva quick prompts customizados do usu√°rio (IDs que n√£o s√£o qp-1 a qp-4)
          // - Atualiza quick prompts padr√£o com vers√µes mais recentes do c√≥digo
          const defaultQpIds = ['qp-1', 'qp-2', 'qp-3', 'qp-4'];
          const userCustomQps = (parsed.quickPrompts || []).filter(qp => !defaultQpIds.includes(qp.id));
          const { quickPrompts: _ignoredQp, ...parsedWithoutQp } = parsed;
          setAiSettingsState(prev => ({
            ...prev,
            ...parsedWithoutQp,
            quickPrompts: [
              ...prev.quickPrompts.filter(qp => defaultQpIds.includes(qp.id)), // defaults do c√≥digo
              ...userCustomQps // customizados do usu√°rio
            ]
          }));
        }
      } catch (err) {
        console.warn('[loadAiSettings] Erro ao carregar configura√ß√µes:', err.message);
      }
    };

    loadAiSettings();
  }, []);

  // Save AI Settings - v1.21.13: suporta tanto objeto direto quanto fun√ß√£o updater
  const setAiSettings = React.useCallback((newSettingsOrUpdater) => {
    if (typeof newSettingsOrUpdater === 'function') {
      setAiSettingsState(prev => {
        const newSettings = newSettingsOrUpdater(prev);
        try {
          localStorage.setItem('sentencify-ai-settings', JSON.stringify(newSettings));
        } catch (err) {}
        return newSettings;
      });
    } else {
      setAiSettingsState(newSettingsOrUpdater);
      try {
        localStorage.setItem('sentencify-ai-settings', JSON.stringify(newSettingsOrUpdater));
      } catch (err) {}
    }
  }, []);

  // Utilities
  // v1.20.3: Modificado para acumular tokens no estado persistente
  const logCacheMetrics = React.useCallback((data) => {
    if (data.usage) {
      const input = data.usage.input_tokens || 0;
      const output = data.usage.output_tokens || 0;
      const cacheRead = data.usage.cache_read_input_tokens || 0;
      const cacheCreation = data.usage.cache_creation_input_tokens || 0;

      // Acumular no contador persistente
      setTokenMetrics(prev => ({
        totalInput: prev.totalInput + input,
        totalOutput: prev.totalOutput + output,
        totalCacheRead: prev.totalCacheRead + cacheRead,
        totalCacheCreation: prev.totalCacheCreation + cacheCreation,
        requestCount: prev.requestCount + 1,
        lastUpdated: new Date().toISOString()
      }));
    }
  }, []);

  // Retorna array com cache_control para Prompt Caching
  const getAiInstructions = React.useCallback(() => {
    const customPrompt = aiSettings?.customPrompt?.trim();

    if (customPrompt) {
      // Retorna array: base (cacheada) + custom (n√£o cacheada)
      return [
        {
          type: "text",
          text: AI_INSTRUCTIONS,
          cache_control: { type: "ephemeral" }
        },
        {
          type: "text",
          text: `\n\n**INSTRU√á√ïES PERSONALIZADAS DO USU√ÅRIO:**\n${customPrompt}`
        }
      ];
    }

    // Retorna array com base cacheada
    return [
      {
        type: "text",
        text: AI_INSTRUCTIONS,
        cache_control: { type: "ephemeral" }
      }
    ];
  }, [aiSettings]);

  // Build API Request
  const buildApiRequest = React.useCallback((messages, optionsOrMaxTokens = {}) => {
    const options = typeof optionsOrMaxTokens === 'number'
      ? { maxTokens: optionsOrMaxTokens }
      : optionsOrMaxTokens;

    const {
      maxTokens = 4000,
      systemPrompt = null,
      useInstructions = false,
      model = null,
      disableThinking = false,
      temperature = null,
      topP = null,
      topK = null
    } = options;

    let savedModel = null;
    try {
      const saved = localStorage.getItem('sentencify-ai-settings');
      if (saved) savedModel = JSON.parse(saved).model;
    } catch (e) { /* localStorage indispon√≠vel */ }
    const modelToUse = model || aiSettings?.model || savedModel || 'claude-sonnet-4-20250514';

    const useThinking = !disableThinking && (aiSettings?.useExtendedThinking || false);

    const MODEL_MAX_TOKENS = {
      'claude-sonnet-4-20250514': 64000,
      'claude-opus-4-5-20251101': 32000
    };
    const modelMaxTokens = MODEL_MAX_TOKENS[modelToUse] || 64000;

    const parsedBudget = parseInt(aiSettings?.thinkingBudget || '10000', 10);
    const rawThinkingBudget = isNaN(parsedBudget) ? 10000 : parsedBudget;

    const maxAllowedBudget = useThinking ? Math.max(modelMaxTokens - 2000, 1024) : 0;
    const thinkingBudget = useThinking ? Math.min(rawThinkingBudget, maxAllowedBudget) : 0;

    const rawAdjustedTokens = useThinking ? Math.max(maxTokens + thinkingBudget, thinkingBudget + 2000) : maxTokens;
    const adjustedMaxTokens = Math.min(rawAdjustedTokens, modelMaxTokens);

    const processedMessages = messages.map(message => {
      if (message.content && Array.isArray(message.content)) {
        let cacheBlocksCount = 0;
        const MAX_CACHE_BLOCKS = 3; // 3 nas messages + 1 no system = 4 total (limite da API)

        const processedContent = message.content.map((block, index, array) => {
          const isLastBlock = index === array.length - 1;

          if (isLastBlock) {
            return block;
          }

          if (cacheBlocksCount >= MAX_CACHE_BLOCKS) {
            return block;
          }

          if (block.type === 'document') {
            cacheBlocksCount++;
            return {
              ...block,
              cache_control: { type: "ephemeral" }
            };
          }

          if (block.type === 'text' && block.text && block.text.length > 2000) {
            cacheBlocksCount++;
            return {
              ...block,
              cache_control: { type: "ephemeral" }
            };
          }

          return block;
        });

        return {
          ...message,
          content: processedContent
        };
      }

      return message;
    });

    const requestBody = {
      model: modelToUse,
      max_tokens: adjustedMaxTokens,
      messages: processedMessages
    };

    // v1.21.25: Parametros opcionais de geracao (apenas se explicitamente passados)
    if (temperature !== null) requestBody.temperature = temperature;
    if (topP !== null) requestBody.top_p = topP;
    if (topK !== null) requestBody.top_k = topK;

    // System prompt com Prompt Caching
    let finalSystemPrompt = null;
    if (systemPrompt) {
      // systemPrompt customizado: wrap em array com cache
      finalSystemPrompt = [
        {
          type: "text",
          text: systemPrompt,
          cache_control: { type: "ephemeral" }
        }
      ];
    } else if (useInstructions) {
      // getAiInstructions() j√° retorna array com cache_control
      finalSystemPrompt = getAiInstructions();
    }

    if (finalSystemPrompt) {
      requestBody.system = finalSystemPrompt;
    }

    if (useThinking) {
      requestBody.thinking = {
        type: "enabled",
        budget_tokens: thinkingBudget
      };
    }

    return requestBody;
  }, [aiSettings, getAiInstructions]);

  // Retorna headers HTTP para API Anthropic
  const getApiHeaders = React.useCallback(() => {
    return {
      'Content-Type': 'application/json',
      'anthropic-beta': 'prompt-caching-2024-07-31'
    };
  }, []);

  // Wrapper para chamadas √† API Anthropic (com retry, timeout e caching)
  // Constantes para retry com backoff exponencial
  const RETRY_MAX_ATTEMPTS = 3;
  const RETRY_INITIAL_DELAY = 5000; // 5 segundos
  const RETRY_BACKOFF_MULTIPLIER = 2; // 5s, 10s, 20s

  const callLLM = React.useCallback(async (messages, options = {}) => {
    const {
      maxTokens = 4000,
      useInstructions = true,
      systemPrompt = null,
      model = null,
      disableThinking = false,
      timeout = null,
      abortSignal = null,
      logMetrics = true,
      extractText = true,
      validateResponse = true
    } = options;

    // v1.32.33: Auto-aumentar timeout para 5 min quando thinking budget >= 40K
    const thinkingBudget = parseInt(aiSettings?.thinkingBudget || '10000', 10);
    const useThinking = !disableThinking && (aiSettings?.useExtendedThinking || false);
    const effectiveTimeout = timeout || (useThinking && thinkingBudget >= 40000 ? 300000 : null); // 5 min para budgets altos

    // Criar AbortController interno se timeout especificado
    const internalController = effectiveTimeout ? new AbortController() : null;
    const timeoutId = effectiveTimeout ? setTimeout(() => internalController.abort(), effectiveTimeout) : null;

    // Combinar signals: externo tem prioridade, sen√£o interno
    const signal = abortSignal || internalController?.signal;

    let lastError = null;

    // Loop de retry para erros 429
    for (let attempt = 0; attempt < RETRY_MAX_ATTEMPTS; attempt++) {
      try {
        const contentSummary = messages[0]?.content?.map(c =>
          c.type === 'document' ? `üìÑ PDF (${Math.round((c.source?.data?.length || 0)/1024)}KB)` :
          c.type === 'text' ? `üìù Texto (${(c.text?.length || 0)} chars)` : c.type
        ) || [];

        // Fazer requisi√ß√£o √† API (v1.30: via proxy local)
        const response = await fetch(`${API_BASE}/api/claude/messages`, {
          method: 'POST',
          headers: {
            ...getApiHeaders(),
            'x-api-key': aiSettings.apiKeys?.claude || ''
          },
          body: JSON.stringify(buildApiRequest(messages, {
            maxTokens,
            useInstructions,
            systemPrompt,
            model,
            disableThinking
          })),
          signal
        });

        // Se erro 429 (rate limit), 529 (overloaded) ou 520 (cloudflare), aguardar e tentar novamente
        if ((response.status === 429 || response.status === 529 || response.status === 520 || response.status === 502) && attempt < RETRY_MAX_ATTEMPTS - 1) {
          const delay = RETRY_INITIAL_DELAY * Math.pow(RETRY_BACKOFF_MULTIPLIER, attempt);
          await new Promise(resolve => setTimeout(resolve, delay));
          continue;
        }

        // Limpar timeout se completou
        if (timeoutId) clearTimeout(timeoutId);

        // Validar status HTTP
        if (validateResponse && !response.ok) {
          const errorText = await response.text();
          throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
        }

        // Parsear JSON
        const data = await response.json();

        // v1.32.39: Log thinking no console do browser (v1.32.40: toggle)
        if (aiSettings.logThinking) {
          const thinkingBlock = data.content?.find(c => c.type === 'thinking');
          if (thinkingBlock?.thinking) {
            console.group('[Claude] Thinking');
            console.log(thinkingBlock.thinking);
            console.groupEnd();
          }
        }

        if (data.usage) {
          const u = data.usage;
          const cacheRead = u.cache_read_input_tokens || 0;
          const cacheCreation = u.cache_creation_input_tokens || 0;
          const regularInput = u.input_tokens || 0;
          const output = u.output_tokens || 0;
        }

        // Logar m√©tricas de cache
        if (logMetrics) {
          logCacheMetrics(data);
        }

        // Verificar erros da API
        if (validateResponse && data.error) {
          throw new Error(`Erro da API: ${data.error.message || JSON.stringify(data.error)}`);
        }

        // Retornar resposta bruta se solicitado
        if (!extractText) {
          return data;
        }

        // Extrair texto da resposta
        const textContent = data.content?.find(c => c.type === 'text')?.text || '';

        // Validar se encontrou conte√∫do
        if (validateResponse && !textContent) {
          throw new Error('Nenhum conte√∫do de texto encontrado na resposta da API');
        }

        return textContent.trim();

      } catch (err) {
        lastError = err;

        // Limpar timeout em caso de erro
        if (timeoutId) clearTimeout(timeoutId);

        // Tratar erros de abort (n√£o retentar)
        if (err.name === 'AbortError') {
          if (abortSignal?.aborted) {
            throw new Error('Opera√ß√£o cancelada pelo usu√°rio');
          } else {
            throw new Error(`Timeout: opera√ß√£o demorou mais de ${effectiveTimeout / 1000}s`);
          }
        }

        // Se n√£o √© √∫ltima tentativa e erro parece ser de rate limit, overload, conex√£o ou JSON malformado da API
        if (attempt < RETRY_MAX_ATTEMPTS - 1 && (err.message?.includes('429') || err.message?.includes('529') || err.message?.includes('520') || err.message?.includes('502') || err.message?.includes('Overloaded') || err.message?.includes('Failed to fetch') || err.message?.includes('parsear resposta'))) {
          const delay = RETRY_INITIAL_DELAY * Math.pow(RETRY_BACKOFF_MULTIPLIER, attempt);
          await new Promise(resolve => setTimeout(resolve, delay));
          continue;
        }

        // Re-lan√ßar outros erros
        throw err;
      }
    }

    // Se chegou aqui, todas as tentativas falharam
    throw lastError || new Error('Todas as tentativas falharam');
  }, [getApiHeaders, buildApiRequest, logCacheMetrics, aiSettings]);

  // ========================================
  // v1.30: MULTI-PROVIDER SUPPORT (Gemini)
  // ========================================

  // Converter formato de mensagens Claude ‚Üí Gemini
  const convertToGeminiFormat = React.useCallback((claudeMessages, systemPrompt = null) => {
    const contents = claudeMessages.map(msg => ({
      role: msg.role === 'assistant' ? 'model' : 'user',
      parts: Array.isArray(msg.content)
        ? msg.content.map(c => {
            // Texto simples
            if (c.type === 'text') return { text: c.text };
            // Imagem (base64)
            if (c.type === 'image') return {
              inlineData: { mimeType: c.source?.media_type || 'image/png', data: c.source?.data }
            };
            // PDF/Documento
            if (c.type === 'document' && c.source?.type === 'base64') {
              return {
                inlineData: {
                  mimeType: c.source.media_type || 'application/pdf',
                  data: c.source.data
                }
              };
            }
            // Fallback
            return { text: JSON.stringify(c) };
          })
        : [{ text: msg.content }]
    }));

    const result = { contents };

    // System prompt ‚Üí systemInstruction
    if (systemPrompt) {
      const systemText = Array.isArray(systemPrompt)
        ? systemPrompt.map(s => s.text || s).join('\n\n')
        : systemPrompt;
      result.systemInstruction = { parts: [{ text: systemText }] };
    }

    return result;
  }, []);

  // Extrair m√©tricas de tokens da resposta (provider-aware)
  const extractTokenMetrics = React.useCallback((data, provider) => {
    if (provider === 'gemini') {
      const usage = data.usageMetadata || {};
      return {
        input: usage.promptTokenCount || 0,
        output: usage.candidatesTokenCount || 0,
        cacheRead: usage.cachedContentTokenCount || 0,
        cacheCreation: 0
      };
    }
    // Claude (default)
    const usage = data.usage || {};
    return {
      input: usage.input_tokens || 0,
      output: usage.output_tokens || 0,
      cacheRead: usage.cache_read_input_tokens || 0,
      cacheCreation: usage.cache_creation_input_tokens || 0
    };
  }, []);

  // Extrair texto da resposta (provider-aware)
  const extractResponseText = React.useCallback((data, provider) => {
    if (provider === 'gemini') {
      const candidate = data.candidates?.[0];
      const finishReason = candidate?.finishReason;

      // Verificar bloqueio de seguran√ßa
      if (finishReason === 'SAFETY') {
        throw new Error('Resposta bloqueada por seguran√ßa. Reformule a pergunta.');
      }
      if (finishReason === 'RECITATION') {
        throw new Error('Resposta bloqueada por direitos autorais.');
      }
      if (data.promptFeedback?.blockReason) {
        throw new Error(`Prompt bloqueado: ${data.promptFeedback.blockReason}`);
      }

      // v1.32.35: Com thinking habilitado, parts[0] √© o thinking block
      // Buscar o primeiro part que N√ÉO seja thinking (thought !== true)
      const parts = candidate?.content?.parts || [];
      const textPart = parts.find(p => !p.thought && p.text);
      return textPart?.text || '';
    }
    // Claude (default)
    return data.content?.find(c => c.type === 'text')?.text || '';
  }, []);

  // v1.32.37: Configurar thinking para Gemini 3 (removido suporte a 2.5)
  // Docs: https://ai.google.dev/gemini-api/docs/thinking
  // Gemini 3: usa thinking_level enum (n√£o pode desativar)
  // - Flash: minimal, low, medium, high
  // - Pro: low, high (n√£o tem minimal nem medium)
  const getGeminiThinkingConfig = React.useCallback((model) => {
    let level = aiSettings.geminiThinkingLevel || 'high';

    // v1.32.37: Pro s√≥ suporta low/high - converter valores inv√°lidos
    const isPro = model?.includes('pro');
    if (isPro && (level === 'minimal' || level === 'medium')) {
      level = 'low';  // Fallback para n√≠vel v√°lido mais pr√≥ximo
    }

    return { thinking_level: level };
  }, [aiSettings.geminiThinkingLevel]);

  // C√≥digos de status para retry por provider
  const GEMINI_RETRY_CODES = [429, 500, 502, 503, 529];

  // Chamada √† API Gemini
  const callGeminiAPI = React.useCallback(async (messages, options = {}) => {
    const {
      maxTokens = 4000,
      systemPrompt = null,
      useInstructions = false,  // v1.32.29: Suporte a useInstructions igual ao Claude
      model = aiSettings.geminiModel || 'gemini-3-flash-preview',
      temperature = null,
      topP = null,
      topK = null,
      timeout = null,
      abortSignal = null,
      logMetrics = true,
      extractText = true
    } = options;

    // v1.32.29: Resolver systemPrompt igual ao Claude (useInstructions ‚Üí getAiInstructions)
    let finalSystemPrompt = systemPrompt;
    if (!finalSystemPrompt && useInstructions) {
      const instructions = getAiInstructions();
      // getAiInstructions() retorna array [{text: "...", cache_control: ...}]
      // Converter para string para o Gemini
      finalSystemPrompt = Array.isArray(instructions)
        ? instructions.map(i => i.text || i).join('\n\n')
        : instructions;
    }

    const RETRY_MAX = 3;
    const RETRY_DELAY = 5000;

    // AbortController para timeout
    const internalController = timeout ? new AbortController() : null;
    const timeoutId = timeout ? setTimeout(() => internalController.abort(), timeout) : null;
    const signal = abortSignal || internalController?.signal;

    let lastError = null;

    for (let attempt = 0; attempt < RETRY_MAX; attempt++) {
      try {
        // Converter mensagens para formato Gemini
        const geminiRequest = convertToGeminiFormat(messages, finalSystemPrompt);

        // v1.32.38: Gemini thinking consome maxOutputTokens - adicionar buffer
        const thinkingLevel = aiSettings.geminiThinkingLevel || 'high';
        const thinkingBuffer = {
          'minimal': 2000,
          'low': 4000,
          'medium': 8000,
          'high': 16000
        }[thinkingLevel] || 8000;

        // Configurar generationConfig com buffer para thinking
        geminiRequest.generationConfig = {
          maxOutputTokens: maxTokens + thinkingBuffer
        };

        // Gemini 3: for√ßar temperature 1.0 para evitar bugs
        // Gemini 2.x: m√≠nimo 0.5 para evitar filtro RECITATION (Google recomenda temp alta)
        const isGemini3 = model.includes('gemini-3') || model.includes('3-flash') || model.includes('3-pro');
        if (isGemini3) {
          geminiRequest.generationConfig.temperature = 1.0;  // Recomendado pelo Google
        } else {
          // Gemini 2.x: usar temperatura fornecida, mas m√≠nimo 0.7 para evitar RECITATION
          const minTemp = 0.7;
          geminiRequest.generationConfig.temperature = temperature !== null
            ? Math.max(temperature, minTemp)
            : minTemp;
        }

        if (topP !== null) geminiRequest.generationConfig.topP = topP;
        if (topK !== null) geminiRequest.generationConfig.topK = topK;

        // v1.32.36: Gemini 3 sempre usa thinking (n√£o pode desativar)
        // v1.32.39: includeThoughts para retornar pensamentos na resposta
        geminiRequest.generationConfig.thinking_config = {
          ...getGeminiThinkingConfig(model),
          includeThoughts: true
        };

        // Fazer requisi√ß√£o via proxy local
        const response = await fetch(`${API_BASE}/api/gemini/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model,
            apiKey: aiSettings.apiKeys?.gemini || '',
            request: geminiRequest
          }),
          signal
        });

        // Retry em caso de rate limit ou erro tempor√°rio
        if (GEMINI_RETRY_CODES.includes(response.status) && attempt < RETRY_MAX - 1) {
          const delay = RETRY_DELAY * Math.pow(2, attempt);
          console.warn(`[Gemini] Retry ${attempt + 1}/${RETRY_MAX} ap√≥s ${delay}ms`);
          await new Promise(r => setTimeout(r, delay));
          continue;
        }

        if (timeoutId) clearTimeout(timeoutId);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();

        // v1.32.39: Log thinking no console do browser (v1.32.40: toggle)
        if (aiSettings.logThinking) {
          const parts = data.candidates?.[0]?.content?.parts || [];
          const thinkingPart = parts.find(p => p.thought === true);
          if (thinkingPart?.text) {
            console.group('[Gemini] Thinking');
            console.log(thinkingPart.text);
            console.groupEnd();
          }
        }

        // Logar m√©tricas
        if (logMetrics && data.usageMetadata) {
          const metrics = extractTokenMetrics(data, 'gemini');
          setTokenMetrics(prev => ({
            totalInput: prev.totalInput + metrics.input,
            totalOutput: prev.totalOutput + metrics.output,
            totalCacheRead: prev.totalCacheRead + metrics.cacheRead,
            totalCacheCreation: prev.totalCacheCreation + metrics.cacheCreation,
            requestCount: prev.requestCount + 1,
            lastUpdated: new Date().toISOString()
          }));
        }

        // Retornar resposta bruta se solicitado
        if (!extractText) {
          return data;
        }

        // Extrair texto
        const textContent = extractResponseText(data, 'gemini');
        return textContent.trim();

      } catch (err) {
        lastError = err;
        if (timeoutId) clearTimeout(timeoutId);

        if (err.name === 'AbortError') {
          throw new Error(abortSignal?.aborted ? 'Opera√ß√£o cancelada' : `Timeout ap√≥s ${timeout/1000}s`);
        }

        if (attempt < RETRY_MAX - 1) {
          const delay = RETRY_DELAY * Math.pow(2, attempt);
          await new Promise(r => setTimeout(r, delay));
          continue;
        }

        throw err;
      }
    }

    throw lastError || new Error('Todas as tentativas falharam');
  }, [aiSettings, convertToGeminiFormat, extractTokenMetrics, extractResponseText, getGeminiThinkingConfig, setTokenMetrics, getAiInstructions]);

  // Fun√ß√£o unificada que escolhe Claude ou Gemini baseado no provider
  const callAI = React.useCallback(async (messages, options = {}) => {
    const provider = aiSettings.provider || 'claude';

    if (provider === 'gemini') {
      return await callGeminiAPI(messages, {
        ...options,
        model: options.model || aiSettings.geminiModel || 'gemini-3-flash-preview'
      });
    }

    // Default: Claude
    return await callLLM(messages, {
      ...options,
      model: options.model || aiSettings.claudeModel || 'claude-sonnet-4-20250514'
    });
  }, [aiSettings, callLLM, callGeminiAPI]);

  // ========================================
  // END MULTI-PROVIDER SUPPORT
  // ========================================

  const getModelDisplayName = React.useCallback((modelId) => {
    const models = {
      // Claude
      'claude-sonnet-4-20250514': 'Claude Sonnet 4.5',
      'claude-opus-4-5-20251101': 'Claude Opus 4.5',
      // Gemini 3 (v1.32.36: removido 2.5)
      'gemini-3-flash-preview': 'Gemini 3 Flash',
      'gemini-3-pro-preview': 'Gemini 3 Pro'
    };
    return models[modelId] || modelId;
  }, []);

  return {
    // Estados
    aiSettings,
    aiInstruction,
    aiGeneratedText,
    generatingAi,
    aiInstructionModel,
    aiGeneratedTextModel,
    generatingAiModel,
    generatingKeywords,
    relatorioInstruction,
    regeneratingRelatorio,
    regenerating,
    dispositivoText,
    generatingDispositivo,
    dispositivoInstruction,
    regeneratingDispositivo,

    // Setters
    setAiSettings,
    setAiInstruction,
    setAiGeneratedText,
    setGeneratingAi,
    setAiInstructionModel,
    setAiGeneratedTextModel,
    setGeneratingAiModel,
    setGeneratingKeywords,
    generatingTitle,
    setGeneratingTitle,
    setRelatorioInstruction,
    setRegeneratingRelatorio,
    setRegenerating,
    setDispositivoText,
    setGeneratingDispositivo,
    setDispositivoInstruction,
    setRegeneratingDispositivo,

    // Fun√ß√µes
    buildApiRequest,
    getApiHeaders,
    callLLM,
    logCacheMetrics,
    getAiInstructions,
    getModelDisplayName,

    // v1.30: Multi-provider support
    callGeminiAPI,
    callAI,
    convertToGeminiFormat,
    extractTokenMetrics,
    extractResponseText,

    // v1.20.3: Contador de tokens persistente
    tokenMetrics,
    setTokenMetrics
  };
};

// üé£ CUSTOM HOOK: useFullscreen (v1.9.22) - Controle de fullscreen e split mode
const useFullscreen = () => {
  const [isFullscreen, setIsFullscreen] = React.useState(false);
  const [isSplitMode, setIsSplitMode] = React.useState(false);
  const [splitPosition, setSplitPosition] = React.useState(70); // percentual do editor (70/30)
  const containerRef = React.useRef(null);

  const toggleFullscreen = React.useCallback(() => {
    setIsFullscreen(prev => {
      const newValue = !prev;
      if (prev) {
        document.body.style.overflow = '';
      }
      return newValue;
    });
    // Fechar split mode separadamente para evitar race condition
    setIsSplitMode(prev => prev ? false : prev);
  }, []);

  const toggleSplitMode = React.useCallback(() => {
    setIsSplitMode(prev => !prev);
  }, []);

  // Handler para drag do divisor
  const handleSplitDrag = React.useCallback((e) => {
    const container = containerRef.current;
    if (!container) return;

    const rect = container.getBoundingClientRect();
    const newPosition = ((e.clientX - rect.left) / rect.width) * 100;

    // Limitar entre 20% e 80%
    const clampedPosition = Math.max(20, Math.min(80, newPosition));
    setSplitPosition(clampedPosition);
  }, []);

  // Atalhos de teclado: Ctrl+F para ativar, ESC para sair, Ctrl+M para split
  React.useEffect(() => {
    const handleKeyDown = (e) => {
      // Ctrl+F: ativa fullscreen quando foco est√° no container do editor
      if (e.ctrlKey && e.key === 'f') {
        const container = containerRef.current;
        if (container && (container.contains(document.activeElement) || isFullscreen)) {
          e.preventDefault();
          toggleFullscreen();
        }
      }
      if (e.ctrlKey && e.key === 'm' && isFullscreen) {
        e.preventDefault();
        setIsSplitMode(prev => !prev);
      }
      // ESC: fecha split primeiro, depois fullscreen
      if (e.key === 'Escape') {
        if (isSplitMode) {
          setIsSplitMode(false);
        } else if (isFullscreen) {
          setIsFullscreen(false);
        }
      }
    };

    document.addEventListener('keydown', handleKeyDown);

    if (isFullscreen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }

    return () => {
      document.removeEventListener('keydown', handleKeyDown);
      document.body.style.overflow = '';
    };
  }, [isFullscreen, isSplitMode, toggleFullscreen]);

  return { isFullscreen, toggleFullscreen, isSplitMode, toggleSplitMode, splitPosition, handleSplitDrag, containerRef };
};

const useSpacingControl = () => {
  const STORAGE_KEY = 'sentencify-paragraph-spacing';

  // Estado com lazy initialization do localStorage
  const [spacing, setSpacingState] = React.useState(() => {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved && SPACING_PRESETS[saved]) {
        return saved;
      }
    } catch (err) {
    }
    return 'normal'; // Fallback para preset padr√£o
  });

  // Persistir no localStorage quando mudar
  React.useEffect(() => {
    try {
      localStorage.setItem(STORAGE_KEY, spacing);
    } catch (err) {
    }
  }, [spacing]);

  React.useEffect(() => {
    const handleSpacingChange = (e) => {
      // Evitar loop infinito: s√≥ atualizar se for diferente
      if (e.detail.spacing !== spacing) {
        setSpacingState(e.detail.spacing);
      }
    };

    window.addEventListener('spacing-changed', handleSpacingChange);
    return () => window.removeEventListener('spacing-changed', handleSpacingChange);
  }, [spacing]);

  // Fun√ß√£o de controle com valida√ß√£o
  const setSpacing = React.useCallback((newSpacing) => {
    if (SPACING_PRESETS[newSpacing]) {
      setSpacingState(newSpacing);
      window.dispatchEvent(new CustomEvent('spacing-changed', {
        detail: { spacing: newSpacing }
      }));
    } else {
      setSpacingState('normal');
      window.dispatchEvent(new CustomEvent('spacing-changed', {
        detail: { spacing: 'normal' }
      }));
    }
  }, []);

  // Retornar API
  const currentPreset = SPACING_PRESETS[spacing];

  return {
    spacing,
    setSpacing,
    currentPreset
  };
};

// üé£ CUSTOM HOOK: useFontSizeControl (v1.10.8)
const useFontSizeControl = () => {
  const STORAGE_KEY = 'sentencify-editor-fontsize';

  const [fontSize, setFontSizeState] = React.useState(() => {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved && FONTSIZE_PRESETS[saved]) {
        return saved;
      }
    } catch (err) {
    }
    return 'normal';
  });

  React.useEffect(() => {
    try {
      localStorage.setItem(STORAGE_KEY, fontSize);
    } catch (err) {
    }
  }, [fontSize]);

  React.useEffect(() => {
    const handleFontSizeChange = (e) => {
      if (e.detail.fontSize !== fontSize) {
        setFontSizeState(e.detail.fontSize);
      }
    };

    window.addEventListener('fontsize-changed', handleFontSizeChange);
    return () => window.removeEventListener('fontsize-changed', handleFontSizeChange);
  }, [fontSize]);

  const setFontSize = React.useCallback((newFontSize) => {
    if (FONTSIZE_PRESETS[newFontSize]) {
      setFontSizeState(newFontSize);
      window.dispatchEvent(new CustomEvent('fontsize-changed', {
        detail: { fontSize: newFontSize }
      }));
    } else {
      setFontSizeState('normal');
      window.dispatchEvent(new CustomEvent('fontsize-changed', {
        detail: { fontSize: 'normal' }
      }));
    }
  }, []);

  const currentPreset = FONTSIZE_PRESETS[fontSize];

  return {
    fontSize,
    setFontSize,
    currentPreset
  };
};

// üé£ CUSTOM HOOK: useFeatureFlags (v1.7)
const useFeatureFlags = () => {
  const STORAGE_KEY = 'sentencify-feature-flags';

  // Default flags (conservative: new features disabled by default)
  const DEFAULT_FLAGS = {
    useIndexedDB: true,          syncEnabled: true,          };

  // Estado de Feature Flags
  const [flags, setFlags] = React.useState(() => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        const parsed = JSON.parse(stored);
        // Merge with defaults para garantir que novas flags existam
        return { ...DEFAULT_FLAGS, ...parsed };
      }
    } catch (err) {
    }
    return DEFAULT_FLAGS;
  });

  // Persistir Flags no LocalStorage
  React.useEffect(() => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(flags));
    } catch (err) {
    }
  }, [flags]);

const setFlag = React.useCallback((flagName, value) => {
    setFlags(prev => ({ ...prev, [flagName]: value }));
  }, []);

  const isEnabled = React.useCallback((flagName) => flags[flagName] === true, [flags]);

  const resetFlags = React.useCallback(() => setFlags(DEFAULT_FLAGS), []);

  const getAllFlags = React.useCallback(() => ({ ...flags }), [flags]);

  return {
    flags,
    setFlag,
    isEnabled,
    resetFlags,
    getAllFlags
  };
};

// üé£ CUSTOM HOOK: useIndexedDB (v1.7)
// üöÄ v1.8.1: Hook useThrottledBroadcast

const useThrottledBroadcast = (channelRef, throttleMs = 1000) => {
  const lastBroadcastRef = React.useRef(0);
  const pendingMessageRef = React.useRef(null);
  const trailingTimerRef = React.useRef(null);

  const broadcast = React.useCallback((message) => {
    const channel = channelRef?.current;
    if (!channel) return;

    const now = Date.now();
    const timeSinceLastBroadcast = now - lastBroadcastRef.current;

    if (timeSinceLastBroadcast >= throttleMs) {
      channel.postMessage(message);
      lastBroadcastRef.current = now;
      pendingMessageRef.current = null;
      if (trailingTimerRef.current) {
        clearTimeout(trailingTimerRef.current);
        trailingTimerRef.current = null;
      }
    } else {
      pendingMessageRef.current = message;
      if (trailingTimerRef.current) {
        clearTimeout(trailingTimerRef.current);
      }
      const remainingTime = throttleMs - timeSinceLastBroadcast;
      trailingTimerRef.current = setTimeout(() => {
        const ch = channelRef?.current;
        if (pendingMessageRef.current && ch) {
          ch.postMessage(pendingMessageRef.current);
          lastBroadcastRef.current = Date.now();
          pendingMessageRef.current = null;
        }
        trailingTimerRef.current = null;
      }, remainingTime);
    }
  }, [channelRef, throttleMs]);

  // Cleanup on unmount
  React.useEffect(() => {
    return () => {
      if (trailingTimerRef.current) {
        clearTimeout(trailingTimerRef.current);
      }
    };
  }, []);

  return broadcast;
};

// üöÄ v1.8.2: Hook useAPICache - Cache LRU com TTL para API Claude
const useAPICache = (maxSize = 50, ttlMs = 5 * 60 * 1000) => {
  const cacheRef = React.useRef(new Map());
  const statsRef = React.useRef({ hits: 0, misses: 0, evictions: 0 });

  const hashKey = React.useCallback((input) => {
    let hash = 0;
    for (let i = 0; i < input.length; i++) {
      const char = input.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return `cache_${hash.toString(36)}`;
  }, []);

  const isExpired = React.useCallback((entry) => (Date.now() - entry.timestamp) > ttlMs, [ttlMs]);

  const evictLRU = React.useCallback(() => {
    const cache = cacheRef.current;
    if (cache.size < maxSize) return;
    let lruKey = null, lruScore = Infinity;
    for (const [key, entry] of cache.entries()) {
      const score = entry.hits - ((Date.now() - entry.timestamp) / 1000);
      if (score < lruScore) { lruScore = score; lruKey = key; }
    }
    if (lruKey) { cache.delete(lruKey); statsRef.current.evictions++; }
  }, [maxSize]);

  const get = React.useCallback((key) => {
    const cache = cacheRef.current;
    const hashedKey = hashKey(key);
    if (!cache.has(hashedKey)) { statsRef.current.misses++; return null; }
    const entry = cache.get(hashedKey);
    if (isExpired(entry)) { cache.delete(hashedKey); statsRef.current.misses++; return null; }
    entry.hits++; statsRef.current.hits++;
    return entry.result;
  }, [hashKey, isExpired]);

  const set = React.useCallback((key, result) => {
    evictLRU();
    cacheRef.current.set(hashKey(key), { result, timestamp: Date.now(), hits: 0 });
  }, [hashKey, evictLRU, maxSize]);

  const clear = React.useCallback(() => {
    cacheRef.current.clear();
    statsRef.current = { hits: 0, misses: 0, evictions: 0 };
  }, []);

  const invalidate = React.useCallback((pattern) => {
    for (const [key] of cacheRef.current.entries()) {
      if (key.includes(pattern)) cacheRef.current.delete(key);
    }
  }, []);

  const stats = React.useCallback(() => {
    const { hits, misses, evictions } = statsRef.current;
    const hitRate = hits + misses > 0 ? (hits / (hits + misses) * 100).toFixed(1) : 0;
    return { size: cacheRef.current.size, maxSize, hits, misses, evictions, hitRate: `${hitRate}%`, ttlMinutes: (ttlMs / 60000).toFixed(1) };
  }, [maxSize, ttlMs]);

  // v1.20.2: Cleanup ao desmontar para evitar memory leak
  React.useEffect(() => {
    return () => {
      cacheRef.current.clear();
      statsRef.current = { hits: 0, misses: 0, evictions: 0 };
    };
  }, []);

  return { get, set, clear, invalidate, stats };
};

// Hook useIndexedDB - Persist√™ncia de modelos com retry e fallback
const useIndexedDB = () => {
  const DB_NAME = 'SentencifyAI';
  const DB_VERSION = 1;
  const STORE_NAME = 'models';
  const MAX_RETRIES = 3;
  const RETRY_DELAY_MS = 1000; // Exponential backoff base
  const BROADCAST_CHANNEL_NAME = 'sentencify-models-sync';

  // Estados
  const [isLoading, setIsLoading] = React.useState(false);
  const [error, setError] = React.useState(null);
  const [dbInstance, setDbInstance] = React.useState(null);
  const [isAvailable, setIsAvailable] = React.useState(false); // false at√© DB estar pronto
  const [lastSyncTime, setLastSyncTime] = React.useState(null);

  // Ref para cache de modelos
  const modelsCacheRef = React.useRef(null);

  // Multi-tab Sync (v1.7 FASE 1.4)
  const broadcastChannelRef = React.useRef(null);
  const tabIdRef = React.useRef(`tab-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`);
  const lastBroadcastTimestampRef = React.useRef(null);
  const syncCallbackRef = React.useRef(null); // Callback para notificar componente pai

  // üöÄ v1.8.1: Throttled broadcast via hook
  const notifyOtherTabs = useThrottledBroadcast(broadcastChannelRef, 1000);

  // Helper: Exponential Backoff Retry
  const retryWithBackoff = React.useCallback(async (fn, retries = MAX_RETRIES) => {
    for (let i = 0; i < retries; i++) {
      try {
        return await fn();
      } catch (err) {
        if (i === retries - 1) throw err;
        const delay = RETRY_DELAY_MS * Math.pow(2, i);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }, []);

  // Open Database
  const openDB = React.useCallback(() => {
    return new Promise((resolve, reject) => {
      try {
        if (!window.indexedDB) {
          reject(new Error('IndexedDB n√£o dispon√≠vel neste navegador'));
          return;
        }

        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => {
          reject(request.error);
        };

        request.onsuccess = () => {
          resolve(request.result);
        };

        request.onupgradeneeded = (event) => {
          const db = event.target.result;

          // Create models store
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            store.createIndex('byCategory', 'category', { unique: false });
            store.createIndex('byCreatedAt', 'createdAt', { unique: false });
          }
        };
      } catch (err) {
        reject(err);
      }
    });
  }, []);

  // Initialize Database + BroadcastChannel (v1.7 FASE 1.4)
  React.useEffect(() => {
    let isMounted = true;

    const init = async () => {
      try {
        const db = await retryWithBackoff(openDB);
        if (isMounted) {
          setDbInstance(db);
          setIsAvailable(true);
          setError(null);
        }
      } catch (err) {
        if (isMounted) {
          setIsAvailable(false);
          setError(err.message);
        }
      }
    };

    // üîÑ MULTI-TAB SYNC: Inicializar BroadcastChannel
    const initBroadcastChannel = () => {
      // Verificar se BroadcastChannel √© suportado
      if (typeof BroadcastChannel === 'undefined') {
        return;
      }

      try {
        const channel = new BroadcastChannel(BROADCAST_CHANNEL_NAME);
        broadcastChannelRef.current = channel;

        // Listener: Receber mensagens de outras tabs
        channel.onmessage = (event) => {
          const { type, tabId, timestamp, action } = event.data;

          // üö® CR√çTICO: Ignorar mensagens da pr√≥pria tab (evita loop infinito)
          if (tabId === tabIdRef.current) {
            return;
          }

          // üö® CR√çTICO: Ignorar mensagens duplicadas (deduplica√ß√£o)
          if (lastBroadcastTimestampRef.current === timestamp) {
            return;
          }

          // Processar mensagem baseado no tipo
          if (type === 'models-updated') {
            // Invalidar cache local para for√ßar reload do IndexedDB
            modelsCacheRef.current = null;

            // Notificar componente pai para atualizar state React
            // (isso ser√° implementado via callback)
            if (syncCallbackRef.current) {
              syncCallbackRef.current({ action, timestamp });
            }

            // Atualizar timestamp para deduplica√ß√£o
            lastBroadcastTimestampRef.current = timestamp;

          }
        };

        channel.onerror = (err) => {
        };

      } catch (err) {
      }
    };

    init();
    initBroadcastChannel();

    return () => {
      isMounted = false;

      // Cleanup: Fechar database
      if (dbInstance) {
        dbInstance.close();
      }

      // Cleanup: Fechar BroadcastChannel
      if (broadcastChannelRef.current) {
        broadcastChannelRef.current.close();
      }
    };
  }, [openDB, retryWithBackoff]);

  // Load Models
  const loadModels = React.useCallback(async () => {
    if (!isAvailable || !dbInstance) {
      throw new Error('IndexedDB n√£o dispon√≠vel');
    }

    // Return cache if available
    if (modelsCacheRef.current) {
      return modelsCacheRef.current;
    }

    setIsLoading(true);
    setError(null);

    try {
      const models = await retryWithBackoff(async () => {
        return new Promise((resolve, reject) => {
          const transaction = dbInstance.transaction([STORE_NAME], 'readonly');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.getAll();

          request.onsuccess = () => {
            resolve(request.result);
          };

          request.onerror = () => reject(request.error);
        });
      });

      // Update cache
      modelsCacheRef.current = models;
      setLastSyncTime(new Date().toISOString());
      setIsLoading(false);
      return models;
    } catch (err) {
      setError(err.message);
      setIsLoading(false);
      throw err;
    }
  }, [isAvailable, dbInstance, retryWithBackoff]);

  // Save Models (Diff-based) + Multi-tab Sync
  const saveModels = React.useCallback(async (newModels) => {
    if (!isAvailable || !dbInstance) {
      throw new Error('IndexedDB n√£o dispon√≠vel');
    }

    setIsLoading(true);
    setError(null);

    try {
      // v1.34.8: Validar ANTES da transa√ß√£o para poder atualizar cache corretamente
      const validatedModels = [];
      const rejectedModels = [];
      for (const model of newModels) {
        const validation = validateModel(model);
        if (!validation.valid) {
          rejectedModels.push({ id: model.id, title: model.title, errors: validation.errors });
          continue;
        }
        const sanitized = sanitizeModel(model);
        validatedModels.push(sanitized);
      }

      // Log modelos rejeitados para debug
      if (rejectedModels.length > 0) {
        console.warn(`[IndexedDB] ${rejectedModels.length} modelos rejeitados pela valida√ß√£o:`, rejectedModels);
      }

      await retryWithBackoff(async () => {
        return new Promise((resolve, reject) => {
          const transaction = dbInstance.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);

          // IMPORTANTE: Clear store primeiro para garantir sincroniza√ß√£o total
          // Sem isso, modelos deletados permaneceriam no IndexedDB
          store.clear();

          // Save all validated models (ap√≥s clear, para substituir completamente)
          validatedModels.forEach(model => {
            store.put(model); // put() adiciona modelo ao store vazio
          });

          transaction.oncomplete = () => {
            resolve();
          };

          transaction.onerror = () => reject(transaction.error);
        });
      });

      // v1.34.8: Update cache com modelos VALIDADOS (n√£o os originais!)
      modelsCacheRef.current = validatedModels;
      setLastSyncTime(new Date().toISOString());
      setIsLoading(false);

      // üîÑ MULTI-TAB SYNC: Broadcast para outras tabs (v1.7 FASE 1.4 + v1.8.1 throttle)
      if (broadcastChannelRef.current) {
        try {
          const timestamp = Date.now();
          const message = {
            type: 'models-updated',
            action: 'save',
            tabId: tabIdRef.current,
            timestamp,
            modelsCount: validatedModels.length  // v1.34.8: Usar count correto
          };

          notifyOtherTabs(message); // üöÄ v1.8.1: Throttled (max 1/segundo)
        } catch (broadcastErr) {
          // N√£o falhar o save se broadcast falhar (graceful degradation)
        }
      }
    } catch (err) {
      setError(err.message);
      setIsLoading(false);
      throw err;
    }
  }, [isAvailable, dbInstance, retryWithBackoff, notifyOtherTabs]);

  // Delete Model + Multi-tab Sync
  const deleteModel = React.useCallback(async (modelId) => {
    if (!isAvailable || !dbInstance) {
      throw new Error('IndexedDB n√£o dispon√≠vel');
    }

    setIsLoading(true);
    setError(null);

    try {
      await retryWithBackoff(async () => {
        return new Promise((resolve, reject) => {
          const transaction = dbInstance.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.delete(modelId);

          request.onsuccess = () => {
            resolve();
          };

          request.onerror = () => reject(request.error);
        });
      });

      // Invalidate cache
      modelsCacheRef.current = null;
      setIsLoading(false);

      // üîÑ MULTI-TAB SYNC: Broadcast para outras tabs (v1.7 FASE 1.4 + v1.8.1 throttle)
      if (broadcastChannelRef.current) {
        try {
          const timestamp = Date.now();
          const message = {
            type: 'models-updated',
            action: 'delete',
            tabId: tabIdRef.current,
            timestamp,
            modelId
          };

          notifyOtherTabs(message); // üöÄ v1.8.1: Throttled (max 1/segundo)
        } catch (broadcastErr) {
          // N√£o falhar se broadcast falhar (graceful degradation)
        }
      }
    } catch (err) {
      setError(err.message);
      setIsLoading(false);
      throw err;
    }
  }, [isAvailable, dbInstance, retryWithBackoff, notifyOtherTabs]);

  // Clear All + Multi-tab Sync
  const clearAll = React.useCallback(async () => {
    if (!isAvailable || !dbInstance) {
      throw new Error('IndexedDB n√£o dispon√≠vel');
    }

    setIsLoading(true);
    setError(null);

    try {
      await retryWithBackoff(async () => {
        return new Promise((resolve, reject) => {
          const transaction = dbInstance.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.clear();

          request.onsuccess = () => {
            resolve();
          };

          request.onerror = () => reject(request.error);
        });
      });

      // Clear cache
      modelsCacheRef.current = null;
      setIsLoading(false);

      // üîÑ MULTI-TAB SYNC: Broadcast para outras tabs (v1.7 FASE 1.4 + v1.8.1 throttle)
      if (broadcastChannelRef.current) {
        try {
          const timestamp = Date.now();
          const message = {
            type: 'models-updated',
            action: 'clear',
            tabId: tabIdRef.current,
            timestamp
          };

          notifyOtherTabs(message); // üöÄ v1.8.1: Throttled (max 1/segundo)
        } catch (broadcastErr) {
          // N√£o falhar se broadcast falhar (graceful degradation)
        }
      }
    } catch (err) {
      setError(err.message);
      setIsLoading(false);
      throw err;
    }
  }, [isAvailable, dbInstance, retryWithBackoff, notifyOtherTabs]);

  // Invalidate Cache (for external updates)
  const invalidateCache = React.useCallback(() => {
    modelsCacheRef.current = null;
  }, []);

  // Set Sync Callback (v1.7 FASE 1.4)
  const setSyncCallback = React.useCallback((callback) => {
    syncCallbackRef.current = callback;
  }, []);

  return {
    // Estado
    isLoading,
    error,
    isAvailable,
    lastSyncTime,

    // Opera√ß√µes
    loadModels,
    saveModels,
    deleteModel,
    clearAll,
    invalidateCache,

    // Multi-tab Sync (v1.7 FASE 1.4)
    setSyncCallback,
    isSupported: typeof BroadcastChannel !== 'undefined' // Indica se multi-tab sync √© suportado
  };
};

// üé£ CUSTOM HOOK: usePrimaryTabLock (v1.9.5) - Controle de aba prim√°ria
const usePrimaryTabLock = () => {
  const LOCK_KEY = 'sentencify-primary-tab-lock';
  const TAKEOVER_KEY = 'sentencify-tab-takeover';

  const [isPrimaryTab, setIsPrimaryTab] = React.useState(false);

  const getSavedTabId = () => {
    try {
      const saved = sessionStorage.getItem(TAKEOVER_KEY);
      if (saved) {
        sessionStorage.removeItem(TAKEOVER_KEY); // Limpar imediatamente
        return saved;
      }
    } catch (err) {
    }
    return null;
  };

  const tabIdRef = React.useRef(
    getSavedTabId() || `tab-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
  );

  // Claim como aba prim√°ria
  // v1.20.1: Adicionada verifica√ß√£o de expira√ß√£o (30s) para locks √≥rf√£os
  const LOCK_EXPIRY_MS = 30000; // 30 segundos

  const claimPrimaryTab = React.useCallback(() => {
    try {
      const lockStr = localStorage.getItem(LOCK_KEY);
      const lock = lockStr ? JSON.parse(lockStr) : {};

      // CASO 1: Nenhum lock existe ‚Üí criar lock e se tornar prim√°ria
      if (!lock.tabId) {
        createLock();
        return;
      }

      // CASO 2: Lock √© nosso ‚Üí atualizar timestamp
      if (lock.tabId === tabIdRef.current) {
        createLock();
        return;
      }

      // CASO 3: Lock expirado (mais de 30s sem heartbeat) ‚Üí assumir for√ßadamente
      if (lock.timestamp && (Date.now() - lock.timestamp > LOCK_EXPIRY_MS)) {
        createLock(true);
        return;
      }

      // CASO 4: Lock existe e pertence a outra aba ativa ‚Üí permanecer secund√°ria
      setIsPrimaryTab(false);

    } catch (err) {
      // Fallback: assumir como prim√°ria em caso de erro
      createLock();
    }
  }, []);

  // Criar lock (tornar esta aba prim√°ria)
  // v1.20.1: Adicionado par√¢metro force para takeover e locks expirados
  const createLock = (force = false) => {
    try {
      const existingLockStr = localStorage.getItem(LOCK_KEY);
      if (existingLockStr && !force) {
        const existingLock = JSON.parse(existingLockStr);
        // S√≥ permite criar lock se √© nosso pr√≥prio lock (evita race condition)
        if (existingLock.tabId !== tabIdRef.current) {
          setIsPrimaryTab(false);
          return;
        }
      }

      localStorage.setItem(LOCK_KEY, JSON.stringify({
        tabId: tabIdRef.current,
        timestamp: Date.now()
      }));
      setIsPrimaryTab(true);
    } catch (err) {
    }
  };

  // Liberar lock (ao fechar aba)
  const releaseLock = React.useCallback(() => {
    try {
      const lockStr = localStorage.getItem(LOCK_KEY);
      const lock = lockStr ? JSON.parse(lockStr) : {};

      // S√≥ libera se esta aba √© a dona do lock
      if (lock.tabId === tabIdRef.current) {
        localStorage.removeItem(LOCK_KEY);
      }
    } catch (err) {
    }
  }, []);

  // Cleanup: Liberar lock ao fechar aba
  React.useEffect(() => {
    window.addEventListener('beforeunload', releaseLock);
    return () => {
      releaseLock();
      window.removeEventListener('beforeunload', releaseLock);
    };
  }, [releaseLock]);

  // Mount: Tentar claim imediatamente
  React.useEffect(() => {
    claimPrimaryTab();
  }, [claimPrimaryTab]);

  // Detect Lock Changes from Other Tabs
  React.useEffect(() => {
    const handleStorageChange = (e) => {
      // Only respond to changes in our lock key
      if (e.key !== LOCK_KEY) return;

      // CASE 1: Lock was removed (primary tab closed)
      if (!e.newValue) {
        // Try to claim it (first tab to claim wins)
        claimPrimaryTab();
        return;
      }

      // CASE 2: Lock was changed to another tab
      try {
        const newLock = JSON.parse(e.newValue);

        if (newLock.tabId !== tabIdRef.current) {
          setIsPrimaryTab(false);
        } else {
          // Lock is ours (defensive check)
          setIsPrimaryTab(true);
        }
      } catch (err) {
        // Stay in current state on error (conservative)
      }
    };

    // Register storage event listener
    window.addEventListener('storage', handleStorageChange);

    // Cleanup
    return () => {
      window.removeEventListener('storage', handleStorageChange);
    };
  }, [claimPrimaryTab]); // Depend on claimPrimaryTab

  // v1.20.1: Heartbeat para manter lock vivo (atualiza timestamp a cada 10s)
  React.useEffect(() => {
    if (!isPrimaryTab) return;

    const heartbeat = setInterval(() => {
      try {
        const lockStr = localStorage.getItem(LOCK_KEY);
        const lock = lockStr ? JSON.parse(lockStr) : {};
        if (lock.tabId === tabIdRef.current) {
          localStorage.setItem(LOCK_KEY, JSON.stringify({
            tabId: tabIdRef.current,
            timestamp: Date.now()
          }));
        }
      } catch (err) {
      }
    }, 10000); // 10 segundos

    return () => clearInterval(heartbeat);
  }, [isPrimaryTab]);

  return {
    isPrimaryTab,
    tabId: tabIdRef.current
  };
};

// üì¶ SERVI√áO IndexedDB para PDFs (v1.12.14)
const PDF_DB_NAME = 'sentencify-pdfs';
const PDF_STORE_NAME = 'pdfs';
const PDF_DB_VERSION = 1;

const openPdfDB = () => {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(PDF_DB_NAME, PDF_DB_VERSION);

    request.onerror = () => {
      reject(request.error);
    };

    request.onsuccess = () => {
      resolve(request.result);
    };

    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(PDF_STORE_NAME)) {
        // Store com chave 'id' (formato: 'upload-{index}' ou 'proof-{id}')
        db.createObjectStore(PDF_STORE_NAME, { keyPath: 'id' });
      }
    };
  });
};

// Salva um PDF no IndexedDB
const savePdfToIndexedDB = async (id, file, type) => {
  try {
    // Converter File para ArrayBuffer ANTES de abrir transa√ß√£o
    // (evita TransactionInactiveError quando chamado em paralelo)
    const arrayBuffer = await file.arrayBuffer();

    const db = await openPdfDB();
    const transaction = db.transaction([PDF_STORE_NAME], 'readwrite');
    const store = transaction.objectStore(PDF_STORE_NAME);

    const pdfRecord = {
      id,
      type,
      fileName: file.name,
      fileSize: file.size,
      mimeType: file.type,
      data: arrayBuffer,
      savedAt: Date.now()
    };

    await new Promise((resolve, reject) => {
      const request = store.put(pdfRecord);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });

    db.close();
  } catch (error) {
    throw error;
  }
};

// Recupera um PDF do IndexedDB
const getPdfFromIndexedDB = async (id) => {
  try {
    const db = await openPdfDB();
    const transaction = db.transaction([PDF_STORE_NAME], 'readonly');
    const store = transaction.objectStore(PDF_STORE_NAME);

    const record = await new Promise((resolve, reject) => {
      const request = store.get(id);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });

    db.close();

    if (!record) {
      return null;
    }

    // Reconstruir File a partir do ArrayBuffer
    const blob = new Blob([record.data], { type: record.mimeType });
    const file = new File([blob], record.fileName, {
      type: record.mimeType,
      lastModified: record.savedAt
    });

    return file;
  } catch (error) {
    return null;
  }
};

// Remove um PDF espec√≠fico do IndexedDB
const removePdfFromIndexedDB = async (id) => {
  try {
    const db = await openPdfDB();
    const transaction = db.transaction([PDF_STORE_NAME], 'readwrite');
    const store = transaction.objectStore(PDF_STORE_NAME);

    await new Promise((resolve, reject) => {
      const request = store.delete(id);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });

    db.close();
  } catch (error) {
    throw error;
  }
};

// Remove todos os PDFs do IndexedDB
const clearAllPdfsFromIndexedDB = async () => {
  try {
    const db = await openPdfDB();
    const transaction = db.transaction([PDF_STORE_NAME], 'readwrite');
    const store = transaction.objectStore(PDF_STORE_NAME);

    await new Promise((resolve, reject) => {
      const request = store.clear();
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });

    db.close();
  } catch (error) {
    throw error;
  }
};

// üì¶ SERVI√áO IndexedDB para Jurisprud√™ncia
const JURIS_DB_NAME = 'sentencify-jurisprudencia';
const JURIS_STORE_NAME = 'precedentes';

const openJurisDB = () => new Promise((resolve, reject) => {
  const request = indexedDB.open(JURIS_DB_NAME, 2);
  request.onerror = () => reject(request.error);
  request.onsuccess = () => resolve(request.result);
  request.onupgradeneeded = (e) => {
    const db = e.target.result;
    if (!db.objectStoreNames.contains(JURIS_STORE_NAME)) {
      const store = db.createObjectStore(JURIS_STORE_NAME, { keyPath: 'id' });
      store.createIndex('byCategory', 'category', { unique: false });
      store.createIndex('byTipo', 'tipoProcesso', { unique: false });
      store.createIndex('byTribunal', 'tribunal', { unique: false });
    } else if (e.oldVersion < 2) {
      const store = e.target.transaction.objectStore(JURIS_STORE_NAME);
      if (!store.indexNames.contains('byTribunal')) {
        store.createIndex('byTribunal', 'tribunal', { unique: false });
      }
    }
  };
});

const savePrecedentesToIndexedDB = async (precedentes) => {
  const db = await openJurisDB();
  const tx = db.transaction([JURIS_STORE_NAME], 'readwrite');
  const store = tx.objectStore(JURIS_STORE_NAME);
  for (const p of precedentes) store.put(p);
  db.close();
};

const loadPrecedentesFromIndexedDB = async () => {
  try {
    const db = await openJurisDB();
    const tx = db.transaction([JURIS_STORE_NAME], 'readonly');
    const store = tx.objectStore(JURIS_STORE_NAME);
    const result = await new Promise((resolve, reject) => {
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
    db.close();
    return result;
  } catch { return []; }
};

const clearPrecedentesFromIndexedDB = async () => {
  try {
    const db = await openJurisDB();
    const tx = db.transaction([JURIS_STORE_NAME], 'readwrite');
    const store = tx.objectStore(JURIS_STORE_NAME);
    await new Promise((resolve, reject) => {
      const req = store.clear();
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
    db.close();
  } catch { /* silenciado */ }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìú LEGISLA√á√ÉO - IndexedDB Storage
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const LEGIS_DB_NAME = 'sentencify-legislacao';
const LEGIS_STORE_NAME = 'artigos';

const LEIS_METADATA = {
  'clt': { nome: 'CLT', nomeCompleto: 'Consolida√ß√£o das Leis do Trabalho', numero: 'Decreto-Lei 5.452/1943' },
  'cf': { nome: 'CF/88', nomeCompleto: 'Constitui√ß√£o Federal', numero: 'CF 1988' },
  'cpc': { nome: 'CPC', nomeCompleto: 'C√≥digo de Processo Civil', numero: 'Lei 13.105/2015' },
  'cc': { nome: 'CC', nomeCompleto: 'C√≥digo Civil', numero: 'Lei 10.406/2002' },
  'cdc': { nome: 'CDC', nomeCompleto: 'C√≥digo de Defesa do Consumidor', numero: 'Lei 8.078/1990' },
  'l605': { nome: 'Lei 605', nomeCompleto: 'Repouso Semanal Remunerado', numero: 'Lei 605/1949' },
  'l6019': { nome: 'Lei 6.019', nomeCompleto: 'Trabalho Tempor√°rio', numero: 'Lei 6.019/1974' },
  'l9029': { nome: 'Lei 9.029', nomeCompleto: 'Pr√°ticas Discriminat√≥rias', numero: 'Lei 9.029/1995' }
};

const getLeiFromId = (id) => {
  const prefix = id?.split('-art-')[0] || id?.split('-')[0];
  return LEIS_METADATA[prefix] || { nome: prefix?.toUpperCase() || '?', nomeCompleto: prefix, numero: '' };
};

const openLegisDB = () => new Promise((resolve, reject) => {
  const request = indexedDB.open(LEGIS_DB_NAME, 1);
  request.onerror = () => reject(request.error);
  request.onsuccess = () => resolve(request.result);
  request.onupgradeneeded = (event) => {
    const db = event.target.result;
    if (!db.objectStoreNames.contains(LEGIS_STORE_NAME)) {
      const store = db.createObjectStore(LEGIS_STORE_NAME, { keyPath: 'id' });
      store.createIndex('byLei', 'lei', { unique: false });
      store.createIndex('byNumero', 'numero', { unique: false });
    }
  };
});

const saveArtigosToIndexedDB = async (artigos) => {
  try {
    const db = await openLegisDB();
    const tx = db.transaction([LEGIS_STORE_NAME], 'readwrite');
    const store = tx.objectStore(LEGIS_STORE_NAME);
    for (const artigo of artigos) {
      const lei = artigo.id?.split('-art-')[0] || artigo.id?.split('-')[0];
      store.put({ ...artigo, lei });
    }
    await new Promise((resolve, reject) => {
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
    db.close();
  } catch (err) { console.error('Erro ao salvar artigos:', err); }
};

const loadArtigosFromIndexedDB = async () => {
  try {
    const db = await openLegisDB();
    const tx = db.transaction([LEGIS_STORE_NAME], 'readonly');
    const store = tx.objectStore(LEGIS_STORE_NAME);
    const result = await new Promise((resolve, reject) => {
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
    db.close();
    return result;
  } catch { return []; }
};

const clearArtigosFromIndexedDB = async () => {
  try {
    const db = await openLegisDB();
    const tx = db.transaction([LEGIS_STORE_NAME], 'readwrite');
    const store = tx.objectStore(LEGIS_STORE_NAME);
    await new Promise((resolve, reject) => {
      const req = store.clear();
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
    db.close();
  } catch { /* silenciado */ }
};

// === VERSIONAMENTO DE CAMPOS ===
const VERSION_DB = 'sentencify-versions';
const VERSION_STORE = 'versions';

const openVersionDB = () => new Promise((resolve, reject) => {
  const req = indexedDB.open(VERSION_DB, 1);
  req.onerror = () => reject(req.error);
  req.onsuccess = () => resolve(req.result);
  req.onupgradeneeded = (e) => {
    const db = e.target.result;
    if (!db.objectStoreNames.contains(VERSION_STORE)) {
      db.createObjectStore(VERSION_STORE, { keyPath: 'id', autoIncrement: true })
        .createIndex('topicTitle', 'topicTitle');
    }
  };
});

const useFieldVersioning = () => {
  const stripHtml = (html) => (html || '').replace(/<[^>]*>/g, '').substring(0, 100);

  const saveVersion = React.useCallback(async (topicTitle, content) => {
    if (!topicTitle || !content) return;
    try {
      const db = await openVersionDB();
      const tx = db.transaction(VERSION_STORE, 'readwrite');
      const store = tx.objectStore(VERSION_STORE);
      const index = store.index('topicTitle');
      const existing = await new Promise(r => {
        const req = index.getAll(topicTitle);
        req.onsuccess = () => r(req.result || []);
      });
      if (existing.length > 0 && existing[existing.length - 1].content === content) {
        db.close(); return;
      }
      store.add({ topicTitle, content, timestamp: Date.now(), preview: stripHtml(content) });
      if (existing.length >= 10) {
        existing.slice(0, existing.length - 9).forEach(v => store.delete(v.id));
      }
      db.close();
    } catch (e) { console.warn('Erro ao salvar vers√£o:', e); }
  }, []);

  const getVersions = React.useCallback(async (topicTitle) => {
    if (!topicTitle) return [];
    try {
      const db = await openVersionDB();
      const store = db.transaction(VERSION_STORE).objectStore(VERSION_STORE);
      const versions = await new Promise(r => {
        const req = store.index('topicTitle').getAll(topicTitle);
        req.onsuccess = () => r(req.result || []);
      });
      db.close();
      return versions.sort((a, b) => b.timestamp - a.timestamp);
    } catch { return []; }
  }, []);

  const restoreVersion = React.useCallback(async (id, currentContent, topicTitle) => {
    await saveVersion(topicTitle, currentContent);
    try {
      const db = await openVersionDB();
      const version = await new Promise(r => {
        const req = db.transaction(VERSION_STORE).objectStore(VERSION_STORE).get(id);
        req.onsuccess = () => r(req.result);
      });
      db.close();
      return version?.content;
    } catch { return null; }
  }, [saveVersion]);

  // v1.33.22: useMemo para evitar novo objeto a cada render (causa infinite loop em VersionSelect)
  return React.useMemo(
    () => ({ saveVersion, getVersions, restoreVersion }),
    [saveVersion, getVersions, restoreVersion]
  );
};

const sortArtigosNatural = (artigos) => {
  return [...artigos].sort((a, b) => {
    const parseId = (id) => {
      const match = id.match(/^(.+)-art-(\d+)(?:-([a-z]))?$/i);
      if (!match) return { lei: id, num: 0, suffix: '' };
      return { lei: match[1], num: parseInt(match[2]), suffix: match[3] || '' };
    };
    const pa = parseId(a.id);
    const pb = parseId(b.id);
    if (pa.lei !== pb.lei) return pa.lei.localeCompare(pb.lei);
    if (pa.num !== pb.num) return pa.num - pb.num;
    return pa.suffix.localeCompare(pb.suffix);
  });
};

// üé£ CUSTOM HOOK: useLocalStorage (persist√™ncia e localStorage)
const useLocalStorage = () => {
  // Estados de Persist√™ncia
  const [sessionLastSaved, setSessionLastSaved] = React.useState(null);
  const [showAutoSaveIndicator, setShowAutoSaveIndicator] = React.useState(false);

  // üöÄ OTIMIZA√á√ÉO v1.4.1: Cache de convers√µes PDF‚Üíbase64
  // Evita re-converter mesmos PDFs (key: fileName-size-lastModified)
  // v1.20.2: Adicionado limite LRU para evitar memory leak
  const PDF_CACHE_MAX_SIZE = 5; // M√°ximo 5 PDFs em cache (~50MB worst case)
  const pdfCacheRef = React.useRef(new Map());
  const pdfCacheOrderRef = React.useRef([]); // Track insertion order para LRU

  // Adiciona ao cache com eviction LRU
  const addToPdfCache = (key, value) => {
    if (pdfCacheRef.current.has(key)) {
      pdfCacheRef.current.set(key, value);
      return;
    }
    while (pdfCacheRef.current.size >= PDF_CACHE_MAX_SIZE) {
      const oldestKey = pdfCacheOrderRef.current.shift();
      if (oldestKey) pdfCacheRef.current.delete(oldestKey);
    }
    pdfCacheRef.current.set(key, value);
    pdfCacheOrderRef.current.push(key);
  };

  // Limpa cache completamente (usado no reset de sess√£o)
  const clearPdfCache = () => {
    pdfCacheRef.current.clear();
    pdfCacheOrderRef.current = [];
  };

  // Fun√ß√µes Auxiliares

  // Converte File para base64 (com cache LRU)
  const fileToBase64 = React.useCallback((file) => {
    // Criar chave √∫nica baseada em propriedades do arquivo
    const cacheKey = `${file.name}-${file.size}-${file.lastModified}`;

    // Verificar cache primeiro
    if (pdfCacheRef.current.has(cacheKey)) {
      return Promise.resolve(pdfCacheRef.current.get(cacheKey));
    }

    // Se n√£o est√° no cache, converter e cachear
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const result = reader.result;
        if (!result || typeof result !== 'string') {
          return reject(new Error('Falha ao ler arquivo: resultado vazio'));
        }
        const parts = result.split(',');
        const base64 = parts[1] || '';
        if (!base64) {
          return reject(new Error('Falha ao converter arquivo para base64'));
        }
        addToPdfCache(cacheKey, base64);
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }, []);

  // Converte base64 para File
  const base64ToFile = React.useCallback((base64, fileName, mimeType = 'application/pdf') => {
    const byteCharacters = atob(base64);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
      byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], { type: mimeType });
    const file = new File([blob], fileName, { type: mimeType });
    return file;
  }, []);

  // Verifica se existe sess√£o salva
  const checkSavedSession = React.useCallback((openModal) => {
    try {
      const saved = localStorage.getItem('sentencifySession');
      if (saved) {
        const session = JSON.parse(saved);
        setSessionLastSaved(session.savedAt);
        openModal('restoreSession');
      }
    } catch (err) {
    }
  }, []);

  const autoSaveSession = React.useCallback(async (allStates, setError, immediate = false) => {
    try {
      const {
        processoNumero,
        pastedPeticaoTexts,
        pastedContestacaoTexts,
        pastedComplementaryTexts,
        extractedTopics,
        selectedTopics,
        partesProcesso,
        activeTab,
        analyzedDocuments,
        proofFiles,
        proofTexts,
        proofUsePdfMode,
        extractedProofTexts,
        proofExtractionFailed,
        proofTopicLinks,
        proofAnalysisResults,
        proofConclusions,
        extractedTexts,
        documentProcessingModes,
        peticaoFiles,
        contestacaoFiles,
        complementaryFiles,
        tokenMetrics // v1.20.3: Contador de tokens persistente
      } = allStates;

      const proofFilesSerializable = proofFiles.map((proof) => ({
        id: proof.id,
        name: proof.name,
        type: proof.type,
        size: proof.size,
        uploadDate: proof.uploadDate
        // Sem fileData - PDFs est√£o no IndexedDB
      }));

      const session = {
        version: APP_VERSION,
        savedAt: new Date().toISOString(),
        processoNumero,
        pastedPeticaoTexts,
        pastedContestacaoTexts,
        pastedComplementaryTexts,
        extractedTopics,
        selectedTopics,
        partesProcesso,
        activeTab,
        // v1.20.1: N√ÉO persistir base64 de PDFs (economia de mem√≥ria ~200-500MB)
        // Base64 √© regenerado quando necess√°rio via fileToBase64()
        analyzedDocuments: {
          peticoes: [], // N√ÉO salvar base64 (pode ser 50MB+ por PDF)
          peticoesText: analyzedDocuments?.peticoesText || [],
          contestacoes: [], // N√ÉO salvar base64
          contestacoesText: analyzedDocuments?.contestacoesText || [],
          complementares: [], // N√ÉO salvar base64
          complementaresText: analyzedDocuments?.complementaresText || [],
        },
        extractedTexts: extractedTexts || { peticoes: [], contestacoes: [], complementares: [] },
        documentProcessingModes: documentProcessingModes || { peticoes: [], contestacoes: [], complementares: [] },
        // IDs dos arquivos para restaura√ß√£o do IndexedDB
        peticaoFileIds: (peticaoFiles || []).map(f => f.id).filter(Boolean),
        contestacaoFileIds: (contestacaoFiles || []).map(f => f.id).filter(Boolean),
        complementaryFileIds: (complementaryFiles || []).map(f => f.id).filter(Boolean),
        // Dados de provas (apenas metadados, PDFs no IndexedDB)
        proofFiles: proofFilesSerializable,
        proofTexts: proofTexts,
        proofUsePdfMode: proofUsePdfMode,
        extractedProofTexts: extractedProofTexts,
        proofExtractionFailed: proofExtractionFailed,
        proofTopicLinks: proofTopicLinks,
        proofAnalysisResults: proofAnalysisResults,
        proofConclusions: proofConclusions,
        proofSendFullContent: allStates.proofSendFullContent || {},
        // v1.20.3: Contador de tokens persistente
        tokenMetrics: tokenMetrics || { totalInput: 0, totalOutput: 0, totalCacheRead: 0, totalCacheCreation: 0, requestCount: 0, lastUpdated: null }
      };

      if (immediate) {
        try {
          const serialized = JSON.stringify(session);
          localStorage.setItem('sentencifySession', serialized);
          setSessionLastSaved(session.savedAt);
          setShowAutoSaveIndicator(true);
          setTimeout(() => setShowAutoSaveIndicator(false), 3000);
        } catch (storageErr) {
          if (storageErr.name === 'QuotaExceededError') {
            setError('‚ùå LocalStorage cheio. Considere limpar dados antigos.');
            setTimeout(() => setError(''), 8000);
          }
        }
      } else {
        // üöÄ OTIMIZA√á√ÉO v1.4.1: Save ass√≠ncrono n√£o-bloqueante usando requestIdleCallback
        const saveAsync = () => {
          const scheduleTask = window.requestIdleCallback || ((cb) => setTimeout(cb, 0));
          scheduleTask(() => {
            try {
              const serialized = JSON.stringify(session);
              localStorage.setItem('sentencifySession', serialized);
              setSessionLastSaved(session.savedAt);
              setShowAutoSaveIndicator(true);
              setTimeout(() => setShowAutoSaveIndicator(false), 3000);
            } catch (storageErr) {
              if (storageErr.name === 'QuotaExceededError') {
                setError('‚ùå LocalStorage cheio. Considere limpar dados antigos.');
                setTimeout(() => setError(''), 8000);
              }
            }
          });
        };
        saveAsync();
      }
    } catch (err) {
    }
  }, [setShowAutoSaveIndicator, setSessionLastSaved]);

  // Restaura sess√£o (PDFs do IndexedDB, metadados do localStorage)
  const restoreSession = React.useCallback(async (callbacks) => {
    try {
      const saved = localStorage.getItem('sentencifySession');
      if (!saved) return;

      const session = JSON.parse(saved);

      const {
        setPastedPeticaoTexts,
        setPastedContestacaoTexts,
        setPastedComplementaryTexts,
        setExtractedTopics,
        setSelectedTopics,
        setPartesProcesso,
        setAnalyzedDocuments,
        setProofFiles,
        setProofTexts,
        setProofUsePdfMode,
        setExtractedProofTexts,
        setProofExtractionFailed,
        setProofTopicLinks,
        setProofAnalysisResults,
        setProofConclusions,
        setProofSendFullContent,
        setActiveTab,
        closeModal,
        setError,
        setProcessoNumero,
        setPeticaoFiles,
        setContestacaoFiles,
        setComplementaryFiles,
        setExtractedTexts,
        setDocumentProcessingModes,
        setTokenMetrics // v1.20.3: Contador de tokens persistente
      } = callbacks;

      // üÜï v1.21: Migra√ß√£o de sess√µes antigas (peticao singular ‚Üí peticoes array)
      if (session.pastedPeticaoText && !session.pastedPeticaoTexts) {
        session.pastedPeticaoTexts = [{ text: session.pastedPeticaoText, name: 'Peti√ß√£o Inicial' }];
      }
      if (session.analyzedDocuments?.peticao && !session.analyzedDocuments?.peticoes) {
        session.analyzedDocuments.peticoes = session.analyzedDocuments.peticaoType === 'pdf'
          ? [session.analyzedDocuments.peticao] : [];
        session.analyzedDocuments.peticoesText = session.analyzedDocuments.peticaoType === 'text'
          ? [{ text: session.analyzedDocuments.peticao, name: 'Peti√ß√£o Inicial' }] : [];
      }

      setProcessoNumero(session.processoNumero || '');
      setPastedPeticaoTexts(session.pastedPeticaoTexts || []);
      setPastedContestacaoTexts(session.pastedContestacaoTexts || []);
      setPastedComplementaryTexts(session.pastedComplementaryTexts || []);
      setExtractedTopics(session.extractedTopics || []);
      setSelectedTopics(session.selectedTopics || []);
      setPartesProcesso(session.partesProcesso || { reclamante: '', reclamadas: [] });
      setAnalyzedDocuments(session.analyzedDocuments || {
        peticoes: [],
        peticoesText: [],
        contestacoes: [],
        contestacoesText: [],
        complementares: [],
        complementaresText: []
      });

      if (setExtractedTexts) {
        setExtractedTexts(session.extractedTexts || { peticoes: [], contestacoes: [], complementares: [] });
      }

      if (setDocumentProcessingModes) {
        // Migrar modos legados (ex: 'gemini-vision') para 'pdfjs'
        const validModes = ['pdfjs', 'tesseract', 'pdf-puro', 'claude-vision'];
        const migrateMode = (mode) => validModes.includes(mode) ? mode : 'pdfjs';
        const migrateModes = (modes) => (modes || []).map(migrateMode);
        const rawModes = session.documentProcessingModes || { peticoes: [], contestacoes: [], complementares: [] };
        setDocumentProcessingModes({
          peticoes: migrateModes(rawModes.peticoes),
          contestacoes: migrateModes(rawModes.contestacoes),
          complementares: migrateModes(rawModes.complementares)
        });
      }

      // Restaurar PDFs usando UUIDs (novo formato) ou migrar do formato antigo (√≠ndices)
      if (setPeticaoFiles) {
        const peticaoPdfs = [];
        if (session.peticaoFileIds?.length > 0) {
          // Novo formato: usar UUIDs salvos
          for (const id of session.peticaoFileIds) {
            const pPdf = await getPdfFromIndexedDB(`upload-peticao-${id}`);
            if (pPdf) peticaoPdfs.push({ file: pPdf, id });
          }
        } else {
          // Migra√ß√£o: formato antigo com √≠ndices ‚Üí novo com UUIDs
          const oldPdf = await getPdfFromIndexedDB('upload-peticao');
          if (oldPdf) {
            const newId = crypto.randomUUID();
            peticaoPdfs.push({ file: oldPdf, id: newId });
            await savePdfToIndexedDB(`upload-peticao-${newId}`, oldPdf, 'upload');
            await removePdfFromIndexedDB('upload-peticao');
          }
          for (let i = 0; i < 20; i++) {
            const pPdf = await getPdfFromIndexedDB(`upload-peticao-${i}`);
            if (pPdf) {
              const newId = crypto.randomUUID();
              peticaoPdfs.push({ file: pPdf, id: newId });
              await savePdfToIndexedDB(`upload-peticao-${newId}`, pPdf, 'upload');
              await removePdfFromIndexedDB(`upload-peticao-${i}`);
            } else if (i > 0) break;
          }
        }
        if (peticaoPdfs.length > 0) setPeticaoFiles(peticaoPdfs);
      }
      if (setContestacaoFiles) {
        const contestFiles = [];
        if (session.contestacaoFileIds?.length > 0) {
          for (const id of session.contestacaoFileIds) {
            const cPdf = await getPdfFromIndexedDB(`upload-contestacao-${id}`);
            if (cPdf) contestFiles.push({ file: cPdf, id });
          }
        } else {
          for (let i = 0; i < 20; i++) {
            const cPdf = await getPdfFromIndexedDB(`upload-contestacao-${i}`);
            if (cPdf) {
              const newId = crypto.randomUUID();
              contestFiles.push({ file: cPdf, id: newId });
              await savePdfToIndexedDB(`upload-contestacao-${newId}`, cPdf, 'upload');
              await removePdfFromIndexedDB(`upload-contestacao-${i}`);
            } else break;
          }
        }
        if (contestFiles.length > 0) setContestacaoFiles(contestFiles);
      }
      if (setComplementaryFiles) {
        const compFiles = [];
        if (session.complementaryFileIds?.length > 0) {
          for (const id of session.complementaryFileIds) {
            const cpPdf = await getPdfFromIndexedDB(`upload-complementar-${id}`);
            if (cpPdf) compFiles.push({ file: cpPdf, id });
          }
        } else {
          for (let i = 0; i < 20; i++) {
            const cpPdf = await getPdfFromIndexedDB(`upload-complementar-${i}`);
            if (cpPdf) {
              const newId = crypto.randomUUID();
              compFiles.push({ file: cpPdf, id: newId });
              await savePdfToIndexedDB(`upload-complementar-${newId}`, cpPdf, 'upload');
              await removePdfFromIndexedDB(`upload-complementar-${i}`);
            } else break;
          }
        }
        if (compFiles.length > 0) setComplementaryFiles(compFiles);
      }

      if (session.proofFiles && Array.isArray(session.proofFiles)) {
        const results = await Promise.allSettled(
          session.proofFiles.map(async (proof) => {
            const pdfFile = await getPdfFromIndexedDB(`proof-${proof.id}`);
            return {
              id: proof.id,
              file: pdfFile,
              name: proof.name,
              type: proof.type,
              size: proof.size,
              uploadDate: proof.uploadDate
            };
          })
        );
        const restoredProofFiles = results
          .filter(r => r.status === 'fulfilled')
          .map(r => r.value);
        setProofFiles(restoredProofFiles);
      } else {
        setProofFiles([]);
      }

      setProofTexts(session.proofTexts || []);
      setProofUsePdfMode(session.proofUsePdfMode || {});
      setExtractedProofTexts(session.extractedProofTexts || {});
      setProofExtractionFailed(session.proofExtractionFailed || {});
      setProofTopicLinks(session.proofTopicLinks || {});
      setProofAnalysisResults(session.proofAnalysisResults || {});
      setProofConclusions(session.proofConclusions || {});
      setProofSendFullContent(session.proofSendFullContent || {});  // üÜï v1.19.2

      // Ir para a aba upload se houver documentos, sen√£o manter a aba salva
      const hasDocuments = (session.analyzedDocuments?.peticoes?.length > 0) ||
                          (session.analyzedDocuments?.peticoesText?.length > 0) ||
                          (session.pastedPeticaoTexts?.length > 0) ||
                          (session.analyzedDocuments?.contestacoes?.length > 0) ||
                          (session.pastedContestacaoTexts?.length > 0);

      setActiveTab(hasDocuments ? 'upload' : (session.activeTab || 'topics'));

      // v1.20.3: Restaurar contador de tokens
      if (setTokenMetrics && session.tokenMetrics) {
        setTokenMetrics(session.tokenMetrics);
      }

      closeModal('restoreSession');

      // Sess√£o restaurada silenciosamente
    } catch (err) {
      setError('Erro ao restaurar sess√£o: ' + err.message);
    }
  }, [setSessionLastSaved]);

  // v1.35.40: Constr√≥i JSON do projeto para salvar no Google Drive (sem download)
  // v1.35.41: Movido para antes de exportProject (usado por ambos)
  const buildProjectJson = React.useCallback(async (allStates) => {
    const {
      processoNumero,
      pastedPeticaoTexts,
      pastedContestacaoTexts,
      pastedComplementaryTexts,
      extractedTopics,
      selectedTopics,
      partesProcesso,
      aiSettings,
      analyzedDocuments,
      proofFiles,
      proofTexts,
      proofUsePdfMode,
      extractedProofTexts,
      proofExtractionFailed,
      proofTopicLinks,
      proofAnalysisResults,
      proofConclusions,
      peticaoFiles,
      contestacaoFiles,
      complementaryFiles,
      extractedTexts,
      documentProcessingModes,
      tokenMetrics
    } = allStates;

    const uploadPdfs = {
      peticoes: [],
      contestacoes: [],
      complementares: []
    };

    if (peticaoFiles && peticaoFiles.length > 0) {
      uploadPdfs.peticoes = await Promise.all(
        peticaoFiles.map(async (f) => {
          const fileObj = f.file || f;
          return { name: fileObj.name, id: f.id, fileData: await fileToBase64(fileObj) };
        })
      );
    }

    if (contestacaoFiles && contestacaoFiles.length > 0) {
      uploadPdfs.contestacoes = await Promise.all(
        contestacaoFiles.map(async (f) => {
          const fileObj = f.file || f;
          return { name: fileObj.name, id: f.id, fileData: await fileToBase64(fileObj) };
        })
      );
    }

    if (complementaryFiles && complementaryFiles.length > 0) {
      uploadPdfs.complementares = await Promise.all(
        complementaryFiles.map(async (f) => {
          const fileObj = f.file || f;
          return { name: fileObj.name, id: f.id, fileData: await fileToBase64(fileObj) };
        })
      );
    }

    const proofFilesSerializable = await Promise.all(
      (proofFiles || []).map(async (proof) => {
        if (!proof.file) {
          return {
            id: proof.id,
            name: proof.name,
            type: proof.type,
            size: proof.size,
            uploadDate: proof.uploadDate,
            fileData: null
          };
        }
        const base64 = await fileToBase64(proof.file);
        return {
          id: proof.id,
          name: proof.name,
          type: proof.type,
          size: proof.size,
          uploadDate: proof.uploadDate,
          fileData: base64
        };
      })
    );

    // v1.35.74: N√£o exportar apiKeys por seguran√ßa
    // eslint-disable-next-line no-unused-vars
    const { apiKeys: _excluded, ...aiSettingsWithoutKeys } = aiSettings;

    return {
      version: APP_VERSION,
      exportedAt: new Date().toISOString(),
      processoNumero,
      pastedPeticaoTexts,
      pastedContestacaoTexts,
      pastedComplementaryTexts,
      extractedTopics,
      selectedTopics,
      partesProcesso,
      aiSettings: aiSettingsWithoutKeys,
      analyzedDocuments,
      extractedTexts: extractedTexts || { peticoes: [], contestacoes: [], complementares: [] },
      uploadPdfs,
      proofFiles: proofFilesSerializable,
      proofTexts: proofTexts || {},
      proofUsePdfMode: proofUsePdfMode || {},
      extractedProofTexts: extractedProofTexts || {},
      proofExtractionFailed: proofExtractionFailed || {},
      proofTopicLinks: proofTopicLinks || {},
      proofAnalysisResults: proofAnalysisResults || {},
      proofConclusions: proofConclusions || {},
      proofSendFullContent: allStates.proofSendFullContent || {},
      documentProcessingModes: documentProcessingModes || { peticao: 'pdfjs', contestacoes: [], complementares: [] },
      tokenMetrics: tokenMetrics || { totalInput: 0, totalOutput: 0, totalCacheRead: 0, totalCacheCreation: 0, requestCount: 0, lastUpdated: null }
    };
  }, [fileToBase64]);

  // Exporta projeto completo em JSON (PDFs em base64)
  // v1.35.41: Refatorado para usar buildProjectJson (elimina duplica√ß√£o)
  const exportProject = React.useCallback(async (allStates, setError) => {
    try {
      const project = await buildProjectJson(allStates);
      const dataStr = JSON.stringify(project, null, 2);

      // Copiar para clipboard
      await navigator.clipboard.writeText(dataStr);

      // Download do arquivo
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;

      // Gerar nome do arquivo baseado no n√∫mero do processo (se dispon√≠vel)
      const processoPart = project.processoNumero
        ? project.processoNumero.replace(/\s+/g, '-').replace(/\//g, '-')
        : '';
      const datePart = new Date().toISOString().split('T')[0];
      a.download = processoPart
        ? `sentencify-${processoPart}-${datePart}.json`
        : `sentencify-projeto-${datePart}.json`;

      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (err) {
      setError('Erro ao exportar projeto: ' + err.message);
    }
  }, [buildProjectJson]);

  // v1.35.40: Importa projeto a partir de JSON (para Google Drive)
  // v1.35.41: Adicionadas migra√ß√µes de projetos antigos (formato singular)
  const importProjectFromJson = React.useCallback(async (project, callbacks, autoSaveSessionFn) => {
    if (!project || !project.version) {
      throw new Error('Arquivo inv√°lido ou incompat√≠vel.');
    }

    const {
      setPastedPeticaoTexts,
      setPastedContestacaoTexts,
      setPastedComplementaryTexts,
      setExtractedTopics,
      setSelectedTopics,
      setPartesProcesso,
      setAnalyzedDocuments,
      setProofFiles,
      setProofTexts,
      setProofUsePdfMode,
      setExtractedProofTexts,
      setProofExtractionFailed,
      setProofTopicLinks,
      setProofAnalysisResults,
      setProofConclusions,
      setProofSendFullContent,
      setAiSettings,
      setActiveTab,
      setError,
      setProcessoNumero,
      setPeticaoFiles,
      setContestacaoFiles,
      setComplementaryFiles,
      setExtractedTexts,
      setDocumentProcessingModes,
      setTokenMetrics
    } = callbacks;

    try {
      await clearAllPdfsFromIndexedDB();
    } catch (err) {
      // Ignore
    }

    // Migra√ß√£o de projetos antigos (formato singular ‚Üí plural)
    if (project.pastedPeticaoText && !project.pastedPeticaoTexts) {
      project.pastedPeticaoTexts = [{ text: project.pastedPeticaoText, name: 'Peti√ß√£o Inicial' }];
    }
    if (project.analyzedDocuments?.peticao && !project.analyzedDocuments?.peticoes) {
      project.analyzedDocuments.peticoes = project.analyzedDocuments.peticaoType === 'pdf'
        ? [project.analyzedDocuments.peticao] : [];
      project.analyzedDocuments.peticoesText = project.analyzedDocuments.peticaoType === 'text'
        ? [{ text: project.analyzedDocuments.peticao, name: 'Peti√ß√£o Inicial' }] : [];
    }

    // Restaurar dados
    setProcessoNumero(project.processoNumero || '');
    setPastedPeticaoTexts(project.pastedPeticaoTexts || []);
    setPastedContestacaoTexts(project.pastedContestacaoTexts || []);
    setPastedComplementaryTexts(project.pastedComplementaryTexts || []);
    setExtractedTopics(project.extractedTopics || []);
    setSelectedTopics(project.selectedTopics || []);
    setPartesProcesso(project.partesProcesso || { reclamante: '', reclamadas: [] });
    setAnalyzedDocuments(project.analyzedDocuments || {
      peticoes: [], peticoesText: [], contestacoes: [], contestacoesText: [],
      complementares: [], complementaresText: []
    });

    if (setExtractedTexts) {
      setExtractedTexts(project.extractedTexts || { peticoes: [], contestacoes: [], complementares: [] });
    }

    if (setDocumentProcessingModes) {
      const validModes = ['pdfjs', 'tesseract', 'pdf-puro', 'claude-vision'];
      const migrateMode = (mode) => validModes.includes(mode) ? mode : 'pdfjs';
      const migrateModes = (modes) => (modes || []).map(migrateMode);
      const rawModes = project.documentProcessingModes || { peticoes: [], contestacoes: [], complementares: [] };
      setDocumentProcessingModes({
        peticoes: migrateModes(rawModes.peticoes),
        contestacoes: migrateModes(rawModes.contestacoes),
        complementares: migrateModes(rawModes.complementares)
      });
    }

    // Restaurar PDFs
    if (project.uploadPdfs) {
      // Peti√ß√µes (novo formato com UUID)
      if (project.uploadPdfs.peticoes && setPeticaoFiles) {
        const petFiles = [];
        for (const pData of project.uploadPdfs.peticoes) {
          const pFile = base64ToFile(pData.fileData, pData.name, 'application/pdf');
          const id = pData.id || crypto.randomUUID();
          petFiles.push({ file: pFile, id });
          await savePdfToIndexedDB(`upload-peticao-${id}`, pFile, 'upload');
        }
        setPeticaoFiles(petFiles);
      }
      // Peti√ß√£o (formato antigo singular - migra√ß√£o)
      else if (project.uploadPdfs.peticao && setPeticaoFiles) {
        const pData = project.uploadPdfs.peticao;
        const pFile = base64ToFile(pData.fileData, pData.name, 'application/pdf');
        const id = crypto.randomUUID();
        setPeticaoFiles([{ file: pFile, id }]);
        await savePdfToIndexedDB(`upload-peticao-${id}`, pFile, 'upload');
      }
      if (project.uploadPdfs.contestacoes && setContestacaoFiles) {
        const contestFiles = [];
        for (const cData of project.uploadPdfs.contestacoes) {
          const cFile = base64ToFile(cData.fileData, cData.name, 'application/pdf');
          const id = cData.id || crypto.randomUUID();
          contestFiles.push({ file: cFile, id });
          await savePdfToIndexedDB(`upload-contestacao-${id}`, cFile, 'upload');
        }
        setContestacaoFiles(contestFiles);
      }
      if (project.uploadPdfs.complementares && setComplementaryFiles) {
        const compFiles = [];
        for (const cpData of project.uploadPdfs.complementares) {
          const cpFile = base64ToFile(cpData.fileData, cpData.name, 'application/pdf');
          const id = cpData.id || crypto.randomUUID();
          compFiles.push({ file: cpFile, id });
          await savePdfToIndexedDB(`upload-complementar-${id}`, cpFile, 'upload');
        }
        setComplementaryFiles(compFiles);
      }
    }

    // Restaurar provas
    let restoredProofFiles = [];
    if (project.proofFiles && Array.isArray(project.proofFiles)) {
      restoredProofFiles = await Promise.all(
        project.proofFiles.map(async (proof) => {
          if (!proof.fileData) {
            return { id: proof.id, file: null, name: proof.name, type: proof.type, size: proof.size, uploadDate: proof.uploadDate };
          }
          const byteCharacters = atob(proof.fileData);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: 'application/pdf' });
          const restoredFile = new File([blob], proof.name, { type: 'application/pdf' });
          await savePdfToIndexedDB(`proof-${proof.id}`, restoredFile, 'proof');
          return { id: proof.id, file: restoredFile, name: proof.name, type: proof.type, size: proof.size, uploadDate: proof.uploadDate };
        })
      );
      setProofFiles(restoredProofFiles);
    } else {
      setProofFiles([]);
    }

    setProofTexts(project.proofTexts || []);
    setProofUsePdfMode(project.proofUsePdfMode || {});
    setExtractedProofTexts(project.extractedProofTexts || {});
    setProofExtractionFailed(project.proofExtractionFailed || {});
    setProofTopicLinks(project.proofTopicLinks || {});
    setProofAnalysisResults(project.proofAnalysisResults || {});
    setProofConclusions(project.proofConclusions || {});
    setProofSendFullContent(project.proofSendFullContent || {});

    if (setTokenMetrics && project.tokenMetrics) {
      setTokenMetrics(project.tokenMetrics);
    }

    // v1.35.74: Migrar projetos antigos + preservar apiKeys do localStorage
    if (project.aiSettings) {
      // Defaults para campos novos de IA Local
      const iaLocalDefaults = {
        semanticSearchEnabled: false,
        semanticThreshold: 50,
        jurisSemanticEnabled: false,
        jurisSemanticThreshold: 50,
        modelSemanticEnabled: false,
        modelSemanticThreshold: 40,
        useLocalAIForSuggestions: false,
        useLocalAIForJuris: false
      };

      // Obter apiKeys ATUAIS do localStorage (nunca sobrescrever!)
      let currentApiKeys = { claude: '', gemini: '' };
      try {
        const saved = localStorage.getItem('sentencify-ai-settings');
        if (saved) {
          const parsed = JSON.parse(saved);
          currentApiKeys = parsed.apiKeys || currentApiKeys;
        }
      } catch (e) { /* ignore */ }

      // Merge: defaults ‚Üí projeto ‚Üí apiKeys atuais (nunca sobrescreve chaves)
      const mergedAiSettings = {
        ...iaLocalDefaults,
        ...project.aiSettings,
        apiKeys: currentApiKeys  // Sempre preserva as chaves do usu√°rio
      };
      setAiSettings(mergedAiSettings);
    }

    setActiveTab('upload');

    if (autoSaveSessionFn) {
      const allStates = {
        processoNumero: project.processoNumero || '',
        pastedPeticaoTexts: project.pastedPeticaoTexts || [],
        pastedContestacaoTexts: project.pastedContestacaoTexts || [],
        pastedComplementaryTexts: project.pastedComplementaryTexts || [],
        extractedTopics: project.extractedTopics || [],
        selectedTopics: project.selectedTopics || [],
        partesProcesso: project.partesProcesso || { reclamante: '', reclamadas: [] },
        activeTab: 'upload',
        analyzedDocuments: project.analyzedDocuments || {},
        extractedTexts: project.extractedTexts || { peticoes: [], contestacoes: [], complementares: [] },
        proofFiles: restoredProofFiles || [],
        proofTexts: project.proofTexts || [],
        proofUsePdfMode: project.proofUsePdfMode || {},
        extractedProofTexts: project.extractedProofTexts || {},
        proofExtractionFailed: project.proofExtractionFailed || {},
        proofTopicLinks: project.proofTopicLinks || {},
        proofAnalysisResults: project.proofAnalysisResults || {},
        proofConclusions: project.proofConclusions || {},
        proofSendFullContent: project.proofSendFullContent || {},
        documentProcessingModes: project.documentProcessingModes || { peticao: 'pdfjs', contestacoes: [], complementares: [] },
        tokenMetrics: project.tokenMetrics || { totalInput: 0, totalOutput: 0, totalCacheRead: 0, totalCacheCreation: 0, requestCount: 0, lastUpdated: null }
      };
      autoSaveSessionFn(allStates, setError, true);
    }
  }, [base64ToFile, clearAllPdfsFromIndexedDB, savePdfToIndexedDB]);

  // Importa projeto de arquivo JSON
  // v1.35.41: Refatorado para usar importProjectFromJson (elimina duplica√ß√£o)
  const importProject = React.useCallback(async (event, callbacks, autoSaveSessionFn) => {
    const file = event.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const project = JSON.parse(text);

      if (!project.version) {
        callbacks.setError('Arquivo inv√°lido ou incompat√≠vel.');
        event.target.value = '';
        return;
      }

      await importProjectFromJson(project, callbacks, autoSaveSessionFn);

      // Limpar input para permitir reimportar o mesmo arquivo
      event.target.value = '';
    } catch (err) {
      callbacks.setError('Erro ao importar projeto: ' + err.message);
      event.target.value = '';
    }
  }, [importProjectFromJson]);

  // Limpa todos os dados do projeto
  const clearProject = React.useCallback((callbacks) => {
    try {
      const {
        closeModal,
        setPastedPeticaoTexts,
        setPastedContestacaoTexts,
        setPastedComplementaryTexts,
        setExtractedTopics,
        setSelectedTopics,
        setPartesProcesso,
        setAnalyzedDocuments,
        setPeticaoFiles,
        setContestacaoFiles,
        setComplementaryFiles,
        setActiveTab,
        setProofFiles,
        setProofTexts,
        setProofUsePdfMode,
        setExtractedProofTexts,
        setProofExtractionFailed,
        setProofTopicLinks,
        setProofAnalysisResults,
        setProofConclusions,
        setProofToDelete,
        setProofToLink,
        setProofToAnalyze,
        clearAnalyzingProofs,
        setShowProofPanel,
        setNewProofTextData,
        setError,
        setProcessoNumero,
        setTokenMetrics // v1.20.3: Contador de tokens persistente
      } = callbacks;

      // Resetar estados de sess√£o e modais
      setSessionLastSaved(null);
      closeModal('restoreSession');
      closeModal('clearProject');

      // Limpar estados de documentos
      setProcessoNumero('');
      setPastedPeticaoTexts([]);
      setPastedContestacaoTexts([]);
      setPastedComplementaryTexts([]);
      setExtractedTopics([]);
      setSelectedTopics([]);
      setPartesProcesso({ reclamante: '', reclamadas: [] });
      setAnalyzedDocuments({
        peticoes: [],
        peticoesText: [],
        contestacoes: [],
        contestacoesText: [],
        complementares: [],
        complementaresText: []
      });
      setPeticaoFiles([]);
      setContestacaoFiles([]);
      setComplementaryFiles([]);
      setActiveTab('upload');

      // Limpar estados do sistema de provas - Dados (v1.2.0)
      setProofFiles([]);
      setProofTexts([]);
      setProofUsePdfMode({});
      setExtractedProofTexts({});
      setProofExtractionFailed({});
      setProofTopicLinks({});
      setProofAnalysisResults({});
      setProofConclusions({});

      // Limpar estados do sistema de provas - UI/Modais (v1.2.0)
      setProofToDelete(null);
      setProofToLink(null);
      setProofToAnalyze(null);
      clearAnalyzingProofs();
      setShowProofPanel(true);
      closeModal('addProofText');
      setNewProofTextData({ name: '', text: '' });
      closeModal('deleteProof');
      closeModal('linkProof');
      closeModal('proofAnalysis');

      // Remover dados salvos do localStorage (deve ser feito ap√≥s resetar estados)
      localStorage.removeItem('sentencifySession');

      // v1.12.14: Limpar todos os PDFs do IndexedDB
      clearAllPdfsFromIndexedDB().catch(err => {
      });

      // v1.20.2: Limpar cache de PDFs em mem√≥ria para liberar RAM
      clearPdfCache();

      // v1.20.3: Resetar contador de tokens
      if (setTokenMetrics) {
        setTokenMetrics({
          totalInput: 0,
          totalOutput: 0,
          totalCacheRead: 0,
          totalCacheCreation: 0,
          requestCount: 0,
          lastUpdated: null
        });
      }

    } catch (err) {
      setError('Erro ao limpar sess√£o: ' + err.message);
    }
  }, [setSessionLastSaved]);

  // Return
  return {
    // Estados
    sessionLastSaved,
    showAutoSaveIndicator,

    // Setters
    setSessionLastSaved,
    setShowAutoSaveIndicator,

    // Fun√ß√µes Auxiliares
    fileToBase64,
    base64ToFile,

    // Fun√ß√µes de Verifica√ß√£o
    checkSavedSession,

    // Fun√ß√µes de Persist√™ncia (ETAPA 4/5)
    autoSaveSession,
    restoreSession,
    exportProject,
    importProject,
    importProjectFromJson,  // v1.35.40: Para carregar do Google Drive
    clearProject,
    buildProjectJson  // v1.35.40: Para salvar no Google Drive
  };
};

// üé£ CUSTOM HOOK: useModelLibrary (v1.2.5) - Biblioteca de modelos jur√≠dicos
// =============================================================================
// useModelLibrary - Biblioteca de Modelos (v2.0 - LLM-friendly)
// Se√ß√µes: 1.DADOS | 2.BUSCA | 3.FORMUL√ÅRIO | 4.BULK | 5.PERSIST√äNCIA
// =============================================================================
const useModelLibrary = () => {

  // ===========================================================================
  // SE√á√ÉO 1: DADOS CORE
  // ===========================================================================
  const [models, setModels] = React.useState([]);
  const [hasUnsavedChanges, setHasUnsavedChanges] = React.useState(false);
  const [isLoadingModels, setIsLoadingModels] = React.useState(false);
  const [persistenceError, setPersistenceError] = React.useState(null);

  // ===========================================================================
  // SE√á√ÉO 2: BUSCA E FILTROS
  // ===========================================================================
  const [searchTerm, setSearchTerm] = React.useState('');
  const [selectedCategory, setSelectedCategory] = React.useState('all');
  const [showFavoritesOnly, setShowFavoritesOnly] = React.useState(false);
  const [ownershipFilter, setOwnershipFilter] = React.useState('all'); // v1.35.0: 'all' | 'mine' | 'shared'
  const [currentModelPage, setCurrentModelPage] = React.useState(1);
  const [manualSearchTerm, setManualSearchTerm] = React.useState('');
  const [manualSearchResults, setManualSearchResults] = React.useState([]);
  const [suggestions, setSuggestions] = React.useState([]);
  const [suggestionsSource, setSuggestionsSource] = React.useState(null); // v1.28.04: 'local' ou 'api'
  const [loadingSuggestions, setLoadingSuggestions] = React.useState(false);
  const [modelViewMode, setModelViewMode] = React.useState('cards');
  const modelsPerPage = 5;

  // --- Busca manual por termo (l√≥gica encapsulada) ---
  const performManualSearch = React.useCallback((term) => {
    if (!term?.trim()) {
      setManualSearchResults([]);
      return;
    }
    const results = searchModelsInLibrary(models, term, { limit: 10, includeContent: true });
    setManualSearchResults(results);
  }, [models]);

  // --- Busca com debounce 300ms ---
  const debouncedSearchTimeoutRef = React.useRef(null);
  const debouncedManualSearch = React.useCallback((term) => {
    clearTimeout(debouncedSearchTimeoutRef.current);
    debouncedSearchTimeoutRef.current = setTimeout(() => performManualSearch(term), 300);
  }, [performManualSearch]);

  // ===========================================================================
  // SE√á√ÉO 3: FORMUL√ÅRIO E EDI√á√ÉO
  // ===========================================================================
  const [newModel, setNewModel] = React.useState({ title: '', content: '', keywords: '', category: '' });
  const [editingModel, setEditingModel] = React.useState(null);
  const [extractingModelFromDecision, setExtractingModelFromDecision] = React.useState(false);
  const [showExtractModelButton, setShowExtractModelButton] = React.useState(true);
  const [extractedModelPreview, setExtractedModelPreview] = React.useState(null);
  const [exportedModelsText, setExportedModelsText] = React.useState('');
  const [modelToDelete, setModelToDelete] = React.useState(null);
  const [similarityWarning, setSimilarityWarning] = React.useState(null);

  // --- Resetar formul√°rio ---
  const resetForm = React.useCallback(() => {
    setNewModel({ title: '', content: '', keywords: '', category: '' });
    setEditingModel(null);
    setExtractedModelPreview(null);
    setSimilarityWarning(null);
  }, []);

  // --- Iniciar edi√ß√£o de modelo ---
  const startEditingModel = React.useCallback((model) => {
    setEditingModel(model);
    setNewModel({
      title: model.title || '',
      content: model.content || '',
      keywords: model.keywords || '',
      category: model.category || ''
    });
  }, []);

  // ===========================================================================
  // SE√á√ÉO 4: PROCESSAMENTO EM LOTE (BULK)
  // ===========================================================================
  const [deleteAllConfirmText, setDeleteAllConfirmText] = React.useState('');
  const [bulkFiles, setBulkFiles] = React.useState([]);
  const [bulkProcessing, setBulkProcessing] = React.useState(false);
  const [bulkCurrentFileIndex, setBulkCurrentFileIndex] = React.useState(0);
  const [bulkProcessedFiles, setBulkProcessedFiles] = React.useState([]);
  const [bulkGeneratedModels, setBulkGeneratedModels] = React.useState([]);
  const [bulkErrors, setBulkErrors] = React.useState([]);
  const [bulkReviewModels, setBulkReviewModels] = React.useState([]);
  const [bulkEditingModel, setBulkEditingModel] = React.useState(null);
  const [bulkCancelController, setBulkCancelController] = React.useState(null);
  const [bulkStaggerDelay, setBulkStaggerDelay] = React.useState(0);
  const [bulkCurrentBatch, setBulkCurrentBatch] = React.useState(0);

  // --- Cancelar processamento bulk ---
  const cancelBulkProcessing = React.useCallback(() => {
    if (bulkCancelController) {
      bulkCancelController.abort();
      setBulkCancelController(null);
    }
    setBulkProcessing(false);
    setBulkCurrentBatch(0);
  }, [bulkCancelController]);

  // --- Remover arquivo da fila ---
  const removeBulkFile = React.useCallback((index) => {
    setBulkFiles(prev => prev.filter((_, i) => i !== index));
  }, []);

  // --- Resetar estados bulk ---
  const resetBulkState = React.useCallback(() => {
    setBulkFiles([]);
    setBulkProcessedFiles([]);
    setBulkGeneratedModels([]);
    setBulkReviewModels([]);
    setBulkErrors([]);
    setBulkEditingModel(null);
  }, []);

  // --- Cleanup ao desmontar ---
  React.useEffect(() => {
    return () => {
      if (bulkCancelController) {
        bulkCancelController.abort();
        setBulkCancelController(null);
      }
    };
  }, [bulkCancelController]);

  // ===========================================================================
  // RETORNO - Interface P√∫blica
  // ===========================================================================
  return {
    // --- Se√ß√£o 1: Dados Core ---
    models, setModels,
    hasUnsavedChanges, setHasUnsavedChanges,
    isLoadingModels, setIsLoadingModels,
    persistenceError, setPersistenceError,

    // --- Se√ß√£o 2: Busca ---
    searchTerm, setSearchTerm,
    selectedCategory, setSelectedCategory,
    showFavoritesOnly, setShowFavoritesOnly,
    ownershipFilter, setOwnershipFilter, // v1.35.0
    currentModelPage, setCurrentModelPage,
    manualSearchTerm, setManualSearchTerm,
    manualSearchResults, setManualSearchResults,
    suggestions, setSuggestions,
    suggestionsSource, setSuggestionsSource,
    loadingSuggestions, setLoadingSuggestions,
    modelViewMode, setModelViewMode,
    modelsPerPage,
    performManualSearch, debouncedManualSearch,

    // --- Se√ß√£o 3: Formul√°rio ---
    newModel, setNewModel,
    editingModel, setEditingModel,
    extractingModelFromDecision, setExtractingModelFromDecision,
    showExtractModelButton, setShowExtractModelButton,
    extractedModelPreview, setExtractedModelPreview,
    exportedModelsText, setExportedModelsText,
    modelToDelete, setModelToDelete,
    similarityWarning, setSimilarityWarning,
    resetForm, startEditingModel,

    // --- Se√ß√£o 4: Bulk ---
    deleteAllConfirmText, setDeleteAllConfirmText,
    bulkFiles, setBulkFiles,
    bulkProcessing, setBulkProcessing,
    bulkCurrentFileIndex, setBulkCurrentFileIndex,
    bulkProcessedFiles, setBulkProcessedFiles,
    bulkGeneratedModels, setBulkGeneratedModels,
    bulkErrors, setBulkErrors,
    bulkReviewModels, setBulkReviewModels,
    bulkEditingModel, setBulkEditingModel,
    bulkCancelController, setBulkCancelController,
    bulkStaggerDelay, setBulkStaggerDelay,
    bulkCurrentBatch, setBulkCurrentBatch,
    cancelBulkProcessing, removeBulkFile, resetBulkState
  };
};

// üîç Busca Inteligente Unificada de Modelos - v1.15.0
const removeAccents = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

// ‚öñÔ∏è v1.20.0: Helpers de Jurisprud√™ncia (reutiliz√°veis)
const STATUS_INVALIDOS = new Set(['cancelada', 'revogada', 'convertida', 'superado', 'convertida em s√∫mula']);
const isStatusValido = (status) => {
  if (!status) return true;
  return !STATUS_INVALIDOS.has(status.toLowerCase());
};
const IRR_TYPES = new Set(['IRR', 'RR', 'RRAG', 'INCJULGRREMBREP', 'INCJULGRREPETITIVO']);
const isIRRType = (tipo) => IRR_TYPES.has((tipo || '').toUpperCase().replace(/-/g, ''));

// Cache global para resultados de jurisprud√™ncia
const jurisCache = new Map();
const JURIS_CACHE_TTL = 5 * 60 * 1000; // 5 minutos
const hashJurisKey = (str) => {
  let hash = 0;
  for (let i = 0; i < (str || '').length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash = hash & hash;
  }
  return hash.toString(36);
};

const refineJurisWithAIHelper = async (title, context, candidates, callLLM) => {
  if (!callLLM || typeof callLLM !== 'function') {
    console.warn('[JurisAI] callLLM n√£o dispon√≠vel, retornando candidatos sem refinamento');
    return candidates.slice(0, 10);
  }
  try {
    // Formatar candidatos com mais informa√ß√£o para a IA decidir melhor
    const candidatosFormatados = candidates.map((c, i) => {
      const tipo = c.tipoProcesso || 'Precedente';
      const num = c.numero ? ` ${c.numero}` : '';
      const tribunal = c.tribunal ? ` (${c.tribunal})` : '';
      const titulo = c.titulo ? `\n   T√≠tulo: ${c.titulo}` : '';
      const tese = (c.tese || c.enunciado || '').substring(0, 150);
      return `${i}: ${tipo}${num}${tribunal}${titulo}\n   Tese: ${tese}...`;
    }).join('\n\n');

    const prompt = `Voc√™ √© um especialista em jurisprud√™ncia trabalhista brasileira.

T√ìPICO DA SENTEN√áA: "${title}"

CONTEXTO/RELAT√ìRIO:
${context || 'N√£o dispon√≠vel'}

PRECEDENTES CANDIDATOS:
${candidatosFormatados}

TAREFA: Selecione os 10 precedentes MAIS RELEVANTES para fundamentar este t√≥pico espec√≠fico.

CRIT√âRIOS DE PRIORIZA√á√ÉO:
1. Precedentes que tratam EXATAMENTE do tema espec√≠fico (n√£o apenas mencionam palavras similares)
2. S√∫mulas e OJs vinculantes diretamente aplic√°veis
3. Teses de repercuss√£o geral ou recursos repetitivos sobre o assunto
4. Hierarquia: TST = STF > TRT > STJ

IMPORTANTE: Foque na PERTIN√äNCIA TEM√ÅTICA REAL, n√£o apenas em palavras coincidentes.

Retorne APENAS os √≠ndices dos 10 selecionados, do mais ao menos relevante.
Formato: 5,12,3,8,15,1,9,7,2,11`;

    const messages = [{ role: 'user', content: [{ type: 'text', text: prompt }] }];
    // v1.21.26: Parametros deterministicos para ranking
    const response = await callLLM(messages, { maxTokens: 300, disableThinking: true, useInstructions: false, temperature: 0.0, topP: 0.9, topK: 40 });
    const text = typeof response === 'string' ? response : response?.content?.[0]?.text || '';
    const indices = text.match(/\d+/g)?.map(Number) || [];
    const result = indices.filter(i => i < candidates.length).map(i => candidates[i]);
    return result.length > 0 ? result.slice(0, 10) : candidates.slice(0, 10);
  } catch (err) {
    console.warn('[JurisAI] Refinamento falhou:', err?.message || err);
    return candidates.slice(0, 10);
  }
};

const findJurisprudenciaHelper = async (topicTitle, miniRelatorio, callLLM, filtros = {}) => {
  // Verificar cache primeiro (incluindo filtros na chave)
  const cacheKey = `juris_${topicTitle}_${hashJurisKey(miniRelatorio)}_${filtros.tipo?.join(',') || ''}_${filtros.tribunal?.join(',') || ''}_${filtros.searchTerm || ''}`;
  const cached = jurisCache.get(cacheKey);
  if (cached && (Date.now() - cached.timestamp) < JURIS_CACHE_TTL) {
    return cached.results;
  }

  const allPrecedentes = await loadPrecedentesFromIndexedDB();
  if (!allPrecedentes || allPrecedentes.length === 0) return [];

  // Filtrar apenas precedentes v√°lidos (excluir canceladas/revogadas/convertidas)
  let validPrecedentes = allPrecedentes.filter(p => isStatusValido(p.status));

  // Aplicar filtros por tipo
  if (filtros.tipo?.length > 0) {
    validPrecedentes = validPrecedentes.filter(p => {
      if (filtros.tipo.includes('IRR') && isIRRType(p.tipoProcesso)) return true;
      return filtros.tipo.includes(p.tipoProcesso);
    });
  }

  // Aplicar filtros por tribunal
  if (filtros.tribunal?.length > 0) {
    validPrecedentes = validPrecedentes.filter(p => filtros.tribunal.includes(p.tribunal));
  }

  // Filtro por busca textual do usu√°rio
  if (filtros.searchTerm?.trim()) {
    const searchTermNorm = removeAccents(filtros.searchTerm.toLowerCase().trim());
    const rawTerms = searchTermNorm.split(/\s+/).filter(w => w.length > 2 && !SEARCH_STOPWORDS.has(w));
    if (rawTerms.length === 0) return [];

    // S√≥ expande sin√¥nimos se a frase COMPLETA corresponder a uma chave do dicion√°rio
    const expandedFromPhrase = [];
    for (const [termo, sinonimos] of Object.entries(SINONIMOS_JURIDICOS)) {
      const termoNorm = removeAccents(termo.toLowerCase());
      if (searchTermNorm.includes(termoNorm) || termoNorm.includes(searchTermNorm)) {
        expandedFromPhrase.push(termoNorm, ...sinonimos.map(s => removeAccents(s.toLowerCase())));
      }
    }

    // Termos para busca: originais + stems + sin√¥nimos de frase completa (sem sin√¥nimos gen√©ricos)
    const rawStems = rawTerms.map(stemJuridico).filter(s => s.length > 3);

    // Pontuar cada precedente por quantos termos deram match
    const scored = validPrecedentes.map(p => {
      const searchable = removeAccents(
        `${p.tese || ''} ${p.enunciado || ''} ${p.titulo || ''} ${(Array.isArray(p.keywords) ? p.keywords : []).join(' ')}`
      ).toLowerCase();

      let score = 0;
      let matchedTerms = 0;

      // Match de termos originais (mais importante)
      for (const term of rawTerms) {
        if (searchable.includes(term)) {
          score += 30;
          matchedTerms++;
        }
      }

      // Match por stems (se n√£o houve match direto)
      if (matchedTerms < rawTerms.length) {
        for (const stem of rawStems) {
          if (searchable.includes(stem)) {
            score += 15;
            matchedTerms++;
          }
        }
      }

      // Match por sin√¥nimos de frase completa
      for (const syn of expandedFromPhrase) {
        if (searchable.includes(syn)) {
          score += 20;
          matchedTerms++;
          break; // s√≥ conta uma vez
        }
      }

      // EXIGIR que pelo menos metade dos termos originais deem match (ou sin√¥nimo da frase)
      const minMatches = Math.max(1, Math.ceil(rawTerms.length / 2));
      if (matchedTerms < minMatches && expandedFromPhrase.length === 0) {
        return { ...p, score: 0 };
      }
      if (matchedTerms === 0) return { ...p, score: 0 };

      // Boost por hierarquia de tribunal
      if (isIRRType(p.tipoProcesso) && p.tribunal === 'TST') score += 500;
      else if (['ADI', 'ADC', 'ADPF', 'RE', 'ARE'].some(t => p.tipoProcesso?.includes(t))) score += 500;
      else if (['IRDR', 'IAC'].includes(p.tipoProcesso) && p.tribunal === 'TRT8') score += 450;
      else if (p.tipoProcesso === 'S√∫mula' && p.tribunal === 'STF') score += 100;
      else if (['S√∫mula', 'OJ'].includes(p.tipoProcesso) && p.tribunal === 'TST') score += 100;
      else if (p.tribunal === 'STF') score += 50;
      else if (p.tribunal === 'TST') score += 50;
      else if (p.tribunal === 'TRT8') score += 30;
      else if (p.tribunal === 'STJ') score += 5;

      return { ...p, score };
    });

    const filtered = scored.filter(p => p.score > 0).sort((a, b) => b.score - a.score);
    const top = filtered.slice(0, 40);
    jurisCache.set(cacheKey, { results: top, timestamp: Date.now() });
    return top;
  }

  // 1. Limpar e normalizar t√≠tulo (remover pontua√ß√£o e stopwords)
  const cleanTitle = topicTitle.replace(/[.,;:!?()\[\]{}]/g, ' ').toLowerCase();
  const rawWords = cleanTitle.split(/\s+/).filter(w => w.length > 2);
  const titleWords = rawWords.filter(w => !SEARCH_STOPWORDS.has(w));

  // 2. Tamb√©m extrair termos do relat√≥rio (contexto adicional)
  const cleanRelatorio = (miniRelatorio || '').replace(/[.,;:!?()\[\]{}]/g, ' ').toLowerCase();
  const relatorioWords = cleanRelatorio.split(/\s+/)
    .filter(w => w.length > 3 && !SEARCH_STOPWORDS.has(w))
    .slice(0, 30); // Limitar para n√£o sobrecarregar

  // 3. Expandir com sin√¥nimos
  const expandedTitle = expandWithSynonyms(titleWords);
  const expandedRelatorio = expandWithSynonyms(relatorioWords);

  // 4. Criar stems para busca fuzzy
  const titleStems = new Set(titleWords.map(w => stemJuridico(w)).filter(s => s.length > 2));
  const allSearchTerms = new Set([...expandedTitle, ...titleWords]);
  const allSearchStems = new Set([...titleStems, ...titleWords.map(w => removeAccents(w))]);

  // 5. Pontuar cada precedente
  const scored = validPrecedentes.map(p => {
    let score = 0;
    const keywordsRaw = typeof p.keywords === 'string' ? p.keywords.split(/[,;]/).map(k => k.trim()) : (Array.isArray(p.keywords) ? p.keywords : []);
    const keywords = keywordsRaw.map(k => removeAccents(k.toLowerCase()));
    const keywordStems = keywords.map(k => k.split(/\s+/).map(w => stemJuridico(w))).flat();
    const tese = removeAccents((p.tese || p.enunciado || '').toLowerCase());
    const titulo = removeAccents((p.titulo || '').toLowerCase());
    const teseStems = tese.split(/\s+/).map(w => stemJuridico(w));

    // Match em keywords (mais importante)
    for (const term of allSearchTerms) {
      const termNorm = removeAccents(term);
      if (keywords.some(k => k.includes(termNorm) || termNorm.includes(k))) score += 20;
    }

    // Match por stem em keywords (captura varia√ß√µes morfol√≥gicas)
    for (const stem of allSearchStems) {
      if (stem.length > 3 && keywordStems.some(ks => ks.includes(stem) || stem.includes(ks))) score += 15;
    }

    // Match em t√≠tulo do precedente
    for (const term of allSearchTerms) {
      const termNorm = removeAccents(term);
      if (titulo.includes(termNorm)) score += 15;
    }

    // Match em tese/enunciado
    for (const term of allSearchTerms) {
      const termNorm = removeAccents(term);
      if (tese.includes(termNorm)) score += 10;
    }

    // Match por stemming em tese (mais flex√≠vel)
    for (const stem of allSearchStems) {
      if (stem.length > 3 && teseStems.some(ts => ts.includes(stem) || stem.includes(ts))) score += 8;
    }

    // Match com termos do relat√≥rio (contexto)
    for (const term of expandedRelatorio) {
      const termNorm = removeAccents(term);
      if (tese.includes(termNorm) || titulo.includes(termNorm)) score += 3;
    }

    // Boost para status v√°lido
    if (isStatusValido(p.status)) score += 5;

    // Boost FORTE para precedentes vinculantes/obrigat√≥rios
    const tipoProc = (p.tipoProcesso || '').toUpperCase();
    const tribunal = (p.tribunal || '').toUpperCase();
    const orgao = (p.orgao || '').toUpperCase();
    const category = (p.category || '').toUpperCase();

    // IRR/IAC do TST (m√°xima prioridade - vinculantes obrigat√≥rios)
    if (tribunal === 'TST' && (isIRRType(tipoProc) || tipoProc === 'IAC' || category.includes('IRR') || category.includes('IAC'))) {
      score += 500;
    }
    // ADI/ADC/ADPF e Repercuss√£o Geral do STF (vinculantes)
    else if (tribunal === 'STF' && (tipoProc === 'ADI' || tipoProc === 'ADC' || tipoProc === 'ADPF' || tipoProc === 'RE' || tipoProc === 'ARE' || category.includes('REPERCUSSAO'))) {
      score += 480;
    }
    // IRDR/IAC do TRT8 (vinculantes regionais)
    else if ((tribunal === 'TRT8' || tribunal === 'TRT-8' || orgao.includes('TRT')) && (tipoProc === 'IRDR' || tipoProc === 'IAC' || category.includes('IRDR') || category.includes('IAC'))) {
      score += 450;
    }
    // S√∫mulas vinculantes STF
    else if (tribunal === 'STF' && tipoProc === 'S√öMULA') {
      score += 80;
    }
    // S√∫mulas TST
    else if (tribunal === 'TST' && (tipoProc === 'S√öMULA' || tipoProc === 'OJ')) {
      score += 70;
    }
    // Outros STF/STJ/TST
    else if (tribunal === 'STF') score += 15;
    else if (tribunal === 'STJ') score += 12;
    else if (tribunal === 'TST') score += 10;

    return { ...p, score };
  });

  // 6. Filtrar e ordenar (mais candidatos para a IA refinar)
  const candidates = scored.filter(p => p.score > 0).sort((a, b) => b.score - a.score).slice(0, 40);

  // 7. Se tiver candidatos suficientes, usar IA para refinar
  let results;
  if (candidates.length > 3 && callLLM) {
    results = await refineJurisWithAIHelper(topicTitle, miniRelatorio, candidates, callLLM);
  } else {
    results = candidates.slice(0, 10);
  }

  // Salvar no cache
  jurisCache.set(cacheKey, { results, timestamp: Date.now() });
  return results;
};

const SEARCH_STOPWORDS = new Set(['de', 'do', 'da', 'dos', 'das', 'em', 'no', 'na', 'nos', 'nas',
  'para', 'com', 'por', 'pelo', 'pela', 'pelos', 'pelas', 'ao', 'aos',
  'um', 'uma', 'uns', 'umas', 'o', 'a', 'os', 'as', 'e', 'ou', 'que', 'se']);

const SINONIMOS_JURIDICOS = {
  'horas extras': ['sobrejornada', 'jornada extraordinaria', 'horas suplementares', 'hora extra'],
  'rescisao indireta': ['despedida indireta', 'justa causa do empregador', 'resilicao indireta'],
  'verbas rescisorias': ['haveres rescisorios', 'parcelas rescisorias', 'direitos rescisorios', 'saldo de salario', 'aviso previo'],
  'rescisao': ['verbas rescisorias', 'rescisao contratual', 'dispensa', 'desligamento', 'termino do contrato'],
  'adicional noturno': ['hora noturna', 'trabalho noturno'],
  'danos morais': ['indenizacao por dano moral', 'reparacao moral', 'dano extrapatrimonial', 'dano moral', 'lesao moral'],
  'dano moral': ['danos morais', 'indenizacao por dano moral', 'reparacao moral', 'dano extrapatrimonial'],
  'danos materiais': ['dano patrimonial', 'prejuizo material'],
  'assedio moral': ['mobbing', 'perseguicao no trabalho'],
  'insalubridade': ['adicional de insalubridade', 'agente insalubre'],
  'periculosidade': ['adicional de periculosidade', 'risco de vida'],
  'vinculo empregaticio': ['relacao de emprego', 'contrato de trabalho'],
  'aviso previo': ['pre-aviso', 'denuncia do contrato'],
  'ferias': ['ferias vencidas', 'ferias proporcionais', 'terco constitucional'],
  'fgts': ['fundo de garantia', 'fundiario', 'deposito fundiario'],
  'multa 477': ['multa rescisoria', 'atraso nas verbas'],
  'multa 467': ['verbas incontroversos'],
  'equiparacao salarial': ['isonomia salarial', 'salario igual'],
  'desvio de funcao': ['acumulo de funcao', 'diferencas salariais'],
  'justa causa': ['dispensa por justa causa', 'falta grave'],
  'estabilidade': ['garantia de emprego', 'estabilidade provisoria'],
  'acidente de trabalho': ['acidente laboral', 'sinistro ocupacional'],
  'doenca ocupacional': ['doenca profissional', 'doenca do trabalho'],
  'intervalo intrajornada': ['intervalo para refeicao', 'hora de almoco'],
  'intervalo interjornada': ['descanso entre jornadas'],
  'banco de horas': ['compensacao de jornada'],
  'terceirizacao': ['outsourcing', 'prestacao de servicos'],
  'responsabilidade subsidiaria': ['condenacao subsidiaria'],
  'responsabilidade solidaria': ['condenacao solidaria'],
  'prescricao': ['prazo prescricional', 'prescricao quinquenal', 'prescricao bienal'],
  'litigancia de ma-fe': ['ma-fe processual'],
  'honorarios': ['honorarios advocaticios', 'honorarios sucumbenciais'],
  'justica gratuita': ['gratuidade de justica', 'assistencia judiciaria'],
  'inss': ['contribuicao previdenciaria', 'previdencia social', 'inss patronal', 'cota parte'],
  'contribuicao sindical': ['imposto sindical', 'contribuicao confederativa'],
  'salario': ['remuneracao', 'contraprestacao', 'vencimentos'],
  'demissao': ['dispensa', 'desligamento', 'rescisao contratual'],
  'contrato': ['vinculo', 'pacto laboral', 'relacao contratual'],
  'inadimplemento': ['mora salarial', 'falta de pagamento', 'atraso salarial'],
  'gestante': ['gravidez', 'licenca maternidade', 'estabilidade gestante', 'gravida'],
  'cipeiro': ['cipa', 'estabilidade cipeiro', 'membro da cipa'],
  'dirigente sindical': ['estabilidade sindical', 'garantia sindical', 'representante sindical'],
  'dispensa discriminatoria': ['dispensa arbitraria', 'demissao discriminatoria', 'dispensa ilicita'],
  'acumulo de funcao': ['desvio funcional', 'funcao diversa', 'plus salarial'],
  'sobreaviso': ['plantao', 'prontidao', 'tempo a disposicao'],
  'pejotizacao': ['fraude trabalhista', 'contrato fraudulento', 'simulacao'],
  'grupo economico': ['responsabilidade solidaria', 'conglomerado', 'empresas coligadas'],
  'sucessao trabalhista': ['sucessao de empregadores', 'transferencia de empresa'],
};

// Stemming simplificado para portugu√™s jur√≠dico
const stemJuridico = (word) => {
  if (!word || word.length < 3) return word;
  const w = removeAccents(word.toLowerCase());
  return w
    .replace(/(√ß√£o|√ß√µes|s√£o|s√µes|mento|mentos)$/i, '')
    .replace(/(√≥rio|√≥ria|√≥rios|√≥rias|ivo|iva|ivos|ivas)$/i, '')
    .replace(/(ista|istas|ante|antes|ente|entes)$/i, '')
    .replace(/(ade|ades|dade|dades)$/i, '')
    .replace(/(eiro|eira|eiros|eiras)$/i, '')
    .replace(/(al|ais|el|eis|il|is|ol|ois|ul|uis)$/i, '')
    .replace(/(ar|er|ir|or|ur)$/i, '')
    .replace(/(s|es)$/i, '');
};

// Expande termos com sin√¥nimos jur√≠dicos
const expandWithSynonyms = (words) => {
  const expanded = new Set(words);
  for (const word of words) {
    const wordNorm = removeAccents(word.toLowerCase());
    for (const [termo, sinonimos] of Object.entries(SINONIMOS_JURIDICOS)) {
      const termoNorm = removeAccents(termo.toLowerCase());
      // Se a palavra est√° no termo ou vice-versa
      if (termoNorm.includes(wordNorm) || wordNorm.includes(termoNorm) ||
          termoNorm.split(' ').some(t => t === wordNorm)) {
        expanded.add(termoNorm);
        sinonimos.forEach(s => expanded.add(removeAccents(s.toLowerCase())));
      }
      // Se a palavra est√° em algum sin√¥nimo
      for (const sin of sinonimos) {
        const sinNorm = removeAccents(sin.toLowerCase());
        if (sinNorm.includes(wordNorm) || wordNorm.includes(sinNorm)) {
          expanded.add(termoNorm);
          sinonimos.forEach(s => expanded.add(removeAccents(s.toLowerCase())));
          break;
        }
      }
    }
  }
  return Array.from(expanded);
};

const fuzzyMatch = (term, text, threshold = 0.7) => {
  if (!term || !text) return false;
  const t = removeAccents(term.toLowerCase());
  const s = removeAccents(text.toLowerCase());
  if (s.includes(t)) return true;
  if (t.length < 4) return false;
  const maxDist = Math.floor(t.length * (1 - threshold));
  for (let i = 0; i <= s.length - t.length; i++) {
    let dist = 0;
    for (let j = 0; j < t.length && dist <= maxDist; j++) {
      if (s[i + j] !== t[j]) dist++;
    }
    if (dist <= maxDist) return true;
  }
  return false;
};

const searchModelsInLibrary = (models, term, options = {}) => {
  if (!term || !term.trim()) return [];

  const {
    limit = null,
    includeContent = true,
    useSynonyms = true,
    boostByUsage = true
  } = options;

  const normalizedTerm = removeAccents(term.toLowerCase().trim());

  // Extrair termos entre aspas (busca exata) e termos normais (fuzzy)
  const exactTerms = [];
  const quotedRegex = /"([^"]+)"/g;
  let match;
  while ((match = quotedRegex.exec(normalizedTerm)) !== null) {
    exactTerms.push(match[1].trim());
  }

  // Remover termos entre aspas e processar palavras restantes como fuzzy
  const termWithoutQuotes = normalizedTerm.replace(quotedRegex, '').trim();
  const fuzzyTerms = termWithoutQuotes.split(/\s+/).filter(w => w.length > 2 && !SEARCH_STOPWORDS.has(w));

  if (exactTerms.length === 0 && fuzzyTerms.length === 0) return [];

  // Expandir sin√¥nimos apenas para termos fuzzy
  const expandedFuzzy = new Set(fuzzyTerms);
  if (useSynonyms) {
    fuzzyTerms.forEach(word => {
      Object.entries(SINONIMOS_JURIDICOS).forEach(([key, synonyms]) => {
        if (key.includes(word) || word.includes(key)) {
          synonyms.forEach(s => expandedFuzzy.add(s));
        }
      });
    });
  }

  const scored = models.map(model => {
    const titleNorm = removeAccents((model.title || '').toLowerCase());
    const keywordsNorm = removeAccents((model.keywords || '').toLowerCase());
    const contentNorm = includeContent ? removeAccents((model.content || '').toLowerCase()) : '';

    let score = 0;
    let matchedExact = 0;
    let matchedFuzzy = 0;

    // Verificar termos EXATOS (entre aspas) - busca por palavra inteira
    for (const word of exactTerms) {
      const wordRegex = new RegExp(`\\b${word}\\b`, 'i');
      const inTitle = wordRegex.test(titleNorm);
      const inKeywords = wordRegex.test(keywordsNorm);
      const inContent = wordRegex.test(contentNorm);

      if (inTitle) { score += 15; matchedExact++; }
      if (inKeywords) { score += 8; matchedExact++; }
      if (inContent) { score += 3; matchedExact++; }
    }

    // Verificar termos FUZZY (sem aspas) - busca por substring
    for (const word of expandedFuzzy) {
      const inTitle = titleNorm.includes(word);
      const inKeywords = keywordsNorm.includes(word);
      const inContent = contentNorm.includes(word);

      if (inTitle) score += 10;
      if (inKeywords) score += 5;
      if (inContent) score += 2;
      if (fuzzyTerms.includes(word) && (inTitle || inKeywords || inContent)) matchedFuzzy++;
    }

    // Termos exatos s√£o OBRIGAT√ìRIOS - zerar score se n√£o encontrou todos
    if (exactTerms.length > 0 && matchedExact < exactTerms.length) score = 0;

    // Boost se todos os termos fuzzy originais foram encontrados
    if (matchedFuzzy >= fuzzyTerms.length && fuzzyTerms.length > 0) score += 20;

    // Aplicar boosts APENAS se houve algum match (evita favoritos sem match aparecerem)
    if (score > 0) {
      if (boostByUsage && model.usageCount) score += Math.min(model.usageCount * 0.5, 10);
      if (model.favorite) score += 5;
    }

    return { model, score };
  });

  const results = scored
    .filter(({ score }) => score > 0)
    .sort((a, b) => b.score - a.score)
    .map(({ model }) => model);

  return limit ? results.slice(0, limit) : results;
};

// v1.27.01: Busca sem√¢ntica de modelos (usa embeddings inline)
const searchModelsBySimilarity = async (models, query, options = {}) => {
  const { threshold = 0.4, limit = 20 } = options;

  if (!query || query.length < 3) return [];

  // Filtrar apenas modelos com embedding
  const modelsWithEmbedding = models.filter(m => m.embedding?.length === 768);
  if (modelsWithEmbedding.length === 0) return [];

  // Gerar embedding da query (v1.32.20: toLowerCase para E5 case-sensitive)
  const queryEmbedding = await AIModelService.getEmbedding(query.toLowerCase(), 'query');

  // Calcular similaridade
  const scored = modelsWithEmbedding.map(model => ({
    ...model,
    similarity: AIModelService.cosineSimilarity(queryEmbedding, model.embedding)
  }));

  // Filtrar por threshold e ordenar
  return scored
    .filter(m => m.similarity >= threshold)
    .sort((a, b) => b.similarity - a.similarity)
    .slice(0, limit);
};

// üé£ CUSTOM HOOK: useModelPreview - Preview de modelos de texto
const useModelPreview = () => {
  const [previewingModel, setPreviewingModel] = React.useState(null);
  const [isPreviewOpen, setIsPreviewOpen] = React.useState(false);
  const [isEditing, setIsEditing] = React.useState(false);
  const [editedContent, setEditedContent] = React.useState('');
  // v1.15.2: Fun√ß√£o de inser√ß√£o contextual (para GlobalEditorModal)
  // v1.33.25: Usar ref em vez de state para n√£o causar recria√ß√£o do objeto modelPreview
  const contextualInsertFnRef = React.useRef(null);
  const setContextualInsertFn = React.useCallback((fn) => {
    contextualInsertFnRef.current = fn;
  }, []);
  // v1.15.3: Estado para "Salvar como Novo Modelo"
  const [saveAsNewData, setSaveAsNewData] = React.useState(null);
  // v1.19.2: Callback para notificar quando modelo √© atualizado (sincroniza sugest√µes do GlobalEditor)
  const onModelUpdatedRef = React.useRef(null);

  const openPreview = React.useCallback((model) => {
    if (!model || !model.content) {
      return;
    }

    setPreviewingModel(model);
    setIsPreviewOpen(true);
  }, []);

  const closePreview = React.useCallback(() => {
    setIsPreviewOpen(false);
    setIsEditing(false);
    setEditedContent('');
    // Delay para anima√ß√£o de sa√≠da
    setTimeout(() => setPreviewingModel(null), 200);
  }, []);

  const startEditing = React.useCallback(() => {
    if (previewingModel) {
      setEditedContent(previewingModel.content);
      setIsEditing(true);
    }
  }, [previewingModel]);

  const cancelEditing = React.useCallback(() => {
    setIsEditing(false);
    setEditedContent('');
  }, []);

  // v1.15.3: Fun√ß√µes para "Salvar como Novo Modelo"
  const openSaveAsNew = React.useCallback((content, originalModel) => {
    setSaveAsNewData({
      title: '',
      content: content,
      keywords: originalModel?.keywords || '',
      category: originalModel?.category || 'M√©rito'
    });
  }, []);

  const closeSaveAsNew = React.useCallback(() => {
    setSaveAsNewData(null);
  }, []);

  // Atalho Esc para fechar/cancelar edi√ß√£o
  React.useEffect(() => {
    const handleEscape = (e) => {
      if (e.key === 'Escape' && isPreviewOpen) {
        if (isEditing) {
          // Em modo edi√ß√£o: cancelar edi√ß√£o (volta para visualiza√ß√£o)
          cancelEditing();
        } else {
          // Em modo visualiza√ß√£o: fechar modal
          closePreview();
        }
      }
    };

    window.addEventListener('keydown', handleEscape);
    return () => window.removeEventListener('keydown', handleEscape);
  }, [isPreviewOpen, isEditing, cancelEditing, closePreview]);

  // v1.33.22: useMemo para evitar novo objeto a cada render (causa infinite loop em GlobalEditorModal)
  return React.useMemo(() => ({
    previewingModel,
    isPreviewOpen,
    isEditing,
    editedContent,
    openPreview,
    closePreview,
    startEditing,
    cancelEditing,
    setEditedContent,
    // v1.15.2: Fun√ß√£o de inser√ß√£o contextual
    contextualInsertFnRef,
    setContextualInsertFn,
    // v1.15.3: Salvar como Novo Modelo
    saveAsNewData,
    setSaveAsNewData,
    openSaveAsNew,
    closeSaveAsNew,
    // v1.19.2: Callback para sincronizar sugest√µes do GlobalEditor
    onModelUpdatedRef,
  }), [
    previewingModel, isPreviewOpen, isEditing, editedContent,
    openPreview, closePreview, startEditing, cancelEditing,
    saveAsNewData, openSaveAsNew, closeSaveAsNew
  ]);
};

// üîß UTILITY FUNCTIONS (v1.6.1)

const generateModelId = () => {
  // Tentar usar crypto.randomUUID() (dispon√≠vel em contextos seguros HTTPS)
  if (typeof crypto !== 'undefined' && crypto.randomUUID) {
    return `model:${crypto.randomUUID()}`;
  }

  // Fallback: Date.now() + random string
  // Random string: base36 (0-9, a-z), 9 caracteres
  const randomStr = Math.random().toString(36).substr(2, 9);
  return `model:${Date.now()}_${randomStr}`;
};

// üîç MODEL VALIDATION & SANITIZATION (v1.7)
const validateModel = (model) => {
  const errors = [];

  // Required fields
  if (!model || typeof model !== 'object') {
    return { valid: false, errors: ['Modelo inv√°lido ou ausente'] };
  }

  if (!model.title || typeof model.title !== 'string' || model.title.trim().length === 0) {
    errors.push('T√≠tulo √© obrigat√≥rio');
  }

  if (!model.content || typeof model.content !== 'string' || model.content.trim().length === 0) {
    errors.push('Conte√∫do √© obrigat√≥rio');
  }

  if (model.id && typeof model.id !== 'string') {
    errors.push('ID deve ser uma string');
  }

  // Optional fields type checking (v1.34.9: aceitar null como valor v√°lido)
  if (model.category != null && typeof model.category !== 'string') {
    errors.push('Categoria deve ser uma string');
  }

  if (model.keywords != null && typeof model.keywords !== 'string') {
    errors.push('Keywords devem ser uma string');
  }

  if (model.createdAt !== undefined) {
    const date = new Date(model.createdAt);
    if (isNaN(date.getTime())) {
      errors.push('createdAt deve ser uma data ISO v√°lida');
    }
  }

  if (model.updatedAt !== undefined) {
    const date = new Date(model.updatedAt);
    if (isNaN(date.getTime())) {
      errors.push('updatedAt deve ser uma data ISO v√°lida');
    }
  }

  // Length limits
  if (model.title && model.title.length > 500) {
    errors.push('T√≠tulo muito longo (m√°ximo 500 caracteres)');
  }

  if (model.content && model.content.length > 500000) {
    errors.push('Conte√∫do muito longo (m√°ximo 500.000 caracteres)');
  }

  if (model.keywords && model.keywords.length > 1000) {
    errors.push('Keywords muito longas (m√°ximo 1000 caracteres)');
  }

  return {
    valid: errors.length === 0,
    errors
  };
};

const sanitizeModel = (model) => {
  if (!model || typeof model !== 'object') {
    throw new Error('Modelo inv√°lido para sanitiza√ß√£o');
  }

  // Extract and trim required fields
  const sanitized = {
    title: (model.title || '').trim(),
    content: (model.content || '').trim(),
    category: (model.category || '').trim(),
    keywords: (model.keywords || '').trim()
  };

  // Optional fields - only include if present and valid
  if (model.id && typeof model.id === 'string') {
    sanitized.id = model.id;
  }

  if (model.createdAt) {
    const date = new Date(model.createdAt);
    if (!isNaN(date.getTime())) {
      sanitized.createdAt = date.toISOString();
    }
  }

  if (model.updatedAt) {
    const date = new Date(model.updatedAt);
    if (!isNaN(date.getTime())) {
      sanitized.updatedAt = date.toISOString();
    }
  }

  // Preserve any extra metadata fields that might be useful
  // (future-proof for new fields without breaking)
  const knownFields = ['id', 'title', 'content', 'category', 'keywords', 'createdAt', 'updatedAt'];
  Object.keys(model).forEach(key => {
    if (!knownFields.includes(key) && model[key] !== undefined) {
      sanitized[key] = model[key];
    }
  });

  return sanitized;
};

// üé£ CUSTOM HOOK: useProofManager (v1.2.6) - Sistema de Provas
const useProofManager = (documentServices = null) => {
  // üìä ESTADOS CORE DE DADOS (8 estados)

  // Provas Principais
  const [proofFiles, setProofFiles] = React.useState([]);
  // Array de { id, file, name, type: 'pdf', size, uploadDate }

  const [proofTexts, setProofTexts] = React.useState([]);
  // Array de { id, text, name, uploadDate }

  // Controle de Visualiza√ß√£o de PDFs
  const [proofUsePdfMode, setProofUsePdfMode] = React.useState({});
  // { proofId: true/false } - true = enviar PDF completo, false = usar texto extra√≠do

  // Extra√ß√£o de Texto
  const [extractedProofTexts, setExtractedProofTexts] = React.useState({});
  // { proofId: 'texto extra√≠do via pdf.js' }

  const [proofExtractionFailed, setProofExtractionFailed] = React.useState({});
  // { proofId: true } - marca PDFs que falharam na extra√ß√£o (PDFs de imagens)

  // Vincula√ß√µes e An√°lises
  const [proofTopicLinks, setProofTopicLinks] = React.useState({});
  // { proofId: ['T√≥pico A', 'T√≥pico B'] } - Rela√ß√£o many-to-many

  const [proofAnalysisResults, setProofAnalysisResults] = React.useState({});
  // { proofId: { type: 'contextual' | 'livre', result: 'an√°lise da IA' } }

  const [proofConclusions, setProofConclusions] = React.useState({});
  // { proofId: 'conclus√£o manual do juiz sobre esta prova' }

  // üÜï v1.19.2: Flag para enviar conte√∫do completo da prova √† IA
  const [proofSendFullContent, setProofSendFullContent] = React.useState({});
  // { proofId: true/false } - se true, envia texto completo da prova ao assistente IA

  // üéõÔ∏è ESTADOS DE UI/CONTROLE (7 estados) - ETAPA 6b

  // Controle de An√°lise - v1.15.0: Suporte a m√∫ltiplas an√°lises simult√¢neas
  const [analyzingProofIds, setAnalyzingProofIds] = React.useState(new Set());
  // Set de IDs das provas sendo analisadas (para mostrar loader em cada uma)

  const addAnalyzingProof = React.useCallback((id) => {
    setAnalyzingProofIds(prev => new Set([...prev, id]));
  }, []);

  const removeAnalyzingProof = React.useCallback((id) => {
    setAnalyzingProofIds(prev => {
      const next = new Set(prev);
      next.delete(id);
      return next;
    });
  }, []);

  const isAnalyzingProof = React.useCallback((id) => {
    return analyzingProofIds.has(id);
  }, [analyzingProofIds]);

  const clearAnalyzingProofs = React.useCallback(() => {
    setAnalyzingProofIds(new Set());
  }, []);

  // Controle de UI
  const [showProofPanel, setShowProofPanel] = React.useState(true);
  // Controla visibilidade do painel lateral de provas no editor

  // Formul√°rio de Nova Prova Texto
  const [newProofTextData, setNewProofTextData] = React.useState({ name: '', text: '' });
  // Dados do formul√°rio para adicionar prova em texto

  // Prova Selecionada para A√ß√µes
  const [proofToDelete, setProofToDelete] = React.useState(null);
  // Prova selecionada para deletar (usado no modal de confirma√ß√£o)

  const [proofToLink, setProofToLink] = React.useState(null);
  // Prova selecionada para vincular a t√≥picos

  const [proofToAnalyze, setProofToAnalyze] = React.useState(null);
  // Prova selecionada para an√°lise com IA

  // Configura√ß√µes de An√°lise
  const [proofAnalysisCustomInstructions, setProofAnalysisCustomInstructions] = React.useState('');
  // Instru√ß√µes customizadas para an√°lise da prova atual

  const [useOnlyMiniRelatorios, setUseOnlyMiniRelatorios] = React.useState(false);
  // Toggle: usar apenas mini-relat√≥rios na an√°lise contextual (em vez de documentos completos)

  const [includeLinkedTopicsInFree, setIncludeLinkedTopicsInFree] = React.useState(false);

  // üÜï v1.12.20: Modo de processamento por prova PDF (v1.12.22: removido OCRAD)
  const [proofProcessingModes, setProofProcessingModes] = React.useState({});
  // { proofId: 'pdfjs' | 'pdf-puro' | 'claude-vision' }
  // Define qual m√©todo de extra√ß√£o de texto usar para cada prova PDF

  // üÜï v1.21.3: Texto de prova pendente aguardando confirma√ß√£o de anonimiza√ß√£o
  const [pendingProofText, setPendingProofText] = React.useState(null);
  // { name: string, text: string } - guardado temporariamente at√© confirmar nomes

  // üÜï v1.21.5: Extra√ß√£o de PDF pendente aguardando confirma√ß√£o de nomes
  const [pendingExtraction, setPendingExtraction] = React.useState(null);
  // { proofId: number, proof: object } - guardado temporariamente at√© confirmar nomes

  // üÜï v1.21.6: Mensagem de chat pendente aguardando confirma√ß√£o de nomes
  const [pendingChatMessage, setPendingChatMessage] = React.useState(null);
  // { message: string, options: object, isGlobal: boolean, topicTitle: string }

  // üìä HELPERS COMPUTADOS (ETAPA 6b)
  const totalProofs = proofFiles.length + proofTexts.length;
  const hasProofs = totalProofs > 0;

  // üîß v1.14.1: Helpers utilit√°rios para redu√ß√£o de c√≥digo duplicado
  const removeObjectKey = React.useCallback((setter, keyToRemove) => {
    setter(prev => {
      const { [keyToRemove]: _, ...rest } = prev;
      return rest;
    });
  }, []);
  const removeById = React.useCallback((arr, id) => arr.filter(item => item.id !== id), []);
  const isValidString = React.useCallback((str, minLength = 1) => str && typeof str === 'string' && str.trim().length >= minLength, []);
  const toFilesArray = React.useCallback((value) => Array.isArray(value) ? value : Array.from(value || []), []);

  // üîß HANDLERS SIMPLES (ETAPA 6c)

  // Handler: Upload de provas em PDF
  const handleUploadProofPdf = React.useCallback(async (files) => {
    const filesArray = toFilesArray(files);

    for (const file of filesArray) {
      const id = Date.now() + Math.random(); // ID √∫nico
      const newProof = {
        id,
        file,
        name: file.name,
        type: 'pdf',
        size: file.size,
        uploadDate: new Date().toISOString()
      };

      setProofFiles(prev => [...prev, newProof]);
      setProofUsePdfMode(prev => ({ ...prev, [id]: true })); // Default: usar PDF completo
      setProofProcessingModes(prev => ({ ...prev, [id]: 'pdfjs' })); // üÜï v1.12.20: Default mode

      // Salvar no IndexedDB para persist√™ncia entre reloads
      try {
        await savePdfToIndexedDB(`proof-${id}`, file, 'proof');
      } catch (err) {
        // Silently ignore - PDF won't persist but app continues working
      }
    }
  }, []); // üöÄ v1.8.1: Memoizado (input file)

  // Handler: Adicionar prova em texto
  const handleAddProofText = React.useCallback(() => {
    if (!newProofTextData.name.trim() || !newProofTextData.text.trim()) {
      return; // Valida√ß√£o b√°sica
    }

    const id = Date.now() + Math.random();
    const newProof = {
      id,
      text: newProofTextData.text,
      name: newProofTextData.name,
      uploadDate: new Date().toISOString()
    };

    setProofTexts(prev => [...prev, newProof]);

    // Limpar formul√°rio
    setNewProofTextData({ name: '', text: '' });
  }, [newProofTextData]); // üöÄ v1.8.1: Memoizado (modal texto)

  // Handler: Deletar prova (PDF ou texto)
  const handleDeleteProof = React.useCallback((proof) => {
    // Deletar da lista correta
    if (proof.isPdf || proof.type === 'pdf') {
      setProofFiles(prev => removeById(prev, proof.id));
    } else {
      setProofTexts(prev => removeById(prev, proof.id));
    }
    // Limpar dados relacionados
    removeObjectKey(setProofUsePdfMode, proof.id);
    removeObjectKey(setExtractedProofTexts, proof.id);
    removeObjectKey(setProofExtractionFailed, proof.id);
    removeObjectKey(setProofTopicLinks, proof.id);
    removeObjectKey(setProofAnalysisResults, proof.id);
    removeObjectKey(setProofConclusions, proof.id);
    removeObjectKey(setProofProcessingModes, proof.id);
  }, [removeObjectKey, removeById]); // üöÄ v1.8.1: Memoizado (renderizado em 2 loops - cr√≠tico!)

  const handleToggleProofMode = React.useCallback((proofId, usePdf) => {
    setProofUsePdfMode(prev => ({
      ...prev,
      [proofId]: usePdf
    }));
  }, []); // üöÄ v1.8.1: Memoizado (cada prova PDF)

  const handleLinkProof = React.useCallback((proofId, topicTitles) => {
    setProofTopicLinks(prev => ({
      ...prev,
      [proofId]: topicTitles
    }));
  }, []); // üöÄ v1.8.1: Memoizado (modal vincular)

  const handleUnlinkProof = React.useCallback((proofId, topicTitle) => {
    setProofTopicLinks(prev => {
      const currentLinks = prev[proofId] || [];
      const newLinks = currentLinks.filter(t => t !== topicTitle);

      if (newLinks.length === 0) {
        // Se n√£o sobrou nenhum link, remover a chave
        const { [proofId]: _, ...rest } = prev;
        return rest;
      }

      return {
        ...prev,
        [proofId]: newLinks
      };
    });
  }, []); // üöÄ v1.8.1: Memoizado (badges v√≠nculo)

  const handleSaveProofConclusion = React.useCallback((proofId, conclusion) => {
    if (conclusion && conclusion.trim()) {
      setProofConclusions(prev => ({
        ...prev,
        [proofId]: conclusion
      }));
    } else {
      // Se conclus√£o vazia, remover
      setProofConclusions(prev => {
        const { [proofId]: _, ...rest } = prev;
        return rest;
      });
    }
  }, [setProofConclusions]); // üöÄ v1.8.1: Memoizado (onChange textarea - cr√≠tico!)

  const serializeForPersistence = () => {
    return {
      proofFiles,        // Ser√° processado por useLocalStorage (convers√£o para base64)
      proofTexts,
      proofUsePdfMode,
      extractedProofTexts,
      proofExtractionFailed,
      proofTopicLinks,
      proofAnalysisResults,
      proofConclusions,
      proofProcessingModes,  // üÜï v1.12.20
      proofSendFullContent   // üÜï v1.19.2
    };
  };

  const restoreFromPersistence = (data) => {
    if (!data) return;

    // Restaurar arrays de provas
    if (data.proofFiles) setProofFiles(data.proofFiles);
    if (data.proofTexts) setProofTexts(data.proofTexts);

    // Restaurar objetos de configura√ß√£o
    if (data.proofUsePdfMode) setProofUsePdfMode(data.proofUsePdfMode);
    if (data.extractedProofTexts) setExtractedProofTexts(data.extractedProofTexts);
    if (data.proofExtractionFailed) setProofExtractionFailed(data.proofExtractionFailed);

    // Restaurar vincula√ß√µes e an√°lises
    if (data.proofTopicLinks) setProofTopicLinks(data.proofTopicLinks);
    if (data.proofAnalysisResults) setProofAnalysisResults(data.proofAnalysisResults);
    if (data.proofConclusions) setProofConclusions(data.proofConclusions);

    // üÜï v1.12.20: Restaurar modos de processamento
    if (data.proofProcessingModes) setProofProcessingModes(data.proofProcessingModes);
    // üÜï v1.19.2: Restaurar flag de conte√∫do completo
    if (data.proofSendFullContent) setProofSendFullContent(data.proofSendFullContent);
  };

  const resetAll = () => {
    // Resetar estados core de dados
    setProofFiles([]);
    setProofTexts([]);
    setProofUsePdfMode({});
    setExtractedProofTexts({});
    setProofExtractionFailed({});
    setProofTopicLinks({});
    setProofAnalysisResults({});
    setProofConclusions({});
    setProofProcessingModes({});  // üÜï v1.12.20
    setProofSendFullContent({});  // üÜï v1.19.2

    // Resetar estados de UI/Controle
    clearAnalyzingProofs();
    setShowProofPanel(true);
    setNewProofTextData({ name: '', text: '' });
    setProofToDelete(null);
    setProofToLink(null);
    setProofToAnalyze(null);
    setProofAnalysisCustomInstructions('');
    setUseOnlyMiniRelatorios(false);
  };

  // üéØ RETURN: Estados, Setters, Helpers, Handlers e M√©todos de Persist√™ncia
  return {
    // Estados Core de Dados (10) - +1 v1.12.20 +1 v1.19.2
    proofFiles,
    proofTexts,
    proofUsePdfMode,
    extractedProofTexts,
    proofExtractionFailed,
    proofTopicLinks,
    proofAnalysisResults,
    proofConclusions,
    proofProcessingModes,  // üÜï v1.12.20
    proofSendFullContent,  // üÜï v1.19.2
    pendingProofText,      // üÜï v1.21.3
    pendingExtraction,     // üÜï v1.21.5
    pendingChatMessage,    // üÜï v1.21.6

    // Estados de UI/Controle (7) - ETAPA 6b - v1.15.0: M√∫ltiplas an√°lises
    analyzingProofIds,
    isAnalyzingProof,
    showProofPanel,
    newProofTextData,
    proofToDelete,
    proofToLink,
    proofToAnalyze,
    proofAnalysisCustomInstructions,
    useOnlyMiniRelatorios,
    includeLinkedTopicsInFree,

    // Setters Core (10) - +1 v1.12.20 +1 v1.19.2
    setProofFiles,
    setProofTexts,
    setProofUsePdfMode,
    setExtractedProofTexts,
    setProofExtractionFailed,
    setProofTopicLinks,
    setProofAnalysisResults,
    setProofConclusions,
    setProofProcessingModes,  // üÜï v1.12.20
    setProofSendFullContent,  // üÜï v1.19.2
    setPendingProofText,      // üÜï v1.21.3
    setPendingExtraction,     // üÜï v1.21.5
    setPendingChatMessage,    // üÜï v1.21.6

    // Setters UI/Controle (8) - ETAPA 6b - v1.15.0: M√∫ltiplas an√°lises
    addAnalyzingProof,
    removeAnalyzingProof,
    clearAnalyzingProofs,
    setShowProofPanel,
    setNewProofTextData,
    setProofToDelete,
    setProofToLink,
    setProofToAnalyze,
    setProofAnalysisCustomInstructions,
    setUseOnlyMiniRelatorios,
    setIncludeLinkedTopicsInFree,

    // Helpers (2) - ETAPA 6b
    totalProofs,
    hasProofs,

    // Handlers (7) - ETAPA 6c
    handleUploadProofPdf,
    handleAddProofText,
    handleDeleteProof,
    handleToggleProofMode,
    handleLinkProof,
    handleUnlinkProof,
    handleSaveProofConclusion,

    // M√©todos de Persist√™ncia (3) - ETAPA 6d
    serializeForPersistence,
    restoreFromPersistence,
    resetAll
  };
};

// üé£ CUSTOM HOOK: useDocumentManager (v1.2.7a) - Sistema de An√°lise de Documentos
const useDocumentManager = () => {
  // üì¶ ESTADOS CORE (13 total)

  // Arquivos de Documentos (3)
  const [peticaoFiles, setPeticaoFiles] = React.useState([]);
  // Array de File objects dos PDFs da peti√ß√£o inicial e emendas

  const [contestacaoFiles, setContestacaoFiles] = React.useState([]);
  // Array de File objects dos PDFs de contesta√ß√µes

  const [complementaryFiles, setComplementaryFiles] = React.useState([]);
  // Array de File objects dos PDFs de documentos complementares

  // Textos Colados (Alternativa aos PDFs) (3)
  const [pastedPeticaoTexts, setPastedPeticaoTexts] = React.useState([]);
  // Array de {text: string, name: string} - peti√ß√£o e emendas coladas

  const [pastedContestacaoTexts, setPastedContestacaoTexts] = React.useState([]);
  // Array de {text: string, name: string} - contesta√ß√µes coladas

  const [pastedComplementaryTexts, setPastedComplementaryTexts] = React.useState([]);
  // Array de {text: string, name: string} - documentos complementares colados

  // Metadados de Documentos Processados (1)
  const [analyzedDocuments, setAnalyzedDocuments] = React.useState({
    peticoes: [],            // Array de base64 (PDFs n√£o extra√≠dos)
    peticoesText: [],        // Array de {text, name} (textos extra√≠dos/colados)
    contestacoes: [],        // Array de base64 (PDFs n√£o extra√≠dos)
    contestacoesText: [],    // Array de {text, name} (textos extra√≠dos/colados)
    complementares: [],      // Array de base64 (PDFs n√£o extra√≠dos)
    complementaresText: []   // Array de {text, name} (textos extra√≠dos/colados)
  });
  // Objeto contendo documentos processados ap√≥s an√°lise

  // Estados de UI e Progresso (6)
  const [analyzing, setAnalyzing] = React.useState(false);
  // Flag indicando se an√°lise est√° em andamento

  const [analysisProgress, setAnalysisProgress] = React.useState('');
  // Mensagem de progresso exibida durante an√°lise (ex: "Extraindo texto da peti√ß√£o...")

  const [extractingText, setExtractingText] = React.useState(false);
  // Flag indicando se extra√ß√£o de texto de PDF est√° em andamento

  const [showPasteArea, setShowPasteArea] = React.useState({
    peticao: false,
    contestacao: false,
    complementary: false
  });
  // Controla visibilidade das √°reas de colagem de texto para cada tipo de documento

  const [extractedTexts, setExtractedTexts] = React.useState({
    peticoes: [],
    contestacoes: [],
    complementares: []
  });
  // Cache de textos extra√≠dos de PDFs (para n√£o reprocessar)

  // üÜï v1.12.18: Modo de processamento por documento (v1.12.22: removido OCRAD)
  // Cada documento pode ter seu pr√≥prio modo: 'pdf-puro' | 'pdfjs' | 'claude-vision'
  const [documentProcessingModes, setDocumentProcessingModes] = React.useState({
    peticoes: [],               // Array de modos, um por arquivo de peti√ß√£o
    contestacoes: [],           // Array de modos, um por arquivo
    complementares: []          // Array de modos, um por arquivo
  });

  const [showTextPreview, setShowTextPreview] = React.useState(false);
  // Controla exibi√ß√£o de modal de preview de texto extra√≠do

  // üÜï v1.12.18: Helpers para definir modo de processamento por √≠ndice
  const setPeticaoMode = React.useCallback((index, mode) => {
    setDocumentProcessingModes(prev => {
      const newPeticoes = [...(prev.peticoes || [])];
      newPeticoes[index] = mode;
      return { ...prev, peticoes: newPeticoes };
    });
  }, []);

  const setContestacaoMode = React.useCallback((index, mode) => {
    setDocumentProcessingModes(prev => {
      const newContestacoes = [...prev.contestacoes];
      newContestacoes[index] = mode;
      return { ...prev, contestacoes: newContestacoes };
    });
  }, []);

  const setComplementarMode = React.useCallback((index, mode) => {
    setDocumentProcessingModes(prev => {
      const newComplementares = [...prev.complementares];
      newComplementares[index] = mode;
      return { ...prev, complementares: newComplementares };
    });
  }, []);

  // üõ†Ô∏è HANDLERS SIMPLES (5) - ETAPA 7b

  // Helper para garantir array (usado por handleUploadContestacao e handleUploadComplementary)
  const toUploadFilesArray = (value) => Array.isArray(value) ? value : Array.from(value || []);

  // Handler: Processa texto colado (peti√ß√£o, contesta√ß√£o ou complementar)
  const handlePastedText = React.useCallback((text, type, setError = null) => {
    if (!text.trim()) {
      if (setError) setError('O texto colado est√° vazio');
      return;
    }

    if (type === 'peticao') {
      setPastedPeticaoTexts(prev => [...prev, {
        text,
        name: prev.length === 0 ? 'Peti√ß√£o Inicial' : `Emenda/Doc Autor ${prev.length + 1}`
      }]);
      setShowPasteArea(prev => ({ ...prev, peticao: false }));
    } else if (type === 'contestacao') {
      setPastedContestacaoTexts(prev => [...prev, {
        text,
        name: `Contesta√ß√£o ${prev.length + 1}`
      }]);
      setShowPasteArea(prev => ({ ...prev, contestacao: false }));
    } else if (type === 'complementary') {
      setPastedComplementaryTexts(prev => [...prev, {
        text,
        name: `Documento Complementar ${prev.length + 1}`
      }]);
      setShowPasteArea(prev => ({ ...prev, complementary: false }));
    }

    if (setError) setError('');
  }, []); // üöÄ v1.8.1: Memoizado (3 textareas)

  // Handler: Remove texto colado
  const removePastedText = (type, index = null) => {
    if (type === 'peticao' && index !== null) {
      setPastedPeticaoTexts(prev => prev.filter((_, i) => i !== index));
    } else if (type === 'contestacao' && index !== null) {
      setPastedContestacaoTexts(prev => prev.filter((_, i) => i !== index));
    } else if (type === 'complementary' && index !== null) {
      setPastedComplementaryTexts(prev => prev.filter((_, i) => i !== index));
    }
  };

  // Handler: Remove arquivo de peti√ß√£o por √≠ndice (com limpeza IndexedDB)
  const removePeticaoFile = React.useCallback(async (index) => {
    const fileToRemove = peticaoFiles[index];
    if (fileToRemove?.id) {
      try {
        await removePdfFromIndexedDB(`upload-peticao-${fileToRemove.id}`);
      } catch (err) { /* ignore */ }
    }
    setPeticaoFiles(prev => prev.filter((_, i) => i !== index));
    setDocumentProcessingModes(prev => ({
      ...prev,
      peticoes: (prev.peticoes || []).filter((_, i) => i !== index)
    }));
  }, [peticaoFiles]);

  const handleUploadPeticao = React.useCallback(async (files) => {
    const filesArray = toUploadFilesArray(files);
    const pdfFiles = filesArray.filter(f => f.type === 'application/pdf');
    if (pdfFiles.length === 0) return;

    const filesWithIds = pdfFiles.map(file => ({
      file,
      id: crypto.randomUUID()
    }));

    setPeticaoFiles(prev => [...prev, ...filesWithIds]);

    for (const { file, id } of filesWithIds) {
      try {
        await savePdfToIndexedDB(`upload-peticao-${id}`, file, 'upload');
      } catch (err) { /* ignore */ }
    }
  }, []);

  const handleUploadContestacao = React.useCallback(async (files) => {
    const filesArray = toUploadFilesArray(files);
    const pdfFiles = filesArray.filter(f => f.type === 'application/pdf');
    if (pdfFiles.length === 0) return;

    const filesWithIds = pdfFiles.map(file => ({
      file,
      id: crypto.randomUUID()
    }));

    setContestacaoFiles(prev => [...prev, ...filesWithIds]);

    for (const { file, id } of filesWithIds) {
      try {
        await savePdfToIndexedDB(`upload-contestacao-${id}`, file, 'upload');
      } catch (err) { /* ignore */ }
    }
  }, []);

  // Handler: Upload de complementares
  const handleUploadComplementary = React.useCallback(async (files) => {
    const filesArray = toUploadFilesArray(files);
    const pdfFiles = filesArray.filter(f => f.type === 'application/pdf');
    if (pdfFiles.length === 0) return;

    const filesWithIds = pdfFiles.map(file => ({
      file,
      id: crypto.randomUUID()
    }));

    setComplementaryFiles(prev => [...prev, ...filesWithIds]);

    for (const { file, id } of filesWithIds) {
      try {
        await savePdfToIndexedDB(`upload-complementar-${id}`, file, 'upload');
      } catch (err) { /* ignore */ }
    }
  }, []);

  // üíæ M√âTODOS DE PERSIST√äNCIA (3) - ETAPA 7c

  // Serializa dados para persist√™ncia
  const serializeForPersistence = () => {
    return {
      // Arquivos (ser√£o convertidos para base64 pelo useLocalStorage)
      peticaoFiles,
      contestacaoFiles,
      complementaryFiles,

      // Textos colados
      pastedPeticaoTexts,
      pastedContestacaoTexts,
      pastedComplementaryTexts,

      // Metadados processados
      analyzedDocuments,

      // Estados de UI (n√£o precisa salvar analyzing/extractingText - tempor√°rios)
      showPasteArea,
      extractedTexts,

      // v1.12.18: Modos de processamento por documento
      documentProcessingModes

      // showTextPreview n√£o precisa persistir (modal tempor√°rio)
    };
  };

  // Restaura dados do localStorage
  const restoreFromPersistence = (data) => {
    if (!data) return;

    // Restaurar arquivos (File objects reconstru√≠dos pelo useLocalStorage)
    if (data.peticaoFiles) setPeticaoFiles(data.peticaoFiles);
    if (data.contestacaoFiles) setContestacaoFiles(data.contestacaoFiles);
    if (data.complementaryFiles) setComplementaryFiles(data.complementaryFiles);

    // Restaurar textos colados
    if (data.pastedPeticaoTexts) setPastedPeticaoTexts(data.pastedPeticaoTexts);
    if (data.pastedContestacaoTexts) setPastedContestacaoTexts(data.pastedContestacaoTexts);
    if (data.pastedComplementaryTexts) setPastedComplementaryTexts(data.pastedComplementaryTexts);

    // Restaurar metadados
    if (data.analyzedDocuments) setAnalyzedDocuments(data.analyzedDocuments);

    // Restaurar estados de UI
    if (data.showPasteArea) setShowPasteArea(data.showPasteArea);
    if (data.extractedTexts) setExtractedTexts(data.extractedTexts);

    // v1.12.18: Restaurar modos de processamento
    if (data.documentProcessingModes) setDocumentProcessingModes(data.documentProcessingModes);
  };

  // Limpa TODOS os estados de documentos
  const clearAll = async () => {
    // Limpar IndexedDB por ID antes de limpar estados
    for (const fileObj of peticaoFiles) {
      if (fileObj?.id) try { await removePdfFromIndexedDB(`upload-peticao-${fileObj.id}`); } catch {}
    }
    for (const fileObj of contestacaoFiles) {
      if (fileObj?.id) try { await removePdfFromIndexedDB(`upload-contestacao-${fileObj.id}`); } catch {}
    }
    for (const fileObj of complementaryFiles) {
      if (fileObj?.id) try { await removePdfFromIndexedDB(`upload-complementar-${fileObj.id}`); } catch {}
    }
    clearPdfCache();

    // Limpar arquivos
    setPeticaoFiles([]);
    setContestacaoFiles([]);
    setComplementaryFiles([]);

    // Limpar textos colados
    setPastedPeticaoTexts([]);
    setPastedContestacaoTexts([]);
    setPastedComplementaryTexts([]);

    // Limpar metadados
    setAnalyzedDocuments({
      peticoes: [],
      peticoesText: [],
      contestacoes: [],
      contestacoesText: [],
      complementares: [],
      complementaresText: []
    });

    // Limpar estados de UI/Progresso
    setAnalyzing(false);
    setAnalysisProgress('');
    setExtractingText(false);
    setShowPasteArea({
      peticao: false,
      contestacao: false,
      complementary: false
    });
    setExtractedTexts({
      peticoes: [],
      contestacoes: [],
      complementares: []
    });
    setShowTextPreview(false);

    // v1.12.18: Resetar modos de processamento
    setDocumentProcessingModes({
      peticoes: [],
      contestacoes: [],
      complementares: []
    });
  };

  // üéØ RETURN: Estados, Setters, Handlers e Persist√™ncia
  return {
    // Arquivos (3)
    peticaoFiles,
    contestacaoFiles,
    complementaryFiles,

    // Textos Colados (3)
    pastedPeticaoTexts,
    pastedContestacaoTexts,
    pastedComplementaryTexts,

    // Metadados (1)
    analyzedDocuments,

    // UI/Progresso (6)
    analyzing,
    analysisProgress,
    extractingText,
    showPasteArea,
    extractedTexts,
    showTextPreview,

    // v1.12.18: Modos de processamento por documento
    documentProcessingModes,

    // Setters Arquivos (3)
    setPeticaoFiles,
    setContestacaoFiles,
    setComplementaryFiles,

    // Setters Textos Colados (3)
    setPastedPeticaoTexts,
    setPastedContestacaoTexts,
    setPastedComplementaryTexts,

    // Setters Metadados (1)
    setAnalyzedDocuments,

    // Setters UI/Progresso (6)
    setAnalyzing,
    setAnalysisProgress,
    setExtractingText,
    setShowPasteArea,
    setExtractedTexts,
    setShowTextPreview,

    // v1.12.18: Setters de modos de processamento
    setDocumentProcessingModes,
    setPeticaoMode,
    setContestacaoMode,
    setComplementarMode,

    // Handlers (5) - ETAPA 7b
    handlePastedText,
    removePastedText,
    removePeticaoFile,
    handleUploadPeticao,
    handleUploadContestacao,
    handleUploadComplementary,

    // M√©todos de Persist√™ncia (3) - ETAPA 7c
    serializeForPersistence,
    restoreFromPersistence,
    clearAll
  };
};

// üéØ HOOK: useTopicManager (v1.2.7d) - Gerenciador de t√≥picos de decis√£o
const useTopicManager = () => {

  // üìä ESTADOS (12) - ETAPA 7d

  // T√≥picos Principais (2)
  const [extractedTopics, setExtractedTopics] = React.useState([]);
  const [selectedTopics, setSelectedTopics] = React.useState([]);

  // Estado de Edi√ß√£o (3)
  const [editingTopic, setEditingTopic] = React.useState(null);
  const [lastEditedTopicTitle, setLastEditedTopicTitle] = React.useState(null);
  const [topicContextScope, setTopicContextScope] = React.useState('current');

  // Estados de UI/Progresso (1)
  const [savingTopic, setSavingTopic] = React.useState(false);

  // Estados de Manipula√ß√£o de T√≥picos (7)
  // Dele√ß√£o
  const [topicToDelete, setTopicToDelete] = React.useState(null);

  // Renomea√ß√£o
  const [topicToRename, setTopicToRename] = React.useState(null);
  const [newTopicName, setNewTopicName] = React.useState('');

  // Merge (mesclagem)
  const [topicsToMerge, setTopicsToMerge] = React.useState([]);

  // Split (divis√£o)
  const [topicToSplit, setTopicToSplit] = React.useState(null);
  const [splitNames, setSplitNames] = React.useState(['', '']);

  // Novo t√≥pico
  const [newTopicData, setNewTopicData] = React.useState(null);

  // üõ†Ô∏è HANDLERS DE UI E PREPARA√á√ÉO (5) - ETAPA 7e

  const prepareDeleteTopic = (topic) => {
    setTopicToDelete(topic);
  };

  const prepareRenameTopic = (topic) => {
    setTopicToRename(topic);
    setNewTopicName(topic.title);
  };

  const prepareMergeTopics = (topics) => {
    setTopicsToMerge(topics);
  };

  const prepareSplitTopic = (topic) => {
    setTopicToSplit(topic);
    setSplitNames(['', '']);
  };

  const prepareNewTopic = (category = 'M√âRITO') => {
    setNewTopicData({
      title: '',
      category: category,
      relatorio: '',
      fundamentacao: ''
    });
  };

  // ‚úÖ HANDLERS DE CONFIRMA√á√ÉO E OPERA√á√ïES (3) - ETAPA 7e

  const confirmDeleteTopic = () => {
    if (!topicToDelete) return;

    setSelectedTopics(prev =>
      prev.filter(t => t.title !== topicToDelete.title)
    );
    setTopicToDelete(null);
  };

  const cancelOperation = () => {
    setTopicToDelete(null);
    setTopicToRename(null);
    setNewTopicName('');
    setTopicsToMerge([]);
    setTopicToSplit(null);
    setSplitNames(['', '']);
    setNewTopicData(null);
  };

  const updateSelectedTopics = (topics) => {
    setSelectedTopics(topics);
  };

  // üíæ M√âTODOS DE PERSIST√äNCIA (3) - ETAPA 7e

  const serializeForPersistence = () => {
    return {
      extractedTopics,
      selectedTopics,
      editingTopic,
      lastEditedTopicTitle
    };
  };

  const restoreFromPersistence = (data) => {
    if (!data) return;

    if (data.extractedTopics) setExtractedTopics(data.extractedTopics);
    if (data.selectedTopics) setSelectedTopics(data.selectedTopics);
    if (data.editingTopic) setEditingTopic(data.editingTopic);
    if (data.lastEditedTopicTitle) setLastEditedTopicTitle(data.lastEditedTopicTitle);
  };

  const clearAll = () => {
    setExtractedTopics([]);
    setSelectedTopics([]);
    setEditingTopic(null);
    setLastEditedTopicTitle(null);
    setSavingTopic(false);
    setTopicToDelete(null);
    setTopicToRename(null);
    setNewTopicName('');
    setTopicsToMerge([]);
    setTopicToSplit(null);
    setSplitNames(['', '']);
    setNewTopicData(null);
  };

  // üéÅ RETORNO DO HOOK
  return {
    // Estados T√≥picos (2)
    extractedTopics,
    selectedTopics,

    // Estados Edi√ß√£o (3)
    editingTopic,
    lastEditedTopicTitle,
    topicContextScope,

    // Estados UI (1)
    savingTopic,

    // Estados Manipula√ß√£o (7)
    topicToDelete,
    topicToRename,
    newTopicName,
    topicsToMerge,
    topicToSplit,
    splitNames,
    newTopicData,

    // Setters T√≥picos (2)
    setExtractedTopics,
    setSelectedTopics,

    // Setters Edi√ß√£o (3)
    setEditingTopic,
    setLastEditedTopicTitle,
    setTopicContextScope,

    // Setters UI (1)
    setSavingTopic,

    // Setters Manipula√ß√£o (7)
    setTopicToDelete,
    setTopicToRename,
    setNewTopicName,
    setTopicsToMerge,
    setTopicToSplit,
    setSplitNames,
    setNewTopicData,

    // Handlers de UI/Prepara√ß√£o (5) - ETAPA 7e
    prepareDeleteTopic,
    prepareRenameTopic,
    prepareMergeTopics,
    prepareSplitTopic,
    prepareNewTopic,

    // Handlers de Confirma√ß√£o (3) - ETAPA 7e
    confirmDeleteTopic,
    cancelOperation,
    updateSelectedTopics,

    // M√©todos de Persist√™ncia (3) - ETAPA 7e
    serializeForPersistence,
    restoreFromPersistence,
    clearAll
  };
};

// üí¨ HOOK: useChatAssistant (v1.19.0) - Gerenciador de chat interativo para assistente IA
const useChatAssistant = (aiIntegration) => {
  const [history, setHistory] = React.useState([]);
  const [generating, setGenerating] = React.useState(false);

  // Limpa hist√≥rico
  const clear = React.useCallback(() => setHistory([]), []);

  // √öltima resposta da IA
  const lastResponse = React.useMemo(() =>
    [...history].reverse().find(m => m.role === 'assistant')?.content || null
  , [history]);

  // Envia mensagem e atualiza hist√≥rico
  // üÜï v1.19.5: Suporta contextBuilder ass√≠ncrono
  const send = React.useCallback(async (message, contextBuilder) => {
    if (!message?.trim()) return { success: false, error: 'Mensagem vazia' };
    if (!aiIntegration?.callAI) return { success: false, error: 'IA n√£o dispon√≠vel' };

    setGenerating(true);

    try {
      const apiMessages = [];
      // üÜï v1.19.5: Calcular contexto antes (suporta async)
      let contextContent = null;

      if (history.length === 0) {
        // Primeira intera√ß√£o: contexto completo + mensagem
        contextContent = await Promise.resolve(contextBuilder(message));
        apiMessages.push({
          role: 'user',
          content: contextContent
        });
      } else {
        // Intera√ß√µes seguintes: reconstr√≥i hist√≥rico completo
        // Primeira mensagem com contexto (para cache hit)
        apiMessages.push({
          role: 'user',
          content: history[0].contentForApi
        });

        // Resto do hist√≥rico
        for (let i = 1; i < history.length; i++) {
          apiMessages.push({
            role: history[i].role,
            content: history[i].content
          });
        }

        // Nova mensagem
        apiMessages.push({
          role: 'user',
          content: message
        });
      }

      // v1.21.26: Parametros para assistente interativo (criativo moderado)
      // v1.32.26: maxTokens aumentado para 16000 (respostas longas no chat)
      const response = await aiIntegration.callAI(apiMessages, {
        maxTokens: 16000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.5,
        topP: 0.9,
        topK: 80
      });

      const trimmedResponse = response.trim();

      // Atualiza hist√≥rico (com limite)
      setHistory(prev => {
        let newHistory;
        if (prev.length === 0) {
          // Primeira intera√ß√£o: salvar content completo para cache
          newHistory = [
            { role: 'user', content: message, contentForApi: contextContent, ts: Date.now() },
            { role: 'assistant', content: trimmedResponse, ts: Date.now() }
          ];
        } else {
          // Intera√ß√µes seguintes
          newHistory = [
            ...prev,
            { role: 'user', content: message, ts: Date.now() },
            { role: 'assistant', content: trimmedResponse, ts: Date.now() }
          ];
        }

        // Aplicar limite de mensagens (manter primeira msg com contexto + √∫ltimas N)
        if (newHistory.length > MAX_CHAT_HISTORY_MESSAGES) {
          const firstMsg = newHistory[0]; // Manter contexto
          const recentMsgs = newHistory.slice(-(MAX_CHAT_HISTORY_MESSAGES - 1));
          return [firstMsg, ...recentMsgs];
        }

        return newHistory;
      });

      return { success: true };

    } catch (err) {
      // Adiciona mensagem de erro ao hist√≥rico
      setHistory(prev => [
        ...prev,
        { role: 'user', content: message, ts: Date.now(), error: err.message }
      ]);
      return { success: false, error: err.message };
    } finally {
      setGenerating(false);
    }
  }, [history, aiIntegration]);

  return { history, generating, send, clear, lastResponse };
};

const useJurisprudencia = () => {
  const [precedentes, setPrecedentes] = React.useState([]);
  const [searchTerm, setSearchTerm] = React.useState('');
  const [filtros, setFiltros] = React.useState({ fonte: [], tipo: [] });
  const [currentPage, setCurrentPage] = React.useState(1);
  const [isLoading, setIsLoading] = React.useState(false);
  const [deleteAllConfirmText, setDeleteAllConfirmText] = React.useState('');
  const itemsPerPage = 10;
  const searchTimeoutRef = React.useRef(null);

  const removeAccents = React.useCallback((str) =>
    str.normalize('NFD').replace(/[\u0300-\u036f]/g, ''), []);

  const searchPrecedentes = React.useCallback((term) => {
    if (!term?.trim()) return precedentes;
    const normalizedTerm = removeAccents(term.toLowerCase());
    const terms = normalizedTerm.split(/\s+/).filter(t => t.length > 2);
    return precedentes
      .map(p => {
        const teseNorm = removeAccents((p.tese || p.enunciado || '').toLowerCase());
        const keywordsNorm = removeAccents(Array.isArray(p.keywords) ? p.keywords.join(' ').toLowerCase() : (p.keywords || '').toLowerCase());
        const numeroNorm = (p.numeroProcesso || String(p.numero || '') || '').toLowerCase();
        let score = 0;
        for (const t of terms) {
          if (keywordsNorm.includes(t)) score += 10;
          if (teseNorm.includes(t)) score += 5;
          if (numeroNorm.includes(t)) score += 15;
        }
        return { precedente: p, score };
      })
      .filter(({ score }) => score > 0)
      .sort((a, b) => b.score - a.score)
      .map(({ precedente }) => precedente);
  }, [precedentes, removeAccents]);

  const filteredPrecedentes = React.useMemo(() => {
    let result = searchTerm ? searchPrecedentes(searchTerm) : precedentes;
    if (filtros.fonte.length > 0) {
      result = result.filter(p => filtros.fonte.includes(p.category));
    }
    if (filtros.tipo.length > 0) {
      result = result.filter(p => {
        if (filtros.tipo.includes('IRR') && isIRRType(p.tipoProcesso)) return true;
        return filtros.tipo.includes(p.tipoProcesso);
      });
    }
    if (filtros.tribunal?.length > 0) {
      result = result.filter(p => filtros.tribunal.includes(p.tribunal));
    }
    return result;
  }, [precedentes, searchTerm, filtros, searchPrecedentes]);

  const paginatedPrecedentes = React.useMemo(() => {
    const start = (currentPage - 1) * itemsPerPage;
    return filteredPrecedentes.slice(start, start + itemsPerPage);
  }, [filteredPrecedentes, currentPage]);

  const totalPages = Math.ceil(filteredPrecedentes.length / itemsPerPage);

  const handleSearchChange = React.useCallback((e) => {
    const term = e.target.value;
    setSearchTerm(term);
    setCurrentPage(1);
  }, []);

  const handleImportJSON = React.useCallback(async (file) => {
    setIsLoading(true);
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      const items = Array.isArray(data) ? data : (data.precedentes || []);
      setPrecedentes(prev => {
        const existingMap = new Map(prev.map(p => [p.id, p]));
        for (const item of items) {
          existingMap.set(item.id, item);
        }
        return Array.from(existingMap.values());
      });
      await savePrecedentesToIndexedDB(items);
      return { success: true, count: items.length };
    } catch (err) {
      return { success: false, error: 'JSON inv√°lido' };
    } finally {
      setIsLoading(false);
    }
  }, []);

  const handleCopyTese = React.useCallback(async (precedente) => {
    const tipo = precedente.tipoProcesso || '';
    const identificador = precedente.tema ? `Tema ${precedente.tema}` : (precedente.numero ? `n¬∫ ${precedente.numero}` : '');
    const titulo = precedente.titulo ? `\n${precedente.titulo}` : '';
    const conteudo = precedente.tese || precedente.enunciado || '';
    const texto = `${tipo}${identificador ? ` - ${identificador}` : ''}${titulo}\n${conteudo}`;
    await navigator.clipboard.writeText(texto);
  }, []);

  const handleClearAll = React.useCallback(async () => {
    setPrecedentes([]);
    await clearPrecedentesFromIndexedDB();
  }, []);

  // v1.33.61: Recarregar precedentes do IndexedDB (usado ap√≥s download autom√°tico)
  const reloadPrecedentes = React.useCallback(async () => {
    const data = await loadPrecedentesFromIndexedDB();
    setPrecedentes(data);
    return data.length;
  }, []);

  React.useEffect(() => {
    loadPrecedentesFromIndexedDB().then(setPrecedentes);
  }, []);

  React.useEffect(() => {
    return () => {
      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);
    };
  }, []);

  return {
    precedentes,
    searchTerm,
    filtros,
    currentPage,
    totalPages,
    isLoading,
    paginatedPrecedentes,
    filteredCount: filteredPrecedentes.length,
    deleteAllConfirmText,
    setDeleteAllConfirmText,
    setFiltros,
    setCurrentPage,
    handleSearchChange,
    handleImportJSON,
    handleCopyTese,
    handleClearAll,
    reloadPrecedentes // v1.33.61: Para atualizar ap√≥s download autom√°tico
  };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìú HOOK: useLegislacao - Gest√£o de artigos de leis
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const useLegislacao = () => {
  const [artigos, setArtigos] = React.useState([]);
  const [leisDisponiveis, setLeisDisponiveis] = React.useState([]);
  const [leiAtiva, setLeiAtiva] = React.useState(null);
  const [searchTerm, setSearchTerm] = React.useState('');
  const [currentPage, setCurrentPage] = React.useState(1);
  const [isLoading, setIsLoading] = React.useState(false);
  const [deleteConfirmText, setDeleteConfirmText] = React.useState('');
  const [copiedId, setCopiedId] = React.useState(null);

  const ITEMS_PER_PAGE = 15;

  const removeAccents = React.useCallback((str) => {
    return str?.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase() || '';
  }, []);

  const searchArtigos = React.useCallback((term, lista) => {
    if (!term?.trim()) return lista;
    const termNorm = removeAccents(term.trim());
    const terms = termNorm.split(/\s+/).filter(t => t.length > 1);
    const numeroMatch = term.match(/\d+[¬∫¬∞]?(?:-[a-z])?/i);

    return lista.map(artigo => {
      let score = 0;
      const caputNorm = removeAccents(artigo.caput || '');
      const numeroNorm = removeAccents(artigo.numero || '');
      const keywordsNorm = (artigo.keywords || []).map(k => removeAccents(k));
      // v1.21.1: Buscar tamb√©m em par√°grafos, incisos e al√≠neas
      const paragrafosText = (artigo.paragrafos || []).map(p => p.texto || '').join(' ');
      const incisosText = (artigo.incisos || []).map(i => i.texto || '').join(' ');
      const alineasText = (artigo.alineas || []).map(a => a.texto || '').join(' ');
      const subTextoNorm = removeAccents(paragrafosText + ' ' + incisosText + ' ' + alineasText);

      if (numeroMatch && numeroNorm.includes(removeAccents(numeroMatch[0]))) {
        score += 50;
      }

      for (const t of terms) {
        if (keywordsNorm.some(k => k.includes(t))) score += 15;
        if (caputNorm.includes(t)) score += 10;
        if (subTextoNorm.includes(t)) score += 8; // par√°grafos, incisos, al√≠neas
        if (numeroNorm === t) score += 30;
      }

      return { artigo, score };
    })
    .filter(({ score }) => score > 0)
    .sort((a, b) => b.score - a.score)
    .map(({ artigo }) => artigo);
  }, [removeAccents]);

  const filteredArtigos = React.useMemo(() => {
    let result = artigos;
    if (leiAtiva) {
      result = result.filter(a => a.lei === leiAtiva || a.id?.startsWith(leiAtiva + '-'));
    }
    if (searchTerm?.trim()) {
      result = searchArtigos(searchTerm, result);
    }
    return result;
  }, [artigos, leiAtiva, searchTerm, searchArtigos]);

  const totalPages = Math.ceil(filteredArtigos.length / ITEMS_PER_PAGE);

  const paginatedArtigos = React.useMemo(() => {
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    return filteredArtigos.slice(start, start + ITEMS_PER_PAGE);
  }, [filteredArtigos, currentPage]);

  const handleImportJSON = React.useCallback(async (file) => {
    setIsLoading(true);
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      const items = Array.isArray(data) ? data : (data.artigos || []);

      if (items.length === 0) {
        throw new Error('Arquivo n√£o cont√©m artigos v√°lidos');
      }

      await saveArtigosToIndexedDB(items);
      const allArtigos = await loadArtigosFromIndexedDB();
      setArtigos(sortArtigosNatural(allArtigos));

      const leis = [...new Set(allArtigos.map(a => a.lei || a.id?.split('-art-')[0] || a.id?.split('-')[0]))].filter(Boolean);
      setLeisDisponiveis(leis.sort());
      setCurrentPage(1);

      return { success: true, count: items.length };
    } catch (err) {
      console.error('Erro ao importar JSON:', err);
      return { success: false, error: err.message };
    } finally {
      setIsLoading(false);
    }
  }, []);

  const handleCopyArtigo = React.useCallback(async (artigo) => {
    try {
      const lei = getLeiFromId(artigo.id);
      let texto = `Art. ${artigo.numero} - ${lei.nome}\n${artigo.caput}`;

      if (artigo.paragrafos?.length > 0) {
        texto += '\n';
        for (const p of artigo.paragrafos) {
          texto += `\n¬ß ${p.numero}¬∫ ${p.texto}`;
        }
      }

      if (artigo.incisos?.length > 0) {
        texto += '\n';
        for (const inc of artigo.incisos) {
          texto += `\n${inc.numero} - ${inc.texto}`;
        }
      }

      await navigator.clipboard.writeText(texto);
      setCopiedId(artigo.id);
      setTimeout(() => setCopiedId(null), 2000);
      return true;
    } catch (err) {
      console.error('Erro ao copiar:', err);
      return false;
    }
  }, []);

  const handleClearAll = React.useCallback(async () => {
    setArtigos([]);
    setLeisDisponiveis([]);
    setDeleteConfirmText('');
    await clearArtigosFromIndexedDB();
  }, []);

  // v1.33.61: Recarregar artigos do IndexedDB (usado ap√≥s download autom√°tico)
  const reloadArtigos = React.useCallback(async () => {
    const data = await loadArtigosFromIndexedDB();
    setArtigos(sortArtigosNatural(data));
    const leis = [...new Set(data.map(a => a.lei || a.id?.split('-art-')[0] || a.id?.split('-')[0]))].filter(Boolean);
    setLeisDisponiveis(leis.sort());
    return data.length;
  }, []);

  React.useEffect(() => {
    loadArtigosFromIndexedDB().then(data => {
      setArtigos(sortArtigosNatural(data));
      const leis = [...new Set(data.map(a => a.lei || a.id?.split('-art-')[0] || a.id?.split('-')[0]))].filter(Boolean);
      setLeisDisponiveis(leis.sort());
    });
  }, []);

  React.useEffect(() => {
    setCurrentPage(1);
  }, [searchTerm, leiAtiva]);

  return {
    artigos,
    leisDisponiveis,
    leiAtiva,
    setLeiAtiva,
    searchTerm,
    setSearchTerm,
    currentPage,
    setCurrentPage,
    totalPages,
    isLoading,
    filteredArtigos,
    paginatedArtigos,
    filteredCount: filteredArtigos.length,
    deleteConfirmText,
    setDeleteConfirmText,
    copiedId,
    handleImportJSON,
    handleCopyArtigo,
    handleClearAll,
    reloadArtigos // v1.33.61: Para atualizar ap√≥s download autom√°tico
  };
};

// üí° COMPONENTE: SpacingDropdown - Controle de espa√ßamento de par√°grafos
const SpacingDropdown = React.memo(({
  value,
  onChange,
  ariaLabel = 'Espa√ßamento de par√°grafo'
}) => {
  // Classes de Tema (v1.9.39: Suporte a tema claro/escuro)
  const themeClasses = {
    select: 'theme-bg-secondary theme-text-primary theme-border-input',
    option: 'theme-bg-secondary theme-text-primary'
  };

  // Render
  return (
    <div className="relative">
      <select
        value={value}
        onChange={(e) => onChange(e.target.value)}
        className={`px-2 py-1 border rounded text-sm cursor-pointer hover-border-blue-500 transition-colors ${themeClasses.select}`}
        aria-label={ariaLabel}
        title="Espa√ßamento entre linhas e par√°grafos"
      >
        {Object.entries(SPACING_PRESETS).map(([key, preset]) => (
          <option
            key={key}
            value={key}
            className={themeClasses.option}
          >
            {preset.icon} {preset.label}
          </option>
        ))}
      </select>
    </div>
  );
});

SpacingDropdown.displayName = 'SpacingDropdown';

// üí° COMPONENTE: FontSizeDropdown - Controle de tamanho de fonte v1.10.8
const FontSizeDropdown = React.memo(({
  value,
  onChange,
  ariaLabel = 'Tamanho da fonte'
}) => {
  const themeClasses = {
    select: 'theme-bg-secondary theme-text-primary theme-border-input',
    option: 'theme-bg-secondary theme-text-primary'
  };

  return (
    <div className="relative">
      <select
        value={value}
        onChange={(e) => onChange(e.target.value)}
        className={`px-2 py-1 border rounded text-sm cursor-pointer hover-border-blue-500 transition-colors ${themeClasses.select}`}
        aria-label={ariaLabel}
        title="Tamanho da fonte do editor"
      >
        {Object.entries(FONTSIZE_PRESETS).map(([key, preset]) => (
          <option
            key={key}
            value={key}
            className={themeClasses.option}
          >
            {preset.icon} {preset.label}
          </option>
        ))}
      </select>
    </div>
  );
});

FontSizeDropdown.displayName = 'FontSizeDropdown';

// üí° COMPONENTE: VersionCompareModal - Modal de compara√ß√£o com diff visual
const VersionCompareModal = React.memo(({ oldContent, newContent, timestamp, onRestore, onClose }) => {
  const stripHtml = (html) => (html || '').replace(/<[^>]*>/g, '');
  const oldText = stripHtml(oldContent);
  const newText = stripHtml(newContent);

  const formatTimeAgo = (ts) => {
    const diff = Math.floor((Date.now() - ts) / 60000);
    if (diff < 60) return `${diff} minuto${diff !== 1 ? 's' : ''}`;
    if (diff < 1440) return `${Math.floor(diff / 60)} hora${Math.floor(diff / 60) !== 1 ? 's' : ''}`;
    return `${Math.floor(diff / 1440)} dia${Math.floor(diff / 1440) !== 1 ? 's' : ''}`;
  };

  // Algoritmo LCS para diff por palavras
  const computeDiff = React.useMemo(() => {
    const oldWords = oldText.split(/(\s+)/);
    const newWords = newText.split(/(\s+)/);
    const m = oldWords.length, n = newWords.length;
    const lcs = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        lcs[i][j] = oldWords[i-1] === newWords[j-1] ? lcs[i-1][j-1] + 1 : Math.max(lcs[i-1][j], lcs[i][j-1]);
      }
    }
    const result = [];
    let i = m, j = n;
    while (i > 0 || j > 0) {
      if (i > 0 && j > 0 && oldWords[i-1] === newWords[j-1]) {
        result.unshift({ type: 'same', text: oldWords[i-1] });
        i--; j--;
      } else if (j > 0 && (i === 0 || lcs[i][j-1] >= lcs[i-1][j])) {
        result.unshift({ type: 'added', text: newWords[j-1] });
        j--;
      } else {
        result.unshift({ type: 'removed', text: oldWords[i-1] });
        i--;
      }
    }
    return result;
  }, [oldText, newText]);

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center overflow-auto" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
      <div className="theme-bg-secondary rounded-lg shadow-xl w-full max-w-3xl mx-4 my-auto">
        <div className="flex items-center justify-between p-4 border-b theme-border-primary">
          <h3 className="font-semibold theme-text-primary">Comparar Vers√µes</h3>
          <button onClick={onClose} className="text-xl theme-text-muted cursor-pointer">√ó</button>
        </div>
        <div className="p-4">
          <div className="flex items-center gap-4 text-xs mb-3">
            <span className="theme-text-muted">Vers√£o salva h√° {formatTimeAgo(timestamp)}</span>
            <span className="flex items-center gap-1"><span className="inline-block w-3 h-3 bg-red-200 rounded"></span> Removido</span>
            <span className="flex items-center gap-1"><span className="inline-block w-3 h-3 bg-green-200 rounded"></span> Adicionado</span>
          </div>
          <div className="border theme-border-input rounded p-3 max-h-80 overflow-auto text-sm theme-text-primary theme-bg-primary leading-relaxed">
            {computeDiff.map((item, i) => {
              if (item.type === 'removed') return <span key={i} className="bg-red-200 text-red-900 line-through">{item.text}</span>;
              if (item.type === 'added') return <span key={i} className="bg-green-200 text-green-900">{item.text}</span>;
              return <span key={i}>{item.text}</span>;
            })}
          </div>
          <div className="flex justify-end gap-2 mt-4">
            <button onClick={onClose} className="px-4 py-2 text-sm border rounded theme-border-input theme-text-primary cursor-pointer hover-slate-600">Cancelar</button>
            <button onClick={onRestore} className="px-4 py-2 text-sm rounded bg-blue-600 text-white cursor-pointer hover-blue-700">Restaurar Vers√£o Anterior</button>
          </div>
        </div>
      </div>
    </div>
  );
});
VersionCompareModal.displayName = 'VersionCompareModal';

// üí° COMPONENTE: VersionSelect - Bot√£o compacto com dropdown de vers√µes
const VersionSelect = React.memo(({ topicTitle, versioning, currentContent, onRestore, className = '' }) => {
  const [isOpen, setIsOpen] = React.useState(false);
  const [versions, setVersions] = React.useState([]);
  const [compareVersion, setCompareVersion] = React.useState(null);
  const dropdownRef = React.useRef(null);

  const loadVersions = React.useCallback(async () => {
    if (!versioning || !topicTitle) return;
    const v = await versioning.getVersions(topicTitle);
    setVersions(v);
  }, [versioning, topicTitle]);

  // Carregar vers√µes ao montar e quando topicTitle mudar
  React.useEffect(() => { loadVersions(); }, [loadVersions]);

  const formatTime = (ts) => {
    const diff = Math.floor((Date.now() - ts) / 60000);
    if (diff < 60) return `${diff}min`;
    if (diff < 1440) return `${Math.floor(diff / 60)}h`;
    return `${Math.floor(diff / 1440)}d`;
  };

  const handleToggle = async () => {
    if (!isOpen) await loadVersions();
    setIsOpen(!isOpen);
  };

  const handleVersionClick = (version) => {
    setCompareVersion(version);
    setIsOpen(false);
  };

  const handleRestore = () => {
    if (compareVersion && onRestore) {
      onRestore(compareVersion.content);
      setCompareVersion(null);
      loadVersions();
    }
  };

  // Fechar ao clicar fora
  React.useEffect(() => {
    if (!isOpen) return;
    const handleClickOutside = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) setIsOpen(false);
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isOpen]);

  if (!versioning || !topicTitle) return null;

  return (
    <>
      <div ref={dropdownRef} className={`relative inline-block ${className}`}>
        <button
          onClick={handleToggle}
          className="px-2 py-1 text-xs border rounded theme-bg-secondary theme-text-primary theme-border-input cursor-pointer hover-slate-600 focus:ring-2 focus:ring-purple-500 focus:outline-none transition-all"
          title="Hist√≥rico de vers√µes"
        >
          üìú {versions.length > 0 ? `(${versions.length})` : ''}
        </button>
        {isOpen && versions.length > 0 && (
          <div className="absolute right-0 mt-1 z-50 min-w-32 max-h-48 overflow-y-auto rounded border theme-border-input theme-bg-secondary shadow-lg">
            {versions.map(v => (
              <div
                key={v.id}
                onClick={() => handleVersionClick(v)}
                title={v.preview}
                className="px-3 py-2 text-xs cursor-pointer theme-text-primary hover-slate-600 border-b theme-border-input last:border-b-0"
              >
                üïê {formatTime(v.timestamp)} atr√°s
              </div>
            ))}
          </div>
        )}
        {isOpen && versions.length === 0 && (
          <div className="absolute right-0 mt-1 z-50 px-3 py-2 text-xs rounded border theme-border-input theme-bg-secondary theme-text-muted">
            Sem vers√µes salvas
          </div>
        )}
      </div>
      {compareVersion && (
        <VersionCompareModal
          oldContent={compareVersion.content}
          newContent={currentContent}
          timestamp={compareVersion.timestamp}
          onRestore={handleRestore}
          onClose={() => setCompareVersion(null)}
        />
      )}
    </>
  );
});

VersionSelect.displayName = 'VersionSelect';

// üí° COMPONENTE: SuggestionCard - Card de sugest√£o de modelo
const SuggestionCard = React.memo(({
  model,
  index = 0,
  totalSuggestions = 5,
  onPreview,
  onInsert,
  sanitizeHTML,
  showRanking = true,
  similarity, // v1.33.18: % similaridade (opcional, vem de busca sem√¢ntica)
}) => {
  // Valida√ß√£o de Props
  if (!model) {
    return null;
  }

  // C√°lculo de Estrelas (5 para 1¬∫, 4 para 2¬∫, etc.)
  const stars = showRanking ? Math.max(1, totalSuggestions - index) : 0;

  // Preview Sanitizado (Memoizado para Performance)
  const sanitizedPreview = React.useMemo(
    () => sanitizeHTML(model.content?.substring(0, 300) || ''),
    [model.content, sanitizeHTML]
  );

  // Labels de Ranking
  const rankingLabels = {
    5: 'Mais relevante',
    4: '2¬∫ lugar',
    3: '3¬∫ lugar',
    2: '4¬∫ lugar',
    1: '5¬∫ lugar',
  };

  // v1.4.8: Hovers otimizados (sem state, manipula√ß√£o direta do DOM)
  // Removidos states previewHover/insertHover para evitar re-renders

  return (
    <div className="theme-bg-secondary-50 p-4 rounded-lg border theme-border-input hover-theme-border transition-all card-hover-lift">

      {/* ‚îÄ‚îÄ‚îÄ Header: T√≠tulo + Categoria + Favorito ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
      <div className="flex items-start justify-between mb-2">
        <div className="flex-1">
          <h5 className="theme-text-primary font-semibold text-sm mb-1">
            {model.title}
          </h5>

          {/* Ranking com Estrelas */}
          {showRanking && stars > 0 && (
            <div className="flex items-center gap-2 mb-1">
              <span className="text-yellow-400 text-xs">
                {'‚≠ê'.repeat(stars)}
              </span>
              <span className="text-yellow-400/80 text-xs">
                ({rankingLabels[stars]})
              </span>
            </div>
          )}
          {/* v1.33.20: Badge de similaridade (independente do ranking) */}
          {similarity && (
            <span className="text-xs px-1.5 py-0.5 rounded bg-green-600 text-white inline-block mb-1 animate-badge">
              {Math.round(similarity * 100)}% similar
            </span>
          )}
        </div>

        {/* Badge de Categoria */}
        {model.category && (
          <span className="px-2 py-1 theme-bg-purple-accent theme-text-purple rounded text-xs ml-2 max-w-[120px] truncate" title={model.category}>
            {model.category}
          </span>
        )}

        {/* √çcone de Favorito */}
        {model.favorite && (
          <span className="text-yellow-400 ml-1" title="Modelo favorito">‚òÖ</span>
        )}
      </div>

      {/* ‚îÄ‚îÄ‚îÄ Keywords ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  */}
      {model.keywords && (
        <div className="theme-text-muted text-xs mb-2">
          üè∑Ô∏è {model.keywords}
        </div>
      )}

      {/* ‚îÄ‚îÄ‚îÄ Preview do Conte√∫do (3 linhas) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  */}
      <div
        className="theme-text-muted text-xs mb-3 line-clamp-3"
        dangerouslySetInnerHTML={{ __html: sanitizedPreview }}
      />

      {/* ‚îÄ‚îÄ‚îÄ Bot√µes de A√ß√£o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  */}
      <div className="flex gap-2">

        {/* Bot√£o Visualizar */}
        <button
          onClick={() => onPreview(model)}
          className="flex-1 py-2 border border-blue-500 text-blue-400 rounded text-sm font-medium flex items-center justify-center gap-2 hover-blue-alpha-10-from-transparent"
          aria-label={`Visualizar modelo ${model.title}`}
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          Visualizar
        </button>

        {/* Bot√£o Inserir */}
        <button
          onClick={() => onInsert(model.content)}
          className="hover-suggestion-insert flex-1 py-2 text-white rounded text-sm font-medium"
          aria-label={`Inserir modelo ${model.title} no editor`}
        >
          Inserir
        </button>
      </div>
    </div>
  );
});

SuggestionCard.displayName = 'SuggestionCard';

// üîÄ COMPONENTE: SplitDivider (v1.9.21) - Divisor arrast√°vel para split window
const SplitDivider = React.memo(({ onDragStart }) => {
  const handleMouseDown = React.useCallback((e) => {
    e.preventDefault();
    onDragStart(e);
  }, [onDragStart]);

  return (
    <div
      className="split-divider"
      onMouseDown={handleMouseDown}
    >
      <div className="split-divider-handle">
        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M8 5h2v14H8zM14 5h2v14h-2z" />
        </svg>
      </div>
    </div>
  );
});

SplitDivider.displayName = 'SplitDivider';

// üìö COMPONENTE: FullscreenModelPanel (v1.9.32) - Sugest√µes de modelos em split
const FullscreenModelPanel = React.memo(({
  models,
  topicTitle = '',
  topicCategory = '',
  topicRelatorio = '',
  onInsert,
  onPreview,
  sanitizeHTML,
  onFindSuggestions
}) => {
  const [searchTerm, setSearchTerm] = React.useState('');
  const [searchResults, setSearchResults] = React.useState([]);
  const [suggestions, setSuggestions] = React.useState([]);
  const [suggestionsSource, setSuggestionsSource] = React.useState(null); // v1.28.04
  const [loading, setLoading] = React.useState(false);

  // Stopwords para scoring local (fallback se IA n√£o dispon√≠vel)
  const STOPWORDS = React.useMemo(() => new Set([
    'de', 'da', 'do', 'das', 'dos', 'em', 'na', 'no', 'nas', 'nos', 'para', 'por', 'com', 'sem',
    'o', 'a', 'os', 'as', 'e', 'ou', 'mas', 'que', 'qual', 'quando', 'onde', 'como'
  ]), []);

  // Fun√ß√£o de scoring local (fallback)
  const scoreModelLocal = React.useCallback((model) => {
    if (!topicTitle) return 0;
    let score = 0;

    const titleLower = topicTitle.toLowerCase();
    const modelTitleLower = (model.title || '').toLowerCase();

    const titleWords = titleLower.split(/\s+/).filter(w => w.length > 2 && !STOPWORDS.has(w));
    const modelWords = modelTitleLower.split(/\s+/).filter(w => w.length > 2 && !STOPWORDS.has(w));

    titleWords.forEach(titleWord => {
      if (modelWords.includes(titleWord)) score += 10;
    });

    titleWords.forEach(titleWord => {
      modelWords.forEach(modelWord => {
        if (titleWord !== modelWord && (titleWord.includes(modelWord) || modelWord.includes(titleWord))) {
          score += 5;
        }
      });
    });

    if (model.category && topicCategory && model.category.toUpperCase() === topicCategory.toUpperCase()) {
      score += 8;
    }

    if (model.keywords) {
      const keywords = model.keywords.toLowerCase().split(',').map(k => k.trim()).filter(k => k.length > 0);
      keywords.forEach(keyword => {
        if (titleLower.includes(keyword) || keyword.includes(titleLower.replace(/\s+/g, ''))) {
          score += 12;
        }
      });
    }

    return score;
  }, [topicTitle, topicCategory, STOPWORDS]);

  React.useEffect(() => {
    if (!models || models.length === 0 || !topicTitle) {
      setSuggestions([]);
      return;
    }

    // Se temos fun√ß√£o de IA, usar ela
    if (onFindSuggestions) {
      setLoading(true);
      // v1.28.06: Yield para UI n√£o travar + async para aguardar
      (async () => {
        await new Promise(r => setTimeout(r, 0));
        try {
          const result = await onFindSuggestions({
            title: topicTitle,
            category: topicCategory,
            relatorio: topicRelatorio
          });
          // v1.28.04: Suporta novo formato { suggestions, source }
          if (result?.suggestions) {
            setSuggestions(result.suggestions);
            setSuggestionsSource(result.source);
          } else {
            setSuggestions(result || []);
            setSuggestionsSource(null);
          }
        } catch (err) {
          // Fallback para scoring local em caso de erro
          const scoredModels = models
            .map(m => ({ ...m, score: scoreModelLocal(m) }))
            .filter(m => m.score > 0)
            .sort((a, b) => b.score - a.score)
            .slice(0, 5);
          setSuggestions(scoredModels);
          setSuggestionsSource(null);
        } finally {
          setLoading(false);
        }
      })();
    } else {
      // Fallback: scoring local
      const scoredModels = models
        .map(m => ({ ...m, score: scoreModelLocal(m) }))
        .filter(m => m.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 5);
      setSuggestions(scoredModels);
    }
  }, [models, topicTitle, topicCategory, topicRelatorio, onFindSuggestions, scoreModelLocal]);

  // Busca manual com debounce
  const searchTimeoutRef = React.useRef(null);

  const handleSearchChange = React.useCallback((e) => {
    const term = e.target.value;
    setSearchTerm(term);

    // Debounce 300ms
    if (searchTimeoutRef.current) {
      clearTimeout(searchTimeoutRef.current);
    }

    searchTimeoutRef.current = setTimeout(() => {
      if (!term.trim()) {
        setSearchResults([]);
        return;
      }

      const termLower = term.toLowerCase();
      const results = (models || [])
        .filter(m => {
          const titleMatch = (m.title || '').toLowerCase().includes(termLower);
          const keywordsMatch = (m.keywords || '').toLowerCase().includes(termLower);
          const contentMatch = (m.content || '').toLowerCase().includes(termLower);
          return titleMatch || keywordsMatch || contentMatch;
        })
        .slice(0, 10); // Max 10 resultados

      setSearchResults(results);
    }, 300);
  }, [models]);

  // Cleanup timeout on unmount
  React.useEffect(() => {
    return () => {
      if (searchTimeoutRef.current) {
        clearTimeout(searchTimeoutRef.current);
      }
    };
  }, []);

  return (
    <div className="model-search-panel">
      {/* Header */}
      <div className="p-3 border-b theme-border-primary">
        <h3 className="text-sm font-semibold theme-text-primary mb-2 flex items-center gap-2">
          <BookOpen className="w-4 h-4" />
          Modelos Sugeridos
        </h3>

        {/* Campo de busca */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 theme-text-muted" />
          <input
            type="text"
            value={searchTerm}
            onChange={handleSearchChange}
            onKeyDown={(e) => e.key === 'Escape' && handleSearchChange({ target: { value: '' } })}
            placeholder="Buscar modelos..."
            className="w-full pl-9 pr-8 py-2 text-sm rounded theme-bg-secondary theme-border-input border theme-text-primary"
          />
          {searchTerm && (
            <button onClick={() => handleSearchChange({ target: { value: '' } })} className="absolute right-2 top-1/2 -translate-y-1/2 p-0.5 theme-text-muted hover-text-primary" title="Limpar (Esc)">
              <X className="w-3.5 h-3.5" />
            </button>
          )}
        </div>
      </div>

      {/* Conte√∫do scroll√°vel */}
      <div className="flex-1 overflow-y-auto p-3 space-y-3">

        {/* Resultados da busca manual (se houver) */}
        {searchResults.length > 0 && (
          <div>
            <h4 className="text-xs font-medium theme-text-muted mb-2 flex items-center gap-1">
              <Search className="w-3 h-3" />
              Resultados da Busca ({searchResults.length})
            </h4>
            <div className="space-y-2">
              {searchResults.map((model) => (
                <SuggestionCard
                  key={`search-${model.id}`}
                  model={model}
                  similarity={model.similarity}
                  onPreview={onPreview}
                  onInsert={onInsert}
                  sanitizeHTML={sanitizeHTML}
                  showRanking={false}
                />
              ))}
            </div>
          </div>
        )}

        {/* Separador se houver busca e sugest√µes */}
        {searchResults.length > 0 && suggestions.length > 0 && (
          <div className="border-t theme-border-primary my-3" />
        )}

        {/* v1.9.32: Loading da IA */}
        {loading ? (
          <div className="flex flex-col items-center justify-center py-8">
            <div className="w-8 h-8 border-2 border-purple-500 border-t-transparent rounded-full animate-spin mb-3"></div>
            <p className="text-sm theme-text-muted">Analisando modelos com IA...</p>
          </div>
        ) : suggestions.length > 0 ? (
          <div>
            <h4 className="text-xs font-medium theme-text-muted mb-2 flex items-center gap-2">
              <Sparkles className="w-3 h-3" />
              Sugest√µes para "{topicTitle}" ({suggestions.length})
              {suggestionsSource === 'local' && <span className="bg-purple-600 text-white px-1.5 py-0.5 rounded text-[10px]">ü§ñ IA Local</span>}
            </h4>
            <div className="space-y-2">
              {suggestions.map((model, idx) => (
                <SuggestionCard
                  key={`suggestion-${model.id}`}
                  model={model}
                  similarity={model.similarity}
                  index={idx}
                  totalSuggestions={suggestions.length}
                  onPreview={onPreview}
                  onInsert={onInsert}
                  sanitizeHTML={sanitizeHTML}
                  showRanking={true}
                />
              ))}
            </div>
          </div>
        ) : !searchResults.length && (
          <p className="text-sm theme-text-muted text-center py-4">
            {topicTitle
              ? 'Nenhuma sugest√£o encontrada para este t√≥pico'
              : 'Selecione um t√≥pico para ver sugest√µes'}
          </p>
        )}
      </div>

      {/* Footer com contagem */}
      <div className="p-2 border-t theme-border-primary text-xs theme-text-muted text-center">
        {searchResults.length > 0
          ? `${searchResults.length} resultado(s) da busca`
          : `${suggestions.length} sugest√£o(√µes) autom√°tica(s)`}
      </div>
    </div>
  );
}, (prevProps, nextProps) => {
  return (
    prevProps.models === nextProps.models &&
    prevProps.topicTitle === nextProps.topicTitle &&
    prevProps.topicCategory === nextProps.topicCategory &&
    prevProps.topicRelatorio === nextProps.topicRelatorio &&
    prevProps.onInsert === nextProps.onInsert &&
    prevProps.onPreview === nextProps.onPreview &&
    prevProps.sanitizeHTML === nextProps.sanitizeHTML &&
    prevProps.onFindSuggestions === nextProps.onFindSuggestions
  );
});

FullscreenModelPanel.displayName = 'FullscreenModelPanel';

// üìö COMPONENTE: ModelSearchPanel (v1.9.23) - Busca de modelos em split
const ModelSearchPanel = React.memo(({
  models,
  onInsert,
  onPreview,
  sanitizeHTML
}) => {
  const [searchTerm, setSearchTerm] = React.useState('');
  const [selectedCategory, setSelectedCategory] = React.useState('all');

  const filteredModels = React.useMemo(() => {
    return (models || []).filter(m => {
      const matchesSearch = !searchTerm ||
        (m.title || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
        (m.keywords || '').toLowerCase().includes(searchTerm.toLowerCase());
      const matchesCategory = selectedCategory === 'all' || m.category === selectedCategory;
      return matchesSearch && matchesCategory;
    });
  }, [models, searchTerm, selectedCategory]);

  const categories = React.useMemo(() => {
    const cats = new Set((models || []).map(m => m.category).filter(Boolean));
    return ['all', ...Array.from(cats)];
  }, [models]);

  return (
    <div className="model-search-panel">
      {/* Header */}
      <div className="p-3 border-b theme-border-primary">
        <h3 className="text-sm font-semibold theme-text-primary mb-2 flex items-center gap-2">
          <BookOpen className="w-4 h-4" />
          Biblioteca de Modelos
        </h3>

        {/* Campo de busca */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 theme-text-muted" />
          <input
            type="text"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            onKeyDown={(e) => e.key === 'Escape' && setSearchTerm('')}
            placeholder="Buscar por t√≠tulo ou palavras-chave..."
            className="w-full pl-9 pr-8 py-2 text-sm rounded theme-bg-secondary theme-border-input border theme-text-primary"
          />
          {searchTerm && (
            <button onClick={() => setSearchTerm('')} className="absolute right-2 top-1/2 -translate-y-1/2 p-0.5 theme-text-muted hover-text-primary" title="Limpar (Esc)">
              <X className="w-3.5 h-3.5" />
            </button>
          )}
        </div>

        {/* Filtro de categoria */}
        <select
          value={selectedCategory}
          onChange={(e) => setSelectedCategory(e.target.value)}
          className="w-full mt-2 px-3 py-2 text-sm rounded theme-bg-secondary theme-border-input border theme-text-primary"
        >
          {categories.map(cat => (
            <option key={cat} value={cat}>
              {cat === 'all' ? 'Todas as categorias' : cat}
            </option>
          ))}
        </select>
      </div>

      {/* Lista de modelos */}
      <div className="flex-1 overflow-y-auto p-3 space-y-2">
        {filteredModels.length === 0 ? (
          <p className="text-sm theme-text-muted text-center py-4">
            Nenhum modelo encontrado
          </p>
        ) : (
          filteredModels.map(model => (
            <div
              key={model.id}
              className="p-3 rounded border theme-border-primary theme-bg-secondary"
            >
              <h4 className="text-sm font-medium theme-text-primary truncate">
                {model.title}
              </h4>
              {model.keywords && (
                <p className="text-xs theme-text-muted mt-1 truncate">
                  {model.keywords}
                </p>
              )}
              <div
                className="text-xs theme-text-secondary mt-2 line-clamp-2"
                dangerouslySetInnerHTML={{ __html: sanitizeHTML ? sanitizeHTML(model.content || '').substring(0, 150) + '...' : '' }}
              />
              <div className="flex gap-2 mt-2">
                <button
                  onClick={() => onPreview && onPreview(model)}
                  className="flex-1 px-2 py-1.5 text-xs rounded theme-bg-tertiary theme-text-primary hover-slate-600 flex items-center justify-center gap-1"
                >
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  Ver
                </button>
                <button
                  onClick={() => onInsert && onInsert(model.content)}
                  className="flex-1 px-2 py-1.5 text-xs rounded bg-blue-600 text-white hover-blue-700 flex items-center justify-center gap-1"
                >
                  <Plus className="w-3 h-3" />
                  Inserir
                </button>
              </div>
            </div>
          ))
        )}
      </div>

      {/* Footer com contagem */}
      <div className="p-2 border-t theme-border-primary text-xs theme-text-muted text-center">
        {filteredModels.length} modelo(s) encontrado(s)
      </div>
    </div>
  );
}, (prevProps, nextProps) => {
  return (
    prevProps.models === nextProps.models &&
    prevProps.onInsert === nextProps.onInsert &&
    prevProps.onPreview === nextProps.onPreview &&
    prevProps.sanitizeHTML === nextProps.sanitizeHTML
  );
});

ModelSearchPanel.displayName = 'ModelSearchPanel';

// üé¥ COMPONENTE: TopicCard (v1.2.7) - Card de t√≥pico com drag-and-drop

// üÜï v1.12.18: Seletor de modo de processamento de PDF
// Componente reutiliz√°vel para selecionar como o PDF ser√° processado antes de enviar para a IA
// v1.14.1: Restaurado PDF Puro como op√ß√£o (config global √© apenas padr√£o, usu√°rio pode mudar por arquivo)
// v1.32.13: anonymizationEnabled bloqueia apenas modos que n√£o extraem texto (claude-vision, pdf-puro)
// PDF.js e Tesseract extraem texto ‚Üí podem ser anonimizados
const ProcessingModeSelector = React.memo(({ value, onChange, disabled = false, anonymizationEnabled = false, className = '' }) => {
  const blockedModes = ['claude-vision', 'pdf-puro'];
  const isValueBlocked = anonymizationEnabled && blockedModes.includes(value);
  const effectiveValue = isValueBlocked ? 'pdfjs' : (value || 'pdfjs');
  return (
    <select
      value={effectiveValue}
      onChange={(e) => onChange(e.target.value)}
      disabled={disabled}
      title={anonymizationEnabled ? 'Anonimiza√ß√£o ativa: modos bin√°rios bloqueados' : undefined}
      className={`text-xs theme-bg-secondary theme-border-input border rounded px-2 py-1 cursor-pointer theme-text-primary hover-border-blue-500 transition-colors ${className}`}
      onClick={(e) => e.stopPropagation()}
    >
      <option value="pdfjs" className="theme-bg-secondary theme-text-primary">PDF.js (Texto)</option>
      <option value="tesseract" className="theme-bg-secondary theme-text-primary">Tesseract OCR (Offline)</option>
      <option value="claude-vision" className="theme-bg-secondary theme-text-primary" disabled={anonymizationEnabled}>{anonymizationEnabled ? 'üîí Claude Vision' : 'Claude Vision (API)'}</option>
      <option value="pdf-puro" className="theme-bg-secondary theme-text-primary" disabled={anonymizationEnabled}>{anonymizationEnabled ? 'üîí PDF Bin√°rio' : 'PDF Puro (bin√°rio)'}</option>
    </select>
  );
});

// v1.33.58: TopicCard refatorado para dnd-kit (isDragging/isOver ao inv√©s de handlers HTML5)
const TopicCard = React.memo(({
  topic,
  selectedIdx,
  topicRefs,
  lastEditedTopicTitle,
  isDragging,  // v1.33.58: dnd-kit
  isOver,      // v1.33.58: dnd-kit
  selectedTopics,
  extractedTopics,
  topicsToMerge,
  toggleTopicSelection,
  moveTopicUp,
  moveTopicDown,
  moveTopicToPosition,
  setSelectedTopics,
  setExtractedTopics,
  startEditing,
  setTopicToRename,
  setNewTopicName,
  openModal,
  setTopicToSplit,
  setTopicsToMerge
}) => {
  const isRelatorioOrDispositivo = isSpecialTopic(topic);

  // Helper para verificar se o t√≥pico est√° decidido (v1.3.5.1 - bug fix)
  const isDecidido = () => {
    // DISPOSITIVO usa editedContent
    if (isDispositivo(topic)) {
      return topic.editedContent && topic.editedContent.trim() !== '';
    }
    if (isRelatorio(topic)) {
      return (topic.editedRelatorio && topic.editedRelatorio.trim() !== '') ||
             (topic.relatorio && topic.relatorio.trim() !== '');
    }
    // T√≥picos normais precisam de conte√∫do E resultado selecionado
    const temConteudo = topic.editedFundamentacao && topic.editedFundamentacao.trim() !== '';
    const temResultado = topic.resultado && topic.resultado.trim() !== '';
    return temConteudo && temResultado;
  };

  // v1.33.58: Removido draggable e handlers HTML5 - agora controlado pelo SortableTopicCard
  return (
    <div
      key={topic.title}
      ref={(el) => topicRefs.current[topic.title] = el}
      className={`hover-topic-drag-area rounded-lg p-3 border-2 transition-all duration-300 ${
        isRelatorioOrDispositivo ? 'cursor-default' : 'cursor-move'
      } ${
        lastEditedTopicTitle === topic.title
          ? 'border-green-500 shadow-lg shadow-green-500/20'
          : isDragging
            ? 'border-blue-500 shadow-2xl shadow-blue-500/40'
            : isOver
              ? 'border-purple-500 shadow-xl shadow-purple-500/30'
              : 'border-blue-500 card-hover-lift'
      }`}
      style={{ backgroundColor: 'rgba(37, 99, 235, 0.1)' }}
    >
      <div className="flex items-center gap-3">
        {/* Checkbox para desselecionar - n√£o mostrar para RELAT√ìRIO e DISPOSITIVO */}
        {!isRelatorioOrDispositivo && (
          <input
            type="checkbox"
            checked={true}
            onChange={(e) => {
              e.stopPropagation();
              toggleTopicSelection(topic);
            }}
            className="w-5 h-5 rounded flex-shrink-0 cursor-pointer"
            title="Desmarcar t√≥pico"
          />
        )}

        {/* √çcone de arrastar - n√£o mostrar para RELAT√ìRIO e DISPOSITIVO */}
        {!isRelatorioOrDispositivo && (
          <div className="flex-shrink-0 cursor-grab active:cursor-grabbing">
            <GripVertical className={`w-5 h-5 transition-colors ${
              isDragging ? 'text-blue-400' : 'theme-text-muted hover-theme-text-secondary'
            }`} />
          </div>
        )}

        {/* Controles de posi√ß√£o - n√£o mostrar para RELAT√ìRIO e DISPOSITIVO */}
        {!isRelatorioOrDispositivo && (
          <div className="flex flex-col gap-1">
            <button
              onClick={() => moveTopicUp(selectedIdx)}
              disabled={selectedIdx === 0}
              className="p-1 rounded disabled:opacity-40 disabled:cursor-not-allowed hover-slate-600 bg-transparent transition-all duration-200"
            >
              <ChevronUp className="w-4 h-4" />
            </button>
            <input
              type="number"
              min="1"
              max={selectedTopics.length}
              value={selectedIdx + 1}
              className="w-12 theme-bg-primary border theme-border-input rounded text-center text-xs py-1 theme-text-primary"
              onKeyDown={(e) => {
                if (e.key === 'Enter') {
                  const newPos = parseInt(e.target.value);
                  moveTopicToPosition(selectedIdx, newPos);
                }
              }}
              onChange={(e) => {
                const newPos = parseInt(e.target.value);
                if (!isNaN(newPos)) {
                  moveTopicToPosition(selectedIdx, newPos);
                }
              }}
            />
            <button
              onClick={() => moveTopicDown(selectedIdx)}
              disabled={selectedIdx === selectedTopics.length - 1}
              className="p-1 rounded disabled:opacity-40 disabled:cursor-not-allowed hover-slate-600 bg-transparent transition-all duration-200"
            >
              <ChevronDown className="w-4 h-4" />
            </button>
          </div>
        )}

        {/* Badge de posi√ß√£o fixa para RELAT√ìRIO e DISPOSITIVO */}
        {isRelatorioOrDispositivo && (
          <div className="flex items-center gap-2 px-3 py-2 theme-bg-purple-accent border border-purple-500/30 rounded-lg">
            <span className="text-xs theme-text-purple font-medium">
              üìå Posi√ß√£o Fixa
            </span>
          </div>
        )}

        {/* Conte√∫do do t√≥pico */}
        <div className="flex-1">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2 flex-wrap">
              {/* Seletor de categoria - edit√°vel (n√£o mostrar para RELAT√ìRIO e DISPOSITIVO) */}
              {!isRelatorioOrDispositivo && (
                <select
                  value={topic.category || 'M√âRITO'}
                  onChange={(e) => {
                    const newTopics = [...selectedTopics];
                    newTopics[selectedIdx] = { ...topic, category: e.target.value };
                    setSelectedTopics(newTopics);

                    // Atualizar tamb√©m em extractedTopics se existir
                    const extractedIndex = extractedTopics.findIndex(t => t.title === topic.title);
                    if (extractedIndex !== -1) {
                      const newExtracted = [...extractedTopics];
                      newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], category: e.target.value };
                      setExtractedTopics(newExtracted);
                    }
                  }}
                  onClick={(e) => e.stopPropagation()}
                  className="text-xs px-2 py-1 rounded cursor-pointer font-medium focus:outline-none focus:ring-2 focus:ring-blue-400 border-2 border-blue-500 hover-blue-700 bg-blue-600 text-white transition-colors duration-200"
                  title="Clique para alterar a categoria"
                >
                  <option value="PRELIMINAR">üìã Preliminar</option>
                  <option value="PREJUDICIAL">‚ö†Ô∏è Prejudicial</option>
                  <option value="M√âRITO">‚öñÔ∏è M√©rito</option>
                  <option value="PROCESSUAL">üìù Processual</option>
                </select>
              )}

              <h4 className="font-semibold theme-text-primary">{topic.title.toUpperCase()}</h4>
              <span className="text-xs theme-bg-blue-accent theme-text-blue px-2 py-1 rounded">
                #{selectedIdx + 1}
              </span>

              {/* Seletor de resultado do julgamento - n√£o mostrar para RELAT√ìRIO e DISPOSITIVO */}
              {topic.title.toUpperCase() !== 'RELAT√ìRIO' && topic.title.toUpperCase() !== 'DISPOSITIVO' && (
                <select
                  value={topic.resultado || ''}
                  onChange={(e) => {
                    const newTopics = [...selectedTopics];
                    // Marcar como escolha manual se usu√°rio selecionar algo (n√£o vazio)
                    const resultadoManual = e.target.value !== '';
                    newTopics[selectedIdx] = {
                      ...topic,
                      resultado: e.target.value,
                      resultadoManual: resultadoManual
                    };
                    setSelectedTopics(newTopics);

                    // Atualizar tamb√©m em extractedTopics se existir
                    const extractedIndex = extractedTopics.findIndex(t => t.title === topic.title);
                    if (extractedIndex !== -1) {
                      const newExtracted = [...extractedTopics];
                      newExtracted[extractedIndex] = {
                        ...newExtracted[extractedIndex],
                        resultado: e.target.value,
                        resultadoManual: resultadoManual
                      };
                      setExtractedTopics(newExtracted);
                    }
                  }}
                  onClick={(e) => e.stopPropagation()}
                  className="text-xs px-3 py-1 rounded border-2 theme-bg-secondary cursor-pointer font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                  style={getResultadoStyle(topic.resultado)}
                >
                  <option value="">‚öñÔ∏è Selecione o resultado...</option>
                  <option value="PROCEDENTE">‚úÖ Procedente</option>
                  <option value="IMPROCEDENTE">‚ùå Improcedente</option>
                  <option value="PARCIALMENTE PROCEDENTE">‚öñÔ∏è Parcialmente Procedente</option>
                  <option value="ACOLHIDO">‚úÖ Acolhido/Reconhecido</option>
                  <option value="REJEITADO">‚ùå Rejeitado/Indeferido</option>
                  <option value="SEM RESULTADO">‚è∏Ô∏è Sem Resultado</option>
                </select>
              )}

              {/* Indicador de resultado auto-detectado */}
              {topic.resultado && !topic.resultadoManual && topic.title.toUpperCase() !== 'RELAT√ìRIO' && topic.title.toUpperCase() !== 'DISPOSITIVO' && (
                <span className="text-xs text-purple-400 flex items-center gap-1" title="Resultado detectado automaticamente pela IA">
                  <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                  </svg>
                  Auto
                </span>
              )}

              {/* Indicador de status de decis√£o - n√£o mostrar para RELAT√ìRIO e DISPOSITIVO */}
              {topic.title.toUpperCase() !== 'RELAT√ìRIO' && topic.title.toUpperCase() !== 'DISPOSITIVO' && (
                isDecidido() ? (
                  <span className="flex items-center gap-1 text-xs theme-bg-green-accent theme-text-green px-2 py-1 rounded border border-green-500/30">
                    <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                    Decidido
                  </span>
                ) : (
                  <span className="flex items-center gap-1 text-xs theme-bg-amber-accent theme-text-amber px-2 py-1 rounded border border-amber-500/30">
                    <span className="w-2 h-2 bg-amber-500 rounded-full"></span>
                    Pendente
                  </span>
                )
              )}
            </div>
          </div>

          {/* Bot√µes de a√ß√£o */}
          <div className="flex flex-wrap gap-2 mt-3">
            <button
              onClick={() => startEditing(topic)}
              className="px-4 py-2 rounded text-sm hover-blue-700 bg-blue-600 text-white transition-colors duration-300"
            >
              Editar
            </button>

            {/* Bot√µes adicionais apenas para t√≥picos que n√£o sejam RELAT√ìRIO ou DISPOSITIVO */}
            {topic.title.toUpperCase() !== 'RELAT√ìRIO' && topic.title.toUpperCase() !== 'DISPOSITIVO' && (
              <>
                <button
                  onClick={() => {
                    setTopicToRename(topic);
                    setNewTopicName(topic.title);
                    openModal('rename');
                  }}
                  className="px-3 py-2 rounded text-sm flex items-center gap-1 hover-purple-700 bg-purple-600 text-white transition-colors duration-300"
                >
                  <Edit2 className="w-3 h-3" />
                  Renomear
                </button>
                <button
                  onClick={() => {
                    setTopicToSplit(topic);
                    openModal('split');
                  }}
                  className="px-3 py-2 rounded text-sm flex items-center gap-1 hover-orange-700 bg-orange-600 text-white transition-colors duration-300"
                >
                  <Split className="w-3 h-3" />
                  Separar
                </button>
                <button
                  onClick={() => {
                    if (topicsToMerge.find(t => t.title === topic.title)) {
                      setTopicsToMerge(topicsToMerge.filter(t => t.title !== topic.title));
                    } else {
                      setTopicsToMerge([...topicsToMerge, topic]);
                    }
                  }}
                  className="px-3 py-2 rounded text-sm flex items-center gap-1 text-white"
                  style={{
                    backgroundColor: topicsToMerge.find(t => t.title === topic.title) ? '#059669' : '#475569',
                    transition: 'background-color 0.3s ease'
                  }}
                  onMouseEnter={(e) => {
                    const isSelected = topicsToMerge.find(t => t.title === topic.title);
                    e.currentTarget.style.backgroundColor = isSelected ? '#047857' : '#334155';
                  }}
                  onMouseLeave={(e) => {
                    const isSelected = topicsToMerge.find(t => t.title === topic.title);
                    e.currentTarget.style.backgroundColor = isSelected ? '#059669' : '#475569';
                  }}
                >
                  <Merge className="w-3 h-3" />
                  {topicsToMerge.find(t => t.title === topic.title) ? 'Selecionado' : 'Unir'}
                </button>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
});

// Display name para React DevTools
TopicCard.displayName = 'TopicCard';

// v1.33.58: SortableTopicCard - wrapper para dnd-kit com suporte a wheel scroll
const SortableTopicCard = React.memo(({ topic, id, ...props }) => {
  const isSpecial = isSpecialTopic(topic);

  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
    isOver
  } = useSortable({
    id,
    disabled: isSpecial
  });

  const style = {
    transform: DndCSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 1000 : 'auto'
  };

  return (
    <div ref={setNodeRef} style={style} {...attributes} {...listeners}>
      <TopicCard
        topic={topic}
        isDragging={isDragging}
        isOver={isOver}
        {...props}
      />
    </div>
  );
});
SortableTopicCard.displayName = 'SortableTopicCard';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üì¶ SE√á√ÉO 4: COMPONENTES DE UI
// VirtualList, JurisprudenciaModalContent, LegislacaoModalContent
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// üì¶ COMPONENTE: VirtualList (v1.7.1) - Virtual scrolling para performance
// v1.19.2: Adicionado suporte a expandedIds para items com altura din√¢mica
const VirtualList = React.memo(({ items, itemHeight, renderItem, className = '', overscan = 5, expandedIds = new Set() }) => {
  const [scrollTop, setScrollTop] = React.useState(0);
  const containerRef = React.useRef(null);

  // Calcular viewport height dinamicamente
  const viewportHeight = React.useMemo(() => {
    if (typeof window === 'undefined') return 600;
    return Math.min(window.innerHeight - 200, 800); // Max 800px
  }, []);

  // Calcular range de items vis√≠veis
  const { visibleStart, visibleEnd, offsetY } = React.useMemo(() => {
    const start = Math.floor(scrollTop / itemHeight);
    const end = Math.ceil((scrollTop + viewportHeight) / itemHeight);

    return {
      visibleStart: Math.max(0, start - overscan),
      visibleEnd: Math.min(items.length, end + overscan),
      offsetY: Math.max(0, start - overscan) * itemHeight
    };
  }, [scrollTop, itemHeight, viewportHeight, items.length, overscan]);

  // Items vis√≠veis + buffer
  const visibleItems = React.useMemo(() => {
    return items.slice(visibleStart, visibleEnd);
  }, [items, visibleStart, visibleEnd]);

  // Handler de scroll com RAF para performance
  const handleScroll = React.useCallback((e) => {
    const newScrollTop = e.target.scrollTop;
    // S√≥ atualizar se mudou significativamente (> 10px)
    if (Math.abs(newScrollTop - scrollTop) > 10) {
      requestAnimationFrame(() => {
        setScrollTop(newScrollTop);
      });
    }
  }, [scrollTop]);

  // Total height para manter scrollbar correto
  const totalHeight = items.length * itemHeight;

  return (
    <div
      ref={containerRef}
      className={`virtual-list-container ${className}`}
      style={{
        height: viewportHeight,
        overflow: 'auto',
        position: 'relative'
      }}
      onScroll={handleScroll}
    >
      {/* Spacer para altura total */}
      <div style={{ height: totalHeight, position: 'relative' }}>
        {/* Container para items vis√≠veis */}
        <div style={{
          position: 'absolute',
          top: offsetY,
          left: 0,
          right: 0
        }}>
          {visibleItems.map((item, idx) => {
            const absoluteIndex = visibleStart + idx;
            const isExpanded = expandedIds.has(item.id);
            return (
              <div
                key={item.id || absoluteIndex}
                style={isExpanded ? {
                  position: 'relative',
                  zIndex: 10,
                  paddingBottom: '12px'
                } : {
                  height: itemHeight,
                  overflow: 'hidden'
                }}
              >
                {renderItem(item, absoluteIndex)}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
});

VirtualList.displayName = 'VirtualList';

// üìö COMPONENTE: ModelCard (v1.2.7) - Card dual-view cards/list
// v1.35.0: Suporte a modelos compartilhados com badge de propriet√°rio
const ModelCard = React.memo(({
  model,
  viewMode,
  onEdit,
  onToggleFavorite,
  onDuplicate,
  onDelete,
  onInsert,
  sanitizeHTML,
  isShared = false,
  ownerEmail = null,
  sharedPermission = 'view'
}) => {
  // Valida√ß√£o de viewMode
  let validViewMode = viewMode;
  if (viewMode !== 'cards' && viewMode !== 'list') {
    validViewMode = 'cards';
  }

  // MODO CARDS - Visualiza√ß√£o expandida com preview
  if (validViewMode === 'cards') {
    return (
      <div
        className="theme-bg-secondary-30 p-5 rounded-lg border-2 transition-all hover-theme-border-from-600 card-hover-lift"
      >
        <div className="flex items-start justify-between mb-3">
          <div className="flex-1">
            <div className="flex items-center gap-2 mb-2">
              <button
                onClick={() => onToggleFavorite(model.id)}
                className={`text-xl hover:scale-125 transition-all duration-200 ${model.favorite ? 'text-yellow-400' : 'text-slate-400 hover:text-yellow-300'}`}
                title={model.favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}
              >
                {model.favorite ? '‚òÖ' : '‚òÜ'}
              </button>
              <h4 className="font-semibold text-lg theme-text-primary">{model.title}</h4>
            </div>
            <div className="flex flex-wrap items-center gap-2 mb-3">
              {model.category && (
                <span className="text-xs px-2 py-1 rounded theme-bg-purple-accent theme-text-purple border border-purple-500/30 font-medium">
                  {model.category}
                </span>
              )}
              {/* v1.33.4: Badge de similaridade para busca sem√¢ntica */}
              {model.similarity !== undefined && (
                <span className={`text-xs px-2 py-1 rounded font-medium animate-badge ${
                  model.similarity >= 0.7 ? 'bg-green-500/20 text-green-400 border border-green-500/30' :
                  model.similarity >= 0.5 ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' :
                  'bg-gray-500/20 text-gray-400 border border-gray-500/30'
                }`}>
                  {Math.round(model.similarity * 100)}% similar
                </span>
              )}
              {/* v1.35.0: Badge de modelo compartilhado */}
              {isShared && ownerEmail && (
                <span className="text-xs px-2 py-1 rounded font-medium bg-purple-500/20 text-purple-400 border border-purple-500/30 animate-badge flex items-center gap-1">
                  <Users className="w-3 h-3" />
                  De: {ownerEmail.split('@')[0]}
                </span>
              )}
              {model.createdAt && (
                <span className="text-xs theme-text-disabled">
                  {new Date(model.createdAt).toLocaleDateString('pt-BR')}
                </span>
              )}
            </div>
            {model.keywords && (() => {
              const kwArr = model.keywords.split(',');
              return (
              <div className="flex flex-wrap gap-1 mb-3">
                {kwArr.slice(0, 3).map((kw, i) => (
                  <span key={i} className="text-xs px-2 py-0.5 rounded theme-bg-tertiary theme-text-tertiary">
                    {kw.trim()}
                  </span>
                ))}
                {kwArr.length > 3 && (
                  <span className="text-xs px-2 py-0.5 theme-text-muted">
                    +{kwArr.length - 3}
                  </span>
                )}
              </div>
            );})()}
          </div>
        </div>

        {/* Preview do conte√∫do */}
        <div
          className="theme-text-tertiary text-sm mb-4 line-clamp-4 theme-bg-primary-50 p-3 rounded"
          dangerouslySetInnerHTML={{ __html: sanitizeHTML(model.content) }}
        />

        {/* Bot√µes de a√ß√£o - v1.35.0: desabilitados para compartilhados view-only */}
        <div className="flex gap-2">
          <button
            onClick={() => onEdit(model)}
            disabled={isShared && sharedPermission === 'view'}
            className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded text-sm transition-all duration-300 border-none ${
              isShared && sharedPermission === 'view'
                ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                : 'hover-blue-500 bg-blue-600 text-white'
            }`}
            title={isShared && sharedPermission === 'view' ? 'Modelo compartilhado (somente leitura)' : 'Editar modelo'}
          >
            <Edit className="w-4 h-4" />
            {isShared && sharedPermission === 'view' ? 'Visualizar' : 'Editar'}
          </button>
          <button
            onClick={() => onDuplicate(model)}
            className="hover-merge-confirm-btn px-3 py-2 rounded text-sm"
            style={{
              color: '#ffffff',
              transform: 'scale(1)'
            }}
            title="Duplicar para sua biblioteca"
          >
            üìã
          </button>
          {/* v1.35.1: Mostrar excluir para modelos pr√≥prios OU compartilhados com permiss√£o edit */}
          {(!isShared || sharedPermission === 'edit') && (
            <button
              onClick={() => onDelete(model)}
              className="hover-merge-cancel-btn px-3 py-2 rounded text-sm"
              style={{
                color: '#ffffff',
                transform: 'scale(1)'
              }}
              title={isShared ? 'Excluir modelo compartilhado (afeta o propriet√°rio)' : 'Excluir modelo'}
            >
              <Trash2 className="w-4 h-4" />
            </button>
          )}
        </div>
      </div>
    );
  }

  // MODO LIST - Visualiza√ß√£o compacta inline (v1.33.55: sem card-hover-lift para n√£o cortar borda superior)
  return (
    <div
      className="theme-bg-secondary-30 p-4 rounded-lg border-2 transition-all hover-theme-border-from-600"
    >
      <div className="flex items-center justify-between gap-4">
        <div className="flex items-center gap-3 flex-1 min-w-0">
          <button
            onClick={() => onToggleFavorite(model.id)}
            className={`text-lg flex-shrink-0 hover:scale-125 transition-all duration-200 ${model.favorite ? 'text-yellow-400' : 'text-slate-400 hover:text-yellow-300'}`}
            title={model.favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}
          >
            {model.favorite ? '‚òÖ' : '‚òÜ'}
          </button>
          <div className="flex-1 min-w-0">
            <h4 className="font-semibold theme-text-primary truncate">{model.title}</h4>
            <div className="flex items-center gap-2 mt-1">
              {model.category && (
                <span className="text-xs px-2 py-0.5 rounded theme-bg-purple-accent theme-text-purple border border-purple-500/30">
                  {model.category}
                </span>
              )}
              {/* v1.33.4: Badge de similaridade para busca sem√¢ntica */}
              {model.similarity !== undefined && (
                <span className={`text-xs px-2 py-0.5 rounded font-medium animate-badge ${
                  model.similarity >= 0.7 ? 'bg-green-500/20 text-green-400' :
                  model.similarity >= 0.5 ? 'bg-yellow-500/20 text-yellow-400' :
                  'bg-gray-500/20 text-gray-400'
                }`}>
                  {Math.round(model.similarity * 100)}%
                </span>
              )}
              {/* v1.35.0: Badge de modelo compartilhado */}
              {isShared && ownerEmail && (
                <span className="text-xs px-2 py-0.5 rounded font-medium bg-purple-500/20 text-purple-400 animate-badge flex items-center gap-1">
                  <Users className="w-3 h-3" />
                  De: {ownerEmail.split('@')[0]}
                </span>
              )}
              {model.keywords && (() => {
                const kwArr = model.keywords.split(',');
                return (
                <span className="text-xs theme-text-muted truncate">
                  {kwArr[0].trim()}
                  {kwArr.length > 1 && ` +${kwArr.length - 1}`}
                </span>
              );})()}
            </div>
          </div>
        </div>
        {/* v1.35.0: Bot√µes adaptados para modelos compartilhados */}
        <div className="flex gap-2 flex-shrink-0">
          <button
            onClick={() => onEdit(model)}
            disabled={isShared && sharedPermission === 'view'}
            className={`p-2 rounded ${
              isShared && sharedPermission === 'view'
                ? 'cursor-not-allowed opacity-50'
                : 'hover-icon-blue-scale'
            }`}
            style={{
              color: isShared && sharedPermission === 'view' ? '#9ca3af' : '#60a5fa',
              transform: 'scale(1)'
            }}
            title={isShared && sharedPermission === 'view' ? 'Modelo compartilhado (somente leitura)' : 'Editar modelo'}
          >
            <Edit className="w-4 h-4" />
          </button>
          <button
            onClick={() => onDuplicate(model)}
            className="hover-icon-green-scale p-2 rounded"
            style={{
              color: '#4ade80',
              transform: 'scale(1)'
            }}
            title="Duplicar para sua biblioteca"
          >
            üìã
          </button>
          {/* v1.35.1: Mostrar excluir para modelos pr√≥prios OU compartilhados com permiss√£o edit */}
          {(!isShared || sharedPermission === 'edit') && (
            <button
              onClick={() => onDelete(model)}
              className="hover-icon-red-scale p-2 rounded"
              style={{
                color: '#f87171',
                transform: 'scale(1)'
              }}
              title={isShared ? 'Excluir modelo compartilhado (afeta o propriet√°rio)' : 'Excluir modelo'}
            >
              <Trash2 className="w-4 h-4" />
            </button>
          )}
        </div>
      </div>
    </div>
  );
});

// Display name para React DevTools
ModelCard.displayName = 'ModelCard';

// üìé COMPONENTE: ProofCard (v1.8.2) - Card de prova PDF/Texto
// v1.16.1: Adicionado anonymizationEnabled para desabilitar op√ß√µes incompat√≠veis
const ProofCard = React.memo(({
  proof,
  isPdf,
  proofManager,
  openModal,
  setError,
  extractTextFromPDFWithMode,
  anonymizationEnabled = false,
  anonConfig = null,
  nomesParaAnonimizar = [],
  editorTheme = 'dark', // v1.21.7: Para contraste correto do aviso de anonimiza√ß√£o
  setTextPreview // v1.21.16: Para preview de texto extra√≠do
}) => {
  // üÜï v1.12.27: Estado local para progresso de extra√ß√£o (em vez de setError global)
  const [extractionProgress, setExtractionProgress] = React.useState(null);
  // null = n√£o extraindo | { current: N, total: N, mode: 'pdfjs'|'claude-vision' } = em progresso

  // Handler: Remover v√≠nculo de t√≥pico
  const handleUnlinkTopic = React.useCallback((topicTitle) => {
    proofManager.setProofTopicLinks(prev => ({
      ...prev,
      [proof.id]: (prev[proof.id] || []).filter(t => t !== topicTitle)
    }));
  }, [proof.id, proofManager]);

  // Handler: Atualizar conclus√£o
  const handleConclusionChange = React.useCallback((e) => {
    proofManager.setProofConclusions(prev => ({
      ...prev,
      [proof.id]: e.target.value
    }));
  }, [proof.id, proofManager]);

  // Handler: Definir modo PDF
  const handleSetPdfMode = React.useCallback(() => {
    if (!proof.isPlaceholder) {
      proofManager.setProofUsePdfMode(prev => ({
        ...prev,
        [proof.id]: true
      }));
    }
  }, [proof.id, proof.isPlaceholder, proofManager]);

  // v1.21.5: Fun√ß√£o interna de extra√ß√£o (chamada diretamente ou ap√≥s modal de nomes)
  const executeExtraction = React.useCallback(async (nomesToUse = []) => {
    // v1.32.14: Bloquear apenas modos bin√°rios, permitir tesseract
    const userMode = proofManager.proofProcessingModes[proof.id] || 'pdfjs';
    const blockedModes = ['claude-vision', 'pdf-puro'];
    const selectedMode = (anonymizationEnabled && blockedModes.includes(userMode))
      ? 'pdfjs'
      : userMode;

    // Se modo √© 'pdf-puro', usar PDF bin√°rio diretamente
    if (selectedMode === 'pdf-puro') {
      proofManager.setProofUsePdfMode(prev => ({ ...prev, [proof.id]: true }));
      return;
    }

    proofManager.setProofUsePdfMode(prev => ({ ...prev, [proof.id]: false }));

    try {
      setExtractionProgress({ current: 0, total: 0, mode: selectedMode });
      const extractedText = await extractTextFromPDFWithMode(proof.file, selectedMode, (current, total) => {
        setExtractionProgress({ current, total, mode: selectedMode });
      });
      setExtractionProgress(null);

      if (extractedText && extractedText.trim().length > 0) {
        // v1.21.5: Usar nomes passados como par√¢metro (do modal ou existentes)
        const textToStore = (anonymizationEnabled && anonConfig)
          ? anonymizeText(extractedText, anonConfig, nomesToUse)
          : extractedText;
        proofManager.setExtractedProofTexts(prev => ({ ...prev, [proof.id]: textToStore }));
        proofManager.setProofExtractionFailed(prev => ({ ...prev, [proof.id]: false }));
      } else {
        proofManager.setProofExtractionFailed(prev => ({ ...prev, [proof.id]: true }));
        proofManager.setProofUsePdfMode(prev => ({ ...prev, [proof.id]: true }));
      }
    } catch (err) {
      setExtractionProgress(null);
      proofManager.setProofExtractionFailed(prev => ({ ...prev, [proof.id]: true }));
      proofManager.setProofUsePdfMode(prev => ({ ...prev, [proof.id]: true }));
    }
  }, [proof.id, proof.file, proofManager, extractTextFromPDFWithMode, anonymizationEnabled, anonConfig]);

  // Handler: Extrair texto do PDF
  // üÜï v1.12.20: Usa modo espec√≠fico da prova (proofProcessingModes)
  // üÜï v1.12.27: Usa estado local para progresso (n√£o mais setError global)
  // üÜï v1.21.5: Se anonimiza√ß√£o ativa, abre modal de nomes antes de extrair
  const handleExtractText = React.useCallback(async () => {
    if (proof.isPlaceholder) return;

    // v1.21.5: Se anonimiza√ß√£o ativa, abrir modal de nomes antes de extrair
    if (anonymizationEnabled && anonConfig) {
      proofManager.setPendingExtraction({ proofId: proof.id, proof, executeExtraction });
      openModal('proofExtractionAnonymization');
      return;
    }

    // Sem anonimiza√ß√£o: extrair diretamente
    await executeExtraction(nomesParaAnonimizar);
  }, [proof.id, proof.isPlaceholder, proofManager, openModal, anonymizationEnabled, anonConfig, nomesParaAnonimizar, executeExtraction]);

  // Handler: Abrir modal de an√°lise
  const handleAnalyze = React.useCallback(() => {
    proofManager.setProofToAnalyze({ ...proof, isPdf });
    openModal('proofAnalysis');
  }, [proof, isPdf, proofManager, openModal]);

  // Handler: Abrir modal de vincula√ß√£o
  const handleLink = React.useCallback(() => {
    proofManager.setProofToLink({ ...proof, isPdf });
    openModal('linkProof');
  }, [proof, isPdf, proofManager, openModal]);

  // Handler: Abrir modal de remo√ß√£o
  const handleDelete = React.useCallback(() => {
    proofManager.setProofToDelete({ ...proof, isPdf });
    openModal('deleteProof');
  }, [proof, isPdf, proofManager, openModal]);

  return (
    <div
      className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input hover-border-blue-500 transition-colors"
    >
      <div className="flex items-start justify-between gap-4">
        <div className="flex-1 min-w-0">
          {/* Cabe√ßalho - Nome + Badge de Tipo */}
          <div className="flex items-center gap-2 mb-2">
            <FileText className={`w-5 h-5 flex-shrink-0 ${isPdf ? 'text-red-400' : 'text-blue-400'}`} />
            <h5 className="font-medium theme-text-secondary truncate">{proof.name}</h5>
            <span className={`px-2 py-0.5 text-xs rounded ${
              isPdf
                ? 'theme-bg-red-accent theme-text-red'
                : 'theme-bg-blue-accent theme-text-blue'
            }`}>
              {isPdf ? 'PDF' : 'TEXTO'}
            </span>
            {isPdf && proof.isPlaceholder && (
              <span className="px-2 py-0.5 theme-bg-amber-accent theme-text-amber text-xs rounded" title="PDF original n√£o salvo, mas texto extra√≠do dispon√≠vel">
                Somente Texto
              </span>
            )}
            {/* Badge de modo de processamento (BIN√ÅRIO vs EXTRA√çDO) */}
            {/* v1.21.10: Mostrar "CONFLITO" quando anon ON + proofUsePdfMode true - requer clicar "Usar Texto" */}
            {/* v1.21.16: Cores ajustadas para tema claro */}
            {isPdf && !proof.isPlaceholder && (
              <span className={`px-2 py-0.5 text-xs rounded ${
                anonymizationEnabled && proofManager.proofUsePdfMode[proof.id]
                  ? editorTheme === 'light' ? 'bg-amber-100 text-amber-700 border border-amber-300' : 'bg-amber-600/20 text-amber-400 border border-amber-500/30'
                  : proofManager.proofUsePdfMode[proof.id]
                    ? editorTheme === 'light' ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'bg-blue-600/20 text-blue-400 border border-blue-500/30'
                    : editorTheme === 'light' ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-green-600/20 text-green-400 border border-green-500/30'
              }`} title={
                anonymizationEnabled && proofManager.proofUsePdfMode[proof.id]
                  ? 'Conflito: Modo PDF + anonimiza√ß√£o. Clique em "Usar Texto" para resolver.'
                  : proofManager.proofUsePdfMode[proof.id]
                    ? 'PDF bin√°rio ser√° enviado √† IA'
                    : 'Texto extra√≠do ser√° enviado √† IA'
              }>
                {anonymizationEnabled && proofManager.proofUsePdfMode[proof.id]
                  ? '‚ö†Ô∏è CONFLITO'
                  : proofManager.proofUsePdfMode[proof.id] ? 'üìÑ BIN√ÅRIO' : 'üìù EXTRA√çDO'}
              </span>
            )}
          </div>

          {/* Metadata - Tamanho/Caracteres + Data */}
          <div className="flex items-center gap-4 text-xs theme-text-muted mb-2">
            <span>{isPdf ? `${(proof.size / 1024).toFixed(1)} KB` : `${proof.text.length} caracteres`}</span>
            <span>{new Date(proof.uploadDate).toLocaleDateString('pt-BR')}</span>
          </div>

          {/* Alert para PDF Placeholder */}
          {isPdf && proof.isPlaceholder && (
            <div className="mb-3 text-xs text-amber-400 flex items-center gap-1">
              <AlertCircle className="w-3 h-3" />
              PDF original n√£o salvo (muito grande), mas texto extra√≠do est√° dispon√≠vel
            </div>
          )}

          {/* v1.21.6: Aviso para PDF com anonimiza√ß√£o ativa */}
          {/* v1.21.7: Contraste correto em ambos os temas */}
          {isPdf && anonymizationEnabled && !proofManager.extractedProofTexts[proof.id] && (
            <div className={`mb-3 p-2 rounded text-xs flex items-start gap-2 ${
              editorTheme === 'dark'
                ? 'bg-purple-600/20 border border-purple-500/30 text-purple-300'
                : 'bg-purple-100 border border-purple-300 text-purple-700'
            }`}>
              <AlertCircle className="w-4 h-4 flex-shrink-0" />
              <div>
                <span className="font-medium">üîí Anonimiza√ß√£o ativa:</span> Extraia o texto antes de usar no Assistente IA
              </div>
            </div>
          )}

          {/* Preview de Texto (apenas para tipo TEXTO) */}
          {!isPdf && (
            <p className="text-xs theme-text-muted line-clamp-2 mb-2">{proof.text.substring(0, 150)}...</p>
          )}

          {/* Toggle PDF/Texto - APENAS para PDFs */}
          {isPdf && (
            <div className="mt-3">
              <div className={CSS.flexGap2}>
                <button
                  onClick={handleSetPdfMode}
                  disabled={proof.isPlaceholder || extractionProgress || anonymizationEnabled}
                  className={`flex-1 px-3 py-2 rounded-lg text-xs font-medium transition-all ${
                    proof.isPlaceholder || extractionProgress || anonymizationEnabled
                      ? 'theme-bg-tertiary-30 theme-text-disabled cursor-not-allowed'
                      : proofManager.proofUsePdfMode[proof.id]
                      ? 'bg-blue-600 text-white shadow-lg hover-blue-700-from-600'
                      : 'theme-bg-tertiary-50 theme-text-muted hover-slate-600'
                  }`}
                  title={proof.isPlaceholder ? 'PDF original n√£o dispon√≠vel' : anonymizationEnabled ? 'üîí Anonimiza√ß√£o ativa: PDF bin√°rio bloqueado' : ''}
                >
                  üìÑ Usar PDF
                </button>
                <button
                  onClick={handleExtractText}
                  disabled={extractionProgress}
                  className={`flex-1 px-3 py-2 rounded-lg text-xs font-medium transition-all ${
                    extractionProgress
                      ? 'theme-bg-tertiary-30 theme-text-disabled cursor-not-allowed'
                      : proofManager.proofUsePdfMode[proof.id] && !proof.isPlaceholder
                      ? 'bg-green-600 text-white shadow-lg hover-green-700-from-600'
                      : 'theme-bg-tertiary-50 theme-text-muted hover-slate-600'
                  }`}
                >
                  {extractionProgress ? '‚è≥ Extraindo...' : 'üìù Extrair Texto'}
                </button>
              </div>

              {/* üÜï v1.12.20: Seletor de modo de processamento */}
              <div className="mt-2 flex items-center justify-end gap-2">
                <span className="text-xs theme-text-muted">Modo:</span>
                <ProcessingModeSelector
                  value={proofManager.proofProcessingModes[proof.id] || 'pdfjs'}
                  onChange={(mode) => proofManager.setProofProcessingModes(prev => ({
                    ...prev,
                    [proof.id]: mode
                  }))}
                  disabled={proofManager.isAnalyzingProof(proof.id) || extractionProgress}
                  anonymizationEnabled={anonymizationEnabled}
                />
              </div>

              {/* üÜï v1.12.27: Indicador de progresso de extra√ß√£o (inline) */}
              {extractionProgress && (
                <div className="mt-2 text-xs text-blue-400 flex items-center gap-2">
                  <Loader2 className="w-3 h-3 animate-spin" />
                  <span>
                    {extractionProgress.mode === 'claude-vision' ? 'üîç' : 'üìù'}
                    {extractionProgress.total > 0
                      ? ` Extraindo... ${extractionProgress.current}/${extractionProgress.total} p√°ginas`
                      : ' Iniciando extra√ß√£o...'}
                  </span>
                </div>
              )}

              {/* Indicador de texto extra√≠do - v1.21.16: clic√°vel para preview */}
              {!proofManager.proofUsePdfMode[proof.id] && proofManager.extractedProofTexts[proof.id] && (
                <div
                  className={`mt-2 text-xs flex items-center gap-1 cursor-pointer hover:underline ${editorTheme === 'light' ? 'text-green-600' : 'text-green-400'}`}
                  onClick={() => setTextPreview({ isOpen: true, title: proof.name, text: proofManager.extractedProofTexts[proof.id] })}
                >
                  <Check className="w-3 h-3" />
                  Texto extra√≠do com sucesso ({proofManager.extractedProofTexts[proof.id].length.toLocaleString()} caracteres)
                </div>
              )}

              {/* Indicador de extra√ß√£o falhada */}
              {proofManager.proofExtractionFailed[proof.id] && (
                <div className="mt-2 text-xs text-amber-400 flex items-center gap-1">
                  <AlertCircle className="w-3 h-3" />
                  PDF sem texto extra√≠vel (imagem) - usando PDF completo
                </div>
              )}
            </div>
          )}

          {/* Bot√£o: Analisar com IA */}
          {/* v1.21.10: Desabilitado tamb√©m quando anon ON + proofUsePdfMode true */}
          <div className="mt-3">
            <button
              onClick={handleAnalyze}
              disabled={proofManager.isAnalyzingProof(proof.id) || (anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]) || (anonymizationEnabled && isPdf && proofManager.proofUsePdfMode[proof.id])}
              className="w-full px-3 py-2 border border-blue-500/30 rounded-lg text-xs font-medium theme-text-blue flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed hover-blue-alpha-3-from-2 theme-bg-blue-accent transition-all duration-300"
            >
              {proofManager.isAnalyzingProof(proof.id) ? (
                <>
                  <Loader2 className="w-3 h-3 animate-spin" />
                  Analisando...
                </>
              ) : (
                <>
                  <Sparkles className="w-3 h-3" />
                  Analisar com IA
                </>
              )}
            </button>
          </div>

          {/* Bot√£o: Vincular a T√≥picos */}
          {/* v1.21.10: Desabilitado tamb√©m quando anon ON + proofUsePdfMode true */}
          <div className="mt-3">
            <button
              onClick={handleLink}
              disabled={(anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]) || (anonymizationEnabled && isPdf && proofManager.proofUsePdfMode[proof.id])}
              className={`w-full px-3 py-2 border rounded-lg text-xs font-medium flex items-center justify-center gap-2 transition-all duration-300 ${
                (anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]) || (anonymizationEnabled && isPdf && proofManager.proofUsePdfMode[proof.id])
                  ? 'border-gray-500/30 theme-text-disabled cursor-not-allowed opacity-50'
                  : 'border-purple-500/30 theme-text-purple hover-purple-alpha-3-from-2 theme-bg-purple-accent'
              }`}
            >
              <Scale className="w-3 h-3" />
              Vincular a T√≥picos
            </button>
          </div>

          {/* üÜï v1.19.2: Toggle para enviar conte√∫do completo √† IA */}
          {/* v1.21.8: Desabilitado quando anon ON + PDF + sem texto extra√≠do */}
          <div className="mt-3 flex items-center gap-2">
            <button
              onClick={() => {
                const isDisabled = anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id];
                if (!isDisabled) {
                  proofManager.setProofSendFullContent(prev => ({
                    ...prev,
                    [proof.id]: !prev[proof.id]
                  }));
                }
              }}
              disabled={anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]}
              className={`relative inline-flex h-5 w-9 items-center rounded-full transition-colors ${
                anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]
                  ? 'bg-gray-700 opacity-50 cursor-not-allowed'
                  : proofManager.proofSendFullContent[proof.id]
                    ? 'bg-green-500'
                    : 'bg-gray-600'
              }`}
            >
              <span className={`inline-block h-3 w-3 transform rounded-full bg-white transition-transform ${
                proofManager.proofSendFullContent[proof.id] ? 'translate-x-5' : 'translate-x-1'
              }`} />
            </button>
            <span className={`text-xs ${
              anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]
                ? 'theme-text-disabled'
                : 'theme-text-muted'
            }`}>
              Enviar conte√∫do completo √† IA
            </span>
          </div>

          {/* Resultado da An√°lise */}
          {proofManager.proofAnalysisResults[proof.id] && (
            <div className="mt-3 theme-info-box">
              <div className="flex items-center gap-2 mb-2">
                <Sparkles className="w-3 h-3 text-blue-400" />
                <span className="text-xs font-medium theme-text-blue">
                  An√°lise {proofManager.proofAnalysisResults[proof.id].type === 'livre' ? 'Livre' : 'Contextual'}
                </span>
              </div>
              <div className="overflow-y-auto" style={{ resize: 'vertical', height: '16rem', minHeight: '10rem', maxHeight: '40rem' }}>
                <p className="text-xs theme-text-tertiary whitespace-pre-wrap">
                  {proofManager.proofAnalysisResults[proof.id].result}
                </p>
              </div>
            </div>
          )}

          {/* Conclus√µes Manuais */}
          <div className="mt-3">
            <label className="block text-xs font-medium theme-text-muted mb-2">
              ‚úçÔ∏è Minhas Conclus√µes:
            </label>
            <textarea
              value={proofManager.proofConclusions[proof.id] || ''}
              onChange={handleConclusionChange}
              placeholder="Adicione suas conclus√µes sobre esta prova..."
              rows={3}
              className="w-full px-3 py-2 theme-bg-secondary-50 border theme-border-input rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent theme-text-secondary text-xs resize-none"
            />
          </div>

          {/* Badges de T√≥picos Vinculados */}
          {proofManager.proofTopicLinks[proof.id] && proofManager.proofTopicLinks[proof.id].length > 0 && (
            <div className="mt-3">
              <p className="text-xs theme-text-muted mb-2">Vinculado a:</p>
              <div className="flex flex-wrap gap-1">
                {proofManager.proofTopicLinks[proof.id].map((topicTitle, idx) => (
                  <span
                    key={idx}
                    className="inline-flex items-center gap-1 px-2 py-1 theme-bg-purple-accent theme-text-purple text-xs rounded border border-purple-500/30"
                  >
                    {topicTitle}
                    <button
                      onClick={() => handleUnlinkTopic(topicTitle)}
                      className="hover-text-red-400 transition-colors"
                    >
                      √ó
                    </button>
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* Bot√£o Remover */}
        <button
          onClick={handleDelete}
          className="p-2 rounded-lg hover-delete-proof"
        >
          <Trash2 className="w-4 h-4 text-red-400" />
        </button>
      </div>
    </div>
  );
});

// Display name para React DevTools
ProofCard.displayName = 'ProofCard';

const JurisprudenciaCard = React.memo(({ precedente, onCopy, expanded, onToggleExpand }) => {
  const texto = precedente.tese || precedente.enunciado || '';
  const tesePreview = texto.length > 200 ? texto.slice(0, 200) + '...' : texto;
  const renderIdentificador = () => {
    if (precedente.tema) {
      return <span className="text-xs theme-text-muted ml-2">Tema {precedente.tema}</span>;
    }
    if (precedente.tipoProcesso === 'S√∫mula' || precedente.tipoProcesso === 'OJ') {
      return <span className="text-xs theme-text-muted ml-2">n¬∫ {precedente.numero}</span>;
    }
    return null;
  };
  return (
    <div className="theme-bg-secondary p-4 rounded-lg border theme-border-secondary">
      <div className="flex justify-between items-start mb-2">
        <div className="flex items-center gap-2">
          <span className="text-xs px-2 py-0.5 rounded theme-bg-tertiary theme-text-tertiary">
            {precedente.tipoProcesso}
          </span>
          {renderIdentificador()}
        </div>
        <div className="flex items-center gap-1">
          {precedente.status && (
            <span className={`text-xs px-2 py-0.5 rounded ${
              isStatusValido(precedente.status)
                ? 'theme-badge-success'
                : 'theme-badge-error'
            }`}>
              {isStatusValido(precedente.status) ? '‚úì' : '‚úó'} {precedente.status.replace(/_/g, ' ')}
            </span>
          )}
          {precedente.orgao && (
            <span className="text-xs px-2 py-0.5 rounded theme-badge-purple">
              {precedente.orgao}
            </span>
          )}
          {precedente.tribunal && (
            <span className="text-xs px-2 py-0.5 rounded theme-badge-blue">
              {precedente.tribunal}
            </span>
          )}
          <button onClick={() => onCopy(precedente)} className="p-1.5 rounded hover-icon-blue-scale" title="Copiar tese">
            <Copy className="w-4 h-4" />
          </button>
        </div>
      </div>
      {precedente.titulo && (
        <h4 className="font-semibold theme-text-primary text-sm mb-1 uppercase">{precedente.titulo}</h4>
      )}
      {precedente.numeroProcesso && (
        <h4 className="font-medium theme-text-primary text-sm mb-1">{precedente.numeroProcesso}</h4>
      )}
      {(precedente.relator || precedente.dataJulgamento || precedente.dataAprovacao) && (
        <p className="text-xs theme-text-muted mb-2">
          {precedente.relator && `Rel: ${precedente.relator}`}
          {precedente.relator && (precedente.dataJulgamento || precedente.dataAprovacao) && ' | '}
          {precedente.dataJulgamento || precedente.dataAprovacao}
        </p>
      )}
      <p className={`text-sm theme-text-secondary ${precedente.status && !isStatusValido(precedente.status) ? 'line-through opacity-70' : ''}`}>
        {expanded ? texto : tesePreview}
      </p>
      {texto.length > 200 && (
        <button
          onClick={() => onToggleExpand(precedente.id)}
          className="text-xs text-purple-500 mt-2 hover-text-purple-400"
        >
          {expanded ? 'Recolher' : 'Expandir'}
        </button>
      )}
    </div>
  );
});
JurisprudenciaCard.displayName = 'JurisprudenciaCard';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìú COMPONENTE: ArtigoCard - Card de exibi√ß√£o de artigo de lei
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ArtigoCard = React.memo(({ artigo, onCopy, expanded, onToggleExpand, copiedId }) => {
  const lei = getLeiFromId(artigo.id);
  const hasDetails = (artigo.paragrafos?.length > 0) || (artigo.incisos?.length > 0) || (artigo.alineas?.length > 0);
  const isCopied = copiedId === artigo.id;

  return (
    <div className="theme-bg-secondary rounded-lg p-3 border theme-border-subtle">
      <div className="flex justify-between items-start gap-2">
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 flex-wrap mb-1">
            <span className="px-2 py-0.5 rounded text-xs font-medium bg-blue-500/20 text-blue-400">
              {lei.nome}
            </span>
            <span className="font-semibold text-sm theme-text-primary">
              Art. {artigo.numero}
            </span>
            {artigo.status === 'revogado' && (
              <span className="px-1.5 py-0.5 rounded text-xs bg-red-500/20 text-red-400">
                Revogado
              </span>
            )}
          </div>
          <p className="text-sm theme-text-secondary line-clamp-3">
            {artigo.caput}
          </p>
        </div>
        <div className="flex gap-1">
          {hasDetails && (
            <button
              onClick={() => onToggleExpand(artigo.id)}
              className="p-1.5 rounded hover-bg-blue-opacity text-blue-400"
              title={expanded ? 'Recolher' : 'Expandir'}
            >
              {expanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
            </button>
          )}
          <button
            onClick={() => onCopy(artigo)}
            className={`p-1.5 rounded transition-colors ${isCopied ? 'bg-green-500/20 text-green-400' : 'hover-bg-blue-opacity text-blue-400'}`}
            title={isCopied ? 'Copiado!' : 'Copiar artigo'}
          >
            {isCopied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
          </button>
        </div>
      </div>

      {expanded && hasDetails && (
        <div className="mt-3 pt-3 border-t theme-border-subtle text-sm space-y-2">
          {artigo.paragrafos?.length > 0 && (
            <div>
              <span className="text-xs font-medium text-purple-400 block mb-1">Par√°grafos:</span>
              {artigo.paragrafos.map((p, i) => (
                <p key={i} className="theme-text-secondary ml-2 mb-1">
                  <span className="text-purple-300">¬ß {p.numero}¬∫</span> {p.texto}
                </p>
              ))}
            </div>
          )}
          {artigo.incisos?.length > 0 && (
            <div>
              <span className="text-xs font-medium text-amber-400 block mb-1">Incisos:</span>
              {artigo.incisos.map((inc, i) => (
                <p key={i} className="theme-text-secondary ml-2 mb-1">
                  <span className="text-amber-300">{inc.numero}</span> - {inc.texto}
                </p>
              ))}
            </div>
          )}
          {artigo.alineas?.length > 0 && (
            <div>
              <span className="text-xs font-medium text-teal-400 block mb-1">Al√≠neas:</span>
              {artigo.alineas.map((al, i) => (
                <p key={i} className="theme-text-secondary ml-2 mb-1">
                  <span className="text-teal-300">{al.letra})</span> {al.texto}
                </p>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
});
ArtigoCard.displayName = 'ArtigoCard';

// v1.20.3: Adicionado isReadOnly para modo somente leitura em aba secund√°ria
// v1.27.00: Adicionado busca sem√¢ntica
const JurisprudenciaTab = React.memo(({
  openModal, closeModal, modals, isReadOnly = false,
  // v1.27.00: Props para busca sem√¢ntica
  jurisSemanticEnabled = false,
  searchModelReady = false,
  jurisEmbeddingsCount = 0,
  jurisSemanticThreshold = 50
}) => {
  const jurisprudencia = useJurisprudencia();
  const [expandedIds, setExpandedIds] = React.useState(new Set());
  const [importStatus, setImportStatus] = React.useState(null);
  const fileInputRef = React.useRef(null);

  // v1.27.00: Estados para busca sem√¢ntica (usa scroll, n√£o pagina√ß√£o)
  // v1.28.01: Usa toggle global como padr√£o se n√£o houver valor no localStorage
  const [useSemanticSearch, setUseSemanticSearch] = React.useState(() => {
    try {
      const stored = localStorage.getItem('jurisSemanticMode');
      if (stored !== null) return stored === 'true';
      return jurisSemanticEnabled; // Usa toggle global como fallback
    } catch { return false; }
  });
  const [semanticResults, setSemanticResults] = React.useState(null);
  const [searchingSemantics, setSearchingSemantics] = React.useState(false);

  // Busca sem√¢ntica dispon√≠vel se: toggle global ativo + modelo pronto + embeddings gerados
  const semanticAvailable = jurisSemanticEnabled && searchModelReady && jurisEmbeddingsCount > 0;

  // v1.27.00: Handler para busca sem√¢ntica de jurisprud√™ncia
  const performSemanticSearch = React.useCallback(async (query) => {
    if (!query || query.length < 3 || !semanticAvailable) {
      setSemanticResults(null);
      return;
    }

    setSearchingSemantics(true);
    try {
      // v1.32.20: toLowerCase para E5 case-sensitive
      const queryEmbedding = await AIModelService.getEmbedding(query.toLowerCase(), 'query');
      const threshold = jurisSemanticThreshold / 100;
      // v1.32.21: Passar filtros para aplicar ANTES do limit (retorna at√© 30 do tipo desejado)
      const results = await JurisEmbeddingsService.searchBySimilarity(queryEmbedding, threshold, 30, jurisprudencia.filtros);

      setSemanticResults(results);
    } catch (err) {
      console.error('[Juris Semantic] Erro na busca:', err);
      setSemanticResults(null);
    } finally {
      setSearchingSemantics(false);
    }
  }, [semanticAvailable, jurisSemanticThreshold, jurisprudencia.filtros]);

  // v1.27.00: Debounce para busca sem√¢ntica
  const semanticSearchTimeoutRef = React.useRef(null);
  React.useEffect(() => {
    if (useSemanticSearch && semanticAvailable && jurisprudencia.searchTerm) {
      clearTimeout(semanticSearchTimeoutRef.current);
      semanticSearchTimeoutRef.current = setTimeout(() => {
        performSemanticSearch(jurisprudencia.searchTerm);
      }, 500);
    } else {
      setSemanticResults(null);
    }
    return () => clearTimeout(semanticSearchTimeoutRef.current);
  }, [jurisprudencia.searchTerm, useSemanticSearch, semanticAvailable, performSemanticSearch, jurisprudencia.filtros]);

  const handleToggleExpand = React.useCallback((id) => {
    setExpandedIds(prev => {
      const next = new Set(prev);
      next.has(id) ? next.delete(id) : next.add(id);
      return next;
    });
  }, []);

  const handleFileSelect = React.useCallback(async (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;
    let totalCount = 0;
    let errors = [];
    for (const file of files) {
      const result = await jurisprudencia.handleImportJSON(file);
      if (result.success) {
        totalCount += result.count;
      } else {
        errors.push(file.name);
      }
    }
    const status = errors.length === 0
      ? { success: true, count: totalCount, message: `${files.length} arquivo(s), ${totalCount} itens` }
      : { success: false, error: `Erro em: ${errors.join(', ')}` };
    setImportStatus(status);
    setTimeout(() => setImportStatus(null), 4000);
    e.target.value = '';
  }, [jurisprudencia]);

  const tiposDisponiveis = ['IRR', 'IAC', 'IRDR', 'S√∫mula', 'OJ', 'RG', 'ADI/ADC/ADPF', 'Informativo'];
  const tribunaisDisponiveis = ['TST', 'STF', 'STJ', 'TRT8'];

  return (
    <div className="h-full flex flex-col">
      <div className="flex gap-3 mb-4">
        <div className="flex-1 relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 theme-text-muted" />
          <input
            type="text"
            placeholder={useSemanticSearch ? "Buscar por significado (ex: intervalo intrajornada)..." : "Buscar por tese, keywords ou n√∫mero..."}
            value={jurisprudencia.searchTerm}
            onChange={jurisprudencia.handleSearchChange}
            onKeyDown={(e) => e.key === 'Escape' && jurisprudencia.handleSearchChange({ target: { value: '' } })}
            className="w-full pl-10 pr-12 py-2 border theme-input rounded-lg text-sm"
          />
          {jurisprudencia.searchTerm && !searchingSemantics && (
            <button onClick={() => jurisprudencia.handleSearchChange({ target: { value: '' } })} className="absolute right-3 top-1/2 -translate-y-1/2 p-0.5 theme-text-muted hover-text-primary" title="Limpar (Esc)">
              <X className="w-3.5 h-3.5" />
            </button>
          )}
          {searchingSemantics && (
            <RefreshCw className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-purple-400 animate-spin" />
          )}
        </div>
        {/* v1.27.00: Toggle de busca sem√¢ntica */}
        {/* v1.33.8: Adicionado hover:bg-purple-700 ao estado sem√¢ntico */}
        {semanticAvailable && (
          <button
            onClick={() => setUseSemanticSearch(prev => !prev)}
            className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5 ${
              useSemanticSearch
                ? 'bg-purple-600 text-white hover:bg-purple-700'
                : 'theme-bg-tertiary theme-text-secondary hover-slate-600'
            }`}
            title={useSemanticSearch ? 'Busca sem√¢ntica (por significado)' : 'Busca textual (por palavras)'}
          >
            {useSemanticSearch ? 'üß†' : 'üî§'}
          </button>
        )}
        {/* v1.20.3: Badge de somente leitura */}
        {isReadOnly && (
          <span className="flex items-center gap-1 px-3 py-2 text-xs text-amber-400 bg-amber-500/10 rounded-lg border border-amber-500/30">
            <Eye className="w-3 h-3" />
            Somente leitura
          </span>
        )}
        <button
          onClick={() => fileInputRef.current?.click()}
          disabled={jurisprudencia.isLoading || isReadOnly}
          className={`px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium disabled:opacity-50 hover-purple-700 ${isReadOnly ? 'cursor-not-allowed' : ''}`}
          title={isReadOnly ? 'Importa√ß√£o desabilitada no modo somente leitura' : 'Importar precedentes de arquivo JSON'}
        >
          <Upload className="w-4 h-4 inline mr-2" />
          Importar JSON
        </button>
        {jurisprudencia.precedentes.length > 0 && !isReadOnly && (
          <button
            onClick={() => openModal('deleteAllPrecedentes')}
            className="p-2 rounded hover-delete-all"
            title="Excluir todos os precedentes"
          >
            <Trash2 className="w-5 h-5 text-red-400" />
          </button>
        )}
        <input ref={fileInputRef} type="file" accept=".json" multiple onChange={handleFileSelect} className="hidden" disabled={isReadOnly} />
      </div>

      {importStatus && (
        <div className={`mb-3 p-2 rounded text-xs ${importStatus.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
          {importStatus.success ? (importStatus.message || `${importStatus.count} precedentes importados`) : importStatus.error}
        </div>
      )}

      <div className="flex flex-wrap justify-between gap-y-2 mb-4">
        <div className="flex gap-2 flex-wrap">
          {tiposDisponiveis.map(tipo => (
            <button
              key={tipo}
              onClick={() => jurisprudencia.setFiltros(prev => ({
                ...prev,
                tipo: prev.tipo.includes(tipo)
                  ? prev.tipo.filter(t => t !== tipo)
                  : [...prev.tipo, tipo]
              }))}
              className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
                jurisprudencia.filtros.tipo.includes(tipo)
                  ? 'bg-purple-600 text-white'
                  : 'theme-bg-tertiary theme-text-tertiary hover-slate-600'
              }`}
            >
              {tipo}
            </button>
          ))}
        </div>
        <div className="flex gap-2 flex-wrap">
          {tribunaisDisponiveis.map(trib => (
            <button
              key={trib}
              onClick={() => jurisprudencia.setFiltros(prev => ({
                ...prev,
                tribunal: prev.tribunal?.includes(trib)
                  ? prev.tribunal.filter(t => t !== trib)
                  : [...(prev.tribunal || []), trib]
              }))}
              className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
                jurisprudencia.filtros.tribunal?.includes(trib)
                  ? 'bg-blue-600 text-white'
                  : 'theme-bg-tertiary theme-text-tertiary hover-slate-600'
              }`}
            >
              {trib}
            </button>
          ))}
        </div>
      </div>

      <div className="text-xs theme-text-muted mb-3">
        {useSemanticSearch && semanticResults ? (
          <span>{semanticResults.length} resultado(s) sem√¢ntico(s) üß†</span>
        ) : (
          <span>{jurisprudencia.filteredCount} precedentes encontrados</span>
        )}
      </div>

      <div className="flex-1 overflow-y-auto space-y-3 pr-1">
        {/* v1.27.00: Resultados sem√¢nticos */}
        {useSemanticSearch && semanticResults && semanticResults.length > 0 ? (
          semanticResults.map((result, idx) => (
            <div key={result.id || idx} className="theme-bg-secondary p-4 rounded-lg border theme-border-secondary">
              <div className="flex justify-between items-start mb-2">
                <div className="flex items-center gap-2 flex-wrap">
                  <span className="text-xs px-2 py-0.5 rounded theme-bg-tertiary theme-text-tertiary font-medium">
                    {result.tipoProcesso}
                  </span>
                  {result.numero && (
                    <span className="text-xs theme-text-muted">
                      {result.tipoProcesso === 'S√∫mula' || result.tipoProcesso === 'OJ' ? `n¬∫ ${result.numero}` : `Tema ${result.numero}`}
                    </span>
                  )}
                  <span className={`text-xs px-2 py-0.5 rounded font-medium ${
                    result.similarity >= 0.7 ? 'bg-green-500/20 text-green-400' :
                    result.similarity >= 0.5 ? 'bg-yellow-500/20 text-yellow-400' :
                    'bg-gray-500/20 text-gray-400'
                  }`}>
                    {Math.round(result.similarity * 100)}%
                  </span>
                  {result.totalChunks > 1 && (
                    <span className="text-xs theme-text-muted">(chunk {result.chunkIndex + 1}/{result.totalChunks})</span>
                  )}
                </div>
                <div className="flex items-center gap-1">
                  {result.tribunal && (
                    <span className="text-xs px-2 py-0.5 rounded bg-blue-500/20 text-blue-400">{result.tribunal}</span>
                  )}
                  <button
                    onClick={() => jurisprudencia.handleCopyTese({
                      tipoProcesso: result.tipoProcesso,
                      numero: result.numero,
                      titulo: result.titulo,
                      tese: result.fullText || result.text
                    })}
                    className="p-1.5 rounded hover-icon-blue-scale"
                    title="Copiar tese completa"
                  >
                    <Copy className="w-4 h-4" />
                  </button>
                </div>
              </div>
              {result.titulo && (
                <h4 className="font-semibold theme-text-primary text-sm mb-2 uppercase">{result.titulo}</h4>
              )}
              <p className="text-sm theme-text-secondary whitespace-pre-wrap">
                {result.fullText || result.text}
              </p>
            </div>
          ))
        ) : useSemanticSearch && semanticResults && semanticResults.length === 0 ? (
          <div className="text-center py-8 theme-text-muted">
            <Search className="w-12 h-12 mx-auto mb-3 opacity-40 animate-pulse" />
            <p className="text-sm">Nenhum resultado sem√¢ntico encontrado</p>
            <p className="text-xs mt-1">Tente reduzir o threshold nas configura√ß√µes</p>
          </div>
        ) : jurisprudencia.paginatedPrecedentes.length === 0 ? (
          <div className="text-center py-8 theme-text-muted">
            <Scale className="w-12 h-12 mx-auto mb-3 opacity-40 animate-pulse" />
            <p className="text-sm">Nenhum precedente encontrado</p>
            <p className="text-xs mt-1">Importe um arquivo JSON para come√ßar</p>
          </div>
        ) : (
          jurisprudencia.paginatedPrecedentes.map(p => (
            <JurisprudenciaCard
              key={p.id}
              precedente={p}
              expanded={expandedIds.has(p.id)}
              onToggleExpand={handleToggleExpand}
              onCopy={jurisprudencia.handleCopyTese}
            />
          ))
        )}
      </div>

      {/* Pagina√ß√£o s√≥ para busca textual (sem√¢ntica usa scroll) */}
      {!useSemanticSearch && jurisprudencia.totalPages > 1 && (
        <div className="flex justify-center items-center gap-2 mt-4 pt-4 border-t theme-border-secondary">
          <button
            disabled={jurisprudencia.currentPage === 1}
            onClick={() => jurisprudencia.setCurrentPage(p => p - 1)}
            className="px-3 py-1 rounded theme-bg-tertiary text-sm disabled:opacity-50 hover-slate-600"
          >
            Anterior
          </button>
          <span className="px-3 py-1 theme-text-muted text-sm">
            {jurisprudencia.currentPage} / {jurisprudencia.totalPages}
          </span>
          <button
            disabled={jurisprudencia.currentPage === jurisprudencia.totalPages}
            onClick={() => jurisprudencia.setCurrentPage(p => p + 1)}
            className="px-3 py-1 rounded theme-bg-tertiary text-sm disabled:opacity-50 hover-slate-600"
          >
            Pr√≥xima
          </button>
        </div>
      )}

      <DeleteAllPrecedentesModal
        isOpen={modals.deleteAllPrecedentes}
        onClose={() => closeModal('deleteAllPrecedentes')}
        totalPrecedentes={jurisprudencia.precedentes.length}
        confirmText={jurisprudencia.deleteAllConfirmText}
        setConfirmText={jurisprudencia.setDeleteAllConfirmText}
        onConfirmDelete={async () => {
          if (jurisprudencia.deleteAllConfirmText === 'EXCLUIR') {
            await jurisprudencia.handleClearAll();
            closeModal('deleteAllPrecedentes');
            jurisprudencia.setDeleteAllConfirmText('');
          }
        }}
      />
    </div>
  );
});
JurisprudenciaTab.displayName = 'JurisprudenciaTab';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìú COMPONENTE: LegislacaoTab - Aba de consulta de legisla√ß√£o
// v1.20.3: Adicionado isReadOnly para modo somente leitura em aba secund√°ria
// v1.26.00: Adicionado busca sem√¢ntica
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LegislacaoTab = React.memo(({
  openModal, closeModal, modals, isReadOnly = false,
  // v1.26.00: Props para busca sem√¢ntica
  semanticSearchEnabled = false,
  searchModelReady = false,
  embeddingsCount = 0,
  semanticThreshold = 50
}) => {
  const legislacao = useLegislacao();
  const [expandedIds, setExpandedIds] = React.useState(new Set());
  const [importStatus, setImportStatus] = React.useState(null);
  const fileInputRef = React.useRef(null);
  // v1.26.00: Toggle local de busca sem√¢ntica (modo de busca)
  // v1.28.01: Usa toggle global como padr√£o se n√£o houver valor no localStorage
  const [useSemanticSearch, setUseSemanticSearch] = React.useState(() => {
    try {
      const stored = localStorage.getItem('legislacaoSemanticMode');
      if (stored !== null) return stored === 'true';
      return semanticSearchEnabled; // Usa toggle global como fallback
    } catch { return false; }
  });
  const [semanticResults, setSemanticResults] = React.useState(null);
  const [searchingSemantics, setSearchingSemantics] = React.useState(false);

  // Busca sem√¢ntica dispon√≠vel se: toggle global ativo + modelo pronto + embeddings gerados
  const semanticAvailable = semanticSearchEnabled && searchModelReady && embeddingsCount > 0;

  // v1.26.00: Handler para busca sem√¢ntica
  const performSemanticSearch = React.useCallback(async (query) => {
    if (!query || query.length < 3 || !semanticAvailable) {
      setSemanticResults(null);
      return;
    }

    setSearchingSemantics(true);
    try {
      // v1.32.20: toLowerCase para E5 case-sensitive
      const queryEmbedding = await AIModelService.getEmbedding(query.toLowerCase(), 'query');
      const threshold = semanticThreshold / 100; // Converter para 0-1
      const results = await EmbeddingsService.searchBySimilarity(queryEmbedding, threshold, 30);
      setSemanticResults(results);
    } catch (err) {
      console.error('[Semantic] Erro na busca:', err);
      setSemanticResults(null);
    } finally {
      setSearchingSemantics(false);
    }
  }, [semanticAvailable, semanticThreshold]);

  // v1.26.00: Debounce para busca sem√¢ntica
  const semanticSearchTimeoutRef = React.useRef(null);
  React.useEffect(() => {
    if (useSemanticSearch && semanticAvailable && legislacao.searchTerm) {
      clearTimeout(semanticSearchTimeoutRef.current);
      semanticSearchTimeoutRef.current = setTimeout(() => {
        performSemanticSearch(legislacao.searchTerm);
      }, 500);
    } else {
      setSemanticResults(null);
    }
    return () => clearTimeout(semanticSearchTimeoutRef.current);
  }, [legislacao.searchTerm, useSemanticSearch, semanticAvailable, performSemanticSearch]);

  const handleToggleExpand = React.useCallback((id) => {
    setExpandedIds(prev => {
      const next = new Set(prev);
      next.has(id) ? next.delete(id) : next.add(id);
      return next;
    });
  }, []);

  const handleFileSelect = React.useCallback(async (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;
    let totalCount = 0;
    let errors = [];
    for (const file of files) {
      const result = await legislacao.handleImportJSON(file);
      if (result.success) {
        totalCount += result.count;
      } else {
        errors.push(`${file.name}: ${result.error}`);
      }
    }
    const status = errors.length === 0
      ? { success: true, message: `${totalCount} artigos importados de ${files.length} arquivo(s)` }
      : { success: false, error: errors.join('; ') };
    setImportStatus(status);
    setTimeout(() => setImportStatus(null), 4000);
    e.target.value = '';
  }, [legislacao]);

  return (
    <div className="h-full flex flex-col">
      <div className="flex gap-3 mb-4">
        <div className="flex-1 relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 theme-text-muted" />
          <input
            type="text"
            placeholder={useSemanticSearch ? "Buscar por significado (ex: demiss√£o sem justa causa)..." : "Buscar por n√∫mero (ex: 7) ou texto (ex: f√©rias)..."}
            value={legislacao.searchTerm}
            onChange={(e) => legislacao.setSearchTerm(e.target.value)}
            onKeyDown={(e) => e.key === 'Escape' && legislacao.setSearchTerm('')}
            className="w-full pl-10 pr-12 py-2 border theme-input rounded-lg text-sm"
          />
          {legislacao.searchTerm && !searchingSemantics && (
            <button onClick={() => legislacao.setSearchTerm('')} className="absolute right-3 top-1/2 -translate-y-1/2 p-0.5 theme-text-muted hover-text-primary" title="Limpar (Esc)">
              <X className="w-3.5 h-3.5" />
            </button>
          )}
          {searchingSemantics && (
            <RefreshCw className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-blue-400 animate-spin" />
          )}
        </div>
        {/* v1.26.00: Toggle de busca sem√¢ntica */}
        {/* v1.33.8: Adicionado hover:bg-purple-700 ao estado sem√¢ntico */}
        {semanticAvailable && (
          <button
            onClick={() => setUseSemanticSearch(prev => !prev)}
            className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5 ${
              useSemanticSearch
                ? 'bg-purple-600 text-white hover:bg-purple-700'
                : 'theme-bg-tertiary theme-text-secondary hover-bg-purple-opacity'
            }`}
            title={useSemanticSearch ? 'Busca sem√¢ntica (por significado)' : 'Busca textual (por palavras)'}
          >
            {useSemanticSearch ? 'üß†' : 'üî§'}
          </button>
        )}
        {/* v1.20.3: Badge de somente leitura */}
        {isReadOnly && (
          <span className="flex items-center gap-1 px-3 py-2 text-xs text-amber-400 bg-amber-500/10 rounded-lg border border-amber-500/30">
            <Eye className="w-3 h-3" />
            Somente leitura
          </span>
        )}
        <button
          onClick={() => fileInputRef.current?.click()}
          disabled={legislacao.isLoading || isReadOnly}
          className={`px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium disabled:opacity-50 hover-blue-700 ${isReadOnly ? 'cursor-not-allowed' : ''}`}
          title={isReadOnly ? 'Importa√ß√£o desabilitada no modo somente leitura' : 'Importar artigos de arquivo JSON'}
        >
          <Upload className="w-4 h-4 inline mr-2" />
          Importar JSON
        </button>
        {legislacao.artigos.length > 0 && !isReadOnly && (
          <button
            onClick={() => openModal('deleteAllLegislacao')}
            className="p-2 rounded hover-delete-all"
            title="Excluir toda legisla√ß√£o"
          >
            <Trash2 className="w-5 h-5 text-red-400" />
          </button>
        )}
        <input ref={fileInputRef} type="file" accept=".json" multiple onChange={handleFileSelect} className="hidden" disabled={isReadOnly} />
      </div>

      {importStatus && (
        <div className={`mb-3 p-2 rounded text-xs ${importStatus.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
          {importStatus.success ? importStatus.message : importStatus.error}
        </div>
      )}

      {legislacao.leisDisponiveis.length > 0 && (
        <div className="flex flex-wrap gap-2 mb-4">
          <button
            onClick={() => legislacao.setLeiAtiva(null)}
            className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
              !legislacao.leiAtiva
                ? 'bg-blue-600 text-white'
                : 'theme-bg-tertiary theme-text-secondary hover-bg-blue-opacity'
            }`}
          >
            Todas ({legislacao.artigos.length})
          </button>
          {legislacao.leisDisponiveis.map(lei => {
            const meta = LEIS_METADATA[lei] || { nome: lei.toUpperCase() };
            const count = legislacao.artigos.filter(a => a.lei === lei || a.id?.startsWith(lei + '-')).length;
            return (
              <button
                key={lei}
                onClick={() => legislacao.setLeiAtiva(legislacao.leiAtiva === lei ? null : lei)}
                className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
                  legislacao.leiAtiva === lei
                    ? 'bg-blue-600 text-white'
                    : 'theme-bg-tertiary theme-text-secondary hover-bg-blue-opacity'
                }`}
                title={meta.nomeCompleto || lei}
              >
                {meta.nome} ({count})
              </button>
            );
          })}
        </div>
      )}

      {/* v1.26.00: Resultados - Sem√¢nticos ou Textuais */}
      <div className="flex-1 overflow-hidden">
        {legislacao.isLoading ? (
          <div className="flex items-center justify-center py-12">
            <div className="animate-spin w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full" />
          </div>
        ) : useSemanticSearch && semanticResults && semanticResults.length > 0 ? (
          /* v1.26.01: Resultados sem√¢nticos com artigo completo e destaque */
          <div className="space-y-3 overflow-y-auto h-full pr-1">
            {semanticResults
              .filter(item => !legislacao.leiAtiva || item.lei === legislacao.leiAtiva)
              .map((item, idx) => {
              const artigo = legislacao.artigos.find(a => a.id === item.artigoId);
              if (!artigo) return null;
              const hasDetails = (artigo.paragrafos?.length > 0) || (artigo.incisos?.length > 0) || (artigo.alineas?.length > 0);
              const isMatchedType = (type) => item.type === type;
              const isMatchedParagrafo = (p) => item.type === 'paragrafo' && item.text.includes(p.texto?.slice(0, 50));
              const isMatchedInciso = (inc) => item.type === 'inciso' && item.text.includes(inc.texto?.slice(0, 50));
              const isMatchedAlinea = (al) => item.type === 'alinea' && item.text.includes(al.texto?.slice(0, 50));
              return (
                <div key={`${item.id}-${idx}`} className="theme-bg-secondary-50 rounded-lg p-3 border theme-border-input">
                  <div className="flex items-start justify-between gap-2 mb-2">
                    <div className="flex items-center gap-2 flex-wrap">
                      <span className="px-2 py-0.5 bg-purple-600/20 text-purple-400 text-xs rounded font-medium">
                        {Math.round(item.similarity * 100)}% similar
                      </span>
                      <span className="text-xs theme-text-muted uppercase">{item.lei}</span>
                      <span className="text-xs font-medium theme-text-primary">Art. {item.numero}</span>
                      <span className="text-xs theme-text-muted capitalize">({item.type})</span>
                    </div>
                    <button
                      onClick={() => legislacao.handleCopyArtigo(artigo)}
                      className="p-1 text-blue-400 hover-text-blue-300"
                      title="Copiar artigo completo"
                    >
                      <Copy className="w-3 h-3" />
                    </button>
                  </div>
                  <p className={`text-sm theme-text-secondary ${isMatchedType('caput') ? 'font-semibold bg-yellow-500/10 px-1 rounded' : ''}`}>
                    {artigo.caput}
                  </p>
                  {hasDetails && (
                    <div className="mt-2 pt-2 border-t theme-border-subtle text-sm space-y-2">
                      {artigo.paragrafos?.length > 0 && (
                        <div>
                          {artigo.paragrafos.map((p, i) => (
                            <p key={i} className={`theme-text-secondary ml-2 mb-1 ${isMatchedParagrafo(p) ? 'font-semibold bg-yellow-500/10 px-1 rounded' : ''}`}>
                              <span className="text-purple-400">¬ß {p.numero}¬∫</span> {p.texto}
                            </p>
                          ))}
                        </div>
                      )}
                      {artigo.incisos?.length > 0 && (
                        <div>
                          {artigo.incisos.map((inc, i) => (
                            <p key={i} className={`theme-text-secondary ml-2 mb-1 ${isMatchedInciso(inc) ? 'font-semibold bg-yellow-500/10 px-1 rounded' : ''}`}>
                              <span className="text-amber-400">{inc.numero}</span> - {inc.texto}
                            </p>
                          ))}
                        </div>
                      )}
                      {artigo.alineas?.length > 0 && (
                        <div>
                          {artigo.alineas.map((al, i) => (
                            <p key={i} className={`theme-text-secondary ml-2 mb-1 ${isMatchedAlinea(al) ? 'font-semibold bg-yellow-500/10 px-1 rounded' : ''}`}>
                              <span className="text-teal-400">{al.letra})</span> {al.texto}
                            </p>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        ) : useSemanticSearch && legislacao.searchTerm && !searchingSemantics ? (
          <div className="text-center py-8 theme-text-muted">
            <Search className="w-8 h-8 mx-auto mb-2 opacity-50" />
            <p>Nenhum resultado sem√¢ntico para "{legislacao.searchTerm}"</p>
            <p className="text-xs mt-1">Tente reduzir o threshold nas configura√ß√µes</p>
          </div>
        ) : legislacao.filteredArtigos.length > 0 ? (
          <VirtualList
            items={legislacao.filteredArtigos}
            itemHeight={120}
            overscan={3}
            className="h-full"
            expandedIds={expandedIds}
            renderItem={(artigo) => (
              <ArtigoCard
                key={artigo.id}
                artigo={artigo}
                onCopy={legislacao.handleCopyArtigo}
                expanded={expandedIds.has(artigo.id)}
                onToggleExpand={handleToggleExpand}
                copiedId={legislacao.copiedId}
              />
            )}
          />
        ) : legislacao.artigos.length === 0 ? (
          <div className="text-center py-12 theme-text-muted">
            <BookOpen className="w-12 h-12 mx-auto mb-3 opacity-50" />
            <p className="font-medium mb-2">Nenhuma legisla√ß√£o importada</p>
            <p className="text-sm">
              Clique em "Importar JSON" para carregar artigos de leis.<br/>
              Arquivos dispon√≠veis na pasta LEGIS: clt.json, cf.json, cpc.json, etc.
            </p>
          </div>
        ) : (
          <div className="text-center py-8 theme-text-muted">
            <Search className="w-8 h-8 mx-auto mb-2 opacity-50" />
            <p>Nenhum artigo encontrado para "{legislacao.searchTerm}"</p>
          </div>
        )}
      </div>

      {/* v1.26.00: Footer com contagem (filtrada por lei) */}
      {(useSemanticSearch && semanticResults?.length > 0) ? (() => {
        const filteredSemanticCount = semanticResults.filter(item => !legislacao.leiAtiva || item.lei === legislacao.leiAtiva).length;
        return filteredSemanticCount > 0 ? (
          <div className="flex items-center justify-center mt-3 pt-2 border-t theme-border-subtle">
            <span className="text-sm theme-text-muted flex items-center gap-2">
              <span className="text-purple-400">üß†</span>
              {filteredSemanticCount} resultado(s) sem√¢ntico(s){legislacao.leiAtiva ? ` em ${legislacao.leiAtiva.toUpperCase()}` : ''}
            </span>
          </div>
        ) : null;
      })() : legislacao.filteredArtigos.length > 0 && (
        <div className="flex items-center justify-center mt-3 pt-2 border-t theme-border-subtle">
          <span className="text-sm theme-text-muted">
            {legislacao.filteredCount} artigo(s) ‚Ä¢ Scroll virtual ativo
          </span>
        </div>
      )}

      {/* v1.35.66: Migrado para BaseModal */}
      <BaseModal
        isOpen={modals?.deleteAllLegislacao}
        onClose={() => { closeModal('deleteAllLegislacao'); legislacao.setDeleteConfirmText(''); }}
        title="Excluir Toda Legisla√ß√£o"
        icon={<AlertCircle />}
        iconColor="red"
        size="md"
      >
        <p className="theme-text-secondary mb-4">
          Voc√™ est√° prestes a <strong className="text-red-400">excluir TODOS os {legislacao.artigos.length} artigo(s)</strong> da sua base de legisla√ß√£o.
        </p>
        <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-3 mb-4">
          <p className="text-sm theme-text-red">‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!</p>
        </div>
        <div className="mb-4">
          <label className="block text-sm font-medium theme-text-secondary mb-2">
            Digite <strong className="text-red-400">EXCLUIR</strong> para confirmar:
          </label>
          <input
            type="text"
            value={legislacao.deleteConfirmText}
            onChange={(e) => legislacao.setDeleteConfirmText(e.target.value)}
            className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary"
            placeholder="Digite EXCLUIR"
            autoFocus
          />
        </div>
        <div className="flex gap-3">
          <button
            onClick={() => { closeModal('deleteAllLegislacao'); legislacao.setDeleteConfirmText(''); }}
            className="flex-1 px-4 py-2 rounded-lg theme-bg-tertiary theme-text-secondary"
          >
            Cancelar
          </button>
          <button
            onClick={async () => {
              if (legislacao.deleteConfirmText === 'EXCLUIR') {
                await legislacao.handleClearAll();
                closeModal('deleteAllLegislacao');
              }
            }}
            disabled={legislacao.deleteConfirmText !== 'EXCLUIR'}
            className="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white disabled:opacity-50 disabled:cursor-not-allowed"
          >
            üóëÔ∏è Excluir Tudo
          </button>
        </div>
      </BaseModal>
    </div>
  );
});
LegislacaoTab.displayName = 'LegislacaoTab';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìã SE√á√ÉO 5: MODAIS ESPEC√çFICOS
// ~50 modais: RenameTopicModal, DeleteTopicModal, GlobalEditorModal, ConfigModal, etc.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// üîß BaseModal: Componente base reutiliz√°vel para modais
// v1.33.48: ESC handler centralizado (18 modais beneficiados)
const BaseModal = React.memo(({
  isOpen,
  onClose,
  title,
  subtitle,
  icon,
  iconColor = 'blue',
  size = 'md',
  children,
  footer,
  preventClose = false // v1.33.62: Impedir fechamento (ESC, X, click fora)
}) => {
  // ESC handler - deve vir antes do early return para cleanup funcionar
  React.useEffect(() => {
    if (preventClose) return; // v1.33.62: N√£o registrar ESC se preventClose
    const handleEsc = (e) => {
      if (e.key === 'Escape') onClose();
    };
    if (isOpen) {
      window.addEventListener('keydown', handleEsc);
    }
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose, preventClose]);

  // v1.35.63: Bloquear scroll do body quando modal aberto
  React.useEffect(() => {
    if (isOpen) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => {
        document.body.style.overflow = originalOverflow;
      };
    }
  }, [isOpen]);

  if (!isOpen) return null;

  const sizes = {
    sm: 'max-w-md',
    md: 'max-w-lg',
    lg: 'max-w-2xl',
    xl: 'max-w-4xl',
    '2xl': 'max-w-5xl'
  };

  // Gradientes para o c√≠rculo do √≠cone
  const iconGradients = {
    blue: 'from-blue-500 to-cyan-500 shadow-blue-500/30',
    red: 'from-red-500 to-orange-500 shadow-red-500/30',
    green: 'from-green-500 to-emerald-500 shadow-green-500/30',
    yellow: 'from-yellow-500 to-orange-500 shadow-yellow-500/30',
    purple: 'from-purple-500 to-blue-500 shadow-purple-500/30',
    orange: 'from-orange-500 to-red-500 shadow-orange-500/30'
  };

  return (
    <div className={CSS.modalOverlay} onClick={preventClose ? undefined : onClose}>
      <div
        className={`${CSS.modalContainer} ${sizes[size] || sizes.md} w-full animate-modal`}
        onClick={e => e.stopPropagation()}
        style={{ animation: 'modalFadeIn 0.2s ease-out' }}
      >
        {/* Header com √≠cone em c√≠rculo e bot√£o X */}
        <div className={`${CSS.modalHeader} flex items-center justify-between`}>
          <div className="flex items-center gap-3">
            {icon && (
              <div className={`w-9 h-9 rounded-full bg-gradient-to-br ${iconGradients[iconColor] || iconGradients.blue} flex items-center justify-center shadow-lg`}>
                {React.cloneElement(icon, { className: 'w-4 h-4 text-white' })}
              </div>
            )}
            <div>
              <h2 className="font-semibold theme-text-primary">{title}</h2>
              {subtitle && <p className="text-xs theme-text-secondary">{subtitle}</p>}
            </div>
          </div>
          {!preventClose && (
            <button
              onClick={onClose}
              className="w-8 h-8 rounded-full theme-bg-secondary theme-hover-bg flex items-center justify-center theme-text-secondary transition-all border theme-border-modal hover:border-current"
            >
              <X className="w-4 h-4" />
            </button>
          )}
        </div>
        {/* Content */}
        <div className="p-5">
          {children}
        </div>
        {/* Footer */}
        {footer && (
          <div className={CSS.modalFooter}>
            {footer}
          </div>
        )}
      </div>
    </div>
  );
});

// üîß ModalFooter: Helpers para footers de modais
const ModalFooter = {
  // Footer com Cancelar + Confirmar (azul)
  Standard: ({ onClose, onConfirm, confirmText = 'Confirmar', disabled = false, loading = false }) => (
    <>
      <button onClick={onClose} className={CSS.btnSecondary} disabled={loading}>Cancelar</button>
      <button onClick={onConfirm} disabled={disabled || loading} className={CSS.btnBlue}>
        {loading ? 'Processando...' : confirmText}
      </button>
    </>
  ),
  // Footer com apenas Fechar
  CloseOnly: ({ onClose, text = 'Fechar' }) => (
    <button onClick={onClose} className={CSS.btnSecondary}>{text}</button>
  ),
  // Footer com Cancelar + A√ß√£o Destrutiva (vermelho)
  Destructive: ({ onClose, onConfirm, confirmText = 'Deletar', disabled = false }) => (
    <>
      <button onClick={onClose} className={CSS.btnSecondary}>Cancelar</button>
      <button onClick={onConfirm} disabled={disabled} className={CSS.btnRed}>{confirmText}</button>
    </>
  ),
  // Footer com Cancelar + Confirmar (verde)
  Success: ({ onClose, onConfirm, confirmText = 'Confirmar', disabled = false }) => (
    <>
      <button onClick={onClose} className={CSS.btnSecondary}>Cancelar</button>
      <button onClick={onConfirm} disabled={disabled} className={CSS.btnGreen}>{confirmText}</button>
    </>
  )
};

// üîß ModalWarningBox: Caixa de aviso vermelho para a√ß√µes destrutivas (v1.18.3: suporta children complexos)
const ModalWarningBox = ({ children, className = '' }) => (
  <div className={`bg-red-900/20 border border-red-500/30 rounded-lg p-3 ${className}`}>
    <div className="text-xs theme-text-red flex items-start gap-2">
      <AlertCircle className="w-4 h-4 flex-shrink-0 mt-0.5" />
      <div className="flex-1">{children}</div>
    </div>
  </div>
);

// üîß ModalInfoBox: Caixa de informa√ß√£o azul para dicas (v1.18.3: suporta children complexos)
const ModalInfoBox = ({ children, className = '' }) => (
  <div className={`${CSS.infoBox} ${className}`}>
    <div className="text-xs theme-text-blue">{children}</div>
  </div>
);

// üîß ModalAmberBox: Caixa de aviso amarelo
const ModalAmberBox = ({ children, className = '' }) => (
  <div className={`theme-warning-box p-4 ${className}`}>
    {children}
  </div>
);

// üîß ModalContentPreview: Preview de conte√∫do em box
const ModalContentPreview = ({ title, subtitle, badge, children, className = '' }) => (
  <div className={`theme-bg-app p-4 rounded-lg border theme-border-secondary ${className}`}>
    {title && <p className="font-semibold theme-text-primary text-lg">{title}</p>}
    {subtitle && <p className="text-sm theme-text-muted mt-1">{subtitle}</p>}
    {badge && <span className="text-xs px-2 py-1 rounded theme-bg-purple-accent theme-text-purple border border-purple-500/30 inline-block mt-2">{badge}</span>}
    {children}
  </div>
);

// Modal: Renomear T√≥pico (migrado para BaseModal v1.18.3)
const RenameTopicModal = React.memo(({ isOpen, onClose, topicToRename, setTopicToRename, newTopicName, setNewTopicName, handleRenameTopic, isRegenerating, hasDocuments }) => {
  const handleClose = () => { onClose(); setTopicToRename(null); setNewTopicName(''); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="Renomear T√≥pico" icon={<Edit2 />} iconColor="purple" size="lg"
      footer={<>
        <button onClick={() => handleRenameTopic(true)} disabled={isRegenerating || !newTopicName.trim()} className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 bg-purple-600 text-white hover-purple-700-from-600">
          {isRegenerating ? <span className="flex items-center justify-center gap-2"><div className={CSS.spinner}></div>Regenerando...</span> : <span className="flex items-center justify-center gap-2"><Sparkles className="w-4 h-4" />Renomear e Regenerar</span>}
        </button>
        <button onClick={() => handleRenameTopic(false)} disabled={isRegenerating || !newTopicName.trim()} className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 bg-blue-600 text-white hover-blue-700-from-600">
          {isRegenerating ? <span className="flex items-center justify-center gap-2"><div className={CSS.spinner}></div>Renomeando...</span> : <span className="flex items-center justify-center gap-2"><Edit className="w-4 h-4" />Apenas Renomear</span>}
        </button>
        <button onClick={handleClose} disabled={isRegenerating} className="px-6 py-3 rounded-lg disabled:opacity-50 theme-bg-tertiary hover-slate-500">Cancelar</button>
      </>}>
      <div className="space-y-4">
        <div><label className={CSS.label}>T√≠tulo Atual</label><p className="theme-text-muted theme-bg-app p-3 rounded">{topicToRename?.title}</p></div>
        <div><label className={CSS.label}>Novo T√≠tulo</label><input type="text" value={newTopicName} onChange={(e) => setNewTopicName(e.target.value)} className="w-full theme-bg-app border theme-border-primary rounded-lg p-3 theme-text-secondary" placeholder="Digite o novo t√≠tulo" /></div>
        <ModalInfoBox>
          üí° <strong>Escolha uma das op√ß√µes:</strong>
          <ul className="mt-2 ml-4 space-y-1 theme-text-tertiary">
            <li>‚Ä¢ <strong>Renomear e Regenerar:</strong> {hasDocuments ? 'Regerar√° com base nos documentos' : 'Regerar√° com IA'}</li>
            <li>‚Ä¢ <strong>Apenas Renomear:</strong> Mant√©m o mini-relat√≥rio atual</li>
          </ul>
        </ModalInfoBox>
      </div>
    </BaseModal>
  );
});
RenameTopicModal.displayName = 'RenameTopicModal';

// Modal: Excluir T√≥pico (migrado para BaseModal)
const DeleteTopicModal = React.memo(({ isOpen, onClose, topicToDelete, setTopicToDelete, onConfirmDelete }) => (
  <BaseModal
    isOpen={isOpen}
    onClose={() => { onClose(); setTopicToDelete(null); }}
    title="Confirmar Exclus√£o"
    icon={<Trash2 />}
    iconColor="red"
    size="md"
    footer={<ModalFooter.Destructive onClose={() => { onClose(); setTopicToDelete(null); }} onConfirm={onConfirmDelete} confirmText="Sim, Excluir" />}
  >
    <div className="space-y-4">
      <p className="theme-text-tertiary">Deseja realmente excluir o t√≥pico abaixo?</p>
      <ModalContentPreview title={topicToDelete?.title}>
        {topicToDelete?.relatorio && <div className="text-sm theme-text-muted mt-2 max-h-48 overflow-y-auto">{topicToDelete.relatorio}</div>}
      </ModalContentPreview>
      <ModalWarningBox><strong>Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita. O t√≥pico ser√° removido permanentemente.</ModalWarningBox>
    </div>
  </BaseModal>
));
DeleteTopicModal.displayName = 'DeleteTopicModal';

// Modal: Unir T√≥picos (migrado para BaseModal v1.18.3)
const MergeTopicsModal = React.memo(({ isOpen, onClose, topicsToMerge, onConfirmMerge, isRegenerating, hasDocuments }) => {
  if (!topicsToMerge || topicsToMerge.length === 0) return null;
  return (
    <BaseModal isOpen={isOpen} onClose={onClose} title="Unir T√≥picos" icon={<Merge />} iconColor="yellow" size="lg"
      footer={<>
        <button onClick={onConfirmMerge} disabled={isRegenerating} className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 bg-amber-600 text-white hover-amber-700-from-600">
          {isRegenerating ? <span className="flex items-center justify-center gap-2"><div className={CSS.spinner}></div>{hasDocuments ? 'Regenerando...' : 'Unindo...'}</span> : 'Confirmar Uni√£o'}
        </button>
        <button onClick={onClose} className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500">Cancelar</button>
      </>}>
      <div className="space-y-4">
        <p className="theme-text-tertiary">Voc√™ est√° prestes a unir os seguintes t√≥picos:</p>
        <div className="space-y-2">{topicsToMerge.map((t, i) => <div key={i} className="theme-bg-app p-3 rounded border theme-border-input"><p className="font-medium theme-text-primary">{i+1}. {t.title}</p></div>)}</div>
        {hasDocuments ? <ModalInfoBox>‚úì Um novo t√≥pico unificado ser√° criado e o mini-relat√≥rio ser√° regenerado com base nos documentos originais.</ModalInfoBox> : <p className="text-xs theme-text-disabled">O mini-relat√≥rio ser√° regenerado automaticamente.</p>}
      </div>
    </BaseModal>
  );
});
MergeTopicsModal.displayName = 'MergeTopicsModal';

// Modal: Separar T√≥pico (migrado para BaseModal v1.18.3)
const SplitTopicModal = React.memo(({ isOpen, onClose, topicToSplit, setTopicToSplit, splitNames, setSplitNames, onConfirmSplit, isRegenerating, hasDocuments }) => {
  if (!splitNames) return null;
  const handleClose = () => { onClose(); setTopicToSplit(null); setSplitNames(['', '']); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="Separar T√≥pico" icon={<Split />} iconColor="orange" size="lg"
      footer={<>
        <button onClick={onConfirmSplit} disabled={isRegenerating || splitNames.filter(n => n.trim()).length < 2} className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 bg-orange-600 text-white hover-orange-700-from-600">
          {isRegenerating ? <span className="flex items-center justify-center gap-2"><div className={CSS.spinner}></div>{hasDocuments ? 'Regenerando...' : 'Separando...'}</span> : 'Confirmar Separa√ß√£o'}
        </button>
        <button onClick={handleClose} className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500">Cancelar</button>
      </>}>
      <div className="space-y-4">
        <div><label className={CSS.label}>T√≥pico Original</label><p className="theme-text-muted theme-bg-app p-3 rounded">{topicToSplit?.title}</p></div>
        <p className="theme-text-tertiary">Separe em quantos subt√≥picos desejar:</p>
        {splitNames.map((name, i) => <div key={i}><label className={CSS.label}>Subt√≥pico {i+1}</label><input type="text" value={name} onChange={(e) => { const n=[...splitNames]; n[i]=e.target.value; setSplitNames(n); }} className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary" placeholder={`T√≠tulo do subt√≥pico ${i+1}`} /></div>)}
        <button onClick={() => setSplitNames([...splitNames, ''])} className="text-sm hover-text-blue-400-from-300">+ Adicionar mais um subt√≥pico</button>
        {hasDocuments ? <ModalInfoBox>‚úì Cada subt√≥pico ter√° seu mini-relat√≥rio regenerado com base nos documentos originais.</ModalInfoBox> : <p className="text-xs theme-text-disabled">O mini-relat√≥rio ser√° regenerado com as informa√ß√µes relevantes.</p>}
      </div>
    </BaseModal>
  );
});
SplitTopicModal.displayName = 'SplitTopicModal';

// Modal: Criar Novo T√≥pico (migrado para BaseModal v1.18.3)
const NewTopicModal = React.memo(({ isOpen, onClose, newTopicData, setNewTopicData, onConfirmCreate, isRegenerating, hasDocuments }) => {
  const data = newTopicData || { title: '', category: 'M√âRITO', relatorio: '' };
  const handleClose = () => { onClose(); setNewTopicData({ title: '', category: 'M√âRITO', relatorio: '' }); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="Criar Novo T√≥pico" icon={<PlusCircle />} iconColor="green" size="lg"
      footer={<>
        <button onClick={onConfirmCreate} disabled={isRegenerating || !data.title.trim()} className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 flex items-center justify-center gap-2 bg-green-600 text-white hover-green-700-from-600">
          {isRegenerating ? <><div className={CSS.spinner}></div>{hasDocuments ? 'Analisando...' : 'Criando...'}</> : 'Criar T√≥pico'}
        </button>
        <button onClick={handleClose} className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500">Cancelar</button>
      </>}>
      <div className="space-y-4">
        <div><label className={CSS.label}>T√≠tulo do T√≥pico</label><input type="text" value={data.title} onChange={(e) => setNewTopicData({...data, title: e.target.value})} className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary" placeholder="Ex: Adicional de Periculosidade" /></div>
        <div><label className={CSS.label}>Categoria</label><select value={data.category} onChange={(e) => setNewTopicData({...data, category: e.target.value})} className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary"><option value="PRELIMINAR">Preliminar</option><option value="PREJUDICIAL">Prejudicial</option><option value="M√âRITO">M√©rito</option></select></div>
        <div><label className={CSS.label}>Mini-relat√≥rio (opcional)</label><textarea value={data.relatorio} onChange={(e) => setNewTopicData({...data, relatorio: e.target.value})} className="w-full h-32 theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary resize-none" placeholder="Digite ou deixe em branco para gerar automaticamente" /></div>
        {hasDocuments ? <ModalInfoBox>‚úì Se deixar em branco, o mini-relat√≥rio ser√° gerado com base nos documentos.</ModalInfoBox> : <p className="text-xs theme-text-disabled">Se deixar vazio, ser√° gerado um texto padr√£o.</p>}
      </div>
    </BaseModal>
  );
});
NewTopicModal.displayName = 'NewTopicModal';

// Modal: Excluir Modelo (migrado para BaseModal)
const DeleteModelModal = React.memo(({ isOpen, onClose, modelToDelete, setModelToDelete, onConfirmDelete }) => {
  if (!modelToDelete) return null;
  const handleClose = () => { onClose(); setModelToDelete(null); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="Excluir Modelo" icon={<Trash2 />} iconColor="red" size="sm"
      footer={<ModalFooter.Destructive onClose={handleClose} onConfirm={onConfirmDelete} confirmText="Excluir" />}>
      <div className="space-y-4">
        <p className="theme-text-tertiary">Tem certeza que deseja excluir o modelo:</p>
        <ModalContentPreview title={modelToDelete.title} badge={modelToDelete.category}>
          {modelToDelete.favorite && <span className="text-xl float-right">‚≠ê</span>}
        </ModalContentPreview>
        <ModalWarningBox><strong>Aten√ß√£o:</strong> O modelo ser√° permanentemente removido e n√£o poder√° ser recuperado.</ModalWarningBox>
      </div>
    </BaseModal>
  );
});
DeleteModelModal.displayName = 'DeleteModelModal';

// Modal: Excluir Todos os Modelos (migrado para BaseModal v1.18.3)
const DeleteAllModelsModal = React.memo(({ isOpen, onClose, totalModels, confirmText, setConfirmText, onConfirmDelete }) => {
  const handleClose = () => { onClose(); setConfirmText(''); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="ATEN√á√ÉO: Exclus√£o em Massa" icon={<AlertCircle />} iconColor="red" size="md"
      footer={<>
        <button onClick={handleClose} className={CSS.btnSecondary}>Cancelar</button>
        <button onClick={onConfirmDelete} disabled={confirmText !== 'EXCLUIR'} className="flex-1 px-4 py-3 rounded-lg disabled:theme-bg-tertiary disabled:cursor-not-allowed font-medium bg-red-600 text-white hover-red-700-from-600">üóëÔ∏è Excluir Tudo</button>
      </>}>
      <div className="space-y-4">
        <p className="theme-text-tertiary">Voc√™ est√° prestes a <strong className="text-red-400">excluir TODOS os {totalModels} modelo(s)</strong> da sua biblioteca.</p>
        <ModalWarningBox>
          ‚ö†Ô∏è <strong>ATEN√á√ÉO:</strong> Todos os modelos ser√£o permanentemente removidos. Esta a√ß√£o n√£o pode ser desfeita!
          <ul className="mt-2 ml-4 list-disc space-y-1 theme-text-secondary">
            <li>Todos os {totalModels} modelos ser√£o exclu√≠dos</li>
            <li>As sugest√µes autom√°ticas n√£o funcionar√£o mais</li>
            <li>Voc√™ precisar√° recriar ou importar novos modelos</li>
          </ul>
        </ModalWarningBox>
        <div>
          <label className={CSS.label}>Para confirmar, digite <strong className="text-red-400">EXCLUIR</strong>:</label>
          <input type="text" value={confirmText} onChange={(e) => setConfirmText(e.target.value)} className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary" placeholder="Digite EXCLUIR" autoFocus />
          {confirmText && confirmText !== 'EXCLUIR' && <p className="text-xs text-red-400 mt-1">‚ùå Digite exatamente "EXCLUIR"</p>}
        </div>
      </div>
    </BaseModal>
  );
});
DeleteAllModelsModal.displayName = 'DeleteAllModelsModal';

const DeleteAllPrecedentesModal = React.memo(({ isOpen, onClose, totalPrecedentes, confirmText, setConfirmText, onConfirmDelete }) => {
  const handleClose = () => { onClose(); setConfirmText(''); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="ATEN√á√ÉO: Exclus√£o em Massa" icon={<AlertCircle />} iconColor="red" size="md"
      footer={<>
        <button onClick={handleClose} className={CSS.btnSecondary}>Cancelar</button>
        <button onClick={onConfirmDelete} disabled={confirmText !== 'EXCLUIR'} className="flex-1 px-4 py-3 rounded-lg disabled:theme-bg-tertiary disabled:cursor-not-allowed font-medium bg-red-600 text-white hover-red-700-from-600">üóëÔ∏è Excluir Tudo</button>
      </>}>
      <div className="space-y-4">
        <p className="theme-text-tertiary">Voc√™ est√° prestes a <strong className="text-red-400">excluir TODOS os {totalPrecedentes} precedente(s)</strong> da sua base.</p>
        <ModalWarningBox>
          ‚ö†Ô∏è <strong>ATEN√á√ÉO:</strong> Todos os precedentes ser√£o permanentemente removidos. Esta a√ß√£o n√£o pode ser desfeita!
        </ModalWarningBox>
        <div>
          <label className={CSS.label}>Para confirmar, digite <strong className="text-red-400">EXCLUIR</strong>:</label>
          <input type="text" value={confirmText} onChange={(e) => setConfirmText(e.target.value)} className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary" placeholder="Digite EXCLUIR" autoFocus />
          {confirmText && confirmText !== 'EXCLUIR' && <p className="text-xs text-red-400 mt-1">‚ùå Digite exatamente "EXCLUIR"</p>}
        </div>
      </div>
    </BaseModal>
  );
});
DeleteAllPrecedentesModal.displayName = 'DeleteAllPrecedentesModal';

// Modal: Confirmar Extra√ß√£o de Modelo
const ExtractModelConfirmModal = React.memo(({
  isOpen,
  onClose,
  editingTopic,
  editorRef,
  onConfirmExtract
}) => {
  // ESC handler
  React.useEffect(() => {
    const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
    if (isOpen) window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div className={CSS.modalOverlay}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-lg w-full`}>
        <div className={CSS.modalHeader}>
          <div className="flex items-center justify-between w-full">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-purple-500/20">
                <Zap className="w-6 h-6 text-purple-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold theme-text-primary">Criar Modelo Gen√©rico</h3>
                <p className="text-sm theme-text-muted">Confirme a cria√ß√£o do modelo reutiliz√°vel</p>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>

        <div className="p-6">
          <div className="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4 mb-4">
            <p className="theme-text-tertiary text-sm mb-3">
              A IA ir√° analisar seu texto e criar um <strong>modelo gen√©rico reutiliz√°vel</strong> que:
            </p>
            <ul className="text-xs theme-text-muted space-y-2 ml-4 list-disc">
              <li>Remove nomes espec√≠ficos de pessoas e empresas</li>
              <li>Remove valores monet√°rios e datas</li>
              <li>Mant√©m a fundamenta√ß√£o jur√≠dica intacta</li>
              <li>Gera palavras-chave automaticamente</li>
              <li>Salva na biblioteca de modelos</li>
            </ul>
          </div>

          {/* v1.9.37: Cores corrigidas para tema claro */}
          <div className="bg-amber-500/10 border border-amber-500/40 rounded-lg p-3 mb-4">
            <div className="flex items-start gap-2">
              <span className="text-amber-500 text-lg">‚ö†Ô∏è</span>
              <div>
                <p className="text-xs text-amber-700 dark:text-amber-200 font-semibold mb-1">Aten√ß√£o:</p>
                <p className="text-xs text-amber-600 dark:text-amber-100">
                  O texto atual ser√° enviado para a API da Anthropic para processamento.
                  Certifique-se de que n√£o h√° informa√ß√µes sens√≠veis que n√£o devem ser compartilhadas.
                </p>
              </div>
            </div>
          </div>

          <div className="theme-bg-secondary-50 rounded-lg p-3 mb-4">
            <p className="text-xs theme-text-muted mb-1">
              <strong className="theme-text-tertiary">T√≥pico:</strong> {editingTopic?.title}
            </p>
            <p className={CSS.textMuted}>
              <strong className="theme-text-tertiary">Tamanho do texto:</strong> {editorRef?.current?.root?.innerText?.length || 0} caracteres
            </p>
          </div>
        </div>

        <div className={CSS.modalFooter}>
          <button
            onClick={onClose}
            className="flex-1 px-4 py-3 rounded-lg font-medium hover-slate-700-from-600"
          >
            ‚ùå Cancelar
          </button>
          <button
            onClick={onConfirmExtract}
            className="flex-1 px-4 py-3 rounded-lg font-medium shadow-lg hover-gradient-purple-pink bg-gradient-to-r from-purple-600 to-pink-500 text-white transition-all duration-300"
          >
            ‚ú® Criar Modelo
          </button>
        </div>
      </div>
    </div>
  );
});

ExtractModelConfirmModal.displayName = 'ExtractModelConfirmModal';

// Modal: Preview de Modelo Extra√≠do
const ExtractedModelPreviewModal = React.memo(({
  isOpen,
  onClose,
  extractedModel,
  setExtractedModel,
  onSave,
  onCancel,
  sanitizeHTML = (html) => html || ''
}) => {
  // ESC handler
  React.useEffect(() => {
    const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
    if (isOpen) window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  if (!isOpen || !extractedModel) return null;

  return (
    <div className={`${CSS.modalOverlay} overflow-y-auto`} style={{ alignItems: 'flex-start', paddingTop: '2rem' }}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-4xl w-full my-8`}>
        {/* Header */}
        <div className={CSS.modalHeader}>
          <div className="flex items-center justify-between w-full">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-purple-500/20">
                <Edit className="w-6 h-6 text-purple-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold theme-text-primary">Revisar e Editar Modelo Gerado</h3>
                <p className="text-sm theme-text-muted">Revise o modelo extra√≠do antes de salv√°-lo na biblioteca</p>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>

        {/* Conte√∫do edit√°vel */}
        <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
          {/* T√≠tulo */}
          <div>
            <label className="block text-sm font-semibold theme-text-tertiary mb-2">
              T√≠tulo do Modelo
            </label>
            <input
              type="text"
              value={extractedModel.title}
              onChange={(e) => setExtractedModel({ ...extractedModel, title: e.target.value })}
              className="w-full px-4 py-3 theme-bg-secondary border theme-border-input rounded-lg theme-text theme-placeholder focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all"
              placeholder="Ex: Adicional de Periculosidade - Modelo"
            />
          </div>

          {/* Categoria */}
          <div>
            <label className="block text-sm font-semibold theme-text-tertiary mb-2">
              üìÇ Categoria
            </label>
            <select
              value={extractedModel.category || ''}
              onChange={(e) => setExtractedModel({ ...extractedModel, category: e.target.value })}
              className="w-full px-4 py-3 theme-bg-secondary border theme-border-input rounded-lg theme-text focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all"
            >
              <option value="Preliminar">Preliminar</option>
              <option value="M√©rito">M√©rito</option>
              <option value="Pedidos">Pedidos</option>
              <option value="Outros">Outros</option>
            </select>
          </div>

          {/* Palavras-chave */}
          <div>
            <label className="block text-sm font-semibold theme-text-tertiary mb-2">
              üè∑Ô∏è Palavras-chave
            </label>
            <input
              type="text"
              value={extractedModel.keywords || ''}
              onChange={(e) => setExtractedModel({ ...extractedModel, keywords: e.target.value })}
              className="w-full px-4 py-3 theme-bg-secondary border theme-border-input rounded-lg theme-text theme-placeholder focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all"
              placeholder="palavras, separadas, por v√≠rgulas"
            />
            <p className="text-xs theme-text-muted mt-1">Separe as palavras-chave com v√≠rgulas</p>
          </div>

          {/* Preview do Conte√∫do */}
          <div>
            <label className="block text-sm font-semibold theme-text-tertiary mb-2">
              Preview do Conte√∫do
            </label>
            <div
              className="w-full px-4 py-3 theme-bg-secondary border theme-border-input rounded-lg min-h-[200px] max-h-[300px] overflow-y-auto theme-text"
              dangerouslySetInnerHTML={{ __html: sanitizeHTML(extractedModel.content) }}
            />
            <p className="text-xs theme-text-muted mt-1">
              Conte√∫do editado no modal anterior
            </p>
          </div>
        </div>

        {/* Footer com a√ß√µes */}
        <div className={CSS.modalFooter}>
          <button
            onClick={onCancel}
            className="flex-1 px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 hover-slate-700-from-600"
          >
            <span>‚ùå</span>
            Cancelar
          </button>
          <button
            onClick={onSave}
            disabled={!extractedModel.title.trim() || !extractedModel.content.trim()}
            className="flex-1 px-6 py-3 disabled:from-gray-600 disabled:to-gray-600 disabled:cursor-not-allowed rounded-lg font-medium shadow-lg flex items-center justify-center gap-2 hover-gradient-purple-pink-darker transition-all duration-300"
          >
            <Save className="w-5 h-5" />
            Salvar Modelo
          </button>
        </div>
      </div>
    </div>
  );
});

ExtractedModelPreviewModal.displayName = 'ExtractedModelPreviewModal';

// Modal: Adicionar Prova (Texto) (migrado para BaseModal v1.18.3)
const AddProofTextModal = React.memo(({ isOpen, onClose, newProofData, setNewProofData, onAddProof }) => {
  const data = newProofData || { name: '', text: '' };
  const handleClose = () => { onClose(); setNewProofData({ name: '', text: '' }); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="Adicionar Prova (Texto)" icon={<FileText />} iconColor="blue" size="lg"
      footer={<>
        <button onClick={handleClose} className={CSS.btnSecondary}>Cancelar</button>
        <button onClick={onAddProof} disabled={!data.text.trim()} className="px-6 py-2 rounded-lg disabled:opacity-50 bg-blue-600 text-white hover-blue-700-from-600">Adicionar Prova</button>
      </>}>
      <div className="space-y-4">
        <div><label className={CSS.label}>Nome da Prova</label><input type="text" value={data.name} onChange={(e) => setNewProofData(prev => ({...prev, name: e.target.value}))} placeholder="Ex: Contracheques, Ata de Audi√™ncia" className="w-full px-4 py-2 theme-bg-secondary border theme-border-input rounded-lg theme-text-secondary" /></div>
        <div><label className={CSS.label}>Texto da Prova</label><textarea value={data.text} onChange={(e) => setNewProofData(prev => ({...prev, text: e.target.value}))} placeholder="Cole aqui o texto da prova..." rows={12} className="w-full px-4 py-2 theme-bg-secondary border theme-border-input rounded-lg theme-text-secondary font-mono text-sm" /></div>
      </div>
    </BaseModal>
  );
});
AddProofTextModal.displayName = 'AddProofTextModal';

// v1.33.45: Migrado para BaseModal
const ProofAnalysisModal = React.memo(({
  isOpen,
  onClose,
  proofToAnalyze,
  customInstructions,
  setCustomInstructions,
  useOnlyMiniRelatorios,
  setUseOnlyMiniRelatorios,
  includeLinkedTopicsInFree,
  setIncludeLinkedTopicsInFree,
  proofTopicLinks,
  onAnalyzeContextual,
  onAnalyzeFree,
  editorTheme = 'dark'
}) => {
  if (!isOpen || !proofToAnalyze) return null;

  const linkedTopicsCount = proofTopicLinks[proofToAnalyze.id]?.length || 0;

  return (
    <BaseModal
      isOpen={isOpen}
      onClose={onClose}
      title="Analisar Prova com IA"
      subtitle={proofToAnalyze.name}
      icon={<Sparkles />}
      iconColor="blue"
      size="lg"
      footer={<ModalFooter.CloseOnly onClose={onClose} text="Cancelar" />}
    >
      <div className="space-y-4">
        <p className="text-sm theme-text-tertiary">
          Selecione o tipo de an√°lise que deseja realizar nesta prova:
        </p>

        {/* Campo de Instru√ß√µes Personalizadas */}
        <div>
          <label className={CSS.label}>
            Instru√ß√µes Personalizadas (Opcional)
          </label>
          <textarea
            value={customInstructions}
            onChange={(e) => setCustomInstructions(e.target.value)}
            placeholder="Adicione instru√ß√µes espec√≠ficas para esta an√°lise (ex: 'Focar em valores monet√°rios', 'Verificar datas de v√≠nculos empregat√≠cios', 'Identificar assinaturas e testemunhas', etc.)..."
            rows={3}
            className="w-full px-3 py-2 theme-bg-secondary-50 border theme-border-input rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent theme-text-secondary text-sm resize-none"
          />
          <p className="text-xs theme-text-disabled mt-1">
            Estas instru√ß√µes ser√£o adicionadas ao prompt de an√°lise da IA.
          </p>
        </div>

        {/* Op√ß√£o 1: An√°lise Contextual (com checkbox de mini-relat√≥rios dentro) */}
        <div className={`rounded-lg ${editorTheme === 'light' ? 'hover-button-contextual-light' : 'hover-button-contextual'}`}>
          <button
            onClick={onAnalyzeContextual}
            className="w-full p-4 text-left"
          >
            <div className="flex items-start gap-3">
              <div className="icon-wrapper p-2 bg-purple-600/20 rounded-lg transition-colors">
                <Scale className="w-5 h-5 text-purple-400" />
              </div>
              <div className="flex-1">
                <h4 className="font-semibold theme-text-secondary mb-1">An√°lise Contextual</h4>
                <p className="text-sm theme-text-muted">
                  Compara a prova com as alega√ß√µes da peti√ß√£o e contesta√ß√£o, avaliando se prova ou refuta os pontos discutidos no processo.
                </p>
              </div>
            </div>
          </button>
          {linkedTopicsCount > 0 && (
            <div className="px-4 pb-4 pt-0">
              <label
                className="flex items-center gap-2 cursor-pointer text-xs theme-text-muted hover-label-text-purple"
                onClick={(e) => e.stopPropagation()}
              >
                <input
                  type="checkbox"
                  checked={useOnlyMiniRelatorios}
                  onChange={(e) => setUseOnlyMiniRelatorios(e.target.checked)}
                  className="w-3.5 h-3.5 rounded border-purple-600 theme-bg-secondary text-purple-500 focus:ring-1 focus:ring-purple-500 cursor-pointer"
                />
                <span>Usar apenas mini-relat√≥rios dos {linkedTopicsCount} t√≥pico(s) vinculado(s)</span>
              </label>
            </div>
          )}
        </div>

        {/* Op√ß√£o 2: An√°lise Livre (com checkbox de t√≥picos vinculados) */}
        <div className={`rounded-lg ${editorTheme === 'light' ? 'hover-button-free-light' : 'hover-button-free'}`}>
          <button
            onClick={onAnalyzeFree}
            className="w-full p-4 text-left"
          >
            <div className="flex items-start gap-3">
              <div className="icon-wrapper p-2 bg-green-600/20 rounded-lg transition-colors">
                <Edit className="w-5 h-5 text-green-400" />
              </div>
              <div className="flex-1">
                <h4 className="font-semibold theme-text-secondary mb-1">An√°lise Livre</h4>
                <p className="text-sm theme-text-muted">
                  Envia apenas a prova e suas instru√ß√µes personalizadas.
                </p>
              </div>
            </div>
          </button>
          {linkedTopicsCount > 0 && (
            <div className="px-4 pb-4 pt-0">
              <label
                className="flex items-center gap-2 cursor-pointer text-xs theme-text-muted hover-label-text-green"
                onClick={(e) => e.stopPropagation()}
              >
                <input
                  type="checkbox"
                  checked={includeLinkedTopicsInFree}
                  onChange={(e) => setIncludeLinkedTopicsInFree(e.target.checked)}
                  className="w-3.5 h-3.5 rounded border-green-600 theme-bg-secondary text-green-500 focus:ring-1 focus:ring-green-500 cursor-pointer"
                />
                <span>Incluir t√≥picos vinculados ({linkedTopicsCount} t√≥p.)</span>
              </label>
            </div>
          )}
        </div>
      </div>
    </BaseModal>
  );
});

ProofAnalysisModal.displayName = 'ProofAnalysisModal';

// v1.33.45: Migrado para BaseModal
const LinkProofModal = React.memo(({
  isOpen,
  onClose,
  proofToLink,
  extractedTopics,
  proofTopicLinks,
  setProofTopicLinks
}) => {
  if (!isOpen || !proofToLink) return null;

  return (
    <BaseModal
      isOpen={isOpen}
      onClose={onClose}
      title="Vincular Prova a T√≥picos"
      subtitle={proofToLink.name}
      icon={<Scale />}
      iconColor="purple"
      size="lg"
      footer={
        <button
          onClick={onClose}
          className="px-6 py-2 rounded-lg font-medium bg-purple-600 text-white hover-purple-700-from-600"
        >
          Concluir
        </button>
      }
    >
      {/* Scroll com margens negativas para compensar padding do BaseModal */}
      <div className="max-h-[50vh] overflow-y-auto -mx-5 px-5">
        {extractedTopics.length === 0 ? (
          <div className="text-center py-8 theme-text-muted">
            <AlertCircle className="w-12 h-12 mx-auto mb-3 opacity-50" />
            <p>Nenhum t√≥pico dispon√≠vel</p>
            <p className="text-sm mt-2">Primeiro analise os documentos na aba "Upload & An√°lise"</p>
          </div>
        ) : (
          <div className="space-y-2">
            <p className="text-sm theme-text-muted mb-4">
              Selecione os t√≥picos aos quais esta prova se relaciona:
            </p>
            {extractedTopics.map((topic) => {
              const isLinked = proofTopicLinks[proofToLink.id]?.includes(topic.title) || false;
              return (
                <label
                  key={topic.title}
                  className={`flex items-start gap-3 p-3 rounded-lg cursor-pointer transition-all ${
                    isLinked
                      ? 'bg-purple-600/20 border border-purple-500/50'
                      : 'theme-bg-secondary-50 border theme-border-input hover-border-purple-alpha-30'
                  }`}
                >
                  <input
                    type="checkbox"
                    checked={isLinked}
                    onChange={(e) => {
                      if (e.target.checked) {
                        setProofTopicLinks(prev => ({
                          ...prev,
                          [proofToLink.id]: [...(prev[proofToLink.id] || []), topic.title]
                        }));
                      } else {
                        setProofTopicLinks(prev => ({
                          ...prev,
                          [proofToLink.id]: (prev[proofToLink.id] || []).filter(t => t !== topic.title)
                        }));
                      }
                    }}
                    className="mt-1 w-4 h-4 rounded theme-border text-purple-600 focus:ring-2 focus:ring-purple-500 focus:ring-offset-0 theme-bg-secondary"
                  />
                  <div className="flex-1">
                    <div className={CSS.flexGap2}>
                      <span className="font-medium theme-text-secondary">{topic.title}</span>
                      <span className={`px-2 py-0.5 text-xs rounded ${
                        topic.category === 'PRELIMINAR'
                          ? 'bg-yellow-500/20 text-yellow-300'
                          : topic.category === 'PREJUDICIAL'
                          ? 'bg-orange-500/20 text-orange-300'
                          : 'theme-bg-blue-accent theme-text-blue'
                      }`}>
                        {topic.category}
                      </span>
                    </div>
                    {topic.relatorio && (
                      <p className="text-xs theme-text-muted mt-1 line-clamp-2">
                        {(topic.relatorio.replace(/<[^>]*>/g, '')).substring(0, 120)}...
                      </p>
                    )}
                  </div>
                </label>
              );
            })}
          </div>
        )}
      </div>
    </BaseModal>
  );
});

LinkProofModal.displayName = 'LinkProofModal';

// Modal: Excluir Prova (migrado para BaseModal)
const DeleteProofModal = React.memo(({ isOpen, onClose, proofToDelete, onConfirmDelete }) => {
  if (!proofToDelete) return null;
  return (
    <BaseModal isOpen={isOpen} onClose={onClose} title="Confirmar Exclus√£o" icon={<Trash2 />} iconColor="red" size="md"
      footer={<ModalFooter.Destructive onClose={onClose} onConfirm={onConfirmDelete} confirmText="Excluir Prova" />}>
      <div className="space-y-4">
        <p className="theme-text-tertiary">Deseja excluir a prova abaixo?</p>
        <ModalContentPreview title={proofToDelete.name}>
          <span className={`px-2 py-0.5 text-xs rounded ml-2 ${proofToDelete.isPdf ? 'theme-bg-red-accent theme-text-red' : 'theme-bg-blue-accent theme-text-blue'}`}>
            {proofToDelete.isPdf ? 'PDF' : 'TEXTO'}
          </span>
          {!proofToDelete.isPdf && proofToDelete.text && <p className="text-xs theme-text-muted mt-2">{proofToDelete.text.substring(0, 200)}...</p>}
        </ModalContentPreview>
        <ModalWarningBox><strong>Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita.</ModalWarningBox>
      </div>
    </BaseModal>
  );
});
DeleteProofModal.displayName = 'DeleteProofModal';

// üí¨ v1.19.0: ChatBubble - Mensagem individual no chat
const ChatBubble = React.memo(({ msg, onUse, showUse, sanitizeHTML = (html) => html || '' }) => {
  const isUser = msg.role === 'user';
  const time = new Date(msg.ts).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
  // v1.19.4: Converter Markdown b√°sico para HTML (fix espa√ßamento)
  const markdownToHtml = (text) => {
    if (!text) return '';
    return text
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*([^*\n]+)\*/g, '<em>$1</em>')
      .replace(/\n+/g, '<br>');
  };

  return (
    <div className={`flex ${isUser ? 'justify-end' : 'justify-start'}`}>
      <div className="max-w-[85%]">
        <div className={`text-xs mb-1 theme-text-muted ${isUser ? 'text-right' : ''}`}>
          {isUser ? 'üë§ Voc√™' : 'ü§ñ Assistente'} <span className="ml-1">{time}</span>
        </div>
        <div className={`rounded-lg p-3 ${
          isUser
            ? 'bg-purple-600/20 border border-purple-500/30'
            : 'theme-bg-secondary border theme-border-input'
        }`}>
          {isUser ? (
            <p className="theme-text-primary text-sm whitespace-pre-wrap">{msg.content}</p>
          ) : (
            <div
              className="theme-text-secondary text-sm leading-relaxed"
              dangerouslySetInnerHTML={{ __html: sanitizeHTML(markdownToHtml(msg.content)) }}
            />
          )}
        </div>
        {msg.error && (
          <div className="text-xs text-red-400 mt-1">‚ö†Ô∏è Erro: {msg.error}</div>
        )}
        {!isUser && showUse && !msg.error && (
          <div className="flex justify-end mt-1">
            <button
              onClick={() => onUse(msg.content)}
              className="text-xs px-2 py-1 rounded theme-bg-tertiary theme-text-muted hover-green-700"
            >
              Usar ‚Üë
            </button>
          </div>
        )}
      </div>
    </div>
  );
});
ChatBubble.displayName = 'ChatBubble';

// üí¨ v1.19.0: ChatHistoryArea - √Årea de hist√≥rico do chat
const ChatHistoryArea = React.memo(({ history, generating, onUseMessage, showUseButtons, sanitizeHTML }) => {
  const ref = React.useRef(null);

  React.useEffect(() => {
    if (ref.current) ref.current.scrollTop = ref.current.scrollHeight;
  }, [history, generating]);

  return (
    <div ref={ref} className="h-80 overflow-y-auto p-4 space-y-4 theme-bg-app" role="log" aria-live="polite">
      {history.length === 0 ? (
        <div className="h-full flex items-center justify-center">
          <div className="text-center theme-text-muted">
            <Sparkles className="w-8 h-8 mx-auto mb-2 opacity-50" />
            <p className="text-sm">Inicie a conversa com sua instru√ß√£o</p>
            <p className="text-xs mt-1">A IA pode fazer perguntas se precisar de mais informa√ß√µes</p>
          </div>
        </div>
      ) : (
        history.map((msg, i) => (
          <ChatBubble
            key={i}
            msg={msg}
            onUse={onUseMessage}
            showUse={showUseButtons && msg.role === 'assistant'}
            sanitizeHTML={sanitizeHTML}
          />
        ))
      )}
      {generating && (
        <div className="flex justify-start">
          <div className="max-w-[85%]">
            <div className="text-xs mb-1 theme-text-muted">ü§ñ Assistente</div>
            <div className="rounded-lg p-3 theme-bg-secondary border theme-border-input flex items-center gap-2">
              <div className="w-4 h-4 border-2 border-purple-500 border-t-transparent rounded-full animate-spin" />
              <span className="text-sm theme-text-muted">Gerando...</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
});
ChatHistoryArea.displayName = 'ChatHistoryArea';

// üí¨ v1.19.0: ChatInput - Campo de entrada do chat
const ChatInput = React.memo(({ onSend, disabled, placeholder }) => {
  const [value, setValue] = React.useState('');

  const handleSend = () => {
    if (!value.trim() || disabled) return;
    onSend(value.trim());
    setValue('');
  };

  const handleKey = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  // v1.35.59: Handler para Voice-to-Text - adiciona texto ao valor
  const handleVoiceTranscript = React.useCallback((text) => {
    setValue(prev => (prev ? prev + ' ' : '') + text);
  }, []);

  return (
    <div className="flex gap-2">
      <textarea
        value={value}
        onChange={(e) => setValue(e.target.value)}
        onKeyDown={handleKey}
        disabled={disabled}
        className="flex-1 h-20 theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary resize-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 disabled:opacity-50"
        placeholder={placeholder}
      />
      {/* v1.35.59: VoiceButton para ditado */}
      <VoiceButton
        onTranscript={handleVoiceTranscript}
        size="sm"
        className="self-end mb-1"
      />
      <button
        onClick={handleSend}
        disabled={!value.trim() || disabled}
        className="px-4 rounded-lg font-medium disabled:opacity-50 text-white bg-gradient-to-r from-purple-600 to-blue-600 hover-purple-700"
      >
        {disabled ? (
          <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
        ) : (
          'Enviar'
        )}
      </button>
    </div>
  );
});
ChatInput.displayName = 'ChatInput';

// üí¨ v1.19.0: InsertDropdown - Dropdown para inserir resposta
const InsertDropdown = React.memo(({ onInsert, disabled }) => {
  const [open, setOpen] = React.useState(false);

  if (disabled) return null;

  return (
    <div className="relative">
      <button
        onClick={() => setOpen(!open)}
        className="px-4 py-2 rounded-lg font-medium bg-green-600 text-white hover-green-700-from-600 flex items-center gap-2"
      >
        Inserir √öltima Resposta
        <ChevronDown className={`w-4 h-4 transition-transform ${open ? 'rotate-180' : ''}`} />
      </button>
      {open && (
        <>
          <div className="fixed inset-0 z-10" onClick={() => setOpen(false)} />
          <div className="absolute bottom-full left-0 mb-1 z-20 theme-bg-primary border theme-border-input rounded-lg shadow-xl py-1 min-w-[180px]">
            <button onClick={() => { onInsert('replace'); setOpen(false); }} className="w-full px-4 py-2 text-left text-sm hover-amber-600 text-amber-400">
              Substituir Tudo
            </button>
            <button onClick={() => { onInsert('prepend'); setOpen(false); }} className="w-full px-4 py-2 text-left text-sm hover-blue-600 text-blue-400">
              Adicionar no In√≠cio
            </button>
            <button onClick={() => { onInsert('append'); setOpen(false); }} className="w-full px-4 py-2 text-left text-sm hover-green-600 text-green-400">
              Adicionar no Final
            </button>
          </div>
        </>
      )}
    </div>
  );
});
InsertDropdown.displayName = 'InsertDropdown';

// üÜï v1.21.1: Detecta se uma prova √© do tipo oral/testemunhal pelo nome
const isOralProof = (proofName) => {
  const keywords = ['audi√™ncia', 'audiencia', 'depoimento', 'testemunha', 'transcri√ß√£o', 'transcricao', 'ata', 'oral', 'oitiva'];
  const nameLower = (proofName || '').toLowerCase();
  return keywords.some(kw => nameLower.includes(kw));
};

// üÜï v1.21.1: Verifica se h√° provas orais vinculadas a um t√≥pico
const hasOralProofsForTopic = (proofManager, topicTitle) => {
  if (!proofManager) return false;
  const linkedProofIds = Object.keys(proofManager.proofTopicLinks || {}).filter(proofId =>
    proofManager.proofTopicLinks[proofId]?.includes(topicTitle)
  );
  const allLinkedProofs = [
    ...(proofManager.proofFiles || []).filter(p => linkedProofIds.includes(String(p.id))),
    ...(proofManager.proofTexts || []).filter(p => linkedProofIds.includes(String(p.id)))
  ];
  return allLinkedProofs.some(p => isOralProof(p.name));
};

// ü§ñ v1.19.0: AIAssistantBaseLegacy - Base LEGACY para Assistentes IA (modo single-shot, usado por AIAssistantModelModal)
const AIAssistantBaseLegacy = React.memo(({
  isOpen,
  onClose,
  aiInstruction,
  setAiInstruction,
  generatingAi,
  aiGeneratedText,
  onGenerateText,
  onInsertText,
  // Configura√ß√µes opcionais
  title = 'Assistente de Reda√ß√£o IA',
  subtitle = 'Instrua a IA sobre o que voc√™ deseja escrever',
  zIndex = 60,
  placeholder = 'Ex: Escreva um par√°grafo explicando por que as horas extras s√£o devidas, considerando que havia controle de ponto irregular...',
  // Componente extra no topo do content (antes do campo de instru√ß√µes)
  extraContent = null,
  // Exemplos personalizados (opcional)
  customExamples = null,
  // Controle de quais bot√µes mostrar
  showInsertButtons = true,
  showCopyButton = true,
  sanitizeHTML = (html) => html || '',
}) => {
  const [copied, setCopied] = React.useState(false);

  const handleCopyText = React.useCallback(() => {
    // v1.25.18: Usar helper ao inv√©s de DOM (memory leak fix)
    let plainText = extractPlainText(aiGeneratedText);
    plainText = plainText.replace(/\n{2,}/g, '\n').trim();
    navigator.clipboard.writeText(plainText)
      .then(() => {
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      })
      .catch(() => {});
  }, [aiGeneratedText]);

  // v1.35.62: Handler para Voice-to-Text no campo de instru√ß√µes
  const handleVoiceInstruction = React.useCallback((text) => {
    const current = aiInstruction || '';
    setAiInstruction(current + (current ? ' ' : '') + text);
  }, [aiInstruction, setAiInstruction]);

  // v1.35.64: ESC handler
  React.useEffect(() => {
    const handleEsc = (e) => {
      if (e.key === 'Escape') onClose();
    };
    if (isOpen) {
      window.addEventListener('keydown', handleEsc);
    }
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  // v1.35.64: Bloquear scroll do body quando modal aberto
  React.useEffect(() => {
    if (isOpen) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => {
        document.body.style.overflow = originalOverflow;
      };
    }
  }, [isOpen]);

  if (!isOpen) return null;

  // Exemplos padr√£o
  const defaultExamples = (
    <ul className="text-xs theme-text-disabled space-y-1">
      <li>‚Ä¢ "Escreva a fundamenta√ß√£o legal sobre horas extras"</li>
      <li>‚Ä¢ "Argumente por que o v√≠nculo empregat√≠cio deve ser reconhecido"</li>
      <li>‚Ä¢ "Explique os requisitos para concess√£o de adicional de insalubridade"</li>
      <li>‚Ä¢ "Conclua o t√≥pico julgando procedente o pedido"</li>
      <li>‚Ä¢ "Refute os argumentos da defesa sobre a jornada de trabalho"</li>
    </ul>
  );

  return (
    <div className={`${CSS.modalOverlay} overflow-auto`} style={{ zIndex }}>
      <div className={`${CSS.modalContainer} max-w-4xl w-full my-auto`}>
        {/* Header */}
        <div className={`${CSS.modalHeader} flex items-center justify-between`}>
          <div className="flex items-center gap-3">
            <div className="p-2 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg">
              <Sparkles className="w-5 h-5 text-white" />
            </div>
            <div>
              <h3 className="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-400">
                {title}
              </h3>
              {subtitle && (
                <p className="text-xs theme-text-muted mt-1">{subtitle}</p>
              )}
            </div>
          </div>
          {/* v1.35.64: Bot√£o X */}
          <button
            onClick={onClose}
            className="w-8 h-8 rounded-full theme-bg-secondary theme-hover-bg flex items-center justify-center theme-text-secondary transition-all border theme-border-modal hover:border-current"
          >
            <X className="w-4 h-4" />
          </button>
        </div>

        {/* Aviso CNJ */}
        <div className="mx-6 mt-4 p-3 bg-amber-500/10 border border-amber-500/40 rounded-lg">
          <div className="flex items-start gap-2">
            <span className="text-amber-500">‚ö†Ô∏è</span>
            <div className="text-xs text-amber-700 dark:text-amber-200">
              <span className="font-semibold">Lembre-se:</span> A IA pode gerar conte√∫do impreciso ou incompleto. Revise e valide todas as informa√ß√µes geradas.
              <span className="block mt-1 text-amber-600 dark:text-amber-300/80">Sua revis√£o √© fundamental, na forma estabelecida pela <span className="font-semibold">Resolu√ß√£o 615/2025 do CNJ</span>.</span>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="p-6 space-y-4 max-h-[65vh] overflow-y-auto">
          {/* Conte√∫do extra (ex: seletor de escopo) */}
          {extraContent}

          {/* Campo de Instru√ß√µes */}
          <div>
            {/* v1.35.62: Label + VoiceButton */}
            <div className="flex items-center justify-between mb-2">
              <label className={CSS.label}>Sua Instru√ß√£o para a IA</label>
              <VoiceButton
                onTranscript={handleVoiceInstruction}
                size="sm"
                idleText="Ditar"
                onError={(err) => console.warn('[VoiceToText]', err)}
              />
            </div>
            <textarea
              value={aiInstruction}
              onChange={(e) => setAiInstruction(e.target.value)}
              className="w-full h-24 theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary resize-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500"
              placeholder={placeholder}
            />
          </div>

          {/* Exemplos */}
          <div className="theme-bg-app-50 p-4 rounded-lg border theme-border-input">
            <p className="text-xs theme-text-muted mb-2">üí° Exemplos de instru√ß√µes:</p>
            {customExamples || defaultExamples}
          </div>

          {/* Bot√£o Gerar */}
          <button
            onClick={onGenerateText}
            disabled={generatingAi || !aiInstruction.trim()}
            className="w-full py-3 rounded-lg font-medium disabled:opacity-50 flex items-center justify-center gap-2 text-white bg-gradient-to-r from-purple-600 to-blue-600 hover-gradient-purple-blue-darker transition-all duration-300"
          >
            {generatingAi ? (
              <>
                <div className={CSS.spinner}></div>
                Gerando...
              </>
            ) : (
              <>
                <Sparkles className="w-4 h-4" />
                Gerar Texto
              </>
            )}
          </button>

          {/* Texto Gerado + Bot√µes de A√ß√£o */}
          {aiGeneratedText && (
            <div className="space-y-3">
              <label className="block text-sm font-medium text-green-600 dark:text-green-400">
                ‚úì Texto Gerado pela IA:
              </label>
              <div
                className="theme-bg-app border border-green-600/30 rounded-lg p-4 max-h-64 overflow-auto theme-text-secondary leading-relaxed"
                dangerouslySetInnerHTML={{ __html: sanitizeHTML(aiGeneratedText) }}
              />
              <div className={`grid gap-2 ${showInsertButtons && showCopyButton ? 'grid-cols-4' : showInsertButtons ? 'grid-cols-3' : 'grid-cols-1'}`}>
                {showInsertButtons && (
                  <>
                    <button
                      onClick={() => onInsertText('replace')}
                      className="py-2 rounded-lg text-sm bg-amber-600 hover-amber-700-from-600"
                    >
                      Substituir Tudo
                    </button>
                    <button
                      onClick={() => onInsertText('prepend')}
                      className="py-2 rounded-lg text-sm bg-blue-600 text-white hover-blue-700"
                    >
                      Adicionar no In√≠cio
                    </button>
                    <button
                      onClick={() => onInsertText('append')}
                      className="py-2 rounded-lg text-sm bg-green-600 text-white hover-green-700-from-600"
                    >
                      Adicionar no Final
                    </button>
                  </>
                )}
                {showCopyButton && (
                  <button
                    onClick={handleCopyText}
                    disabled={copied}
                    className={`py-2 rounded-lg text-sm ${copied ? 'bg-green-600' : 'theme-bg-tertiary hover-slate-500'}`}
                  >
                    {copied ? '‚úì Copiado' : 'üìã Copiar'}
                  </button>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className={CSS.modalFooter}>
          <button
            onClick={onClose}
            className="flex-1 py-3 rounded-lg font-medium theme-bg-tertiary hover-slate-500"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  );
});

AIAssistantBaseLegacy.displayName = 'AIAssistantBaseLegacy';

// ü§ñ v1.19.0: AIAssistantBase - Base para Assistentes IA com CHAT INTERATIVO
const AIAssistantBase = React.memo(({
  isOpen,
  onClose,
  chatHistory,
  onSendMessage,
  onInsertResponse,
  generating,
  onClear,
  lastResponse,
  // Configura√ß√µes opcionais
  title = 'Assistente de Reda√ß√£o IA',
  subtitle = null,
  zIndex = 60,
  placeholder = 'Digite sua mensagem...',
  extraContent = null,
  showInsertButtons = true,
  sanitizeHTML = (html) => html || '',
  quickPrompts = [],  // v1.20.0: Prompts r√°pidos
  topicTitle = '',    // v1.21.1: T√≠tulo do t√≥pico para substitui√ß√£o em quick prompts
  onQuickPromptClick = null, // v1.21.1: Handler opcional para quick prompts (permite valida√ß√£o)
  qpError = null,     // v1.21.2: Estado de erro para mostrar no bot√£o do quick prompt
}) => {
  // Bloquear scroll do body quando modal est√° aberto
  React.useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
      return () => { document.body.style.overflow = ''; };
    }
  }, [isOpen]);

  // ESC handler
  React.useEffect(() => {
    const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
    if (isOpen) window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  const handleInsert = (mode) => {
    if (lastResponse) onInsertResponse(mode);
  };

  return (
    <div className={`${CSS.modalOverlay} overflow-auto`} style={{ zIndex }}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-4xl w-full my-auto`}>
        {/* Header */}
        <div className={CSS.modalHeader}>
          <div className="flex items-center justify-between w-full">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-purple-500/20">
                <Sparkles className="w-6 h-6 text-purple-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold theme-text-primary">{title}</h3>
                {subtitle && <p className="text-sm theme-text-muted">{subtitle}</p>}
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>

        {/* Aviso CNJ */}
        <div className="mx-6 mt-4 p-3 bg-amber-500/10 border border-amber-500/40 rounded-lg">
          <div className="flex items-start gap-2">
            <span className="text-amber-500">‚ö†Ô∏è</span>
            <div className="text-xs text-amber-700 dark:text-amber-200">
              <span className="font-semibold">Lembre-se:</span> A IA pode gerar conte√∫do impreciso. Revise todas as informa√ß√µes.
              <span className="block mt-1 text-amber-600 dark:text-amber-300/80">
                Revis√£o obrigat√≥ria conforme <span className="font-semibold">Resolu√ß√£o 615/2025 do CNJ</span>.
              </span>
            </div>
          </div>
        </div>

        {/* Conte√∫do extra (ex: seletor de escopo) */}
        {extraContent && <div className="px-6 pt-4">{extraContent}</div>}

        {/* Content */}
        <div className="p-6 space-y-4">
          {/* √Årea de Chat */}
          <div className="border theme-border-input rounded-lg">
            <div className="flex items-center justify-between px-4 py-2 border-b theme-border-input theme-bg-secondary">
              <span className="text-sm font-medium theme-text-secondary">üí¨ Conversa</span>
              {chatHistory.length > 0 && (
                <button onClick={onClear} className="text-xs theme-text-muted hover-text-red-400">
                  Limpar
                </button>
              )}
            </div>
            <ChatHistoryArea
              history={chatHistory}
              generating={generating}
              onUseMessage={() => onInsertResponse('append')}
              showUseButtons={showInsertButtons}
              sanitizeHTML={sanitizeHTML}
            />
          </div>

          {/* v1.20.0: Prompts R√°pidos */}
          {quickPrompts?.length > 0 && (
            <div className="flex flex-wrap gap-2">
              <span className="text-xs theme-text-muted w-full mb-1">‚ö° Prompts r√°pidos:</span>
              {quickPrompts.map(qp => {
                const resolvedPrompt = qp.prompt.replace(/\{TOPICO\}/g, topicTitle || 't√≥pico atual');
                const isError = qpError?.id === qp.id;
                return (
                  <button
                    key={qp.id}
                    onClick={() => {
                      // v1.21.1: Se onQuickPromptClick existe, usa para valida√ß√£o; sen√£o, envia direto
                      if (onQuickPromptClick) {
                        onQuickPromptClick(qp, resolvedPrompt);
                      } else {
                        onSendMessage(resolvedPrompt);
                      }
                    }}
                    disabled={generating || isError}
                    className={`px-3 py-1.5 text-xs rounded-full border transition-colors ${
                      isError
                        ? 'bg-red-500/20 border-red-500 text-red-400 cursor-not-allowed'
                        : 'hover-quick-prompt theme-bg-secondary text-blue-600 dark:text-blue-400 theme-border-input disabled:opacity-50 disabled:cursor-not-allowed'
                    }`}
                    title={isError ? qpError.message : resolvedPrompt}
                  >
                    {isError ? <>‚ö†Ô∏è {qpError.message}</> : <>{qp.icon} {qp.name}</>}
                  </button>
                );
              })}
            </div>
          )}

          {/* Input de Chat */}
          <ChatInput onSend={onSendMessage} disabled={generating} placeholder={placeholder} />

          {/* Exemplos (apenas se chat vazio) */}
          {chatHistory.length === 0 && (
            <div className="theme-bg-app-50 p-4 rounded-lg border theme-border-input">
              <p className="text-xs theme-text-muted mb-2">üí° Exemplos:</p>
              <ul className="text-xs theme-text-disabled space-y-1">
                <li>‚Ä¢ "Escreva a fundamenta√ß√£o sobre horas extras"</li>
                <li>‚Ä¢ "Argumente pelo reconhecimento do v√≠nculo"</li>
                <li>‚Ä¢ "Refute a defesa sobre jornada de trabalho"</li>
              </ul>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className={`${CSS.modalFooter} justify-between`}>
          <InsertDropdown onInsert={handleInsert} disabled={!lastResponse} />
          <button onClick={onClose} className="px-6 py-2 rounded-lg font-medium theme-bg-tertiary hover-slate-500">
            Fechar
          </button>
        </div>
      </div>
    </div>
  );
});
AIAssistantBase.displayName = 'AIAssistantBase';

// ü§ñ v1.19.0: AIAssistantModal - Wrapper com seletor de escopo e CHAT INTERATIVO para Editor de T√≥picos
const AIAssistantModal = React.memo(({
  isOpen,
  onClose,
  contextScope,
  setContextScope,
  topicTitle,
  // Props do chat
  chatHistory,
  onSendMessage,
  onInsertResponse,
  generating,
  onClear,
  lastResponse,
  sanitizeHTML = (html) => html || '',
  quickPrompts = [],  // v1.20.0
  proofManager = null  // v1.21.1: Para valida√ß√£o de provas orais
}) => {
  // v1.21.2: Estado para erro no bot√£o do quick prompt
  const [qpError, setQpError] = React.useState(null);

  // v1.21.2: Handler para quick prompts com valida√ß√£o - mostra erro no pr√≥prio bot√£o
  const handleQuickPromptClick = React.useCallback((qp, resolvedPrompt) => {
    if (qp.proofFilter === 'oral') {
      const hasOral = hasOralProofsForTopic(proofManager, topicTitle);
      if (!hasOral) {
        // Mostrar erro no pr√≥prio bot√£o por 3 segundos
        setQpError({ id: qp.id, message: 'Prova oral n√£o vinculada' });
        setTimeout(() => setQpError(null), 3000);
        return;
      }
      onSendMessage(resolvedPrompt, { proofFilter: 'oral' });
    } else {
      onSendMessage(resolvedPrompt);
    }
  }, [proofManager, topicTitle, onSendMessage]);

  const scopeSelector = (
    <div>
      <label className={CSS.label}>Escopo do Contexto</label>
      <div className="flex gap-4 mt-2">
        <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${
          contextScope === 'current'
            ? 'border-purple-500 bg-purple-500/10'
            : 'theme-border-input theme-bg-secondary-30 hover-theme-border'
        }`}>
          <input
            type="radio"
            name="topicContextScope"
            value="current"
            checked={contextScope === 'current'}
            onChange={() => setContextScope('current')}
            className="w-4 h-4 text-purple-600"
          />
          <div>
            <span className="text-sm font-medium theme-text-primary">Apenas este t√≥pico</span>
            <p className="text-xs theme-text-muted">Mini-relat√≥rio + decis√£o do t√≥pico atual</p>
          </div>
        </label>
        <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${
          contextScope === 'all'
            ? 'border-purple-500 bg-purple-500/10'
            : 'theme-border-input theme-bg-secondary-30 hover-theme-border'
        }`}>
          <input
            type="radio"
            name="topicContextScope"
            value="all"
            checked={contextScope === 'all'}
            onChange={() => setContextScope('all')}
            className="w-4 h-4 text-purple-600"
          />
          <div>
            <span className="text-sm font-medium theme-text-primary">Toda a decis√£o</span>
            <p className="text-xs theme-text-muted">RELAT√ìRIO + todos os t√≥picos</p>
          </div>
        </label>
      </div>
    </div>
  );

  return (
    <AIAssistantBase
      isOpen={isOpen}
      onClose={onClose}
      chatHistory={chatHistory}
      onSendMessage={onSendMessage}
      onInsertResponse={onInsertResponse}
      generating={generating}
      onClear={onClear}
      lastResponse={lastResponse}
      zIndex={60}
      subtitle={topicTitle ? <>T√≥pico: <span className="font-semibold text-purple-400">{topicTitle}</span></> : null}
      extraContent={scopeSelector}
      sanitizeHTML={sanitizeHTML}
      quickPrompts={quickPrompts}
      topicTitle={topicTitle}
      onQuickPromptClick={handleQuickPromptClick}
      qpError={qpError}
    />
  );
});

AIAssistantModal.displayName = 'AIAssistantModal';

// ü§ñ v1.19.0: AIAssistantGlobalModal - Para Editor Global com CHAT INTERATIVO
const AIAssistantGlobalModal = React.memo(({
  isOpen,
  onClose,
  contextScope,
  setContextScope,
  topicTitle,
  // Props do chat
  chatHistory,
  onSendMessage,
  onInsertResponse,
  generating,
  onClear,
  lastResponse,
  sanitizeHTML = (html) => html || '',
  quickPrompts = [],  // v1.20.0
  proofManager = null  // v1.21.1: Para valida√ß√£o de provas orais
}) => {
  // v1.21.2: Estado para erro no bot√£o do quick prompt
  const [qpError, setQpError] = React.useState(null);

  // v1.21.2: Handler para quick prompts com valida√ß√£o - mostra erro no pr√≥prio bot√£o
  const handleQuickPromptClick = React.useCallback((qp, resolvedPrompt) => {
    if (qp.proofFilter === 'oral') {
      const hasOral = hasOralProofsForTopic(proofManager, topicTitle);
      if (!hasOral) {
        // Mostrar erro no pr√≥prio bot√£o por 3 segundos
        setQpError({ id: qp.id, message: 'Prova oral n√£o vinculada' });
        setTimeout(() => setQpError(null), 3000);
        return;
      }
      onSendMessage(resolvedPrompt, { proofFilter: 'oral' });
    } else {
      onSendMessage(resolvedPrompt);
    }
  }, [proofManager, topicTitle, onSendMessage]);

  // Componente de sele√ß√£o de escopo para passar como extraContent
  const scopeSelector = (
    <div>
      <label className={CSS.label}>Escopo do Contexto</label>
      <div className="flex gap-4 mt-2">
        <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${
          contextScope === 'current'
            ? 'border-purple-500 bg-purple-500/10'
            : 'theme-border-input theme-bg-secondary-30 hover-theme-border'
        }`}>
          <input
            type="radio"
            name="contextScope"
            value="current"
            checked={contextScope === 'current'}
            onChange={() => setContextScope('current')}
            className="w-4 h-4 text-purple-600"
          />
          <div>
            <span className="text-sm font-medium theme-text-primary">Apenas este t√≥pico</span>
            <p className="text-xs theme-text-muted">Mini-relat√≥rio + decis√£o do t√≥pico atual</p>
          </div>
        </label>
        <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${
          contextScope === 'all'
            ? 'border-purple-500 bg-purple-500/10'
            : 'theme-border-input theme-bg-secondary-30 hover-theme-border'
        }`}>
          <input
            type="radio"
            name="contextScope"
            value="all"
            checked={contextScope === 'all'}
            onChange={() => setContextScope('all')}
            className="w-4 h-4 text-purple-600"
          />
          <div>
            <span className="text-sm font-medium theme-text-primary">Toda a decis√£o</span>
            <p className="text-xs theme-text-muted">RELAT√ìRIO + todos os t√≥picos</p>
          </div>
        </label>
      </div>
    </div>
  );

  return (
    <AIAssistantBase
      isOpen={isOpen}
      onClose={onClose}
      chatHistory={chatHistory}
      onSendMessage={onSendMessage}
      onInsertResponse={onInsertResponse}
      generating={generating}
      onClear={onClear}
      lastResponse={lastResponse}
      zIndex={70}
      subtitle={<>T√≥pico: <span className="font-semibold text-purple-400">{topicTitle}</span></>}
      extraContent={scopeSelector}
      sanitizeHTML={sanitizeHTML}
      quickPrompts={quickPrompts}
      topicTitle={topicTitle}
      onQuickPromptClick={handleQuickPromptClick}
      qpError={qpError}
    />
  );
});

AIAssistantGlobalModal.displayName = 'AIAssistantGlobalModal';

// ü§ñ v1.19.0: AIAssistantModelModal - Wrapper para modelos (usa Legacy - single-shot, n√£o chat)
const AIAssistantModelModal = React.memo(({
  isOpen,
  onClose,
  aiInstructionModel,
  setAiInstructionModel,
  generatingAiModel,
  aiGeneratedTextModel,
  onGenerateText,
  onInsertText,
  sanitizeHTML = (html) => html || ''
}) => {
  // Exemplos espec√≠ficos para cria√ß√£o de modelos
  const modelExamples = (
    <ul className="text-xs theme-text-disabled space-y-1">
      <li>‚Ä¢ "Escreva um modelo gen√©rico de fundamenta√ß√£o sobre reconhecimento de v√≠nculo empregat√≠cio"</li>
      <li>‚Ä¢ "Crie um par√°grafo padr√£o explicando os requisitos da CLT para horas extras"</li>
      <li>‚Ä¢ "Desenvolva um modelo de conclus√£o julgando procedente pedido de adicional de insalubridade"</li>
      <li>‚Ä¢ "Elabore um texto padr√£o sobre prescri√ß√£o bienal"</li>
      <li>‚Ä¢ "Redija um modelo de fundamenta√ß√£o sobre rescis√£o indireta"</li>
    </ul>
  );

  // v1.19.0: Usa vers√£o Legacy para manter comportamento single-shot (n√£o chat)
  return (
    <AIAssistantBaseLegacy
      isOpen={isOpen}
      onClose={onClose}
      aiInstruction={aiInstructionModel}
      setAiInstruction={setAiInstructionModel}
      generatingAi={generatingAiModel}
      aiGeneratedText={aiGeneratedTextModel}
      onGenerateText={onGenerateText}
      onInsertText={onInsertText}
      zIndex={60}
      title="Assistente de Reda√ß√£o IA - Modelos"
      subtitle="Instrua a IA sobre o que voc√™ deseja escrever no modelo"
      placeholder="Ex: Escreva um modelo de fundamenta√ß√£o sobre horas extras que possa ser adaptado para diferentes casos..."
      customExamples={modelExamples}
      sanitizeHTML={sanitizeHTML}
    />
  );
});

AIAssistantModelModal.displayName = 'AIAssistantModelModal';

const AnalysisModal = React.memo(({
  isOpen,
  analysisProgress,
  peticaoFiles,
  pastedPeticaoTexts,
  contestacaoFiles,
  pastedContestacaoTexts,
  complementaryFiles,
  pastedComplementaryTexts
}) => {
  if (!isOpen) return null;

  const totalPeticoes = (peticaoFiles?.length || 0) + (pastedPeticaoTexts?.length || 0);

  return (
    <div className={CSS.modalOverlay}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-lg w-full`}>
        <div className={CSS.modalHeader}>
          <div className="flex items-center gap-3">
            <div className="p-3 rounded-xl bg-blue-500/20">
              <Loader2 className="w-6 h-6 text-blue-400 animate-spin" />
            </div>
            <div>
              <h3 className="text-lg font-semibold theme-text-primary">An√°lise em Andamento</h3>
              <p className="text-sm theme-text-muted">Por favor, aguarde enquanto processamos os documentos</p>
            </div>
          </div>
        </div>

        <div className="p-8">
          <div className="flex flex-col items-center gap-6">
            {/* Spinner Neon + Ripple - v1.33.49 */}
            <div className="spinner-neon-ripple">
              <div className="ripple"></div>
              <div className="ripple"></div>
              <div className="ripple"></div>
              <div className="core">
                <div className="outer"></div>
                <div className="inner"></div>
              </div>
            </div>

            {/* Mensagem de progresso */}
            <div className="text-center space-y-2 w-full">
              <p className="text-lg font-medium theme-text-secondary">{analysisProgress}</p>

              {/* Barra de progresso animada */}
              <div className="w-full theme-bg-secondary rounded-full h-2 overflow-hidden">
                <div className="h-full bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500 animate-pulse"
                     style={{
                       width: '100%',
                       animation: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                     }}>
                </div>
              </div>
            </div>

            {/* Informa√ß√µes adicionais */}
            <div className="theme-bg-app-50 rounded-lg p-4 w-full border theme-border-input">
              <div className="space-y-2 text-sm theme-text-muted">
                <div className={CSS.flexGap2}>
                  <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                  <span>
                    Docs do Autor: {totalPeticoes > 0 ? `${totalPeticoes} documento${totalPeticoes !== 1 ? 's' : ''}` : 'N√£o anexados'}
                  </span>
                </div>
                {(contestacaoFiles.length > 0 || pastedContestacaoTexts.length > 0) && (
                  <div className={CSS.flexGap2}>
                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span>
                      Contesta√ß√µes: {contestacaoFiles.length + pastedContestacaoTexts.length} documento{(contestacaoFiles.length + pastedContestacaoTexts.length) !== 1 ? 's' : ''}
                      {pastedContestacaoTexts.length > 0 && ` (${pastedContestacaoTexts.length} texto${pastedContestacaoTexts.length !== 1 ? 's' : ''})`}
                    </span>
                  </div>
                )}
                {(complementaryFiles.length > 0 || pastedComplementaryTexts.length > 0) && (
                  <div className={CSS.flexGap2}>
                    <div className="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
                    <span>
                      Complementares: {complementaryFiles.length + pastedComplementaryTexts.length} documento{(complementaryFiles.length + pastedComplementaryTexts.length) !== 1 ? 's' : ''}
                    </span>
                  </div>
                )}
              </div>
            </div>

            {/* Dica */}
            <div className="text-xs text-center theme-text-disabled max-w-sm">
              üí° A an√°lise pode levar de 30 segundos a 2 minutos dependendo do tamanho dos documentos e da complexidade do processo.
            </div>
          </div>
        </div>
      </div>
    </div>
  );
});

AnalysisModal.displayName = 'AnalysisModal';

// Modal: Exportar Minuta (migrado para BaseModal v1.18.3)
const ExportModal = React.memo(({ isOpen, onClose, exportedText, exportedHtml, copySuccess, setCopySuccess, setError }) => {
  const timeoutRef = React.useRef(null);
  React.useEffect(() => () => { if (timeoutRef.current) clearTimeout(timeoutRef.current); }, []);
  const handleCopy = async () => {
    try {
      const htmlBlob = new Blob([exportedHtml], { type: 'text/html' });
      const textBlob = new Blob([exportedText], { type: 'text/plain' });
      await navigator.clipboard.write([new ClipboardItem({ 'text/html': htmlBlob, 'text/plain': textBlob })]);
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
      setCopySuccess(true);
      timeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
    } catch (clipErr) {
      try { await navigator.clipboard.writeText(exportedText); if (timeoutRef.current) clearTimeout(timeoutRef.current); setCopySuccess(true); timeoutRef.current = setTimeout(() => setCopySuccess(false), 3000); } catch (err) { setError('Erro ao copiar texto'); }
    }
  };
  return (
    <BaseModal isOpen={isOpen} onClose={onClose} title="Minuta Exportada" icon={<Download />} iconColor="blue" size="xl"
      footer={<>
        <button onClick={handleCopy} className="flex-1 py-3 rounded-lg font-medium bg-blue-600 text-white hover-blue-700-from-600">üìã Copiar com Formata√ß√£o</button>
        <button onClick={onClose} className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500">Fechar</button>
      </>}>
      <div className="space-y-4">
        {copySuccess && <p className="text-green-400 text-sm">‚úì Copiado para √°rea de transfer√™ncia!</p>}
        <ModalInfoBox>
          <strong>Formata√ß√£o Preservada</strong> - O conte√∫do foi copiado com toda a formata√ß√£o. Cole diretamente no Google Docs ou Word usando Ctrl+V.
        </ModalInfoBox>
        <textarea value={exportedText} readOnly className="w-full min-h-[400px] theme-bg-app border theme-border-input rounded-lg p-4 theme-text-primary font-mono text-sm resize-none" />
      </div>
    </BaseModal>
  );
});
ExportModal.displayName = 'ExportModal';

// Modal: Restaurar Sess√£o (migrado para BaseModal)
// v1.33.62: preventClose - usu√°rio deve escolher uma op√ß√£o
const RestoreSessionModal = React.memo(({ isOpen, onClose, sessionLastSaved, onRestoreSession, onStartNew }) => (
  <BaseModal isOpen={isOpen} onClose={onClose} title="Sess√£o Anterior Encontrada" icon={<Save />} iconColor="blue" size="sm" preventClose
    footer={<><button onClick={onRestoreSession} className={CSS.btnGreen}>‚úÖ Continuar Sess√£o</button><button onClick={onStartNew} className={CSS.btnRed}>üóëÔ∏è Come√ßar do Zero</button></>}>
    <div className="space-y-4">
      <p className="text-xs theme-text-muted">√öltima atualiza√ß√£o: {sessionLastSaved ? new Date(sessionLastSaved).toLocaleString('pt-BR') : ''}</p>
      <p className="theme-text-tertiary">Encontramos uma sess√£o salva. Deseja continuar ou come√ßar uma nova senten√ßa?</p>
      <ModalInfoBox>üí° <strong>Dica:</strong> Use "Salvar Projeto" para fazer backup seguro.</ModalInfoBox>
    </div>
  </BaseModal>
));
RestoreSessionModal.displayName = 'RestoreSessionModal';

// Modal: Limpar Projeto (migrado para BaseModal)
const ClearProjectModal = React.memo(({ isOpen, onClose, onConfirmClear }) => (
  <BaseModal isOpen={isOpen} onClose={onClose} title="Limpar Projeto" icon={<Trash2 />} iconColor="red" size="sm"
    footer={<ModalFooter.Destructive onClose={onClose} onConfirm={onConfirmClear} confirmText="Sim, Limpar Tudo" />}>
    <div className="space-y-4">
      <p className="theme-text-tertiary">Tem certeza que deseja <strong>limpar todos os dados</strong> do projeto?</p>
      <ModalAmberBox>
        <p className="text-xs theme-text-primary mb-2"><strong>‚ö†Ô∏è Aten√ß√£o! Isto ir√° apagar:</strong></p>
        <ul className="text-xs theme-text-secondary space-y-1 ml-4 list-disc">
          <li>Todos os documentos (PDFs e textos)</li>
          <li>Todos os t√≥picos e decis√µes</li>
          <li>Todo o progresso da senten√ßa</li>
        </ul>
      </ModalAmberBox>
      <ModalInfoBox>üí° <strong>Dica:</strong> Se quiser manter seus dados, clique em "Salvar Projeto" antes.</ModalInfoBox>
    </div>
  </BaseModal>
));
ClearProjectModal.displayName = 'ClearProjectModal';

// v1.33.57: Modal de confirma√ß√£o de logout estilizado
const LogoutConfirmModal = React.memo(({ isOpen, onClose, onConfirm }) => (
  <BaseModal isOpen={isOpen} onClose={onClose} title="Sair do Sistema" icon={<LogOut />} iconColor="red" size="sm"
    footer={<ModalFooter.Destructive onClose={onClose} onConfirm={onConfirm} confirmText="Sim, Sair" />}>
    <div className="space-y-4">
      <p className="theme-text-tertiary">Deseja realmente sair do sistema?</p>
      <ModalInfoBox>üíæ Seus dados permanecer√£o salvos localmente.</ModalInfoBox>
    </div>
  </BaseModal>
));
LogoutConfirmModal.displayName = 'LogoutConfirmModal';

// v1.35.1: Modal para compartilhar biblioteca de modelos (convite por email)
// v1.35.23: Adicionado onRemoveSharedModels para limpar modelos ao remover acesso
const ShareLibraryModal = React.memo(({ isOpen, onClose, user, onRemoveSharedModels }) => {
  const [permission, setPermission] = React.useState('view');
  const [loading, setLoading] = React.useState(false);
  const [recipientEmail, setRecipientEmail] = React.useState('');
  const [successMessage, setSuccessMessage] = React.useState('');
  const [errorMessage, setErrorMessage] = React.useState('');
  const [shares, setShares] = React.useState([]);
  const [sharedWithMe, setSharedWithMe] = React.useState([]);
  const [activeTab, setActiveTab] = React.useState('share'); // 'share' | 'myShares' | 'sharedWithMe'

  // Buscar compartilhamentos ao abrir
  React.useEffect(() => {
    if (!isOpen) return;
    const fetchShares = async () => {
      try {
        const token = localStorage.getItem('sentencify-auth-token');
        const [mySharesRes, sharedWithMeRes] = await Promise.all([
          fetch(`${API_BASE}/api/share/library/my-shares`, {
            headers: { 'Authorization': `Bearer ${token}` }
          }),
          fetch(`${API_BASE}/api/share/library/shared-with-me`, {
            headers: { 'Authorization': `Bearer ${token}` }
          })
        ]);
        if (mySharesRes.ok) {
          const data = await mySharesRes.json();
          setShares(data.shares || []);
        }
        if (sharedWithMeRes.ok) {
          const data = await sharedWithMeRes.json();
          setSharedWithMe(data.libraries || []);
        }
      } catch (err) {
        console.error('[Share] Fetch error:', err);
      }
    };
    fetchShares();
    setRecipientEmail('');
    setSuccessMessage('');
    setErrorMessage('');
  }, [isOpen]);

  // v1.35.1: Enviar convite por email
  const handleSendInvite = async () => {
    if (!recipientEmail || !recipientEmail.includes('@')) {
      setErrorMessage('Por favor, informe um email v√°lido.');
      return;
    }
    setLoading(true);
    setErrorMessage('');
    setSuccessMessage('');
    try {
      const token = localStorage.getItem('sentencify-auth-token');
      const res = await fetch(`${API_BASE}/api/share/library`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ permission, recipientEmail })
      });
      const data = await res.json();
      if (res.ok) {
        setSuccessMessage(`Convite enviado para ${recipientEmail}!`);
        setRecipientEmail('');
        // Adicionar √† lista de convites
        setShares(prev => [{
          id: data.shareId,
          permission,
          recipient_email: recipientEmail.toLowerCase(),
          created_at: new Date().toISOString(),
          recipients: []
        }, ...prev]);
      } else {
        setErrorMessage(data.error || 'Erro ao enviar convite.');
      }
    } catch (err) {
      console.error('[Share] Send invite error:', err);
      setErrorMessage('Erro de conex√£o. Tente novamente.');
    } finally {
      setLoading(false);
    }
  };

  const handleRevoke = async (shareId) => {
    try {
      const token = localStorage.getItem('sentencify-auth-token');
      const res = await fetch(`${API_BASE}/api/share/library/${shareId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.ok) {
        setShares(prev => prev.filter(s => s.id !== shareId));
      }
    } catch (err) {
      console.error('[Share] Revoke error:', err);
    }
  };

  const handleRemoveAccess = async (accessId) => {
    try {
      // v1.35.23: Encontrar ownerId antes de remover
      const accessToRemove = sharedWithMe.find(s => s.accessId === accessId);
      const ownerIdToRemove = accessToRemove?.ownerId;

      const token = localStorage.getItem('sentencify-auth-token');
      const res = await fetch(`${API_BASE}/api/share/library/access/${accessId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.ok) {
        setSharedWithMe(prev => prev.filter(s => s.accessId !== accessId));

        // v1.35.23: Remover modelos compartilhados desse owner da biblioteca
        if (ownerIdToRemove && onRemoveSharedModels) {
          onRemoveSharedModels(ownerIdToRemove);
        }
      }
    } catch (err) {
      console.error('[Share] Remove access error:', err);
    }
  };

  return (
    <BaseModal isOpen={isOpen} onClose={onClose} title="Compartilhar Biblioteca" icon={<Share2 />} iconColor="purple" size="lg">
      <div className="space-y-4">
        {/* Tabs */}
        <div className="flex border-b theme-border-primary">
          <button
            onClick={() => setActiveTab('share')}
            className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
              activeTab === 'share' ? 'border-purple-500 text-purple-400' : 'border-transparent theme-text-tertiary hover:text-purple-400'
            }`}
          >
            Compartilhar
          </button>
          <button
            onClick={() => setActiveTab('myShares')}
            className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
              activeTab === 'myShares' ? 'border-purple-500 text-purple-400' : 'border-transparent theme-text-tertiary hover:text-purple-400'
            }`}
          >
            Meus Convites ({shares.length})
          </button>
          <button
            onClick={() => setActiveTab('sharedWithMe')}
            className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
              activeTab === 'sharedWithMe' ? 'border-purple-500 text-purple-400' : 'border-transparent theme-text-tertiary hover:text-purple-400'
            }`}
          >
            Recebidos ({sharedWithMe.length})
          </button>
        </div>

        {/* Tab: Compartilhar */}
        {activeTab === 'share' && (
          <div className="space-y-4">
            <ModalInfoBox>üìß Digite o email do destinat√°rio para enviar um convite de compartilhamento da sua biblioteca de modelos.</ModalInfoBox>

            {/* Campo de email */}
            <div>
              <label className={CSS.label}>Email do destinat√°rio</label>
              <input
                type="email"
                value={recipientEmail}
                onChange={(e) => setRecipientEmail(e.target.value)}
                placeholder="email@exemplo.com"
                className={`${CSS.input} mt-2`}
                onKeyDown={(e) => e.key === 'Enter' && !loading && handleSendInvite()}
              />
            </div>

            {/* Permiss√£o */}
            <div>
              <label className={CSS.label}>Permiss√£o</label>
              <div className="flex gap-3 mt-2">
                <label className={`flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer border transition-colors ${
                  permission === 'view'
                    ? 'border-purple-500 bg-purple-100 text-purple-700 dark:bg-purple-500/20 dark:text-purple-300'
                    : 'theme-border-primary theme-bg-secondary theme-text-secondary'
                }`}>
                  <input type="radio" name="permission" value="view" checked={permission === 'view'} onChange={() => setPermission('view')} className="hidden" />
                  <Eye className="w-4 h-4" />
                  <span className="text-sm">Somente Leitura</span>
                </label>
                <label className={`flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer border transition-colors ${
                  permission === 'edit'
                    ? 'border-purple-500 bg-purple-100 text-purple-700 dark:bg-purple-500/20 dark:text-purple-300'
                    : 'theme-border-primary theme-bg-secondary theme-text-secondary'
                }`}>
                  <input type="radio" name="permission" value="edit" checked={permission === 'edit'} onChange={() => setPermission('edit')} className="hidden" />
                  <Edit3 className="w-4 h-4" />
                  <span className="text-sm">Leitura e Escrita</span>
                </label>
              </div>
            </div>

            {/* Bot√£o enviar */}
            <button
              onClick={handleSendInvite}
              disabled={loading || !recipientEmail}
              className="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
            >
              {loading ? <RefreshCw className="w-4 h-4 animate-spin" /> : <Mail className="w-4 h-4" />}
              {loading ? 'Enviando...' : 'Enviar Convite'}
            </button>

            {/* Mensagem de sucesso */}
            {successMessage && (
              <div className="p-3 bg-green-500/20 border border-green-500/50 rounded-lg">
                <p className="text-green-400 text-sm flex items-center gap-2">
                  <Check className="w-4 h-4" />
                  {successMessage}
                </p>
              </div>
            )}

            {/* Mensagem de erro */}
            {errorMessage && (
              <div className="p-3 bg-red-500/20 border border-red-500/50 rounded-lg">
                <p className="text-red-400 text-sm flex items-center gap-2">
                  <AlertCircle className="w-4 h-4" />
                  {errorMessage}
                </p>
              </div>
            )}
          </div>
        )}

        {/* Tab: Meus Convites */}
        {activeTab === 'myShares' && (
          <div className="space-y-3">
            {shares.length === 0 ? (
              <p className="text-center theme-text-tertiary py-8">Nenhum convite enviado.</p>
            ) : (
              shares.map(share => (
                <div key={share.id} className="p-3 theme-bg-secondary rounded-lg border theme-border-primary">
                  <div className="flex items-center justify-between">
                    <div className="flex-1">
                      {/* Email do destinat√°rio */}
                      <p className="theme-text-secondary font-medium text-sm">
                        {share.recipient_email || 'Link p√∫blico'}
                      </p>
                      <div className="flex items-center gap-2 mt-1">
                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                          share.permission === 'edit'
                            ? 'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-400'
                            : 'bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400'
                        }`}>
                          {share.permission === 'edit' ? 'Leitura/Escrita' : 'Somente Leitura'}
                        </span>
                        {/* Status: pendente ou aceito */}
                        {share.recipients?.length > 0 ? (
                          <span className="px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700 dark:bg-green-500/20 dark:text-green-400">
                            Aceito
                          </span>
                        ) : (
                          <span className="px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-700 dark:bg-yellow-500/20 dark:text-yellow-400">
                            Pendente
                          </span>
                        )}
                        <span className="text-xs theme-text-tertiary">
                          {new Date(share.created_at || share.createdAt).toLocaleDateString('pt-BR')}
                        </span>
                      </div>
                    </div>
                    <button
                      onClick={() => handleRevoke(share.id)}
                      className="text-red-400 hover:text-red-300 text-xs ml-2"
                    >
                      Revogar
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        )}

        {/* Tab: Compartilhados Comigo */}
        {activeTab === 'sharedWithMe' && (
          <div className="space-y-3">
            {sharedWithMe.length === 0 ? (
              <p className="text-center theme-text-tertiary py-8">Nenhuma biblioteca compartilhada com voc√™.</p>
            ) : (
              sharedWithMe.map(lib => (
                <div key={lib.accessId} className="p-3 theme-bg-secondary rounded-lg border theme-border-primary">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="theme-text-secondary font-medium">{lib.ownerEmail}</p>
                      <div className="flex items-center gap-2 mt-1">
                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                          lib.permission === 'edit'
                            ? 'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-400'
                            : 'bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400'
                        }`}>
                          {lib.permission === 'edit' ? 'Leitura/Escrita' : 'Somente Leitura'}
                        </span>
                        <span className="text-xs theme-text-tertiary">{lib.modelsCount} modelos</span>
                      </div>
                    </div>
                    <button
                      onClick={() => handleRemoveAccess(lib.accessId)}
                      className="text-red-400 hover:text-red-300 text-xs"
                    >
                      Remover
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        )}
      </div>
    </BaseModal>
  );
});
ShareLibraryModal.displayName = 'ShareLibraryModal';

// v1.35.0: P√°gina para aceitar compartilhamento de biblioteca
const AcceptSharePage = React.memo(({ token, onAccepted, onLogin }) => {
  const [loading, setLoading] = React.useState(true);
  const [shareInfo, setShareInfo] = React.useState(null);
  const [error, setError] = React.useState('');
  const [accepting, setAccepting] = React.useState(false);
  const [accepted, setAccepted] = React.useState(false);

  // Buscar informa√ß√µes do compartilhamento
  React.useEffect(() => {
    const fetchShareInfo = async () => {
      try {
        const res = await fetch(`${API_BASE}/api/share/library/${token}`);
        if (res.ok) {
          const data = await res.json();
          setShareInfo(data);
        } else if (res.status === 404) {
          setError('Link de compartilhamento inv√°lido ou expirado.');
        } else {
          setError('Erro ao carregar informa√ß√µes do compartilhamento.');
        }
      } catch (err) {
        console.error('[AcceptShare] Fetch error:', err);
        setError('Erro de conex√£o. Tente novamente.');
      } finally {
        setLoading(false);
      }
    };
    fetchShareInfo();
  }, [token]);

  const handleAccept = async () => {
    setAccepting(true);
    try {
      const authToken = localStorage.getItem('sentencify-auth-token');
      const res = await fetch(`${API_BASE}/api/share/library/${token}/accept`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        }
      });

      if (res.ok) {
        setAccepted(true);
        setTimeout(() => {
          onAccepted?.();
          window.location.href = '/'; // Redirecionar para home
        }, 2000);
      } else if (res.status === 401) {
        onLogin?.(); // Redirecionar para login
      } else {
        const data = await res.json();
        setError(data.error || 'Erro ao aceitar compartilhamento.');
      }
    } catch (err) {
      console.error('[AcceptShare] Accept error:', err);
      setError('Erro de conex√£o. Tente novamente.');
    } finally {
      setAccepting(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center gap-6">
        <div className="spinner-neon-ripple">
          <div className="ripple"></div>
          <div className="ripple"></div>
          <div className="ripple"></div>
          <div className="core">
            <div className="outer"></div>
            <div className="inner"></div>
          </div>
        </div>
        <span className="text-slate-400 animate-pulse">Carregando...</span>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        <div className="max-w-md w-full bg-slate-800 rounded-2xl p-8 shadow-2xl border border-slate-700 text-center">
          <div className="w-16 h-16 mx-auto bg-red-500/20 rounded-full flex items-center justify-center mb-4">
            <X className="w-8 h-8 text-red-400" />
          </div>
          <h2 className="text-xl font-bold text-white mb-2">Link Inv√°lido</h2>
          <p className="text-slate-400 mb-6">{error}</p>
          <button
            onClick={() => window.location.href = '/'}
            className="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors"
          >
            Voltar ao In√≠cio
          </button>
        </div>
      </div>
    );
  }

  if (accepted) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        <div className="max-w-md w-full bg-slate-800 rounded-2xl p-8 shadow-2xl border border-slate-700 text-center">
          <div className="w-16 h-16 mx-auto bg-green-500/20 rounded-full flex items-center justify-center mb-4">
            <Check className="w-8 h-8 text-green-400" />
          </div>
          <h2 className="text-xl font-bold text-white mb-2">Compartilhamento Aceito!</h2>
          <p className="text-slate-400 mb-4">
            Os modelos de <span className="text-purple-400 font-medium">{shareInfo?.owner?.email}</span> agora aparecem na sua biblioteca.
          </p>
          <p className="text-slate-500 text-sm">Redirecionando...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
      <div className="max-w-md w-full bg-slate-800 rounded-2xl p-8 shadow-2xl border border-slate-700">
        <div className="text-center mb-6">
          <div className="w-16 h-16 mx-auto bg-purple-500/20 rounded-full flex items-center justify-center mb-4">
            <Users className="w-8 h-8 text-purple-400" />
          </div>
          <h2 className="text-xl font-bold text-white mb-2">Convite de Compartilhamento</h2>
          <p className="text-slate-400">
            <span className="text-purple-400 font-medium">{shareInfo?.owner?.email}</span> quer compartilhar sua biblioteca de modelos com voc√™.
          </p>
        </div>

        <div className="bg-slate-700/50 rounded-xl p-4 mb-6 space-y-3">
          <div className="flex items-center justify-between">
            <span className="text-slate-400 text-sm">Propriet√°rio</span>
            <span className="text-white font-medium">{shareInfo?.owner?.email}</span>
          </div>
          <div className="flex items-center justify-between">
            <span className="text-slate-400 text-sm">Modelos</span>
            <span className="text-white font-medium">{shareInfo?.modelsCount} modelos</span>
          </div>
          <div className="flex items-center justify-between">
            <span className="text-slate-400 text-sm">Permiss√£o</span>
            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
              shareInfo?.permission === 'edit' ? 'bg-amber-500/20 text-amber-400' : 'bg-blue-500/20 text-blue-400'
            }`}>
              {shareInfo?.permission === 'edit' ? 'Leitura e Escrita' : 'Somente Leitura'}
            </span>
          </div>
        </div>

        <button
          onClick={handleAccept}
          disabled={accepting}
          className="w-full px-6 py-3 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 text-white rounded-xl font-medium transition-colors flex items-center justify-center gap-2"
        >
          {accepting ? (
            <>
              <RefreshCw className="w-5 h-5 animate-spin" />
              Aceitando...
            </>
          ) : (
            <>
              <Check className="w-5 h-5" />
              Aceitar Compartilhamento
            </>
          )}
        </button>

        <p className="text-center text-slate-500 text-xs mt-4">
          Os modelos compartilhados aparecer√£o na sua aba Modelos com indica√ß√£o do propriet√°rio.
        </p>
      </div>
    </div>
  );
});
AcceptSharePage.displayName = 'AcceptSharePage';

// Modal: Anonimiza√ß√£o (migrado para BaseModal) - v1.25: + NER
// v1.29.03: Adicionar overlay IA Local durante detec√ß√£o
const AnonymizationNamesModal = React.memo(({ isOpen, onClose, onConfirm, nomesTexto, setNomesTexto, nerEnabled, onDetectNames, detectingNames, onOpenAiSettings }) => {
  const handleConfirm = () => { onConfirm(nomesTexto.split(/[\n,]/).map(n => n.trim()).filter(n => n.length >= 2)); };
  return (
    <BaseModal isOpen={isOpen} onClose={onClose} title="Anonimiza√ß√£o de Documentos" icon={<AlertCircle />} iconColor="purple" size="lg"
      footer={<ModalFooter.Standard onClose={onClose} onConfirm={handleConfirm} confirmText="Continuar An√°lise" />}>
      {/* v1.32.00: Overlay removido - NER roda em worker */}
      <div className="space-y-4">
        <ModalInfoBox>üîí A anonimiza√ß√£o est√° ativada. Insira os nomes para anonimizar.</ModalInfoBox>
        <div>
          <div className="flex items-center justify-between mb-2">
            <label className={CSS.label}>Nomes para anonimizar (um por linha)</label>
            {/* v1.25: Bot√£o Detectar Nomes com IA */}
            <div className="flex items-center gap-2">
              <button
                onClick={onDetectNames}
                disabled={!nerEnabled || detectingNames}
                title={!nerEnabled ? 'Ative o NER em Configura√ß√µes IA' : 'Detectar nomes automaticamente'}
                className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${
                  nerEnabled && !detectingNames
                    ? 'bg-purple-600 text-white hover-purple-700'
                    : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                }`}
              >
                {detectingNames ? (
                  <>
                    <RefreshCw className="w-3.5 h-3.5 animate-spin" />
                    Detectando...
                  </>
                ) : (
                  <>
                    <Wand2 className="w-3.5 h-3.5" />
                    Detectar Nomes
                  </>
                )}
              </button>
              {!nerEnabled && (
                <button
                  onClick={onOpenAiSettings}
                  className="text-xs text-amber-400 underline"
                  title="Abrir configura√ß√µes de IA"
                >
                  Configurar IA
                </button>
              )}
            </div>
          </div>
          <textarea value={nomesTexto} onChange={(e) => setNomesTexto(e.target.value)}
            className="w-full h-48 theme-bg-app border theme-border-primary rounded-lg p-3 theme-text-secondary font-mono text-sm"
            placeholder="JO√ÉO DA SILVA&#10;MARIA SANTOS&#10;EMPRESA XYZ LTDA&#10;..." />
          <p className="text-xs theme-text-tertiary mt-2">üí° CPF, CNPJ, telefone, e-mail ser√£o anonimizados automaticamente.</p>
        </div>
      </div>
    </BaseModal>
  );
});
AnonymizationNamesModal.displayName = 'AnonymizationNamesModal';

// v1.21.16: Modal de preview de texto extra√≠do
const TextPreviewModal = React.memo(({ isOpen, onClose, title, text }) => {
  // v1.35.67: ESC handler
  React.useEffect(() => {
    if (!isOpen) return;
    const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
    window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  // v1.35.67: Scroll lock
  React.useEffect(() => {
    if (isOpen) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => { document.body.style.overflow = originalOverflow; };
    }
  }, [isOpen]);

  if (!isOpen) return null;

  return (
    <div className={`${CSS.modalOverlay} overflow-y-auto`} style={{ alignItems: 'flex-start' }} onClick={onClose}>
      <div
        className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal w-full max-w-4xl my-8`}
        onClick={(e) => e.stopPropagation()}
      >
        <div className={`${CSS.modalHeader} flex items-start justify-between`}>
          <div className="flex items-center gap-3">
            <div className="p-3 rounded-xl bg-blue-500/20">
              <Eye className="w-6 h-6 text-blue-400" />
            </div>
            <div>
              <h3 className="text-lg font-semibold theme-text-primary">Preview: {title}</h3>
              <p className="text-xs theme-text-muted">{text?.length?.toLocaleString() || 0} caracteres</p>
            </div>
          </div>
          <button onClick={onClose} className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors" title="Fechar">
            <X className="w-5 h-5 theme-text-tertiary" />
          </button>
        </div>
        <div className="p-4 max-h-[70vh] overflow-y-auto">
          <pre className="whitespace-pre-wrap text-sm theme-text-secondary font-mono bg-black/20 p-4 rounded-lg">
            {text || 'Sem conte√∫do'}
          </pre>
        </div>
      </div>
    </div>
  );
});
TextPreviewModal.displayName = 'TextPreviewModal';

const DispositivoModal = React.memo(({
  isOpen,
  onClose,
  dispositivoText,
  setDispositivoText,
  copySuccess,
  setCopySuccess,
  setError,
  extractedTopics,
  setExtractedTopics,
  selectedTopics,
  setSelectedTopics,
  sanitizeHTML = (html) => html || ''
}) => {
  const timeoutRef = React.useRef(null);
  React.useEffect(() => () => { if (timeoutRef.current) clearTimeout(timeoutRef.current); }, []);

  // ESC handler
  React.useEffect(() => {
    const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
    if (isOpen) window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  const handleAddToTopics = React.useCallback(() => {
    const dispositivoTopic = {
      title: 'DISPOSITIVO',
      category: 'DISPOSITIVO',
      relatorio: 'Dispositivo final da senten√ßa com todos os pedidos julgados.',
      editedContent: dispositivoText.replace(/\n/g, '<br>'),
      order: extractedTopics.length
    };

    // Verificar se j√° existe em extractedTopics
    const existsInExtracted = extractedTopics.some(t =>
      t.title.toUpperCase() === 'DISPOSITIVO'
    );

    if (existsInExtracted) {
      // Substituir em extractedTopics
      setExtractedTopics(extractedTopics.map(t =>
        t.title.toUpperCase() === 'DISPOSITIVO' ? dispositivoTopic : t
      ));
    } else {
      // Adicionar em extractedTopics
      setExtractedTopics([...extractedTopics, dispositivoTopic]);
    }

    // Verificar se j√° existe em selectedTopics
    const existsInSelected = selectedTopics.some(t =>
      t.title.toUpperCase() === 'DISPOSITIVO'
    );

    if (existsInSelected) {
      // Substituir em selectedTopics
      setSelectedTopics(selectedTopics.map(t =>
        t.title.toUpperCase() === 'DISPOSITIVO' ? dispositivoTopic : t
      ));
    } else {
      // Adicionar em selectedTopics
      setSelectedTopics([...selectedTopics, dispositivoTopic]);
    }

    onClose();
  }, [dispositivoText, extractedTopics, selectedTopics]); // üöÄ v1.8.3: Memoizado (GRUPO B)

  if (!isOpen) return null;

  // Copiar como texto puro (mant√©m compatibilidade)
  const handleCopyDispositivo = async () => {
    try {
      await navigator.clipboard.writeText(dispositivoText);
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
      setCopySuccess(true);
      timeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
    } catch (err) {
      setError('Erro ao copiar dispositivo');
    }
  };

  const handleCopyFormattedDispositivo = async () => {
    try {
      const tempDiv = document.createElement('div');
      tempDiv.style.position = 'absolute';
      tempDiv.style.left = '-9999px';
      tempDiv.innerHTML = dispositivoText;
      document.body.appendChild(tempDiv);
      const range = document.createRange();
      range.selectNodeContents(tempDiv);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      let success = false;
      try { success = document.execCommand('copy'); } catch (e) { /* execCommand deprecated */ }
      selection.removeAllRanges();
      document.body.removeChild(tempDiv);
      if (success) {
        if (timeoutRef.current) clearTimeout(timeoutRef.current);
        setCopySuccess(true);
        timeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
      } else {
        await navigator.clipboard.writeText(dispositivoText);
        if (timeoutRef.current) clearTimeout(timeoutRef.current);
        setCopySuccess(true);
        timeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
      }
    } catch (err) {
      setError('Erro ao copiar dispositivo formatado');
    }
  };

  return (
    <div className={`${CSS.modalOverlay} overflow-auto`}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-6xl w-full max-h-[95vh] flex flex-col my-auto`}>
        {/* Header - fixo */}
        <div className={`${CSS.modalHeader} flex-shrink-0`}>
          <div className="flex items-center justify-between w-full">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-purple-500/20">
                <Sparkles className="w-6 h-6 text-purple-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold theme-text-primary">Dispositivo Gerado com IA</h3>
                <p className="text-sm theme-text-muted">Revise e edite conforme necess√°rio antes de copiar</p>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>

        {/* Conte√∫do com scroll */}
        <div className="flex-1 overflow-y-auto">
          {/* Aviso cr√≠tico sobre revis√£o */}
          {/* v1.9.37: Cores corrigidas para tema claro */}
          <div className="m-6 p-4 bg-amber-500/15 border-2 border-amber-500/50 rounded-lg flex-shrink-0">
            <div className="flex items-start gap-3">
              <span className="text-amber-500 text-2xl flex-shrink-0">‚ö†Ô∏è</span>
              <div className="text-sm text-amber-700 dark:text-amber-100">
                <p className="font-bold text-amber-600 dark:text-amber-400 mb-2">ATEN√á√ÉO: REVIS√ÉO OBRIGAT√ìRIA</p>
                <p className="text-xs leading-relaxed">
                  Este dispositivo foi gerado por IA e pode conter erros, imprecis√µes ou omiss√µes.
                  <span className="font-semibold text-amber-700 dark:text-amber-200"> √â OBRIGAT√ìRIO que voc√™ revise minuciosamente:</span>
                </p>
                <ul className="text-xs mt-2 space-y-1 ml-4">
                  <li>‚úì Nomes corretos das partes</li>
                  <li>‚úì Pedidos e valores mencionados</li>
                  <li>‚úì Fundamenta√ß√£o legal adequada</li>
                  <li>‚úì Coer√™ncia com a fundamenta√ß√£o da senten√ßa</li>
                  <li>‚úì Ortografia e gram√°tica</li>
                </ul>
                <p className="text-xs mt-3 text-amber-600 dark:text-amber-300/80 font-semibold border-t border-amber-500/30 pt-2">
                  Sua revis√£o √© fundamental, na forma estabelecida pela Resolu√ß√£o 615/2025 do CNJ.
                </p>
              </div>
            </div>
          </div>

          {/* √Årea de preview HTML renderizado (read-only) */}
          <div className="px-6 pb-6">
            <style>{`
              .dispositivo-preview p {
                margin-bottom: 1rem;
              }
              .dispositivo-preview br {
                display: block;
                content: "";
                margin-top: 0.5rem;
              }
              .dispositivo-preview strong,
              .dispositivo-preview b {
                font-weight: 700;
                color: #fbbf24;
              }
              .dispositivo-preview em,
              .dispositivo-preview i {
                font-style: italic;
              }
              .dispositivo-preview u {
                text-decoration: underline;
              }
              .dispositivo-preview ul,
              .dispositivo-preview ol {
                margin-left: 1.5rem;
                margin-bottom: 1rem;
              }
              .dispositivo-preview li {
                margin-bottom: 0.5rem;
              }
            `}</style>
            <div
              className="dispositivo-preview w-full h-96 theme-bg-app border theme-border-input rounded-lg p-6 theme-text-primary text-base overflow-y-auto"
              style={{
                lineHeight: '1.8',
                whiteSpace: 'pre-wrap',
                wordWrap: 'break-word'
              }}
              dangerouslySetInnerHTML={{
                __html: sanitizeHTML(dispositivoText) || '<p style="color: #94a3b8; font-style: italic;">O dispositivo ser√° gerado aqui...</p>'
              }}
            />
          </div>

          {/* Dicas - fixas, compactas */}
          <div className="px-6 pb-6 space-y-3">
            {/* v1.5.1: Dica sobre op√ß√µes de c√≥pia */}
            <div className="p-3 bg-purple-900/20 border border-purple-500/30 rounded-lg flex items-start gap-2">
              <span className="text-purple-400 text-lg">üìã</span>
              <div className="flex-1 text-xs theme-text-tertiary">
                <p className="font-medium theme-text-purple mb-1">Op√ß√µes de C√≥pia:</p>
                <p className="text-xs">
                  <strong className="theme-text-secondary">Copiar Formatado:</strong> Preserva negrito, par√°grafos e formata√ß√£o HTML (ideal para Word/Google Docs)
                  <br />
                  <strong className="theme-text-tertiary">Copiar Texto Puro:</strong> Remove toda formata√ß√£o (√∫til para editores de texto simples)
                </p>
              </div>
            </div>

            <div className="theme-info-box flex items-start gap-2">
              <span className="text-blue-400 text-lg">üí°</span>
              <div className="flex-1 text-xs theme-text-tertiary">
                <p className="font-medium theme-text-blue mb-1">Dicas r√°pidas:</p>
                <p className="text-xs">
                  Revise nomes das partes ‚Ä¢ Verifique pedidos ‚Ä¢ Confira valores ‚Ä¢ Adapte ao seu estilo ‚Ä¢ Edite diretamente
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Bot√µes - fixos */}
        <div className={`${CSS.modalFooter} flex-shrink-0`}>
          {/* v1.5.1: Bot√£o Copiar Texto Puro */}
          <button
            onClick={handleCopyDispositivo}
            className="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg font-medium theme-bg-tertiary hover-slate-500"
            title="Copiar como texto puro (sem formata√ß√£o)"
          >
            <Download className="w-5 h-5" />
            {copySuccess ? '‚úì Copiado!' : 'Copiar Texto Puro'}
          </button>

          {/* v1.5.1: Bot√£o Copiar Formatado (NOVO) */}
          <button
            onClick={handleCopyFormattedDispositivo}
            className="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg font-medium shadow-lg hover-gradient-purple-blue bg-gradient-to-r from-purple-600 to-blue-600 text-white transition-all duration-300"
            title="Copiar com formata√ß√£o (negrito, par√°grafos) para Word/Google Docs"
          >
            <Download className="w-5 h-5" />
            {copySuccess ? '‚úì Copiado!' : 'Copiar Formatado'}
          </button>

          <button
            onClick={handleAddToTopics}
            className="px-6 py-3 rounded-lg font-medium bg-green-600 text-white hover-green-700-from-600"
          >
            {selectedTopics.some(t => t.title.toUpperCase() === 'DISPOSITIVO')
              ? 'Substituir Dispositivo'
              : 'Adicionar aos T√≥picos'}
          </button>
          <button
            onClick={onClose}
            className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  );
});

DispositivoModal.displayName = 'DispositivoModal';

// Modal: Descartar Modelos em Lote (migrado para BaseModal)
const BulkDiscardConfirmModal = React.memo(({ isOpen, onClose, totalModels, onConfirm }) => (
  <BaseModal isOpen={isOpen} onClose={onClose} title="Descartar Modelos?" icon={<AlertCircle />} iconColor="red" size="sm"
    footer={<ModalFooter.Destructive onClose={onClose} onConfirm={onConfirm} confirmText="Sim, Descartar" />}>
    <div className="space-y-4">
      <p className="theme-text-tertiary">Descartar <strong className="theme-text-primary">{totalModels} modelo(s)</strong>?</p>
      <p className="text-sm theme-text-muted">Todos ser√£o perdidos e precisar√° processar novamente.</p>
    </div>
  </BaseModal>
));
BulkDiscardConfirmModal.displayName = 'BulkDiscardConfirmModal';

// Modal: Cancelar Processamento em Lote (migrado para BaseModal)
const ConfirmBulkCancelModal = React.memo(({ isOpen, onClose, filesInProgress, onConfirm }) => (
  <BaseModal isOpen={isOpen} onClose={onClose} title="Cancelar Processamento?" icon={<AlertCircle />} iconColor="yellow" size="sm"
    footer={<><button onClick={onClose} className={CSS.btnSecondary}>Continuar</button><button onClick={onConfirm} className="flex-1 px-4 py-3 rounded-lg font-medium bg-amber-600 text-white hover-amber-700-from-600">Sim, Cancelar</button></>}>
    <div className="space-y-4">
      <p className="theme-text-tertiary">Cancelar processamento de <strong className="theme-text-primary">{filesInProgress} arquivo(s)</strong>?</p>
      <ModalInfoBox>‚ÑπÔ∏è Os modelos j√° gerados ser√£o preservados.</ModalInfoBox>
    </div>
  </BaseModal>
));
ConfirmBulkCancelModal.displayName = 'ConfirmBulkCancelModal';

const LockedTabOverlay = React.memo(({ isPrimaryTab, activeTab, setActiveTab }) => {
  const [controlTaken, setControlTaken] = React.useState(false);

  const handleTakeControl = React.useCallback(() => {
    const LOCK_KEY = 'sentencify-primary-tab-lock';
    const TAKEOVER_KEY = 'sentencify-tab-takeover';

    // PHASE 1: Gerar futuro tabId (mesmo formato que o hook usa)
    const futureTabId = `tab-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    // PHASE 2: Salvar em sessionStorage (sobrevive ao reload)
    sessionStorage.setItem(TAKEOVER_KEY, futureTabId);

    // PHASE 3: Escrever lock com futureTabId
    // Isso previne que Tab 1 reclame o lock antes de Tab 2 recarregar
    localStorage.setItem(LOCK_KEY, JSON.stringify({
      tabId: futureTabId,
      timestamp: Date.now(),
      takeover: true
    }));

    setControlTaken(true);
  }, [setControlTaken]);

  const handleGoToModels = React.useCallback(() => {
    setActiveTab('models');
  }, [setActiveTab]);

  // v1.20.3: N√£o mostrar overlay se for aba prim√°ria OU se estiver em abas liberadas (read-only)
  // Modelos, Jurisprud√™ncia e Legisla√ß√£o s√£o acess√≠veis em modo secund√°rio
  const READONLY_ALLOWED_TABS = ['models', 'jurisprudencia', 'legislacao'];
  if (isPrimaryTab || READONLY_ALLOWED_TABS.includes(activeTab)) {
    return null;
  }

  return (
    <div
      role="dialog"
      aria-modal="true"
      aria-labelledby="locked-tab-title"
      style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0, 0, 0, 0.85)',
        backdropFilter: 'blur(8px)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 9999,
        padding: '20px'
      }}
    >
      <div
        style={{
          background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
          border: '2px solid #3b82f6',
          borderRadius: '16px',
          padding: '40px',
          maxWidth: '500px',
          width: '100%',
          boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.1)',
          textAlign: 'center'
        }}
      >
        {/* √çcone de Cadeado */}
        <div
          style={{
            width: '80px',
            height: '80px',
            margin: '0 auto 24px',
            borderRadius: '50%',
            background: 'linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            boxShadow: '0 8px 16px rgba(59, 130, 246, 0.3)'
          }}
        >
          <svg
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="white"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>

        {/* T√≠tulo */}
        <h2
          id="locked-tab-title"
          style={{
            fontSize: '24px',
            fontWeight: '700',
            color: '#f1f5f9',
            marginBottom: '16px',
            letterSpacing: '-0.025em'
          }}
        >
          Aba Bloqueada
        </h2>

        {/* Mensagem */}
        <p
          style={{
            fontSize: '15px',
            color: '#94a3b8',
            lineHeight: '1.6',
            marginBottom: '12px'
          }}
        >
          Outra aba est√° atualmente editando este projeto. Para evitar conflitos e perda de dados,
          apenas uma aba pode editar por vez.
          <br /><br />
          <span style={{ color: '#60a5fa' }}>
            A <strong>Biblioteca de Modelos</strong> continua funcionando normalmente em todas as abas.
          </span>
        </p>

        {/* v1.9.10: Instru√ß√£o para assumir controle */}
        <p
          style={{
            fontSize: controlTaken ? '16px' : '14px',
            color: '#fbbf24',
            lineHeight: '1.5',
            marginBottom: '24px',
            padding: '12px 16px',
            background: 'rgba(251, 191, 36, 0.1)',
            borderRadius: '8px',
            border: '1px solid rgba(251, 191, 36, 0.3)',
            fontWeight: controlTaken ? '700' : '400',
            animation: controlTaken ? 'pulse 2s ease-in-out infinite' : 'none',
            transition: 'all 0.3s ease'
          }}
        >
          {controlTaken ? (
            <>
              <strong>‚úì Controle assumido!</strong><br />
              Agora pressione <kbd style={{
                padding: '4px 8px',
                background: 'rgba(255, 255, 255, 0.2)',
                borderRadius: '4px',
                fontFamily: 'monospace',
                fontSize: '15px',
                fontWeight: '700',
                boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)'
              }}>F5</kbd> para recarregar a p√°gina
            </>
          ) : (
            <>
              <strong>Para assumir o controle:</strong><br />
              1. Clique em "Assumir Controle" para reivindicar o lock<br />
              2. Depois, pressione <kbd style={{
                padding: '2px 6px',
                background: 'rgba(255, 255, 255, 0.1)',
                borderRadius: '4px',
                fontFamily: 'monospace',
                fontSize: '13px'
              }}>F5</kbd> para recarregar
            </>
          )}
        </p>

        {/* Bot√£o de Assumir Controle */}
        <button
          onClick={handleTakeControl}
          disabled={controlTaken}
          style={{
            width: '100%',
            padding: '14px 24px',
            background: controlTaken
              ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
              : 'linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%)',
            color: 'white',
            fontSize: '15px',
            fontWeight: '600',
            border: 'none',
            borderRadius: '8px',
            cursor: controlTaken ? 'not-allowed' : 'pointer',
            boxShadow: controlTaken
              ? '0 4px 12px rgba(16, 185, 129, 0.3)'
              : '0 4px 12px rgba(59, 130, 246, 0.3)',
            transition: 'all 0.2s ease',
            letterSpacing: '0.025em',
            opacity: controlTaken ? 0.9 : 1
          }}
          onMouseEnter={(e) => {
            if (!controlTaken) {
              e.currentTarget.style.transform = 'translateY(-2px)';
              e.currentTarget.style.boxShadow = '0 8px 20px rgba(59, 130, 246, 0.4)';
            }
          }}
          onMouseLeave={(e) => {
            if (!controlTaken) {
              e.currentTarget.style.transform = 'translateY(0)';
              e.currentTarget.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
            }
          }}
        >
          {controlTaken ? '‚úì Controle Assumido' : 'üîí Assumir Controle'}
        </button>

        {/* v1.9.6: Bot√£o para acessar Modelos sem assumir controle */}
        <button
          onClick={handleGoToModels}
          disabled={controlTaken}
          style={{
            width: '100%',
            marginTop: '12px',
            padding: '12px 24px',
            background: 'transparent',
            color: controlTaken ? '#64748b' : '#60a5fa',
            fontSize: '14px',
            fontWeight: '500',
            border: `2px solid ${controlTaken ? '#475569' : '#3b82f6'}`,
            borderRadius: '8px',
            cursor: controlTaken ? 'not-allowed' : 'pointer',
            transition: 'all 0.2s ease',
            opacity: controlTaken ? 0.5 : 1
          }}
          onMouseEnter={(e) => {
            if (!controlTaken) {
              e.currentTarget.style.background = 'rgba(59, 130, 246, 0.1)';
              e.currentTarget.style.borderColor = '#60a5fa';
            }
          }}
          onMouseLeave={(e) => {
            if (!controlTaken) {
              e.currentTarget.style.background = 'transparent';
              e.currentTarget.style.borderColor = '#3b82f6';
            }
          }}
        >
          üìö Ir para Biblioteca de Modelos
        </button>

        {/* Nota de Rodap√© */}
        <p
          style={{
            fontSize: '13px',
            color: '#64748b',
            marginTop: '20px',
            fontStyle: 'italic'
          }}
        >
          Ao assumir o controle, a outra aba ser√° bloqueada automaticamente.
        </p>
      </div>
    </div>
  );
});

LockedTabOverlay.displayName = 'LockedTabOverlay';

// üîç Modal de Aviso de Similaridade (v1.13.3 - Compara√ß√£o lado a lado)
// v1.33.3: Feedback visual "Salvando..." durante gera√ß√£o de embedding
const SimilarityWarningModal = React.memo(({ warning, saving, onCancel, onSaveNew, onReplace, sanitizeHTML = (html) => html || '' }) => {
  // ESC handler
  React.useEffect(() => {
    const handleEsc = (e) => { if (e.key === 'Escape' && !saving) onCancel(); };
    if (warning) window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [warning, saving, onCancel]);

  if (!warning) return null;
  const { newModel, similarModel, similarity } = warning;
  const pct = Math.round(similarity * 100);
  return (
    <div className={CSS.modalOverlay} style={{zIndex:60}}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-5xl w-full`}>
        <div className={CSS.modalHeader}>
          <div className="flex items-center justify-between w-full">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-amber-500/20">
                <AlertTriangle className="w-6 h-6 text-amber-400" />
              </div>
              <h3 className="text-lg font-semibold theme-text-primary">Modelo Similar Encontrado ({pct}%)</h3>
            </div>
            <button
              onClick={onCancel}
              disabled={saving}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors disabled:opacity-50"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>
        <div className="p-6">
          <div className="grid grid-cols-2 gap-4 mb-4">
            <div className="theme-card p-4 flex flex-col">
              <div className="flex-shrink-0 mb-2">
                <p className="text-xs theme-text-muted mb-1">NOVO MODELO</p>
                <p className="font-semibold theme-text-secondary text-sm" style={{wordBreak:'break-word'}}>{newModel.title}</p>
              </div>
              <div className="flex-1 overflow-y-auto text-sm theme-text-secondary border theme-border-input rounded p-3 theme-bg-tertiary" style={{maxHeight:'300px'}} dangerouslySetInnerHTML={{__html: sanitizeHTML(newModel.content || '')}} />
            </div>
            <div className="theme-card p-4 flex flex-col border-yellow-500/50">
              <div className="flex-shrink-0 mb-2">
                <p className="text-xs theme-text-muted mb-1">MODELO EXISTENTE</p>
                <p className="font-semibold theme-text-yellow text-sm" style={{wordBreak:'break-word'}}>{similarModel.title}</p>
              </div>
              <div className="flex-1 overflow-y-auto text-sm theme-text-secondary border theme-border-input rounded p-3 theme-bg-tertiary" style={{maxHeight:'300px'}} dangerouslySetInnerHTML={{__html: sanitizeHTML(similarModel.content || '')}} />
            </div>
          </div>
          <p className="text-sm theme-text-muted text-center">{saving ? 'Salvando modelo...' : 'O que deseja fazer?'}</p>
        </div>
        <div className="px-6 pb-6 flex gap-3 justify-center">
          <button onClick={onCancel} className={CSS.btnSecondary} disabled={saving}>Cancelar</button>
          <button onClick={onSaveNew} className={CSS.btnSuccess} disabled={saving}>{saving ? 'Salvando...' : 'Salvar Mesmo Assim'}</button>
          <button onClick={onReplace} className="px-4 py-2 rounded-lg font-medium bg-amber-600 text-white hover-amber-700-from-600 disabled:opacity-50" disabled={saving}>{saving ? 'Salvando...' : 'Substituir Existente'}</button>
        </div>
      </div>
    </div>
  );
});
SimilarityWarningModal.displayName = 'SimilarityWarningModal';

const BulkReviewModal = React.memo(({
  isOpen,
  onClose,
  bulkReviewModels,
  bulkFiles,
  bulkGeneratedModels,
  bulkErrors,
  onRemoveModel,
  onDiscard,
  onSave,
  sanitizeHTML = (html) => html || ''
}) => {
  if (!isOpen) return null;

  return (
    <div className={CSS.modalOverlay}>
      <div className={`${CSS.modalContainer} max-w-6xl w-full flex flex-col`} style={{ maxHeight: '90vh', height: 'auto' }}>
        <div className={`${CSS.modalHeader} flex-shrink-0`}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <span className="text-3xl">‚úÖ</span>
              <div>
                <h3 className="text-2xl font-bold text-green-400">Revis√£o de Modelos Gerados</h3>
                <p className="text-sm theme-text-muted mt-1">
                  {bulkReviewModels.length} modelo{bulkReviewModels.length !== 1 ? 's' : ''} gerado{bulkReviewModels.length !== 1 ? 's' : ''} de {bulkFiles.length} arquivo{bulkFiles.length !== 1 ? 's' : ''}
                </p>
              </div>
            </div>
          </div>
        </div>

        <div className="overflow-y-auto flex-1 p-6">
          {/* Resumo */}
          <div className="theme-info-box p-4 mb-6">
            <div className="flex items-start gap-3">
              <span className="text-2xl">üìà</span>
              <div className="flex-1">
                <p className="font-semibold theme-text-secondary mb-2">Resumo do Processamento:</p>
                <div className="grid grid-cols-3 gap-4 text-sm">
                  <div>
                    <p className="theme-text-muted">Total de arquivos:</p>
                    <p className="text-lg font-bold theme-text-blue">{bulkFiles.length}</p>
                  </div>
                  <div>
                    <p className="theme-text-muted">Modelos na revis√£o:</p>
                    <p className="text-lg font-bold theme-text-green">{bulkReviewModels.length}</p>
                  </div>
                  <div>
                    <p className="theme-text-muted">Erros:</p>
                    <p className="text-lg font-bold theme-text-red">{bulkErrors.length}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Erros (se houver) */}
          {bulkErrors.length > 0 && (
            <div className="bg-red-900/20 border border-red-500/30 rounded-lg p-4 mb-6">
              <p className="font-semibold theme-text-red mb-2">‚ö†Ô∏è Arquivos com erro:</p>
              <div className="space-y-1 text-sm">
                {bulkErrors.map((err, idx) => (
                  <div key={idx} className="theme-text-secondary">
                    ‚Ä¢ <span className="font-medium">{err.file}</span>: {err.error}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Lista de Modelos */}
          <div className="space-y-4">
            {bulkReviewModels.map((model, idx) => (
              <div
                key={model.id}
                style={{ borderColor: '#475569', transition: 'border-color 0.3s ease' }}
                className="theme-bg-secondary-30 rounded-lg border p-4 hover-border-purple-alpha-50"
              >
                <div className="flex items-start justify-between mb-3">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="theme-text-muted text-sm">#{idx + 1}</span>
                      <h4 className="font-semibold theme-text-primary">{model.title}</h4>
                    </div>
                    <div className="flex items-center gap-2 flex-wrap">
                      <span className="text-xs px-2 py-0.5 rounded theme-bg-purple-accent theme-text-purple border border-purple-500/30">
                        {model.category}
                      </span>
                      <span className="text-xs px-2 py-0.5 rounded theme-bg-blue-accent theme-text-blue border border-blue-500/30">
                        üìÅ {model.sourceFile}
                      </span>
                      {model.keywords && (
                        <span className={CSS.textMuted}>
                          üè∑Ô∏è {model.keywords.split(',').slice(0, 3).join(', ')}
                        </span>
                      )}
                      {model.similarityInfo && (
                        <span className={`text-xs px-2 py-1 rounded font-medium ${
                          model.similarityInfo.similarity > 0.90
                            ? 'bg-red-500/20 text-red-300 border border-red-500/30'
                            : 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30'
                        }`}>
                          ‚ö†Ô∏è {Math.round(model.similarityInfo.similarity * 100)}% similar a "{model.similarityInfo.similarModel.title}"
                        </span>
                      )}
                    </div>
                  </div>
                  <button
                    onClick={() => onRemoveModel(model.id)}
                    className="hover-delete-topic p-2 rounded"
                    title="Remover este modelo"
                  >
                    <Trash2 className="w-5 h-5" />
                  </button>
                </div>

                {/* Preview do conte√∫do */}
                <div className="theme-bg-primary-50 rounded p-3 text-sm theme-text-tertiary">
                  <div
                    dangerouslySetInnerHTML={{ __html: sanitizeHTML(model.content).substring(0, 300) + '...' }}
                    className="line-clamp-3"
                  />
                </div>
              </div>
            ))}
          </div>

          {bulkReviewModels.length === 0 && (
            <div className="text-center py-12 theme-text-muted">
              <p className="text-lg mb-2">Nenhum modelo para revisar</p>
              <p className="text-sm">Todos os modelos foram removidos ou nenhum foi gerado.</p>
            </div>
          )}
        </div>

        <div className={`${CSS.modalFooter} flex-shrink-0`}>
          <button
            onClick={onDiscard}
            className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500"
          >
            Descartar Tudo
          </button>
          <button
            onClick={onSave}
            disabled={bulkReviewModels.length === 0}
            className="flex-1 px-6 py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white hover-gradient-green transition-all duration-300"
          >
            <Save className="w-5 h-5" />
            Salvar {bulkReviewModels.length} Modelo{bulkReviewModels.length !== 1 ? 's' : ''}
          </button>
        </div>
      </div>
    </div>
  );
});

BulkReviewModal.displayName = 'BulkReviewModal';

const BulkUploadModal = React.memo(({
  isOpen,
  onClose,
  isProcessing,
  isReviewOpen,
  bulkFiles,
  bulkFileInputRef,
  onFileUpload,
  onRemoveFile,
  onProcess,
  currentFileIndex,
  processedFiles,
  bulkStaggerDelay,
  setBulkStaggerDelay,
  bulkCancelController,
  generatedModels,
  bulkCurrentBatch,
  bulkBatchSize = 3,
  openModal
}) => {
  if (!isOpen) return null;

  // View 1: Upload/Selection (quando N√ÉO est√° processando E N√ÉO est√° na revis√£o)
  if (!isProcessing && !isReviewOpen) {
    return (
      <div className="fixed inset-0 z-[90] p-4 theme-modal-overlay backdrop-blur-sm flex items-start justify-center pt-8 overflow-y-auto">
        <div className="theme-modal-container theme-border-modal theme-modal-glow animate-modal max-w-3xl w-full mb-8">
          <div className={CSS.modalHeader}>
            <div className="flex items-center justify-between w-full">
              <div className="flex items-center gap-3">
                <div className="p-3 rounded-xl bg-purple-500/20">
                  <Sparkles className="w-6 h-6 text-purple-400" />
                </div>
                <div>
                  <h3 className="text-lg font-semibold theme-text-primary">Criar Modelos de Arquivos com IA</h3>
                  <p className="text-sm theme-text-muted">
                    Envie at√© 20 arquivos e deixe a IA criar modelos completos automaticamente
                  </p>
                </div>
              </div>
              <button
                onClick={onClose}
                className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
                title="Fechar"
              >
                <X className="w-5 h-5 theme-text-tertiary" />
              </button>
            </div>
          </div>

          <div className="p-6 space-y-6">
            {/* √Årea de Upload */}
            <div>
              <label className="block text-sm font-medium theme-text-tertiary mb-3">
                üì§ Selecione os arquivos (PDF, DOCX, DOC ou TXT)
              </label>
              <div
                onClick={() => bulkFileInputRef.current?.click()}
                className="hover-bulk-upload-area border-2 border-dashed rounded-lg p-8 text-center cursor-pointer"
              >
                <Upload className="w-12 h-12 theme-text-disabled mx-auto mb-3" />
                <p className="theme-text-tertiary font-medium mb-1">
                  Clique para selecionar arquivos
                </p>
                <p className="text-sm theme-text-disabled">
                  PDF, DOCX, DOC, TXT - M√°ximo: 20 arquivos
                </p>
                <p className="text-xs theme-text-disabled mt-2">
                  ‚ö° Extra√ß√£o de texto 100% local e r√°pida
                </p>
              </div>
              <input
                ref={bulkFileInputRef}
                type="file"
                multiple
                accept=".pdf,.docx,.doc,.txt"
                onChange={onFileUpload}
                className="hidden"
              />
            </div>

            {/* Lista de Arquivos Selecionados */}
            {bulkFiles.length > 0 && (
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  üìã Arquivos Selecionados ({bulkFiles.length}/20)
                </label>
                <div className="theme-bg-secondary-30 rounded-lg border theme-border-input max-h-64 overflow-y-auto">
                  {bulkFiles.map((file, idx) => (
                    <div
                      key={idx}
                      className="flex items-center justify-between p-3 border-b theme-border-input/50 last:border-b-0 hover-slate-alpha-30-from-transparent"
                    >
                      <div className="flex items-center gap-3 flex-1 min-w-0">
                        <FileText className="w-5 h-5 text-blue-400 flex-shrink-0" />
                        <span className="text-sm theme-text-secondary truncate">{file.name}</span>
                        <span className="text-xs theme-text-disabled">
                          ({(file.size / 1024).toFixed(1)} KB)
                        </span>
                      </div>
                      <button
                        onClick={() => onRemoveFile(idx)}
                        className="hover-delete-topic p-1 rounded"
                        title="Remover"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Informa√ß√µes */}
            <div className="theme-info-box p-4">
              <div className="flex items-start gap-3">
                <span className="text-blue-400 text-2xl">üí°</span>
                <div className="text-sm theme-text-secondary">
                  <p className="font-semibold mb-2">Como funciona:</p>
                  <ul className="space-y-1 list-disc list-inside">
                    <li>Cada arquivo pode gerar 1 ou mais modelos</li>
                    <li>A IA identifica automaticamente os t√≥picos jur√≠dicos</li>
                    <li>Voc√™ poder√° revisar e editar antes de salvar</li>
                    <li>Se houver erros, o processo continua com os pr√≥ximos</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          {/* v1.5.15: Configura√ß√£o de delay entre arquivos (staggered start) */}
          <div className="px-6 pb-4">
            <div className="theme-bg-secondary-50 rounded-lg border theme-border-input p-4">
              <label className={CSS.label}>
                ‚öôÔ∏è Delay entre iniciar arquivos (Rate Limiting)
              </label>
              <select
                value={bulkStaggerDelay}
                onChange={(e) => setBulkStaggerDelay(Number(e.target.value))}
                className="w-full px-3 py-2 theme-bg-primary border theme-border-input rounded theme-text-secondary text-sm"
              >
                <option value={0}>Sem delay - M√°xima velocidade ({bulkBatchSize} por lote)</option>
                <option value={300}>300ms - Balanceado (delay dentro do lote)</option>
                <option value={500}>500ms - Conservador (delay dentro do lote)</option>
                <option value={1000}>1s - Muito conservador (delay dentro do lote)</option>
              </select>
              <p className="text-xs theme-text-muted mt-2">
                üí° Sistema de lotes ativo ({bulkBatchSize} arquivos/lote + 1s entre lotes). Delay adicional entre iniciar os {bulkBatchSize} arquivos do lote.
              </p>
            </div>
          </div>

          <div className={CSS.modalFooter}>
            <button
              onClick={onClose}
              className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500"
            >
              Cancelar
            </button>
            <button
              onClick={onProcess}
              disabled={bulkFiles.length === 0}
              className="flex-1 px-6 py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 hover-gradient-blue-purple transition-all duration-300 text-white"
            >
              <Zap className="w-5 h-5" />
              Processar {bulkFiles.length} Arquivo{bulkFiles.length !== 1 ? 's' : ''}
            </button>
          </div>
        </div>
      </div>
    );
  }

  // View 2: Processing (quando est√° processando)
  if (isProcessing) {
    return (
      <div className={CSS.modalOverlay}>
        <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-2xl w-full flex flex-col`} style={{ maxHeight: '90vh' }}>
          <div className={CSS.modalHeader}>
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-purple-500/20">
                <Loader2 className="w-6 h-6 text-purple-400 animate-spin" />
              </div>
              <div>
                <h3 className="text-lg font-semibold theme-text-primary">Processando Arquivos...</h3>
                <p className="text-sm theme-text-muted">
                  Aguarde enquanto a IA analisa os documentos
                </p>
              </div>
            </div>
          </div>

          {/* v1.5.15: Grid de cards por arquivo (processamento paralelo) */}
          <div className="p-6 space-y-4 flex-1 overflow-y-auto">
            {/* Grid de status por arquivo */}
            <div className="space-y-3">
              {bulkFiles.map((file, index) => {
                const result = processedFiles.find(f => f.file === file.name);
                const isComplete = result?.status === 'success';
                const isError = result?.status === 'error';

                const fileBatch = Math.floor(index / bulkBatchSize) + 1;
                const isInCurrentBatch = fileBatch === bulkCurrentBatch;
                const isWaiting = fileBatch > bulkCurrentBatch && !result;
                const isProcessing = isInCurrentBatch && !result;

                return (
                  <div
                    key={index}
                    className={`p-4 rounded-lg border-2 flex items-center gap-3 transition-all ${
                      isComplete ? 'bg-green-900/20 border-green-500/30' :
                      isError ? 'bg-red-900/20 border-red-500/30' :
                      isProcessing ? 'bg-blue-900/30 border-blue-500/40' :
                      isWaiting ? 'theme-bg-secondary-30 theme-border-input/40' :
                      'theme-bg-secondary-50 theme-border-input'
                    }`}
                  >
                    {/* √çcone de status */}
                    <div className="flex-shrink-0">
                      {isComplete && <Check className="w-6 h-6 text-green-400" />}
                      {isError && <X className="w-6 h-6 text-red-400" />}
                      {isProcessing && (
                        <div className="w-6 h-6 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                      )}
                      {isWaiting && <Clock className="w-6 h-6 theme-text-disabled" />}
                    </div>

                    {/* Info do arquivo */}
                    <div className="flex-grow min-w-0">
                      <p className="text-sm theme-text-secondary truncate font-medium">{file.name}</p>
                      <p className="text-xs theme-text-muted mt-1">
                        {isComplete && `‚úÖ ${result.modelsCount} modelo${result.modelsCount !== 1 ? 's' : ''} gerado${result.modelsCount !== 1 ? 's' : ''} em ${result.duration}s`}
                        {isError && `‚ùå Erro: ${result.error}`}
                        {isProcessing && `üîÑ Processando agora... (Batch ${bulkCurrentBatch}/${Math.ceil(bulkFiles.length / bulkBatchSize)})`}
                        {isWaiting && `‚è≥ Aguardando na fila (Batch ${fileBatch}/${Math.ceil(bulkFiles.length / bulkBatchSize)})`}
                      </p>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Resumo geral */}
            <div className="theme-bg-secondary-30 border theme-border-input rounded-lg p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium theme-text-tertiary">
                    üìä Progresso: {processedFiles.length} de {bulkFiles.length} arquivos
                  </p>
                  {generatedModels.length > 0 && (
                    <p className="text-xs theme-text-muted mt-1">
                      ‚ú® {generatedModels.length} modelo{generatedModels.length !== 1 ? 's' : ''} gerado{generatedModels.length !== 1 ? 's' : ''} no total
                    </p>
                  )}
                </div>
                <div className="text-right">
                  <p className="text-2xl font-bold text-purple-400">
                    {Math.round((processedFiles.length / bulkFiles.length) * 100)}%
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* v1.5.15: Bot√£o Cancelar processamento */}
          <div className="p-6 border-t theme-border-secondary">
            <button
              onClick={() => openModal('confirmBulkCancel')}
              className="w-full px-4 py-3 text-white rounded-lg flex items-center justify-center gap-2 font-medium bg-red-500 hover-red-600"
            >
              <X className="w-5 h-5" />
              Cancelar Processamento
            </button>
            <p className="text-center text-xs theme-text-disabled mt-3">
              üí° Processamento em lotes: {bulkBatchSize} arquivos por vez (evita rate limits)
            </p>
          </div>
        </div>
      </div>
    );
  }

  return null;
});

BulkUploadModal.displayName = 'BulkUploadModal';

// üìã FASE 3.1: ModelFormFields - Campos do formul√°rio de modelos
const ModelFormFields = React.memo(({
  formData,
  onChange,
  categories,
  onGenerateKeywords,
  generatingKeywords,
  onGenerateTitle,
  generatingTitle
}) => {

  const handleFieldChange = React.useCallback((field, value) => {
    onChange(field, value);
  }, [onChange]); // üöÄ v1.8.3: Memoizado (GRUPO C)

  return (
    <div className="space-y-4">
      {/* Campo T√≠tulo com bot√£o de gera√ß√£o IA */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium theme-text-tertiary">T√≠tulo</label>
          <button
            onClick={onGenerateTitle}
            disabled={generatingTitle || !formData.content}
            className="flex items-center gap-1 px-3 py-1 text-xs text-white bg-purple-600 disabled:theme-bg-tertiary disabled:cursor-not-allowed rounded hover-purple-700-from-600 transition-colors"
            title="Gerar t√≠tulo com IA baseado no conte√∫do"
          >
            {generatingTitle ? (
              <>
                <svg className="animate-spin w-3 h-3" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Gerando...
              </>
            ) : (
              <>
                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Gerar com IA
              </>
            )}
          </button>
        </div>
        <input
          type="text"
          value={formData.title}
          onChange={(e) => handleFieldChange('title', e.target.value)}
          className="w-full theme-bg-primary border theme-border-input rounded-lg p-3 theme-text-primary focus:border-blue-500 focus:outline-none transition-colors"
          placeholder="Ex: HORAS EXTRAS - SOBREJORNADA - PROCEDENTE"
        />
      </div>

      {/* Campo Categoria com autocomplete */}
      <div>
        <label className={CSS.label}>Categoria</label>
        <input
          type="text"
          value={formData.category}
          onChange={(e) => handleFieldChange('category', e.target.value)}
          className="w-full theme-bg-primary border theme-border-input rounded-lg p-3 theme-text-primary focus:border-blue-500 focus:outline-none transition-colors"
          placeholder="Ex: Verbas Rescis√≥rias, Jornada de Trabalho, Preliminares"
          list="categories-list"
        />
        <datalist id="categories-list">
          {categories.map((cat, idx) => (
            <option key={idx} value={cat} />
          ))}
        </datalist>
      </div>

      {/* Campo Keywords com bot√£o de gera√ß√£o IA */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium theme-text-tertiary">Palavras-chave</label>
          <button
            onClick={onGenerateKeywords}
            disabled={generatingKeywords || (!formData.title && !formData.content)}
            className="flex items-center gap-1 px-3 py-1 text-xs text-white bg-purple-600 disabled:theme-bg-tertiary disabled:cursor-not-allowed rounded hover-purple-700-from-600 transition-colors"
            title="Gerar palavras-chave com IA"
          >
            {generatingKeywords ? (
              <>
                <svg className="animate-spin w-3 h-3" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Gerando...
              </>
            ) : (
              <>
                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Gerar com IA
              </>
            )}
          </button>
        </div>
        <input
          type="text"
          value={formData.keywords}
          onChange={(e) => handleFieldChange('keywords', e.target.value)}
          className="w-full theme-bg-primary border theme-border-input rounded-lg p-3 theme-text-primary focus:border-blue-500 focus:outline-none transition-colors"
          placeholder="horas extras, sobrejornada, adicional"
        />
      </div>
    </div>
  );
});

ModelFormFields.displayName = 'ModelFormFields';

// ModelRichEditor removido em v1.9.11 - use QuillModelEditor

// ModelFormModal - Container para edi√ß√£o de modelos
// v1.35.10: Estado local bufferizado para evitar re-render do LegalDecisionEditor a cada keystroke
const ModelFormModal = React.forwardRef(({
  isOpen,
  editingModel,
  newModel,
  setNewModel,
  models,
  onSave,
  onCancel,
  onGenerateKeywords,
  generatingKeywords,
  onGenerateTitle,
  generatingTitle,
  onSaveWithoutClosing,
  onOpenAIAssistant,
  sanitizeHTML,
  modelEditorRef,
  quillReady = false,
  quillError = null,
  editorTheme,
  toggleEditorTheme,
  modelSaved = false,
  savingModel = false
}, containerRef) => {

  // v1.35.10: Estado LOCAL para campos do formul√°rio
  // Digita√ß√£o atualiza apenas este componente (leve), n√£o o LegalDecisionEditor (pesado)
  const [localModel, setLocalModel] = React.useState({ title: '', content: '', keywords: '', category: '' });

  // v1.35.10: Sincronizar estado local quando modal abre ou editingModel muda
  React.useEffect(() => {
    if (isOpen) {
      setLocalModel({
        title: newModel.title || '',
        content: newModel.content || '',
        keywords: newModel.keywords || '',
        category: newModel.category || ''
      });
    }
  }, [isOpen, editingModel]); // Sincroniza quando abre ou troca de modelo

  // v1.35.3: Memoizar categorias para evitar rec√°lculo a cada keystroke
  const categories = React.useMemo(() => {
    return [...new Set(models.map(m => m.category).filter(c => c && c.trim() !== ''))].sort();
  }, [models]);

  // v1.35.10: Handler para mudan√ßas nos campos - atualiza estado LOCAL
  const handleFieldChange = React.useCallback((field, value) => {
    setLocalModel(prev => ({ ...prev, [field]: value }));
  }, []);

  // v1.35.10: Handler para mudan√ßas no editor rico - atualiza estado LOCAL
  const handleContentChange = React.useCallback((html) => {
    setLocalModel(prev => ({ ...prev, content: html }));
  }, []);

  // v1.35.10: Sincronizar com pai ANTES de salvar
  const handleSave = React.useCallback(() => {
    // Sincroniza estado local com o pai antes de salvar
    setNewModel(localModel);
    // Pequeno delay para garantir que o estado foi propagado
    setTimeout(() => onSave(), 0);
  }, [localModel, setNewModel, onSave]);

  // v1.35.10: Sincronizar com pai ANTES de salvar sem fechar
  const handleSaveWithoutClosing = React.useCallback(() => {
    setNewModel(localModel);
    setTimeout(() => onSaveWithoutClosing(), 0);
  }, [localModel, setNewModel, onSaveWithoutClosing]);

  // v1.35.5: Return condicional AP√ìS todos os hooks
  if (!isOpen) return null;

  return (
    <div ref={containerRef} className="theme-bg-secondary-30 p-6 rounded-lg border theme-border-input space-y-4">
      {/* Header din√¢mico */}
      <h4 className="text-lg font-bold theme-text-primary">
        {editingModel ? 'Editar Modelo' : 'Novo Modelo'}
      </h4>

      {/* Campos simples (t√≠tulo, categoria, keywords) - usam estado LOCAL */}
      <ModelFormFields
        formData={localModel}
        onChange={handleFieldChange}
        categories={categories}
        onGenerateKeywords={onGenerateKeywords}
        generatingKeywords={generatingKeywords}
        onGenerateTitle={onGenerateTitle}
        generatingTitle={generatingTitle}
      />

      {/* Editor rico de conte√∫do - usa estado LOCAL */}
      <QuillModelEditor
        ref={modelEditorRef}
        content={localModel.content || ''}
        onChange={handleContentChange}
        onSaveWithoutClosing={handleSaveWithoutClosing}
        onOpenAIAssistant={onOpenAIAssistant}
        quillReady={quillReady}
        quillError={quillError}
        editorTheme={editorTheme}
        toggleEditorTheme={toggleEditorTheme}
      />

      {/* Bot√µes de a√ß√£o */}
      <div className="flex gap-3 pt-4">
        <button
          onClick={onCancel}
          className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500"
        >
          Cancelar
        </button>
        <button
          onClick={handleSave}
          disabled={modelSaved || savingModel}
          style={{
            backgroundImage: (modelSaved || savingModel) ? 'none' : 'linear-gradient(to right, #2563eb, #9333ea)',
            backgroundColor: modelSaved ? '#16a34a' : (savingModel ? '#6b7280' : 'transparent'),
            transition: 'all 0.3s ease'
          }}
          className={`flex-1 px-6 py-3 rounded-lg font-medium text-white ${(modelSaved || savingModel) ? '' : 'hover-gradient-blue-purple'}`}
        >
          {modelSaved ? '‚úì Altera√ß√µes Salvas' : (savingModel ? 'Salvando...' : (editingModel ? 'Salvar Altera√ß√µes' : 'Salvar Modelo'))}
        </button>
      </div>
    </div>
  );
});

ModelFormModal.displayName = 'ModelFormModal';

// üëÅÔ∏è COMPONENTE: ModelPreviewModal - Preview de modelo
const ModelPreviewModal = React.memo(({
  isOpen,
  model,
  onInsert,
  onClose,
  sanitizeHTML,
  showToast,
  // Props para modo de edi√ß√£o (Quick Edit)
  isEditing = false,
  editedContent = '',
  onStartEditing,
  onCancelEditing,
  onSaveEdit,
  onContentChange,
  quillReady = false,
  quillError = null,
  // Props para configura√ß√µes globais de editor
  fontSize = 'normal',
  spacing = 'normal',
  editorTheme = 'dark',
  // Prop para exclus√£o de modelo
  onDelete,
  // Prop para favoritar modelo
  onToggleFavorite,
  // v1.15.3: Prop para "Salvar como Novo Modelo"
  onOpenSaveAsNew,
}) => {
  // Hooks DEVEM vir antes de qualquer early return
  // Ref para o editor Quill em modo edi√ß√£o
  const quickEditRef = React.useRef(null);

  // Conte√∫do Sanitizado (Memoizado para Performance)
  const sanitizedContent = React.useMemo(
    () => model ? sanitizeHTML(model.content || '<p class="theme-text-muted">Conte√∫do n√£o dispon√≠vel</p>') : '',
    [model?.content, sanitizeHTML]
  );

  // Handler de Inser√ß√£o (Insere + Fecha)
  const handleInsert = React.useCallback(() => {
    if (model) {
      onInsert(model.content);
      onClose();
    }
  }, [model?.content, onInsert, onClose]);

  // Handler de Copiar (Copia para Clipboard)
  const handleCopy = React.useCallback(() => {
    if (!model) return;
    // v1.25.18: Usar helper ao inv√©s de DOM (memory leak fix)
    const plainText = extractPlainText(model.content);

    navigator.clipboard.writeText(plainText)
      .then(() => {
        showToast?.('‚úÖ Modelo copiado para √°rea de transfer√™ncia', 'success');
      })
      .catch(err => {
        showToast?.('‚ùå Erro ao copiar modelo', 'error');
      });
  }, [model?.content, showToast]);

  // v1.35.61: Handler para Voice-to-Text no modo Quick Edit
  const handleVoiceTranscript = React.useCallback((text) => {
    const quill = quickEditRef.current;
    if (quill) {
      requestAnimationFrame(() => {
        const range = quill.getSelection() || { index: quill.getLength() - 1 };
        quill.insertText(range.index, text + ' ');
        quill.setSelection(range.index + text.length + 1);
      });
    }
  }, []);

  // v1.35.67: ESC handler
  React.useEffect(() => {
    if (!isOpen) return;
    const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
    window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  // v1.35.67: Scroll lock
  React.useEffect(() => {
    if (isOpen) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => { document.body.style.overflow = originalOverflow; };
    }
  }, [isOpen]);

  // Early Return se Modal Fechado
  if (!isOpen) {
    return null;
  }

  // Error State se Modelo Inv√°lido
  if (!model) {
    return (
      <div className={CSS.modalOverlay} onClick={onClose}>
        <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal p-6`} onClick={e => e.stopPropagation()}>
          <p className="text-red-400 mb-4 flex items-center gap-2">
            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
            </svg>
            Erro: Modelo n√£o encontrado
          </p>
          <button
            onClick={onClose}
            className="w-full px-4 py-3 rounded-lg font-medium text-white theme-bg-tertiary hover-slate-500"
          >
            Fechar
          </button>
        </div>
      </div>
    );
  }

  return (
    <div
      className={CSS.modalOverlay}
      role="dialog"
      aria-modal="true"
      aria-labelledby="preview-modal-title"
      onClick={onClose}
    >

      {/* ‚îÄ‚îÄ‚îÄ Modal Container ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  */}
      <div
        className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal flex flex-col`}
        style={{
          width: '90%',
          maxWidth: '1000px',
          height: '85vh',
          maxHeight: '85vh',
          contain: 'content'
        }}
        onClick={e => e.stopPropagation()}
      >

        {/* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  */}
        <div className="p-4 sm:p-6 border-b theme-border-input flex-shrink-0">
          <div className="flex items-start justify-between">
            <div className="flex-1 pr-4">
              <div className="flex items-center gap-2 mb-2">
                <h3 id="preview-modal-title" className="text-xl font-bold theme-text-primary">
                  {model.title}
                </h3>
                {onToggleFavorite && (
                  <button
                    onClick={() => onToggleFavorite(model.id)}
                    className="text-xl hover:scale-110 transition-transform"
                    title={model.favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}
                  >
                    {model.favorite ? '‚≠ê' : '‚òÜ'}
                  </button>
                )}
              </div>

              {/* Metadata: Categoria + Keywords */}
              <div className="flex items-center gap-3 flex-wrap">
                {model.category && (
                  <span className="px-2 py-1 theme-bg-purple-accent theme-text-purple rounded text-sm border border-purple-500/30">
                    {model.category}
                  </span>
                )}
                {model.keywords && (
                  <span className="theme-text-muted text-sm flex items-center gap-1">
                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clipRule="evenodd" />
                    </svg>
                    {model.keywords}
                  </span>
                )}
              </div>
            </div>

            {/* Bot√£o Fechar (X) - v1.35.68: padronizado */}
            <button
              onClick={onClose}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
              aria-label="Fechar modal"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>

        {/* ‚îÄ‚îÄ‚îÄ Body: Conte√∫do Scroll√°vel ou Editor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  */}
        <div
          className="flex-1 p-4 sm:p-6 overflow-y-auto"
          style={{
            minHeight: 0,
            overflowY: 'auto',
            transition: 'none'
          }}
        >
          {isEditing ? (
            // Modo Edi√ß√£o: Quill Editor com altura m√°xima para n√£o ativar scroll externo
            <div className="space-y-2">
              {/* v1.35.61: VoiceButton para Quick Edit */}
              <div className="flex justify-end">
                <VoiceButton
                  onTranscript={handleVoiceTranscript}
                  size="md"
                  idleText="Ditar"
                  onError={(err) => console.warn('[VoiceToText]', err)}
                />
              </div>
              <div
                className={`quick-edit-wrapper fontsize-${fontSize} spacing-${spacing} ${editorTheme === 'light' ? 'quill-light-theme bg-white' : 'theme-bg-primary'} border theme-border-input rounded-lg`}
                style={{
                  maxHeight: 'calc(55vh + 4px)',
                  overflow: 'hidden'
                }}
              >
                <QuillEditorBase
                  ref={quickEditRef}
                  content={editedContent}
                  onChange={(html) => onContentChange?.(html)}
                  toolbarConfig={getQuillToolbarConfig('simple')}
                  placeholder="Edite o conte√∫do do modelo..."
                  className="flex-1"
                  quillReady={quillReady}
                  quillError={quillError}
                />
              </div>
            </div>
          ) : (
            // Modo Visualiza√ß√£o: HTML renderizado
            <div
              className={`model-preview-content ${editorTheme === 'light' ? 'light-theme-content' : ''}`}
              dangerouslySetInnerHTML={{ __html: sanitizedContent }}
            />
          )}
        </div>

        {/* ‚îÄ‚îÄ‚îÄ Footer: Bot√µes de A√ß√£o (condicionais por modo) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  */}
        <div className="p-4 sm:p-6 border-t theme-border-input flex gap-3 justify-end flex-shrink-0">
          {isEditing ? (
            // Bot√µes modo edi√ß√£o
            <>
              <button
                onClick={onCancelEditing}
                className="px-4 py-3 rounded-lg font-medium text-white theme-bg-tertiary hover-slate-500"
              >
                Cancelar
              </button>
              <button
                onClick={() => onSaveEdit?.(quickEditRef)}
                className="hover-green-500 px-4 py-2 text-white rounded-lg font-semibold flex items-center gap-2 bg-green-600"
              >
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                </svg>
                Atualizar Modelo
              </button>
              {onOpenSaveAsNew && (
                <button
                  onClick={() => {
                    const content = quickEditRef.current?.root?.innerHTML || editedContent;
                    onOpenSaveAsNew(content, model);
                  }}
                  className="hover-purple-700 px-4 py-2 text-white rounded-lg font-semibold flex items-center gap-2 bg-purple-600"
                >
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" />
                  </svg>
                  Salvar como Novo
                </button>
              )}
            </>
          ) : (
            // Bot√µes modo visualiza√ß√£o
            <>
              <button
                onClick={onClose}
                className="px-4 py-3 rounded-lg font-medium text-white theme-bg-tertiary hover-slate-500"
              >
                Fechar
              </button>
              <button
                onClick={handleCopy}
                className="hover-green-700 px-4 py-2 text-white rounded-lg font-semibold flex items-center gap-2 bg-green-600"
              >
                <Copy className="w-4 h-4" />
                Copiar
              </button>
              <button
                onClick={onStartEditing}
                className="hover-yellow-alpha px-4 py-2 rounded-lg font-semibold flex items-center gap-2 border border-yellow-500 text-yellow-400"
              >
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                </svg>
                Editar
              </button>
              <button
                onClick={handleInsert}
                className="hover-blue-700 px-4 py-2 text-white rounded-lg font-semibold flex items-center gap-2 bg-blue-600"
              >
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clipRule="evenodd" />
                </svg>
                Inserir no Editor
              </button>
              {onDelete && (
                <button
                  onClick={() => { onDelete(model); onClose(); }}
                  className="hover-red-700-from-600 px-4 py-2 text-white rounded-lg font-semibold flex items-center gap-2 bg-red-600"
                >
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" />
                  </svg>
                  Excluir
                </button>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
});

ModelPreviewModal.displayName = 'ModelPreviewModal';

// üìù SLASH COMMAND MENU (v1.33.8) - Acesso r√°pido a modelos com /
// v1.33.8: Viewport-aware positioning, tooltip preview, toggle busca sem√¢ntica
const SlashCommandMenu = React.memo(({
  isOpen,
  position,
  models,
  searchTerm,
  selectedIndex,
  onSelect,
  onClose,
  onSearchChange,
  onNavigate,
  semanticAvailable,      // v1.33.8: indica se busca sem√¢ntica est√° dispon√≠vel
  searchModelsBySimilarity // v1.33.8: fun√ß√£o para busca sem√¢ntica
}) => {
  const inputRef = React.useRef(null);
  const listRef = React.useRef(null);
  const menuRef = React.useRef(null);

  // v1.33.8: Estado para toggle busca sem√¢ntica
  const [useSemanticSearch, setUseSemanticSearch] = React.useState(false);
  const [semanticResults, setSemanticResults] = React.useState(null);
  const [isSearching, setIsSearching] = React.useState(false);

  // v1.33.8: Ajustar posi√ß√£o para ficar dentro da viewport
  const adjustedPosition = React.useMemo(() => {
    const menuHeight = 360; // altura aproximada do menu
    const menuWidth = 320;
    const viewportHeight = typeof window !== 'undefined' ? window.innerHeight : 800;
    const viewportWidth = typeof window !== 'undefined' ? window.innerWidth : 1200;

    let top = position.top;
    let left = position.left;

    // Se vai sair pela parte inferior, posicionar acima
    if (top + menuHeight > viewportHeight - 20) {
      top = Math.max(20, viewportHeight - menuHeight - 20);
    }

    // Se vai sair pela direita, ajustar
    if (left + menuWidth > viewportWidth - 20) {
      left = Math.max(20, viewportWidth - menuWidth - 20);
    }

    return { top, left };
  }, [position]);

  // v1.33.8: Busca sem√¢ntica com debounce
  React.useEffect(() => {
    if (!useSemanticSearch || !searchModelsBySimilarity || !searchTerm || searchTerm.trim().length < 2) {
      setSemanticResults(null);
      return;
    }

    const timeoutId = setTimeout(async () => {
      setIsSearching(true);
      try {
        const results = await searchModelsBySimilarity(models, searchTerm.toLowerCase(), { threshold: 0.3, limit: 10 });
        setSemanticResults(results);
      } catch (error) {
        console.error('[SlashCommand] Erro na busca sem√¢ntica:', error);
        setSemanticResults(null);
      }
      setIsSearching(false);
    }, 300);

    return () => clearTimeout(timeoutId);
  }, [searchTerm, useSemanticSearch, models, searchModelsBySimilarity]);

  // Filtrar modelos pelo termo de busca (textual)
  const filteredModels = React.useMemo(() => {
    // Se busca sem√¢ntica est√° ativa e tem resultados, usar eles
    if (useSemanticSearch && semanticResults) {
      return semanticResults;
    }
    if (!models || models.length === 0) return [];
    const term = (searchTerm || '').toLowerCase().trim();
    if (!term) return models.slice(0, 10);
    return models.filter(m =>
      m.title.toLowerCase().includes(term) ||
      (m.keywords && m.keywords.toLowerCase().includes(term))
    ).slice(0, 10);
  }, [models, searchTerm, useSemanticSearch, semanticResults]);

  // Auto-focus no input quando abre
  React.useEffect(() => {
    if (isOpen && inputRef.current) {
      const timeoutId = setTimeout(() => inputRef.current?.focus(), 50);
      return () => clearTimeout(timeoutId);
    }
  }, [isOpen]);

  // Scroll para item selecionado
  React.useEffect(() => {
    if (listRef.current && filteredModels.length > 0) {
      const selectedEl = listRef.current.children[selectedIndex];
      if (selectedEl) {
        selectedEl.scrollIntoView({ block: 'nearest' });
      }
    }
  }, [selectedIndex, filteredModels.length]);

  // Handler de teclado
  const handleKeyDown = React.useCallback((e) => {
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        onNavigate?.('down', filteredModels.length);
        break;
      case 'ArrowUp':
        e.preventDefault();
        onNavigate?.('up', filteredModels.length);
        break;
      case 'Enter':
        e.preventDefault();
        if (filteredModels[selectedIndex]) {
          onSelect?.(filteredModels[selectedIndex]);
        }
        break;
      case 'Escape':
        e.preventDefault();
        onClose?.();
        break;
      case 'Tab':
        e.preventDefault();
        onClose?.();
        break;
    }
  }, [filteredModels, selectedIndex, onSelect, onClose, onNavigate]);

  if (!isOpen) return null;

  // v1.33.8: Helper para extrair texto puro do HTML (para tooltip)
  // v1.33.10: Mostrar modelo completo no tooltip
  const getPreviewText = (content) => {
    if (!content) return 'Sem conte√∫do';
    return content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
  };

  return (
    <div
      ref={menuRef}
      className="slash-command-menu fixed z-[100] theme-bg-secondary border theme-border-input rounded-lg shadow-xl w-80"
      style={{ top: adjustedPosition.top, left: adjustedPosition.left, maxHeight: '360px' }}
    >
      <div className="p-2 border-b theme-border-input flex items-center gap-2">
        <input
          ref={inputRef}
          type="text"
          value={searchTerm}
          onChange={(e) => onSearchChange?.(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder={useSemanticSearch ? "Busca sem√¢ntica..." : "Buscar modelo..."}
          className="flex-1 px-2 py-1.5 theme-bg-primary theme-text-primary border theme-border-input rounded text-sm focus:outline-none focus:ring-1 focus:ring-purple-500"
        />
        {/* v1.33.8: Toggle busca sem√¢ntica */}
        {semanticAvailable && (
          <button
            onClick={() => {
              setUseSemanticSearch(prev => !prev);
              setSemanticResults(null);
            }}
            className={`p-1.5 rounded text-sm transition-colors ${
              useSemanticSearch
                ? 'bg-purple-600 text-white hover:bg-purple-700'
                : 'theme-bg-tertiary theme-text-secondary hover-slate-600'
            }`}
            title={useSemanticSearch ? 'Busca sem√¢ntica (por significado)' : 'Busca textual (por palavras)'}
          >
            {useSemanticSearch ? 'üß†' : 'üî§'}
          </button>
        )}
        <button
          onClick={onClose}
          className="p-1 rounded hover-slate-600 theme-text-muted"
          title="Fechar (Esc)"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div ref={listRef} className="overflow-y-auto" style={{ maxHeight: '280px' }}>
        {isSearching ? (
          <div className="px-3 py-4 text-sm theme-text-muted text-center">
            <span className="animate-pulse">Buscando...</span>
          </div>
        ) : filteredModels.length === 0 ? (
          <div className="px-3 py-4 text-sm theme-text-muted text-center">
            Nenhum modelo encontrado
          </div>
        ) : (
          filteredModels.map((model, idx) => (
            <div
              key={model.id}
              onClick={() => onSelect?.(model)}
              className={`px-3 py-2 cursor-pointer border-l-2 ${
                idx === selectedIndex
                  ? 'bg-purple-600/30 border-purple-500'
                  : 'border-transparent hover-slate-700'
              }`}
              title={getPreviewText(model.content)}
            >
              <div className="flex items-center gap-2">
                <div className="text-sm font-medium theme-text-primary truncate flex-1">{model.title}</div>
                {/* v1.33.8: Badge de similaridade (busca sem√¢ntica) */}
                {/* v1.33.9: Fix contraste tema claro */}
                {model.similarity !== undefined && (
                  <span className={`text-[10px] px-1.5 py-0.5 rounded font-medium ${
                    model.similarity >= 0.7 ? 'bg-green-500/20 text-green-700 dark:text-green-400' :
                    model.similarity >= 0.5 ? 'bg-yellow-500/20 text-yellow-700 dark:text-yellow-400' :
                    'bg-gray-500/20 text-gray-700 dark:text-gray-400'
                  }`}>
                    {Math.round(model.similarity * 100)}%
                  </span>
                )}
              </div>
              <div className="text-xs theme-text-muted truncate">{model.category}</div>
            </div>
          ))
        )}
      </div>
      <div className="px-3 py-1.5 border-t theme-border-input text-xs theme-text-muted flex items-center gap-2">
        <span>‚Üë‚Üì</span> navegar
        <span className="mx-1">¬∑</span>
        <span>Enter</span> inserir
        <span className="mx-1">¬∑</span>
        <span>Esc</span> fechar
        {useSemanticSearch && <span className="ml-auto text-purple-400">üß†</span>}
      </div>
    </div>
  );
});

SlashCommandMenu.displayName = 'SlashCommandMenu';

// üìù FIELD EDITOR (v1.12.0) - Editor Quill sem toolbar
// v1.15.3: Adicionado suporte a slash command (/)
// v1.20.4: forwardRef para expor API de formata√ß√£o
const FieldEditor = React.memo(React.forwardRef(({
  label,
  content,
  onChange,
  onFocus,
  onBlur,
  onSlashCommand,
  fieldType = 'text', // 'relatorio' | 'fundamentacao' | 'dispositivo'
  quillReady,
  quillError,
  minHeight = '120px',
  editorTheme = 'dark',
  hideVoiceButton = false // v1.35.65: Esconder VoiceButton quando gerenciado externamente
}, ref) => {
  const editorRef = React.useRef(null);
  const quillInstanceRef = React.useRef(null);

  // v1.20.4: Expor m√©todos de formata√ß√£o para componente pai (toolbar inline)
  React.useImperativeHandle(ref, () => ({
    format: (name, value) => quillInstanceRef.current?.format(name, value),
    getFormat: () => quillInstanceRef.current?.getFormat() || {},
    focus: () => quillInstanceRef.current?.focus()
  }), []);
  const isInitializedRef = React.useRef(false);
  const lastContentRef = React.useRef('');
  const onSlashCommandRef = React.useRef(onSlashCommand);
  const onChangeDebounceRef = React.useRef(null); // v1.35.3: Debounce para onChange
  // v1.25.18: Refs para cleanup de blur listener (memory leak fix)
  const blurHandlerRef = React.useRef(null);
  const blurTimeoutRef = React.useRef(null);

  // Manter ref atualizada
  React.useEffect(() => {
    onSlashCommandRef.current = onSlashCommand;
  }, [onSlashCommand]);

  // Inicializa√ß√£o do Quill (sem toolbar)
  React.useEffect(() => {
    if (!quillReady || !window.Quill || isInitializedRef.current || !editorRef.current) return;

    try {
      quillInstanceRef.current = new window.Quill(editorRef.current, {
        theme: 'snow',
        modules: {
          toolbar: false,  // SEM TOOLBAR - formata√ß√£o via shortcuts
          keyboard: {
            bindings: {}  // Shortcuts padr√£o: Ctrl+B, Ctrl+I, Ctrl+U
          }
        },
        placeholder: `Digite o ${label.toLowerCase()} aqui...`
      });

      // Setar conte√∫do inicial
      if (content) {
        quillInstanceRef.current.root.innerHTML = content;
        lastContentRef.current = content;
      }

      // Event listener - mudan√ßas de texto
      // v1.35.3: Debounce para evitar lag durante digita√ß√£o r√°pida
      quillInstanceRef.current.on('text-change', (delta, oldDelta, source) => {
        // v1.15.3: Detectar "\" digitado pelo usu√°rio para slash command (SEM debounce)
        if (source === 'user' && onSlashCommandRef.current) {
          const ops = delta.ops || [];
          const lastOp = ops[ops.length - 1];
          if (typeof lastOp?.insert === 'string' && lastOp.insert.endsWith('\\')) {
            const quill = quillInstanceRef.current;
            const range = quill.getSelection();
            if (range) {
              const bounds = quill.getBounds(range.index);
              const editorRect = editorRef.current?.getBoundingClientRect();
              if (editorRect) {
                onSlashCommandRef.current({
                  position: {
                    top: editorRect.top + bounds.top + bounds.height + 5,
                    left: editorRect.left + bounds.left
                  },
                  quillInstance: quill,
                  triggerPosition: range.index - 1
                });
              }
            }
          }
        }

        // v1.35.3: Debounce onChange (150ms) - evita re-renders excessivos
        if (onChangeDebounceRef.current) {
          clearTimeout(onChangeDebounceRef.current);
        }
        onChangeDebounceRef.current = setTimeout(() => {
          const html = quillInstanceRef.current?.root?.innerHTML;
          if (!html) return;
          if (html !== lastContentRef.current) {
            lastContentRef.current = html;
            onChange?.(html);
          }
        }, 150);
      });

      // Event listener - foco (para sugest√µes contextuais)
      if (onFocus) {
        quillInstanceRef.current.root.addEventListener('focus', onFocus);
      }

      // v1.24: Event listener - blur (para versionamento)
      // v1.25.18: Usar handler nomeado para permitir cleanup (memory leak fix)
      if (onBlur) {
        blurHandlerRef.current = () => {
          if (blurTimeoutRef.current) clearTimeout(blurTimeoutRef.current);
          blurTimeoutRef.current = setTimeout(() => {
            const html = quillInstanceRef.current?.root?.innerHTML || '';
            if (html && html !== '<p><br></p>') onBlur(html);
          }, 0);
        };
        quillInstanceRef.current.root.addEventListener('blur', blurHandlerRef.current);
      }

      isInitializedRef.current = true;
    } catch (error) {
    }
  }, [quillReady]);

  React.useEffect(() => {
    if (!quillInstanceRef.current || !isInitializedRef.current) return;

    // S√≥ atualizar se o conte√∫do mudou externamente (n√£o pelo pr√≥prio Quill)
    if (content !== lastContentRef.current) {
      quillInstanceRef.current.root.innerHTML = content || '';
      lastContentRef.current = content || '';
    }
  }, [content]);

  // Cleanup
  React.useEffect(() => {
    return () => {
      // v1.25.18: Limpar timeout pendente (memory leak fix)
      if (blurTimeoutRef.current) {
        clearTimeout(blurTimeoutRef.current);
        blurTimeoutRef.current = null;
      }
      if (quillInstanceRef.current) {
        quillInstanceRef.current.off('text-change');
        if (onFocus) {
          quillInstanceRef.current.root?.removeEventListener('focus', onFocus);
        }
        // v1.25.18: Remover blur listener (memory leak fix)
        if (blurHandlerRef.current) {
          quillInstanceRef.current.root?.removeEventListener('blur', blurHandlerRef.current);
        }
        quillInstanceRef.current = null;
      }
      if (editorRef.current) {
        editorRef.current.innerHTML = '';
      }
      isInitializedRef.current = false;
    };
  }, []);

  // v1.35.62: Handler para Voice-to-Text - insere texto na posi√ß√£o do cursor
  const handleVoiceTranscript = React.useCallback((text) => {
    const quill = quillInstanceRef.current;
    if (quill) {
      requestAnimationFrame(() => {
        const range = quill.getSelection() || { index: quill.getLength() - 1 };
        quill.insertText(range.index, text + ' ');
        quill.setSelection(range.index + text.length + 1);
      });
    }
  }, []);

  // Renderiza√ß√£o
  if (!quillReady) {
    return (
      <div className="field-editor">
        <label className="block text-xs font-semibold theme-text-muted mb-1">{label}</label>
        <div className="theme-bg-primary border theme-border-input rounded p-3 text-sm theme-text-muted">
          ‚è≥ Carregando editor...
        </div>
      </div>
    );
  }

  if (quillError) {
    return (
      <div className="field-editor">
        <label className="block text-xs font-semibold theme-text-muted mb-1">{label}</label>
        <div className="bg-red-900/20 border border-red-600 rounded p-3 text-sm text-red-400">
          ‚ùå {quillError}
        </div>
      </div>
    );
  }

  return (
    <div className="field-editor">
      {/* v1.35.62: Label + VoiceButton | v1.35.65: hideVoiceButton para gerenciamento externo */}
      <div className="flex items-center justify-between mb-1">
        <label className="block text-xs font-semibold theme-text-muted">{label}</label>
        {!hideVoiceButton && (
          <VoiceButton
            onTranscript={handleVoiceTranscript}
            size="sm"
            onError={(err) => console.warn('[VoiceToText]', err)}
          />
        )}
      </div>
      <div
        ref={editorRef}
        className={`${editorTheme === 'light' ? 'quill-light-theme bg-white' : 'theme-bg-primary'} border theme-border-input rounded field-editor-content`}
        style={{
          minHeight,
          overflow: 'hidden'
        }}
      />
    </div>
  );
}));

FieldEditor.displayName = 'FieldEditor';

// üìù LINKED PROOFS MODAL (v1.12.14)
const LinkedProofsModal = React.memo(({
  isOpen,
  onClose,
  topicTitle,
  linkedProofs,
  proofManager
}) => {
  if (!isOpen || !linkedProofs) return null;

  return (
    <div className="absolute inset-0 bg-black/80 flex items-start justify-center z-[80] py-8 px-4 overflow-y-auto">
      <div className="theme-bg-primary rounded-lg shadow-2xl border border-green-700 max-w-4xl w-full">
        {/* Header */}
        <div className="p-4 border-b border-green-500/30 flex items-center justify-between flex-shrink-0">
          <div className="flex items-center gap-3">
            <Scale className="w-6 h-6 text-green-400" />
            <div>
              <h3 className="text-lg font-bold text-green-400">Provas Vinculadas</h3>
              <p className="text-sm theme-text-muted">{topicTitle}</p>
            </div>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover-slate-700 rounded-lg transition-colors"
          >
            <X className="w-5 h-5 theme-text-secondary" />
          </button>
        </div>

        {/* Lista de Provas */}
        <div className="p-4 space-y-3 max-h-[75vh] overflow-y-auto">
          {linkedProofs.length === 0 ? (
            <div className="text-center py-8 theme-text-muted">
              <Scale className="w-12 h-12 mx-auto mb-3 opacity-50" />
              <p>Nenhuma prova vinculada a este t√≥pico</p>
            </div>
          ) : (
            linkedProofs.map((proof) => (
              <div
                key={proof.id}
                className="theme-bg-secondary-50 rounded-lg p-3 border theme-border-input"
              >
                <div className="flex items-center gap-2 mb-2">
                  <FileText className="w-4 h-4 text-blue-400 flex-shrink-0" />
                  <h5 className="font-medium theme-text-secondary text-sm flex-1 truncate">{proof.name}</h5>
                  <span className={`px-2 py-0.5 text-xs rounded ${
                    proof.isPdf
                      ? 'theme-bg-red-accent theme-text-red'
                      : 'theme-bg-blue-accent theme-text-blue'
                  }`}>
                    {proof.isPdf ? 'PDF' : 'TEXTO'}
                  </span>
                </div>

                {/* An√°lise IA */}
                {proofManager?.proofAnalysisResults?.[proof.id] && (
                  <div className="mb-2 p-2 theme-bg-blue-accent border border-blue-500/30 rounded text-xs">
                    <div className="flex items-center gap-1 mb-1">
                      <Sparkles className="w-3 h-3 theme-text-blue" />
                      <span className="font-medium theme-text-blue">
                        {proofManager.proofAnalysisResults[proof.id].type === 'livre' ? 'An√°lise Livre' : 'An√°lise Contextual'}
                      </span>
                    </div>
                    <div className="overflow-y-auto" style={{ resize: 'vertical', height: '8rem', minHeight: '8rem' }}>
                      <p className="theme-text-tertiary whitespace-pre-wrap">
                        {proofManager.proofAnalysisResults[proof.id].result}
                      </p>
                    </div>
                  </div>
                )}

                {/* Conclus√µes Manuais */}
                {proofManager?.proofConclusions?.[proof.id] && (
                  <div className="p-2 theme-bg-green-accent border border-green-500/30 rounded text-xs">
                    <div className="flex items-center gap-1 mb-1">
                      <Edit className="w-3 h-3 theme-text-green" />
                      <span className="font-medium theme-text-green">Minhas Conclus√µes</span>
                    </div>
                    <div className="overflow-y-auto" style={{ resize: 'vertical', height: '6rem', minHeight: '6rem' }}>
                      <p className="theme-text-tertiary whitespace-pre-wrap">
                        {proofManager.proofConclusions[proof.id]}
                      </p>
                    </div>
                  </div>
                )}
              </div>
            ))
          )}
        </div>

        {/* Footer */}
        <div className="p-4 border-t theme-border-secondary flex-shrink-0">
          <button
            onClick={onClose}
            className="w-full py-2 theme-bg-tertiary hover-slate-600 rounded-lg text-sm font-medium theme-text-secondary"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  );
});

LinkedProofsModal.displayName = 'LinkedProofsModal';

// ‚öñÔ∏è v1.20.0: Modal de Jurisprud√™ncia Reutiliz√°vel
const JURIS_TIPOS_DISPONIVEIS = ['IRR', 'IAC', 'IRDR', 'S√∫mula', 'OJ', 'RG', 'ADI/ADC/ADPF', 'Informativo'];
const JURIS_TRIBUNAIS_DISPONIVEIS = ['TST', 'STF', 'STJ', 'TRT8'];

// v1.32.18: Adicionado useLocalAI e jurisSemanticThreshold para busca sem√¢ntica
// v1.33.16: Adicionado jurisSemanticEnabled para toggle interno + badge IA Local
const JurisprudenciaModal = React.memo(({ isOpen, onClose, topicTitle, topicRelatorio, callAI, useLocalAI = false, jurisSemanticThreshold = 50, jurisSemanticEnabled = false }) => {
  const [suggestions, setSuggestions] = React.useState([]);
  const [loading, setLoading] = React.useState(false);
  const [copiedId, setCopiedId] = React.useState(null);
  const [filtros, setFiltros] = React.useState({ tipo: [], tribunal: [] });
  const [searchTerm, setSearchTerm] = React.useState('');
  const [searchApplied, setSearchApplied] = React.useState('');
  const [searchSource, setSearchSource] = React.useState(null); // 'local' ou 'text'
  const [useSemanticMode, setUseSemanticMode] = React.useState(useLocalAI); // v1.33.16: estado interno para toggle

  // v1.32.18: Busca sem√¢ntica via IA Local
  const doSemanticSearch = React.useCallback(async (queryText) => {
    try {
      const threshold = jurisSemanticThreshold / 100;
      // v1.32.20: toLowerCase para E5 case-sensitive
      const queryEmbedding = await AIModelService.getEmbedding(queryText.toLowerCase(), 'query');
      // v1.32.21: Passar filtros para aplicar ANTES do limit (retorna at√© 30 do tipo desejado)
      const results = await JurisEmbeddingsService.searchBySimilarity(queryEmbedding, threshold, 30, filtros);

      return results;
    } catch (err) {
      console.warn('[JurisModal] Erro na busca sem√¢ntica:', err);
      return [];
    }
  }, [jurisSemanticThreshold, filtros]);

  const doSearch = React.useCallback(async (term = '') => {
    setLoading(true);
    setSuggestions([]);
    setSearchApplied(term);
    try {
      // v1.33.16: Usar busca sem√¢ntica se toggle ativo E IA Local habilitada
      if (useSemanticMode && jurisSemanticEnabled) {
        // v1.32.19: Usar apenas t√≠tulo para query mais focada (relat√≥rio longo dilui relev√¢ncia)
        const queryText = term || topicTitle;
        const results = await doSemanticSearch(queryText);
        setSuggestions(results);
        setSearchSource('local');
      } else {
        const results = await findJurisprudenciaHelper(topicTitle, topicRelatorio, callAI, { ...filtros, searchTerm: term });
        setSuggestions(results);
        setSearchSource('text');
      }
    } catch { setSuggestions([]); }
    setLoading(false);
  }, [topicTitle, topicRelatorio, callAI, filtros, useSemanticMode, jurisSemanticEnabled, doSemanticSearch]);

  // v1.33.16: Re-busca quando toggle muda
  React.useEffect(() => {
    if (isOpen && topicTitle) {
      doSearch(searchApplied);
    }
  }, [isOpen, topicTitle, filtros, useSemanticMode]);

  // v1.33.17: Sincronizar useSemanticMode com useLocalAI quando modal abre
  React.useEffect(() => {
    if (isOpen) {
      setUseSemanticMode(useLocalAI);
    }
  }, [isOpen, useLocalAI]);

  React.useEffect(() => {
    if (!isOpen) {
      setFiltros({ tipo: [], tribunal: [] });
      setSearchTerm('');
      setSearchApplied('');
    }
  }, [isOpen]);

  // v1.35.64: ESC handler
  React.useEffect(() => {
    const handleEsc = (e) => {
      if (e.key === 'Escape') onClose();
    };
    if (isOpen) {
      window.addEventListener('keydown', handleEsc);
    }
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  // v1.35.64: Bloquear scroll do body quando modal aberto
  React.useEffect(() => {
    if (isOpen) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => {
        document.body.style.overflow = originalOverflow;
      };
    }
  }, [isOpen]);

  if (!isOpen) return null;

  const handleCopy = async (p) => {
    const tipo = isIRRType(p.tipoProcesso) ? 'IRR' : (p.tipoProcesso || '');
    const identificador = p.tema ? `Tema ${p.tema}` : (p.numero ? `n¬∫ ${p.numero}` : '');
    const partes = [];
    partes.push(`${tipo}${identificador ? ` ${identificador}` : ''}${p.tribunal ? ` - ${p.tribunal}` : ''}${p.orgao ? ` - ${p.orgao}` : ''}`);
    if (p.titulo) partes.push(`T√≠tulo: ${p.titulo}`);
    if (p.numeroProcesso) partes.push(`Processo: ${p.numeroProcesso}`);
    if (p.relator) partes.push(`Relator: ${p.relator}`);
    if (p.dataPublicacao || p.dataAprovacao || p.dataJulgamento) partes.push(`Data: ${p.dataPublicacao || p.dataAprovacao || p.dataJulgamento}`);
    if (p.resolucao) partes.push(`Resolu√ß√£o: ${p.resolucao}`);
    if (p.status) partes.push(`Status: ${p.status.replace(/_/g, ' ')}`);
    partes.push('');
    partes.push(p.tese || p.enunciado || '');
    await navigator.clipboard.writeText(partes.join('\n'));
    setCopiedId(p.id);
    setTimeout(() => setCopiedId(null), 2000);
  };

  return (
    <div className={`${CSS.modalOverlay} overflow-auto`} onClick={onClose}>
      <div className={`${CSS.modalContainer} flex flex-col my-auto`} style={{ width: '80vw', maxHeight: '90vh' }} onClick={(e) => e.stopPropagation()}>
        <div className="p-4 border-b theme-border flex justify-between items-center flex-shrink-0">
          <h3 className="font-semibold theme-text-primary flex items-center gap-2">
            <Scale className="w-4 h-4" />
            Jurisprud√™ncia: {topicTitle}
            {searchSource === 'local' && (
              <span className="bg-purple-600 text-white px-1.5 py-0.5 rounded text-[10px]">ü§ñ IA Local</span>
            )}
          </h3>
          <button onClick={onClose} className="p-1 rounded hover-bg-tertiary">
            <X className="w-5 h-5 theme-text-secondary" />
          </button>
        </div>
        <div className="px-4 py-2 border-b theme-border flex flex-wrap gap-2 items-center flex-shrink-0">
          <span className="text-xs theme-text-muted mr-1">Filtros:</span>
          <div className="flex gap-1 flex-wrap">
            {JURIS_TIPOS_DISPONIVEIS.map(tipo => (
              <button
                key={tipo}
                onClick={() => setFiltros(prev => ({
                  ...prev,
                  tipo: prev.tipo.includes(tipo) ? prev.tipo.filter(t => t !== tipo) : [...prev.tipo, tipo]
                }))}
                className={`px-2 py-0.5 rounded-full text-xs transition-colors ${filtros.tipo.includes(tipo) ? 'bg-purple-600 text-white' : 'theme-bg-tertiary theme-text-tertiary hover-slate-600'}`}
              >
                {tipo}
              </button>
            ))}
          </div>
          <div className="w-px h-4 theme-bg-tertiary mx-1" />
          <div className="flex gap-1 flex-wrap">
            {JURIS_TRIBUNAIS_DISPONIVEIS.map(trib => (
              <button
                key={trib}
                onClick={() => setFiltros(prev => ({
                  ...prev,
                  tribunal: prev.tribunal.includes(trib) ? prev.tribunal.filter(t => t !== trib) : [...prev.tribunal, trib]
                }))}
                className={`px-2 py-0.5 rounded-full text-xs transition-colors ${filtros.tribunal.includes(trib) ? 'bg-blue-600 text-white' : 'theme-bg-tertiary theme-text-tertiary hover-slate-600'}`}
              >
                {trib}
              </button>
            ))}
          </div>
          <div className="w-px h-4 theme-bg-tertiary mx-1" />
          <div className="flex items-center gap-2 flex-1 min-w-[200px]">
            <div className="flex-1 relative">
              <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400" />
              <input
                type="text"
                placeholder="Buscar por termo, tese..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && doSearch(searchTerm.trim())}
                className="w-full pl-8 pr-2 py-1 border rounded text-xs theme-input"
              />
            </div>
            <button
              onClick={() => doSearch(searchTerm.trim())}
              disabled={loading}
              className="px-2.5 py-1 bg-blue-600 text-white rounded text-xs hover-blue-700-from-600 disabled:opacity-50 flex items-center gap-1"
            >
              <Search className="w-3 h-3" />
              Buscar
            </button>
            {searchApplied && (
              <button
                onClick={() => { setSearchTerm(''); doSearch(''); }}
                className="px-2 py-1 theme-bg-tertiary theme-text-secondary rounded text-xs hover-slate-600"
                title="Limpar busca"
              >
                <X className="w-3 h-3" />
              </button>
            )}
            {/* v1.33.16: Toggle sem√¢ntico/textual */}
            {jurisSemanticEnabled && (
              <button
                onClick={() => setUseSemanticMode(prev => !prev)}
                className={`px-2 py-1 rounded text-xs transition-colors ${
                  useSemanticMode
                    ? 'bg-purple-600 text-white hover:bg-purple-700'
                    : 'theme-bg-tertiary theme-text-secondary hover-slate-600'
                }`}
                title={useSemanticMode ? 'Busca sem√¢ntica (por significado)' : 'Busca textual (por palavras)'}
              >
                {useSemanticMode ? 'üß†' : 'üî§'}
              </button>
            )}
          </div>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-3">
          {loading ? (
            <div className="text-center py-8">
              <Loader2 className="w-6 h-6 animate-spin mx-auto mb-2 text-purple-500" />
              <p className="text-sm theme-text-muted">Buscando precedentes relevantes...</p>
            </div>
          ) : suggestions.length === 0 ? (
            <div className="text-center py-8">
              <Scale className="w-8 h-8 mx-auto mb-2 theme-text-muted opacity-50" />
              <p className="theme-text-muted">Nenhum precedente encontrado{searchApplied ? ` para "${searchApplied}"` : ' para este t√≥pico'}</p>
              <p className="text-xs theme-text-muted mt-1">{searchApplied ? 'Tente outros termos ou remova filtros' : 'Importe JSONs de jurisprud√™ncia na aba correspondente'}</p>
            </div>
          ) : (
            suggestions.map(p => (
              <div key={p.id} className="theme-bg-secondary p-3 rounded-lg border theme-border-secondary">
                <div className="flex flex-wrap justify-between items-start gap-2 mb-2">
                  <span className="text-xs px-2 py-0.5 rounded theme-bg-tertiary theme-text-tertiary">
                    {isIRRType(p.tipoProcesso) ? 'IRR' : p.tipoProcesso} {p.numero || p.tema}
                  </span>
                  <div className="flex gap-1 flex-wrap">
                    {p.status && (
                      <span className={`text-xs px-2 py-0.5 rounded ${isStatusValido(p.status) ? 'theme-badge-success' : 'theme-badge-error'}`}>
                        {isStatusValido(p.status) ? '‚úì' : '‚úó'} {p.status.replace(/_/g, ' ')}
                      </span>
                    )}
                    {p.orgao && <span className="text-xs px-2 py-0.5 rounded theme-badge-purple">{p.orgao}</span>}
                    {p.tribunal && <span className="text-xs px-2 py-0.5 rounded theme-badge-blue">{p.tribunal}</span>}
                    {/* v1.33.18: Badge de similaridade no modo sem√¢ntico */}
                    {searchSource === 'local' && p.similarity && (
                      <span className="text-xs px-2 py-0.5 rounded bg-green-600 text-white">
                        {Math.round(p.similarity * 100)}%
                      </span>
                    )}
                  </div>
                </div>
                {p.titulo && <p className="text-xs font-medium theme-text-primary mb-1">{p.titulo}</p>}
                <p className="text-sm theme-text-secondary mb-3 line-clamp-4">{p.tese || p.enunciado || p.fullText || p.text}</p>
                <button
                  onClick={() => handleCopy(p)}
                  className={`text-xs px-3 py-1.5 text-white rounded flex items-center gap-1 ${copiedId === p.id ? 'bg-green-600' : 'bg-purple-600 hover-purple-700'}`}
                >
                  {copiedId === p.id ? <Check className="w-3 h-3" /> : <Copy className="w-3 h-3" />}
                  {copiedId === p.id ? 'Copiado!' : 'Copiar'}
                </button>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
});
JurisprudenciaModal.displayName = 'JurisprudenciaModal';

// üìù INLINE FORMATTING TOOLBAR (v1.20.4) - Toolbar de formata√ß√£o para FieldEditor
const InlineFormattingToolbar = React.memo(({ editorRef }) => {
  const [activeFormats, setActiveFormats] = React.useState({});

  const updateFormats = React.useCallback(() => {
    if (editorRef?.current) {
      setActiveFormats(editorRef.current.getFormat());
    }
  }, [editorRef]);

  const toggleFormat = React.useCallback((format, value = true) => {
    if (!editorRef?.current) return;
    const current = editorRef.current.getFormat();
    const currentValue = current[format];
    if (format === 'list' || format === 'align') {
      editorRef.current.format(format, currentValue === value ? false : value);
    } else {
      editorRef.current.format(format, currentValue ? false : value);
    }
    updateFormats();
    editorRef.current.focus();
  }, [editorRef, updateFormats]);

  const setHeader = React.useCallback((level) => {
    if (!editorRef?.current) return;
    editorRef.current.format('header', level || false);
    updateFormats();
    editorRef.current.focus();
  }, [editorRef, updateFormats]);

  // v1.33.21: Limpar formata√ß√£o usando format(key, false) - wrapper n√£o tem getSelection/removeFormat
  const removeFormatting = React.useCallback(() => {
    if (!editorRef?.current) return;
    const quill = editorRef.current;
    const formats = quill.getFormat();
    // Remover cada formato ativo usando format(name, false)
    ['bold', 'italic', 'underline', 'strike', 'color', 'background', 'header', 'list', 'align', 'indent', 'link'].forEach(key => {
      if (formats[key]) quill.format(key, false);
    });
    updateFormats();
    quill.focus();
  }, [editorRef, updateFormats]);

  const btnClass = (isActive) =>
    `px-1.5 py-0.5 text-xs rounded transition-colors ${isActive
      ? 'bg-blue-600 text-white'
      : 'theme-bg-secondary theme-text-secondary'}`;

  return (
    <div className="flex items-center gap-1 flex-wrap" onClick={(e) => e.stopPropagation()}>
      <select
        className="text-xs px-1 py-0.5 theme-bg-secondary theme-border-input border rounded theme-text-primary"
        onChange={(e) => setHeader(e.target.value ? parseInt(e.target.value) : false)}
        value={activeFormats.header || ''}
        onFocus={updateFormats}
      >
        <option value="">¬∂</option>
        <option value="1">H1</option>
        <option value="2">H2</option>
        <option value="3">H3</option>
      </select>
      <span className="text-gray-500 text-xs">|</span>
      <button onClick={() => toggleFormat('bold')} className={btnClass(activeFormats.bold)} title="Negrito (Ctrl+B)"><strong>N</strong></button>
      <button onClick={() => toggleFormat('italic')} className={btnClass(activeFormats.italic)} title="It√°lico (Ctrl+I)"><em>I</em></button>
      <button onClick={() => toggleFormat('underline')} className={btnClass(activeFormats.underline)} title="Sublinhado (Ctrl+U)"><u>S</u></button>
      <span className="text-gray-500 text-xs">|</span>
      <button onClick={() => toggleFormat('list', 'ordered')} className={btnClass(activeFormats.list === 'ordered')} title="Lista numerada">1.</button>
      <button onClick={() => toggleFormat('list', 'bullet')} className={btnClass(activeFormats.list === 'bullet')} title="Lista com marcadores">‚Ä¢</button>
      <span className="text-gray-500 text-xs">|</span>
      <button onClick={() => toggleFormat('align', false)} className={btnClass(!activeFormats.align)} title="Alinhar √† esquerda">‚´∑</button>
      <button onClick={() => toggleFormat('align', 'center')} className={btnClass(activeFormats.align === 'center')} title="Centralizar">‚â°</button>
      <button onClick={() => toggleFormat('align', 'right')} className={btnClass(activeFormats.align === 'right')} title="Alinhar √† direita">‚´∏</button>
      <button onClick={() => toggleFormat('align', 'justify')} className={btnClass(activeFormats.align === 'justify')} title="Justificar">‚ò∞</button>
      <span className="text-gray-500 text-xs">|</span>
      <button onClick={() => removeFormatting()} className="px-1.5 py-0.5 text-xs rounded transition-colors theme-bg-secondary theme-text-secondary hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400" title="Limpar formata√ß√£o">‚úñ</button>
    </div>
  );
});
InlineFormattingToolbar.displayName = 'InlineFormattingToolbar';

// üìù GLOBAL EDITOR SECTION (v1.12.0)
const GlobalEditorSection = React.memo(({
  topic,
  topicIndex,
  onFieldChange,
  onFieldFocus,
  onSlashCommand,
  quillReady,
  quillError,
  editorTheme = 'dark',
  onOpenAIAssistant = null,
  onOpenProofsModal = null,
  onOpenJurisModal = null,
  linkedProofsCount = 0,
  isCollapsed = false,
  onToggleCollapse = null,
  versioning = null
}) => {
  const titleUpper = topic.title.toUpperCase();
  const isRelatorio = titleUpper === 'RELAT√ìRIO';
  const isDispositivo = titleUpper === 'DISPOSITIVO';

  // v1.20.4: Ref para toolbar inline no campo Decis√£o
  const fundamentacaoEditorRef = React.useRef(null);

  return (
    <div className="global-editor-section mb-6 border theme-border-secondary rounded-lg overflow-hidden">
      {/* Header fixo do t√≥pico - CLIC√ÅVEL PARA COLAPSAR */}
      <div
        className="px-4 py-3 theme-bg-tertiary border-b theme-border-secondary flex items-center gap-3 cursor-pointer select-none"
        onClick={() => onToggleCollapse?.(topicIndex)}
      >
        <ChevronDown className={`w-4 h-4 theme-text-secondary transition-transform duration-200 ${isCollapsed ? '-rotate-90' : ''}`} />
        <span className="font-bold theme-text-primary text-lg">{topic.title}</span>
        {!isRelatorio && !isDispositivo && topic.category && (
          <span className="px-2 py-0.5 text-xs rounded theme-bg-purple-accent theme-text-purple border border-purple-500/30">
            {topic.category}
          </span>
        )}
        {/* v1.12.14: Bot√£o Provas Vinculadas - apenas se houver provas */}
        {!isRelatorio && !isDispositivo && linkedProofsCount > 0 && onOpenProofsModal && (
          <button
            onClick={(e) => { e.stopPropagation(); onOpenProofsModal(topicIndex); }}
            className="ml-auto hover-green-700 px-2 py-1 text-white text-xs rounded flex items-center gap-1 bg-green-600"
            title="Ver Provas Vinculadas"
          >
            <Scale className="w-3 h-3" />
            Provas ({linkedProofsCount})
          </button>
        )}
      </div>

      {/* Editores dos campos - COLAPS√ÅVEL */}
      {!isCollapsed && (
        <div className="p-4 space-y-4 theme-bg-secondary">
          {isRelatorio ? (
            // RELAT√ìRIO: apenas editedRelatorio
            <FieldEditor
              label="Relat√≥rio"
              fieldType="relatorio"
              content={topic.editedRelatorio || topic.relatorio || ''}
              onChange={(html) => onFieldChange(topicIndex, 'editedRelatorio', html)}
              onFocus={() => onFieldFocus?.(topicIndex, 'relatorio', null)}
              onSlashCommand={onSlashCommand}
              quillReady={quillReady}
              quillError={quillError}
              minHeight="200px"
              editorTheme={editorTheme}
            />
          ) : isDispositivo ? (
            // DISPOSITIVO: apenas editedContent
            <FieldEditor
              label="Dispositivo"
              fieldType="dispositivo"
              content={topic.editedContent || ''}
              onChange={(html) => onFieldChange(topicIndex, 'editedContent', html)}
              onFocus={() => onFieldFocus?.(topicIndex, 'dispositivo', null)}
              onSlashCommand={onSlashCommand}
              quillReady={quillReady}
              quillError={quillError}
              minHeight="200px"
              editorTheme={editorTheme}
            />
          ) : (
            // T√≥pico normal: mini-relat√≥rio + decis√£o
            <>
              <FieldEditor
                label="Mini-Relat√≥rio"
                fieldType="relatorio"
                content={topic.editedRelatorio || topic.relatorio || ''}
                onChange={(html) => onFieldChange(topicIndex, 'editedRelatorio', html)}
                onFocus={() => onFieldFocus?.(topicIndex, 'relatorio', null)}
                onSlashCommand={onSlashCommand}
                quillReady={quillReady}
                quillError={quillError}
                minHeight="100px"
                editorTheme={editorTheme}
              />
              {/* v1.20.4: Wrapper com toolbar + bot√µes Jurisprud√™ncia/AI na linha do label */}
              <div>
                <div className="flex items-center justify-between mb-1 gap-2">
                  <div className="flex items-center gap-0">
                    <span className="text-xs font-medium theme-text-secondary uppercase tracking-wide flex-shrink-0">Decis√£o</span>
                    {/* v1.20.4: Toolbar de formata√ß√£o inline - pr√≥xima ao label */}
                    <div className="ml-8">
                      <InlineFormattingToolbar editorRef={fundamentacaoEditorRef} />
                    </div>
                  </div>
                  <div className="flex items-center gap-2 flex-wrap justify-end">
                    {versioning && (
                      <VersionSelect
                        topicTitle={topic.title}
                        versioning={versioning}
                        currentContent={topic.editedFundamentacao || topic.fundamentacao || ''}
                        onRestore={(content) => onFieldChange(topicIndex, 'editedFundamentacao', content)}
                      />
                    )}
                    {onOpenJurisModal && (
                      <button
                        onClick={() => onOpenJurisModal(topicIndex)}
                        className="hover-blue-700 px-2 py-1 text-white text-xs rounded flex items-center gap-1 bg-blue-600"
                        title="Buscar Jurisprud√™ncia"
                      >
                        <Scale className="w-3 h-3" />
                        Jurisprud√™ncia
                      </button>
                    )}
                    {onOpenAIAssistant && (
                      <button
                        onClick={() => onOpenAIAssistant(topicIndex)}
                        className="hover-purple-700 px-2 py-1 text-white text-xs rounded flex items-center gap-1 bg-purple-600"
                        title="Assistente de Reda√ß√£o IA"
                      >
                        <Sparkles className="w-3 h-3" />
                        Assistente IA
                      </button>
                    )}
                    {/* v1.35.65: VoiceButton ao lado do Assistente IA */}
                    <VoiceButton
                      onTranscript={(text) => {
                        // Inserir texto no editor de fundamenta√ß√£o via ref
                        if (fundamentacaoEditorRef.current) {
                          const current = topic.editedFundamentacao || topic.fundamentacao || '';
                          onFieldChange(topicIndex, 'editedFundamentacao', current + (current ? ' ' : '') + text);
                        }
                      }}
                      size="sm"
                      onError={(err) => console.warn('[VoiceToText]', err)}
                    />
                  </div>
                </div>
                <FieldEditor
                  ref={fundamentacaoEditorRef}
                  label=""
                  fieldType="fundamentacao"
                  content={topic.editedFundamentacao || topic.fundamentacao || ''}
                  onChange={(html) => onFieldChange(topicIndex, 'editedFundamentacao', html)}
                  onFocus={() => onFieldFocus?.(topicIndex, 'fundamentacao', topic)}
                  onBlur={(html) => versioning?.saveVersion(topic.title, html)}
                  onSlashCommand={onSlashCommand}
                  quillReady={quillReady}
                  quillError={quillError}
                  minHeight="150px"
                  editorTheme={editorTheme}
                  hideVoiceButton={true}
                />
              </div>
            </>
          )}
        </div>
      )}
    </div>
  );
});

GlobalEditorSection.displayName = 'GlobalEditorSection';

// üìù GLOBAL EDITOR MODAL (v1.12.0) - Edi√ß√£o global da senten√ßa
// v1.15.3: Adicionado suporte a slash command (/)
const GlobalEditorModal = React.memo(({
  isOpen,
  onClose,
  selectedTopics,
  setSelectedTopics,
  setExtractedTopics,
  models,
  findSuggestions,
  sanitizeHTML,
  showToast,
  fontSize = 'normal',
  spacing = 'normal',
  setFontSize = null,
  setSpacing = null,
  editorTheme = 'dark',
  quillReady = false,
  quillError = null,
  modelPreview = null,
  analyzedDocuments = {},
  proofManager = null,
  aiIntegration = null,
  detectResultadoAutomatico = null,
  onSlashCommand = null,
  fileToBase64 = null,
  openModal = null, // v1.21.6: Para abrir modal de anonimiza√ß√£o
  closeModal = null, // v1.21.6: Para fechar modal de anonimiza√ß√£o
  useLocalAIForSuggestions = false, // v1.28.08: Para exibir overlay IA Local
  // v1.32.18: Props para busca sem√¢ntica de jurisprud√™ncia
  useLocalAIForJuris = false,
  jurisSemanticThreshold = 50,
  searchModelReady = false,
  jurisEmbeddingsCount = 0,
  // v1.33.19: Fun√ß√£o para busca sem√¢ntica de modelos
  searchModelsBySimilarity = null,
  // v1.33.20: Config de busca sem√¢ntica de modelos (para inicializar toggle)
  modelSemanticEnabled = false
}) => {
  // Estado local para os t√≥picos (c√≥pia para edi√ß√£o)
  const [localTopics, setLocalTopics] = React.useState([]);
  const [isDirty, setIsDirty] = React.useState(false);
  const [originalTopics, setOriginalTopics] = React.useState([]);

  // Estados para sugest√µes de modelos - v1.12.2: inicia true para sugest√µes funcionarem na primeira abertura
  const [isSplitMode, setIsSplitMode] = React.useState(true);
  const [splitPosition, setSplitPosition] = React.useState(80); // v1.13: 80/20 por padr√£o
  const [currentFocusedTopic, setCurrentFocusedTopic] = React.useState(null);
  const isSavingRef = React.useRef(false); // Indica quando salvando para evitar reset de sugest√µes
  const wasOpenRef = React.useRef(false); // Track se modal j√° estava aberto (evita reset no Ctrl+S)
  const [suggestions, setSuggestions] = React.useState([]);
  const [suggestionsSource, setSuggestionsSource] = React.useState(null); // v1.28.06
  const [loadingSuggestions, setLoadingSuggestions] = React.useState(false);

  // Estados para busca manual de modelos - v1.12.12
  const [globalManualSearchTerm, setGlobalManualSearchTerm] = React.useState('');
  const [globalManualSearchResults, setGlobalManualSearchResults] = React.useState([]);

  // v1.33.19: Estados para busca sem√¢ntica na busca manual do editor global
  // v1.33.20: Inicializa com modelSemanticEnabled (respeitando config IA)
  const [useGlobalSemanticSearch, setUseGlobalSemanticSearch] = React.useState(modelSemanticEnabled);
  const [globalSemanticSearching, setGlobalSemanticSearching] = React.useState(false);

  // Estados para modais de confirma√ß√£o
  const [showCancelConfirm, setShowCancelConfirm] = React.useState(false);

  // Estado para se√ß√µes colapsadas - iniciar todas colapsadas
  const [collapsedSections, setCollapsedSections] = React.useState({});

  // Estados para detec√ß√£o autom√°tica de resultado ao salvar - v1.13
  const [editedTopicTitles, setEditedTopicTitles] = React.useState(new Set());
  const [isAnalyzingResults, setIsAnalyzingResults] = React.useState(false);
  const [analyzingProgress, setAnalyzingProgress] = React.useState({ current: 0, total: 0 });

  // Estados para modal de provas vinculadas - v1.12.14
  const [showProofsModal, setShowProofsModal] = React.useState(false);
  const [proofsModalTopicIndex, setProofsModalTopicIndex] = React.useState(null);

  const [showAIAssistant, setShowAIAssistant] = React.useState(false);
  const [aiAssistantTopicIndex, setAiAssistantTopicIndex] = React.useState(null);
  const [globalAiInstruction, setGlobalAiInstruction] = React.useState('');
  const [globalAiGeneratedText, setGlobalAiGeneratedText] = React.useState('');
  const [generatingGlobalAi, setGeneratingGlobalAi] = React.useState(false);
  const [globalContextScope, setGlobalContextScope] = React.useState('current'); // 'current' | 'all'

  // ü§ñ v1.19.0: Chat interativo do assistente IA (Global)
  const chatAssistantGlobal = useChatAssistant(aiIntegration);

  // üìú v1.24: Versionamento de campos
  const fieldVersioning = useFieldVersioning();

  // ‚öñÔ∏è v1.20.0: Jurisprud√™ncia contextual (usa componente JurisprudenciaModal)
  const [showJurisModal, setShowJurisModal] = React.useState(false);
  const [jurisTopicIndex, setJurisTopicIndex] = React.useState(null);

  // Ref para o container (drag do divisor)
  const containerRef = React.useRef(null);
  const [isDragging, setIsDragging] = React.useState(false);

  const prevIsSplitModeRef = React.useRef(isSplitMode);
  const isSplitModeRef = React.useRef(isSplitMode);
  // v1.13.8: Ref para auto-save debounced no Editor Global
  const globalAutoSaveTimerRef = React.useRef(null);

  React.useEffect(() => {
    isSplitModeRef.current = isSplitMode;
  }, [isSplitMode]);

  // v1.19.2: Registrar listener para sincronizar sugest√µes quando modelo √© editado
  React.useEffect(() => {
    if (modelPreview && isOpen) {
      modelPreview.onModelUpdatedRef.current = (updatedModel) => {
        setSuggestions(prev => prev.map(s => s.id === updatedModel.id ? updatedModel : s));
        setGlobalManualSearchResults(prev => prev.map(s => s.id === updatedModel.id ? updatedModel : s));
      };
    }
    return () => {
      if (modelPreview) {
        modelPreview.onModelUpdatedRef.current = null;
      }
    };
  }, [modelPreview, isOpen]);

  // Fun√ß√£o de busca manual debounced - v1.12.13: Usa helper reutiliz√°vel
  const debouncedGlobalManualSearch = React.useMemo(() => {
    let timeoutId = null;
    return (term) => {
      if (timeoutId) clearTimeout(timeoutId);
      if (!term.trim()) {
        setGlobalManualSearchResults([]);
        return;
      }
      timeoutId = setTimeout(() => {
        const results = searchModelsInLibrary(models || [], term);
        setGlobalManualSearchResults(results);
      }, 300);
    };
  }, [models]);

  // v1.33.19: useEffect para busca sem√¢ntica na busca manual do editor global
  React.useEffect(() => {
    if (!useGlobalSemanticSearch || !searchModelReady || !searchModelsBySimilarity || !globalManualSearchTerm || globalManualSearchTerm.trim().length < 2) {
      return;
    }

    const timeoutId = setTimeout(async () => {
      setGlobalSemanticSearching(true);
      try {
        const results = await searchModelsBySimilarity(models || [], globalManualSearchTerm.toLowerCase(), { threshold: 0.3, limit: 10 });
        setGlobalManualSearchResults(results);
      } catch (error) {
        console.error('[GlobalEditor] Erro na busca sem√¢ntica:', error);
      }
      setGlobalSemanticSearching(false);
    }, 300);

    return () => clearTimeout(timeoutId);
  }, [useGlobalSemanticSearch, globalManualSearchTerm, searchModelReady, searchModelsBySimilarity, models]);

  // Inicializar localTopics quando abrir
  React.useEffect(() => {
    // S√≥ inicializar quando ABRIR (transi√ß√£o false -> true)
    // Isso evita reset quando Ctrl+S atualiza selectedTopics
    const isOpening = isOpen && !wasOpenRef.current;

    if (isOpening && selectedTopics.length > 0) {
      const copy = structuredClone(selectedTopics);
      setLocalTopics(copy);
      setOriginalTopics(structuredClone(copy));
      setIsDirty(false);
      setCurrentFocusedTopic(null);
      setSuggestions([]);
      setIsSplitMode(true);
      // v1.13: Limpar rastreamento de edi√ß√µes ao abrir
      setEditedTopicTitles(new Set());
      // Iniciar todas se√ß√µes colapsadas
      const initialCollapsed = {};
      copy.forEach((_, idx) => { initialCollapsed[idx] = true; });
      setCollapsedSections(initialCollapsed);
    }

    wasOpenRef.current = isOpen;
  }, [isOpen, selectedTopics]);

  // Handler para mudan√ßa de campo
  const handleFieldChange = React.useCallback((topicIndex, field, html) => {
    setLocalTopics(prev => {
      const updated = [...prev];
      const topicTitle = updated[topicIndex]?.title;
      updated[topicIndex] = {
        ...updated[topicIndex],
        [field]: html
      };
      // Se for editedRelatorio, tamb√©m atualizar relatorio
      if (field === 'editedRelatorio') {
        updated[topicIndex].relatorio = html;
      }
      // v1.13: Rastrear edi√ß√µes no campo decisao para detec√ß√£o autom√°tica de resultado
      if (field === 'editedFundamentacao' && topicTitle) {
        setEditedTopicTitles(prevSet => new Set(prevSet).add(topicTitle));
      }
      return updated;
    });
    setIsDirty(true);
  }, []);

  // Handler para foco em campo (sugest√µes contextuais) - v1.12.2: usa ref para evitar closure stale
  const handleFieldFocus = React.useCallback(async (topicIndex, fieldType, topic) => {
    if (fieldType === 'fundamentacao' && topic) {
      // Campo de fundamenta√ß√£o/decis√£o focado ‚Üí buscar sugest√µes automaticamente
      const topicInfo = {
        index: topicIndex,
        title: topic.title,
        category: topic.category,
        relatorio: topic.editedRelatorio || topic.relatorio || ''
      };
      setCurrentFocusedTopic(topicInfo);

      // Buscar sugest√µes automaticamente (apenas se em split mode) - usa ref para valor atual
      if (isSplitModeRef.current && findSuggestions) {
        setLoadingSuggestions(true);
        try {
          await new Promise(r => setTimeout(r, 0)); // v1.28.06: Yield para UI
          const results = await findSuggestions({
            title: topicInfo.title,
            category: topicInfo.category,
            relatorio: topicInfo.relatorio
          });
          // v1.28.06: Suporta novo formato { suggestions, source }
          if (results?.suggestions) {
            setSuggestions(results.suggestions);
            setSuggestionsSource(results.source);
          } else {
            setSuggestions(results || []);
            setSuggestionsSource(null);
          }
        } catch (error) {
          setSuggestionsSource(null);
        } finally {
          setLoadingSuggestions(false);
        }
      }
    } else {
      // Outro campo focado ‚Üí limpar contexto de sugest√µes
      setCurrentFocusedTopic(null);
      setSuggestions([]);
    }
  }, [findSuggestions]); // Removido isSplitMode das deps - agora usa ref

  React.useEffect(() => {
    // Detectar transi√ß√£o de false ‚Üí true
    const wasOff = !prevIsSplitModeRef.current;
    const isNowOn = isSplitMode;
    prevIsSplitModeRef.current = isSplitMode;

    // S√≥ buscar quando split mode ACABOU de ser ativado (n√£o em cada render)
    if (wasOff && isNowOn && currentFocusedTopic && findSuggestions) {
      const fetchSuggestions = async () => {
        setLoadingSuggestions(true);
        try {
          await new Promise(r => setTimeout(r, 0)); // v1.28.06: Yield para UI
          const results = await findSuggestions({
            title: currentFocusedTopic.title,
            category: currentFocusedTopic.category,
            relatorio: currentFocusedTopic.relatorio
          });
          // v1.28.06: Suporta novo formato { suggestions, source }
          if (results?.suggestions) {
            setSuggestions(results.suggestions);
            setSuggestionsSource(results.source);
          } else {
            setSuggestions(results || []);
            setSuggestionsSource(null);
          }
        } catch (error) {
          setSuggestionsSource(null);
        } finally {
          setLoadingSuggestions(false);
        }
      };

      fetchSuggestions();
    }
  }, [isSplitMode, currentFocusedTopic, findSuggestions]); // Agora com todas as depend√™ncias

  // Inserir modelo no campo de fundamenta√ß√£o do t√≥pico focado
  const handleInsertModel = React.useCallback((modelContent) => {
    if (currentFocusedTopic?.index === undefined) return;

    const topicIndex = currentFocusedTopic.index;
    setLocalTopics(prev => {
      const updated = [...prev];
      const currentContent = updated[topicIndex].editedFundamentacao ||
                            updated[topicIndex].fundamentacao || '';

      // Adicionar ao final do conte√∫do existente
      updated[topicIndex].editedFundamentacao = currentContent +
        (currentContent ? '<p><br></p>' : '') + modelContent;

      return updated;
    });

    setIsDirty(true);
    showToast?.('Modelo inserido', 'success');
  }, [currentFocusedTopic, showToast]);

  // v1.33.23: Ref para handleInsertModel (evita loop infinito no useEffect abaixo)
  const handleInsertModelRef = React.useRef(handleInsertModel);
  React.useEffect(() => {
    handleInsertModelRef.current = handleInsertModel;
  }, [handleInsertModel]);

  const handlePreviewModel = React.useCallback((model) => {
    if (modelPreview?.openPreview) {
      modelPreview.openPreview(model);
    }
  }, [modelPreview]);

  // v1.15.2: Registrar fun√ß√£o de inser√ß√£o contextual quando modal abre
  // v1.33.23: Usa ref para evitar loop (handleInsertModel muda frequentemente)
  React.useEffect(() => {
    if (isOpen && modelPreview?.setContextualInsertFn) {
      // Wrapper com identidade est√°vel que chama a ref
      modelPreview.setContextualInsertFn((content) => handleInsertModelRef.current(content));
    }
    return () => {
      if (modelPreview?.setContextualInsertFn) {
        modelPreview.setContextualInsertFn(null);
      }
    };
  }, [isOpen, modelPreview]); // Removido handleInsertModel das depend√™ncias

  // Salvar altera√ß√µes (sem fechar) - usa isSavingRef para preservar sugest√µes
  const handleSaveOnly = React.useCallback(() => {
    // Marcar que estamos salvando (para useEffect ignorar reset)
    isSavingRef.current = true;

    // Sincronizar estados externos
    setSelectedTopics(localTopics);
    setExtractedTopics(prev =>
      prev.map(et => {
        const updated = localTopics.find(lt => lt.title === et.title);
        return updated ? { ...et, ...updated } : et;
      })
    );

    setIsDirty(false);
    showToast?.('Altera√ß√µes salvas!', 'success');
  }, [localTopics, setSelectedTopics, setExtractedTopics, showToast]);

  // v1.13.8: Auto-save com debounce no Editor Global
  React.useEffect(() => {
    // S√≥ rodar se modal est√° aberto e h√° mudan√ßas
    if (!isOpen || !isDirty) return;

    // Limpar timer anterior
    if (globalAutoSaveTimerRef.current) {
      clearTimeout(globalAutoSaveTimerRef.current);
    }

    // Debounce: aguardar 3s antes de salvar automaticamente
    globalAutoSaveTimerRef.current = setTimeout(() => {
      // Marcar que estamos salvando (para useEffect ignorar reset)
      isSavingRef.current = true;

      // Sincronizar estados externos
      setSelectedTopics(localTopics);
      setExtractedTopics(prev =>
        prev.map(et => {
          const updated = localTopics.find(lt => lt.title === et.title);
          return updated ? { ...et, ...updated } : et;
        })
      );

      setIsDirty(false);
      // N√£o mostrar toast no auto-save (apenas o indicador verde j√° √© suficiente)
    }, AUTO_SAVE_DEBOUNCE_MS);

    return () => {
      if (globalAutoSaveTimerRef.current) {
        clearTimeout(globalAutoSaveTimerRef.current);
      }
    };
  }, [isOpen, isDirty, localTopics, setSelectedTopics, setExtractedTopics]);

  // Salvar e fechar - sincroniza estados externos e fecha
  // v1.13: Agora tamb√©m detecta automaticamente o resultado para t√≥picos editados
  const handleSaveAndClose = React.useCallback(async () => {
    // v1.13: Identificar t√≥picos que precisam de an√°lise de resultado:
    // - Foram editados (campo decisao)
    // - N√£o t√™m resultadoManual (usu√°rio n√£o escolheu manualmente)
    // - N√£o s√£o RELAT√ìRIO ou DISPOSITIVO
    const topicsToAnalyze = detectResultadoAutomatico ? localTopics.filter(t =>
      editedTopicTitles.has(t.title) &&
      !t.resultadoManual &&
      t.category !== 'RELAT√ìRIO' &&
      t.category !== 'DISPOSITIVO' &&
      t.title.toUpperCase() !== 'RELAT√ìRIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO'
    ) : [];

    let updatedTopics = [...localTopics];

    if (topicsToAnalyze.length > 0) {
      // Mostrar modal de progresso
      setIsAnalyzingResults(true);
      setAnalyzingProgress({ current: 0, total: topicsToAnalyze.length });

      // v1.33.11: Usar valor configur√°vel de requisi√ß√µes paralelas
      const BATCH_SIZE = aiIntegration?.aiSettings?.parallelRequests || 5;

      for (let i = 0; i < topicsToAnalyze.length; i += BATCH_SIZE) {
        const batch = topicsToAnalyze.slice(i, i + BATCH_SIZE);

        const promises = batch.map(async (topic) => {
          const resultado = await detectResultadoAutomatico(
            topic.title,
            topic.editedFundamentacao || topic.fundamentacao,
            topic.category
          );
          return { title: topic.title, resultado };
        });

        const results = await Promise.allSettled(promises);

        // Atualizar t√≥picos com resultados detectados
        let rejectedCount = 0;
        results.forEach(r => {
          if (r.status === 'fulfilled' && r.value.resultado) {
            const idx = updatedTopics.findIndex(t => t.title === r.value.title);
            if (idx !== -1) {
              updatedTopics[idx] = { ...updatedTopics[idx], resultado: r.value.resultado };
            }
          } else if (r.status === 'rejected') {
            rejectedCount++;
          }
        });
        if (rejectedCount > 0) {
          console.warn(`[SentencifyAI] ${rejectedCount} t√≥pico(s) falharam na detec√ß√£o autom√°tica de resultado`);
        }

        setAnalyzingProgress({ current: Math.min(i + BATCH_SIZE, topicsToAnalyze.length), total: topicsToAnalyze.length });

        // Delay entre batches para evitar rate limit (exceto √∫ltimo)
        if (i + BATCH_SIZE < topicsToAnalyze.length) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }

      setIsAnalyzingResults(false);
    }

    // Aplicar altera√ß√µes aos t√≥picos selecionados
    setSelectedTopics(updatedTopics);

    // Sincronizar com extractedTopics
    setExtractedTopics(prev =>
      prev.map(et => {
        const updated = updatedTopics.find(lt => lt.title === et.title);
        return updated ? { ...et, ...updated } : et;
      })
    );

    showToast?.('Altera√ß√µes salvas com sucesso!', 'success');
    setEditedTopicTitles(new Set()); // Limpar rastreamento
    onClose();
  }, [localTopics, editedTopicTitles, setSelectedTopics, setExtractedTopics, showToast, onClose, detectResultadoAutomatico]);

  // Cancelar
  const handleCancel = React.useCallback(() => {
    if (isDirty) {
      setShowCancelConfirm(true);
      return;
    }
    onClose();
  }, [isDirty, onClose]);

  // Confirmar cancelamento
  const confirmCancel = React.useCallback(() => {
    setShowCancelConfirm(false);
    onClose();
  }, [onClose]);

  const handleOpenAIAssistant = React.useCallback((topicIndex) => {
    setAiAssistantTopicIndex(topicIndex);
    setShowAIAssistant(true);
  }, []);

  // v1.12.14: Handler para abrir modal de provas vinculadas
  const handleOpenProofsModal = React.useCallback((topicIndex) => {
    setProofsModalTopicIndex(topicIndex);
    setShowProofsModal(true);
  }, []);

  // v1.12.14: Helper para calcular provas vinculadas a um t√≥pico
  const getLinkedProofsForTopic = React.useCallback((topicTitle) => {
    if (!proofManager) return [];
    const linkedProofIds = Object.keys(proofManager.proofTopicLinks || {}).filter(proofId =>
      proofManager.proofTopicLinks[proofId]?.includes(topicTitle)
    );
    return [
      ...(proofManager.proofFiles || []).filter(p => linkedProofIds.includes(String(p.id))).map(p => ({ ...p, isPdf: true })),
      ...(proofManager.proofTexts || []).filter(p => linkedProofIds.includes(String(p.id))).map(p => ({ ...p, isPdf: false }))
    ];
  }, [proofManager]);

  const generateGlobalAiText = React.useCallback(async () => {
    if (!globalAiInstruction.trim() || !aiIntegration) return;

    setGeneratingGlobalAi(true);
    setGlobalAiGeneratedText('');

    try {
      const topic = localTopics[aiAssistantTopicIndex];
      if (!topic) throw new Error('T√≥pico n√£o encontrado');

      // Preparar documentos usando helper
      const { contentArray, flags } = prepareDocumentsContext(analyzedDocuments);
      const { hasPeticao, hasContestacoes, hasComplementares } = flags;

      // üÜï v1.19.5: Usar fun√ß√£o centralizada para provas
      // v1.19.2: Passar flag de anonimiza√ß√£o
      // v1.21.5: Passar anonConfig para anonimizar texto
      const { proofDocuments, proofsContext, hasProofs } = await prepareProofsContext(
        proofManager, topic.title, fileToBase64, aiIntegration?.aiSettings?.anonymization?.enabled, aiIntegration?.aiSettings?.anonymization
      );
      contentArray.push(...proofDocuments);

      // Preparar contexto baseado no escopo selecionado
      let decisionContext = '';

      if (globalContextScope === 'current') {
        // Apenas o t√≥pico atual
        decisionContext = `
üìã CONTEXTO DO T√ìPICO:
T√≠tulo: ${topic.title}
Categoria: ${topic.category || 'N√£o especificada'}

üìù MINI-RELAT√ìRIO DO T√ìPICO:
${topic.editedRelatorio || topic.relatorio || 'N√£o dispon√≠vel'}

‚úçÔ∏è DECIS√ÉO J√Å ESCRITA:
${topic.editedFundamentacao || topic.fundamentacao || 'Ainda n√£o foi escrito nada'}
`;
      } else {
        // Toda a decis√£o (todos os t√≥picos)
        decisionContext = 'üìã CONTEXTO COMPLETO DA DECIS√ÉO:\n\n';

        localTopics.forEach((t, index) => {
          const titleUpper = t.title.toUpperCase();
          if (titleUpper === 'RELAT√ìRIO') {
            decisionContext += `üìÑ RELAT√ìRIO GERAL:\n${t.editedRelatorio || t.relatorio || 'N√£o dispon√≠vel'}\n\n---\n\n`;
          } else if (titleUpper === 'DISPOSITIVO') {
            decisionContext += `‚öñÔ∏è DISPOSITIVO:\n${t.editedContent || ''}\n\n---\n\n`;
          } else {
            decisionContext += `üìã T√ìPICO ${index}: ${t.title} (${t.category || 'Sem categoria'})
Mini-relat√≥rio: ${t.editedRelatorio || t.relatorio || 'N√£o dispon√≠vel'}
Decis√£o: ${t.editedFundamentacao || t.fundamentacao || 'N√£o escrita'}

---

`;
          }
        });

        decisionContext += `\nüéØ T√ìPICO SENDO EDITADO: ${topic.title}`;
      }

      // 8. Adicionar instru√ß√£o final (mesmo prompt do assistente individual)
      contentArray.push({
        type: 'text',
        text: `Voc√™ est√° auxiliando na reda√ß√£o de uma DECIS√ÉO JUDICIAL TRABALHISTA.

${decisionContext}

${hasPeticao || hasContestacoes || hasComplementares || hasProofs ? `
üìö DOCUMENTOS DISPON√çVEIS PARA CONSULTA:
${hasPeticao ? '‚úì Peti√ß√£o inicial' : ''}
${hasContestacoes ? '‚úì Contesta√ß√£o(√µes)' : ''}
${hasComplementares ? '‚úì Documento(s) complementar(es)' : ''}
${hasProofs ? '‚úì Prova(s) vinculada(s) a este t√≥pico' : ''}

Os documentos foram anexados acima. Voc√™ pode e DEVE consult√°-los para fundamentar sua decis√£o, especialmente:
- Para identificar alega√ß√µes e argumentos das partes
- Para verificar provas mencionadas
- Para fundamentar sua decis√£o com base no que foi apresentado nos autos
${hasProofs ? '- Para analisar as provas vinculadas e suas respectivas an√°lises/conclus√µes' : ''}
` : ''}
${proofsContext}
üéØ INSTRU√á√ÉO DO USU√ÅRIO:
${globalAiInstruction}

‚ö†Ô∏è IMPORTANTE - N√ÉO INCLUIR MINI-RELAT√ìRIO:
- O mini-relat√≥rio j√° foi fornecido acima apenas como CONTEXTO
- N√ÉO repita ou resuma os fatos no texto gerado
- N√ÉO inicie com "Trata-se de...", "Cuida-se de...", "O reclamante postula..."
- V√° DIRETO para a an√°lise jur√≠dica, fundamenta√ß√£o e conclus√£o

${AI_PROMPTS.estiloRedacao}

Com base em TODOS os elementos acima (contexto do t√≥pico, documentos processuais e instru√ß√£o do usu√°rio), gere o texto solicitado.

O texto deve:
- Ser adequado para uma decis√£o judicial trabalhista
- Usar SEMPRE a primeira pessoa
- Manter linguagem formal, mas acess√≠vel
- Evitar latinismos desnecess√°rios
- Ser claro e objetivo
- Considerar o contexto do t√≥pico e o que j√° foi escrito
- FUNDAMENTAR-SE nos documentos processuais (peti√ß√£o, contesta√ß√µes, provas)
- Citar fatos espec√≠ficos dos autos quando relevante
- Aplicar bases legais quando apropriado

${AI_PROMPTS.formatacaoHTML("A <strong>CLT</strong> estabelece que...")}

${AI_PROMPTS.formatacaoParagrafos("<p>Passo a analisar...</p><p>A CLT estabelece...</p>")}

${AI_PROMPTS.numeracaoReclamadas}

Responda APENAS com o texto gerado em HTML, sem pref√°cio, sem explica√ß√µes. Gere texto pronto para ser inserido na decis√£o.`
      });

      // Chamar API
      // v1.21.26: Parametros para assistente interativo (criativo moderado)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 4000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.5,
        topP: 0.9,
        topK: 80
      });

      setGlobalAiGeneratedText(textContent.trim());
    } catch (err) {
      showToast?.('Erro ao gerar texto: ' + err.message, 'error');
    } finally {
      setGeneratingGlobalAi(false);
    }
  }, [globalAiInstruction, aiIntegration, aiAssistantTopicIndex, localTopics, analyzedDocuments, proofManager, globalContextScope, showToast]);

  const insertGlobalAiText = React.useCallback((mode) => {
    if (!globalAiGeneratedText || aiAssistantTopicIndex === null) return;

    setLocalTopics(prev => {
      const updated = [...prev];
      const currentContent = updated[aiAssistantTopicIndex].editedFundamentacao ||
                            updated[aiAssistantTopicIndex].fundamentacao || '';
      const normalizedAiText = normalizeHTMLSpacing(globalAiGeneratedText);

      let newContent;
      switch (mode) {
        case 'replace':
          newContent = sanitizeHTML(normalizedAiText);
          break;
        case 'append':
          newContent = sanitizeHTML(currentContent + '<p><br></p>' + normalizedAiText);
          break;
        case 'prepend':
          newContent = sanitizeHTML(normalizedAiText + '<p><br></p>' + currentContent);
          break;
        default:
          newContent = currentContent;
      }

      updated[aiAssistantTopicIndex].editedFundamentacao = newContent;
      return updated;
    });

    setIsDirty(true);
    setShowAIAssistant(false);
    setAiAssistantTopicIndex(null);
    setGlobalAiInstruction('');
    setGlobalAiGeneratedText('');
    showToast?.('Texto inserido com sucesso!', 'success');
  }, [globalAiGeneratedText, aiAssistantTopicIndex, sanitizeHTML, showToast]);

  // ü§ñ v1.19.0: Constr√≥i contexto completo para chat do assistente IA (Global)
  // üÜï v1.19.5: Agora ass√≠ncrono para suportar PDFs bin√°rios
  // v1.21.1: Aceita options para filtrar provas
  const buildContextForChatGlobal = React.useCallback(async (userMessage, options = {}) => {
    const topic = localTopics[aiAssistantTopicIndex];
    if (!topic) return [];
    const { proofFilter } = options;

    // Preparar documentos usando helper
    const { contentArray, flags } = prepareDocumentsContext(analyzedDocuments);
    const { hasPeticao, hasContestacoes, hasComplementares } = flags;

    // üÜï v1.21.1: Usar fun√ß√£o de provas orais se filtro ativo
    // v1.19.2: Passar flag de anonimiza√ß√£o
    // v1.21.5: Passar anonConfig para anonimizar texto
    const prepareFunction = proofFilter === 'oral' ? prepareOralProofsContext : prepareProofsContext;
    const { proofDocuments, proofsContext, hasProofs } = await prepareFunction(
      proofManager, topic.title, fileToBase64, aiIntegration?.aiSettings?.anonymization?.enabled, aiIntegration?.aiSettings?.anonymization
    );
    contentArray.push(...proofDocuments);

    // Contexto baseado no escopo selecionado
    let decisionContext = '';
    if (globalContextScope === 'current') {
      decisionContext = `
üìã CONTEXTO DO T√ìPICO:
T√≠tulo: ${topic.title}
Categoria: ${topic.category || 'N√£o especificada'}

üìù MINI-RELAT√ìRIO DO T√ìPICO:
${topic.editedRelatorio || topic.relatorio || 'N√£o dispon√≠vel'}

‚úçÔ∏è DECIS√ÉO J√Å ESCRITA:
${topic.editedFundamentacao || topic.fundamentacao || 'Ainda n√£o foi escrito nada'}
`;
    } else {
      decisionContext = 'üìã CONTEXTO COMPLETO DA DECIS√ÉO:\n\n';
      localTopics.forEach((t, index) => {
        const titleUpper = t.title.toUpperCase();
        if (titleUpper === 'RELAT√ìRIO') {
          decisionContext += `üìÑ RELAT√ìRIO GERAL:\n${t.editedRelatorio || t.relatorio || 'N√£o dispon√≠vel'}\n\n---\n\n`;
        } else if (titleUpper === 'DISPOSITIVO') {
          decisionContext += `‚öñÔ∏è DISPOSITIVO:\n${t.editedContent || ''}\n\n---\n\n`;
        } else {
          decisionContext += `üìã T√ìPICO ${index}: ${t.title} (${t.category || 'Sem categoria'})
Mini-relat√≥rio: ${t.editedRelatorio || t.relatorio || 'N√£o dispon√≠vel'}
Decis√£o: ${t.editedFundamentacao || t.fundamentacao || 'N√£o escrita'}

---

`;
        }
      });
      decisionContext += `\nüéØ T√ìPICO SENDO EDITADO: ${topic.title}`;
    }

    // Verificar se anonimiza√ß√£o est√° ativada
    const anonymizationEnabled = aiIntegration?.aiSettings?.anonymization?.enabled;

    // Montar prompt completo
    contentArray.push({
      type: 'text',
      text: `Voc√™ est√° auxiliando na reda√ß√£o de uma DECIS√ÉO JUDICIAL TRABALHISTA.

${decisionContext}

${hasPeticao || hasContestacoes || hasComplementares || hasProofs ? `
üìö DOCUMENTOS DISPON√çVEIS PARA CONSULTA:
${hasPeticao ? '‚úì Peti√ß√£o inicial' : ''}
${hasContestacoes ? '‚úì Contesta√ß√£o(√µes)' : ''}
${hasComplementares ? '‚úì Documento(s) complementar(es)' : ''}
${hasProofs ? '‚úì Prova(s) vinculada(s) a este t√≥pico' : ''}

Os documentos foram anexados acima. Voc√™ pode e DEVE consult√°-los para fundamentar sua decis√£o.
${hasProofs ? '- Analise as provas vinculadas e suas respectivas an√°lises/conclus√µes' : ''}
` : ''}
${proofsContext}

${INSTRUCAO_NAO_PRESUMIR}

${AI_PROMPTS.estiloRedacao}
${AI_PROMPTS.numeracaoReclamadas}
${anonymizationEnabled ? AI_PROMPTS.preservarAnonimizacao : ''}

‚ö†Ô∏è N√ÉO INCLUIR MINI-RELAT√ìRIO no texto gerado.

üéØ INSTRU√á√ÉO DO USU√ÅRIO:
${userMessage}

Quando faltar informa√ß√£o expressa necess√°ria √† reda√ß√£o, PERGUNTE ao usu√°rio antes de redigir. Prefira perguntar a presumir.

‚ö†Ô∏è ANTES DE REDIGIR QUALQUER TEXTO DE DECIS√ÉO:
Liste as informa√ß√µes/conclus√µes que voc√™ precisa confirmar com o usu√°rio.
S√≥ prossiga com a reda√ß√£o AP√ìS receber as respostas.
Se n√£o houver nada a confirmar, indique "Nenhuma informa√ß√£o pendente" e prossiga.

Quando gerar texto para a decis√£o, responda em HTML.
${AI_PROMPTS.formatacaoHTML("A <strong>CLT</strong> estabelece...")}
${AI_PROMPTS.formatacaoParagrafos("<p>Primeiro par√°grafo.</p><p>Segundo par√°grafo.</p>")}`
    });

    return contentArray;
  }, [localTopics, aiAssistantTopicIndex, analyzedDocuments, proofManager, globalContextScope, aiIntegration?.aiSettings?.anonymization?.enabled]);

  // ü§ñ v1.19.0: Handler para inserir resposta do chat no editor global
  const handleInsertGlobalChatResponse = React.useCallback((mode) => {
    const response = chatAssistantGlobal.lastResponse;
    if (!response || aiAssistantTopicIndex === null) return;

    setLocalTopics(prev => {
      const updated = [...prev];
      const currentContent = updated[aiAssistantTopicIndex].editedFundamentacao ||
                            updated[aiAssistantTopicIndex].fundamentacao || '';
      const normalizedAiText = normalizeHTMLSpacing(response);

      let newContent;
      switch (mode) {
        case 'replace':
          newContent = sanitizeHTML(normalizedAiText);
          break;
        case 'append':
          newContent = sanitizeHTML(currentContent + '<p><br></p>' + normalizedAiText);
          break;
        case 'prepend':
          newContent = sanitizeHTML(normalizedAiText + '<p><br></p>' + currentContent);
          break;
        default:
          newContent = sanitizeHTML(normalizedAiText);
      }

      updated[aiAssistantTopicIndex].editedFundamentacao = newContent;
      return updated;
    });

    setIsDirty(true);
  }, [chatAssistantGlobal.lastResponse, aiAssistantTopicIndex, sanitizeHTML]);

  // ü§ñ v1.19.0: Handler para enviar mensagem no chat global
  // v1.21.1: Aceita options (ex: { proofFilter: 'oral' }) para filtrar provas
  // v1.21.6: Verifica provas vinculadas + anonimiza√ß√£o ‚Üí abre modal de nomes
  const handleSendGlobalChatMessage = React.useCallback(async (message, options = {}) => {
    // v1.21.13: Removido modal de anonimiza√ß√£o - provas CONFLITO s√£o filtradas em prepareProofsContext
    const contextBuilderWithOptions = (msg) => buildContextForChatGlobal(msg, options);
    await chatAssistantGlobal.send(message, contextBuilderWithOptions);
  }, [chatAssistantGlobal, buildContextForChatGlobal]);

  // Toggle split mode
  const toggleSplitMode = React.useCallback(() => {
    setIsSplitMode(prev => !prev);
  }, []);

  // Handlers para drag do divisor
  const handleMouseDown = React.useCallback(() => {
    setIsDragging(true);
  }, []);

  const handleMouseMove = React.useCallback((e) => {
    if (!isDragging || !containerRef.current) return;

    const rect = containerRef.current.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const percentage = (x / rect.width) * 100;
    const clampedPercentage = Math.max(30, Math.min(80, percentage));
    setSplitPosition(clampedPercentage);
  }, [isDragging]);

  const handleMouseUp = React.useCallback(() => {
    setIsDragging(false);
  }, []);

  // Mouse up global para drag
  React.useEffect(() => {
    if (isDragging) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('mouseup', handleMouseUp);
      return () => {
        window.removeEventListener('mousemove', handleMouseMove);
        window.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [isDragging, handleMouseMove, handleMouseUp]);

  // Atalhos de teclado
  React.useEffect(() => {
    if (!isOpen) return;

    const handleKeyDown = (e) => {
      // Ctrl+S: Salvar (sem fechar)
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        if (isDirty) handleSaveOnly();
      }

      // Ctrl+M: Toggle split mode
      if (e.ctrlKey && e.key === 'm') {
        e.preventDefault();
        toggleSplitMode();
      }

      // ESC: Fechar (com confirma√ß√£o se dirty)
      if (e.key === 'Escape') {
        if (showCancelConfirm) return;
        handleCancel();
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, isDirty, handleSaveOnly, toggleSplitMode, handleCancel, showCancelConfirm]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[70] flex flex-col theme-bg-app overflow-visible">
      {/* v1.13: Modal de progresso da an√°lise de resultados */}
      {isAnalyzingResults && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50">
          <div className="theme-bg-primary rounded-xl p-6 shadow-xl border theme-border max-w-sm">
            <div className="flex items-center gap-3">
              <Loader2 className="w-6 h-6 animate-spin text-blue-500" />
              <div>
                <p className="font-medium theme-text">Analisando resultados...</p>
                <p className="text-sm theme-text-muted">
                  T√≥pico {analyzingProgress.current} de {analyzingProgress.total}
                </p>
              </div>
            </div>
          </div>
        </div>
      )}
      {/* v1.32.00: Overlay removido - IA roda em worker */}
      {/* Header */}
      <div className="flex items-center justify-between px-6 py-3 border-b theme-border-secondary theme-bg-secondary flex-shrink-0">
        <div className="flex items-center gap-4">
          <h2 className="text-lg font-bold theme-text-primary flex items-center gap-2">
            <Edit className="w-5 h-5 text-cyan-400" />
            Edi√ß√£o Global
          </h2>
          <span className="text-xs theme-text-muted">
            {localTopics.length} t√≥pico{localTopics.length !== 1 ? 's' : ''}
          </span>
          {currentFocusedTopic && (
            <span className="px-3 py-1 text-xs rounded-full theme-bg-purple-accent theme-text-purple border border-purple-500/30">
              Editando: {currentFocusedTopic.title}
              {currentFocusedTopic.category && ` (${currentFocusedTopic.category})`}
            </span>
          )}
          {isDirty && (
            <span className="px-2 py-1 text-xs rounded bg-amber-500/20 text-amber-400 border border-amber-500/30">
              N√£o salvo
            </span>
          )}
        </div>

        <div className="flex items-center gap-2">
          {/* v1.12.2: Bot√£o Modelos padronizado igual ao fullscreen */}
          <button
            onClick={toggleSplitMode}
            className={`px-3 py-1.5 text-white text-xs rounded flex items-center gap-1.5 transition-all ${
              isSplitMode
                ? 'bg-amber-700 ring-2 ring-amber-400'
                : 'bg-amber-600 hover-amber-700'
            }`}
            title={isSplitMode ? 'Fechar Modelos (Ctrl+M)' : 'üìö Abrir Biblioteca de Modelos (Ctrl+M)'}
          >
            <BookOpen className="w-3.5 h-3.5" />
            {isSplitMode ? 'Fechar Modelos' : 'üìö Modelos'}
          </button>

          {/* v1.12.2: Seletores de espa√ßamento e tamanho de fonte (configura√ß√£o global) */}
          {setSpacing && <SpacingDropdown value={spacing} onChange={setSpacing} />}
          {setFontSize && <FontSizeDropdown value={fontSize} onChange={setFontSize} />}

          <button
            onClick={handleCancel}
            className="px-3 py-1.5 text-xs rounded flex items-center gap-1.5 theme-bg-tertiary theme-text-secondary hover-slate-600"
            title="ESC"
          >
            <X className="w-4 h-4" />
            Cancelar
          </button>

          <button
            onClick={handleSaveOnly}
            className="px-4 py-1.5 text-xs rounded flex items-center gap-1.5 bg-blue-600 text-white hover-blue-500"
            title="Ctrl+S"
          >
            <Save className="w-4 h-4" />
            Salvar
          </button>

          <button
            onClick={handleSaveAndClose}
            className="px-4 py-1.5 text-xs rounded flex items-center gap-1.5 bg-green-600 text-white hover-green-700-from-600"
          >
            <Save className="w-4 h-4" />
            Salvar e Sair
          </button>
        </div>
      </div>

      {/* Main Content Area */}
      <div
        ref={containerRef}
        className="flex flex-1 min-h-0 overflow-hidden"
      >
        {/* Editor Pane - Lista de t√≥picos com editores separados */}
        <div
          className="flex flex-col min-h-0 overflow-hidden"
          style={{ width: isSplitMode ? `${splitPosition}%` : '100%' }}
        >
          <div className={`flex-1 overflow-y-auto p-6 fontsize-${fontSize} spacing-${spacing}`}>
            {localTopics.length > 0 ? (
              localTopics.map((topic, index) => (
                <GlobalEditorSection
                  key={`${topic.title}-${index}`}
                  topic={topic}
                  topicIndex={index}
                  onFieldChange={handleFieldChange}
                  onFieldFocus={handleFieldFocus}
                  onSlashCommand={onSlashCommand}
                  quillReady={quillReady}
                  quillError={quillError}
                  editorTheme={editorTheme}
                  onOpenAIAssistant={handleOpenAIAssistant}
                  onOpenProofsModal={handleOpenProofsModal}
                  onOpenJurisModal={(idx) => {
                    setJurisTopicIndex(idx);
                    setShowJurisModal(true);
                  }}
                  linkedProofsCount={getLinkedProofsForTopic(topic.title).length}
                  isCollapsed={collapsedSections[index] ?? false}
                  onToggleCollapse={(idx) => setCollapsedSections(prev => ({ ...prev, [idx]: !prev[idx] }))}
                  versioning={fieldVersioning}
                />
              ))
            ) : (
              <div className="flex items-center justify-center h-full theme-text-muted">
                <div className="text-center">
                  <div className="w-8 h-8 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                  <span>Carregando t√≥picos...</span>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Split Divider */}
        {isSplitMode && (
          <div
            className="w-1 cursor-col-resize flex-shrink-0 theme-bg-tertiary hover:bg-purple-500 transition-colors"
            onMouseDown={handleMouseDown}
          />
        )}

        {/* Model Suggestions Pane */}
        {isSplitMode && (
          <div
            className="flex flex-col min-h-0 overflow-hidden theme-bg-secondary"
            style={{ width: `${100 - splitPosition}%` }}
          >
            {/* Panel Header - v1.12.1: Sugest√µes autom√°ticas */}
            <div className="p-4 border-b theme-border-secondary flex-shrink-0">
              <h3 className="text-sm font-semibold theme-text-primary mb-2 flex items-center gap-2">Sugest√µes de Modelos{suggestionsSource === 'local' && <span className="bg-purple-600 text-white px-1.5 py-0.5 rounded text-[10px]">ü§ñ IA Local</span>}</h3>

              {currentFocusedTopic ? (
                <p className="text-xs theme-text-muted flex items-center gap-1.5">
                  {loadingSuggestions && (
                    <span className="w-3 h-3 border border-purple-500 border-t-transparent rounded-full animate-spin inline-block"></span>
                  )}
                  <span>
                    {loadingSuggestions ? 'Buscando para:' : 'Sugest√µes para:'}{' '}
                    <strong>{currentFocusedTopic.title}</strong>
                    {currentFocusedTopic.category && ` (${currentFocusedTopic.category})`}
                  </span>
                </p>
              ) : (
                <p className="text-xs theme-text-muted italic">
                  Clique em um campo de "Decis√£o" para ver sugest√µes de modelos
                </p>
              )}
            </div>

            {/* Campo de Busca Manual - v1.12.12 */}
            <div className="px-4 pt-3 pb-2 border-b theme-border-secondary flex-shrink-0">
              <div className="flex gap-2">
                <div className="relative flex-1">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 theme-text-muted" />
                  <input
                    type="text"
                    value={globalManualSearchTerm}
                    onChange={(e) => {
                      setGlobalManualSearchTerm(e.target.value);
                      // v1.33.19: S√≥ faz busca textual se n√£o estiver em modo sem√¢ntico
                      if (!useGlobalSemanticSearch) {
                        debouncedGlobalManualSearch(e.target.value);
                      }
                    }}
                    placeholder={useGlobalSemanticSearch ? "Busca por significado..." : "Buscar modelos..."}
                    className="w-full pl-9 pr-3 py-2 text-sm rounded theme-bg-primary border theme-border-input theme-text-primary"
                  />
                </div>
                {globalManualSearchTerm && (
                  <button
                    onClick={() => {
                      setGlobalManualSearchTerm('');
                      setGlobalManualSearchResults([]);
                    }}
                    className="px-3 py-2 theme-bg-tertiary rounded hover-slate-600 text-sm theme-text-secondary"
                    title="Limpar busca"
                  >
                    ‚úï
                  </button>
                )}
                {/* v1.33.19: Toggle busca sem√¢ntica/textual */}
                {searchModelReady && (
                  <button
                    onClick={() => {
                      setUseGlobalSemanticSearch(prev => !prev);
                      // Limpar resultados ao alternar modo
                      setGlobalManualSearchResults([]);
                    }}
                    className={`px-2 py-1 rounded text-sm transition-colors ${
                      useGlobalSemanticSearch
                        ? 'bg-purple-600 text-white hover:bg-purple-700'
                        : 'theme-bg-tertiary theme-text-secondary hover:bg-slate-600'
                    }`}
                    title={useGlobalSemanticSearch ? 'Busca sem√¢ntica (por significado)' : 'Busca textual (por palavras)'}
                  >
                    {useGlobalSemanticSearch ? 'üß†' : 'üî§'}
                  </button>
                )}
              </div>
              {globalSemanticSearching && (
                <p className="text-xs text-purple-400 mt-2 flex items-center gap-1">
                  <span className="animate-spin inline-block w-3 h-3 border border-purple-400 border-t-transparent rounded-full"></span>
                  Buscando por significado...
                </p>
              )}
              {!globalSemanticSearching && globalManualSearchTerm && globalManualSearchResults.length > 0 && (
                <p className="text-xs theme-text-muted mt-2">
                  {globalManualSearchResults.length} modelo(s) encontrado(s)
                  {useGlobalSemanticSearch && <span className="ml-1 text-purple-400">(sem√¢ntica)</span>}
                </p>
              )}
              {!globalSemanticSearching && globalManualSearchTerm && globalManualSearchResults.length === 0 && (
                <p className="text-xs text-amber-400 mt-2">
                  Nenhum modelo encontrado para "{globalManualSearchTerm}"
                </p>
              )}
            </div>

            {/* Suggestions List - v1.12.2: Usando SuggestionCard com bot√µes Visualizar/Inserir */}
            <div className="flex-1 overflow-y-auto p-4 space-y-3">
              {/* v1.12.12: Mostrar resultados da busca manual primeiro, depois sugest√µes autom√°ticas */}
              {globalManualSearchResults.length > 0 ? (
                <>
                  <p className="text-xs theme-text-muted mb-2 font-medium">Resultados da busca:</p>
                  {globalManualSearchResults.map((model, idx) => (
                    <SuggestionCard
                      key={model.id || `search-${idx}`}
                      model={model}
                      similarity={model.similarity}
                      index={idx}
                      totalSuggestions={globalManualSearchResults.length}
                      onPreview={handlePreviewModel}
                      onInsert={(content) => handleInsertModel(content)}
                      sanitizeHTML={sanitizeHTML}
                      showRanking={false}
                    />
                  ))}
                </>
              ) : suggestions.length > 0 ? (
                suggestions.map((model, idx) => (
                  <SuggestionCard
                    key={model.id || idx}
                    model={model}
                    similarity={model.similarity}
                    index={idx}
                    totalSuggestions={suggestions.length}
                    onPreview={handlePreviewModel}
                    onInsert={(content) => handleInsertModel(content)}
                    sanitizeHTML={sanitizeHTML}
                    showRanking={true}
                  />
                ))
              ) : (
                <div className="text-center py-8 theme-text-muted text-sm">
                  {loadingSuggestions ? (
                    <div className="flex flex-col items-center gap-2">
                      <div className="w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                      <span>Buscando sugest√µes...</span>
                    </div>
                  ) : currentFocusedTopic ? (
                    <span>Nenhum modelo encontrado para este t√≥pico</span>
                  ) : globalManualSearchTerm ? (
                    <span>Use a busca acima para encontrar modelos</span>
                  ) : (
                    <span>Clique em um campo de "Decis√£o" para ver sugest√µes</span>
                  )}
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {/* Modal de Confirma√ß√£o - Cancelar */}
      {showCancelConfirm && (
        <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
          <div
            className="absolute inset-0 bg-black/70"
            onClick={() => setShowCancelConfirm(false)}
          />
          <div className="relative theme-bg-primary rounded-lg shadow-xl border theme-border-input max-w-md w-full p-6">
            <h3 className="text-lg font-bold text-amber-400 mb-4 flex items-center gap-2">
              <AlertCircle className="w-5 h-5" />
              Descartar altera√ß√µes?
            </h3>
            <p className="theme-text-secondary mb-6">
              Voc√™ tem altera√ß√µes n√£o salvas. Deseja descart√°-las?
            </p>
            <div className="flex gap-3 justify-end">
              <button
                onClick={() => setShowCancelConfirm(false)}
                className="px-4 py-2 text-sm rounded theme-bg-tertiary theme-text-secondary hover-slate-600"
              >
                Continuar Editando
              </button>
              <button
                onClick={confirmCancel}
                className="px-4 py-2 text-sm rounded bg-red-600 text-white hover-red-700-from-600"
              >
                Descartar
              </button>
            </div>
          </div>
        </div>
      )}

      {/* v1.19.0: Modal Assistente IA Global - Chat Interativo */}
      {showAIAssistant && aiAssistantTopicIndex !== null && (
        <AIAssistantGlobalModal
          isOpen={showAIAssistant}
          onClose={() => {
            setShowAIAssistant(false);
            setAiAssistantTopicIndex(null);
            chatAssistantGlobal.clear();
          }}
          topicTitle={localTopics[aiAssistantTopicIndex]?.title}
          chatHistory={chatAssistantGlobal.history}
          onSendMessage={handleSendGlobalChatMessage}
          onInsertResponse={handleInsertGlobalChatResponse}
          generating={chatAssistantGlobal.generating}
          onClear={chatAssistantGlobal.clear}
          lastResponse={chatAssistantGlobal.lastResponse}
          contextScope={globalContextScope}
          setContextScope={setGlobalContextScope}
          sanitizeHTML={sanitizeHTML}
          quickPrompts={aiIntegration?.aiSettings?.quickPrompts}
          proofManager={proofManager}
        />
      )}

      {/* v1.12.14: Modal de Provas Vinculadas */}
      {showProofsModal && proofsModalTopicIndex !== null && (
        <LinkedProofsModal
          isOpen={showProofsModal}
          onClose={() => {
            setShowProofsModal(false);
            setProofsModalTopicIndex(null);
          }}
          topicTitle={localTopics[proofsModalTopicIndex]?.title}
          linkedProofs={getLinkedProofsForTopic(localTopics[proofsModalTopicIndex]?.title)}
          proofManager={proofManager}
        />
      )}

      {/* v1.20.0: Modal de Jurisprud√™ncia (componente reutiliz√°vel) */}
      {/* v1.32.18: Props para busca sem√¢ntica */}
      {/* v1.33.16: jurisSemanticEnabled para toggle interno */}
      <JurisprudenciaModal
        isOpen={showJurisModal && jurisTopicIndex !== null}
        onClose={() => { setShowJurisModal(false); setJurisTopicIndex(null); }}
        topicTitle={localTopics[jurisTopicIndex]?.title}
        topicRelatorio={localTopics[jurisTopicIndex]?.editedRelatorio || localTopics[jurisTopicIndex]?.relatorio}
        callAI={aiIntegration?.callAI}
        useLocalAI={useLocalAIForJuris && searchModelReady && jurisEmbeddingsCount > 0}
        jurisSemanticThreshold={jurisSemanticThreshold}
        jurisSemanticEnabled={searchModelReady && jurisEmbeddingsCount > 0}
      />
    </div>
  );
});

GlobalEditorModal.displayName = 'GlobalEditorModal';

// Prepara array de documentos para envio √† API de IA
// v1.25: Adicionado cache_control para otimiza√ß√£o de tokens
const prepareDocumentsContext = (docs) => {
  const contentArray = [];

  if (docs.peticao) {
    contentArray.push(docs.peticaoType === 'pdf'
      ? { type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: docs.peticao }, cache_control: docs.peticao.length > 100000 ? { type: "ephemeral" } : undefined }
      : { type: 'text', text: `PETI√á√ÉO INICIAL:\n\n${docs.peticao}`, cache_control: docs.peticao.length > 2000 ? { type: "ephemeral" } : undefined });
  }

  docs.contestacoes?.forEach((base64) => {
    contentArray.push({ type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: base64 }, cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined });
  });

  docs.contestacoesText?.forEach((contestacao, index) => {
    contentArray.push({ type: 'text', text: `CONTESTA√á√ÉO ${index + 1 + (docs.contestacoes?.length || 0)}:\n\n${contestacao.text}`, cache_control: contestacao.text.length > 2000 ? { type: "ephemeral" } : undefined });
  });

  docs.complementares?.forEach((base64) => {
    contentArray.push({ type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: base64 }, cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined });
  });

  docs.complementaresText?.forEach((doc, index) => {
    contentArray.push({ type: 'text', text: `DOCUMENTO COMPLEMENTAR ${index + 1 + (docs.complementares?.length || 0)}:\n\n${doc.text}`, cache_control: doc.text.length > 2000 ? { type: "ephemeral" } : undefined });
  });

  return {
    contentArray,
    flags: {
      hasPeticao: !!docs.peticao,
      hasContestacoes: (docs.contestacoes?.length || 0) + (docs.contestacoesText?.length || 0) > 0,
      hasComplementares: (docs.complementares?.length || 0) + (docs.complementaresText?.length || 0) > 0
    }
  };
};

// üÜï v1.19.5: Prepara contexto de provas vinculadas para envio √† API de IA
// v1.19.2: Adicionado anonymizationEnabled para bloquear PDF bin√°rio
// v1.21.5: Adicionado anonConfig para anonimizar texto extra√≠do ao enviar
const prepareProofsContext = async (proofManager, topicTitle, fileToBase64Fn, anonymizationEnabled = false, anonConfig = null) => {
  if (!proofManager) return { proofDocuments: [], proofsContext: '', hasProofs: false };

  const linkedProofIds = Object.keys(proofManager.proofTopicLinks || {}).filter(proofId =>
    proofManager.proofTopicLinks[proofId]?.includes(topicTitle)
  );

  const linkedProofs = [
    ...(proofManager.proofFiles || []).filter(p => linkedProofIds.includes(String(p.id))),
    ...(proofManager.proofTexts || []).filter(p => linkedProofIds.includes(String(p.id)))
  ];

  // v1.21.13: Filtrar provas CONFLITO quando anonimiza√ß√£o ativa
  // - CONFLITO: proofUsePdfMode=true + anon ativa (usu√°rio quer PDF mas anon exige texto)
  // - Sem texto extra√≠do + anon ativa (imposs√≠vel anonimizar)
  const filteredProofs = linkedProofs.filter(proof => {
    const isPdf = proofManager.proofFiles?.some(p => p.id === proof.id);
    if (anonymizationEnabled && isPdf) {
      // CONFLITO: usu√°rio escolheu "Usar PDF" mas anonimiza√ß√£o est√° ativa
      if (proofManager.proofUsePdfMode?.[proof.id]) {
        return false;
      }
      // Sem texto extra√≠do: imposs√≠vel anonimizar
      if (!proofManager.extractedProofTexts?.[proof.id]) {
        return false;
      }
    }
    return true;
  });

  if (filteredProofs.length === 0) {
    return { proofDocuments: [], proofsContext: '', hasProofs: false };
  }

  const proofDocuments = [];
  let proofsContext = '\n\nüîç PROVAS VINCULADAS A ESTE T√ìPICO:\n\n';

  for (let index = 0; index < filteredProofs.length; index++) {
    const proof = filteredProofs[index];
    const proofId = proof.id;
    const isPdf = proofManager.proofFiles?.some(p => p.id === proof.id);

    proofsContext += `PROVA ${index + 1}: ${proof.name}\n`;

    // An√°lise IA
    if (proofManager.proofAnalysisResults?.[proofId]) {
      const typeLabel = proofManager.proofAnalysisResults[proofId].type === 'livre' ? 'Livre' : 'Contextual';
      proofsContext += `\nAn√°lise ${typeLabel}:\n${proofManager.proofAnalysisResults[proofId].result}\n`;
    }

    // Conclus√µes do juiz
    if (proofManager.proofConclusions?.[proofId]) {
      proofsContext += `\nConclus√µes do Juiz:\n${proofManager.proofConclusions[proofId]}\n`;
    }

    // Conte√∫do completo (se flag ativada) - v1.21.15: Respeita proofUsePdfMode (escolha visual do usu√°rio)
    if (proofManager.proofSendFullContent?.[proofId]) {
      if (isPdf) {
        const usePdfMode = proofManager.proofUsePdfMode?.[proofId];
        const fullText = proofManager.extractedProofTexts?.[proofId];

        if (usePdfMode || !fullText) {
          // Usu√°rio escolheu "Usar PDF" OU n√£o h√° texto extra√≠do ‚Üí enviar PDF bin√°rio
          if (anonymizationEnabled) {
            // Anon ativa: fallback para texto extra√≠do (se existir)
            if (fullText) {
              const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
              const textToSend = anonymizeText(fullText, anonConfig, nomesParaAnonimizar);
              proofsContext += `\nConte√∫do Completo da Prova:\n${textToSend}\n`;
            } else {
              proofsContext += `\n[PDF "${proof.name}" n√£o anexado - anonimiza√ß√£o ativa e texto n√£o extra√≠do]\n`;
            }
          } else if (proof.file && fileToBase64Fn) {
            // Anon desligada: enviar PDF bin√°rio
            // v1.25: Adicionado cache_control para otimiza√ß√£o de tokens
            const base64 = await fileToBase64Fn(proof.file);
            proofDocuments.push({
              type: 'document',
              source: { type: 'base64', media_type: 'application/pdf', data: base64 },
              cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
            });
            proofsContext += `\n[PDF "${proof.name}" anexado como documento]\n`;
          }
        } else {
          // Usu√°rio escolheu "Usar Texto" ‚Üí enviar texto extra√≠do
          const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
          const textToSend = (anonymizationEnabled && anonConfig)
            ? anonymizeText(fullText, anonConfig, nomesParaAnonimizar)
            : fullText;
          proofsContext += `\nConte√∫do Completo da Prova:\n${textToSend}\n`;
        }
      } else if (proof.text) {
        // v1.21.5: Anonimizar texto colado ao enviar
        const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
        const textToSend = (anonymizationEnabled && anonConfig)
          ? anonymizeText(proof.text, anonConfig, nomesParaAnonimizar)
          : proof.text;
        proofsContext += `\nConte√∫do Completo da Prova:\n${textToSend}\n`;
      }
    }

    proofsContext += '\n---\n\n';
  }

  return { proofDocuments, proofsContext, hasProofs: true };
};

// üÜï v1.21.1: Prepara contexto APENAS de provas orais vinculadas (isOralProof definido antes dos componentes)
// v1.21.5: Adicionado anonConfig para anonimizar texto extra√≠do ao enviar
const prepareOralProofsContext = async (proofManager, topicTitle, fileToBase64Fn, anonymizationEnabled = false, anonConfig = null) => {
  if (!proofManager) return { proofDocuments: [], proofsContext: '', hasProofs: false, noOralProofFound: true };

  const linkedProofIds = Object.keys(proofManager.proofTopicLinks || {}).filter(proofId =>
    proofManager.proofTopicLinks[proofId]?.includes(topicTitle)
  );

  const allLinkedProofs = [
    ...(proofManager.proofFiles || []).filter(p => linkedProofIds.includes(String(p.id))),
    ...(proofManager.proofTexts || []).filter(p => linkedProofIds.includes(String(p.id)))
  ];

  // Filtrar apenas provas orais
  const linkedOralProofs = allLinkedProofs.filter(p => isOralProof(p.name));

  // v1.21.13: Filtrar provas CONFLITO quando anonimiza√ß√£o ativa
  const filteredProofs = linkedOralProofs.filter(proof => {
    const isPdf = proofManager.proofFiles?.some(p => p.id === proof.id);
    if (anonymizationEnabled && isPdf) {
      if (proofManager.proofUsePdfMode?.[proof.id]) {
        return false; // CONFLITO: usu√°rio quer PDF mas anon exige texto
      }
      if (!proofManager.extractedProofTexts?.[proof.id]) {
        return false; // Sem texto extra√≠do: imposs√≠vel anonimizar
      }
    }
    return true;
  });

  if (filteredProofs.length === 0) {
    return { proofDocuments: [], proofsContext: '', hasProofs: false, noOralProofFound: true };
  }

  const proofDocuments = [];
  let proofsContext = '\n\nüé§ PROVAS ORAIS VINCULADAS A ESTE T√ìPICO:\n\n';

  for (let index = 0; index < filteredProofs.length; index++) {
    const proof = filteredProofs[index];
    const proofId = proof.id;
    const isPdf = proofManager.proofFiles?.some(p => p.id === proof.id);

    proofsContext += `PROVA ORAL ${index + 1}: ${proof.name}\n`;

    if (proofManager.proofAnalysisResults?.[proofId]) {
      const typeLabel = proofManager.proofAnalysisResults[proofId].type === 'livre' ? 'Livre' : 'Contextual';
      proofsContext += `\nAn√°lise ${typeLabel}:\n${proofManager.proofAnalysisResults[proofId].result}\n`;
    }

    if (proofManager.proofConclusions?.[proofId]) {
      proofsContext += `\nConclus√µes do Juiz:\n${proofManager.proofConclusions[proofId]}\n`;
    }

    // v1.21.15: Respeita proofUsePdfMode (escolha visual do usu√°rio)
    if (proofManager.proofSendFullContent?.[proofId]) {
      if (isPdf) {
        const usePdfMode = proofManager.proofUsePdfMode?.[proofId];
        const fullText = proofManager.extractedProofTexts?.[proofId];

        if (usePdfMode || !fullText) {
          // Usu√°rio escolheu "Usar PDF" OU n√£o h√° texto extra√≠do ‚Üí enviar PDF bin√°rio
          if (anonymizationEnabled) {
            // Anon ativa: fallback para texto extra√≠do (se existir)
            if (fullText) {
              const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
              const textToSend = anonymizeText(fullText, anonConfig, nomesParaAnonimizar);
              proofsContext += `\nConte√∫do Completo da Prova:\n${textToSend}\n`;
            } else {
              proofsContext += `\n[PDF "${proof.name}" n√£o anexado - anonimiza√ß√£o ativa e texto n√£o extra√≠do]\n`;
            }
          } else if (proof.file && fileToBase64Fn) {
            // Anon desligada: enviar PDF bin√°rio
            // v1.25: Adicionado cache_control para otimiza√ß√£o de tokens
            const base64 = await fileToBase64Fn(proof.file);
            proofDocuments.push({
              type: 'document',
              source: { type: 'base64', media_type: 'application/pdf', data: base64 },
              cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
            });
            proofsContext += `\n[PDF "${proof.name}" anexado como documento]\n`;
          }
        } else {
          // Usu√°rio escolheu "Usar Texto" ‚Üí enviar texto extra√≠do
          const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
          const textToSend = (anonymizationEnabled && anonConfig)
            ? anonymizeText(fullText, anonConfig, nomesParaAnonimizar)
            : fullText;
          proofsContext += `\nConte√∫do Completo da Prova:\n${textToSend}\n`;
        }
      } else if (proof.text) {
        // Anonimizar texto colado ao enviar
        const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
        const textToSend = (anonymizationEnabled && anonConfig)
          ? anonymizeText(proof.text, anonConfig, nomesParaAnonimizar)
          : proof.text;
        proofsContext += `\nConte√∫do Completo da Prova:\n${textToSend}\n`;
      }
    }

    proofsContext += '\n---\n\n';
  }

  return { proofDocuments, proofsContext, hasProofs: true, noOralProofFound: false };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úèÔ∏è SE√á√ÉO 6: QUILL EDITOR
// QuillEditorBase, QuillModelEditor, QuillDecisionEditor, QuillMiniRelatorioEditor
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// üîß QUILL.JS UTILITY FUNCTIONS (v1.4.0 - FASE 4)
// Fun√ß√µes utilit√°rias puras para Quill.js - definidas em escopo global

// Retorna configura√ß√£o de toolbar do Quill.js
const getQuillToolbarConfig = (type = 'full') => {
  const configs = {
    // Toolbar completa para editor de decis√£o (28 op√ß√µes)
    full: [
      [{ 'header': [1, 2, 3, 4, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      [{ 'align': [] }],
      [{ 'list': 'ordered'}, { 'list': 'bullet' }],
      [{ 'indent': '-1'}, { 'indent': '+1' }],
      ['blockquote'],
      ['clean']
    ],
    // Toolbar simplificada para editor de modelos (15 op√ß√µes)
    simple: [
      [{ 'header': [1, 2, 3, false] }],
      ['bold', 'italic', 'underline'],
      [{ 'align': [] }],
      [{ 'list': 'ordered'}, { 'list': 'bullet' }],
      ['clean']
    ],
    // Toolbar m√≠nima ou desabilitada para mini-relat√≥rio
    minimal: false
  };

  return configs[type] || configs.full;
};

// Sanitiza HTML gerado pelo Quill.js
const sanitizeQuillHTML = (html) => {
  // Verificar se DOMPurify est√° dispon√≠vel (n√£o depende de estado React)
  if (!window.DOMPurify) {
    return html || '';
  }

  // Se vazio, retornar string vazia
  if (!html || html.trim() === '') {
    return '';
  }

  const cleanHTML = window.DOMPurify.sanitize(html, {
    ALLOWED_TAGS: [
      'p', 'br', 'div', 'span',                // Estrutura
      'strong', 'b', 'em', 'i', 'u', 's',      // Formata√ß√£o
      'ul', 'ol', 'li',                         // Listas
      'h1', 'h2', 'h3', 'h4', 'h5', 'h6',      // Cabe√ßalhos
      'a', 'blockquote',                        // Extras Quill
      'pre', 'code'                             // Code blocks (futuro)
    ],
    ALLOWED_ATTR: [
      'href', 'target', 'rel',                  // Links
      'class',                                  // Classes do Quill (ql-*)
      'style'                                   // Estilos inline
    ],
    ALLOWED_STYLES: {
      '*': {
        'text-align': [/^(left|center|right|justify)$/],  // Alinhamento
        'font-weight': [/^bold$/],
        'font-style': [/^italic$/],
        'text-decoration': [/^(underline|line-through)$/]
      }
    },
    KEEP_CONTENT: true,
    RETURN_TRUSTED_TYPE: false
  });

  return cleanHTML;
};

// üîß HOOK COMPARTILHADO: useQuillEditor (v1.9.12)
// Centraliza l√≥gica comum dos editores Quill (keyboard bindings, refs, topic detection)
const useQuillEditor = (options = {}) => {
  const {
    ref,
    onSaveWithoutClosing,
    enableCtrlS = false,
    topicTitle,
    content,
    enableTopicChangeDetection = false
  } = options;

  const quillInstanceRef = React.useRef(null);
  const lastTopicTitle = React.useRef(null);

  // Keyboard bindings: Ctrl+S para salvar
  const customModules = React.useMemo(() => {
    if (!enableCtrlS) return {};

    return {
      keyboard: {
        bindings: {
          save: {
            key: 'S',
            ctrlKey: true,
            handler: () => {
              if (onSaveWithoutClosing) {
                onSaveWithoutClosing();
              }
              return false; // Prevenir default
            }
          }
        }
      }
    };
  }, [enableCtrlS, onSaveWithoutClosing]);

  // Ref handling: Expor inst√¢ncia Quill via ref
  const handleQuillReady = React.useCallback((quillInstance) => {
    quillInstanceRef.current = quillInstance;

    // Expor inst√¢ncia via ref
    if (ref) {
      if (typeof ref === 'function') {
        ref(quillInstance);
      } else {
        ref.current = quillInstance;
      }
    }
  }, [ref]);

  // Topic change detection: Atualizar conte√∫do quando trocar de t√≥pico
  React.useEffect(() => {
    if (!enableTopicChangeDetection || !quillInstanceRef.current) return;

    // Se mudou de t√≥pico
    if (topicTitle !== lastTopicTitle.current) {
      try {
        const sanitized = sanitizeQuillHTML(content || '');
        quillInstanceRef.current.root.innerHTML = sanitized;
        lastTopicTitle.current = topicTitle;
      } catch (error) {
      }
    }
  }, [enableTopicChangeDetection, topicTitle, content]);

  const refreshQuill = React.useCallback(() => {
    if (quillInstanceRef.current) {
      quillInstanceRef.current.update('silent');
    }
  }, []);

  return {
    quillInstanceRef,
    customModules,
    handleQuillReady,
    refreshQuill
  };
};

const QuillEditorBase = React.forwardRef(({
  content = '',
  onChange,
  onReady,
  onSelectionChange,
  onSlashCommand,
  toolbarConfig = null,
  placeholder = 'Digite aqui...',
  readOnly = false,
  className = '',
  theme = 'snow',
  modules = {},
  quillReady = false,
  quillError = null
}, quillRef) => {
  const containerRef = React.useRef(null);
  const quillInstanceRef = React.useRef(null);
  const isInitializedRef = React.useRef(false);
  const lastContentRef = React.useRef('');
  const copyHandlerRef = React.useRef(null);
  const copyListenerAddedRef = React.useRef(false); // v1.20.2: Guard contra listeners duplicados
  const onSlashCommandRef = React.useRef(onSlashCommand);
  const onChangeDebounceRef = React.useRef(null); // v1.35.3: Debounce para onChange

  // v1.15.4: Manter ref atualizada para slash command
  React.useEffect(() => {
    onSlashCommandRef.current = onSlashCommand;
  }, [onSlashCommand]);

  // Inicializa√ß√£o do Quill (apenas uma vez)
  React.useEffect(() => {
    // Aguardar Quill estar dispon√≠vel
    if (!quillReady || !window.Quill) {
      return;
    }

    // Prevenir re-inicializa√ß√£o
    if (isInitializedRef.current || !containerRef.current) {
      return;
    }

    // v1.30 FIX: Destruir qualquer inst√¢ncia Quill existente no container
    // Necess√°rio porque React.StrictMode (React 18+) causa mount ‚Üí unmount ‚Üí remount
    // O cleanup pode n√£o limpar corretamente se containerRef mudou entre unmount e remount
    const existingQuill = window.Quill?.find?.(containerRef.current);
    if (existingQuill) {
      try {
        existingQuill.off('text-change');
        existingQuill.off('selection-change');
      } catch (e) {}
    }
    // Limpar container COMPLETAMENTE (remove toolbar √≥rf√£)
    containerRef.current.innerHTML = '';

    try {
      // Configura√ß√£o de m√≥dulos Quill
      const quillModules = {
        toolbar: toolbarConfig !== null ? toolbarConfig : false,
        clipboard: {
          matchVisual: false // Melhor paste handling
        },
        ...modules
      };

      // Inicializar Quill
      quillInstanceRef.current = new window.Quill(containerRef.current, {
        theme: theme,
        placeholder: placeholder,
        readOnly: readOnly,
        modules: quillModules
      });

      // Setar conte√∫do inicial
      if (content) {
        const finalContent = sanitizeQuillHTML(content);
        quillInstanceRef.current.root.innerHTML = finalContent;
        lastContentRef.current = finalContent;
      }

      // Event listener - mudan√ßas de texto
      // v1.35.3: Debounce para evitar lag durante digita√ß√£o r√°pida
      quillInstanceRef.current.on('text-change', (delta, oldDelta, source) => {
        // v1.15.4: Detectar "\" para slash command (SEM debounce - precisa ser imediato)
        if (source === 'user' && onSlashCommandRef.current) {
          const ops = delta.ops || [];
          const lastOp = ops[ops.length - 1];
          if (typeof lastOp?.insert === 'string' && lastOp.insert.endsWith('\\')) {
            const quill = quillInstanceRef.current;
            const range = quill.getSelection();
            if (range) {
              const bounds = quill.getBounds(range.index);
              const rect = containerRef.current?.getBoundingClientRect();
              if (rect) {
                onSlashCommandRef.current({
                  position: {
                    top: rect.top + bounds.top + bounds.height + 5,
                    left: rect.left + bounds.left
                  },
                  quillInstance: quill,
                  triggerPosition: range.index - 1
                });
              }
            }
          }
        }

        // v1.35.3: Debounce onChange e sanitiza√ß√£o (150ms)
        // Isso evita re-renders excessivos e DOMPurify a cada keystroke
        if (onChangeDebounceRef.current) {
          clearTimeout(onChangeDebounceRef.current);
        }
        onChangeDebounceRef.current = setTimeout(() => {
          const html = quillInstanceRef.current?.root?.innerHTML;
          if (!html) return;
          const finalHTML = sanitizeQuillHTML(html);

          // Evitar loops de onChange
          if (finalHTML !== lastContentRef.current) {
            lastContentRef.current = finalHTML;
            if (onChange) {
              onChange(finalHTML);
            }
          }
        }, 150);
      });

      // Event listener - mudan√ßa de sele√ß√£o (v1.11.3: para detectar se√ß√£o atual)
      if (onSelectionChange) {
        quillInstanceRef.current.on('selection-change', (range, oldRange, source) => {
          onSelectionChange(range, oldRange, source);
        });
      }

      // Handler de clipboard - converter classes de indenta√ß√£o em estilos inline ao copiar
      copyHandlerRef.current = (e) => {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;

        // Obter HTML selecionado
        const range = selection.getRangeAt(0);
        const container = document.createElement('div');
        container.appendChild(range.cloneContents());

        // Converter classes de indenta√ß√£o em estilos inline
        const indentElements = container.querySelectorAll('[class*="ql-indent-"]');
        indentElements.forEach(el => {
          const classList = Array.from(el.classList);
          const indentClass = classList.find(cls => cls.startsWith('ql-indent-'));
          if (indentClass) {
            const level = parseInt(indentClass.replace('ql-indent-', ''));
            const marginLeft = `${level * 3}em`;
            el.style.marginLeft = marginLeft;
            el.classList.remove(indentClass); // Remover classe
          }
        });

        // Copiar HTML com estilos inline
        e.clipboardData.setData('text/html', container.innerHTML);
        e.clipboardData.setData('text/plain', selection.toString());
        e.preventDefault();
      };
      // v1.20.2: Guard para evitar listeners duplicados
      if (!copyListenerAddedRef.current) {
        quillInstanceRef.current.root.addEventListener('copy', copyHandlerRef.current);
        copyListenerAddedRef.current = true;
      }

      // Expor inst√¢ncia via ref
      if (quillRef) {
        if (typeof quillRef === 'function') {
          quillRef(quillInstanceRef.current);
        } else {
          quillRef.current = quillInstanceRef.current;
        }
      }

      // Callback onReady
      if (onReady) {
        onReady(quillInstanceRef.current);
      }

      isInitializedRef.current = true;

    } catch (error) {
    }

  }, [quillReady]); // Depende apenas de quillReady

  // Atualizar conte√∫do quando props.content mudar externamente
  // (ex: trocar de t√≥pico, carregar novo modelo)
  React.useEffect(() => {
    if (!quillInstanceRef.current) return;

    const currentHTML = quillInstanceRef.current.root.innerHTML;
    const newContent = sanitizeQuillHTML(content || '');

    // Atualizar apenas se o conte√∫do realmente mudou (evitar loops)
    if (newContent !== currentHTML && newContent !== lastContentRef.current) {
      try {
        // Atualizar conte√∫do
        quillInstanceRef.current.root.innerHTML = newContent;
        lastContentRef.current = newContent;

        // A sele√ß√£o ser√° recriada naturalmente quando o usu√°rio interagir
      } catch (error) {
      }
    }
  }, [content]);

  // Atualizar readOnly mode
  React.useEffect(() => {
    if (quillInstanceRef.current) {
      quillInstanceRef.current.enable(!readOnly);
    }
  }, [readOnly]);

  // Cleanup - v1.9.27: Destruir Quill ao desmontar componente
  React.useEffect(() => {
    return () => {
      if (quillInstanceRef.current) {
        // Remover event listeners
        quillInstanceRef.current.off('text-change');
        quillInstanceRef.current.off('selection-change');
        if (copyHandlerRef.current) {
          quillInstanceRef.current.root?.removeEventListener('copy', copyHandlerRef.current);
        }
        // v1.20.2: Reset guard para permitir re-adicionar listener em nova inst√¢ncia
        copyListenerAddedRef.current = false;
        // Limpar refer√™ncia
        quillInstanceRef.current = null;
      }
      // Limpar o container (remove toolbar duplicada)
      if (containerRef.current) {
        containerRef.current.innerHTML = '';
      }
      isInitializedRef.current = false;
    };
  }, []);

  // Renderiza√ß√£o
  if (!quillReady) {
    return (
      <div className={`theme-bg-primary border theme-border-input rounded-lg p-4 ${className}`}>
        <p className="theme-text-muted text-center">
          ‚è≥ Carregando editor Quill.js...
        </p>
      </div>
    );
  }

  if (quillError) {
    return (
      <div className={`bg-red-900/20 border border-red-600 rounded-lg p-4 ${className}`}>
        <p className="text-red-400 text-sm">
          ‚ùå {quillError}
        </p>
        <p className="theme-text-muted text-xs mt-2">
          Usando editor alternativo. Verifique sua conex√£o com a internet.
        </p>
      </div>
    );
  }

  return (
    <div
      ref={containerRef}
      className={className}
      style={{ minHeight: '150px', height: '100%' }}
    />
  );
});

QuillEditorBase.displayName = 'QuillEditorBase';

// QuillModelEditor - Editor para modelos/templates
const QuillModelEditor = React.forwardRef(({
  content,
  onChange,
  onSaveWithoutClosing,
  onOpenAIAssistant,
  toolbarRef,
  quillReady = false,
  quillError = null,
  editorTheme,
  toggleEditorTheme
}, ref) => {
  const { quillInstanceRef, customModules, handleQuillReady } = useQuillEditor({
    ref,
    onSaveWithoutClosing,
    enableCtrlS: true
  });

  const { spacing, setSpacing } = useSpacingControl();

  const { fontSize, setFontSize } = useFontSizeControl();

  const { isFullscreen, toggleFullscreen, containerRef } = useFullscreen();

  // Estilos injetados globalmente no componente principal (ap√≥s Quill carregar)

  // Configurar toolbar completa para modelos (full = 28 op√ß√µes)
  const toolbarConfig = React.useMemo(() => getQuillToolbarConfig('full'), []);

  // v1.35.61: Handler para Voice-to-Text - insere texto na posi√ß√£o do cursor
  const handleVoiceTranscript = React.useCallback((text) => {
    const quill = quillInstanceRef.current;
    if (quill) {
      requestAnimationFrame(() => {
        const range = quill.getSelection() || { index: quill.getLength() - 1 };
        quill.insertText(range.index, text + ' ');
        quill.setSelection(range.index + text.length + 1);
      });
    }
  }, []);

  return (
    <div ref={containerRef} className={isFullscreen ? 'editor-fullscreen' : ''}>
      {/* v1.9.36: Wrapper interno como QuillDecisionEditor */}
      <div className={isFullscreen ? 'flex flex-col flex-1 min-h-0' : ''}>
        {!isFullscreen && (
          <label className={CSS.label}>
            Conte√∫do
          </label>
        )}

        {/* Bot√µes Customizados (acima do editor) */}
        {/* v1.9.36: Adicionado flex-wrap e flex-shrink-0 */}
        <div className="flex flex-wrap gap-2 mb-2 flex-shrink-0">
        {/* Bot√£o Salvar */}
        <button
          onClick={onSaveWithoutClosing}
          className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-green-600 hover-green-700-from-600"
          title="Salvar (Ctrl+S)"
        >
          <Save className="w-3.5 h-3.5" />
          Salvar
        </button>

        {/* v1.35.61: Bot√£o Voice-to-Text */}
        <VoiceButton
          onTranscript={handleVoiceTranscript}
          size="md"
          onError={(err) => console.warn('[VoiceToText]', err)}
        />

        {/* Bot√£o Assistente IA */}
        {onOpenAIAssistant && (
          <button
            onClick={onOpenAIAssistant}
            className="hover-purple-700 px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-purple-600"
            title="Assistente de IA"
          >
            <Sparkles className="w-3.5 h-3.5" />
            Assistente IA
          </button>
        )}

        {/* v1.9.20: Bot√£o Fullscreen */}
        <button
          onClick={toggleFullscreen}
          className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 theme-bg-tertiary hover-slate-500"
          title={isFullscreen ? 'Sair do Fullscreen (ESC ou Ctrl+F)' : 'Tela Cheia (Ctrl+F)'}
        >
          {isFullscreen ? (
            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          ) : (
            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg>
          )}
        </button>

        {/* v1.9.11: Dropdown de Espa√ßamento + v1.10.8: Tamanho de Fonte */}
        <div className="ml-auto flex items-center gap-4">
          <div className="flex items-center gap-2">
            <span className={CSS.textMuted}>Fonte:</span>
            <FontSizeDropdown
              value={fontSize}
              onChange={setFontSize}
              ariaLabel="Tamanho da fonte do editor de modelos"
            />
          </div>
          <div className="flex items-center gap-2">
            <span className={CSS.textMuted}>Espa√ßamento:</span>
            <SpacingDropdown
              value={spacing}
              onChange={setSpacing}
              ariaLabel="Espa√ßamento do editor de modelos"
            />
          </div>
        </div>
      </div>

      {/* Editor Quill (com toolbar sticky e scroll interno) */}
      {/* v1.9.35: Alinhado com QuillDecisionEditor - key for√ßa recria√ß√£o DOM */}
      <div
        key={isFullscreen ? 'model-fullscreen-wrapper' : 'model-normal-wrapper'}
        className={`fontsize-${fontSize} spacing-${spacing} ${editorTheme === 'light' ? 'quill-light-theme bg-white' : 'theme-bg-primary'} border theme-border-input rounded-lg ${isFullscreen ? 'fullscreen-editor-wrapper' : ''}`}
      >
        <QuillEditorBase
          content={content}
          onChange={onChange}
          onReady={handleQuillReady}
          toolbarConfig={toolbarConfig}
          modules={customModules}
          placeholder="Digite o conte√∫do do modelo..."
          className={isFullscreen ? 'fullscreen-quill-fill' : 'min-h-[300px] max-h-[80vh]'}
          quillReady={quillReady}
          quillError={quillError}
        />
      </div>
      </div>
      {/* v1.9.36: Fecha wrapper interno */}
    </div>
  );
});

QuillModelEditor.displayName = 'QuillModelEditor';

// QuillDecisionEditor - Editor para decis√µes judiciais
// v1.15.4: Adicionado onSlashCommand
const QuillDecisionEditor = React.forwardRef(({
  content = '',
  onChange,
  onSaveWithoutClosing,
  onOpenAIAssistant,
  onOpenJurisModal,
  onExtractModel,
  onSaveAsModel,
  extractingModel = false,
  showExtractButton = false,
  label = '‚úçÔ∏è Sua Decis√£o:',
  placeholder = 'Digite aqui sua decis√£o...',
  topicTitle = '',
  topicCategory = '',
  quillReady = false,
  quillError = null,
  onRegenerate,
  customInstruction = '',
  onInstructionChange,
  regenerating = false,
  showRegenerateSection = false,
  editorTheme,
  toggleEditorTheme,
  models = [],
  onInsertModel,
  onPreviewModel,
  sanitizeHTML,
  topicRelatorio = '',
  onFindSuggestions,
  onSlashCommand,
  isDirty = false,
  versioning = null,
  onBlur = null
}, ref) => {
  const { quillInstanceRef, customModules, handleQuillReady } = useQuillEditor({
    ref,
    onSaveWithoutClosing,
    enableCtrlS: true,
    topicTitle,
    content,
    enableTopicChangeDetection: true
  });

  const { spacing, setSpacing } = useSpacingControl();

  const { fontSize, setFontSize } = useFontSizeControl();

  const { isFullscreen, toggleFullscreen, isSplitMode, toggleSplitMode, splitPosition, handleSplitDrag, containerRef } = useFullscreen();

  const [isDragging, setIsDragging] = React.useState(false);

  const startDrag = React.useCallback((e) => {
    setIsDragging(true);
    e.preventDefault();
  }, []);

  React.useEffect(() => {
    if (!isDragging) return;

    const handleMouseMove = (e) => {
      handleSplitDrag(e);
    };

    const handleMouseUp = () => {
      setIsDragging(false);
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);

    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [isDragging, handleSplitDrag]);

  // v1.24: Listener de blur para versionamento
  React.useEffect(() => {
    const quillRoot = quillInstanceRef.current?.root;
    if (!quillRoot || !onBlur) return;
    const handleBlur = () => {
      setTimeout(() => {
        const html = quillInstanceRef.current?.root?.innerHTML || '';
        if (html && html !== '<p><br></p>') onBlur(html);
      }, 0);
    };
    quillRoot.addEventListener('blur', handleBlur);
    return () => quillRoot.removeEventListener('blur', handleBlur);
  }, [onBlur]);

  // Configurar toolbar completa (28 op√ß√µes - igual DecisionEditorToolbar)
  const toolbarConfig = React.useMemo(() => getQuillToolbarConfig('full'), []);

  const handleInsertModel = React.useCallback((content) => {
    onInsertModel?.(content);
  }, [onInsertModel]);

  const handlePreviewModel = React.useCallback((model) => {
    onPreviewModel?.(model);
  }, [onPreviewModel]);

  // v1.35.59: Handler para Voice-to-Text - insere texto na posi√ß√£o do cursor
  const handleVoiceTranscript = React.useCallback((text) => {
    const quill = quillInstanceRef.current;
    if (quill) {
      // Usar requestAnimationFrame para n√£o bloquear UI
      requestAnimationFrame(() => {
        const range = quill.getSelection() || { index: quill.getLength() - 1 };
        quill.insertText(range.index, text + ' ');
        quill.setSelection(range.index + text.length + 1);
      });
    }
  }, []);

  const editorPaneStyle = React.useMemo(() =>
    isSplitMode ? { width: `${splitPosition}%` } : undefined
  , [isSplitMode, splitPosition]);

  const modelPaneStyle = React.useMemo(() =>
    isSplitMode ? { width: `${100 - splitPosition}%` } : undefined
  , [isSplitMode, splitPosition]);

  return (
    <div ref={containerRef} className={`${isFullscreen ? 'editor-fullscreen' : ''} ${isSplitMode ? 'editor-fullscreen-split' : ''}`}>
      {/* Painel do Editor (esquerda em split mode) */}
      {/* v1.9.30: Adicionado flex flex-col flex-1 min-h-0 para altura correta */}
      <div
        className={`flex flex-col flex-1 min-h-0 ${isSplitMode ? 'split-editor-pane' : ''}`}
        style={editorPaneStyle}
      >
        {/* v1.9.30: Mostrar nome do t√≥pico em fullscreen */}
        {isFullscreen ? (
          <div className="flex items-center gap-2 mb-2 flex-shrink-0">
            <span className="theme-text-primary font-semibold text-lg">
              üìù {topicTitle}
            </span>
            {topicCategory && (
              <span className="px-2 py-1 text-xs rounded theme-bg-purple-accent theme-text-purple">
                {topicCategory}
              </span>
            )}
          </div>
        ) : (
          <label className={CSS.label}>
            {label}
          </label>
        )}

        {/* Bot√µes Customizados (acima do editor) */}
        {/* v1.9.30: Adicionado flex-shrink-0 para n√£o comprimir bot√µes */}
        <div className="flex flex-wrap gap-2 mb-2 flex-shrink-0">
          {/* Bot√£o Salvar */}
          <button
            onClick={onSaveWithoutClosing}
            className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-green-600 hover-green-700-from-600"
            title="Salvar (Ctrl+S)"
          >
            <Save className="w-3.5 h-3.5" />
            Salvar
          </button>

          {/* v1.35.59: Bot√£o Voice-to-Text */}
          <VoiceButton
            onTranscript={handleVoiceTranscript}
            size="md"
            onError={(err) => console.warn('[VoiceToText]', err)}
          />

          {/* Bot√£o Assistente IA */}
          {onOpenAIAssistant && (
            <button
              onClick={onOpenAIAssistant}
              className="hover-purple-700 px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-purple-600"
              title="Assistente de IA"
            >
              <Sparkles className="w-3.5 h-3.5" />
              Assistente IA
            </button>
          )}

          {/* v1.20.0: Bot√£o Jurisprud√™ncia */}
          {onOpenJurisModal && (
            <button
              onClick={onOpenJurisModal}
              className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-blue-600 hover-blue-700-from-600"
              title="Buscar jurisprud√™ncia relevante"
            >
              <Scale className="w-3.5 h-3.5" />
              Jurisprud√™ncia
            </button>
          )}

          {/* Bot√£o Extrair Modelo (condicional) */}
          {showExtractButton && onExtractModel && (
            <button
              onClick={onExtractModel}
              disabled={extractingModel}
              className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-pink-600 hover-pink-700 disabled:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-300"
              title="Extrair como modelo reutiliz√°vel (usa IA)"
            >
              {extractingModel ? (
                <>
                  <div className="w-3.5 h-3.5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  Extraindo...
                </>
              ) : (
                <>
                  <BookOpen className="w-3.5 h-3.5" />
                  Extrair Modelo
                </>
              )}
            </button>
          )}

          {/* v1.13.2: Bot√£o Salvar como Modelo (preserva texto 100%) */}
          {showExtractButton && onSaveAsModel && (
            <button
              onClick={onSaveAsModel}
              className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-blue-600 hover-blue-700-from-600"
              title="Salvar texto atual como modelo (preserva 100%)"
            >
              <Save className="w-3.5 h-3.5" />
              Salvar como Modelo
            </button>
          )}

          {/* v1.9.31: Bot√£o Modelos (ANTES do Fullscreen toggle) - Cor amber para destaque */}
          {isFullscreen && (
            <button
              onClick={toggleSplitMode}
              className={`px-3 py-1.5 text-white text-xs rounded flex items-center gap-1.5 transition-all ${
                isSplitMode
                  ? 'bg-amber-700 ring-2 ring-amber-400'
                  : 'bg-amber-600 hover-amber-700'
              }`}
              title={isSplitMode ? 'Fechar Modelos (ESC ou Ctrl+M)' : 'üìö Abrir Biblioteca de Modelos (Ctrl+M)'}
            >
              <BookOpen className="w-3.5 h-3.5" />
              {isSplitMode ? 'Fechar Modelos' : 'üìö Modelos'}
            </button>
          )}

          {/* v1.9.20: Bot√£o Fullscreen */}
          <button
            onClick={toggleFullscreen}
            className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 theme-bg-tertiary hover-slate-500"
            title={isFullscreen ? 'Sair do Fullscreen (ESC ou Ctrl+F)' : 'Tela Cheia (Ctrl+F)'}
          >
            {isFullscreen ? (
              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            ) : (
              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
              </svg>
            )}
          </button>

          {/* v1.24: Dropdown de vers√µes (ao lado do fullscreen) */}
          {versioning && topicTitle && (
            <VersionSelect
              topicTitle={topicTitle}
              versioning={versioning}
              currentContent={content}
              onRestore={(restoredContent) => onChange?.(restoredContent)}
            />
          )}

          {/* v1.13.9: Indicador de mudan√ßas n√£o salvas */}
          {isDirty && (
            <span className="px-2 py-1 text-xs rounded bg-amber-500/20 text-amber-400 border border-amber-500/30">
              N√£o salvo
            </span>
          )}

          {/* v1.9.11: Dropdown de Espa√ßamento + v1.10.8: Tamanho de Fonte */}
          <div className="ml-auto flex items-center gap-4">
            <div className="flex items-center gap-2">
              <span className={CSS.textMuted}>Fonte:</span>
              <FontSizeDropdown
                value={fontSize}
                onChange={setFontSize}
                ariaLabel="Tamanho da fonte do editor de t√≥picos"
              />
            </div>
            <div className="flex items-center gap-2">
              <span className={CSS.textMuted}>Espa√ßamento:</span>
              <SpacingDropdown
                value={spacing}
                onChange={setSpacing}
                ariaLabel="Espa√ßamento do editor de t√≥picos"
              />
            </div>
          </div>
        </div>

        {/* Editor Quill (com toolbar sticky e scroll interno) */}
        {/* v1.9.27: Key no div pai for√ßa React a destruir/recriar toda a √°rvore DOM */}
        <div
          key={isFullscreen ? 'fullscreen-wrapper' : 'normal-wrapper'}
          className={`fontsize-${fontSize} spacing-${spacing} ${editorTheme === 'light' ? 'quill-light-theme bg-white' : 'theme-bg-primary'} border theme-border-input rounded-lg ${isFullscreen ? 'fullscreen-editor-wrapper' : ''}`}
        >
          <QuillEditorBase
            content={content}
            onChange={onChange}
            onReady={handleQuillReady}
            onSlashCommand={onSlashCommand}
            toolbarConfig={toolbarConfig}
            modules={customModules}
            placeholder={placeholder}
            className={isFullscreen ? 'fullscreen-quill-fill' : 'min-h-[400px] max-h-[80vh]'}
            quillReady={quillReady}
            quillError={quillError}
          />
        </div>

        {/* v1.9.12: Se√ß√£o de regenera√ß√£o IA (DISPOSITIVO) - Usando componente compartilhado */}
        {showRegenerateSection && onRegenerate && !isFullscreen && (
          <AIRegenerationSection
            customInstruction={customInstruction}
            onInstructionChange={onInstructionChange}
            regenerating={regenerating}
            onRegenerate={onRegenerate}
            contextLabel="dispositivo"
          />
        )}
      </div>

      {/* v1.9.21: Divisor arrast√°vel (s√≥ em split mode) */}
      {isSplitMode && (
        <SplitDivider onDragStart={startDrag} />
      )}

      {/* v1.9.29: Painel de Sugest√µes de Modelos (direita, s√≥ em split mode) */}
      {isSplitMode && (
        <div
          className="split-editor-pane"
          style={modelPaneStyle}
        >
          <FullscreenModelPanel
            models={models}
            topicTitle={topicTitle}
            topicCategory={topicCategory}
            topicRelatorio={topicRelatorio}
            onInsert={handleInsertModel}
            onPreview={handlePreviewModel}
            sanitizeHTML={sanitizeHTML}
            onFindSuggestions={onFindSuggestions}
          />
        </div>
      )}
    </div>
  );
});

QuillDecisionEditor.displayName = 'QuillDecisionEditor';

// üîß COMPONENTE COMPARTILHADO: AIRegenerationSection (v1.9.12)
// Se√ß√£o de regenera√ß√£o com IA (textarea de instru√ß√µes + bot√£o gerar)
// v1.35.10: Estado local bufferizado para evitar re-render do LegalDecisionEditor a cada keystroke
const AIRegenerationSection = React.memo(({
  customInstruction = '',
  onInstructionChange,
  regenerating = false,
  onRegenerate,
  contextLabel = 'texto' // "dispositivo" ou "mini-relat√≥rio"
}) => {
  // v1.35.10: Estado LOCAL para o textarea
  // Digita√ß√£o atualiza apenas este componente (leve), n√£o o LegalDecisionEditor (pesado)
  const [localInstruction, setLocalInstruction] = React.useState(customInstruction);

  // v1.35.10: Sincronizar estado local quando customInstruction muda externamente
  React.useEffect(() => {
    setLocalInstruction(customInstruction);
  }, [customInstruction]);

  // v1.35.10: Handler para digita√ß√£o - atualiza estado LOCAL
  const handleInstructionChange = React.useCallback((e) => {
    setLocalInstruction(e.target.value);
  }, []);

  // v1.35.10: Propagar para pai apenas no blur
  const handleBlur = React.useCallback(() => {
    if (onInstructionChange && localInstruction !== customInstruction) {
      onInstructionChange(localInstruction);
    }
  }, [onInstructionChange, localInstruction, customInstruction]);

  const handleMouseEnterButton = React.useCallback((e) => {
    if (!regenerating) {
      e.currentTarget.style.backgroundColor = '#7e22ce';
    }
  }, [regenerating]);

  const handleMouseLeaveButton = React.useCallback((e) => {
    e.currentTarget.style.backgroundColor = regenerating ? '#6b7280' : '#9333ea';
  }, [regenerating]);

  // v1.35.10: Sincronizar antes de regenerar (caso usu√°rio n√£o tenha sa√≠do do campo)
  const handleRegenerate = React.useCallback(() => {
    if (onInstructionChange && localInstruction !== customInstruction) {
      onInstructionChange(localInstruction);
    }
    // Pequeno delay para garantir que o estado foi propagado
    setTimeout(() => onRegenerate(), 0);
  }, [onInstructionChange, localInstruction, customInstruction, onRegenerate]);

  // v1.35.59: Handler para Voice-to-Text - adiciona texto ao final da instru√ß√£o
  const handleVoiceTranscript = React.useCallback((text) => {
    setLocalInstruction(prev => (prev ? prev + ' ' : '') + text);
  }, []);

  return (
    <div className="mt-4 pt-4 border-t theme-border-input">
      <p className="text-xs theme-text-muted mb-2">
        ‚ú® <strong>Regenerar com IA:</strong> Adicione uma instru√ß√£o opcional abaixo e clique em "Gerar" para que a IA recrie este {contextLabel}
      </p>

      {/* v1.35.59: Container flex para textarea + VoiceButton */}
      <div className="flex gap-2">
        <textarea
          value={localInstruction}
          onChange={handleInstructionChange}
          onBlur={handleBlur}
          placeholder="Instru√ß√£o opcional (ex: 'Seja mais objetivo', 'Adicione detalhes sobre...')"
          className="flex-1 px-3 py-2 theme-bg-primary border theme-border-input rounded theme-text-tertiary text-sm theme-placeholder focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all"
          rows="2"
        />
        <VoiceButton
          onTranscript={handleVoiceTranscript}
          size="sm"
          className="self-start mt-1"
        />
      </div>

      <button
        onClick={handleRegenerate}
        disabled={regenerating}
        onMouseEnter={handleMouseEnterButton}
        onMouseLeave={handleMouseLeaveButton}
        style={{
          backgroundColor: regenerating ? '#6b7280' : '#9333ea',
          transition: 'background-color 0.3s ease',
          cursor: regenerating ? 'not-allowed' : 'pointer'
        }}
        className="mt-2 px-3 py-1.5 text-white text-xs rounded flex items-center gap-1"
      >
        {regenerating ? (
          <>
            <div className="w-3.5 h-3.5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            Gerando...
          </>
        ) : (
          <>
            <Sparkles className="w-3.5 h-3.5" />
            Gerar com IA
          </>
        )}
      </button>
    </div>
  );
});

AIRegenerationSection.displayName = 'AIRegenerationSection';

// QuillMiniRelatorioEditor - Mini-relat√≥rio sem toolbar
// v1.15.6: Adicionado onSlashCommand
const QuillMiniRelatorioEditor = React.memo(React.forwardRef(({
  content = '',
  onChange,
  onRegenerate,
  onSaveWithoutClosing,
  customInstruction = '',
  onInstructionChange,
  regenerating = false,
  topicTitle = '',
  label = 'Mini-relat√≥rio (edit√°vel):',
  showRegenerateSection = true,
  quillReady = false,
  quillError = null,
  editorTheme,
  toggleEditorTheme,
  onSlashCommand
}, ref) => {
  const { quillInstanceRef, customModules, handleQuillReady } = useQuillEditor({
    ref,
    onSaveWithoutClosing,
    enableCtrlS: true,
    topicTitle,
    content,
    enableTopicChangeDetection: true
  });

  const { spacing } = useSpacingControl();

  const { fontSize } = useFontSizeControl();

  // Configura√ß√£o: SEM toolbar (minimal = false)
  const toolbarConfig = React.useMemo(() => false, []);

  return (
    <div className="theme-bg-secondary-30 p-4 rounded-lg border theme-border-input">
      <p className="text-blue-400 font-medium mb-2">{label}</p>

      {/* Editor Quill SEM toolbar + Ctrl+S */}
      <div className={`fontsize-${fontSize} spacing-${spacing} ${editorTheme === 'light' ? 'quill-light-theme bg-white' : 'theme-bg-primary-50'} border theme-border-input rounded`}>
        <QuillEditorBase
          content={content}
          onChange={onChange}
          onReady={handleQuillReady}
          onSlashCommand={onSlashCommand}
          toolbarConfig={toolbarConfig} // false = sem toolbar
          modules={customModules} // CORRE√á√ÉO #3: Adiciona Ctrl+S keyboard shortcut
          placeholder="O reclamante narra que... Sustenta que... Postula... A primeira reclamada, em defesa, alega que..."
          className="min-h-32"
          quillReady={quillReady}
          quillError={quillError}
        />
      </div>

      <p className="text-xs theme-text-disabled mt-2">
        üí° Formato sugerido: "O reclamante narra que... Sustenta que... Postula... A primeira reclamada, em defesa, alega que..."
        <br />
        ‚å®Ô∏è <strong>Ctrl+S</strong> = Salvar sem fechar
      </p>

      {/* v1.9.12: Se√ß√£o de regenera√ß√£o IA (MINI-RELAT√ìRIO) - Usando componente compartilhado */}
      {showRegenerateSection && onRegenerate && (
        <AIRegenerationSection
          customInstruction={customInstruction}
          onInstructionChange={onInstructionChange}
          regenerating={regenerating}
          onRegenerate={onRegenerate}
          contextLabel="mini-relat√≥rio"
        />
      )}
    </div>
  );
}));

QuillMiniRelatorioEditor.displayName = 'QuillMiniRelatorioEditor';

// üõ†Ô∏è COMPONENTE: DecisionEditorContainer - Container do editor de decis√£o
// v1.15.4: Adicionado onSlashCommand, v1.20.0: Adicionado onOpenJurisModal
const DecisionEditorContainer = React.memo(React.forwardRef(({
  editorRef,
  relatorioRef,
  toolbarRef,
  topic,
  onSave,
  onCancel,
  onSaveWithoutClosing,
  onCategoryChange,
  onFundamentacaoChange,
  onRelatorioChange,
  onOpenAIAssistant,
  onOpenJurisModal,
  onExtractModel,
  onSaveAsModel,
  onRegenerateRelatorio,
  savingTopic,
  extractingModel,
  showExtractButton,
  regeneratingRelatorio,
  relatorioInstruction,
  onInstructionChange,
  sanitizeHTML,
  onTextSelection,
  // Para atualiza√ß√£o de categoria
  selectedTopics,
  setSelectedTopics,
  extractedTopics,
  setExtractedTopics,
  getTopicEditorConfig,
  quillReady,
  quillError,
  onRegenerateDispositivo,
  dispositivoInstruction,
  onDispositivoInstructionChange,
  regeneratingDispositivo,
  editorTheme,
  toggleEditorTheme,
  models,
  onInsertModel,
  onPreviewModel,
  findSuggestions,
  onSlashCommand,
  isDirty = false,
  versioning = null
}, containerRef) => {

  const editorConfig = getTopicEditorConfig(topic.title);

  // üöÄ v1.8.3: Handler para mudan√ßa de categoria (MEMOIZADO)
  const handleCategoryChange = React.useCallback((e) => {
    const newCategory = e.target.value;

    // Chamar callback do pai
    onCategoryChange(newCategory);

    // Atualizar em selectedTopics
    const selectedIndex = selectedTopics.findIndex(t => t.title === topic.title);
    if (selectedIndex !== -1) {
      const newSelected = [...selectedTopics];
      newSelected[selectedIndex] = { ...newSelected[selectedIndex], category: newCategory };
      setSelectedTopics(newSelected);
    }

    // Atualizar em extractedTopics
    const extractedIndex = extractedTopics.findIndex(t => t.title === topic.title);
    if (extractedIndex !== -1) {
      const newExtracted = [...extractedTopics];
      newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], category: newCategory };
      setExtractedTopics(newExtracted);
    }
  }, [onCategoryChange, topic.title, selectedTopics, extractedTopics]); // üöÄ v1.8.3: Memoizado (GRUPO C)

  return (
    <div ref={containerRef} className="space-y-4">
      {/* Header com t√≠tulo e categoria */}
      <div className="flex items-center gap-3 flex-wrap">
        <h3 className="text-xl font-bold text-blue-400">{topic.title.toUpperCase()}</h3>

        {/* v1.4.7: Seletor de categoria - condicional baseado em config */}
        {editorConfig.showCategory && (
          <select
            value={topic.category || 'M√âRITO'}
            onChange={handleCategoryChange}
            className="text-xs px-3 py-2 rounded cursor-pointer font-medium focus:outline-none focus:ring-2 focus:ring-blue-400 border-2 theme-border theme-text-secondary theme-bg-tertiary hover-slate-500"
            title="Clique para alterar a categoria"
          >
            <option value="PRELIMINAR">üìã Preliminar</option>
            <option value="PREJUDICIAL">‚ö†Ô∏è Prejudicial</option>
            <option value="M√âRITO">‚öñÔ∏è M√©rito</option>
            <option value="PROCESSUAL">üìù Processual</option>
          </select>
        )}
      </div>

      {/* v1.5.1: Mini-Relat√≥rio - migrado para Quill.js (ETAPA 4) */}
      {editorConfig.showMiniRelatorio && (
      <QuillMiniRelatorioEditor
        ref={relatorioRef}
        content={topic.editedRelatorio || topic.relatorio || ''}
        topicTitle={topic.title}
        onChange={onRelatorioChange}
        onRegenerate={onRegenerateRelatorio}
        onSaveWithoutClosing={onSaveWithoutClosing} // CORRE√á√ÉO #3: Adiciona handler Ctrl+S
        customInstruction={relatorioInstruction}
        onInstructionChange={onInstructionChange}
        regenerating={regeneratingRelatorio}
        quillReady={quillReady}
        quillError={quillError}
        editorTheme={editorTheme}
        toggleEditorTheme={toggleEditorTheme}
        onSlashCommand={onSlashCommand}
        {...editorConfig.relatorioConfig}
      />
      )}

      {/* v1.5.0: Editor de Decis√£o migrado para Quill.js (ETAPA 3) */}
      {editorConfig.showDecisionEditor && (
      <QuillDecisionEditor
        ref={editorRef}
        content={
          topic.title.toUpperCase() === 'DISPOSITIVO'
            ? (topic.editedContent || '')
            : (topic.fundamentacao || topic.editedFundamentacao || '')
        }
        topicTitle={topic.title}
        topicCategory={topic.category}
        onChange={onFundamentacaoChange}
        onSaveWithoutClosing={onSaveWithoutClosing}
        onOpenAIAssistant={onOpenAIAssistant}
        onOpenJurisModal={onOpenJurisModal}
        onExtractModel={onExtractModel}
        onSaveAsModel={onSaveAsModel}
        extractingModel={extractingModel}
        showExtractButton={showExtractButton}
        quillReady={window.Quill !== undefined}
        quillError={null}
        onRegenerate={topic.title.toUpperCase() === 'DISPOSITIVO' ? onRegenerateDispositivo : undefined}
        customInstruction={topic.title.toUpperCase() === 'DISPOSITIVO' ? dispositivoInstruction : ''}
        onInstructionChange={topic.title.toUpperCase() === 'DISPOSITIVO' ? onDispositivoInstructionChange : undefined}
        regenerating={topic.title.toUpperCase() === 'DISPOSITIVO' ? regeneratingDispositivo : false}
        showRegenerateSection={topic.title.toUpperCase() === 'DISPOSITIVO'}
        editorTheme={editorTheme}
        toggleEditorTheme={toggleEditorTheme}
        models={models}
        onInsertModel={onInsertModel}
        onPreviewModel={onPreviewModel}
        sanitizeHTML={sanitizeHTML}
        topicRelatorio={topic.relatorio || topic.editedRelatorio || ''}
        onFindSuggestions={findSuggestions}
        onSlashCommand={onSlashCommand}
        isDirty={isDirty}
        versioning={versioning}
        onBlur={(html) => versioning?.saveVersion(topic.title, html)}
        {...editorConfig.editorConfig}
      />
      )}

      {/* Footer com bot√µes */}
      <div className="flex gap-3">
        <button
          onClick={onCancel}
          disabled={savingTopic}
          className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed theme-bg-secondary hover-slate-600-from-700 transition-all duration-300"
        >
          Cancelar
        </button>
        <button
          onClick={onSave}
          disabled={savingTopic}
          className="flex-1 py-3 rounded-lg font-medium text-white disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 hover-gradient-blue-purple transition-all duration-300"
        >
          {savingTopic ? (
            <>
              <div className={CSS.spinner}></div>
              <span>Salvando...</span>
            </>
          ) : (
            'Salvar e Fechar'
          )}
        </button>
      </div>
    </div>
  );
}));

DecisionEditorContainer.displayName = 'DecisionEditorContainer';

// üîß HELPER: Fast Hash (v1.9.1)
const fastHashUtil = (str) => {
  if (!str) return 'empty';
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash |= 0; // Convert to 32bit integer
  }
  return hash.toString(36);
};

// üîß HOOK: useDocumentServices (v1.9.12)
// Centraliza toda a l√≥gica de processamento de documentos (PDF, DOCX, OCR)
const useDocumentServices = (aiIntegration) => {
  // üìö CARREGAR BIBLIOTECAS VIA CDN

  const loadPDFJS = React.useCallback(() => {
    return new Promise((resolve, reject) => {

      if (window.pdfjsLib) {
        resolve(window.pdfjsLib);
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';

      script.onload = () => {
        if (window.pdfjsLib) {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
          resolve(window.pdfjsLib);
        } else {
          reject(new Error('pdfjsLib n√£o encontrado ap√≥s carregar script'));
        }
      };

      script.onerror = (err) => {
        reject(new Error('Falha ao carregar PDF.js da CDN'));
      };

      setTimeout(() => {
        if (!window.pdfjsLib) {
          reject(new Error('Timeout ao carregar PDF.js'));
        }
      }, 10000);

      document.head.appendChild(script);
    });
  }, []);

  const loadMammoth = React.useCallback(() => {
    return new Promise((resolve, reject) => {

      if (window.mammoth) {
        resolve(window.mammoth);
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js';

      script.onload = () => {
        if (window.mammoth) {
          resolve(window.mammoth);
        } else {
          reject(new Error('mammoth n√£o encontrado ap√≥s carregar script'));
        }
      };

      script.onerror = (err) => {
        reject(new Error('Falha ao carregar Mammoth.js da CDN'));
      };

      setTimeout(() => {
        if (!window.mammoth) {
          reject(new Error('Timeout ao carregar Mammoth.js'));
        }
      }, 10000);

      document.head.appendChild(script);
    });
  }, []);

  // üÜï v1.31: Loader Tesseract.js para OCR offline
  const loadTesseract = React.useCallback(() => {
    return new Promise((resolve, reject) => {
      if (window.Tesseract) {
        resolve(window.Tesseract);
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';

      script.onload = () => {
        if (window.Tesseract) {
          resolve(window.Tesseract);
        } else {
          reject(new Error('Tesseract n√£o encontrado ap√≥s carregar script'));
        }
      };

      script.onerror = () => {
        reject(new Error('Falha ao carregar Tesseract.js da CDN'));
      };

      // Timeout maior (30s) pois modelo portugu√™s (~4MB) pode demorar
      setTimeout(() => {
        if (!window.Tesseract) {
          reject(new Error('Timeout ao carregar Tesseract.js'));
        }
      }, 30000);

      document.head.appendChild(script);
    });
  }, []);

  // üìù EXTRA√á√ÉO DE TEXTO DE PDF

  // v1.20.2: Adicionado pdf.destroy() em finally (FIX memory leak ~50-100MB por PDF)
  const extractTextFromPDFPure = React.useCallback(async (file, progressCallback = null) => {
    let pdf = null;
    try {
      const pdfjsLib = await loadPDFJS();
      const arrayBuffer = await file.arrayBuffer();
      pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      let fullText = '';
      const totalPages = pdf.numPages;

      for (let i = 1; i <= totalPages; i++) {
        if (progressCallback) {
          progressCallback(i, totalPages);
        }
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        // v1.14.1: Validar textContent.items antes de map (fix: null em alguns PDFs)
        const items = textContent?.items || [];
        const pageText = items.map(item => item?.str || '').join(' ');
        fullText += pageText + '\n\n';
      }

      // v1.16.7: Anonimiza√ß√£o movida para analyzeDocuments (evita duplica√ß√£o)
      return fullText.trim();
    } catch (err) {
      return null;
    } finally {
      if (pdf) {
        try { pdf.destroy(); } catch (e) { /* ignore */ }
      }
    }
  }, [loadPDFJS]);

  const extractTextFromDOCX = React.useCallback(async (file) => {
    try {
      const mammoth = await loadMammoth();

      const arrayBuffer = await file.arrayBuffer();

      const result = await mammoth.extractRawText({ arrayBuffer });
      const text = result.value;

      if (result.messages && result.messages.length > 0) {
      }

      return text;
    } catch (err) {
      throw new Error(`Falha ao extrair texto do DOCX: ${err.message}`);
    }
  }, [loadMammoth]);

  // üÜï v1.12.23: Processamento em BATCH - envia at√© 50 p√°ginas por requisi√ß√£o (25x mais r√°pido)
  // v1.20.2: Adicionado pdf.destroy() em finally (FIX memory leak)
  const extractTextFromPDFWithClaudeVision = React.useCallback(async (file, progressCallback = null) => {
    // Constantes de configura√ß√£o do batch
    const BATCH_SIZE = 50;        // M√°ximo de p√°ginas por requisi√ß√£o (API suporta at√© 100)
    const SCALE = 1.5;            // Escala reduzida para garantir < 2000px por imagem
    const JPEG_QUALITY = 0.85;    // Qualidade JPEG (menor = mais r√°pido upload)
    const MAX_TOKENS = 16384;     // Tokens para acomodar m√∫ltiplas p√°ginas

    let pdf = null;
    try {
      if (progressCallback) {
        progressCallback(0, 0, 'iniciando');
      }

      const pdfjsLib = await loadPDFJS();
      const arrayBuffer = await file.arrayBuffer();

      // v1.12.15: Desabilita carregamento de fontes externas (evita erro CORS no Claude.ai)
      pdf = await pdfjsLib.getDocument({
        data: arrayBuffer,
        useSystemFonts: true,
        disableFontFace: true
      }).promise;

      const totalPages = pdf.numPages;

      // FASE 1: Renderizar TODAS as p√°ginas para imagens base64
      const pageImages = [];
      for (let i = 1; i <= totalPages; i++) {
        if (progressCallback) {
          progressCallback(i, totalPages, 'renderizando');
        }

        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: SCALE });

        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        try {
          const context = canvas.getContext('2d');
          await page.render({
            canvasContext: context,
            viewport: viewport
          }).promise;

          const base64Image = canvas.toDataURL('image/jpeg', JPEG_QUALITY).split(',')[1];
          pageImages.push({ pageNum: i, base64: base64Image });
        } finally {
          // Liberar mem√≥ria do canvas sempre, mesmo em caso de erro
          canvas.width = 0;
          canvas.height = 0;
        }
      }

      // FASE 2: Processar em batches de at√© 50 p√°ginas
      let fullText = '';
      const totalBatches = Math.ceil(totalPages / BATCH_SIZE);

      for (let batchIdx = 0; batchIdx < totalBatches; batchIdx++) {
        const startIdx = batchIdx * BATCH_SIZE;
        const endIdx = Math.min(startIdx + BATCH_SIZE, totalPages);
        const batchImages = pageImages.slice(startIdx, endIdx);
        const batchPageNumbers = batchImages.map(img => img.pageNum);

        if (progressCallback) {
          progressCallback(endIdx, totalPages, `processando batch ${batchIdx + 1}/${totalBatches}`);
        }

        // Construir array de content com todas as imagens do batch
        const content = [];

        // Adicionar cada imagem do batch
        batchImages.forEach((img) => {
          content.push({
            type: 'image',
            source: {
              type: 'base64',
              media_type: 'image/jpeg',
              data: img.base64
            }
          });
        });

        // Prompt final pedindo extra√ß√£o de TODAS as p√°ginas do batch
        const idioma = aiIntegration.aiSettings?.ocrLanguage === 'por' ? 'Portugu√™s' : 'English';
        // v1.14.1: Validar batchPageNumbers antes de acessar √≠ndices (fix: array vazio)
        const firstPage = batchPageNumbers[0] || 1;
        const lastPage = batchPageNumbers[batchPageNumbers.length - 1] || firstPage;
        content.push({
          type: 'text',
          text: `Extraia TODO o texto de TODAS as ${batchImages.length} imagens acima. S√£o as p√°ginas ${firstPage} a ${lastPage} de um documento legal.

INSTRU√á√ïES IMPORTANTES:
- Processe CADA p√°gina na ordem exata apresentada
- Para CADA p√°gina, inicie com uma linha "--- P√ÅGINA ${firstPage <= 1 ? 'X' : firstPage + ' a ' + lastPage} ---" (substitua X pelo n√∫mero)
- Retorne APENAS o texto extra√≠do, sem coment√°rios ou explica√ß√µes
- Preserve a formata√ß√£o de par√°grafos e estrutura do documento
- Idioma do documento: ${idioma}`
        });

        // Fazer a requisi√ß√£o para o batch inteiro
        const requestBody = {
          model: aiIntegration.aiSettings?.model || 'claude-sonnet-4-20250514',
          max_tokens: MAX_TOKENS,
          messages: [{ role: 'user', content }]
        };

        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: aiIntegration.getApiHeaders(),
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorText = await response.text();

          // Se falhar no primeiro batch, fazer fallback para PDF.js puro
          if (batchIdx === 0) {
            console.warn('‚ö†Ô∏è Fallback para PDF.js puro');
            return await extractTextFromPDFPure(file, progressCallback);
          }

          // Se falhar em batches subsequentes, marcar erro e continuar
          fullText += `\n\n[ERRO: P√°ginas ${startIdx + 1} a ${endIdx} n√£o puderam ser processadas via OCR]\n\n`;
          continue;
        }

        const data = await response.json();
        // v1.20.5: Contabilizar tokens de OCR Claude Vision
        if (data.usage) {
          aiIntegration.logCacheMetrics(data);
        }
        const batchText = data.content?.[0]?.text || '';
        fullText += batchText + '\n\n';
      }

      const finalText = fullText.trim();
      return finalText;

    } catch (err) {
      return await extractTextFromPDFPure(file, progressCallback);
    } finally {
      if (pdf) {
        try { pdf.destroy(); } catch (e) { /* ignore */ }
      }
    }
  }, [loadPDFJS, aiIntegration, extractTextFromPDFPure]);

  // üÜï v1.31: OCR offline com Tesseract.js
  // v1.31.02: Paralelo com Scheduler (pool de workers)
  // v1.31.03: Batching + Workers din√¢micos (75% cores, max 8)
  // v1.32.15: Alta qualidade (SCALE 4.0 + PSM 6)
  const extractTextFromPDFWithTesseract = React.useCallback(async (file, progressCallback = null) => {
    const SCALE = 4.0;  // v1.32.15: M√°xima qualidade OCR
    // 75% dos cores l√≥gicos, m√≠nimo 2, m√°ximo 8
    const NUM_WORKERS = Math.min(Math.max(Math.ceil((navigator.hardwareConcurrency || 4) * 0.75), 2), 8);
    const BATCH_SIZE = NUM_WORKERS;

    let pdf = null;
    let scheduler = null;

    try {
      const [pdfjsLib, Tesseract] = await Promise.all([
        loadPDFJS(),
        loadTesseract()
      ]);

      const arrayBuffer = await file.arrayBuffer();
      pdf = await pdfjsLib.getDocument({
        data: arrayBuffer,
        useSystemFonts: true,
        disableFontFace: true
      }).promise;

      const totalPages = pdf.numPages;

      // 1. Criar scheduler com pool de workers
      if (progressCallback) progressCallback(0, totalPages, `Iniciando ${NUM_WORKERS} workers...`);

      scheduler = Tesseract.createScheduler();
      await Promise.all(
        Array.from({ length: NUM_WORKERS }, async () => {
          const worker = await Tesseract.createWorker('por');
          // v1.32.15: PSM 6 (bloco √∫nico) + preservar espa√ßos
          await worker.setParameters({
            tessedit_pageseg_mode: '6',
            preserve_interword_spaces: '1'
          });
          scheduler.addWorker(worker);
        })
      );

      // 2. Processar em batches (limita mem√≥ria)
      const allResults = [];
      let completed = 0;

      for (let batchStart = 0; batchStart < totalPages; batchStart += BATCH_SIZE) {
        const batchEnd = Math.min(batchStart + BATCH_SIZE, totalPages);
        const batchPages = Array.from(
          { length: batchEnd - batchStart },
          (_, i) => batchStart + i + 1
        );

        // 2a. Renderizar batch de p√°ginas
        const canvases = await Promise.all(
          batchPages.map(async (pageNum) => {
            const page = await pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: SCALE });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const ctx = canvas.getContext('2d');
            await page.render({ canvasContext: ctx, viewport }).promise;
            return { canvas, pageNum };
          })
        );

        // 2b. OCR batch em paralelo
        const batchResults = await Promise.all(
          canvases.map(async ({ canvas, pageNum }) => {
            const { data: { text } } = await scheduler.addJob('recognize', canvas);
            completed++;
            if (progressCallback) progressCallback(completed, totalPages, 'OCR...');
            // Cleanup imediato
            canvas.width = 0;
            canvas.height = 0;
            return { pageNum, text };
          })
        );

        allResults.push(...batchResults);
      }

      // 3. Ordenar e juntar
      allResults.sort((a, b) => a.pageNum - b.pageNum);
      return allResults.map(r => r.text).join('\n\n').trim();

    } catch (err) {
      console.error('[Tesseract OCR] Erro:', err);
      return null;
    } finally {
      if (scheduler) {
        try { await scheduler.terminate(); } catch (e) { /* ignore */ }
      }
      if (pdf) {
        try { pdf.destroy(); } catch (e) { /* ignore */ }
      }
    }
  }, [loadPDFJS, loadTesseract]);

  const extractTextFromPDF = React.useCallback(async (file, progressCallback = null) => {
    const engine = aiIntegration.aiSettings?.ocrEngine || 'pdfjs';

    switch (engine) {
      case 'claude-vision':
        return await extractTextFromPDFWithClaudeVision(file, progressCallback);
      case 'pdf-puro':
        return null;
      default:
        return await extractTextFromPDFPure(file, progressCallback);
    }
  }, [aiIntegration, extractTextFromPDFWithClaudeVision, extractTextFromPDFPure]);

  // üÜï v1.12.20: Extra√ß√£o de texto com modo espec√≠fico (para provas individuais)
  const extractTextFromPDFWithMode = React.useCallback(async (file, mode, progressCallback = null) => {
    // Modos: 'pdfjs' | 'tesseract' | 'claude-vision' | 'pdf-puro'
    switch (mode) {
      case 'pdf-puro':
        return null;
      case 'tesseract':
        return await extractTextFromPDFWithTesseract(file, progressCallback);
      case 'claude-vision':
        return await extractTextFromPDFWithClaudeVision(file, progressCallback);
      case 'pdfjs':
      default:
        return await extractTextFromPDFPure(file, progressCallback);
    }
  }, [extractTextFromPDFWithClaudeVision, extractTextFromPDFPure, extractTextFromPDFWithTesseract]);

  // üî¢ DETEC√á√ÉO DE N√öMERO DO PROCESSO

  const extractProcessoFromFileName = React.useCallback((fileName) => {
    if (!fileName) return null;

    const match = fileName.match(/(AT|ATOrd|RO|RR|AP|AI|MS)?\s*(\d{7}-\d{2}\.\d{4}\.\d\.\d{2}\.\d{4})/);

    if (match) {
      return match[0].trim();
    }

    return null;
  }, []);

  // v1.20.2: Adicionado pdf.destroy() em finally (FIX memory leak)
  const extractProcessoFromFirstPage = React.useCallback(async (file) => {
    if (!file || file.type !== 'application/pdf') return null;

    let pdf = null;
    try {
      const pdfjsLib = await loadPDFJS();
      const arrayBuffer = await file.arrayBuffer();
      // v1.12.15: Desabilita carregamento de fontes externas (evita erro CORS no Claude.ai)
      pdf = await pdfjsLib.getDocument({
        data: arrayBuffer,
        useSystemFonts: true,
        disableFontFace: true
      }).promise;

      const page = await pdf.getPage(1);
      const textContent = await page.getTextContent();
      // v1.14.1: Validar textContent.items
      const items = textContent?.items || [];
      const pageText = items.map(item => item?.str || '').join(' ');

      const match = pageText.match(/(AT|ATOrd|RO|RR|AP|AI|MS)?\s*(\d{7}-\d{2}\.\d{4}\.\d\.\d{2}\.\d{4})/);

      if (match) {
        return match[0].trim();
      }

      return null;
    } catch (err) {
      return null;
    } finally {
      if (pdf) {
        try { pdf.destroy(); } catch (e) { /* ignore */ }
      }
    }
  }, [loadPDFJS]);

  const autoDetectProcessoNumero = React.useCallback(async (files) => {
    try {
      if (files.peticao) {
        const numeroFromPeticao = extractProcessoFromFileName(files.peticao.name);
        if (numeroFromPeticao) {
          return numeroFromPeticao;
        }
      }

      if (files.contestacoes && files.contestacoes.length > 0) {
        const numeroFromContestacao = extractProcessoFromFileName(files.contestacoes[0].name);
        if (numeroFromContestacao) {
          return numeroFromContestacao;
        }
      }

      if (files.complementares && files.complementares.length > 0) {
        for (const comp of files.complementares) {
          const numeroFromComp = extractProcessoFromFileName(comp.name);
          if (numeroFromComp) {
            return numeroFromComp;
          }
        }
      }

      if (files.contestacoes && files.contestacoes.length > 0) {
        const numeroFromPage = await extractProcessoFromFirstPage(files.contestacoes[0]);
        if (numeroFromPage) {
          return numeroFromPage;
        }
      }

      if (files.peticao) {
        const numeroFromPage = await extractProcessoFromFirstPage(files.peticao);
        if (numeroFromPage) {
          return numeroFromPage;
        }
      }

      return null;
    } catch (err) {
      return null;
    }
  }, [extractProcessoFromFileName, extractProcessoFromFirstPage]);

  // üì¶ PROCESSAMENTO EM LOTE

  const extractTextFromBulkFile = React.useCallback(async (file) => {
    const fileType = file.type;
    const fileName = file.name.toLowerCase();

    if (fileType === 'text/plain' || fileName.endsWith('.txt')) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          resolve(text);
        };
        reader.onerror = () => reject(new Error('Erro ao ler arquivo TXT'));
        reader.readAsText(file);
      });
    }

    if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
      try {
        const text = await extractTextFromPDF(file);

        if (!text || text.trim().length < 50) {
          throw new Error('PDF vazio ou texto muito curto');
        }

        return text;
      } catch (err) {
        throw new Error(`Falha ao extrair texto do PDF: ${err.message}`);
      }
    }

    if (fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
        fileType === 'application/msword' ||
        fileName.endsWith('.docx') ||
        fileName.endsWith('.doc')) {
      try {
        const text = await extractTextFromDOCX(file);

        if (!text || text.trim().length < 50) {
          throw new Error('DOCX vazio ou texto muito curto');
        }

        return text;
      } catch (err) {
        throw new Error(`Falha ao extrair texto do DOCX: ${err.message}`);
      }
    }

    throw new Error(`Tipo de arquivo n√£o suportado: ${fileType}`);
  }, [extractTextFromPDF, extractTextFromDOCX]);

  const tryExtractTextFromPDFs = React.useCallback(async (files, callbacks) => {
    const { setExtractingText, setAnalysisProgress, setExtractedTexts, setError } = callbacks;

    setExtractingText(true);
    setAnalysisProgress('üìÑ Extraindo texto dos PDFs...');

    const extracted = {
      peticao: null,
      contestacoes: [],
      complementares: []
    };

    try {
      if (files.peticao) {
        const engine = aiIntegration.aiSettings?.ocrEngine || 'pdfjs';
        const engineLabel = engine === 'claude-vision' ? ' (Claude Vision)' : engine === 'tesseract' ? ' (Tesseract)' : engine === 'pdfjs' ? ' (PDF.js)' : '';
        setAnalysisProgress(`üìÑ Extraindo texto da peti√ß√£o inicial${engineLabel}...`);

        try {
          const text = await extractTextFromPDF(files.peticao, (page, total) => {
            setAnalysisProgress(`üîç Peti√ß√£o inicial: p√°gina ${page}/${total}${engineLabel}...`);
          });

          if (text && text.length > 100) {
            extracted.peticao = text;
          } else {
          }
        } catch (err) {
        }
      }

      if (files.contestacoes && files.contestacoes.length > 0) {
        const engine = aiIntegration.aiSettings?.ocrEngine || 'pdfjs';
        const engineLabel = engine === 'claude-vision' ? ' (Claude Vision)' : engine === 'tesseract' ? ' (Tesseract)' : engine === 'pdfjs' ? ' (PDF.js)' : '';
        for (let i = 0; i < files.contestacoes.length; i++) {
          try {
            setAnalysisProgress(`üìë Extraindo texto da contesta√ß√£o ${i + 1}/${files.contestacoes.length}${engineLabel}...`);
            const text = await extractTextFromPDF(files.contestacoes[i], (page, total) => {
              setAnalysisProgress(`üîç Contesta√ß√£o ${i + 1}: p√°gina ${page}/${total}${engineLabel}...`);
            });

            if (text && text.length > 100) {
              extracted.contestacoes.push({ text, name: `Contesta√ß√£o ${i + 1}` });
            } else {
              extracted.contestacoes.push(null);
            }
          } catch (err) {
            extracted.contestacoes.push(null);
          }
        }
      }

      if (files.complementares && files.complementares.length > 0) {
        const engine = aiIntegration.aiSettings?.ocrEngine || 'pdfjs';
        const engineLabel = engine === 'claude-vision' ? ' (Claude Vision)' : engine === 'tesseract' ? ' (Tesseract)' : engine === 'pdfjs' ? ' (PDF.js)' : '';
        for (let i = 0; i < files.complementares.length; i++) {
          try {
            setAnalysisProgress(`üìé Extraindo texto do documento complementar ${i + 1}/${files.complementares.length}${engineLabel}...`);
            const text = await extractTextFromPDF(files.complementares[i], (page, total) => {
              setAnalysisProgress(`üîç Documento ${i + 1}: p√°gina ${page}/${total}${engineLabel}...`);
            });

            if (text && text.length > 100) {
              const fileName = files.complementares[i].name || `Documento Complementar ${i + 1}`;
              extracted.complementares.push({ text, name: fileName });
            } else {
              extracted.complementares.push(null);
            }
          } catch (err) {
            extracted.complementares.push(null);
          }
        }
      }

      setExtractedTexts(extracted);
      return extracted;
    } catch (err) {
      setError('Erro durante extra√ß√£o de texto. Usando PDFs originais.');
      return extracted;
    } finally {
      setExtractingText(false);
    }
  }, [aiIntegration, extractTextFromPDF]);

  return {
    loadPDFJS,
    loadMammoth,
    extractTextFromPDFPure,
    extractTextFromDOCX,
    extractTextFromPDFWithClaudeVision,
    extractTextFromPDFWithTesseract,  // üÜï v1.31
    extractTextFromPDF,
    extractTextFromPDFWithMode,  // üÜï v1.12.20
    extractProcessoFromFileName,
    extractProcessoFromFirstPage,
    autoDetectProcessoNumero,
    extractTextFromBulkFile,
    tryExtractTextFromPDFs
  };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ü§ñ SE√á√ÉO 7: AI_PROMPTS
// v1.35.26: AI_PROMPTS movido para src/prompts/ai-prompts.js (~820 linhas extra√≠das)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚öñÔ∏è SE√á√ÉO 8: LEGALDECISIONEDITOR
// Componente principal da aplica√ß√£o (~13.000 linhas)
// Cont√©m: reorderTopicsViaLLM, handleAnalyzeDocuments, analyzeProof, generateDispositivo
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// üì¶ COMPONENTE PRINCIPAL: LegalDecisionEditor
// v1.34.1: Adicionado props receivedModels e clearReceivedModels para merge de sync
const LegalDecisionEditor = ({ onLogout, cloudSync, receivedModels, activeSharedLibraries, clearReceivedModels }) => {

  // üé£ CUSTOM HOOKS
  const { modals, openModal, closeModal, closeAllModals, isAnyModalOpen, textPreview, setTextPreview } = useModalManager();
  const aiIntegration = useAIIntegration();
  const featureFlags = useFeatureFlags();
  const indexedDB = useIndexedDB();   const apiCache = useAPICache(50, 5 * 60 * 1000); // üöÄ v1.8.2: Cache de API (50 entradas, TTL 5min)
  const storage = useLocalStorage();
  const modelLibrary = useModelLibrary();

  // v1.35.1: Merge modelos recebidos do servidor (AP√ìS IndexedDB carregar)
  // IMPORTANTE: Modelos compartilhados s√£o SUBSTITU√çDOS (n√£o mesclados) para refletir exclus√µes do propriet√°rio
  // v1.35.1: Extrair apenas as propriedades necess√°rias para evitar re-renders desnecess√°rios
  const { models: libraryModels, setModels: setLibraryModels, isLoadingModels } = modelLibrary;
  const { isAvailable: indexedDBAvailable, saveModels: saveToIndexedDB } = indexedDB;

  // v1.35.4: Usar ref para libraryModels evitando depend√™ncia circular no useEffect abaixo
  // Antes: libraryModels estava nas deps do effect, mas o effect chamava setLibraryModels(),
  // causando loop infinito de re-renders que congelava a UI durante digita√ß√£o
  const libraryModelsRef = React.useRef(libraryModels);
  libraryModelsRef.current = libraryModels;

  React.useEffect(() => {
    // Esperar IndexedDB terminar de carregar antes de fazer merge
    if (isLoadingModels || !indexedDBAvailable) {
      return;
    }

    // v1.35.4: Usar ref para evitar depend√™ncia circular
    const currentLibraryModels = libraryModelsRef.current;

    // v1.35.1: Executar merge se recebeu modelos OU se tem modelos compartilhados locais que podem ter sido deletados
    const hasLocalSharedModels = currentLibraryModels.some(m => m.isShared);
    if (receivedModels && (receivedModels.length > 0 || hasLocalSharedModels)) {
      console.log(`[Sync] Merge: ${receivedModels.length} do servidor + ${currentLibraryModels.length} locais (${hasLocalSharedModels ? 'tem' : 'sem'} compartilhados locais)`);

      // v1.35.1: Separar modelos pr√≥prios dos compartilhados
      // v1.35.21: Tamb√©m separar compartilhados locais para preservar quando servidor n√£o retorna
      const localOwnModels = currentLibraryModels.filter(m => !m.isShared);
      const localSharedModels = currentLibraryModels.filter(m => m.isShared);
      const serverOwnModels = receivedModels.filter(m => !m.isShared);
      const serverSharedModels = receivedModels.filter(m => m.isShared);

      // Merge apenas para modelos PR√ìPRIOS
      const merged = new Map(localOwnModels.map(m => [m.id, m]));
      for (const serverModel of serverOwnModels) {
        if (serverModel.deletedAt) {
          merged.delete(serverModel.id);
        } else {
          const local = merged.get(serverModel.id);
          if (!local || new Date(serverModel.updatedAt) > new Date(local.updatedAt || 0)) {
            merged.set(serverModel.id, serverModel);
          }
        }
      }

      // v1.35.24: Filtrar compartilhados locais por owners que ainda t√™m acesso ativo
      // Isso resolve B8b: quando share √© removido, modelos desse owner s√£o exclu√≠dos no pr√≥ximo sync
      const activeOwnerIds = new Set((activeSharedLibraries || []).map(lib => lib.ownerId));
      const validLocalSharedModels = localSharedModels.filter(m => activeOwnerIds.has(m.ownerId));

      if (localSharedModels.length !== validLocalSharedModels.length) {
        console.log(`[Sync] Removidos ${localSharedModels.length - validLocalSharedModels.length} modelos de owners sem acesso`);
      }

      // v1.35.21: Preservar compartilhados locais (validados) se servidor n√£o retornou nenhum
      // Isso evita perder modelos quando sync incremental n√£o retorna compartilhados
      // (porque nenhum foi atualizado desde lastSyncAt)
      // Quando servidor retorna compartilhados, substituir completamente (para refletir exclus√µes)
      const finalSharedModels = serverSharedModels.length > 0
        ? serverSharedModels  // Servidor retornou compartilhados ‚Üí substituir
        : validLocalSharedModels;  // Servidor n√£o retornou ‚Üí preservar apenas de owners v√°lidos

      // Combinar: modelos pr√≥prios mesclados + compartilhados (servidor ou locais preservados)
      const mergedModels = [...Array.from(merged.values()), ...finalSharedModels];
      console.log(`[Sync] Merge resultado: ${merged.size} pr√≥prios + ${finalSharedModels.length} compartilhados (${serverSharedModels.length > 0 ? 'servidor' : 'local'}) = ${mergedModels.length} total`);

      // Atualizar state
      setLibraryModels(mergedModels);

      // v1.34.7: Salvar IMEDIATAMENTE no IndexedDB (n√£o esperar debounce)
      saveToIndexedDB(mergedModels).then(() => {
        localStorage.setItem('sentencify-models-count', String(mergedModels.length));
        console.log(`[Sync] Salvo ${mergedModels.length} modelos no IndexedDB`);
      }).catch(err => {
        console.error('[Sync] Erro ao salvar no IndexedDB:', err);
      });

      clearReceivedModels();
    }
  }, [receivedModels, activeSharedLibraries, clearReceivedModels, setLibraryModels, isLoadingModels, indexedDBAvailable, saveToIndexedDB]);
  // ‚Üë v1.35.4: Removido libraryModels das deps - usamos libraryModelsRef para evitar loop
  // ‚Üë v1.35.24: Adicionado activeSharedLibraries para filtrar owners revogados

  // ü§ñ v1.19.0: Chat interativo do assistente IA (Editor Individual)
  const chatAssistant = useChatAssistant(aiIntegration);

  // üìú v1.24: Versionamento de campos (Editor Individual)
  const fieldVersioning = useFieldVersioning();

  // ‚òÅÔ∏è v1.35.40: Google Drive - Salvar/Carregar projetos
  const googleDrive = useGoogleDrive();
  const [driveFilesModalOpen, setDriveFilesModalOpen] = React.useState(false);
  const [driveFiles, setDriveFiles] = React.useState([]);

  // ü™Ñ v1.35.69: Gerador de Modelo a partir de Exemplos
  const [modelGeneratorModal, setModelGeneratorModal] = React.useState({
    isOpen: false,
    targetField: null // 'modeloRelatorio' | 'modeloDispositivo' | 'modeloTopicoRelatorio'
  });

  const openModelGenerator = React.useCallback((targetField) => {
    setModelGeneratorModal({ isOpen: true, targetField });
  }, []);

  const closeModelGenerator = React.useCallback(() => {
    setModelGeneratorModal({ isOpen: false, targetField: null });
  }, []);

  const handleModelGenerated = React.useCallback((generatedPrompt) => {
    const { targetField } = modelGeneratorModal;
    if (targetField) {
      aiIntegration.setAiSettings(prev => ({
        ...prev,
        [targetField]: generatedPrompt
      }));
    }
    setModelGeneratorModal({ isOpen: false, targetField: null });
  }, [modelGeneratorModal.targetField, aiIntegration.setAiSettings]);

  const getHardcodedPrompt = React.useCallback((targetField) => {
    const prompts = {
      modeloRelatorio: AI_PROMPTS.instrucoesRelatorioMiniPadrao || '',
      modeloDispositivo: AI_PROMPTS.instrucoesDispositivoPadrao || '',
      modeloTopicoRelatorio: AI_PROMPTS.instrucoesRelatorioPadrao || ''
    };
    return prompts[targetField] || '';
  }, []);

  // üìÑ v1.9.12: Servi√ßos de Processamento de Documentos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const documentServices = useDocumentServices(aiIntegration);

  const proofManager = useProofManager(documentServices);   const documentManager = useDocumentManager();   const topicManager = useTopicManager();   const modelPreview = useModelPreview(); // Preview de modelos sugeridos

  // v1.13.9: Ref para auto-save debounced no Editor Individual
  const individualAutoSaveTimerRef = React.useRef(null);

  // v1.13.9: Auto-save com debounce no Editor Individual
  React.useEffect(() => {
    const editingTopic = topicManager.editingTopic;
    if (!editingTopic) return;

    // Limpar timer anterior
    if (individualAutoSaveTimerRef.current) {
      clearTimeout(individualAutoSaveTimerRef.current);
    }

    // Debounce: aguardar 3s antes de sincronizar
    individualAutoSaveTimerRef.current = setTimeout(() => {
      // Sincronizar editingTopic ‚Üí selectedTopics
      topicManager.setSelectedTopics(prev =>
        prev.map(t => t.title === editingTopic.title ? { ...t, ...editingTopic } : t)
      );
      topicManager.setExtractedTopics(prev =>
        prev.map(t => t.title === editingTopic.title ? { ...t, ...editingTopic } : t)
      );
    }, AUTO_SAVE_DEBOUNCE_MS);

    return () => {
      if (individualAutoSaveTimerRef.current) {
        clearTimeout(individualAutoSaveTimerRef.current);
      }
    };
  }, [topicManager.editingTopic]);

  // v1.13.9: Detectar se h√° mudan√ßas n√£o salvas no Editor Individual
  // v1.35.3: Extrair valores primitivos para evitar rec√°lculo desnecess√°rio a cada keystroke
  // Nota: n√£o declarar editingTopic aqui pois j√° √© destructured de topicManager mais abaixo (linha ~19820)
  const editingTopicTitle = topicManager.editingTopic?.title;
  const editingTopicFundamentacao = topicManager.editingTopic?.editedFundamentacao;
  const editingTopicRelatorio = topicManager.editingTopic?.editedRelatorio;
  const editingTopicContent = topicManager.editingTopic?.editedContent;
  const editingTopicCategory = topicManager.editingTopic?.category;

  const isIndividualDirty = React.useMemo(() => {
    if (!editingTopicTitle) return false;

    const original = topicManager.selectedTopics.find(t => t.title === editingTopicTitle);
    if (!original) return false;

    // Comparar campos edit√°veis
    return (
      editingTopicFundamentacao !== original.editedFundamentacao ||
      editingTopicRelatorio !== original.editedRelatorio ||
      editingTopicContent !== original.editedContent ||
      editingTopicCategory !== original.category
    );
  }, [editingTopicTitle, editingTopicFundamentacao, editingTopicRelatorio, editingTopicContent, editingTopicCategory, topicManager.selectedTopics]);

  // üìè v1.10.13: Hooks de configura√ß√£o global de editor (para Quick Edit)
  const { spacing, setSpacing } = useSpacingControl();
  const { fontSize, setFontSize } = useFontSizeControl();

  // üîí v1.9.5: Sistema de Lock de Aba Prim√°ria ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const primaryTabLock = usePrimaryTabLock();

  // üíì v1.33.31: Heartbeat keepalive (evita Render free tier dormir)
  const HEARTBEAT_INTERVAL = 10 * 60 * 1000; // 10 minutos
  React.useEffect(() => {
    // S√≥ ativa em produ√ß√£o
    if (!import.meta.env.PROD) return;

    const keepAlive = async () => {
      try {
        await fetch(`${API_BASE}/api/health`, { method: 'GET' });
      } catch (err) {
        // Silencioso - servidor pode estar acordando
      }
    };

    // Primeiro heartbeat imediato (acorda servidor se dormindo)
    keepAlive();

    // Heartbeats peri√≥dicos
    const interval = setInterval(keepAlive, HEARTBEAT_INTERVAL);

    return () => clearInterval(interval);
  }, []);

  // üé® v1.9.13: Sistema de Tema Claro/Escuro GLOBAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [appTheme, setAppTheme] = React.useState(() =>
    localStorage.getItem('sentencify-app-theme') || 'dark'
  );

  // Aplicar tema no documento e salvar no localStorage
  React.useEffect(() => {
    // Aplicar data-theme no HTML root para CSS Variables
    document.documentElement.setAttribute('data-theme', appTheme);
    // Persistir no localStorage
    localStorage.setItem('sentencify-app-theme', appTheme);
  }, [appTheme]);

  // Toggle tema global
  const toggleAppTheme = React.useCallback(() => {
    setAppTheme(prev => prev === 'dark' ? 'light' : 'dark');
  }, []);

  // v1.32.24: Modal de changelog
  const [showChangelogModal, setShowChangelogModal] = React.useState(false);

  // Alias para compatibilidade com editores Quill existentes
  const editorTheme = appTheme;
  const toggleEditorTheme = toggleAppTheme;

  // üíæ PERSIST√äNCIA AUTOM√ÅTICA: Load/Save modelos (v1.7)

  // Ref para garantir que load s√≥ execute UMA VEZ
  const hasLoadedModelsRef = React.useRef(false);

  // Ref para rastrear √∫ltimo array de models salvo (otimiza√ß√£o de performance)
  const lastSavedModelsRef = React.useRef(null);

  // üöÄ OTIMIZA√á√ÉO v1.7: Fast hash ao inv√©s de JSON.stringify (FASE 1.2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Hash r√°pido baseado apenas em IDs e timestamps (~1ms vs 50-200ms stringify)
  const modelsHashRef = React.useRef(null);

  const fastHash = React.useCallback((str) => {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash |= 0; // Convert to 32bit integer
    }
    return hash.toString(36);
  }, []);

  // Calcular hash dos modelos (apenas IDs + timestamps, n√£o conte√∫do completo)
  const currentModelsHash = React.useMemo(() => {
    if (modelLibrary.models.length === 0) return 'empty';

    // Signature baseada em metadados (r√°pido)
    const signature = modelLibrary.models
      .map(m => `${m.id}-${m.updatedAt || m.createdAt || ''}`)
      .join('|');

    return fastHash(signature);
  }, [modelLibrary.models, fastHash]); // üêõ BUGFIX: models completo (detecta edi√ß√µes), n√£o s√≥ length

  // üöÄ OTIMIZA√á√ÉO v1.7: Auto-save com dirty tracking (FASE 1.1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [autoSaveDirty, setAutoSaveDirty] = React.useState(false);
  const lastAutoSaveSnapshotRef = React.useRef(null);
  const autoSaveTimerRef = React.useRef(null);

  // v1.12.28: Ref para snapshot atualizado (evita stale closure no auto-save)
  const currentSessionSnapshotRef = React.useRef(null);

  // Helper: marcar sess√£o como dirty (needs save)
  const markSessionDirty = React.useCallback(() => {
    setAutoSaveDirty(true);
  }, []);

  // üöÄ OTIMIZA√á√ÉO v1.7 (FASE 1.3): Batch DOM updates para evitar m√∫ltiplos reflows
  // Antes: 3 innerHTML = 3 reflows (~300ms total)
  // Depois: 1 RAF batch = 1 reflow (~100ms)
  const batchDOMUpdates = React.useCallback((updates) => {
    requestAnimationFrame(() => {
      updates.forEach(({ ref, content, property = 'innerHTML' }) => {
        if (!ref || !ref.current) return;

        try {
          // Suporta refs diretos ou Quill refs (com .root)
          const element = ref.current.root || ref.current;

          if (property === 'innerHTML') {
            element.innerHTML = content;
          } else if (property === 'innerText') {
            element.innerText = content;
          } else if (property === 'textContent') {
            element.textContent = content;
          }
        } catch (err) {
        }
      });
    });
  }, []);

  // üîÑ MULTI-TAB SYNC: Registrar callback (v1.7 BUGFIX) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Refs para evitar closure stale (sempre acessar vers√£o mais recente)
  const indexedDBRef = React.useRef(indexedDB);
  const modelLibraryRef = React.useRef(modelLibrary);
  const featureFlagsRef = React.useRef(featureFlags);

  // Atualizar refs quando os objetos mudarem
  React.useEffect(() => {
    indexedDBRef.current = indexedDB;
    modelLibraryRef.current = modelLibrary;
    featureFlagsRef.current = featureFlags;
  }, [indexedDB, modelLibrary, featureFlags]);

  React.useEffect(() => {
    // Registrar callback para receber notifica√ß√µes de sync de outras tabs
    const handleSync = async ({ action, timestamp }) => {

      // Usar refs para acessar vers√£o sempre atualizada (evitar closure stale)
      const currentIndexedDB = indexedDBRef.current;
      const currentModelLibrary = modelLibraryRef.current;
      const currentFeatureFlags = featureFlagsRef.current;

      // Skip if IndexedDB feature flag is disabled
      if (!currentFeatureFlags.isEnabled('useIndexedDB')) {
        return;
      }

      // Skip if IndexedDB n√£o est√° dispon√≠vel
      if (!currentIndexedDB.isAvailable) {
        return;
      }

      try {
        // Recarregar modelos do IndexedDB (cache j√° foi invalidado pelo hook)
        const reloadedModels = await currentIndexedDB.loadModels();


        // Atualizar state React com modelos sincronizados
        currentModelLibrary.setModels(reloadedModels);

        // Atualizar ref para evitar save loop
        lastSavedModelsRef.current = JSON.stringify(reloadedModels);

      } catch (err) {
        currentModelLibrary.setPersistenceError(`Erro ao sincronizar com outra tab: ${err.message}`);
      }
    };

    // Registrar callback no hook useIndexedDB
    indexedDB.setSyncCallback(handleSync);


    // Cleanup: remover callback
    return () => {
      indexedDB.setSyncCallback(null);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); // ‚ö†Ô∏è Array vazio OK: handleSync usa refs (sempre atualizadas) ao inv√©s de closure

  // Load Models no mount
  React.useEffect(() => {
    // Skip if already loaded
    if (hasLoadedModelsRef.current) {
      return;
    }

    // Skip if IndexedDB feature flag is disabled
    if (!featureFlags.isEnabled('useIndexedDB')) {
      return;
    }

    // Wait for IndexedDB to be initialized (isAvailable becomes true AFTER dbInstance is ready)
    if (!indexedDB.isAvailable) {
      return;
    }

    let isMounted = true;

    const loadModelsFromStorage = async () => {
      modelLibrary.setIsLoadingModels(true);
      modelLibrary.setPersistenceError(null);

      try {
        const loadedModels = await indexedDB.loadModels();

        if (isMounted && loadedModels && loadedModels.length > 0) {
          modelLibrary.setModels(loadedModels);
          hasLoadedModelsRef.current = true; // Marcar como carregado
        } else if (isMounted) {
          hasLoadedModelsRef.current = true; // Marcar como carregado mesmo se vazio
        }
      } catch (err) {
        if (isMounted) {
          modelLibrary.setPersistenceError(err.message);
        }
      } finally {
        if (isMounted) {
          modelLibrary.setIsLoadingModels(false);
        }
      }
    };

    loadModelsFromStorage();

    return () => {
      isMounted = false;
    };
  }, [indexedDB.isAvailable]); // Only re-run when IndexedDB becomes available

  // Save Models quando mudarem (v1.7 FASE 1.2: hash ao inv√©s de stringify)
  React.useEffect(() => {
    // Skip if IndexedDB feature flag is disabled
    if (!featureFlags.isEnabled('useIndexedDB')) {
      return;
    }

    // Skip if IndexedDB is not available
    if (!indexedDB.isAvailable) {
      return;
    }

    // Skip if currently loading (to avoid save loop)
    if (modelLibrary.isLoadingModels) {
      return;
    }

    // Skip first load when models is empty array (not yet loaded)
    if (modelLibrary.models.length === 0 && !hasLoadedModelsRef.current) {
      return;
    }

    // üöÄ OTIMIZA√á√ÉO v1.7 (FASE 1.2): Hash comparison ao inv√©s de JSON.stringify
    // Antes: JSON.stringify(100 models) = 50-200ms de bloqueio
    // Depois: Hash apenas IDs+timestamps = ~1ms
    const lastHash = modelsHashRef.current;

    if (currentModelsHash === lastHash) {
      // Nenhuma mudan√ßa real detectada, skip save
      return;
    }

    // Debounce save to avoid excessive writes
    const timeoutId = setTimeout(async () => {
      try {
        await indexedDB.saveModels(modelLibrary.models);

        // v1.34.6: Salvar contagem para sync comparar com servidor
        localStorage.setItem('sentencify-models-count', String(modelLibrary.models.length));

        // Atualizar ref com hash atual
        modelsHashRef.current = currentModelsHash;

        modelLibrary.setPersistenceError(null);
      } catch (err) {
        modelLibrary.setPersistenceError(err.message);
      }
    }, 1500); // üöÄ v1.8.1: 1500ms debounce (-20% saves em edi√ß√µes r√°pidas)

    return () => clearTimeout(timeoutId);
  }, [currentModelsHash, modelLibrary.isLoadingModels]); // Hash ao inv√©s de models array

  // üé® ESTADOS: Navega√ß√£o e UI
  const [activeTab, setActiveTab] = useState('upload');
  const [toast, setToast] = useState({ show: false, message: '', type: 'success' }); // 'success', 'error', 'info'
  const [error, setError] = useState('');
  const [copySuccess, setCopySuccess] = useState(false);
  const copyTimeoutRef = React.useRef(null);
  const [modelSaved, setModelSaved] = useState(false);
  const [savingModel, setSavingModel] = useState(false); // v1.27.02: Feedback visual durante gera√ß√£o de embedding
  const [savingFromSimilarity, setSavingFromSimilarity] = useState(false); // v1.33.3: Feedback no modal de similaridade

  // v1.17.0: Estados para modal de anonimiza√ß√£o (nomes inseridos pelo usu√°rio)
  const [showAnonymizationModal, setShowAnonymizationModal] = useState(false);
  const [anonymizationNamesText, setAnonymizationNamesText] = useState('');

  // v1.35.30: Estados para modal de curadoria de t√≥picos (pr√©-gera√ß√£o de mini-relat√≥rios)
  const [showTopicCurationModal, setShowTopicCurationModal] = useState(false);
  const [pendingCurationData, setPendingCurationData] = useState(null);

  // v1.21.14: Sincronizar nomes do modal com aiSettings persistido
  useEffect(() => {
    const nomesUsuario = aiIntegration?.aiSettings?.anonymization?.nomesUsuario;
    if (Array.isArray(nomesUsuario) && nomesUsuario.length > 0) {
      setAnonymizationNamesText(nomesUsuario.join('\n'));
    }
  }, [aiIntegration?.aiSettings?.anonymization?.nomesUsuario]);

  // v1.15.3: Estado para Slash Menu (acesso r√°pido a modelos com /)
  const [slashMenu, setSlashMenu] = React.useState({
    isOpen: false,
    position: { top: 0, left: 0 },
    searchTerm: '',
    selectedIndex: 0,
    quillInstance: null,
    triggerPosition: 0
  });

  // v1.21.21: Estados para revis√£o cr√≠tica de senten√ßa
  const [reviewScope, setReviewScope] = useState('decisionOnly');
  const [reviewResult, setReviewResult] = useState('');
  const [generatingReview, setGeneratingReview] = useState(false);

  // Scroll autom√°tico para o topo quando aparecer erro
  useEffect(() => {
    if (error) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }, [error]);

  // Cleanup de timeout do copySuccess para evitar memory leak
  useEffect(() => {
    return () => {
      if (copyTimeoutRef.current) clearTimeout(copyTimeoutRef.current);
    };
  }, []);

  // üìÇ DESTRUCTURING: useDocumentManager & useTopicManager (v1.2.7)
  const {
    // Documentos - Estados
    peticaoFiles, contestacaoFiles, complementaryFiles,
    pastedPeticaoTexts, pastedContestacaoTexts, pastedComplementaryTexts,
    analyzedDocuments,
    analyzing, analysisProgress, extractingText, showPasteArea, extractedTexts, showTextPreview,
    // v1.12.18: Modos de processamento por documento
    documentProcessingModes,
    // Documentos - Setters
    setPeticaoFiles, setContestacaoFiles, setComplementaryFiles,
    setPastedPeticaoTexts, setPastedContestacaoTexts, setPastedComplementaryTexts,
    setAnalyzedDocuments,
    setAnalyzing, setAnalysisProgress, setExtractingText, setShowPasteArea, setExtractedTexts, setShowTextPreview,
    // v1.12.18: Setters de modos de processamento
    setDocumentProcessingModes, setPeticaoMode, setContestacaoMode, setComplementarMode,
    // Documentos - Handlers
    handlePastedText, removePastedText, removePeticaoFile,
    handleUploadPeticao, handleUploadContestacao, handleUploadComplementary,
    // Documentos - Persist√™ncia (com alias para evitar conflito)
    serializeForPersistence: serializeDocuments,
    restoreFromPersistence: restoreDocuments,
    clearAll: clearDocuments
  } = documentManager;

  const {
    // T√≥picos - Estados
    extractedTopics, selectedTopics,
    editingTopic, lastEditedTopicTitle, topicContextScope,
    savingTopic,
    topicToDelete, topicToRename, newTopicName, topicsToMerge, topicToSplit, splitNames, newTopicData,
    // T√≥picos - Setters
    setExtractedTopics, setSelectedTopics,
    setEditingTopic, setLastEditedTopicTitle, setTopicContextScope,
    setSavingTopic,
    setTopicToDelete, setTopicToRename, setNewTopicName, setTopicsToMerge, setTopicToSplit, setSplitNames, setNewTopicData
    // ‚ö†Ô∏è NOTA: Handlers de t√≥picos (prepareDeleteTopic, confirmDeleteTopic, etc.)
    // permanecem no componente principal pois dependem de modals e l√≥gica complexa
    // N√£o fazemos destructuring deles para evitar conflitos
  } = topicManager;

  // üÜï v1.12.18: Helper para determinar modo padr√£o baseado nas configura√ß√µes globais
  // v1.12.22: Simplificado - agora usa diretamente ocrEngine (pdfjs | pdf-puro | claude-vision)
  // v1.12.25: Removido autoExtractPDFText - usa apenas ocrEngine
  const getDefaultProcessingMode = React.useCallback(() => {
    return aiIntegration.aiSettings?.ocrEngine || 'pdfjs';
  }, [aiIntegration.aiSettings.ocrEngine]);

  // üîÑ v1.9.1: HASHES para detectar edi√ß√µes (n√£o apenas add/remove)

  // Hash de extractedTopics (detecta edi√ß√µes de campos)
  // v1.13.8: Usar fastHashUtil no texto completo (n√£o apenas preview)
  const extractedTopicsHash = React.useMemo(() => {
    if (!extractedTopics || extractedTopics.length === 0) return 'empty';

    try {
      const signature = extractedTopics
        .map((t, idx) => {
          const id = t?.id || '';
          const title = t?.title || '';
          const category = t?.category || '';
          const resultado = t?.resultado || '';
          // v1.13.8: Hash do conte√∫do completo para detectar qualquer mudan√ßa
          const contentHash = fastHashUtil(t?.content || '');
          const fundamentacaoHash = fastHashUtil(t?.fundamentacao || '');
          const editedFundHash = fastHashUtil(t?.editedFundamentacao || '');
          const editedRelHash = fastHashUtil(t?.editedRelatorio || '');
          const editedContentHash = fastHashUtil(t?.editedContent || '');
          return `${idx}:${id}-${title}-${category}-${contentHash}-${fundamentacaoHash}-${editedFundHash}-${editedRelHash}-${editedContentHash}-${resultado}`;
        })
        .join('||');

      return fastHashUtil(signature);
    } catch (err) {
      return 'error';
    }
  }, [extractedTopics]);

  // Hash de selectedTopics
  // v1.13.8: Usar fastHashUtil no texto completo (n√£o apenas preview)
  const selectedTopicsHash = React.useMemo(() => {
    if (!selectedTopics || selectedTopics.length === 0) return 'empty';

    try {
      const signature = selectedTopics
        .map((t, idx) => {
          const id = t?.id || '';
          const title = t?.title || '';
          const category = t?.category || '';
          const resultado = t?.resultado || '';
          // v1.13.8: Hash do conte√∫do completo para detectar qualquer mudan√ßa
          const contentHash = fastHashUtil(t?.content || '');
          const fundamentacaoHash = fastHashUtil(t?.fundamentacao || '');
          const editedFundHash = fastHashUtil(t?.editedFundamentacao || '');
          const editedRelHash = fastHashUtil(t?.editedRelatorio || '');
          const editedContentHash = fastHashUtil(t?.editedContent || '');
          return `${idx}:${id}-${title}-${category}-${contentHash}-${fundamentacaoHash}-${editedFundHash}-${editedRelHash}-${editedContentHash}-${resultado}`;
        })
        .join('||');

      return fastHashUtil(signature);
    } catch (err) {
      return 'error';
    }
  }, [selectedTopics]);

  // Hash de provas (detecta edi√ß√µes)
  const proofsHash = React.useMemo(() => {
    try {
      const proofFilesSig = (proofManager.proofFiles || [])
        .map(p => `${p?.id || ''}-${p?.name || ''}-${p?.size || 0}`)
        .join('|');

      const proofTextsSig = (proofManager.proofTexts || [])
        .map(p => {
          const id = p?.id || '';
          const name = p?.name || '';
          const text = p?.text || '';
          const textPreview = typeof text === 'string' ? text.substring(0, 50) : '';
          return `${id}-${name}-${textPreview}`;
        })
        .join('|');

      const extractedTexts = proofManager.extractedProofTexts || {};
      const extractedSig = Object.keys(extractedTexts)
        .map(id => {
          const text = extractedTexts[id] || '';
          const textPreview = typeof text === 'string' ? text.substring(0, 50) : '';
          return `${id}-${textPreview}`;
        })
        .join('|');

      // v1.13.5: Incluir conclus√µes no hash para detectar edi√ß√µes
      const conclusions = proofManager.proofConclusions || {};
      const conclusionsSig = Object.keys(conclusions)
        .map(id => {
          const text = conclusions[id] || '';
          const textPreview = typeof text === 'string' ? text.substring(0, 50) : '';
          return `${id}-${textPreview}`;
        })
        .join('|');

      // v1.13.5: Incluir v√≠nculos prova-t√≥pico no hash para detectar altera√ß√µes
      const topicLinks = proofManager.proofTopicLinks || {};
      const topicLinksSig = Object.keys(topicLinks)
        .map(id => {
          const links = topicLinks[id] || [];
          return `${id}:[${links.join(',')}]`;
        })
        .join('|');

      // v1.13.5: Incluir resultados de an√°lise IA no hash
      const analysisResults = proofManager.proofAnalysisResults || {};
      const analysisResultsSig = Object.keys(analysisResults)
        .map(id => {
          const analysis = analysisResults[id] || {};
          const type = analysis.type || '';
          const result = analysis.result || '';
          const resultPreview = typeof result === 'string' ? result.substring(0, 50) : '';
          return `${id}:${type}:${resultPreview}`;
        })
        .join('|');

      // v1.19.2: Incluir flags de modo PDF e enviar conte√∫do completo
      const pdfModeSig = JSON.stringify(proofManager.proofUsePdfMode || {});
      const sendFullContentSig = JSON.stringify(proofManager.proofSendFullContent || {});
      const signature = `${proofFilesSig}||${proofTextsSig}||${extractedSig}||${conclusionsSig}||${topicLinksSig}||${analysisResultsSig}||${pdfModeSig}||${sendFullContentSig}`;
      return fastHashUtil(signature);
    } catch (err) {
      return 'error';
    }
  }, [
    proofManager.proofFiles,
    proofManager.proofTexts,
    proofManager.extractedProofTexts,
    proofManager.proofConclusions,   // v1.13.5: Detectar edi√ß√µes nas conclus√µes
    proofManager.proofTopicLinks,    // v1.13.5: Detectar altera√ß√µes nos v√≠nculos
    proofManager.proofAnalysisResults, // v1.13.5: Detectar resultados de an√°lise IA
    proofManager.proofUsePdfMode,      // v1.19.2: Detectar mudan√ßas no modo PDF
    proofManager.proofSendFullContent  // v1.19.2: Detectar mudan√ßas na flag enviar conte√∫do completo
  ]);

  // v1.13.6: Hash para detectar mudan√ßas em Upload (arquivos, extractedTexts, documentProcessingModes)
  const uploadHash = React.useMemo(() => {
    try {
      // v1.13.7: Incluir arquivos PDF selecionados no hash (compat√≠vel com formato {file, id})
      const peticaoFilesSig = peticaoFiles.map((f, i) => `${i}:${f?.file?.name || f?.name || ''}:${f?.file?.size || f?.size || 0}`).join('|');
      const contestacaoFilesSig = contestacaoFiles.map((f, i) => `${i}:${f?.file?.name || f?.name || ''}:${f?.file?.size || f?.size || 0}`).join('|');
      const complementaryFilesSig = complementaryFiles.map((f, i) => `${i}:${f?.file?.name || f?.name || ''}:${f?.file?.size || f?.size || 0}`).join('|');

      // extractedTexts: { peticoes: [{text, name}], contestacoes: [{text, name}], complementares: [{text, name}] }
      const peticoesText = (extractedTexts?.peticoes || [])
        .map((c, i) => `${i}:${(c?.text || '').substring(0, 50)}`)
        .join('|');

      const contestacoesText = (extractedTexts?.contestacoes || [])
        .map((c, i) => {
          const text = c?.text || '';
          return `${i}:${text.substring(0, 50)}`;
        })
        .join('|');

      const complementaresText = (extractedTexts?.complementares || [])
        .map((c, i) => {
          const text = c?.text || '';
          return `${i}:${text.substring(0, 50)}`;
        })
        .join('|');

      // documentProcessingModes: { peticoes: string[], contestacoes: string[], complementares: string[] }
      const peticoesModes = (documentProcessingModes?.peticoes || []).join(',');
      const contestacoesModes = (documentProcessingModes?.contestacoes || []).join(',');
      const complementaresModes = (documentProcessingModes?.complementares || []).join(',');

      // v1.13.7: Signature inclui arquivos + textos extra√≠dos + modos
      const signature = `${peticaoFilesSig}||${contestacaoFilesSig}||${complementaryFilesSig}||${peticoesText}||${contestacoesText}||${complementaresText}||${peticoesModes}||${contestacoesModes}||${complementaresModes}`;
      return fastHashUtil(signature);
    } catch (err) {
      return 'error';
    }
  }, [peticaoFiles, contestacaoFiles, complementaryFiles, extractedTexts, documentProcessingModes]);

  // üñ±Ô∏è ESTADOS: Drag & Drop
  const [draggedIndex, setDraggedIndex] = useState(null);
  const [dragOverIndex, setDragOverIndex] = useState(null);
  const [draggedComplementaryIndex, setDraggedComplementaryIndex] = useState(null);
  const [dragOverComplementaryIndex, setDragOverComplementaryIndex] = useState(null);

  // üíæ ESTADOS: Sess√£o e Persist√™ncia
  const [partesProcesso, setPartesProcesso] = useState({ reclamante: '', reclamadas: [] });

  // üìù ESTADOS: Editor de Texto Rico
  const [exportedText, setExportedText] = useState('');
  const [exportedHtml, setExportedHtml] = useState('');
    
  // üìã ESTADO: Informa√ß√µes do Processo (v1.3.5.1)
  const [processoNumero, setProcessoNumero] = useState('');
  // N√∫mero do processo trabalhista (ex: ATOrd 0000313-98.2025.5.08.0110)

  // üîß ESTADOS: Utilit√°rios
  const [domPurifyReady, setDomPurifyReady] = useState(false);
  const [quillReady, setQuillReady] = useState(false);
  const [quillError, setQuillError] = useState(null);
  const [quillRetryCount, setQuillRetryCount] = useState(0);

  // üß† v1.32.00: ESTADOS: IA Offline (NER)
  const [nerFilesStored, setNerFilesStored] = useState([]); // Legado - n√£o mais usado
  const [nerModelReady, setNerModelReady] = useState(false);
  const [nerInitializing, setNerInitializing] = useState(false);
  const [nerDownloadProgress, setNerDownloadProgress] = useState(0);
  const [detectingNames, setDetectingNames] = useState(false);
  // v1.32.00: Toggle master para NER
  const [nerEnabled, setNerEnabled] = useState(() => {
    try { return JSON.parse(localStorage.getItem('nerEnabled')) || false; } catch { return false; }
  });
  // v1.29: Estado para incluir ORG (empresas) na detec√ß√£o
  const [nerIncludeOrg, setNerIncludeOrg] = useState(() => {
    try { return JSON.parse(localStorage.getItem('nerIncludeOrg')) || false; } catch { return false; }
  });

  // üîç v1.26.00: ESTADOS: Busca Sem√¢ntica (E5-base)
  const [searchFilesStored, setSearchFilesStored] = useState([]);
  const [searchModelReady, setSearchModelReady] = useState(false);
  const [searchInitializing, setSearchInitializing] = useState(false);
  const [searchDownloadProgress, setSearchDownloadProgress] = useState(0);
  const [embeddingsCount, setEmbeddingsCount] = useState(0);
  const [embeddingsProgress, setEmbeddingsProgress] = useState({ current: 0, total: 0 });
  // v1.28.00: Toggle MASTER que controla carregamento do modelo E5
  const [searchEnabled, setSearchEnabled] = useState(() => {
    try {
      // Migra√ß√£o: se searchEnabled n√£o existe, usa semanticSearchEnabled como fallback
      const stored = localStorage.getItem('searchEnabled');
      if (stored !== null) return JSON.parse(stored);
      return JSON.parse(localStorage.getItem('semanticSearchEnabled')) || false;
    } catch { return false; }
  });
  // v1.35.74: semanticSearchEnabled, semanticThreshold, jurisSemanticEnabled, jurisSemanticThreshold
  // movidos para aiSettings (agora em aiIntegration.aiSettings.X)
  const [jurisEmbeddingsCount, setJurisEmbeddingsCount] = useState(0);
  const [jurisEmbeddingsProgress, setJurisEmbeddingsProgress] = useState({ current: 0, total: 0 });
  const jurisEmbeddingsFileInputRef = useRef(null);

  // üåê v1.33.0: Estados para download autom√°tico de embeddings via CDN
  const [showEmbeddingsDownloadModal, setShowEmbeddingsDownloadModal] = useState(false);
  const [embeddingsDownloadStatus, setEmbeddingsDownloadStatus] = useState({
    legislacao: { needed: null, downloading: false, progress: 0, error: null },
    jurisprudencia: { needed: null, downloading: false, progress: 0, error: null }
  });
  const [dismissedEmbeddingsPrompt, setDismissedEmbeddingsPrompt] = useState(() => {
    try { return JSON.parse(localStorage.getItem('dismissedEmbeddingsPrompt')) || false; } catch { return false; }
  });

  // üì• v1.33.61: Estados para download autom√°tico de DADOS (legisla√ß√£o e jurisprud√™ncia)
  const [showDataDownloadModal, setShowDataDownloadModal] = useState(false);
  const [dataDownloadStatus, setDataDownloadStatus] = useState({
    legislacao: { needed: null, downloading: false, progress: 0, error: null, completed: false },
    jurisprudencia: { needed: null, downloading: false, progress: 0, error: null, completed: false }
  });
  const [dismissedDataPrompt, setDismissedDataPrompt] = useState(() => {
    try { return JSON.parse(localStorage.getItem('dismissedDataPrompt')) || false; } catch { return false; }
  });

  // üì¶ v1.27.01: Estados para busca sem√¢ntica de MODELOS (embeddings inline)
  // v1.35.74: modelSemanticEnabled, modelSemanticThreshold, useLocalAIForSuggestions
  // movidos para aiSettings (agora em aiIntegration.aiSettings.X)
  const [generatingModelEmbeddings, setGeneratingModelEmbeddings] = useState(false);
  const [modelEmbeddingsProgress, setModelEmbeddingsProgress] = useState({ current: 0, total: 0 });
  // v1.32.18: Jurisprud√™ncia via IA Local nos editores
  // v1.35.74: useLocalAIForJuris movido para aiSettings

  // v1.33.19: Toggle para busca sem√¢ntica na busca manual de modelos (editores individual e global)
  // v1.33.20: Inicializa com modelSemanticEnabled (respeitando config IA)
  // v1.35.74: Agora usa aiIntegration.aiSettings.modelSemanticEnabled
  const [useSemanticManualSearch, setUseSemanticManualSearch] = useState(() => aiIntegration.aiSettings.modelSemanticEnabled);

  // v1.35.75: Feedback inline nos bot√µes de teste de API Key
  const [claudeTestStatus, setClaudeTestStatus] = useState(null); // null | 'testing' | 'ok' | 'error'
  const [geminiTestStatus, setGeminiTestStatus] = useState(null);
  const [semanticManualSearchResults, setSemanticManualSearchResults] = useState(null);
  const [semanticManualSearching, setSemanticManualSearching] = useState(false);

  // üìú v1.26.02: Hook de legisla√ß√£o para gera√ß√£o de embeddings
  const legislacao = useLegislacao();

  // üéØ REFS
  const bulkFileInputRef = useRef(null);
  const bulkEditorRef = useRef(null);
  const editorRef = useRef(null);
  const modelEditorRef = useRef(null);
  const modelFormRef = useRef(null);
  const relatorioRef = useRef(null);
  const fileInputRef = useRef(null);
  const topicRefs = useRef({});
  const editorContainerRef = useRef(null);

  // v1.20.2: Cleanup de refs de t√≥picos removidos para evitar memory leak
  const cleanupTopicRefs = React.useCallback((currentTitles) => {
    const titles = new Set(currentTitles);
    Object.keys(topicRefs.current).forEach(title => {
      if (!titles.has(title)) delete topicRefs.current[title];
    });
  }, []);

  // ‚ö° EFFECTS

  // üîÑ v1.9 FASE 2: Implementar reloadSessionFromStorage com todos os setters
  React.useEffect(() => {
    // Redefinir reloadSessionFromStorage com acesso aos setters
    const reloadImpl = async () => {
      try {

        await storage.restoreSession({
          setPastedPeticaoTexts,
          setPastedContestacaoTexts,
          setPastedComplementaryTexts,
          setExtractedTopics,
          setSelectedTopics,
          setPartesProcesso,
          setAnalyzedDocuments,
          // v1.13.7: Adicionar setters de arquivos de Upload para restaurar PDFs do IndexedDB
          setPeticaoFiles,
          setContestacaoFiles,
          setComplementaryFiles,
          setExtractedTexts,
          setDocumentProcessingModes,
          setProofFiles: proofManager.setProofFiles,
          setProofTexts: proofManager.setProofTexts,
          setProofUsePdfMode: proofManager.setProofUsePdfMode,
          setExtractedProofTexts: proofManager.setExtractedProofTexts,
          setProofExtractionFailed: proofManager.setProofExtractionFailed,
          setProofTopicLinks: proofManager.setProofTopicLinks,
          setProofAnalysisResults: proofManager.setProofAnalysisResults,
          setProofConclusions: proofManager.setProofConclusions,
          setActiveTab,
          closeModal,
          setError,
          setProcessoNumero,
          setTokenMetrics: aiIntegration.setTokenMetrics // v1.20.3: Contador de tokens
        });


        // Atualizar ref para refletir novo estado
        localStateRef.current.lastSaveTimestamp = Date.now();
      } catch (err) {
        setError('Erro ao sincronizar com outra aba: ' + err.message);
      }
    };

    // Substituir o placeholder vazio
    if (typeof window !== 'undefined') {
      window.__reloadSessionFromStorage = reloadImpl;
    }
  }, [
    storage,
    setPastedPeticaoTexts, setPastedContestacaoTexts, setPastedComplementaryTexts,
    setExtractedTopics, setSelectedTopics, setPartesProcesso, setAnalyzedDocuments,
    proofManager, setActiveTab, closeModal, setError, setProcessoNumero
  ]);

  useEffect(() => {
    // Verificar se j√° est√° carregado
    if (window.DOMPurify) {
      setDomPurifyReady(true);
      return;
    }

    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js';
    script.async = true;
    script.onload = () => {
      setDomPurifyReady(true);
    };
    script.onerror = () => {
    };

    document.head.appendChild(script);

    return () => {
      if (script.parentNode) {
        script.parentNode.removeChild(script);
      }
    };
  }, []);

  // v1.33.19: Effect para busca sem√¢ntica manual de modelos
  useEffect(() => {
    if (!useSemanticManualSearch || !searchModelReady || !modelLibrary.manualSearchTerm || modelLibrary.manualSearchTerm.trim().length < 2) {
      setSemanticManualSearchResults(null);
      return;
    }

    const timeoutId = setTimeout(async () => {
      setSemanticManualSearching(true);
      try {
        const results = await searchModelsBySimilarity(modelLibrary.models, modelLibrary.manualSearchTerm.toLowerCase(), { threshold: 0.3, limit: 10 });
        setSemanticManualSearchResults(results);
        // Tamb√©m atualizar os resultados no modelLibrary para exibi√ß√£o
        modelLibrary.setManualSearchResults(results);
      } catch (error) {
        console.error('[ModelSearch] Erro na busca sem√¢ntica:', error);
        setSemanticManualSearchResults(null);
      }
      setSemanticManualSearching(false);
    }, 300);

    return () => clearTimeout(timeoutId);
  }, [useSemanticManualSearch, modelLibrary.manualSearchTerm, searchModelReady, modelLibrary.models]);

  // üé® Fun√ß√£o para injetar estilos do Quill (dark theme)
  const injectQuillStyles = () => {
    const styleId = 'quill-dark-theme-styles';

    // SEMPRE remover estilos antigos (se existirem) para garantir atualiza√ß√£o
    const existingStyle = document.getElementById(styleId);
    if (existingStyle) {
      existingStyle.remove();
    }
    const style = document.createElement('style');
    style.id = styleId;
    style.textContent = `
      /* Quill Dark Theme - SentencifyAI (Injetado Globalmente) */
      .ql-toolbar.ql-snow {
        border: none !important;
        border-bottom: 1px solid rgb(71, 85, 105) !important;
        background: rgba(51, 65, 85, 0.95) !important;
        padding: 8px !important;
        position: sticky !important;
        top: 0 !important;
        z-index: 10 !important;
        /* v1.9.31: backdrop-filter removido - causa lag */
      }

      /* √çcones da toolbar - Tamanho e cores */
      .ql-toolbar.ql-snow button {
        width: 28px !important;
        height: 24px !important;
        padding: 3px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      .ql-toolbar.ql-snow button svg {
        width: 18px !important;
        height: 18px !important;
      }

      .ql-toolbar.ql-snow .ql-stroke {
        stroke: rgb(203, 213, 225) !important;
        stroke-width: 2 !important;
      }

      .ql-toolbar.ql-snow .ql-fill {
        fill: rgb(203, 213, 225) !important;
      }

      .ql-toolbar.ql-snow .ql-picker {
        color: rgb(203, 213, 225) !important;
      }

      .ql-toolbar.ql-snow .ql-picker-label {
        color: rgb(203, 213, 225) !important;
        border-color: rgb(100, 116, 139) !important;
      }

      .ql-toolbar.ql-snow button:hover,
      .ql-toolbar.ql-snow button.ql-active {
        background: rgb(71, 85, 105) !important;
      }

      .ql-toolbar.ql-snow .ql-picker-options {
        background: rgb(51, 65, 85) !important;
        border-color: rgb(100, 116, 139) !important;
      }

      .ql-toolbar.ql-snow .ql-picker-item:hover {
        background: rgb(71, 85, 105) !important;
        color: rgb(241, 245, 249) !important;
      }

      .ql-container.ql-snow {
        border: none !important;
        background: rgb(30, 41, 59) !important;
      }

      .ql-editor {
        background-color: rgb(30, 41, 59) !important;
        color: rgb(241, 245, 249) !important;
        min-height: 300px !important;
        max-height: 60vh !important;
        overflow: auto !important;
        padding: 16px !important;
        font-size: 14px !important;
        line-height: 1.35 !important;  /* v1.5.11: Reduzido de 1.6 para fix espa√ßamento duplo entre par√°grafos */
        resize: vertical !important;
        display: block !important;
      }

      .ql-editor p {
        margin-bottom: 0.25em !important;  /* v1.5.11: Espa√ßamento sutil para apar√™ncia de quebra √∫nica */
      }

      /* Negrito destacado em laranja no dark mode */
      .ql-editor strong,
      .ql-editor b {
        color: #fb923c !important;
        font-weight: 700 !important;
      }

      .ql-editor.ql-blank::before {
        color: rgb(148, 163, 184) !important;
        font-style: italic !important;
      }

      .ql-editor ul {
        list-style-type: disc !important;
        padding-left: 2rem !important;
        margin: 1rem 0 !important;
      }

      .ql-editor ol {
        list-style-type: decimal !important;
        padding-left: 2rem !important;
        margin: 1rem 0 !important;
      }

      /* Indenta√ß√£o de par√°grafos - usando margin-left para melhor compatibilidade */
      .ql-editor .ql-indent-1 {
        margin-left: 3em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-2 {
        margin-left: 6em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-3 {
        margin-left: 9em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-4 {
        margin-left: 12em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-5 {
        margin-left: 15em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-6 {
        margin-left: 18em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-7 {
        margin-left: 21em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-8 {
        margin-left: 24em !important;
        padding-left: 0 !important;
      }

      /* Espa√ßamento de Par√°grafos - Compacto */
      .spacing-compact .ql-editor,
      .spacing-compact[contenteditable] {
        line-height: 1.2 !important;
      }
      .spacing-compact .ql-editor p,
      .spacing-compact[contenteditable] p {
        margin-bottom: 0.15em !important;
      }

      /* Normal: line-height 1.35, margin 0.25em (padr√£o atual) */
      .spacing-normal .ql-editor,
      .spacing-normal[contenteditable] {
        line-height: 1.35 !important;
      }
      .spacing-normal .ql-editor p,
      .spacing-normal[contenteditable] p {
        margin-bottom: 0.25em !important;
      }

      /* Confort√°vel: line-height 1.6, margin 0.5em */
      .spacing-comfortable .ql-editor,
      .spacing-comfortable[contenteditable] {
        line-height: 1.6 !important;
      }
      .spacing-comfortable .ql-editor p,
      .spacing-comfortable[contenteditable] p {
        margin-bottom: 0.5em !important;
      }

      /* Amplo: line-height 2.0, margin 1.0em */
      .spacing-wide .ql-editor,
      .spacing-wide[contenteditable] {
        line-height: 2.0 !important;
      }
      .spacing-wide .ql-editor p,
      .spacing-wide[contenteditable] p {
        margin-bottom: 1.0em !important;
      }

      /* Tamanho de Fonte - Normal */
      .fontsize-normal .ql-editor,
      .fontsize-normal[contenteditable] {
        font-size: 14px !important;
      }

      /* Maior: 16px */
      .fontsize-larger .ql-editor,
      .fontsize-larger[contenteditable] {
        font-size: 16px !important;
      }

      /* Grande: 18px */
      .fontsize-largest .ql-editor,
      .fontsize-largest[contenteditable] {
        font-size: 18px !important;
      }

      /* Hover effect para SpacingDropdown (CSS hover, n√£o Tailwind) */
      .hover-border-blue-500:hover:not(:disabled) {
        border-color: #3b82f6 !important;
      }

      .ql-editor h1 {
        font-size: 2rem !important;
        font-weight: bold !important;
        margin: 1rem 0 !important;
        color: rgb(241, 245, 249) !important;
      }

      .ql-editor h2 {
        font-size: 1.5rem !important;
        font-weight: bold !important;
        margin: 0.75rem 0 !important;
        color: rgb(241, 245, 249) !important;
      }

      .ql-editor h3 {
        font-size: 1.25rem !important;
        font-weight: bold !important;
        margin: 0.5rem 0 !important;
        color: rgb(241, 245, 249) !important;
      }

      .ql-editor a {
        color: rgb(96, 165, 250) !important;
        text-decoration: underline !important;
      }

      .ql-editor blockquote {
        border-left: 4px solid rgb(100, 116, 139) !important;
        padding-left: 1rem !important;
        margin: 1rem 0 !important;
        color: rgb(203, 213, 225) !important;
        font-style: italic !important;
      }
    `;

    document.head.appendChild(style);
  };

  // üåû Quill Light Theme Styles
  const injectQuillLightStyles = () => {
    // Remover estilo antigo para garantir atualiza√ß√£o
    const existingStyle = document.getElementById('quill-light-theme-styles');
    if (existingStyle) existingStyle.remove();

    const style = document.createElement('style');
    style.id = 'quill-light-theme-styles';
    style.innerHTML = `
      /* Quill Light Theme - SentencifyAI (CSS Granular) */

      /* Container: fundo bege */
      .quill-light-theme .ql-container.ql-snow {
        background-color: #fefcf3 !important;
        border: none !important;
      }

      /* √Årea de edi√ß√£o: fundo bege, texto escuro */
      .quill-light-theme .ql-editor {
        background-color: #fefcf3 !important;
        color: #292524 !important; /* Stone 800 */
      }

      /* Sobrescreve par√°grafos e textos espec√≠ficos */
      .quill-light-theme .ql-editor p,
      .quill-light-theme .ql-editor span,
      .quill-light-theme .ql-editor li,
      .quill-light-theme .ql-editor div {
        color: #292524 !important; /* Stone 800 */
      }

      /* Sobrescreve t√≠tulos */
      .quill-light-theme .ql-editor h1,
      .quill-light-theme .ql-editor h2,
      .quill-light-theme .ql-editor h3,
      .quill-light-theme .ql-editor h4,
      .quill-light-theme .ql-editor h5,
      .quill-light-theme .ql-editor h6 {
        color: #1c1917 !important; /* Stone 900 */
      }

      /* Sobrescreve elementos de formata√ß√£o */
      .quill-light-theme .ql-editor strong,
      .quill-light-theme .ql-editor b {
        color: #000000 !important;
        font-weight: 700 !important;
      }

      .quill-light-theme .ql-editor u {
        text-decoration-color: #000000 !important;
      }

      /* Sobrescreve links */
      .quill-light-theme .ql-editor a {
        color: #2563eb !important; /* Blue 600 */
      }

      /* Sobrescreve blockquotes */
      .quill-light-theme .ql-editor blockquote {
        border-left: 4px solid #d6d3d1 !important; /* Stone 300 */
        color: #57534e !important; /* Stone 600 */
      }

      /* Placeholder */
      .quill-light-theme .ql-editor.ql-blank::before {
        color: #a8a29e !important; /* Stone 400 */
        font-style: italic !important;
      }

      /* v1.9.17: Toolbar - Tema Claro (Stone) */
      .quill-light-theme .ql-toolbar.ql-snow {
        background: #f5f5f4 !important;
        border-bottom: 1px solid #d6d3d1 !important;
      }

      /* √çcones da toolbar - cor escura */
      .quill-light-theme .ql-toolbar.ql-snow .ql-stroke {
        stroke: #57534e !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow .ql-fill {
        fill: #57534e !important;
      }

      /* Picker (dropdowns) */
      .quill-light-theme .ql-toolbar.ql-snow .ql-picker {
        color: #44403c !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow .ql-picker-label {
        color: #44403c !important;
        border-color: #a8a29e !important;
      }

      /* Dropdown aberto - fundo azul claro, texto preto */
      .quill-light-theme .ql-toolbar.ql-snow .ql-picker-options {
        background: #dbeafe !important;
        border-color: #93c5fd !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow .ql-picker-item {
        color: #000000 !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow .ql-picker-item:hover {
        background: #bfdbfe !important;
        color: #000000 !important;
      }

      /* Hover nos bot√µes */
      .quill-light-theme .ql-toolbar.ql-snow button:hover,
      .quill-light-theme .ql-toolbar.ql-snow button.ql-active {
        background: #e7e5e3 !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow button:hover .ql-stroke,
      .quill-light-theme .ql-toolbar.ql-snow button.ql-active .ql-stroke {
        stroke: #1c1917 !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow button:hover .ql-fill,
      .quill-light-theme .ql-toolbar.ql-snow button.ql-active .ql-fill {
        fill: #1c1917 !important;
      }
    `;

    document.head.appendChild(style);
  };

  // üìù Quill.js Loader (FASE 4 - Rich Text Editor)
  useEffect(() => {
    const MAX_RETRIES = 3;
    const RETRY_DELAY = 2000; // 2 segundos
    let styleDelayTimeout = null;
    let retryTimeout = null;
    let isMounted = true;

    // Verificar se j√° existe script carregando/carregado
    const existingScript = document.getElementById('quill-library-js');
    const existingCSS = document.getElementById('quill-theme-css');

    // Se Quill j√° est√° dispon√≠vel e scripts existem, apenas inicializar estilos
    if (window.Quill && existingScript && existingCSS) {
      styleDelayTimeout = setTimeout(() => {
        if (isMounted) {
          injectQuillStyles();
          injectQuillLightStyles();
          setQuillReady(true);
          setQuillError(null);
        }
      }, 100);
      return () => { isMounted = false; if (styleDelayTimeout) clearTimeout(styleDelayTimeout); };
    }

    // Remover scripts antigos apenas se n√£o houver Quill ativo
    if (!window.Quill) {
      if (existingScript) existingScript.remove();
      if (existingCSS) existingCSS.remove();
    }

    // Carregar CSS primeiro
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css';
    link.id = 'quill-theme-css';

    link.onerror = () => {
      if (isMounted) setQuillError('Falha ao carregar tema do editor');
    };

    document.head.appendChild(link);

    // Carregar JavaScript
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js';
    script.async = true;
    script.id = 'quill-library-js';

    script.onload = () => {
      if (!isMounted) return;
      if (window.Quill) {
        styleDelayTimeout = setTimeout(() => {
          if (isMounted) {
            injectQuillStyles();
            injectQuillLightStyles();
            setQuillReady(true);
            setQuillError(null);
          }
        }, 100);
      } else {
        setQuillError('Biblioteca carregada mas n√£o dispon√≠vel');
      }
    };

    script.onerror = () => {
      if (!isMounted) return;
      if (quillRetryCount < MAX_RETRIES) {
        retryTimeout = setTimeout(() => {
          if (isMounted) setQuillRetryCount(prev => prev + 1);
        }, RETRY_DELAY);
      } else {
        setQuillError(`Falha ao carregar editor ap√≥s ${MAX_RETRIES} tentativas. Verifique sua conex√£o.`);
      }
    };

    document.head.appendChild(script);

    // Cleanup
    return () => {
      isMounted = false;
      if (styleDelayTimeout) clearTimeout(styleDelayTimeout);
      if (retryTimeout) clearTimeout(retryTimeout);
    };
  }, [quillRetryCount]);

  useEffect(() => {
        // loadAiSettings() agora est√° dentro do hook useAIIntegration

        if (primaryTabLock.isPrimaryTab) {
      storage.checkSavedSession(openModal);
    }
  }, [primaryTabLock.isPrimaryTab]);

  
  // Resetar p√°gina de modelos quando filtros/busca mudarem
  useEffect(() => {
    modelLibrary.setCurrentModelPage(1);
  }, [modelLibrary.searchTerm, modelLibrary.selectedCategory, modelLibrary.showFavoritesOnly]);

  // üöÄ OTIMIZA√á√ÉO v1.4.1: Agrupar useEffects relacionados (keyboard + scroll management)
  useEffect(() => {
    // Atalho Ctrl+S para salvar
    const handleKeyDown = (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (editingTopic) {
          saveTopicEditWithoutClosing();
        } else if (modals.modelForm) {
          saveModelWithoutClosing();
        }
      }
    };

    document.addEventListener('keydown', handleKeyDown);

    return () => {
      document.removeEventListener('keydown', handleKeyDown);
    };
  }, [editingTopic, modals.modelForm]);

  // ESC para fechar modal de configura√ß√µes
  React.useEffect(() => {
    const handleEscape = (e) => {
      if (e.key === 'Escape' && modals.settings) {
        closeModal('settings');
      }
    };

    if (modals.settings) {
      window.addEventListener('keydown', handleEscape);
    }

    return () => window.removeEventListener('keydown', handleEscape);
  }, [modals.settings, closeModal]);

  // v1.35.64: Bloquear scroll do body quando modal de configura√ß√µes aberto
  React.useEffect(() => {
    if (modals.settings) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => {
        document.body.style.overflow = originalOverflow;
      };
    }
  }, [modals.settings]);

  // üöÄ OTIMIZA√á√ÉO v1.7: Observer para marcar dirty (FASE 1.1) - DEPS REDUZIDAS
  // üîÑ v1.9.1: Agora usa HASHES para detectar edi√ß√µes de campos (n√£o apenas add/remove)
  // Observa apenas valores primitivos (strings, numbers) ao inv√©s de objetos/arrays completos
  // Isso reduz drasticamente re-renders (primitive comparison vs deep comparison)
  useEffect(() => {
    // Marca como dirty quando qualquer estado cr√≠tico mudar
    // Este effect √© LEVE (apenas seta flag booleana, n√£o faz save)
    // v1.13.7: Incluir arquivos de Upload na condi√ß√£o
    if (extractedTopics.length > 0 || selectedTopics.length > 0 ||
        proofManager.proofFiles.length > 0 || proofManager.proofTexts.length > 0 ||
        peticaoFiles.length > 0 || contestacaoFiles.length > 0 || complementaryFiles.length > 0 ||
        aiIntegration.tokenMetrics.requestCount > 0) {
      markSessionDirty();
      // üö´ v1.9.5: DESABILITADO - Timestamp de edi√ß√£o n√£o mais usado (sync removido)
      // localStateRef.current.lastLocalEditTimestamp = Date.now();
    }
  }, [
    processoNumero,
    pastedPeticaoTexts?.length || 0,
    extractedTopicsHash,  // ‚úÖ Detecta mudan√ßas em t√≠tulo, conte√∫do, categoria
    selectedTopicsHash,   // ‚úÖ Detecta mudan√ßas em t√≠tulo, conte√∫do, categoria
    proofsHash,           // ‚úÖ Detecta mudan√ßas em provas (files, texts, extracted)
    uploadHash,           // v1.13.6: Detecta mudan√ßas em Upload (extractedTexts, documentProcessingModes)
    // Outros lengths (n√£o precisam de hash pois s√£o simples)
    pastedContestacaoTexts?.length || 0,
    pastedComplementaryTexts?.length || 0,
    analyzedDocuments?.length || 0,
    partesProcesso?.reclamante || '',
    partesProcesso?.reclamado || '',
    aiIntegration.tokenMetrics.requestCount,  // v1.22.01: Persistir tokens ao contabilizar
    markSessionDirty
  ]);

  // v1.12.28: Manter snapshot atualizado para evitar stale closures no auto-save
  // Este useEffect roda a cada render e atualiza o ref com os valores atuais
  // Assim, o setTimeout dentro do auto-save sempre acessa dados frescos via ref
  React.useEffect(() => {
    currentSessionSnapshotRef.current = {
      processoNumero,
      pastedPeticaoTexts,
      pastedContestacaoTexts,
      pastedComplementaryTexts,
      extractedTopics,
      selectedTopics,
      partesProcesso,
      activeTab,
      analyzedDocuments,
      // v1.13.5: Incluir extractedTexts para n√£o perder textos de Upload
      extractedTexts,
      // v1.13.6: Incluir modos de processamento de Upload
      documentProcessingModes,
      // v1.13.7: Indicador de arquivos de Upload (para decidir se deve salvar sess√£o)
      hasUploadFiles: !!(peticaoFiles.length > 0 || contestacaoFiles.length > 0 || complementaryFiles.length > 0),
      // v1.20.3: Arquivos de Upload (para autoSaveSession)
      peticaoFiles,
      contestacaoFiles,
      complementaryFiles,
      proofFiles: proofManager.proofFiles,
      proofTexts: proofManager.proofTexts,
      proofUsePdfMode: proofManager.proofUsePdfMode,
      proofSendFullContent: proofManager.proofSendFullContent, // v1.19.2: Persistir flag enviar conte√∫do completo
      extractedProofTexts: proofManager.extractedProofTexts,
      proofExtractionFailed: proofManager.proofExtractionFailed,
      proofTopicLinks: proofManager.proofTopicLinks,
      proofAnalysisResults: proofManager.proofAnalysisResults,
      proofConclusions: proofManager.proofConclusions,
      // v1.20.3: Contador de tokens persistente
      tokenMetrics: aiIntegration.tokenMetrics
    };
  });

  // üöÄ OTIMIZA√á√ÉO v1.7: Auto-save quando dirty (FASE 1.1) - Pesado, mas s√≥ roda quando flag muda
  // Separa√ß√£o: Observer (leve) marca dirty ‚Üí Este effect (pesado) faz o save
  // Benef√≠cio: Save com debounce n√£o recria a cada mudan√ßa de estado
  useEffect(() => {
    // üîí v1.9.5: PROTE√á√ÉO - Apenas aba prim√°ria pode salvar sess√£o
    if (!primaryTabLock.isPrimaryTab) {
      setAutoSaveDirty(false);
      return;
    }

    // Skip se n√£o est√° dirty
    if (!autoSaveDirty) return;

    // v1.12.28: Usar ref para verifica√ß√£o (evita stale closure)
    const currentSnapshot = currentSessionSnapshotRef.current;

    // Skip se n√£o h√° dados para salvar
    // v1.13.7: Incluir verifica√ß√£o de arquivos de Upload
    if (!currentSnapshot ||
        ((currentSnapshot.extractedTopics?.length || 0) === 0 &&
         (currentSnapshot.selectedTopics?.length || 0) === 0 &&
         (currentSnapshot.proofFiles?.length || 0) === 0 &&
         (currentSnapshot.proofTexts?.length || 0) === 0 &&
         !currentSnapshot.hasUploadFiles)) {
      setAutoSaveDirty(false);
      return;
    }

    // Limpar timer anterior
    if (autoSaveTimerRef.current) {
      clearTimeout(autoSaveTimerRef.current);
    }

    // Debounce: aguardar 3s antes de salvar
    // v1.12.28: Usar ref para snapshot (evita stale closure - bug das provas sumindo)
    autoSaveTimerRef.current = setTimeout(() => {
      const snapshot = currentSessionSnapshotRef.current;
      if (!snapshot) return;

      // Comparar com √∫ltimo snapshot (evitar saves duplicados)
      const currentJson = JSON.stringify(snapshot);
      if (currentJson !== lastAutoSaveSnapshotRef.current) {
        storage.autoSaveSession(snapshot, setError);
        lastAutoSaveSnapshotRef.current = currentJson;
      }

      // Limpar dirty flag
      setAutoSaveDirty(false);
    }, AUTO_SAVE_DEBOUNCE_MS);

    return () => {
      if (autoSaveTimerRef.current) {
        clearTimeout(autoSaveTimerRef.current);
      }
    };
  }, [autoSaveDirty, primaryTabLock.isPrimaryTab]); // üîí v1.9.5: + lock para proteger save


  // üõ†Ô∏è FUN√á√ïES UTILIT√ÅRIAS

  React.useEffect(() => {
    const handleBeforeUnload = (e) => {
      const skipBeforeunload = sessionStorage.getItem('sentencify-skip-beforeunload');
      if (skipBeforeunload) {
        sessionStorage.removeItem('sentencify-skip-beforeunload');
        return; // Sair sem salvar
      }

      // üî• SAVE FOR√áADO: Salvar modelos imediatamente no IndexedDB antes de sair
      if (modelLibrary.models.length > 0 && indexedDB.isSupported) {
        try {
          // üöÄ OTIMIZA√á√ÉO v1.7 (FASE 1.2): Hash comparison ao inv√©s de JSON.stringify
          // Evita bloquear main thread por 50-200ms no beforeunload
          const lastHash = modelsHashRef.current;

          if (currentModelsHash !== lastHash) {
            // ‚ö†Ô∏è NOTA: IndexedDB √© ass√≠ncrono, mas tentamos salvar aqui
            // O navegador pode ou n√£o aguardar a opera√ß√£o completar
            // Por isso mantemos tamb√©m o auto-save com debounce
            indexedDB.saveModels(modelLibrary.models).catch(err => {
            });

            // Atualizar ref imediatamente (otimista)
            modelsHashRef.current = currentModelsHash;

          } else {
          }
        } catch (err) {
        }
      }

      // ‚ÑπÔ∏è AVISO OPCIONAL: Pode ser removido j√° que temos persist√™ncia autom√°tica
      // Mantido apenas como lembrete de que exporta√ß√£o √© recomendada
      // (N√£o bloqueia a sa√≠da da p√°gina)
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [currentModelsHash, indexedDB.isSupported]); // Hash ao inv√©s de models array

  // Persist√™ncia e Sess√£o
  const checkSavedSession = () => {
    try {
      const saved = localStorage.getItem('sentencifySession');
      if (saved) {
        const session = JSON.parse(saved);
        setSessionLastSaved(session.savedAt);
        openModal('restoreSession');
      }
    } catch (err) {
    }
  };


  // üîí Sanitiza√ß√£o com DOMPurify (memoizada)
  const sanitizeHTML = React.useCallback((dirty) => {
    // Se DOMPurify n√£o estiver carregado ainda, retorna string vazia para seguran√ßa
    if (!domPurifyReady || !window.DOMPurify) {
      return ''; // Mais seguro retornar vazio do que conte√∫do n√£o sanitizado
    }

    // Configura√ß√£o de sanitiza√ß√£o para permitir apenas tags seguras de formata√ß√£o
    const cleanHTML = window.DOMPurify.sanitize(dirty, {
      ALLOWED_TAGS: [
        'p', 'br', 'div', 'span',           // Estrutura
        'strong', 'b', 'em', 'i', 'u',      // Formata√ß√£o b√°sica
        'ul', 'ol', 'li',                    // Listas
        'h1', 'h2', 'h3', 'h4', 'h5', 'h6'  // Cabe√ßalhos
      ],
      ALLOWED_ATTR: [
        'class', 'id', 'style'               // Atributos permitidos (limitados)
      ],
      ALLOWED_STYLES: {
        '*': {
          'font-weight': [/^bold$/],
          'font-style': [/^italic$/],
          'text-decoration': [/^underline$/]
        }
      },
      KEEP_CONTENT: true,                     // Preserva conte√∫do de tags removidas
      RETURN_TRUSTED_TYPE: false
    });

    return cleanHTML;
  }, [domPurifyReady]); // ‚úÖ Est√°vel - s√≥ muda quando DOMPurify carrega

  // üìù Utility functions para Quill.js (movidas para escopo global)

  // Fun√ß√£o de teste de sanitiza√ß√£o (dispon√≠vel no console via window.testSanitization)
  const testSanitization = (testHTML) => {
    const sanitized = sanitizeHTML(testHTML);
    return sanitized;
  };

  // Expor fun√ß√£o de teste no console (desenvolvimento)
  if (typeof window !== 'undefined') {
    window.testSanitization = testSanitization;
    window.checkDOMPurify = () => ({
      loaded: domPurifyReady,
      available: !!window.DOMPurify,
      version: window.DOMPurify?.version || 'Desconhecida'
    });
  }

  // üß† v1.25: NER HANDLERS - IA Offline para detec√ß√£o de nomes

  // Ref para garantir inicializa√ß√£o √∫nica (prote√ß√£o contra StrictMode/re-renders)
  const nerInitStartedRef = useRef(false);

  // Verificar arquivos do modelo NER + auto-inicializar se anonimiza√ß√£o ativa
  const anonymizationEnabled = aiIntegration?.aiSettings?.anonymization?.enabled;
  React.useEffect(() => {
    if (anonymizationEnabled) {
      // Auto-inicializar se anonimiza√ß√£o ativa e arquivos presentes
      // v1.32.00: Verificar status do modelo NER via novo AIModelService
      setNerModelReady(AIModelService.isReady('ner'));
    } else {
      // v1.32.00: Descarregar modelo quando anonimiza√ß√£o desabilitada
      if (AIModelService.isReady('ner')) {
        console.log('[NER] Descarregando modelo...');
        AIModelService.unload('ner').then(() => {
          setNerModelReady(false);
        });
      }
    }
  }, [anonymizationEnabled]);

  // v1.32.00: Handlers simplificados (modelos s√£o baixados automaticamente)
  const initNerModel = async () => {
    if (nerInitializing || nerModelReady) return;
    setNerInitializing(true);
    setNerDownloadProgress(0);

    // Listener para progresso do download
    const unsubscribe = AIModelService.subscribe((status, progress) => {
      if (progress.ner > 0) {
        setNerDownloadProgress(Math.round(progress.ner));
      }
    });

    try {
      await AIModelService.init('ner');
      setNerModelReady(true);
      showToast('Modelo NER pronto!', 'success');
    } catch (err) {
      showToast('Erro ao inicializar NER: ' + err.message, 'error');
    } finally {
      setNerInitializing(false);
      setNerDownloadProgress(0);
      unsubscribe();
    }
  };

  // üîç v1.32.00: HANDLERS: Busca Sem√¢ntica (E5-base) - Simplificado
  const searchInitStartedRef = useRef(false);

  // v1.32.00: Verificar status e contar embeddings ao montar
  React.useEffect(() => {
    const checkSearchModel = async () => {
      try {
        setSearchModelReady(AIModelService.isReady('search'));
        const count = await EmbeddingsService.getCount();
        setEmbeddingsCount(count);
      } catch (err) {
        console.warn('[Search] Erro ao verificar:', err);
      }
    };
    checkSearchModel();
  }, []);

  // v1.32.00: Inicializar modelo de busca com progresso
  const initSearchModel = async () => {
    if (searchInitializing || searchModelReady) return;
    setSearchInitializing(true);
    setSearchDownloadProgress(0);

    // Listener para progresso do download
    const unsubscribe = AIModelService.subscribe((status, progress) => {
      if (progress.search > 0) {
        setSearchDownloadProgress(Math.round(progress.search));
      }
    });

    try {
      await AIModelService.init('search');
      setSearchModelReady(true);
      showToast('Modelo de busca pronto!', 'success');
    } catch (err) {
      showToast('Erro ao inicializar: ' + err.message, 'error');
    } finally {
      setSearchInitializing(false);
      setSearchDownloadProgress(0);
      unsubscribe();
    }
  };

  // v1.32.00: Handler MASTER - controla carregamento/descarregamento do modelo E5
  const handleSearchToggle = async (newEnabled) => {
    setSearchEnabled(newEnabled);
    localStorage.setItem('searchEnabled', JSON.stringify(newEnabled));

    if (!newEnabled) {
      // Desligando: descarregar modelo E5 da mem√≥ria
      if (AIModelService.isReady('search')) {
        await AIModelService.unload('search');
        setSearchModelReady(false);
        console.log('[SEARCH] Modelo E5 descarregado');
      }
    }
  };

  // v1.32.17: NER agora √© carregado sob demanda (ao clicar "Detectar Nomes")
  // Removido auto-init para economizar ~2GB de RAM
  // O modelo ser√° carregado automaticamente em extractEntities() quando necess√°rio

  // v1.32.06: Auto-inicializar Search ao carregar p√°gina se estava ativado
  React.useEffect(() => {
    if (searchEnabled && !searchModelReady && !searchInitializing) {
      if (import.meta.env.DEV) console.log('[SEARCH] Auto-inicializando modelo (estava ativado)...');
      // Delay para n√£o bloquear render inicial
      const timer = setTimeout(() => {
        initSearchModel();
      }, 1000); // Delay maior para n√£o competir com NER
      return () => clearTimeout(timer);
    }
  }, []); // eslint-disable-line react-hooks/exhaustive-deps

  // v1.28.00: Toggle individual de legisla√ß√£o (n√£o afeta modelo E5)
  // v1.28.01: Ao habilitar, tamb√©m seta modo sem√¢ntico como padr√£o na aba
  // v1.35.74: Agora usa aiIntegration.setAiSettings (persiste automaticamente)
  const handleLegislacaoToggle = (newEnabled) => {
    aiIntegration.setAiSettings(prev => ({ ...prev, semanticSearchEnabled: newEnabled }));
    if (newEnabled) localStorage.setItem('legislacaoSemanticMode', 'true');
  };

  // v1.28.01: Handler para toggle de Jurisprud√™ncia
  // v1.35.74: Agora usa aiIntegration.setAiSettings
  const handleJurisToggle = (newEnabled) => {
    aiIntegration.setAiSettings(prev => ({ ...prev, jurisSemanticEnabled: newEnabled }));
    if (newEnabled) localStorage.setItem('jurisSemanticMode', 'true');
  };

  // v1.28.01: Handler para toggle de Modelos
  // v1.35.74: Agora usa aiIntegration.setAiSettings
  const handleModelToggle = (newEnabled) => {
    aiIntegration.setAiSettings(prev => ({ ...prev, modelSemanticEnabled: newEnabled }));
    if (newEnabled) localStorage.setItem('modelSemanticMode', 'true');
  };

  // Limpar todos os embeddings
  const clearEmbeddings = async () => {
    try {
      await EmbeddingsService.clearAll();
      setEmbeddingsCount(0);
      showToast('Embeddings removidos', 'info');
    } catch (err) {
      showToast('Erro ao limpar embeddings: ' + err.message, 'error');
    }
  };

  // v1.26.04: Importar embeddings de arquivo JSON (gerado pelo script Python)
  const embeddingsFileInputRef = useRef(null);
  const [importingEmbeddings, setImportingEmbeddings] = useState(false);

  const handleImportEmbeddings = async (event) => {
    const file = event.target.files?.[0];
    if (!file) return;

    setImportingEmbeddings(true);
    try {
      const text = await file.text();
      const items = JSON.parse(text);

      if (!Array.isArray(items) || items.length === 0) {
        throw new Error('Arquivo inv√°lido: deve ser um array de embeddings');
      }

      // Verificar estrutura
      const first = items[0];
      if (!first.id || !first.embedding || !Array.isArray(first.embedding)) {
        throw new Error('Formato inv√°lido: cada item deve ter id e embedding');
      }

      // Salvar em batches
      const BATCH_SIZE = 100;
      for (let i = 0; i < items.length; i += BATCH_SIZE) {
        const batch = items.slice(i, i + BATCH_SIZE);
        await EmbeddingsService.saveEmbeddingsBatch(batch);
        setEmbeddingsProgress({ current: Math.min(i + BATCH_SIZE, items.length), total: items.length });
      }

      const count = await EmbeddingsService.getCount();
      setEmbeddingsCount(count);
      showToast(`${items.length} embeddings importados com sucesso!`, 'success');
    } catch (err) {
      showToast('Erro ao importar: ' + err.message, 'error');
      console.error('Import error:', err);
    } finally {
      setImportingEmbeddings(false);
      setEmbeddingsProgress({ current: 0, total: 0 });
      event.target.value = '';
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üìö v1.27.00: FUN√á√ïES DE EMBEDDINGS PARA JURISPRUD√äNCIA
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Hook de jurisprud√™ncia para acessar precedentes
  const jurisprudencia = useJurisprudencia();

  // Limpar embeddings de jurisprud√™ncia
  const clearJurisEmbeddings = async () => {
    try {
      await JurisEmbeddingsService.clearAll();
      setJurisEmbeddingsCount(0);
      showToast('Embeddings de jurisprud√™ncia removidos', 'info');
    } catch (err) {
      showToast('Erro ao limpar embeddings: ' + err.message, 'error');
    }
  };

  // üì¶ v1.27.01: Gerar embeddings para modelos (inline)
  const generateModelEmbeddings = async () => {
    if (!searchModelReady) {
      showToast('Modelo de busca n√£o est√° pronto', 'error');
      return;
    }
    if (generatingModelEmbeddings) return;

    const modelsWithoutEmbedding = modelLibrary.models.filter(m => !m.embedding || m.embedding.length !== 768);
    if (!modelsWithoutEmbedding.length) {
      showToast('Todos os modelos j√° t√™m embeddings', 'info');
      return;
    }

    setGeneratingModelEmbeddings(true);
    setModelEmbeddingsProgress({ current: 0, total: modelsWithoutEmbedding.length });

    // v1.27.03: Yield para React renderizar estado de loading
    await new Promise(resolve => setTimeout(resolve, 50));

    try {
      const stripHTML = (html) => {
        const div = document.createElement('div');
        div.innerHTML = html || '';
        return div.textContent || div.innerText || '';
      };

      for (let i = 0; i < modelsWithoutEmbedding.length; i++) {
        const model = modelsWithoutEmbedding[i];
        const text = [model.title, model.keywords, stripHTML(model.content).slice(0, 2000)].filter(Boolean).join(' ');
        const embedding = await AIModelService.getEmbedding(text, 'passage');
        model.embedding = embedding;
        setModelEmbeddingsProgress({ current: i + 1, total: modelsWithoutEmbedding.length });
        // Yield to event loop para permitir que React renderize o progresso
        await new Promise(resolve => setTimeout(resolve, 0));
      }

      // Salvar modelos atualizados
      await indexedDB.saveModels(modelLibrary.models);
      // v1.27.03: Trigger re-render para atualizar contador
      modelLibrary.setModels([...modelLibrary.models]);
      showToast(`${modelsWithoutEmbedding.length} embeddings de modelos gerados`, 'success');
    } catch (err) {
      showToast('Erro ao gerar embeddings: ' + err.message, 'error');
      console.error('[MODEL-SEARCH] Erro:', err);
    } finally {
      setGeneratingModelEmbeddings(false);
      setModelEmbeddingsProgress({ current: 0, total: 0 });
    }
  };

  // Limpar embeddings dos modelos
  const clearModelEmbeddings = async () => {
    try {
      const updatedModels = modelLibrary.models.map(m => {
        const { embedding, ...rest } = m;
        return rest;
      });
      await indexedDB.saveModels(updatedModels);
      showToast('Embeddings dos modelos removidos', 'info');
    } catch (err) {
      showToast('Erro ao limpar embeddings: ' + err.message, 'error');
    }
  };

  // Importar embeddings de jurisprud√™ncia de arquivo JSON
  const [importingJurisEmbeddings, setImportingJurisEmbeddings] = useState(false);

  const handleImportJurisEmbeddings = async (event) => {
    const file = event.target.files?.[0];
    if (!file) return;

    setImportingJurisEmbeddings(true);
    try {
      const text = await file.text();
      const items = JSON.parse(text);

      if (!Array.isArray(items) || items.length === 0) {
        throw new Error('Arquivo inv√°lido: deve ser um array de embeddings');
      }

      const first = items[0];
      if (!first.id || !first.embedding || !Array.isArray(first.embedding)) {
        throw new Error('Formato inv√°lido: cada item deve ter id e embedding');
      }

      const BATCH_SIZE = 100;
      for (let i = 0; i < items.length; i += BATCH_SIZE) {
        const batch = items.slice(i, i + BATCH_SIZE);
        await JurisEmbeddingsService.saveEmbeddingsBatch(batch);
        setJurisEmbeddingsProgress({ current: Math.min(i + BATCH_SIZE, items.length), total: items.length });
      }

      const count = await JurisEmbeddingsService.getCount();
      setJurisEmbeddingsCount(count);
      showToast(`${items.length} embeddings de jurisprud√™ncia importados!`, 'success');
    } catch (err) {
      showToast('Erro ao importar: ' + err.message, 'error');
      console.error('[JURIS-SEARCH] Import error:', err);
    } finally {
      setImportingJurisEmbeddings(false);
      setJurisEmbeddingsProgress({ current: 0, total: 0 });
      event.target.value = '';
    }
  };

  // Inicializar contagem de embeddings de jurisprud√™ncia
  React.useEffect(() => {
    JurisEmbeddingsService.getCount().then(setJurisEmbeddingsCount).catch(() => {});
  }, []);

  // üåê v1.33.0: Verificar se embeddings precisam ser baixados do CDN
  React.useEffect(() => {
    const checkEmbeddingsNeeded = async () => {
      try {
        const legCount = await EmbeddingsService.getCount();
        const jurisCount = await JurisEmbeddingsService.getCount();

        const legNeeded = legCount === 0;
        const jurisNeeded = jurisCount === 0;

        setEmbeddingsDownloadStatus(prev => ({
          legislacao: { ...prev.legislacao, needed: legNeeded },
          jurisprudencia: { ...prev.jurisprudencia, needed: jurisNeeded }
        }));

        // Mostrar modal se algum embedding estiver faltando e usu√°rio n√£o dismissou
        if ((legNeeded || jurisNeeded) && !dismissedEmbeddingsPrompt) {
          // Delay para n√£o bloquear renderiza√ß√£o inicial
          setTimeout(() => setShowEmbeddingsDownloadModal(true), 2000);
        }
      } catch (err) {
        console.warn('[CDN] Erro ao verificar embeddings:', err);
      }
    };

    checkEmbeddingsNeeded();
  }, [dismissedEmbeddingsPrompt]);

  // üì• v1.33.61: Verificar se dados (legisla√ß√£o/jurisprud√™ncia) precisam ser baixados do CDN
  React.useEffect(() => {
    const checkDataNeeded = async () => {
      try {
        const legNeeded = await EmbeddingsCDNService.needsDataDownload('legislacao');
        const jurisNeeded = await EmbeddingsCDNService.needsDataDownload('jurisprudencia');

        setDataDownloadStatus(prev => ({
          legislacao: { ...prev.legislacao, needed: legNeeded },
          jurisprudencia: { ...prev.jurisprudencia, needed: jurisNeeded }
        }));

        // Mostrar modal se algum dado estiver faltando e usu√°rio n√£o dismissou
        if ((legNeeded || jurisNeeded) && !dismissedDataPrompt) {
          // Delay para n√£o bloquear renderiza√ß√£o inicial
          setTimeout(() => setShowDataDownloadModal(true), 1500);
        }
      } catch (err) {
        console.warn('[CDN] Erro ao verificar dados:', err);
      }
    };

    checkDataNeeded();
  }, [dismissedDataPrompt]);

  // üì• v1.33.61: Handler para iniciar download de dados do CDN
  const handleStartDataDownload = async () => {
    if (!navigator.onLine) {
      showToast('Sem conex√£o com a internet', 'error');
      return;
    }

    const { legislacao: legStatus, jurisprudencia: jurisStatus } = dataDownloadStatus;

    // Download legisla√ß√£o se necess√°rio
    if (legStatus.needed && !legStatus.downloading && !legStatus.completed) {
      setDataDownloadStatus(prev => ({
        ...prev,
        legislacao: { ...prev.legislacao, downloading: true, error: null }
      }));

      try {
        const count = await EmbeddingsCDNService.downloadLegislacaoData(
          (progress) => {
            setDataDownloadStatus(prev => ({
              ...prev,
              legislacao: { ...prev.legislacao, progress }
            }));
          }
        );

        // Atualizar artigos no hook de legisla√ß√£o
        await legislacao.reloadArtigos();

        setDataDownloadStatus(prev => ({
          ...prev,
          legislacao: { needed: false, downloading: false, progress: 1, error: null, completed: true }
        }));
        showToast(`${count} artigos de legisla√ß√£o baixados!`, 'success');
      } catch (err) {
        setDataDownloadStatus(prev => ({
          ...prev,
          legislacao: { ...prev.legislacao, downloading: false, error: err.message }
        }));
        showToast('Erro ao baixar legisla√ß√£o: ' + err.message, 'error');
      }
    }

    // Download jurisprud√™ncia se necess√°rio
    if (jurisStatus.needed && !jurisStatus.downloading && !jurisStatus.completed) {
      setDataDownloadStatus(prev => ({
        ...prev,
        jurisprudencia: { ...prev.jurisprudencia, downloading: true, error: null }
      }));

      try {
        const count = await EmbeddingsCDNService.downloadJurisprudenciaData(
          (progress) => {
            setDataDownloadStatus(prev => ({
              ...prev,
              jurisprudencia: { ...prev.jurisprudencia, progress }
            }));
          }
        );

        // Atualizar precedentes no state via hook
        await jurisprudencia.reloadPrecedentes();

        setDataDownloadStatus(prev => ({
          ...prev,
          jurisprudencia: { needed: false, downloading: false, progress: 1, error: null, completed: true }
        }));
        showToast(`${count} precedentes baixados!`, 'success');
      } catch (err) {
        setDataDownloadStatus(prev => ({
          ...prev,
          jurisprudencia: { ...prev.jurisprudencia, downloading: false, error: err.message }
        }));
        showToast('Erro ao baixar jurisprud√™ncia: ' + err.message, 'error');
      }
    }
  };

  // üì• v1.33.61: Dismiss data download modal
  const handleDismissDataPrompt = () => {
    setShowDataDownloadModal(false);
    setDismissedDataPrompt(true);
    localStorage.setItem('dismissedDataPrompt', 'true');
  };

  // üåê v1.33.0: Handler para iniciar download de embeddings do CDN
  const handleStartEmbeddingsDownload = async () => {
    if (!navigator.onLine) {
      showToast('Sem conex√£o com a internet', 'error');
      return;
    }

    const { legislacao, jurisprudencia } = embeddingsDownloadStatus;

    // Download legisla√ß√£o se necess√°rio
    if (legislacao.needed && !legislacao.downloading) {
      setEmbeddingsDownloadStatus(prev => ({
        ...prev,
        legislacao: { ...prev.legislacao, downloading: true, error: null }
      }));

      try {
        await EmbeddingsCDNService.downloadLegislacao(
          (progress) => {
            setEmbeddingsDownloadStatus(prev => ({
              ...prev,
              legislacao: { ...prev.legislacao, progress }
            }));
          }
        );

        const count = await EmbeddingsService.getCount();
        setEmbeddingsCount(count);
        setEmbeddingsDownloadStatus(prev => ({
          ...prev,
          legislacao: { needed: false, downloading: false, progress: 1, error: null }
        }));
        showToast('Legisla√ß√£o baixada com sucesso!', 'success');
      } catch (err) {
        setEmbeddingsDownloadStatus(prev => ({
          ...prev,
          legislacao: { ...prev.legislacao, downloading: false, error: err.message }
        }));
        showToast('Erro ao baixar legisla√ß√£o: ' + err.message, 'error');
      }
    }

    // Download jurisprud√™ncia se necess√°rio
    if (jurisprudencia.needed && !jurisprudencia.downloading) {
      setEmbeddingsDownloadStatus(prev => ({
        ...prev,
        jurisprudencia: { ...prev.jurisprudencia, downloading: true, error: null }
      }));

      try {
        await EmbeddingsCDNService.downloadJurisprudencia(
          (progress) => {
            setEmbeddingsDownloadStatus(prev => ({
              ...prev,
              jurisprudencia: { ...prev.jurisprudencia, progress }
            }));
          }
        );

        const count = await JurisEmbeddingsService.getCount();
        setJurisEmbeddingsCount(count);
        setEmbeddingsDownloadStatus(prev => ({
          ...prev,
          jurisprudencia: { needed: false, downloading: false, progress: 1, error: null }
        }));
        showToast('Jurisprud√™ncia baixada com sucesso!', 'success');
      } catch (err) {
        setEmbeddingsDownloadStatus(prev => ({
          ...prev,
          jurisprudencia: { ...prev.jurisprudencia, downloading: false, error: err.message }
        }));
        showToast('Erro ao baixar jurisprud√™ncia: ' + err.message, 'error');
      }
    }

    // Fechar modal ap√≥s ambos terminarem (ou se nenhum precisava)
    const finalStatus = embeddingsDownloadStatus;
    if (!finalStatus.legislacao.downloading && !finalStatus.jurisprudencia.downloading) {
      setShowEmbeddingsDownloadModal(false);
    }
  };

  // üåê v1.33.0: Handler para dismissar o prompt de download
  const handleDismissEmbeddingsPrompt = () => {
    setShowEmbeddingsDownloadModal(false);
    setDismissedEmbeddingsPrompt(true);
    localStorage.setItem('dismissedEmbeddingsPrompt', 'true');
  };

  // v1.32.00: Removido SEARCH_FILES_REQUIRED (modelos s√£o baixados automaticamente)

  // v1.25: Detectar nomes automaticamente usando NER
  // v1.25.26: Adicionar overrideText para modais de prova
  // v1.28.09: Adicionar skipSetDetecting para feedback visual imediato
  const detectarNomesAutomaticamente = async (overrideText = null, skipSetDetecting = false) => {
    // v1.32.17: Verificar se NER est√° habilitado (modelo ser√° carregado sob demanda)
    if (!nerEnabled) {
      showToast('Ative o NER em Configura√ß√µes IA para detectar nomes automaticamente.', 'error');
      return;
    }

    if (!skipSetDetecting) setDetectingNames(true);

    try {
      let textoCompleto;

      // v1.25.26: Se overrideText fornecido, usar diretamente (modal de prova)
      if (overrideText && typeof overrideText === 'string' && overrideText.trim().length > 50) {
        textoCompleto = overrideText.slice(0, 3000); // Limitar a 3000 chars
      } else {
        // Coletar APENAS qualifica√ß√£o das partes (~1000 chars por doc)
        // Nomes aparecem nos primeiros ~500-800 chars (cabe√ßalho)
        const CHARS_PER_PAGE = 1000;
        const textos = [];
        const textosHash = new Set(); // Para deduplica√ß√£o

      // Helper: adicionar texto se n√£o for duplicata
      const addTexto = (txt) => {
        if (!txt || txt.length < 50) return;
        const hash = txt.slice(0, 200); // Usar primeiros 200 chars como hash
        if (!textosHash.has(hash)) {
          textosHash.add(hash);
          textos.push(txt);
        }
      };

      // Helper: extrair texto de string ou objeto (s√≥ primeira p√°gina)
      const getFirstPage = (t) => {
        if (!t) return null;
        const fullText = typeof t === 'string' ? t : (t.text || null);
        if (!fullText) return null;
        return fullText.slice(0, CHARS_PER_PAGE);
      };

      // Helper: extrair primeira p√°gina de um PDF
      const extractFirstPageFromPDF = async (fileObj) => {
        try {
          const file = fileObj.file || fileObj;
          if (!file || !(file instanceof Blob || file instanceof File)) return null;
          const text = await documentServices.extractTextFromPDFPure(file);
          return text ? text.slice(0, CHARS_PER_PAGE) : null;
        } catch (e) {
          console.warn('[NER] Falha ao extrair PDF:', e.message);
          return null;
        }
      };

      // 1. Textos COLADOS (j√° dispon√≠veis, limitados a 3000 chars)
      pastedPeticaoTexts?.forEach(t => addTexto(getFirstPage(t)));
      pastedContestacaoTexts?.forEach(t => addTexto(getFirstPage(t)));

      // 2. PDFs - extrair primeira p√°gina de cada (PRIORIDADE: funciona antes da an√°lise!)
      for (const fileObj of (peticaoFiles || [])) {
        const txt = await extractFirstPageFromPDF(fileObj);
        addTexto(txt);
      }
      for (const fileObj of (contestacaoFiles || [])) {
        const txt = await extractFirstPageFromPDF(fileObj);
        addTexto(txt);
      }

      // 3. Se extractedTexts J√Å tiver dados, usar tamb√©m (fallback)
      extractedTexts?.peticoes?.forEach(p => addTexto(getFirstPage(p)));
      extractedTexts?.contestacoes?.forEach(c => addTexto(getFirstPage(c)));

      textoCompleto = textos.join('\n\n');

      if (!textoCompleto.trim()) {
        showToast('Nenhum documento carregado para an√°lise.', 'error');
        setDetectingNames(false);
        return;
      }
    } // Fim do else (coleta de texto de peti√ß√£o/contesta√ß√£o)

    // Executar NER
    const entidades = await AIModelService.extractEntities(textoCompleto);

    // v1.25.23: Separar STOP_WORDS em dois grupos para evitar filtrar "ALMEIDA" (cont√©m "ME")
    // v1.29.02: Removido LTDA/EIRELI - s√£o sufixos v√°lidos de empresas que agora detectamos
    const STOP_WORDS_CONTAINS = [
      'V . EXA', 'V. EXA', 'VOSSA EXCEL√äNCIA', 'V.EXA',
      'RECLAMANTE', 'RECLAMADA', 'RECLAMADO',
      'TRIBUNAL'
    ];

    // Palavras curtas que devem ser palavras inteiras (word boundary)
    const STOP_WORDS_EXACT = [
      'EXA', 'MM', 'DR', 'DRA', 'SR', 'SRA', 'EXMO', 'EXMA',
      'CPF', 'CNPJ', 'CEP', 'RG', 'CTPS', 'PIS',
      'S/A', 'S.A', 'ME', 'EPP', 'AUTOR', 'R√âU',
      'JUIZ', 'JU√çZO', 'VARA', 'TST', 'TRT'
    ];

    // Fun√ß√£o para verificar se √© palavra inteira (word boundary)
    const containsExactWord = (text, word) => {
      const regex = new RegExp(`\\b${word}\\b`, 'i');
      return regex.test(text);
    };

    // v1.25.22: Lista de gent√≠licos/estados civis que n√£o s√£o nomes de pessoas
    const GENTILIC_WORDS = [
      'PARAENSE', 'PAULISTA', 'CARIOCA', 'MINEIRO', 'MINEIRA',
      'GA√öCHO', 'GA√öCHA', 'BAIANO', 'BAIANA', 'CATARINENSE',
      'GOIANO', 'GOIANA', 'CAPIXABA', 'AMAPAENSE', 'AMAZONENSE',
      'ACREANO', 'ACREANA', 'RONDONIENSE', 'RORAIMENSE', 'TOCANTINENSE',
      'MARANHENSE', 'PIAUIENSE', 'CEARENSE', 'POTIGUAR', 'PARAIBANO', 'PARAIBANA',
      'PERNAMBUCANO', 'PERNAMBUCANA', 'ALAGOANO', 'ALAGOANA', 'SERGIPANO', 'SERGIPANA',
      'PARANAENSE', 'MATOGROSSENSE', 'SULMATOGROSSENSE', 'BRASILIENSE',
      'BRASILEIRO', 'BRASILEIRA', 'SOLTEIRO', 'SOLTEIRA', 'CASADO', 'CASADA',
      'DIVORCIADO', 'DIVORCIADA', 'VI√öVO', 'VI√öVA', 'SEPARADO', 'SEPARADA'
    ];

    // v1.29.01: STOP_WORDS para ORG (tribunais, √≥rg√£os p√∫blicos, termos jur√≠dicos)
    // N√ÉO inclui LTDA, EIRELI, S/A, ME, EPP - s√£o sufixos leg√≠timos de nomes de empresas
    const ORG_STOP_WORDS = [
      'JUSTI√áA DO TRABALHO', 'TRIBUNAL REGIONAL', 'TRIBUNAL SUPERIOR',
      'TRT', 'TST', 'STF', 'STJ', 'TRF', 'TRE',
      'MINIST√âRIO P√öBLICO', 'MPT', 'MPF', 'MPE',
      'VARA DO TRABALHO', 'VARA C√çVEL', 'JU√çZO',
      'RECLAMANTE', 'RECLAMADA', 'RECLAMADO', 'AUTOR', 'R√âU', 'R√âUS',
      'CNPJ', 'CEI', 'CPF',
      'UNI√ÉO FEDERAL', 'MUNIC√çPIO DE', 'PREFEITURA DE', 'GOVERNO DO',
      'INSS', 'CEF', 'CAIXA ECON√îMICA FEDERAL', 'BANCO DO BRASIL', 'FGTS',
      'EXCELENT√çSSIMO', 'V. EXA', 'SECRETARIA'
    ];
    const ORG_MIN_SCORE = 0.85; // v1.29.01: Reduzido para capturar mais empresas

    // v1.29: Filtrar pessoas (PER/PESSOA) e opcionalmente ORG
    const isPessoa = e => e.type.includes('PER') || e.type.includes('PESSOA');
    const isOrg = e => e.type.includes('ORG');

    const entidadesFiltradas = entidades.filter(e => {
      if (isPessoa(e)) return true;
      if (nerIncludeOrg && isOrg(e)) {
        if (e.score < ORG_MIN_SCORE) return false;
        const upper = e.text.toUpperCase();
        if (ORG_STOP_WORDS.some(sw => upper.includes(sw))) return false;
        return true;
      }
      return false;
    });

    // v1.33.14: Fallback regex para ORG n√£o detectadas pelo modelo
    // Captura padr√µes conhecidos: "NOME LTDA", "NOME EIRELI", "NOME S/A", etc.
    // Limitado a 4 palavras antes do sufixo para evitar capturar contexto demais
    if (nerIncludeOrg) {
      const ORG_REGEX = /\b([A-Z0-9]+(?:\s+[A-Z0-9]+){0,3})\s+(LTDA|EIRELI|S\.?A\.?|ME|EPP)\b/gi;
      const ORG_PREFIX_STOP = ['O', 'A', 'OS', 'AS', 'DE', 'DO', 'DA', 'EM', 'FACE', 'CONTRA', 'RECLAMADA', 'RECLAMANTE'];
      const textoUpper = textoCompleto.toUpperCase();
      let match;
      while ((match = ORG_REGEX.exec(textoUpper)) !== null) {
        let fullOrg = match[0].trim().replace(/\s+/g, ' '); // Normalizar espa√ßos m√∫ltiplos
        // Remover palavras comuns do in√≠cio
        let words = fullOrg.split(' ');
        while (words.length > 2 && ORG_PREFIX_STOP.includes(words[0])) {
          words.shift();
        }
        fullOrg = words.join(' ');
        // Verificar se j√° n√£o foi detectado pelo modelo
        const alreadyDetected = entidadesFiltradas.some(e =>
          e.text.toUpperCase().includes(fullOrg) || fullOrg.includes(e.text.toUpperCase())
        );
        if (!alreadyDetected && !ORG_STOP_WORDS.some(sw => fullOrg.includes(sw))) {
          console.log(`[NER] Fallback ORG: "${fullOrg}"`);
          entidadesFiltradas.push({ text: fullOrg, type: 'ORG', score: 0.9 });
        }
      }
    }

    // v1.29.02: Manter tipo junto com texto para fuzzy dedup separado
    const nomesComTipo = entidadesFiltradas.map(e => ({
      text: e.text.toUpperCase(),
      isOrg: isOrg(e)
    }));

    // v1.25.23: Filtro com STOP_WORDS separados (contains vs exact)
    // Deduplica por texto primeiro, mantendo o tipo
    const seen = new Map();
    nomesComTipo.forEach(item => {
      if (!seen.has(item.text)) seen.set(item.text, item);
    });
    const nomesFiltrados = [...seen.values()].filter(item =>
      item.text.length >= 4 &&
      !STOP_WORDS_CONTAINS.some(sw => item.text.includes(sw)) &&
      !STOP_WORDS_EXACT.some(sw => containsExactWord(item.text, sw)) &&
      !GENTILIC_WORDS.includes(item.text.trim())
    );

    // Fuzzy Deduplication: mesclar varia√ß√µes do mesmo nome
    const similarity = (a, b) => {
      const longer = a.length > b.length ? a : b;
      const shorter = a.length > b.length ? b : a;
      if (longer.length === 0) return 1.0;
      if (longer.includes(shorter)) return shorter.length / longer.length;
      const wordsA = a.split(/\s+/);
      const wordsB = b.split(/\s+/);
      const common = wordsA.filter(w => wordsB.some(wb => wb.includes(w) || w.includes(wb)));
      return common.length / Math.max(wordsA.length, wordsB.length);
    };

    // v1.29.02: Fuzzy dedup separado por tipo (PER vs ORG)
    const nomesUnicos = [];
    for (const item of nomesFiltrados) {
      const similarIdx = nomesUnicos.findIndex(n => {
        // S√≥ comparar entidades do mesmo tipo
        if (n.isOrg !== item.isOrg) return false;
        // Threshold mais alto para ORG (0.85) vs PER (0.7)
        const threshold = item.isOrg ? 0.85 : 0.7;
        return similarity(n.text, item.text) > threshold;
      });
      if (similarIdx >= 0) {
        if (item.text.length > nomesUnicos[similarIdx].text.length) {
          console.log(`[NER] Fuzzy merge: "${nomesUnicos[similarIdx].text}" ‚Üí "${item.text}"`);
          nomesUnicos[similarIdx] = item;
        }
      } else {
        nomesUnicos.push(item);
      }
    }
    console.log('[NER] Nomes ap√≥s fuzzy dedup:', nomesUnicos.map(n => n.text));

    // v1.25.24: Limpar gent√≠licos do final dos nomes
    // v1.29.02: nomesUnicos agora √© array de {text, isOrg}
    const nomesLimpos = nomesUnicos.map(item => {
      let limpo = item.text;
      for (const gentilic of GENTILIC_WORDS) {
        if (limpo.endsWith(' ' + gentilic)) {
          limpo = limpo.slice(0, -(gentilic.length + 1)).trim();
        }
      }
      return limpo;
    });

    if (nomesLimpos.length === 0) {
      showToast('Nenhum nome detectado nos documentos.', 'info');
      return;
    }

    // Merge com nomes existentes
    const nomesAtuais = anonymizationNamesText.split(/[\n,]/).map(n => n.trim().toUpperCase()).filter(n => n);
    const todoNomes = [...new Set([...nomesAtuais, ...nomesLimpos])];

    // Atualizar textarea
    setAnonymizationNamesText(todoNomes.join('\n'));

    showToast(`Detectados ${nomesLimpos.length} nome(s). Total: ${todoNomes.length}`, 'success');

  } catch (err) {
    console.error('Erro na detec√ß√£o de nomes:', err);
    showToast('Erro ao detectar nomes: ' + err.message, 'error');
  } finally {
    setDetectingNames(false);
  }
};


  const exportAiSettings = async () => {
    const dataStr = JSON.stringify(aiIntegration.aiSettings, null, 2);
    
    try {
      await navigator.clipboard.writeText(dataStr);
      
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sentencify-configuracoes-' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Configura√ß√µes exportadas com sucesso! Arquivo baixado e copiado para √°rea de transfer√™ncia.', 'success');
    } catch (err) {
      showToast('Erro ao exportar configura√ß√µes: ' + err.message, 'error');
    }
  };

  const importAiSettings = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const importedSettings = JSON.parse(text);
      
      if (typeof importedSettings !== 'object') {
        showToast('Arquivo inv√°lido.', 'error');
        return;
      }

      const mergedSettings = {
        model: importedSettings.model || 'claude-sonnet-4-20250514',
        useExtendedThinking: importedSettings.useExtendedThinking || false,
        customPrompt: importedSettings.customPrompt || '',
        modeloRelatorio: importedSettings.modeloRelatorio || '',
        modeloDispositivo: importedSettings.modeloDispositivo || '',
        modeloTopicoRelatorio: importedSettings.modeloTopicoRelatorio || '',
        // v1.12.25: autoExtractPDFText removido - usa apenas ocrEngine
        topicosComplementares: importedSettings.topicosComplementares || [
          { id: 1, title: 'HONOR√ÅRIOS ADVOCAT√çCIOS', category: 'M√âRITO', enabled: true, ordem: 1 },
          { id: 2, title: 'HONOR√ÅRIOS PERICIAIS', category: 'M√âRITO', enabled: true, ordem: 2 },
          { id: 3, title: 'JUROS E CORRE√á√ÉO MONET√ÅRIA', category: 'M√âRITO', enabled: true, ordem: 3 },
          { id: 4, title: 'DEDU√á√ïES DE NATUREZA PREVIDENCI√ÅRIA E FISCAL', category: 'M√âRITO', enabled: true, ordem: 4 },
          { id: 5, title: 'COMPENSA√á√ÉO/DEDU√á√ÉO/ABATIMENTO', category: 'M√âRITO', enabled: true, ordem: 5 }
        ]
      };

      aiIntegration.setAiSettings(mergedSettings);
      showToast('Configura√ß√µes importadas com sucesso!', 'success');
      event.target.value = '';
    } catch (err) {
      showToast('Erro ao importar: ' + err.message, 'error');
      event.target.value = '';
    }
  };

  const showToast = (message, type = 'success') => {
    setToast({ show: true, message, type });
    setTimeout(() => {
      setToast({ show: false, message: '', type: 'success' });
    }, 4000); // Auto-hide after 4 seconds
  };

  // v1.15.3: Fun√ß√µes para Slash Menu (acesso r√°pido a modelos com \)
  const findSlashPosition = (text, triggerPos) => {
    if (text[triggerPos] === '\\') return triggerPos;
    if (text[triggerPos + 1] === '\\') return triggerPos + 1;
    if (triggerPos > 0 && text[triggerPos - 1] === '\\') return triggerPos - 1;
    return -1;
  };

  const openSlashMenu = React.useCallback((data) => {
    setSlashMenu({
      isOpen: true,
      position: data.position,
      searchTerm: '',
      selectedIndex: 0,
      quillInstance: data.quillInstance,
      triggerPosition: data.triggerPosition
    });
  }, []);

  const closeSlashMenu = React.useCallback((removeSlash = false) => {
    setSlashMenu(prev => {
      if (removeSlash && prev.quillInstance && typeof prev.triggerPosition === 'number') {
        try {
          const text = prev.quillInstance.getText();
          const slashPos = findSlashPosition(text, prev.triggerPosition);
          if (slashPos >= 0) {
            prev.quillInstance.deleteText(slashPos, 1);
            setTimeout(() => {
              prev.quillInstance.focus();
              prev.quillInstance.setSelection(slashPos, 0);
            }, 0);
          }
        } catch (e) { /* Quill pode estar indispon√≠vel */ }
      }
      return { ...prev, isOpen: false };
    });
  }, []);

  const navigateSlashMenu = React.useCallback((direction, maxItems) => {
    setSlashMenu(prev => {
      if (direction === 'down') {
        return { ...prev, selectedIndex: Math.min(prev.selectedIndex + 1, maxItems - 1) };
      } else {
        return { ...prev, selectedIndex: Math.max(prev.selectedIndex - 1, 0) };
      }
    });
  }, []);

  const selectModelFromSlash = React.useCallback((model) => {
    const { quillInstance, triggerPosition } = slashMenu;
    if (!quillInstance || !model) {
      closeSlashMenu();
      return;
    }

    try {
      const text = quillInstance.getText();
      const slashPos = findSlashPosition(text, triggerPosition);
      if (slashPos < 0) { closeSlashMenu(); return; }

      const currentPos = quillInstance.getSelection()?.index || slashPos + 1;
      const deleteLength = currentPos - slashPos;
      if (deleteLength > 0) quillInstance.deleteText(slashPos, deleteLength);

      const sanitizedContent = sanitizeHTML(model.content);
      quillInstance.clipboard.dangerouslyPasteHTML(slashPos, sanitizedContent);

      closeSlashMenu();
      showToast(`Modelo "${model.title}" inserido`, 'success');
    } catch (err) {
      closeSlashMenu();
    }
  }, [slashMenu, closeSlashMenu, showToast]);

  const updateSlashSearchTerm = React.useCallback((term) => {
    setSlashMenu(prev => ({ ...prev, searchTerm: term, selectedIndex: 0 }));
  }, []);

  // v1.15.4: ESC global para fechar slash menu
  React.useEffect(() => {
    if (!slashMenu.isOpen) return;

    const handleGlobalKeyDown = (e) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        e.stopPropagation();
        closeSlashMenu(true);
      }
    };

    document.addEventListener('keydown', handleGlobalKeyDown, true);
    return () => document.removeEventListener('keydown', handleGlobalKeyDown, true);
  }, [slashMenu.isOpen, closeSlashMenu]);

  // v1.15.4: Click fora do menu fecha
  React.useEffect(() => {
    if (!slashMenu.isOpen) return;

    const handleClickOutside = (e) => {
      const menuEl = document.querySelector('.slash-command-menu');
      if (menuEl && !menuEl.contains(e.target)) {
        closeSlashMenu(true);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [slashMenu.isOpen, closeSlashMenu]);

  useEffect(() => {
    if (editingTopic) {
      aiIntegration.setRelatorioInstruction(''); // Limpar instru√ß√£o ao mudar de t√≥pico
    }
  }, [editingTopic?.title]); // S√≥ roda quando o T√çTULO mudar (trocar de t√≥pico)

  useEffect(() => {
    if (lastEditedTopicTitle && activeTab === 'topics') {
      let nestedTimeoutId = null;
      // Timeout maior para garantir que o DOM foi atualizado ap√≥s troca de aba
      const timeoutId = setTimeout(() => {
        const element = topicRefs.current[lastEditedTopicTitle];
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          nestedTimeoutId = setTimeout(() => setLastEditedTopicTitle(null), 2000);
        } else {
          setLastEditedTopicTitle(null); // Limpa para n√£o ficar travado
        }
      }, 300); // Aumentado de 100ms para 300ms

      return () => {
        clearTimeout(timeoutId);
        if (nestedTimeoutId) clearTimeout(nestedTimeoutId);
      };
    }
  }, [lastEditedTopicTitle, activeTab]);

  // v1.20.2: Cleanup de refs √≥rf√£s quando t√≥picos mudam
  React.useEffect(() => {
    if (selectedTopics?.length) {
      cleanupTopicRefs(selectedTopics.map(t => t.title));
    }
  }, [selectedTopics, cleanupTopicRefs]);

  // üîß HELPER FUNCTIONS - v1.3.5.1

  // Verifica se um t√≥pico est√° decidido
  const isTopicDecidido = React.useCallback((topic) => {
    if (!topic) return false;

    // DISPOSITIVO usa editedContent
    if (isDispositivo(topic)) {
      return topic.editedContent && topic.editedContent.trim() !== '';
    }

    if (isRelatorio(topic)) {
      return (topic.editedRelatorio && topic.editedRelatorio.trim() !== '') ||
             (topic.relatorio && topic.relatorio.trim() !== '');
    }

    // T√≥picos normais precisam de conte√∫do E resultado selecionado
    const temConteudo = topic.editedFundamentacao && topic.editedFundamentacao.trim() !== '';
    const temResultado = topic.resultado && topic.resultado.trim() !== '';

    return temConteudo && temResultado;
  }, []);

  // üöÄ OTIMIZA√á√ïES DE PERFORMANCE - v1.2.7

  // üìä Contadores memoizados para evitar rec√°lculos a cada render
  const topicsDecididos = React.useMemo(() => {
    return selectedTopics.filter(t =>
      isTopicDecidido(t) &&
      t.title.toUpperCase() !== 'RELAT√ìRIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO'
    ).length;
  }, [selectedTopics, isTopicDecidido]);

  const topicsPendentes = React.useMemo(() => {
    return selectedTopics.filter(t =>
      !isTopicDecidido(t) &&
      t.title.toUpperCase() !== 'RELAT√ìRIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO'
    ).length;
  }, [selectedTopics, isTopicDecidido]);

  const topicsSemDecisao = React.useMemo(() => {
    return selectedTopics.filter(t => !isTopicDecidido(t));
  }, [selectedTopics, isTopicDecidido]);

  const topicsSemResultado = React.useMemo(() => {
    return selectedTopics.filter(t =>
      t.title.toUpperCase() !== 'RELAT√ìRIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO' &&
      !t.resultado
    );
  }, [selectedTopics]);

  const canGenerateDispositivo = React.useMemo(() => {
    // Precisa ter pelo menos 1 t√≥pico selecionado
    if (selectedTopics.length === 0) {
      return { enabled: false, reason: 'Nenhum t√≥pico selecionado' };
    }

    // Filtrar t√≥picos relevantes (exceto RELAT√ìRIO e DISPOSITIVO)
    const topicsRelevantes = selectedTopics.filter(t =>
      t.title.toUpperCase() !== 'RELAT√ìRIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO'
    );

    if (topicsRelevantes.length === 0) {
      return { enabled: false, reason: 'Nenhum t√≥pico de m√©rito/preliminar selecionado' };
    }

    // Verificar t√≥picos sem conte√∫do (fundamenta√ß√£o n√£o escrita)
    const semConteudo = topicsRelevantes.filter(t =>
      !t.editedFundamentacao || t.editedFundamentacao.trim() === ''
    );

    // Verificar t√≥picos com conte√∫do mas sem resultado selecionado
    const semResultado = topicsRelevantes.filter(t =>
      t.editedFundamentacao && t.editedFundamentacao.trim() !== '' &&
      (!t.resultado || t.resultado.trim() === '')
    );

    const totalPendentes = semConteudo.length + semResultado.length;

    if (totalPendentes > 0) {
      // Construir mensagem detalhada
      let detalhes = [];

      if (semConteudo.length > 0) {
        const primeiros = semConteudo.slice(0, 3).map(t => t.title);
        const resto = semConteudo.length > 3 ? ` e mais ${semConteudo.length - 3}` : '';
        detalhes.push(`${semConteudo.length} sem conte√∫do: ${primeiros.join(', ')}${resto}`);
      }

      if (semResultado.length > 0) {
        const primeiros = semResultado.slice(0, 3).map(t => t.title);
        const resto = semResultado.length > 3 ? ` e mais ${semResultado.length - 3}` : '';
        detalhes.push(`${semResultado.length} sem resultado: ${primeiros.join(', ')}${resto}`);
      }

      return {
        enabled: false,
        reason: `${totalPendentes} t√≥pico${totalPendentes > 1 ? 's' : ''} pendente${totalPendentes > 1 ? 's' : ''} (${detalhes.join(' | ')})`
      };
    }

    return { enabled: true, reason: '' };
  }, [selectedTopics]);

  // v1.14.5: Excluir DISPOSITIVO para evitar ru√≠do do conte√∫do antigo
  const topicsParaDispositivo = React.useMemo(() => {
    return selectedTopics.filter(topic =>
      topic.title.toUpperCase() !== 'RELAT√ìRIO' &&
      topic.title.toUpperCase() !== 'DISPOSITIVO' &&
      topic.resultado !== 'SEM RESULTADO'
    );
  }, [selectedTopics]);

  const selectedTopicTitles = React.useMemo(() =>
    selectedTopics.map(t => t.title).join('|'),
    [selectedTopics.map(t => t.title).join('|')]
  );

  // v1.19.2: Normalizar compara√ß√£o case-insensitive para evitar duplicatas
  const unselectedTopics = React.useMemo(() => {
    return extractedTopics.filter(topic =>
      !selectedTopics.find(st =>
        (st.title || '').toUpperCase().trim() === (topic.title || '').toUpperCase().trim()
      )
    );
  }, [extractedTopics, selectedTopicTitles]);

  // üéØ HANDLERS COM useCallback (memoizados para evitar recria√ß√£o)

  // v1.33.58: dnd-kit sensors e handler para drag and drop com wheel scroll
  const dndSensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // M√≠nimo de 8px de movimento antes de iniciar drag (evita cliques acidentais)
      },
    })
  );

  // v1.33.60: Set pr√©-computado para lookup O(1) no collision detection
  const specialTopicIds = React.useMemo(() => {
    return new Set(
      selectedTopics
        .filter(t => isSpecialTopic(t))
        .map(t => t.id || t.title)
    );
  }, [selectedTopics]);

  // v1.33.60: Collision detection otimizado - O(n) ao inv√©s de O(n¬≤)
  // Ignora RELAT√ìRIO e DISPOSITIVO para evitar feedback visual enganoso
  const customCollisionDetection = React.useCallback((args) => {
    const { droppableContainers, ...rest } = args;

    // Filtrar usando Set (O(1) por lookup)
    const filteredContainers = droppableContainers.filter(
      container => !specialTopicIds.has(container.id)
    );

    return closestCenter({ ...rest, droppableContainers: filteredContainers });
  }, [specialTopicIds]);

  const handleDndDragEnd = React.useCallback((event) => {
    const { active, over } = event;
    if (!over || active.id === over.id) return;

    const oldIndex = selectedTopics.findIndex(t => (t.id || t.title) === active.id);
    const newIndex = selectedTopics.findIndex(t => (t.id || t.title) === over.id);

    // Proteger t√≥picos especiais (RELAT√ìRIO e DISPOSITIVO)
    if (isSpecialTopic(selectedTopics[oldIndex]) || isSpecialTopic(selectedTopics[newIndex])) {
      return;
    }

    const reordered = arrayMove(selectedTopics, oldIndex, newIndex);
    setSelectedTopics(reordered);
  }, [selectedTopics, setSelectedTopics]);

  // v1.33.58: Handlers HTML5 antigos mantidos temporariamente para complementares
  const handleDragStart = React.useCallback((e, index) => {
    // Bloquear drag de RELAT√ìRIO e DISPOSITIVO
    const topic = selectedTopics[index];
    if (isSpecialTopic(topic)) {
      e.preventDefault();
      return;
    }

    setDraggedIndex(index);
    e.dataTransfer.effectAllowed = 'move';
    // Adiciona um pequeno delay para permitir o visual do drag
    e.currentTarget.style.opacity = '0.5';
  }, [selectedTopics]);

  const handleDragEnd = React.useCallback((e) => {
    e.currentTarget.style.opacity = '1';
    setDraggedIndex(null);
    setDragOverIndex(null);
  }, []);

  const handleDragOver = React.useCallback((e, index) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';

    if (draggedIndex !== null && draggedIndex !== index) {
      setDragOverIndex(index);
    }

    // üÜï Auto-scroll quando arrastar perto das bordas
    const scrollThreshold = 150; // √Årea maior para detectar (150px da borda)
    const scrollSpeed = 25; // Scroll mais r√°pido
    const viewportHeight = window.innerHeight;
    const mouseY = e.clientY;

    // Scroll para baixo quando mouse est√° perto da borda inferior
    if (mouseY > viewportHeight - scrollThreshold) {
      window.scrollBy({
        top: scrollSpeed,
        behavior: 'auto'
      });
    }
    // Scroll para cima quando mouse est√° perto da borda superior
    else if (mouseY < scrollThreshold) {
      window.scrollBy({
        top: -scrollSpeed,
        behavior: 'auto'
      });
    }
  }, [draggedIndex]);

  const handleDragLeave = React.useCallback((e) => {
    // S√≥ limpa se realmente sair do elemento
    if (!e.currentTarget.contains(e.relatedTarget)) {
      setDragOverIndex(null);
    }
  }, []);

  const handleDrop = React.useCallback((e, dropIndex) => {
    e.preventDefault();
    
    if (draggedIndex === null || draggedIndex === dropIndex) {
      setDraggedIndex(null);
      setDragOverIndex(null);
      return;
    }

    // Bloquear drop em posi√ß√µes de RELAT√ìRIO (0) e DISPOSITIVO (√∫ltima posi√ß√£o)
    const draggedTopic = selectedTopics[draggedIndex];
    const dropTopic = selectedTopics[dropIndex];
    
    // N√£o permitir mover RELAT√ìRIO ou DISPOSITIVO
    if (isSpecialTopic(draggedTopic)) {
      setDraggedIndex(null);
      setDragOverIndex(null);
      return;
    }

    // N√£o permitir drop na posi√ß√£o de RELAT√ìRIO ou DISPOSITIVO
    if (isSpecialTopic(dropTopic)) {
      setDraggedIndex(null);
      setDragOverIndex(null);
      return;
    }

    const newTopics = [...selectedTopics];
    const [draggedTopicItem] = newTopics.splice(draggedIndex, 1);
    newTopics.splice(dropIndex, 0, draggedTopicItem);

    setSelectedTopics(newTopics);
    setDraggedIndex(null);
    setDragOverIndex(null);
  }, [draggedIndex, selectedTopics]);

  // üöÄ OTIMIZA√á√ÉO v1.4.1: Fun√ß√µes de drag and drop para t√≥picos complementares com useCallback
  const handleComplementaryDragStart = React.useCallback((e, index) => {
    setDraggedComplementaryIndex(index);
    e.dataTransfer.effectAllowed = 'move';
    e.currentTarget.style.opacity = '0.5';
  }, []);

  const handleComplementaryDragEnd = React.useCallback((e) => {
    e.currentTarget.style.opacity = '1';
    setDraggedComplementaryIndex(null);
    setDragOverComplementaryIndex(null);
  }, []);

  const handleComplementaryDragOver = React.useCallback((e, index) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';

    if (draggedComplementaryIndex !== null && index !== draggedComplementaryIndex) {
      setDragOverComplementaryIndex(index);
    }
  }, [draggedComplementaryIndex]);

  const handleComplementaryDragLeave = React.useCallback((e) => {
    if (e.currentTarget === e.target) {
      setDragOverComplementaryIndex(null);
    }
  }, []);

  const handleComplementaryDrop = React.useCallback((e, dropIndex) => {
    e.preventDefault();

    if (draggedComplementaryIndex === null || draggedComplementaryIndex === dropIndex) {
      setDraggedComplementaryIndex(null);
      setDragOverComplementaryIndex(null);
      return;
    }

    const updatedTopics = [...aiIntegration.aiSettings.topicosComplementares];
    const [draggedTopic] = updatedTopics.splice(draggedComplementaryIndex, 1);
    updatedTopics.splice(dropIndex, 0, draggedTopic);

    // Recalcular ordem
    const reorderedTopics = updatedTopics.map((topic, idx) => ({
      ...topic,
      ordem: idx + 1
    }));

    aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, topicosComplementares: reorderedTopics });
    setDraggedComplementaryIndex(null);
    setDragOverComplementaryIndex(null);
  }, [draggedComplementaryIndex, aiIntegration.aiSettings.topicosComplementares, aiIntegration.setAiSettings]);

  // üéØ v1.4.6.3: OPT-06 - Handlers Memoizados para Editor de Decis√µes
  // Estes handlers s√£o passados como props para DecisionEditorContainer.
  // Memoiz√°-los evita quebrar React.memo e recalcular useMemo internos.

  const handleFundamentacaoChange = React.useCallback((html) => {
    setEditingTopic(prev => ({
      ...prev,
      editedFundamentacao: html
    }));
  }, []);

  const handleRelatorioChange = React.useCallback((html) => {
    setEditingTopic(prev => ({
      ...prev,
      editedRelatorio: html
    }));
  }, []);

  const handleCategoryChange = React.useCallback((newCategory) => {
    setEditingTopic(prev => ({
      ...prev,
      category: newCategory
    }));

    // Atualiza selectedTopics
    setSelectedTopics(prevSelected => {
      const selectedIndex = prevSelected.findIndex(t => t.title === editingTopic?.title);
      if (selectedIndex === -1) return prevSelected;

      const newSelected = [...prevSelected];
      newSelected[selectedIndex] = { ...newSelected[selectedIndex], category: newCategory };
      return newSelected;
    });

    // Atualiza extractedTopics
    setExtractedTopics(prevExtracted => {
      const extractedIndex = prevExtracted.findIndex(t => t.title === editingTopic?.title);
      if (extractedIndex === -1) return prevExtracted;

      const newExtracted = [...prevExtracted];
      newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], category: newCategory };
      return newExtracted;
    });
  }, [editingTopic?.title]);

  // üé® v1.4.7: Helper Centralizado para Configura√ß√£o de Editores por Tipo
  // Este helper retorna configura√ß√£o espec√≠fica para cada tipo de t√≥pico,
  // permitindo especializa√ß√£o de editores sem acoplar componentes filhos.

  const getTopicEditorConfig = React.useCallback((topicTitle) => {
    switch(topicTitle?.toUpperCase()) {
      case 'RELAT√ìRIO':
        return {
          showCategory: false,
          showMiniRelatorio: true,
          showDecisionEditor: false,
          relatorioConfig: {
            label: 'üìÑ Relat√≥rio:',
            minHeight: 'min-h-48',
            showRegenerateSection: true
          },
          editorConfig: {}
        };

      case 'DISPOSITIVO':
        return {
          showCategory: false,
          showMiniRelatorio: false,
          showDecisionEditor: true,
          relatorioConfig: {},
          editorConfig: {
            label: 'üìã Dispositivo:',
            placeholder: 'Descreva o resultado da decis√£o (PROCEDENTE, IMPROCEDENTE, etc)...',
            showRegenerateSection: true
          }
        };

      default:
        // T√≥picos normais (PRELIMINAR, M√âRITO, etc)
        return {
          showCategory: true,
          showMiniRelatorio: true,
          showDecisionEditor: true,
          relatorioConfig: {},
          editorConfig: {}
        };
    }
  }, []);

  // üìö FUN√á√ïES: Gerenciamento de Modelos

    // Hook useModelLibrary j√° gerencia persist√™ncia via 'sentencify-models'

  // üöÄ v1.8.2: Gerar keywords automaticamente com IA (COM CACHE)
  const generateKeywordsWithAI = async () => {
    // Verifica√ß√£o defensiva
    if (!aiIntegration?.callAI) {
      console.error('[generateKeywordsWithAI] aiIntegration.callAI undefined');
      setError('Erro interno: sistema de IA n√£o inicializado. Recarregue a p√°gina.');
      return;
    }
    if (!modelLibrary.newModel.title && !modelLibrary.newModel.content) {
      setError('Preencha ao menos o t√≠tulo ou conte√∫do para gerar palavras-chave');
      return;
    }

    // üöÄ v1.8.2: Gerar cache key baseado em t√≠tulo + categoria + conte√∫do
    const cacheKey = `keywords_${modelLibrary.newModel.title}_${modelLibrary.newModel.category}_${modelLibrary.newModel.content}`;

    // üöÄ v1.8.2: Verificar cache antes de chamar API
    const cachedKeywords = apiCache.get(cacheKey);
    if (cachedKeywords) {
      modelLibrary.setNewModel({ ...modelLibrary.newModel, keywords: cachedKeywords });
      return; // Retornar imediatamente com resultado cacheado
    }

    aiIntegration.setGeneratingKeywords(true);
    setError('');

    try {
      const prompt = `${AI_PROMPTS.roles.analiseDoc}

MODELO DE DECIS√ÉO:
T√≠tulo: ${modelLibrary.newModel.title || 'N√£o fornecido'}
Categoria: ${modelLibrary.newModel.category || 'N√£o especificada'}
Conte√∫do: ${modelLibrary.newModel.content || 'N√£o fornecido'}

TAREFA:
Analise o modelo acima e gere palavras-chave (keywords) relevantes que ajudem a identificar e encontrar este modelo.

CRIT√âRIOS:
1. Identifique os principais conceitos jur√≠dicos mencionados
2. Extraia termos t√©cnicos relevantes
3. Identifique pedidos ou temas tratados (ex: "horas extras", "adicional noturno", "danos morais")
4. Inclua sin√¥nimos e varia√ß√µes (ex: "sobrejornada" para "horas extras")
5. Limite a 5-8 palavras-chave mais relevantes
6. Use termos que um usu√°rio provavelmente buscaria

Responda APENAS com as palavras-chave separadas por v√≠rgula, sem explica√ß√µes.
Exemplo de resposta v√°lida: horas extras, sobrejornada, adicional, jornada de trabalho, hora extra

N√£o adicione explica√ß√µes, apenas as keywords separadas por v√≠rgula.`;

      // v1.21.26: Parametros semi-deterministicos para keywords
      const keywords = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], {
        maxTokens: 500,
        useInstructions: false,
        temperature: 0.2,
        topP: 0.9,
        topK: 50
      });

      if (keywords) {
        // üöÄ v1.8.2: Armazenar resultado no cache
        apiCache.set(cacheKey, keywords);

        modelLibrary.setNewModel({ ...modelLibrary.newModel, keywords: keywords });
      } else {
        setError('N√£o foi poss√≠vel gerar palavras-chave. Tente novamente.');
      }

    } catch (err) {
      setError('Erro ao gerar palavras-chave: ' + err.message);
    } finally {
      aiIntegration.setGeneratingKeywords(false);
    }
  };

  const generateTitleWithAI = async () => {
    // Verifica√ß√£o defensiva
    if (!aiIntegration?.callAI) {
      console.error('[generateTitleWithAI] aiIntegration.callAI undefined');
      setError('Erro interno: sistema de IA n√£o inicializado. Recarregue a p√°gina.');
      return;
    }
    if (!modelLibrary.newModel.content) {
      setError('Preencha o conte√∫do do modelo para gerar o t√≠tulo');
      return;
    }

    // Cache key baseado nos primeiros 500 caracteres do conte√∫do
    const cacheKey = `title_${modelLibrary.newModel.content.substring(0, 500)}`;
    const cachedTitle = apiCache.get(cacheKey);
    if (cachedTitle) {
      modelLibrary.setNewModel({ ...modelLibrary.newModel, title: cachedTitle });
      return;
    }

    aiIntegration.setGeneratingTitle(true);
    setError('');

    try {
      const prompt = `${AI_PROMPTS.roles.classificacao}

CONTE√öDO DO MODELO:
${modelLibrary.newModel.content}

TAREFA:
Analise o conte√∫do acima e gere um T√çTULO padronizado para este modelo de decis√£o.

FORMATO OBRIGAT√ìRIO:
TEMA - SUBTEMA - RESULTADO (PROCEDENTE/IMPROCEDENTE)

EXEMPLOS V√ÅLIDOS:
- HORAS EXTRAS - SOBREJORNADA HABITUAL - PROCEDENTE
- RESCIS√ÉO INDIRETA - ATRASO SALARIAL - PROCEDENTE
- DANOS MORAIS - ASS√âDIO MORAL - IMPROCEDENTE
- ADICIONAL DE INSALUBRIDADE - GRAU M√âDIO - PARCIALMENTE PROCEDENTE
- V√çNCULO EMPREGAT√çCIO - PEJOTIZA√á√ÉO - PROCEDENTE
- EQUIPARA√á√ÉO SALARIAL - IDENTIDADE DE FUN√á√ïES - IMPROCEDENTE

REGRAS:
1. TEMA: Assunto principal (ex: HORAS EXTRAS, DANOS MORAIS, V√çNCULO)
2. SUBTEMA: Especifica√ß√£o do tema (ex: SOBREJORNADA, ASS√âDIO, PEJOTIZA√á√ÉO)
3. RESULTADO: PROCEDENTE, IMPROCEDENTE ou PARCIALMENTE PROCEDENTE
4. Sempre em MAI√öSCULAS
5. Separar com " - " (h√≠fen com espa√ßos)

Responda APENAS com o t√≠tulo no formato especificado, sem explica√ß√µes.`;

      // v1.21.26: Parametros semi-deterministicos para titulo padronizado
      const title = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], {
        maxTokens: 100,
        useInstructions: false,
        temperature: 0.1,
        topP: 0.9,
        topK: 40
      });

      if (title) {
        apiCache.set(cacheKey, title.trim());
        modelLibrary.setNewModel({ ...modelLibrary.newModel, title: title.trim() });
      } else {
        setError('N√£o foi poss√≠vel gerar o t√≠tulo. Tente novamente.');
      }
    } catch (err) {
      setError('Erro ao gerar t√≠tulo: ' + err.message);
    } finally {
      aiIntegration.setGeneratingTitle(false);
    }
  };

  // üîç v1.13.1: Executa salvamento do modelo (chamado ap√≥s verifica√ß√£o de similaridade)
  // v1.27.02: Gera embedding automaticamente se IA local estiver ativa
  const executeSaveModel = async (modelData, isReplace = false, replaceId = null) => {
    // Gerar embedding se modelo de busca estiver pronto E op√ß√£o ativada
    if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady && !modelData.embedding) {
      await new Promise(resolve => setTimeout(resolve, 50));
      try {
        const stripHTML = (html) => {
          const div = document.createElement('div');
          div.innerHTML = html || '';
          return div.textContent || div.innerText || '';
        };
        const text = [modelData.title, modelData.keywords, stripHTML(modelData.content).slice(0, 2000)].filter(Boolean).join(' ');
        modelData.embedding = await AIModelService.getEmbedding(text, 'passage');
      } catch (err) {
        console.warn('[MODEL-EMBED] Erro ao gerar embedding:', err);
      }
    } else if (!aiIntegration.aiSettings.modelSemanticEnabled && modelData.embedding) {
      delete modelData.embedding;
    }

    if (isReplace && replaceId) {
      const updatedModel = { ...modelData, id: replaceId, updatedAt: new Date().toISOString() };
      const updated = modelLibrary.models.map(m => m.id === replaceId ? updatedModel : m);
      modelLibrary.setModels(updated);
      // v1.34.0: Rastrear update para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('update', updatedModel);
      TFIDFSimilarity.invalidate();
      apiCache.invalidate('suggestions_');
    } else {
      modelLibrary.setModels(prev => [...prev, modelData]);
      // v1.34.0: Rastrear create para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('create', modelData);
      TFIDFSimilarity.invalidate();
      apiCache.invalidate('suggestions_');
    }
    modelLibrary.setHasUnsavedChanges(true);
    setModelSaved(true);
    setTimeout(() => {
      modelLibrary.setNewModel({ title: '', content: '', keywords: '', category: '' });
      if (modelEditorRef.current?.root) modelEditorRef.current.root.innerHTML = '';
      closeModal('modelForm');
      setError('');
      setModelSaved(false);
    }, 1200);
  };

  const saveModel = async () => {
    const currentContent = modelEditorRef.current?.root
      ? sanitizeHTML(modelEditorRef.current.root.innerHTML)
      : modelLibrary.newModel.content;

    if (!modelLibrary.newModel.title || !currentContent) {
      setError('T√≠tulo e conte√∫do s√£o obrigat√≥rios');
      return;
    }

    setSavingModel(true);
    // Yield para React renderizar "Salvando..." antes da opera√ß√£o pesada
    await new Promise(resolve => setTimeout(resolve, 50));
    try {
      if (modelLibrary.editingModel) {
        // Edi√ß√£o de modelo existente - sem verifica√ß√£o de similaridade
        const modelData = {
          ...modelLibrary.editingModel,
          title: modelLibrary.newModel.title,
          content: currentContent,
          keywords: modelLibrary.newModel.keywords,
          category: modelLibrary.newModel.category,
          updatedAt: new Date().toISOString()
        };

        // v1.27.02: Regenerar embedding se IA local estiver ativa
        if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady) {
          try {
            const stripHTML = (html) => {
              const div = document.createElement('div');
              div.innerHTML = html || '';
              return div.textContent || div.innerText || '';
            };
            const text = [modelData.title, modelData.keywords, stripHTML(modelData.content).slice(0, 2000)].filter(Boolean).join(' ');
            modelData.embedding = await AIModelService.getEmbedding(text, 'passage');
          } catch (err) {
            console.warn('[MODEL-EMBED] Erro ao regenerar embedding:', err);
          }
        } else if (modelData.embedding) {
          // Limpar embedding desatualizado para regenerar depois
          delete modelData.embedding;
        }

        const updated = modelLibrary.models.map(m => m.id === modelLibrary.editingModel.id ? modelData : m);
        modelLibrary.setModels(updated);
        // v1.34.0: Rastrear update para sync
        if (cloudSync?.trackChange) cloudSync.trackChange('update', modelData);
        modelLibrary.setHasUnsavedChanges(true);
        TFIDFSimilarity.invalidate();
        apiCache.invalidate('suggestions_');
        modelLibrary.setEditingModel(null);
        setModelSaved(true);
        setTimeout(() => {
          modelLibrary.setNewModel({ title: '', content: '', keywords: '', category: '' });
          if (modelEditorRef.current?.root) modelEditorRef.current.root.innerHTML = '';
          closeModal('modelForm');
          setError('');
          setModelSaved(false);
        }, 1200);
      } else {
        // Novo modelo - verificar similaridade
        const modelId = generateModelId();
        const modelData = {
          ...modelLibrary.newModel,
          content: currentContent,
          id: modelId,
          createdAt: new Date().toISOString()
        };

        // üîç v1.13.1: Verificar similaridade com TF-IDF
        const simResult = TFIDFSimilarity.findSimilar(modelData, modelLibrary.models, 0.80);
        if (simResult.hasSimilar) {
          modelLibrary.setSimilarityWarning({
            newModel: modelData,
            similarModel: simResult.similarModel,
            similarity: simResult.similarity,
            context: 'saveModel'
          });
          return;
        }

        await executeSaveModel(modelData);
      }
    } catch (err) {
      setError('Erro ao salvar modelo: ' + err.message);
    } finally {
      setSavingModel(false);
    }
  };

  const saveModelWithoutClosing = async () => {
    // üîß BUGFIX: Capturar conte√∫do diretamente do editor Quill (igual saveTopicEditWithoutClosing)
    // Previne problema onde state pode estar desatualizado ao apertar Ctrl+S
    const currentContent = modelEditorRef.current?.root
      ? sanitizeHTML(modelEditorRef.current.root.innerHTML)
      : modelLibrary.newModel.content;

    if (!modelLibrary.newModel.title || !currentContent) {
      setError('T√≠tulo e conte√∫do s√£o obrigat√≥rios');
      return;
    }

    try {
      if (modelLibrary.editingModel) {
        const modelData = {
          ...modelLibrary.editingModel,
          title: modelLibrary.newModel.title,
          content: currentContent,  // üîß BUGFIX: Usar conte√∫do atual do editor
          keywords: modelLibrary.newModel.keywords,
          category: modelLibrary.newModel.category,
          updatedAt: new Date().toISOString()
        };

        const updated = modelLibrary.models.map(m => m.id === modelLibrary.editingModel.id ? modelData : m);
        modelLibrary.setModels(updated);
        // v1.34.0: Rastrear update para sync
        if (cloudSync?.trackChange) cloudSync.trackChange('update', modelData);
        modelLibrary.setHasUnsavedChanges(true);
                modelLibrary.setEditingModel(modelData);

        // üîß BUGFIX: Atualizar tamb√©m o newModel.content para manter state sincronizado
        modelLibrary.setNewModel({ ...modelLibrary.newModel, content: currentContent });
      } else {
        const modelId = generateModelId();
        const modelData = {
          ...modelLibrary.newModel,
          content: currentContent,  // üîß BUGFIX: Usar conte√∫do atual do editor
          id: modelId,
          createdAt: new Date().toISOString()
        };

        modelLibrary.setModels(prev => [...prev, modelData]);
        // v1.34.0: Rastrear create para sync
        if (cloudSync?.trackChange) cloudSync.trackChange('create', modelData);
        modelLibrary.setHasUnsavedChanges(true);
                modelLibrary.setEditingModel(modelData);

        // üîß BUGFIX: Atualizar tamb√©m o newModel.content para manter state sincronizado
        modelLibrary.setNewModel({ ...modelLibrary.newModel, content: currentContent });
      }

      setError('');

      // Feedback visual tempor√°rio
      const successMsg = document.createElement('div');
      successMsg.className = 'fixed top-4 left-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-pulse';
      successMsg.innerHTML = '<span>‚úì</span> Modelo salvo!';
      document.body.appendChild(successMsg);
      setTimeout(() => successMsg.remove(), 2000);
    } catch (err) {
      setError('Erro ao salvar modelo: ' + err.message);
    }
  };

  // Salva edi√ß√µes r√°pidas de um modelo
  // v1.27.02: Regenerar embedding se IA local estiver ativa
  const saveQuickEdit = async (editorRef) => {
    if (!modelPreview.previewingModel) {
      showToast('Erro: nenhum modelo selecionado', 'error');
      return;
    }

    // Capturar conte√∫do do editor Quill
    const newContent = editorRef.current?.root
      ? sanitizeHTML(editorRef.current.root.innerHTML)
      : modelPreview.editedContent;

    if (!newContent || !newContent.trim()) {
      showToast('Conte√∫do n√£o pode estar vazio', 'error');
      return;
    }

    try {
      const modelId = modelPreview.previewingModel.id;
      if (!modelLibrary.models.some(m => m.id === modelId)) {
        showToast('Modelo n√£o encontrado na biblioteca', 'error');
        return;
      }

      const updatedModel = {
        ...modelPreview.previewingModel,
        content: newContent,
        updatedAt: new Date().toISOString()
      };

      // v1.27.02: Regenerar embedding se IA local estiver ativa
      if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady) {
        await new Promise(resolve => setTimeout(resolve, 50));
        try {
          const stripHTML = (html) => {
            const div = document.createElement('div');
            div.innerHTML = html || '';
            return div.textContent || div.innerText || '';
          };
          const text = [updatedModel.title, updatedModel.keywords, stripHTML(updatedModel.content).slice(0, 2000)].filter(Boolean).join(' ');
          updatedModel.embedding = await AIModelService.getEmbedding(text, 'passage');
        } catch (err) {
          console.warn('[MODEL-EMBED] Erro ao regenerar embedding:', err);
        }
      } else if (updatedModel.embedding) {
        delete updatedModel.embedding;
      }

      modelLibrary.setModels(modelLibrary.models.map(m => m.id === modelId ? updatedModel : m));
      // v1.34.0: Rastrear update para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('update', updatedModel);
      modelLibrary.setHasUnsavedChanges(true);
      TFIDFSimilarity.invalidate();
      apiCache.invalidate('suggestions_');

      // Sincronizar sugest√µes se existirem (evita mostrar conte√∫do antigo ao clicar "Visualizar" novamente)
      if (modelLibrary.suggestions?.length > 0) {
        modelLibrary.setSuggestions(
          modelLibrary.suggestions.map(s => s.id === modelId ? updatedModel : s)
        );
      }

      // v1.19.2: Notificar listeners (ex: GlobalEditorModal) sobre atualiza√ß√£o do modelo
      if (modelPreview.onModelUpdatedRef?.current) {
        modelPreview.onModelUpdatedRef.current(updatedModel);
      }

      // Atualizar o modelo no preview para refletir mudan√ßas
      modelPreview.openPreview(updatedModel);
      modelPreview.cancelEditing();

      showToast('Modelo salvo com sucesso!', 'success');
    } catch (err) {
      showToast('Erro ao salvar modelo: ' + err.message, 'error');
    }
  };

  // v1.15.3: Salva como novo modelo (a partir do preview editado)
  // v1.27.02: Gera embedding automaticamente se IA local estiver ativa
  const confirmSaveAsNew = async () => {
    const data = modelPreview.saveAsNewData;
    if (!data) {
      showToast('Erro: nenhum modelo para salvar', 'error');
      return;
    }

    const { title, keywords, category, content } = data;

    if (!title?.trim()) {
      showToast('T√≠tulo √© obrigat√≥rio', 'error');
      return;
    }

    if (!content?.trim()) {
      showToast('Conte√∫do n√£o pode estar vazio', 'error');
      return;
    }

    const modelId = generateModelId();
    const modelData = {
      id: modelId,
      title: title.trim(),
      content: sanitizeHTML(content),
      keywords: keywords?.trim() || '',
      category: category || 'M√©rito',
      createdAt: new Date().toISOString()
    };

    // Verificar similaridade com TF-IDF
    const simResult = TFIDFSimilarity.findSimilar(modelData, modelLibrary.models, 0.80);
    if (simResult.hasSimilar) {
      modelLibrary.setSimilarityWarning({
        newModel: modelData,
        similarModel: simResult.similarModel,
        similarity: simResult.similarity,
        context: 'saveAsNew'
      });
      return;
    }

    // v1.27.02: Gerar embedding se IA local estiver ativa
    if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady) {
      await new Promise(resolve => setTimeout(resolve, 50));
      try {
        const stripHTML = (html) => {
          const div = document.createElement('div');
          div.innerHTML = html || '';
          return div.textContent || div.innerText || '';
        };
        const text = [modelData.title, modelData.keywords, stripHTML(modelData.content).slice(0, 2000)].filter(Boolean).join(' ');
        modelData.embedding = await AIModelService.getEmbedding(text, 'passage');
      } catch (err) {
        console.warn('[MODEL-EMBED] Erro ao gerar embedding:', err);
      }
    }

    // Salvar novo modelo
    modelLibrary.setModels(prev => [...prev, modelData]);
    // v1.34.0: Rastrear create para sync
    if (cloudSync?.trackChange) cloudSync.trackChange('create', modelData);
    modelLibrary.setHasUnsavedChanges(true);
    TFIDFSimilarity.invalidate();
    apiCache.invalidate('suggestions_');

    showToast('Novo modelo criado com sucesso!', 'success');
    modelPreview.closeSaveAsNew();
    modelPreview.closePreview();
  };

  // v1.15.3: Executa salvamento de "Salvar como Novo" (chamado ap√≥s confirma√ß√£o de similaridade)
  // v1.27.02: Gera embedding automaticamente se IA local estiver ativa
  const executeSaveAsNew = async (modelData, isReplace = false, replaceId = null) => {
    // Gerar embedding se modelo de busca estiver pronto E op√ß√£o ativada
    if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady && !modelData.embedding) {
      await new Promise(resolve => setTimeout(resolve, 50));
      try {
        const stripHTML = (html) => {
          const div = document.createElement('div');
          div.innerHTML = html || '';
          return div.textContent || div.innerText || '';
        };
        const text = [modelData.title, modelData.keywords, stripHTML(modelData.content).slice(0, 2000)].filter(Boolean).join(' ');
        modelData.embedding = await AIModelService.getEmbedding(text, 'passage');
      } catch (err) {
        console.warn('[MODEL-EMBED] Erro ao gerar embedding:', err);
      }
    } else if (!aiIntegration.aiSettings.modelSemanticEnabled && modelData.embedding) {
      delete modelData.embedding;
    }

    if (isReplace && replaceId) {
      const updatedModel = { ...modelData, id: replaceId, updatedAt: new Date().toISOString() };
      const updated = modelLibrary.models.map(m =>
        m.id === replaceId ? updatedModel : m
      );
      modelLibrary.setModels(updated);
      // v1.34.0: Rastrear update para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('update', updatedModel);
    } else {
      modelLibrary.setModels(prev => [...prev, modelData]);
      // v1.34.0: Rastrear create para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('create', modelData);
    }
    modelLibrary.setHasUnsavedChanges(true);
    TFIDFSimilarity.invalidate();
    apiCache.invalidate('suggestions_');
    showToast('Novo modelo criado com sucesso!', 'success');
    modelPreview.closeSaveAsNew();
    modelPreview.closePreview();
  };

  const startEditingModel = (model) => {
    modelLibrary.setEditingModel(model);
    modelLibrary.setNewModel({
      title: model.title,
      content: model.content,
      keywords: model.keywords || '',
      category: model.category || ''
    });
    openModal('modelForm');
    
    // Scroll suave para o formul√°rio de edi√ß√£o
    setTimeout(() => {
      if (modelFormRef.current) {
        modelFormRef.current.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    }, 100);

    setTimeout(() => {
      if (modelEditorRef.current?.root) {
        modelEditorRef.current.root.innerHTML = sanitizeHTML(model.content);
      }
    }, 200);
  };

  const exportModels = async () => {
    try {
      const modelsToExport = modelLibrary.selectedCategory === 'all'
        ? modelLibrary.models
        : modelLibrary.models.filter(m => m.category === modelLibrary.selectedCategory);

      const dataStr = JSON.stringify(modelsToExport, null, 2);

      // Copiar para clipboard
      await navigator.clipboard.writeText(dataStr);

      // Download do arquivo
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const categoryName = modelLibrary.selectedCategory === 'all' ? 'todos' : modelLibrary.selectedCategory.toLowerCase().replace(/\s+/g, '-');
      a.download = `sentencify-modelos-${categoryName}-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      modelLibrary.setHasUnsavedChanges(false);
      showToast(`‚úÖ Modelos exportados com sucesso!\n\n${modelsToExport.length} modelo(s) exportado(s).\nArquivo baixado e copiado para √°rea de transfer√™ncia.`, 'success');
    } catch (err) {
      showToast('Erro ao exportar modelos: ' + err.message, 'error');
    }
  };

  // Detecta modelos duplicados no arquivo de importa√ß√£o
  const checkDuplicate = (newModel, existingModels) => {
    // Level 1: Exact title + category match
    const exactMatch = existingModels.find(
      existing => existing.title === newModel.title &&
                  existing.category === (newModel.category || '')
    );

    if (exactMatch) {
      return {
        isDuplicate: true,
        reason: 'Mesmo t√≠tulo e categoria',
        existingId: exactMatch.id
      };
    }

    // Level 2: Exact content match (normalized)
    const normalizeContent = (text) => {
      return text.toLowerCase().trim().replace(/\s+/g, ' ');
    };

    const contentA = normalizeContent(newModel.content);
    const contentMatch = existingModels.find(
      existing => normalizeContent(existing.content) === contentA
    );

    if (contentMatch) {
      return {
        isDuplicate: true,
        reason: 'Conte√∫do id√™ntico (t√≠tulo diferente)',
        existingId: contentMatch.id
      };
    }

    return { isDuplicate: false };
  };

  // v1.27.02: Gera embeddings para modelos importados sem embedding
  const importModels = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const importedModels = JSON.parse(text);

      if (!Array.isArray(importedModels)) {
        setError('Arquivo inv√°lido. Deve conter um array de modelos.');
        return;
      }

      let importCount = 0;
      let duplicateCount = 0;
      const newModels = [];
      const duplicates = [];

      for (const model of importedModels) {
        if (model.title && model.content) {
          const dupCheck = checkDuplicate(model, modelLibrary.models);

          if (dupCheck.isDuplicate) {
            duplicateCount++;
            duplicates.push({
              title: model.title,
              reason: dupCheck.reason,
              existingId: dupCheck.existingId
            });
            continue; // SKIP this model
          }

          const modelId = `${generateModelId()}_import${importCount}`;
          const modelData = {
            ...model,
            id: modelId,
            createdAt: new Date().toISOString(),
            category: model.category || ''
          };
          newModels.push(modelData);
          importCount++;
        }
      }

      // v1.27.02: Gerar embeddings para modelos sem embedding se IA local estiver ativa E op√ß√£o ativada
      if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady && newModels.length > 0) {
        const modelsWithoutEmbedding = newModels.filter(m => !m.embedding || m.embedding.length !== 768);
        if (modelsWithoutEmbedding.length > 0) {
          const stripHTML = (html) => {
            const div = document.createElement('div');
            div.innerHTML = html || '';
            return div.textContent || div.innerText || '';
          };
          for (const model of modelsWithoutEmbedding) {
            try {
              const text = [model.title, model.keywords, stripHTML(model.content).slice(0, 2000)].filter(Boolean).join(' ');
              model.embedding = await AIModelService.getEmbedding(text, 'passage');
              // Yield para n√£o travar UI
              await new Promise(resolve => setTimeout(resolve, 0));
            } catch (err) {
              console.warn('[MODEL-EMBED] Erro ao gerar embedding para modelo importado:', err);
            }
          }
        }
      }

      if (newModels.length > 0) {
        modelLibrary.setModels(prev => [...prev, ...newModels]);
        // v1.35.23: Usar trackChangeBatch para importa√ß√£o eficiente (n√£o 100 chamadas individuais)
        if (cloudSync?.trackChangeBatch) {
          cloudSync.trackChangeBatch(newModels.map(model => ({ operation: 'create', model })));
        }
        modelLibrary.setHasUnsavedChanges(true);
      }

      setError('');

      // Enhanced notification
      if (duplicateCount > 0) {
        showToast(
          `${importCount} modelo(s) importado(s) com sucesso!\n‚ö†Ô∏è ${duplicateCount} duplicata(s) ignorada(s)`,
          importCount > 0 ? 'success' : 'warning'
        );
      } else {
        showToast(`${importCount} modelo(s) importado(s) com sucesso!`, 'success');
      }

    } catch (err) {
      setError('Erro ao importar modelos: ' + err.message);
    }
  };

  // ============================================================================
  // HELPERS PARA GERA√á√ÉO DE MINI-RELAT√ìRIOS (v1.15)
  // ============================================================================

  // Helper: Constr√≥i array de documentos para envio √† API (elimina duplica√ß√£o)
  const buildDocumentContentArray = (options = {}) => {
    const {
      includePeticao = true,
      includeContestacoes = true,
      includeComplementares = false,
      documentsOverride = null // Permite passar documentos diretamente (bypass do estado React)
    } = options;

    // Usar documentsOverride se fornecido, sen√£o usar analyzedDocuments (estado React)
    const docs = documentsOverride || analyzedDocuments;
    const contentArray = [];

    // v1.16.6: Anonimiza√ß√£o j√° aplicada em analyzeDocuments (n√£o duplicar aqui)

    // 1. Peti√ß√µes (m√∫ltiplas) - v1.21: Suporte a peti√ß√£o inicial + emendas
    if (includePeticao) {
      // Primeiro: textos extra√≠dos (PDF.JS ou Claude Vision)
      if (docs.peticoesText?.length > 0) {
        docs.peticoesText.forEach((doc, idx) => {
          contentArray.push({
            type: 'text',
            text: `${doc.name?.toUpperCase() || `PETI√á√ÉO ${idx + 1}`}:\n\n${doc.text}`,
            cache_control: doc.text.length > 2000 ? { type: "ephemeral" } : undefined
          });
        });
      }
      // Depois: PDFs bin√°rios (modo pdf-puro ou fallback)
      // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
      if (docs.peticoes?.length > 0) {
        const textCount = docs.peticoesText?.length || 0;
        docs.peticoes.forEach((base64, index) => {
          const label = index === 0 && textCount === 0 ? 'PETI√á√ÉO INICIAL' : `PETI√á√ÉO ${textCount + index + 1}`;
          contentArray.push({ type: 'text', text: `${label} (documento PDF a seguir):` });
          contentArray.push({
            type: 'document',
            source: { type: 'base64', media_type: 'application/pdf', data: base64 },
            cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
          });
        });
      }
    }

    // 2. Contesta√ß√µes - v1.14.1: Suporte a modos mistos (envia textos E PDFs)
    // v1.25: Adicionado cache_control para otimiza√ß√£o de tokens
    if (includeContestacoes) {
      // Primeiro: textos extra√≠dos (PDF.JS ou Claude Vision)
      if (docs.contestacoesText?.length > 0) {
        docs.contestacoesText.forEach((contestacao, index) => {
          contentArray.push({
            type: 'text',
            text: `CONTESTA√á√ÉO ${index + 1}:\n\n${contestacao.text}`,
            cache_control: contestacao.text.length > 2000 ? { type: "ephemeral" } : undefined
          });
        });
      }
      // Depois: PDFs n√£o extra√≠dos (modo PDF Puro ou fallback)
      // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
      if (docs.contestacoes?.length > 0) {
        const textCount = docs.contestacoesText?.length || 0;
        docs.contestacoes.forEach((base64, index) => {
          contentArray.push({ type: 'text', text: `CONTESTA√á√ÉO ${textCount + index + 1} (documento PDF a seguir):` });
          contentArray.push({
            type: 'document',
            source: { type: 'base64', media_type: 'application/pdf', data: base64 },
            cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
          });
        });
      }
    }

    // 3. Documentos Complementares - v1.14.1: Suporte a modos mistos (envia textos E PDFs)
    // v1.25: Adicionado cache_control para otimiza√ß√£o de tokens
    if (includeComplementares) {
      // Primeiro: textos extra√≠dos (PDF.JS ou Claude Vision)
      if (docs.complementaresText?.length > 0) {
        docs.complementaresText.forEach((doc, index) => {
          contentArray.push({
            type: 'text',
            text: `DOCUMENTO COMPLEMENTAR ${index + 1}:\n\n${doc.text}`,
            cache_control: doc.text.length > 2000 ? { type: "ephemeral" } : undefined
          });
        });
      }
      // Depois: PDFs n√£o extra√≠dos (modo PDF Puro ou fallback)
      // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
      if (docs.complementares?.length > 0) {
        const textCount = docs.complementaresText?.length || 0;
        docs.complementares.forEach((base64, index) => {
          contentArray.push({ type: 'text', text: `DOCUMENTO COMPLEMENTAR ${textCount + index + 1} (documento PDF a seguir):` });
          contentArray.push({
            type: 'document',
            source: { type: 'base64', media_type: 'application/pdf', data: base64 },
            cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
          });
        });
      }
    }

    return contentArray;
  };

  // v1.14.3: Reordena t√≥picos via LLM (preliminares ‚Üí prejudiciais ‚Üí m√©rito ‚Üí processuais)
  // v1.31.01: Fix RECITATION - retornar √≠ndices ao inv√©s de t√≠tulos
  const reorderTopicsViaLLM = async (topics) => {
    if (!topics || topics.length <= 1) return topics;

    const topicsList = topics.map((t, i) => `${i + 1}. "${t.title}" (${t.category})`).join('\n');

    const prompt = `Reordene os seguintes t√≥picos de uma a√ß√£o trabalhista na ordem processual correta:

ORDEM PROCESSUAL:
1. RELAT√ìRIO
2. TRAMITA√á√ÉO (Ju√≠zo Digital, Segredo Justi√ßa, Prioridade)
3. IMPUGNA√á√ÉO AOS DOCUMENTOS
4. PRELIMINARES - Art. 337 CPC na ordem: cita√ß√£o ‚Üí incompet√™ncia ‚Üí valor ‚Üí in√©pcia ‚Üí peremp√ß√£o ‚Üí litispend√™ncia ‚Üí coisa julgada ‚Üí conex√£o ‚Üí representa√ß√£o ‚Üí arbitragem ‚Üí legitimidade ‚Üí cau√ß√£o ‚Üí gratuidade
5. PREJUDICIAIS (prescri√ß√£o bienal/quinquenal, decad√™ncia)
6. M√âRITO - ordenar assim:
   6a. Declarat√≥rios/Constitutivos (v√≠nculo, revers√£o justa causa, rescis√£o indireta)
   6b. Obriga√ß√µes de fazer (CTPS, guias)
   6c. Condenat√≥rios (verbas, horas extras, adicionais, danos)
   6d. Responsabilidade - AP√ìS definir o que √© devido (grupo econ√¥mico, solid√°ria, subsidi√°ria)
   6e. Justi√ßa Gratuita - ANTES de honor√°rios
   6f. Honor√°rios - √öLTIMO do m√©rito
7. QUEST√ïES FINAIS (litig√¢ncia m√°-f√©, of√≠cios, juros, limita√ß√£o)

T√ìPICOS A ORDENAR:
${topicsList}

Responda APENAS com JSON: {"order": [1, 3, 2, ...]}
Use os n√∫meros originais da lista.`;

    try {
      const isGemini = aiIntegration.aiSettings?.provider === 'gemini';
      const result = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], {
        maxTokens: 4000, // v1.32.25: Aumentado para evitar truncamento (thinking tokens do Gemini 3)
        useInstructions: false,
        temperature: isGemini ? 0.5 : 0.0,
        topP: 0.9,
        topK: 40
      });

      // v1.32.34: Regex mais robusto para extrair JSON (suporta newlines, markdown, etc.)
      let jsonMatch = result.match(/\{\s*"order"\s*:\s*\[[\d,\s\n\r]+\]\s*\}/);

      // Fallback: tentar extrair de bloco markdown ```json ... ```
      if (!jsonMatch) {
        const markdownMatch = result.match(/```(?:json)?\s*(\{[\s\S]*?"order"[\s\S]*?\})\s*```/);
        if (markdownMatch) {
          jsonMatch = [markdownMatch[1]];
        }
      }

      // Fallback: busca gen√©rica por {"order": [...]}
      if (!jsonMatch) {
        const genericMatch = result.match(/\{[^{}]*"order"\s*:\s*\[[^\]]+\][^{}]*\}/);
        if (genericMatch) jsonMatch = genericMatch;
      }

      if (!jsonMatch) {
        console.warn('[reorderTopicsViaLLM] JSON n√£o encontrado na resposta, mantendo ordem original');
        console.log('[reorderTopicsViaLLM] Resposta recebida:', result.substring(0, 500));
        return topics;
      }

      const cleanResult = jsonMatch[0];
      const parsed = JSON.parse(cleanResult);

      // Novo formato: √≠ndices (evita RECITATION)
      if (parsed.order && Array.isArray(parsed.order)) {
        const orderedTopics = [];
        for (const idx of parsed.order) {
          const topic = topics[idx - 1];
          if (topic) orderedTopics.push(topic);
        }
        for (const topic of topics) {
          if (!orderedTopics.includes(topic)) {
            orderedTopics.push(topic);
          }
        }
        return orderedTopics;
      }

      // Fallback: formato antigo com t√≠tulos (retrocompatibilidade)
      if (parsed.orderedTitles && Array.isArray(parsed.orderedTitles)) {
        const orderedTopics = [];
        for (const title of parsed.orderedTitles) {
          const topic = topics.find(t => t.title.toUpperCase() === title.toUpperCase());
          if (topic) orderedTopics.push(topic);
        }
        for (const topic of topics) {
          if (!orderedTopics.find(t => t.title === topic.title)) {
            orderedTopics.push(topic);
          }
        }
        return orderedTopics;
      }

      console.warn('[reorderTopicsViaLLM] Formato desconhecido, mantendo ordem original');
      return topics;

    } catch (err) {
      console.error('[reorderTopicsViaLLM] Erro:', err);
      return topics;
    }
  };

  // v1.21.27: Fun√ß√£o base que retorna componentes reutiliz√°veis para prompts de mini-relat√≥rio
  const buildMiniReportPromptCore = (options = {}) => {
    const { isInitialGeneration = false } = options;

    const totalContestacoes = (analyzedDocuments.contestacoes?.length || 0) +
                              (analyzedDocuments.contestacoesText?.length || 0);

    const modeloPersonalizado = aiIntegration.aiSettings?.modeloRelatorio?.trim();

    const modeloBase = modeloPersonalizado || `PRIMEIRO PAR√ÅGRAFO (alega√ß√µes do autor):
"O reclamante narra [resumo]. Sustenta [argumentos]. Indica que [situa√ß√£o]. Em decorr√™ncia, postula [pedido]."

SEGUNDO PAR√ÅGRAFO (primeira defesa):
${totalContestacoes > 0 ? '"A primeira reclamada, em defesa, alega [argumentos]. Sustenta que [posi√ß√£o]."' : '"N√£o houve apresenta√ß√£o de contesta√ß√£o."'}

${totalContestacoes > 1 ? `TERCEIRO PAR√ÅGRAFO (segunda defesa):
"A segunda r√©, por sua vez, nega [posi√ß√£o]. Aduz [argumentos]."` : ''}

${totalContestacoes > 2 ? `QUARTO PAR√ÅGRAFO (terceira defesa):
"A terceira reclamada tamb√©m contesta [argumentos]. Sustenta [posi√ß√£o]."` : ''}`;

    const numeracaoPrompt = isInitialGeneration
      ? AI_PROMPTS.numeracaoReclamadasInicial
      : AI_PROMPTS.numeracaoReclamadas;

    let partesInfo = '';
    if (partesProcesso?.reclamadas?.length > 0) {
      partesInfo = `\nPARTES DO PROCESSO:
- Reclamante: ${partesProcesso.reclamante || 'N√£o identificado'}
${partesProcesso.reclamadas.map((r, i) => `- ${i + 1}¬™ Reclamada: ${r}`).join('\n')}
`;
    }

    return {
      totalContestacoes,
      modeloBase,
      modeloPersonalizado,
      numeracaoPrompt,
      partesInfo,
      formatacaoHTML: AI_PROMPTS.formatacaoHTML("O <strong>reclamante</strong> narra que..."),
      formatacaoParagrafos: AI_PROMPTS.formatacaoParagrafos("<p>O reclamante narra...</p><p>A primeira reclamada, em defesa...</p>"),
      nivelDetalhe: aiIntegration.aiSettings?.detailedMiniReports ? `‚ö†Ô∏è N√çVEL DE DETALHE - FATOS:
Gere com alto n√≠vel de detalhe em rela√ß√£o aos FATOS alegados pelas partes.
A descri√ß√£o f√°tica (postulat√≥ria e defensiva) deve ter alto n√≠vel de detalhe.
` : '',
      estiloRedacao: AI_PROMPTS.estiloRedacao,
      preservarAnonimizacao: AI_PROMPTS.preservarAnonimizacao,
      proibicaoMetaComentarios: AI_PROMPTS.proibicaoMetaComentarios // v1.35.29
    };
  };

  // v1.21.27: Helper para prompt de mini-relat√≥rio INDIVIDUAL (usa Core)
  const buildMiniReportPrompt = (options = {}) => {
    const {
      title,
      context = '',
      instruction = '',
      currentRelatorio = '',
      isInitialGeneration = false
    } = options;

    const core = buildMiniReportPromptCore({ isInitialGeneration });

    return `Com base nos documentos processuais fornecidos acima${core.totalContestacoes > 0 ? ` (peti√ß√£o inicial e ${core.totalContestacoes} contesta√ß√£o${core.totalContestacoes > 1 ? '√µes' : ''})` : ' (peti√ß√£o inicial)'}, gere um mini-relat√≥rio narrativo para o t√≥pico "${title}".

${instruction ? `INSTRU√á√ÉO DO USU√ÅRIO:\n${instruction}\n` : ''}

${context ? `CONTEXTO:\n${context}\n` : ''}

${currentRelatorio ? `MINI-RELAT√ìRIO ATUAL:\n${currentRelatorio}\n` : ''}

${core.modeloPersonalizado ? `MODELO PERSONALIZADO:\n${core.modeloBase}` : `FORMATO PADR√ÉO:\n${core.modeloBase}`}
${core.partesInfo}
${core.numeracaoPrompt}

${core.formatacaoHTML}

${core.formatacaoParagrafos}

${core.nivelDetalhe}

${core.estiloRedacao}

${core.preservarAnonimizacao}

${core.proibicaoMetaComentarios}

Responda APENAS com o texto do mini-relat√≥rio formatado em HTML, sem JSON, sem markdown, sem prefixo.`;
  };

  // v1.21.27: Helper para prompt de mini-relat√≥rios BATCH (usa Core)
  const buildBatchMiniReportPrompt = (topics, options = {}) => {
    const { isInitialGeneration = false } = options;

    const core = buildMiniReportPromptCore({ isInitialGeneration });
    const topicsList = topics.map((t, i) => `${i + 1}. "${t.title}"`).join('\n');

    return `Com base nos documentos processuais fornecidos acima${core.totalContestacoes > 0 ? ` (peti√ß√£o inicial e ${core.totalContestacoes} contesta√ß√£o${core.totalContestacoes > 1 ? '√µes' : ''})` : ' (peti√ß√£o inicial)'}, gere mini-relat√≥rios narrativos para os seguintes ${topics.length} t√≥picos:

${topicsList}

FORMATO DE CADA MINI-RELAT√ìRIO:
${core.modeloBase}
${core.partesInfo}
${core.numeracaoPrompt}

${core.formatacaoHTML}

${core.formatacaoParagrafos}

${core.nivelDetalhe}

${core.estiloRedacao}

${core.preservarAnonimizacao}

${core.proibicaoMetaComentarios}

IMPORTANTE: Responda APENAS com um JSON v√°lido no formato:
{
  "reports": [
    { "title": "T√çTULO DO T√ìPICO 1", "relatorio": "<p>Mini-relat√≥rio HTML...</p>" },
    { "title": "T√çTULO DO T√ìPICO 2", "relatorio": "<p>Mini-relat√≥rio HTML...</p>" }
  ]
}

Gere EXATAMENTE ${topics.length} mini-relat√≥rios, um para cada t√≥pico listado, na mesma ordem.`;
  };

  // Fun√ß√£o unificada: Gera um mini-relat√≥rio individual
  const generateMiniReport = async (options = {}) => {
    const {
      title,
      context = '',
      instruction = '',
      currentRelatorio = '',
      includeComplementares = false,
      isInitialGeneration = false,
      maxTokens = 4000,
      documentsOverride = null // Permite passar documentos diretamente (bypass do estado React)
    } = options;

    // 1. Construir array de documentos
    const contentArray = buildDocumentContentArray({
      includePeticao: true,
      includeContestacoes: true,
      includeComplementares,
      documentsOverride
    });

    // 2. Construir e adicionar prompt
    const prompt = buildMiniReportPrompt({
      title,
      context,
      instruction,
      currentRelatorio,
      isInitialGeneration
    });

    contentArray.push({ type: 'text', text: prompt });

    // 3. Chamar API
    // v1.21.26: Parametros para texto juridico (balanceado)
    const result = await aiIntegration.callAI([{
      role: 'user',
      content: contentArray
    }], {
      maxTokens,
      useInstructions: true,
      temperature: 0.4,
      topP: 0.9,
      topK: 60
    });

    // 4. Normalizar e retornar (v1.35.29: remove meta-coment√°rios de revis√£o)
    return removeMetaComments(normalizeHTMLSpacing(result));
  };

  // v1.14.1: Fun√ß√£o para gerar m√∫ltiplos mini-relat√≥rios em UMA requisi√ß√£o
  // v1.21.27: Refatorado para usar buildBatchMiniReportPrompt centralizado
  const generateMultipleMiniReports = async (topics, options = {}) => {
    const {
      includeComplementares = false,
      isInitialGeneration = false,
      documentsOverride = null
    } = options;

    // 1. Construir array de documentos (apenas 1x para todos os t√≥picos)
    const contentArray = buildDocumentContentArray({
      includePeticao: true,
      includeContestacoes: true,
      includeComplementares,
      documentsOverride
    });

    // 2. Usar builder centralizado (v1.21.27)
    const prompt = buildBatchMiniReportPrompt(topics, { isInitialGeneration });
    contentArray.push({ type: 'text', text: prompt });

    // 3. Chamar API com maxTokens escalado (v1.14.2: aumentado cap para 24K/48K)
    // v1.21.26: Parametros para texto juridico (balanceado)
    const isAllInOne = aiIntegration.aiSettings?.topicsPerRequest === 'all';
    const tokenCap = isAllInOne ? 48000 : 24000;
    const maxTokens = Math.min(4000 * topics.length, tokenCap);
    const result = await aiIntegration.callAI([{
      role: 'user',
      content: contentArray
    }], {
      maxTokens,
      useInstructions: true,
      extractText: false,
      temperature: 0.4,
      topP: 0.9,
      topK: 60
    });

    // 6. Parsear resposta JSON (provider-aware)
    const provider = aiIntegration.aiSettings.provider || 'claude';
    const textContent = aiIntegration.extractResponseText(result, provider);
    let cleanText = textContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

    try {
      const parsed = JSON.parse(cleanText);
      if (parsed.reports && Array.isArray(parsed.reports)) {
        // v1.35.29: remove meta-coment√°rios de revis√£o
        return parsed.reports.map(r => ({
          title: r.title,
          relatorio: removeMetaComments(normalizeHTMLSpacing(r.relatorio || ''))
        }));
      }
      throw new Error('Formato de resposta inv√°lido');
    } catch (parseError) {
      // Tentar extrair JSON de dentro do texto
      const jsonMatch = cleanText.match(/\{[\s\S]*"reports"[\s\S]*\}/);
      if (jsonMatch) {
        try {
          const parsed = JSON.parse(jsonMatch[0]);
          if (parsed.reports && Array.isArray(parsed.reports)) {
            // v1.35.29: remove meta-coment√°rios de revis√£o
            return parsed.reports.map(r => ({
              title: r.title,
              relatorio: removeMetaComments(normalizeHTMLSpacing(r.relatorio || ''))
            }));
          }
        } catch (innerParseError) {
          // JSON extra√≠do tamb√©m √© inv√°lido, continuar para o throw abaixo
        }
      }
      throw new Error(`Erro ao parsear resposta de m√∫ltiplos t√≥picos: ${parseError.message}`);
    }
  };

  // Fun√ß√£o batch: Gera m√∫ltiplos mini-relat√≥rios em paralelo (batches de 3)
  // v1.14.1: Suporta m√∫ltiplos t√≥picos por requisi√ß√£o via topicsPerRequest
  const generateMiniReportsBatch = async (topics, options = {}) => {
    const {
      batchSize = 3,
      delayBetweenBatches = 1000,
      onProgress = null // callback(current, total, batchNum)
    } = options;

    // v1.14.1: Obter configura√ß√£o de t√≥picos por requisi√ß√£o
    const topicsPerRequestSetting = aiIntegration.aiSettings?.topicsPerRequest || 1;

    const results = [];
    const errors = [];
    const totalTopics = topics.length;

    // v1.14.2: Agrupar t√≥picos conforme topicsPerRequest (suporta 'all')
    const topicGroups = [];
    if (topicsPerRequestSetting === 'all') {
      topicGroups.push(topics);
    } else {
      const perReq = topicsPerRequestSetting;
      for (let i = 0; i < totalTopics; i += perReq) {
        topicGroups.push(topics.slice(i, i + perReq));
      }
    }

    const totalGroups = topicGroups.length;
    const totalBatches = Math.ceil(totalGroups / batchSize);
    let processedTopics = 0;

    // v1.14.3: Timeout maior para "Todos" (10 min vs 3 min)
    const timeoutMs = topicsPerRequestSetting === 'all' ? 600000 : 360000;

    for (let i = 0; i < totalGroups; i += batchSize) {
      const batch = topicGroups.slice(i, i + batchSize);
      const batchNum = Math.floor(i / batchSize) + 1;

      // Notificar progresso
      if (onProgress) {
        onProgress(processedTopics, totalTopics, batchNum, totalBatches);
      }

      // Processar batch de grupos em paralelo, atualizando progresso a cada resposta
      const promises = batch.map(async (group) => {
        try {
          let groupResults;
          if (group.length === 1) {
            // Grupo com 1 t√≥pico: usar fun√ß√£o individual (comportamento original)
            const topic = group[0];
            const result = await callWithRetry(
              () => generateMiniReport({
                title: topic.title,
                context: topic.context || '',
                instruction: topic.instruction || '',
                includeComplementares: topic.includeComplementares || false,
                isInitialGeneration: topic.isInitialGeneration || false,
                documentsOverride: topic.documentsOverride || null
              }),
              3,
              topic.title,
              null,
              timeoutMs
            );
            groupResults = [{ title: topic.title, relatorio: result, status: 'success' }];
          } else {
            // Grupo com m√∫ltiplos t√≥picos: usar nova fun√ß√£o
            const multiResults = await callWithRetry(
              () => generateMultipleMiniReports(group, {
                includeComplementares: group[0]?.includeComplementares || false,
                isInitialGeneration: group[0]?.isInitialGeneration || false,
                documentsOverride: group[0]?.documentsOverride || null
              }),
              2,
              group.map(t => t.title).join(', '),
              null,
              timeoutMs
            );
            groupResults = multiResults.map(r => ({ ...r, status: 'success' }));
          }
          // Atualizar progresso imediatamente ao receber resposta
          groupResults.forEach(r => {
            processedTopics++;
            if (r.status === 'success') {
              results.push(r);
            } else {
              errors.push(r);
            }
            if (onProgress) {
              onProgress(processedTopics, totalTopics, batchNum, totalBatches);
            }
          });
          return groupResults;
        } catch (err) {
          // Se falhar, retornar erro para cada t√≥pico do grupo
          const errorResults = group.map(t => ({ title: t.title, error: err.message, status: 'error' }));
          errorResults.forEach(r => {
            processedTopics++;
            errors.push(r);
            if (onProgress) {
              onProgress(processedTopics, totalTopics, batchNum, totalBatches);
            }
          });
          return errorResults;
        }
      });

      await Promise.all(promises);

      // Delay entre batches (evitar rate limit)
      if (i + batchSize < totalGroups) {
        await new Promise(resolve => setTimeout(resolve, delayBetweenBatches));
      }
    }

    // Notificar conclus√£o
    if (onProgress) {
      onProgress(totalTopics, totalTopics, totalBatches, totalBatches);
    }

    return { results, errors };
  };

  // ============================================================================
  // FIM DOS HELPERS
  // ============================================================================

  const regenerateRelatorio = async (topicTitle, topicContext) => {
    aiIntegration.setRegenerating(true);
    setAnalysisProgress(`üîÑ Regenerando relat√≥rio para "${topicTitle}"...`);
    try {
      const result = await generateMiniReport({ title: topicTitle, context: topicContext });
      return result;
    } catch (err) {
      setError('Erro ao regerar mini-relat√≥rio: ' + err.message);
      return null;
    } finally {
      aiIntegration.setRegenerating(false);
    }
  };

  const regenerateRelatorioWithInstruction = async () => {
    if (!aiIntegration.relatorioInstruction.trim()) {
      setError('Digite uma instru√ß√£o para regera√ß√£o do mini-relat√≥rio');
      return;
    }
    if (!editingTopic) {
      setError('Nenhum t√≥pico selecionado para edi√ß√£o');
      return;
    }
    const cacheKey = `relatorioCustom_${editingTopic.title}_${aiIntegration.relatorioInstruction}_${JSON.stringify(analyzedDocuments)}`;
    const cachedRelatorio = apiCache.get(cacheKey);
    if (cachedRelatorio) {
      setEditingTopic(prev => ({ ...prev, editedRelatorio: cachedRelatorio }));
      closeModal('regenerateRelatorioCustom');
      return;
    }
    aiIntegration.setRegeneratingRelatorio(true);
    setError('');
    try {
      const isRelatorioTopic = editingTopic.title.toUpperCase().includes('RELAT√ìRIO');
      const instructionMentionsComplementares = /\b(documento complementar|ata|audi√™ncia|prova|juntad[oa]|anexad[oa]|complementar)\b/i.test(aiIntegration.relatorioInstruction);
      const htmlContent = await generateMiniReport({
        title: editingTopic.title,
        instruction: aiIntegration.relatorioInstruction,
        currentRelatorio: editingTopic.editedRelatorio || editingTopic.relatorio,
        includeComplementares: isRelatorioTopic || instructionMentionsComplementares
      });
      apiCache.set(cacheKey, htmlContent);
      const updatedTopic = { ...editingTopic, editedRelatorio: htmlContent, relatorio: htmlContent };
      setEditingTopic(updatedTopic);
      if (relatorioRef.current) {
        relatorioRef.current.root.innerHTML = normalizeHTMLSpacing(sanitizeHTML(htmlContent));
      }
      setSelectedTopics(selectedTopics.map(t => t.title === editingTopic.title ? updatedTopic : t));
      setExtractedTopics(extractedTopics.map(t => t.title === editingTopic.title ? updatedTopic : t));
      aiIntegration.setRelatorioInstruction('');
    } catch (err) {
      setError('Erro ao regerar mini-relat√≥rio: ' + err.message);
    } finally {
      aiIntegration.setRegeneratingRelatorio(false);
    }
  };

  const regenerateRelatorioProcessual = async () => {
    if (!editingTopic || editingTopic.title.toUpperCase() !== 'RELAT√ìRIO') {
      setError('Esta fun√ß√£o s√≥ pode ser usada para o t√≥pico RELAT√ìRIO');
      return;
    }
    aiIntegration.setRegeneratingRelatorio(true);
    setAnalysisProgress('üîÑ Regenerando RELAT√ìRIO processual...');
    try {
      const contentArray = buildDocumentContentArray({ includeComplementares: true });
      const instrucao = aiIntegration.relatorioInstruction.trim();
      if (instrucao) {
        contentArray.push({ type: 'text', text: `‚ö†Ô∏è INSTRU√á√ÉO ADICIONAL DO USU√ÅRIO:\n${instrucao}` });
      }
      const relatorioGerado = await generateRelatorioProcessual(contentArray);
      if (!relatorioGerado?.trim()) throw new Error('Relat√≥rio gerado est√° vazio');
      const htmlContent = normalizeHTMLSpacing(relatorioGerado.trim());
      const updatedTopic = { ...editingTopic, editedRelatorio: htmlContent };
      setEditingTopic(updatedTopic);
      if (relatorioRef.current) {
        relatorioRef.current.root.innerHTML = normalizeHTMLSpacing(sanitizeHTML(htmlContent));
      }
      setSelectedTopics(selectedTopics.map(t => t.title === editingTopic.title ? updatedTopic : t));
      setExtractedTopics(extractedTopics.map(t => t.title === editingTopic.title ? updatedTopic : t));
      setAnalysisProgress('');
      aiIntegration.setRelatorioInstruction('');
      showToast('‚úÖ RELAT√ìRIO processual regenerado!', 'success');
    } catch (err) {
      setError('Erro ao regerar RELAT√ìRIO: ' + err.message);
      setAnalysisProgress('');
    } finally {
      aiIntegration.setRegeneratingRelatorio(false);
    }
  };


  // üìã FUN√á√ïES: Gerenciamento de T√≥picos

  const handleRenameTopic = async (shouldRegenerate = true) => {
    if (!newTopicName.trim() || !topicToRename) return;
    const upperCaseTitle = newTopicName.trim().toUpperCase();
    aiIntegration.setRegenerating(true);
    setError('');
    try {
      let newRelatorio = topicToRename.relatorio;
      if (shouldRegenerate) {
        setAnalysisProgress(`üîÑ Regenerando mini-relat√≥rio para "${upperCaseTitle}"...`);
        const renameContext = `**CONTEXTO DE RENOMEA√á√ÉO:**
T√≥pico ANTERIOR: "${topicToRename.title}"
T√≥pico NOVO: "${upperCaseTitle}"
**INSTRU√á√ÉO:** Busque informa√ß√µes ESPEC√çFICAS sobre "${upperCaseTitle}" nos documentos.
N√ÉO replique o conte√∫do do t√≥pico anterior "${topicToRename.title}".
Se o novo t√≠tulo representa um aspecto DIFERENTE do anterior, extraia informa√ß√µes DIFERENTES.
Se n√£o houver informa√ß√µes espec√≠ficas, indique: "N√£o foram localizadas informa√ß√µes espec√≠ficas sobre ${upperCaseTitle} nas pe√ßas processuais."`;
        newRelatorio = await generateMiniReport({ title: upperCaseTitle, context: renameContext });
      }
      if (newRelatorio) {
        setSelectedTopics(selectedTopics.map(t => t.title === topicToRename.title ? { ...t, title: upperCaseTitle, relatorio: newRelatorio } : t));
        setExtractedTopics(extractedTopics.map(t => t.title === topicToRename.title ? { ...t, title: upperCaseTitle, relatorio: newRelatorio } : t));
      } else {
        setError('N√£o foi poss√≠vel gerar o mini-relat√≥rio para o t√≥pico renomeado.');
      }
    } catch (err) {
      setError('Erro ao renomear t√≥pico: ' + err.message);
    } finally {
      aiIntegration.setRegenerating(false);
    }
    closeModal('rename');
    setTopicToRename(null);
    setNewTopicName('');
  };

  const handleMergeTopics = async () => {
    if (topicsToMerge.length < 2) {
      setError('Selecione pelo menos 2 t√≥picos para unir');
      return;
    }
    aiIntegration.setRegenerating(true);
    setError('');
    try {
      const mergedTitle = topicsToMerge.map(t => t.title).join(' e ');
      setAnalysisProgress(`üîÑ Gerando mini-relat√≥rio unificado para "${mergedTitle}"...`);
      const topicsInfo = topicsToMerge.map((t, i) => `${i + 1}. ${t.title}`).join('\n');
      const mergeContext = `**CONTEXTO DE UNI√ÉO DE T√ìPICOS:**
Os seguintes t√≥picos est√£o sendo unidos em um √∫nico t√≥pico:
${topicsInfo}
**INSTRU√á√ÉO:** Crie um mini-relat√≥rio unificado que contemple TODOS os aspectos dos t√≥picos originais.
Extraia informa√ß√µes relevantes para TODOS os t√≥picos sendo unidos.
Unifique as informa√ß√µes de forma coerente e abrangente.`;
      const newRelatorio = await generateMiniReport({ title: mergedTitle, context: mergeContext });
      if (newRelatorio) {
        const mergedTopic = { title: mergedTitle, category: topicsToMerge[0]?.category || 'M√âRITO', relatorio: newRelatorio, editedContent: '' };
        const mergeSet = new Set(topicsToMerge.map(mt => mt.title));
        // Calcular posi√ß√£o correta: contar quantos itens N√ÉO mesclados v√™m ANTES do primeiro mesclado
        const firstTopicIndex = selectedTopics.findIndex(t => mergeSet.has(t.title));
        const insertPosition = firstTopicIndex >= 0 ? selectedTopics.slice(0, firstTopicIndex).filter(t => !mergeSet.has(t.title)).length : 0;
        const remainingTopics = selectedTopics.filter(t => !mergeSet.has(t.title));
        remainingTopics.splice(insertPosition, 0, mergedTopic);
        setSelectedTopics(remainingTopics);
        const firstExtractedIndex = extractedTopics.findIndex(t => mergeSet.has(t.title));
        const extractInsertPosition = firstExtractedIndex >= 0 ? extractedTopics.slice(0, firstExtractedIndex).filter(t => !mergeSet.has(t.title)).length : 0;
        const remainingExtracted = extractedTopics.filter(t => !mergeSet.has(t.title));
        remainingExtracted.splice(extractInsertPosition, 0, mergedTopic);
        setExtractedTopics(remainingExtracted);
        closeModal('merge');
        setTopicsToMerge([]);
      } else {
        setError('N√£o foi poss√≠vel gerar o mini-relat√≥rio unificado. Tente novamente.');
      }
    } catch (err) {
      setError('Erro ao unir t√≥picos: ' + err.message);
    } finally {
      aiIntegration.setRegenerating(false);
    }
  };

  const handleSplitTopic = async () => {
    if (!topicToSplit || splitNames.filter(n => n.trim()).length < 2) return;
    const validNames = splitNames.filter(n => n.trim()).map(n => n.trim().toUpperCase());
    aiIntegration.setRegenerating(true);
    setError('');
    try {
      const splitContext = `**CONTEXTO DE DIVIS√ÉO:**
T√≥pico original: "${topicToSplit.title}"
**INSTRU√á√ÉO:** Este √© um subt√≥pico derivado de "${topicToSplit.title}".
Extraia APENAS informa√ß√µes relevantes para o subt√≥pico espec√≠fico.
Se n√£o houver informa√ß√µes espec√≠ficas nos documentos, indique de forma clara.`;
      const topicsToGenerate = validNames.map(name => ({
        title: name,
        category: topicToSplit.category,
        context: splitContext,
        includeComplementares: true
      }));
      const { results, errors } = await generateMiniReportsBatch(topicsToGenerate, {
        batchSize: aiIntegration.aiSettings.parallelRequests || 5,
        delayBetweenBatches: 1000,
        onProgress: (current, total, batchNum, totalBatches) => {
          setAnalysisProgress(`üöÄ Gerando subt√≥picos... ${current}/${total} (Lote ${batchNum}/${totalBatches})`);
        }
      });
      if (errors.length > 0) {
        setError(`${errors.length} subt√≥pico(s) falharam: ${errors.map(e => e.error).join('; ')}`);
      }
      const newTopics = results.map(r => ({ title: r.title, category: topicToSplit.category, relatorio: r.relatorio, editedContent: '' }));
      if (newTopics.length === 0) {
        throw new Error('Nenhum subt√≥pico foi gerado com sucesso.');
      }
      const originalIndex = selectedTopics.findIndex(t => t.title === topicToSplit.title);
      const remainingTopics = selectedTopics.filter(t => t.title !== topicToSplit.title);
      remainingTopics.splice(originalIndex, 0, ...newTopics);
      setSelectedTopics(remainingTopics);
      const originalExtractedIndex = extractedTopics.findIndex(t => t.title === topicToSplit.title);
      const remainingExtracted = extractedTopics.filter(t => t.title !== topicToSplit.title);
      remainingExtracted.splice(originalExtractedIndex, 0, ...newTopics);
      setExtractedTopics(remainingExtracted);
    } catch (err) {
      setError('Erro ao separar t√≥pico: ' + err.message);
    } finally {
      aiIntegration.setRegenerating(false);
    }
    closeModal('split');
    setTopicToSplit(null);
    setSplitNames(['', '']);
  };

  const handleCreateNewTopic = async () => {
    if (!newTopicData.title.trim()) {
      setError('Digite um t√≠tulo para o t√≥pico');
      return;
    }
    const upperCaseTitle = newTopicData.title.trim().toUpperCase();
    aiIntegration.setRegenerating(true);
    setError('');
    try {
      let newRelatorio = newTopicData.relatorio.trim();
      if (!newRelatorio && (analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0)) {
        try {
          newRelatorio = await generateMiniReport({
            title: upperCaseTitle,
            context: `T√≥pico criado manualmente na categoria "${newTopicData.category}". Se n√£o houver informa√ß√µes espec√≠ficas, indique que o t√≥pico foi criado manualmente.`,
            includeComplementares: true
          });
        } catch (apiErr) {
          setError('N√£o foi poss√≠vel gerar automaticamente: ' + apiErr.message);
          newRelatorio = plainTextToHtml(`T√≥pico "${upperCaseTitle}" criado manualmente.\n\nErro ao analisar documentos.`);
        }
      } else if (!newRelatorio) {
        newRelatorio = plainTextToHtml(`T√≥pico "${upperCaseTitle}" criado manualmente.\n\nN√£o h√° documentos para an√°lise.`);
      }
      const newTopic = { title: upperCaseTitle, category: newTopicData.category, relatorio: newRelatorio, editedContent: '' };
      setExtractedTopics([...extractedTopics, newTopic]);
      closeModal('newTopic');
      setNewTopicData({ title: '', category: 'M√âRITO', relatorio: '' });
      setError('');
    } catch (err) {
      setError('Erro ao criar t√≥pico: ' + err.message);
    } finally {
      aiIntegration.setRegenerating(false);
    }
  };


  // ü§ñ FUN√á√ïES: Gera√ß√£o de Texto com IA

  const generateAiText = async () => {
    if (!aiIntegration.aiInstruction.trim()) {
      setError('Digite uma instru√ß√£o para a IA');
      return;
    }

    aiIntegration.setGeneratingAi(true);
    aiIntegration.setAiGeneratedText('');

    try {
      const currentContent = editorRef.current?.root?.innerText || '';

      // Preparar documentos usando helper
      const { contentArray, flags } = prepareDocumentsContext(analyzedDocuments);
      const { hasPeticao, hasContestacoes, hasComplementares } = flags;

      // üÜï v1.19.5: Usar fun√ß√£o centralizada para provas
      // v1.19.2: Passar flag de anonimiza√ß√£o
      // v1.21.5: Passar anonConfig para anonimizar texto
      const { proofDocuments, proofsContext, hasProofs } = await prepareProofsContext(
        proofManager, editingTopic?.title, storage.fileToBase64, aiIntegration?.aiSettings?.anonymization?.enabled, aiIntegration?.aiSettings?.anonymization
      );
      contentArray.push(...proofDocuments);

      // Preparar contexto baseado no escopo selecionado
      let decisionContext = '';

      if (topicContextScope === 'current') {
        // Apenas o t√≥pico atual
        decisionContext = `üìã CONTEXTO DO T√ìPICO:
T√≠tulo: ${editingTopic?.title || 'N√£o especificado'}
Categoria: ${editingTopic?.category || 'N√£o especificada'}

üìù MINI-RELAT√ìRIO DO T√ìPICO:
${editingTopic?.relatorio || 'N√£o dispon√≠vel'}

‚úçÔ∏è CONTE√öDO J√Å ESCRITO DA DECIS√ÉO:
${currentContent || 'Ainda n√£o foi escrito nada'}`;
      } else {
        // Toda a decis√£o (todos os t√≥picos)
        decisionContext = 'üìã CONTEXTO COMPLETO DA DECIS√ÉO:\n\n';

        selectedTopics.forEach((t, index) => {
          const titleUpper = t.title.toUpperCase();
          if (titleUpper === 'RELAT√ìRIO') {
            decisionContext += `üìÑ RELAT√ìRIO GERAL:\n${t.editedRelatorio || t.relatorio || 'N√£o dispon√≠vel'}\n\n---\n\n`;
          } else if (titleUpper === 'DISPOSITIVO') {
            decisionContext += `‚öñÔ∏è DISPOSITIVO:\n${t.editedContent || ''}\n\n---\n\n`;
          } else {
            decisionContext += `üìã T√ìPICO ${index}: ${t.title} (${t.category || 'Sem categoria'})
Mini-relat√≥rio: ${t.editedRelatorio || t.relatorio || 'N√£o dispon√≠vel'}
Decis√£o: ${t.editedFundamentacao || t.fundamentacao || 'N√£o escrita'}

---

`;
          }
        });

        decisionContext += `\nüéØ T√ìPICO SENDO EDITADO: ${editingTopic?.title}
‚úçÔ∏è CONTE√öDO J√Å ESCRITO NESTE T√ìPICO:
${currentContent || 'Ainda n√£o foi escrito nada'}`;
      }

      // 8. Adicionar instru√ß√£o de texto
      contentArray.push({
        type: 'text',
        text: `Voc√™ est√° auxiliando na reda√ß√£o de uma DECIS√ÉO JUDICIAL TRABALHISTA.

${decisionContext}

${hasPeticao || hasContestacoes || hasComplementares || hasProofs ? `
üìö DOCUMENTOS DISPON√çVEIS PARA CONSULTA:
${hasPeticao ? '‚úì Peti√ß√£o inicial' : ''}
${hasContestacoes ? '‚úì Contesta√ß√£o(√µes)' : ''}
${hasComplementares ? '‚úì Documento(s) complementar(es)' : ''}
${hasProofs ? '‚úì Prova(s) vinculada(s) a este t√≥pico' : ''}

Os documentos foram anexados acima. Voc√™ pode e DEVE consult√°-los para fundamentar sua decis√£o, especialmente:
- Para identificar alega√ß√µes e argumentos das partes
- Para verificar provas mencionadas
- Para fundamentar sua decis√£o com base no que foi apresentado nos autos
${hasProofs ? '- Para analisar as provas vinculadas e suas respectivas an√°lises/conclus√µes' : ''}
` : ''}
${proofsContext}
üéØ INSTRU√á√ÉO DO USU√ÅRIO:
${aiIntegration.aiInstruction}

‚ö†Ô∏è IMPORTANTE - N√ÉO INCLUIR MINI-RELAT√ìRIO:
- O mini-relat√≥rio j√° foi fornecido acima apenas como CONTEXTO
- N√ÉO repita ou resuma os fatos no texto gerado
- N√ÉO inicie com "Trata-se de...", "Cuida-se de...", "O reclamante postula..."
- V√° DIRETO para a an√°lise jur√≠dica, fundamenta√ß√£o e conclus√£o

${AI_PROMPTS.estiloRedacao}

Com base em TODOS os elementos acima (contexto do t√≥pico, documentos processuais e instru√ß√£o do usu√°rio), gere o texto solicitado.

O texto deve:
- Ser adequado para uma decis√£o judicial trabalhista
- Usar SEMPRE a primeira pessoa
- Manter linguagem formal, mas acess√≠vel
- Evitar latinismos desnecess√°rios
- Ser claro e objetivo
- Considerar o contexto do t√≥pico e o que j√° foi escrito
- FUNDAMENTAR-SE nos documentos processuais (peti√ß√£o, contesta√ß√µes, provas)
- Citar fatos espec√≠ficos dos autos quando relevante
- Aplicar bases legais quando apropriado

${AI_PROMPTS.formatacaoHTML("A <strong>CLT</strong> estabelece que...")}

${AI_PROMPTS.formatacaoParagrafos("<p>Passo a analisar...</p><p>A CLT estabelece...</p>")}

${AI_PROMPTS.numeracaoReclamadas}

Responda APENAS com o texto gerado em HTML, sem pref√°cio, sem explica√ß√µes. Gere texto pronto para ser inserido na decis√£o.`
      });

      // v1.21.26: Parametros para assistente interativo (criativo moderado)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 4000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.5,
        topP: 0.9,
        topK: 80
      });

      aiIntegration.setAiGeneratedText(textContent.trim());
      setError('');
    } catch (err) {
      setError('Erro ao gerar texto com IA: ' + err.message);
    } finally {
      aiIntegration.setGeneratingAi(false);
    }
  };

  const insertAiText = (mode) => {
    if (!aiIntegration.aiGeneratedText || !editorRef.current) return;

        const currentHtml = editorRef.current.root.innerHTML;
    const normalizedAiText = normalizeHTMLSpacing(aiIntegration.aiGeneratedText);
    let newHtml;

    switch (mode) {
      case 'replace':
        newHtml = sanitizeHTML(normalizedAiText);
        break;
      case 'append':
        newHtml = sanitizeHTML(currentHtml + '<br>' + normalizedAiText);
        break;
      case 'prepend':
        newHtml = sanitizeHTML(normalizedAiText + '<br>' + currentHtml);
        break;
    }

    editorRef.current.root.innerHTML = newHtml;

    setEditingTopic({
      ...editingTopic,
      editedFundamentacao: newHtml
    });

    closeModal('aiAssistant');
    aiIntegration.setAiInstruction('');
    aiIntegration.setAiGeneratedText('');
  };

  // ü§ñ v1.19.0: Constr√≥i contexto completo para chat do assistente IA (Editor Individual)
  // üÜï v1.19.5: Agora ass√≠ncrono para suportar PDFs bin√°rios
  const buildContextForChat = React.useCallback(async (userMessage, options = {}) => {
    const currentContent = editorRef.current?.root?.innerText || '';
    const { proofFilter } = options;

    // Preparar documentos usando helper
    const { contentArray, flags } = prepareDocumentsContext(analyzedDocuments);
    const { hasPeticao, hasContestacoes, hasComplementares } = flags;

    // üÜï v1.21.1: Usar fun√ß√£o de provas orais se filtro ativo
    // v1.19.2: Passar flag de anonimiza√ß√£o
    // v1.21.5: Passar anonConfig para anonimizar texto
    const prepareFunction = proofFilter === 'oral' ? prepareOralProofsContext : prepareProofsContext;
    const { proofDocuments, proofsContext, hasProofs } = await prepareFunction(
      proofManager, editingTopic?.title, storage.fileToBase64, aiIntegration?.aiSettings?.anonymization?.enabled, aiIntegration?.aiSettings?.anonymization
    );
    contentArray.push(...proofDocuments);

    // Contexto baseado no escopo selecionado
    let decisionContext = '';
    if (topicContextScope === 'current') {
      decisionContext = `üìã CONTEXTO DO T√ìPICO:
T√≠tulo: ${editingTopic?.title || 'N√£o especificado'}
Categoria: ${editingTopic?.category || 'N√£o especificada'}

üìù MINI-RELAT√ìRIO DO T√ìPICO:
${editingTopic?.relatorio || 'N√£o dispon√≠vel'}

‚úçÔ∏è CONTE√öDO J√Å ESCRITO DA DECIS√ÉO:
${currentContent || 'Ainda n√£o foi escrito nada'}`;
    } else {
      decisionContext = 'üìã CONTEXTO COMPLETO DA DECIS√ÉO:\n\n';
      selectedTopics.forEach((t, index) => {
        const titleUpper = t.title.toUpperCase();
        if (titleUpper === 'RELAT√ìRIO') {
          decisionContext += `üìÑ RELAT√ìRIO GERAL:\n${t.editedRelatorio || t.relatorio || 'N√£o dispon√≠vel'}\n\n---\n\n`;
        } else if (titleUpper === 'DISPOSITIVO') {
          decisionContext += `‚öñÔ∏è DISPOSITIVO:\n${t.editedContent || ''}\n\n---\n\n`;
        } else {
          decisionContext += `üìã T√ìPICO ${index}: ${t.title} (${t.category || 'Sem categoria'})
Mini-relat√≥rio: ${t.editedRelatorio || t.relatorio || 'N√£o dispon√≠vel'}
Decis√£o: ${t.editedFundamentacao || t.fundamentacao || 'N√£o escrita'}

---

`;
        }
      });
      decisionContext += `\nüéØ T√ìPICO SENDO EDITADO: ${editingTopic?.title}
‚úçÔ∏è CONTE√öDO J√Å ESCRITO NESTE T√ìPICO:
${currentContent || 'Ainda n√£o foi escrito nada'}`;
    }

    // Verificar se anonimiza√ß√£o est√° ativada
    const anonymizationEnabled = aiIntegration?.aiSettings?.anonymization?.enabled;

    // Montar prompt completo
    contentArray.push({
      type: 'text',
      text: `Voc√™ est√° auxiliando na reda√ß√£o de uma DECIS√ÉO JUDICIAL TRABALHISTA.

${decisionContext}

${hasPeticao || hasContestacoes || hasComplementares || hasProofs ? `
üìö DOCUMENTOS DISPON√çVEIS PARA CONSULTA:
${hasPeticao ? '‚úì Peti√ß√£o inicial' : ''}
${hasContestacoes ? '‚úì Contesta√ß√£o(√µes)' : ''}
${hasComplementares ? '‚úì Documento(s) complementar(es)' : ''}
${hasProofs ? '‚úì Prova(s) vinculada(s) a este t√≥pico' : ''}

Os documentos foram anexados acima. Voc√™ pode e DEVE consult√°-los para fundamentar sua decis√£o.
${hasProofs ? '- Analise as provas vinculadas e suas respectivas an√°lises/conclus√µes' : ''}
` : ''}
${proofsContext}

${INSTRUCAO_NAO_PRESUMIR}

${AI_PROMPTS.estiloRedacao}
${AI_PROMPTS.numeracaoReclamadas}
${anonymizationEnabled ? AI_PROMPTS.preservarAnonimizacao : ''}

‚ö†Ô∏è N√ÉO INCLUIR MINI-RELAT√ìRIO no texto gerado.

üéØ INSTRU√á√ÉO DO USU√ÅRIO:
${userMessage}

Quando faltar informa√ß√£o expressa necess√°ria √† reda√ß√£o, PERGUNTE ao usu√°rio antes de redigir. Prefira perguntar a presumir.

‚ö†Ô∏è ANTES DE REDIGIR QUALQUER TEXTO DE DECIS√ÉO:
Liste as informa√ß√µes/conclus√µes que voc√™ precisa confirmar com o usu√°rio.
S√≥ prossiga com a reda√ß√£o AP√ìS receber as respostas.
Se n√£o houver nada a confirmar, indique "Nenhuma informa√ß√£o pendente" e prossiga.

Quando gerar texto para a decis√£o, responda em HTML.
${AI_PROMPTS.formatacaoHTML("A <strong>CLT</strong> estabelece...")}
${AI_PROMPTS.formatacaoParagrafos("<p>Primeiro par√°grafo.</p><p>Segundo par√°grafo.</p>")}`
    });

    return contentArray;
  }, [analyzedDocuments, proofManager, editingTopic, topicContextScope, selectedTopics, aiIntegration?.aiSettings?.anonymization?.enabled]);

  // ü§ñ v1.19.0: Handler para inserir resposta do chat no editor
  const handleInsertChatResponse = React.useCallback((mode) => {
    const response = chatAssistant.lastResponse;
    if (!response || !editorRef.current) return;

    const currentHtml = editorRef.current.root.innerHTML;
    const normalizedAiText = normalizeHTMLSpacing(response);
    let newHtml;

    switch (mode) {
      case 'replace':
        newHtml = sanitizeHTML(normalizedAiText);
        break;
      case 'append':
        newHtml = sanitizeHTML(currentHtml + '<br>' + normalizedAiText);
        break;
      case 'prepend':
        newHtml = sanitizeHTML(normalizedAiText + '<br>' + currentHtml);
        break;
      default:
        newHtml = sanitizeHTML(normalizedAiText);
    }

    editorRef.current.root.innerHTML = newHtml;
    setEditingTopic({
      ...editingTopic,
      editedFundamentacao: newHtml
    });
  }, [chatAssistant.lastResponse, editingTopic, setEditingTopic]);

  // ü§ñ v1.19.0: Handler para enviar mensagem no chat
  // v1.21.1: Aceita options (ex: { proofFilter: 'oral' }) para filtrar provas
  // v1.21.13: Removido modal de anonimiza√ß√£o - provas CONFLITO s√£o filtradas em prepareProofsContext
  const handleSendChatMessage = React.useCallback(async (message, options = {}) => {
    const contextBuilderWithOptions = (msg) => buildContextForChat(msg, options);
    await chatAssistant.send(message, contextBuilderWithOptions);
  }, [chatAssistant, buildContextForChat]);

  const generateAiTextForModel = async () => {
    // Verifica√ß√£o defensiva
    if (!aiIntegration?.callAI) {
      console.error('[generateAiTextForModel] aiIntegration.callAI undefined');
      setError('Erro interno: sistema de IA n√£o inicializado. Recarregue a p√°gina.');
      return;
    }
    if (!aiIntegration.aiInstructionModel.trim()) {
      setError('Digite uma instru√ß√£o para a IA');
      return;
    }

    aiIntegration.setGeneratingAiModel(true);
    aiIntegration.setAiGeneratedTextModel('');

    try {
      // FASE 4: Obter conte√∫do atual do editor (Quill ou contentEditable)
      let currentContent = '';
      if (modelEditorRef.current) {
        // Editor Quill - obter texto via root.innerText
        currentContent = modelEditorRef.current.root ? modelEditorRef.current.root.innerText : '';
      }

      const prompt = `Voc√™ est√° auxiliando na cria√ß√£o de um modelo de texto para decis√µes judiciais trabalhistas.

CONTEXTO DO MODELO:
T√≠tulo: ${modelLibrary.newModel.title || 'N√£o especificado'}
Categoria: ${modelLibrary.newModel.category || 'N√£o especificada'}

CONTE√öDO J√Å ESCRITO:
${currentContent || 'Ainda n√£o foi escrito nada'}

INSTRU√á√ÉO DO USU√ÅRIO:
${aiIntegration.aiInstructionModel}

‚ö†Ô∏è IMPORTANTE - N√ÉO INCLUIR MINI-RELAT√ìRIO:
- Este √© um MODELO gen√©rico de decis√£o, n√£o um caso espec√≠fico
- N√ÉO inicie com resumo de fatos ou mini-relat√≥rio
- N√ÉO use "Trata-se de...", "Cuida-se de...", "O reclamante postula..."
- V√° DIRETO para a an√°lise jur√≠dica, fundamenta√ß√£o e conclus√£o
- Use termos gen√©ricos ("o reclamante", "a reclamada", "os documentos dos autos")

${AI_PROMPTS.estiloRedacao}

Baseado no contexto acima e na instru√ß√£o do usu√°rio, gere o texto solicitado. O texto deve:
- Ser adequado para um modelo reutiliz√°vel de decis√£o judicial trabalhista
- Usar SEMPRE a primeira pessoa
- Manter linguagem formal, mas acess√≠vel
- Evitar latinismos desnecess√°rios
- Ser claro e objetivo
- Ser gen√©rico o suficiente para ser adapt√°vel a diferentes casos similares
- Fundamentar em bases legais quando apropriado

Responda APENAS com o texto gerado, sem pref√°cio, sem explica√ß√µes, sem markdown. Gere texto pronto para ser inserido no modelo.`;

      // v1.21.26: Parametros para assistente de modelos (mais criativo)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], {
        maxTokens: 4000,
        useInstructions: true,
        temperature: 0.6,
        topP: 0.9,
        topK: 100
      });

      aiIntegration.setAiGeneratedTextModel(textContent);
      setError('');
    } catch (err) {
      setError('Erro ao gerar texto com IA: ' + err.message);
    } finally {
      aiIntegration.setGeneratingAiModel(false);
    }
  };

  const insertAiTextModel = (mode) => {
    if (!aiIntegration.aiGeneratedTextModel || !modelEditorRef.current) return;

    // Editor Quill - usar API do Quill

    const quillInstance = modelEditorRef.current;
    const generatedText = normalizeHTMLSpacing(aiIntegration.aiGeneratedTextModel);

    switch (mode) {
      case 'replace':
        // Substituir todo o conte√∫do
        quillInstance.root.innerHTML = sanitizeQuillHTML(generatedText);
        break;

      case 'append':
        // Adicionar ao final
        const currentLength = quillInstance.getLength();
        quillInstance.insertText(currentLength - 1, '\n');
        quillInstance.clipboard.dangerouslyPasteHTML(
          quillInstance.getLength(),
          sanitizeQuillHTML(generatedText)
        );
        break;

      case 'prepend':
        // Adicionar no in√≠cio
        quillInstance.clipboard.dangerouslyPasteHTML(0, sanitizeQuillHTML(generatedText + '\n'));
        break;
    }

    // Atualizar estado com o HTML do Quill
    const newContent = sanitizeQuillHTML(quillInstance.root.innerHTML);
    modelLibrary.setNewModel({
      ...modelLibrary.newModel,
      content: newContent
    });


    closeModal('aiAssistantModel');
    aiIntegration.setAiInstructionModel('');
    aiIntegration.setAiGeneratedTextModel('');
  };


  // ‚úèÔ∏è FUN√á√ïES: Editor de Texto

  const applyFormat = (command, value = null) => {
    document.execCommand(command, false, value);
    if (editorRef.current) {
      editorRef.current.focus();
    }
  };

  const applyModelFormat = (command, value = null) => {
    document.execCommand(command, false, value);
    if (modelEditorRef.current) {
      modelEditorRef.current.focus();
    }
  };

  
  const htmlToPlainText = (html) => {
    const temp = document.createElement('div');
    temp.innerHTML = sanitizeHTML(html); // Sanitizar antes de processar
    return temp.textContent || temp.innerText || '';
  };

  const htmlToFormattedText = (html) => {
    if (!html) return '';
    
    let text = html;
    
    // Detectar se √© texto puro (sem tags HTML significativas) ou HTML
    const hasSignificantHtml = /<(p|br|div|ul|ol|li|h[1-6]|strong|b|em|i|u)[^>]*>/i.test(text);
    
    if (!hasSignificantHtml) {
      // √â texto puro - converter quebras de linha simples em duplas para Google Docs
      text = text.replace(/\n/g, '\n\n');
      // Limpar m√∫ltiplas quebras excessivas
      text = text.replace(/\n{3,}/g, '\n\n');
      return text.trim();
    }
    
        // Remover tags de formata√ß√£o mantendo apenas o conte√∫do
    text = text.replace(/<\/?b>/gi, '');
    text = text.replace(/<\/?strong>/gi, '');
    text = text.replace(/<\/?i>/gi, '');
    text = text.replace(/<\/?em>/gi, '');
    text = text.replace(/<\/?u>/gi, '');

    // Converter <br> em quebra de linha simples
    text = text.replace(/<br\s*\/?>/gi, '\n');
    
    // Converter fechamento de par√°grafo em duas quebras de linha
    text = text.replace(/<\/p>/gi, '\n\n');
    text = text.replace(/<p>/gi, '');
    
    // Converter divs em quebras de linha
    text = text.replace(/<\/div>/gi, '\n');
    text = text.replace(/<div>/gi, '');
    
    // Processar listas
    text = text.replace(/<li>/gi, '‚Ä¢ ');
    text = text.replace(/<\/li>/gi, '\n');
    text = text.replace(/<ul>|<\/ul>|<ol>|<\/ol>/gi, '\n');
    
    // Processar cabe√ßalhos
    text = text.replace(/<\/h[1-6]>/gi, '\n\n');
    text = text.replace(/<h[1-6][^>]*>/gi, '');
    
    // Remover outras tags HTML
    text = text.replace(/<[^>]+>/g, '');
    text = text.replace(/&nbsp;/g, ' ');
    text = text.replace(/&amp;/g, '&');
    text = text.replace(/&lt;/g, '<');
    text = text.replace(/&gt;/g, '>');
    text = text.replace(/&quot;/g, '"');
    
    // Limpar m√∫ltiplas quebras de linha excessivas (mais de 2 seguidas)
    text = text.replace(/\n{3,}/g, '\n\n');
    
    return text.trim();
  };

  const plainTextToHtml = (text) => {
    if (!text) return '';
    
    // Converter texto puro em HTML, preservando quebras de linha
    let html = text;
    
    // Escapar caracteres HTML especiais
    html = html.replace(/&/g, '&amp;');
    html = html.replace(/</g, '&lt;');
    html = html.replace(/>/g, '&gt;');
    
    // Converter quebras de linha em <br>
    html = html.replace(/\n/g, '<br>');
    
    return html;
  };

  const cleanHtmlForExport = (html) => {
    if (!html) return '';

    // Preservar a formata√ß√£o original
    let cleaned = html;

    // v1.20.7: Limpar artefatos do Google Docs ANTES de remover spans
    // Usar regex que N√ÉO atravessa outras tags span (evita greedy matching)
    let prevHtml;

    // 1. Remover wrapper docs-internal-guid (m√∫ltiplas passadas para spans aninhados)
    do {
      prevHtml = cleaned;
      cleaned = cleaned.replace(/<span\s+id="docs-internal-guid-[^"]*"[^>]*>([^<]*(?:<(?!span)[^<]*)*)<\/span>/gi, '$1');
    } while (cleaned !== prevHtml);

    // 2. Remover tags <font> (m√∫ltiplas passadas para aninhados)
    do {
      prevHtml = cleaned;
      cleaned = cleaned.replace(/<font[^>]*>([^<]*(?:<(?!font)[^<]*)*)<\/font>/gi, '$1');
    } while (cleaned !== prevHtml);

    // 3. Converter font-weight: 700/bold para <strong> (s√≥ spans sem spans internos)
    do {
      prevHtml = cleaned;
      cleaned = cleaned.replace(/<span\s+style="[^"]*font-weight:\s*(?:700|bold)[^"]*"[^>]*>([^<]*(?:<(?!span)[^<]*)*)<\/span>/gi, '<strong>$1</strong>');
    } while (cleaned !== prevHtml);

    // 4. Converter font-style: italic para <em>
    do {
      prevHtml = cleaned;
      cleaned = cleaned.replace(/<span\s+style="[^"]*font-style:\s*italic[^"]*"[^>]*>([^<]*(?:<(?!span)[^<]*)*)<\/span>/gi, '<em>$1</em>');
    } while (cleaned !== prevHtml);

    // 5. Remover spans com estilos desnecess√°rios do Google Docs
    do {
      prevHtml = cleaned;
      cleaned = cleaned.replace(/<span\s+style="[^"]*(?:font-family|font-size|background-color|font-variant|vertical-align)[^"]*"[^>]*>([^<]*(?:<(?!span)[^<]*)*)<\/span>/gi, '$1');
    } while (cleaned !== prevHtml);

    // 6. Limpar <strong>/<em> vazios e mesclar adjacentes
    cleaned = cleaned.replace(/<strong>\s*<\/strong>/gi, '');
    cleaned = cleaned.replace(/<em>\s*<\/em>/gi, '');
    cleaned = cleaned.replace(/<\/strong>\s*<strong>/gi, '');
    cleaned = cleaned.replace(/<\/em>\s*<em>/gi, '');

    // Normalizar quebras de linha
    cleaned = cleaned.replace(/<br\s*\/?>/gi, '<br>');

    // v1.20.7: Remover atributos style/class de tags de formata√ß√£o (Quill adiciona estilos inline)
    cleaned = cleaned.replace(/<(strong|em|b|i|u)(\s+[^>]*)>/gi, '<$1>');

    // Normalizar tags de formata√ß√£o
    cleaned = cleaned.replace(/<strong>/gi, '<b>');
    cleaned = cleaned.replace(/<\/strong>/gi, '</b>');
    cleaned = cleaned.replace(/<em>/gi, '<i>');
    cleaned = cleaned.replace(/<\/em>/gi, '</i>');

    // Remover divs vazias e spans desnecess√°rios
    cleaned = cleaned.replace(/<div><\/div>/gi, '');
    cleaned = cleaned.replace(/<span[^>]*>(.*?)<\/span>/gi, '$1');
    
    // Converter quebras de linha duplas em par√°grafos
    cleaned = cleaned.replace(/(<br>\s*<br>)/gi, '</p><p>');
    
    // Se n√£o come√ßa com <p>, envolver em <p>
    if (!cleaned.trim().startsWith('<p') && !cleaned.trim().startsWith('<ul') && !cleaned.trim().startsWith('<ol') && !cleaned.trim().startsWith('<h')) {
      cleaned = '<p>' + cleaned + '</p>';
    }
    
    // Limpar par√°grafos vazios
    cleaned = cleaned.replace(/<p><\/p>/gi, '');
    cleaned = cleaned.replace(/<p>\s*<\/p>/gi, '');
    
    return cleaned.trim();
  };

  const confirmDeleteModel = (model) => {
    modelLibrary.setModelToDelete(model);
    openModal('deleteModel');
  };

  const executeDeleteModel = async () => {
    if (!modelLibrary.modelToDelete) return;

    try {
      const modelId = modelLibrary.modelToDelete.id;
      const modelToDelete = modelLibrary.modelToDelete;
      modelLibrary.setModels(modelLibrary.models.filter(m => m.id !== modelId));
      // v1.34.0: Rastrear delete para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('delete', { ...modelToDelete, updatedAt: new Date().toISOString() });
      modelLibrary.setHasUnsavedChanges(true);
      // Remover das sugest√µes tamb√©m
      if (modelLibrary.suggestions?.length > 0) {
        modelLibrary.setSuggestions(modelLibrary.suggestions.filter(m => m.id !== modelId));
      }
      closeModal('deleteModel');
      modelLibrary.setModelToDelete(null);
    } catch (err) {
      setError('Erro ao excluir modelo: ' + err.message);
    }
  };

  const deleteAllModels = async () => {
    if (modelLibrary.deleteAllConfirmText !== 'EXCLUIR') {
      setError('Digite "EXCLUIR" para confirmar');
      return;
    }

    try {
      // v1.35.2: Rastrear cada modelo como delete para sync com servidor
      const modelsToDelete = [...modelLibrary.models];
      const now = new Date().toISOString();

      for (const model of modelsToDelete) {
        if (cloudSync?.trackChange) {
          cloudSync.trackChange('delete', { ...model, updatedAt: now });
        }
      }

      modelLibrary.setModels([]);
      modelLibrary.setHasUnsavedChanges(true);
      closeModal('deleteAllModels');
      modelLibrary.setDeleteAllConfirmText('');
    } catch (err) {
      setError('Erro ao excluir todos os modelos: ' + err.message);
    }
  };

  // v1.27.02: Gera embedding automaticamente se IA local estiver ativa
  // v1.33.7: Feedback visual ao duplicar modelo
  const duplicateModel = async (model) => {
    try {
      showToast('‚è≥ Duplicando modelo...', 'info');
      await new Promise(resolve => setTimeout(resolve, 50)); // yield para UI

      const modelId = generateModelId();
      const duplicatedModel = {
        ...model,
        id: modelId,
        title: `${model.title} (C√≥pia)`,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        embedding: undefined, // Limpar para regenerar com novo t√≠tulo
        // v1.35.22: C√≥pia √© modelo pr√≥prio, n√£o compartilhado
        isShared: false,
        ownerId: undefined,
        ownerEmail: undefined,
        sharedPermission: undefined,
      };

      // v1.27.02: Gerar novo embedding se IA local estiver ativa
      if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady) {
        await new Promise(resolve => setTimeout(resolve, 50));
        try {
          const stripHTML = (html) => {
            const div = document.createElement('div');
            div.innerHTML = html || '';
            return div.textContent || div.innerText || '';
          };
          const text = [duplicatedModel.title, duplicatedModel.keywords, stripHTML(duplicatedModel.content).slice(0, 2000)].filter(Boolean).join(' ');
          duplicatedModel.embedding = await AIModelService.getEmbedding(text, 'passage');
        } catch (err) {
          console.warn('[MODEL-EMBED] Erro ao gerar embedding:', err);
        }
      }

      modelLibrary.setModels(prev => [...prev, duplicatedModel]);
      // v1.34.0: Rastrear create para sync (duplica√ß√£o cria novo modelo)
      if (cloudSync?.trackChange) cloudSync.trackChange('create', duplicatedModel);
      modelLibrary.setHasUnsavedChanges(true);

      showToast('‚úÖ Modelo duplicado com sucesso!', 'success');
    } catch (err) {
      setError('Erro ao duplicar modelo: ' + err.message);
    }
  };

  // Fun√ß√£o para extrair modelo do texto de decis√£o
  const confirmExtractModel = () => {
    if (!editingTopic || !editorRef.current) {
      setError('Nenhum t√≥pico em edi√ß√£o');
      return;
    }

        const decisionText = editorRef.current.root ? editorRef.current.root.innerText : '';

    if (!decisionText || decisionText.trim().length < 100) {
      setError('Texto da decis√£o muito curto (m√≠nimo 100 caracteres)');
      return;
    }

    // Mostrar modal de confirma√ß√£o
    openModal('extractModelConfirm');
  };

  // v1.13.2: Salvar como modelo (preserva texto 100%, sem usar IA)
  const saveAsModel = () => {
    if (!editingTopic || !editorRef.current) {
      setError('Nenhum t√≥pico em edi√ß√£o');
      return;
    }
    const htmlContent = editorRef.current.root ? sanitizeHTML(editorRef.current.root.innerHTML) : '';
    if (!htmlContent || htmlContent.replace(/<[^>]+>/g, '').trim().length < 50) {
      setError('Texto da decis√£o muito curto');
      return;
    }
    modelLibrary.setEditingModel(null);
    modelLibrary.setNewModel({
      title: editingTopic.title || '',
      content: htmlContent,
      keywords: '',
      category: editingTopic.category || ''
    });
    setActiveTab('models');
    openModal('modelForm');
    setTimeout(() => {
      if (modelEditorRef.current?.root) {
        modelEditorRef.current.root.innerHTML = htmlContent;
      }
    }, 100);
  };

  const extractModelFromDecisionText = async () => {
    closeModal('extractModelConfirm');
    modelLibrary.setExtractingModelFromDecision(true);
    setError('');

        const decisionText = editorRef.current.root ? editorRef.current.root.innerText : '';

    // üöÄ v1.8.2: Cache key baseado em texto + t√≠tulo + categoria do t√≥pico
    const cacheKey = `extractModel_${editingTopic?.title}_${editingTopic?.category}_${decisionText}`;

    // üöÄ v1.8.2: Verificar cache antes de chamar API
    const cachedModel = apiCache.get(cacheKey);
    if (cachedModel) {
      try {
        const parsedResponse = JSON.parse(cachedModel);
        if (parsedResponse.modelos && Array.isArray(parsedResponse.modelos) && parsedResponse.modelos.length > 0) {
          const modelo = parsedResponse.modelos[0];
          modelLibrary.openCreateModelModal({
            title: modelo.titulo,
            category: modelo.categoria,
            keywords: modelo.palavrasChave,
            content: modelo.conteudo
          });
          setError('');
        }
      } catch (err) {
        // Se falhar, continua com chamada API normal abaixo
      }
      modelLibrary.setExtractingModelFromDecision(false);
      return; // Retornar se cache funcionou
    }

    try {

      const analysisPrompt = `Voc√™ √© um assistente jur√≠dico especializado em criar modelos de decis√£o trabalhista GEN√âRICOS e REUTILIZ√ÅVEIS.

TAREFA: Analise o texto de decis√£o judicial fornecido e transforme-o em UM MODELO GEN√âRICO e REUTILIZ√ÅVEL.

‚ö†Ô∏è ATEN√á√ÉO - REGRAS DE GENERALIZA√á√ÉO (MUITO IMPORTANTE):

1. **REMOVA informa√ß√µes espec√≠ficas do caso concreto:**
   - ‚ùå N√ÉO use nomes de partes (ex: "Jo√£o da Silva", "Empresa XYZ Ltda")
   - ‚ùå N√ÉO use valores monet√°rios espec√≠ficos (ex: "R$ 5.000,00")
   - ‚ùå N√ÉO use datas espec√≠ficas (ex: "10/05/2023")
   - ‚ùå N√ÉO use n√∫meros de processo
   - ‚ùå N√ÉO use endere√ßos ou locais espec√≠ficos

2. **USE termos gen√©ricos:**
   - ‚úÖ "o reclamante", "a reclamada", "a empresa"
   - ‚úÖ "o valor devido", "o montante apurado"
   - ‚úÖ "o per√≠odo trabalhado", "a data da rescis√£o"
   - ‚úÖ "os documentos apresentados", "as provas dos autos"

3. **FOQUE na fundamenta√ß√£o jur√≠dica:**
   - Argumenta√ß√£o legal aplic√°vel a casos similares
   - An√°lise de requisitos jur√≠dicos gen√©ricos
   - Racioc√≠nio jur√≠dico reproduz√≠vel
   - Conclus√µes adapt√°veis a diferentes situa√ß√µes

4. **MANTENHA a estrutura, o estilo e a qualidade textual:**
   - Preserve o tom e a formata√ß√£o do texto original
   - Mantenha os par√°grafos bem desenvolvidos e conectivos entre eles
   - Conserve a linha argumentativa fluida
   - Mantenha a coes√£o e progress√£o textual
   - N√ÉO fragmente em enumera√ß√µes excessivas
   - Mantenha reda√ß√£o em prosa corrida quando o original estiver assim

üö® PRESERVA√á√ÉO LITERAL DO TEXTO (CR√çTICO - EXTREMAMENTE IMPORTANTE):

Esta √© a regra MAIS IMPORTANTE de todas. Se voc√™ n√£o seguir isso, o modelo ser√° IN√öTIL.

**O QUE VOC√ä DEVE FAZER:**
- Fazer APENAS substitui√ß√µes literais de informa√ß√µes espec√≠ficas por termos gen√©ricos
- Funcionar como "CTRL+F ‚Üí SUBSTITUIR": encontrar nomes/valores/datas e trocar por gen√©ricos
- PRESERVAR TODO O RESTO DO TEXTO EXATAMENTE COMO EST√Å
- Manter a reda√ß√£o, estrutura de frases, argumenta√ß√£o, conectivos, tudo ID√äNTICO

**O QUE VOC√ä N√ÉO DEVE FAZER:**
- ‚ùå N√ÉO resuma o texto
- ‚ùå N√ÉO reescreva com suas pr√≥prias palavras
- ‚ùå N√ÉO simplifique a argumenta√ß√£o
- ‚ùå N√ÉO altere a estrutura das frases
- ‚ùå N√ÉO mude conectivos ou express√µes jur√≠dicas
- ‚ùå N√ÉO "melhore" ou "otimize" o texto original

**EXEMPLO DO QUE FAZER:**

‚ùå ERRADO (resumindo/reescrevendo):
Texto original: "A pretens√£o autoral merece acolhimento. Com efeito, restou comprovado nos autos que o reclamante Jo√£o da Silva laborou para a empresa Acme Ltda no per√≠odo de 01/01/2020 a 31/12/2023, recebendo sal√°rio mensal de R$ 3.500,00. A jornada habitual era das 8h √†s 18h, com uma hora de intervalo, conforme cart√µes de ponto de fls. 45/89."

Modelo ERRADO: "A pretens√£o √© procedente. Ficou demonstrado que houve rela√ß√£o de trabalho com jornada superior √† legal."

‚úÖ CORRETO (apenas substituindo dados espec√≠ficos):
Modelo CORRETO: "A pretens√£o autoral merece acolhimento. Com efeito, restou comprovado nos autos que o reclamante laborou para a reclamada no per√≠odo trabalhado, recebendo o sal√°rio mensal contratado. A jornada habitual era das [hor√°rio de in√≠cio] √†s [hor√°rio de t√©rmino], com uma hora de intervalo, conforme cart√µes de ponto dos autos."

**REGRA DE OURO:**
Se voc√™ n√£o tem certeza se deve alterar algo, N√ÉO ALTERE. Preserve o texto original.
Seu trabalho √© fazer "buscar e substituir" de dados espec√≠ficos, N√ÉO reescrever.

**CHECKLIST FINAL - VERIFIQUE ANTES DE RESPONDER:**
‚úì Mantive a estrutura exata das frases do original?
‚úì Mantive os mesmos conectivos (ademais, com efeito, nesse sentido, etc.)?
‚úì Mantive a mesma argumenta√ß√£o jur√≠dica?
‚úì Mantive a mesma ordem dos argumentos?
‚úì Fiz APENAS substitui√ß√µes de nomes, valores, datas por termos gen√©ricos?
‚úì O texto tem o mesmo tamanho/extens√£o do original (n√£o resumi)?

EXCLUSAO OBRIGATORIA DE MINI-RELATORIO (CRITICO):

Esta e uma das regras MAIS IMPORTANTES. Se voce incluir mini-relatorio, o modelo sera INUTIL.

PROIBIDO ABSOLUTAMENTE (exemplos do que NAO fazer):
- "O reclamante pleiteia..."
- "O reclamante postula..."
- "O reclamante alega..."
- "As reclamadas impugnaram..."
- "A reclamada sustenta..."
- "Trata-se de..."
- "Cuida-se de..."
- "O reclamante ajuizou..."
- Qualquer resumo das alegacoes das partes
- Qualquer descricao do que foi pedido ou contestado

CORRETO - Como DEVE comecar o modelo:
- "A configuracao de grupo economico..."
- "O reconhecimento do vinculo empregaticio..."
- "A concessao de horas extras..."
- "Para caracterizacao da jornada..."
- "A caracterizacao do dano moral..."
- Diretamente com ANALISE JURIDICA, FUNDAMENTOS LEGAIS, DOUTRINA, PRECEDENTES

‚ö†Ô∏è IMPORTANTE - PRESERVA√á√ÉO DE CITA√á√ïES DOUTRIN√ÅRIAS E JURISPRUDENCIAIS:

Esta regra e CRITICA para manter a qualidade e fundamentacao do modelo extraido.

O QUE PRESERVAR (MANTER INTEGRALMENTE):
‚úÖ Citacoes de autores (ex: "Segundo Mauricio Godinho Delgado...")
‚úÖ Citacoes de jurisprudencia (ex: "Conforme TST-AIRR-1234-56.2023...")
‚úÖ Sumulas (ex: "A Sumula 437 do TST estabelece...")
‚úÖ Orientacoes Jurisprudenciais (ex: "A OJ 415 da SDI-1 dispoe...")
‚úÖ Precedentes vinculantes (ex: "Nos termos do Tema 1046 do TST...")
‚úÖ Referencias doutrinarias completas (autor, obra, citacao)
‚úÖ Referencias jurisprudenciais completas (tribunal, numero, ementa)
‚úÖ Fundamentos teoricos e academicos

O QUE GENERALIZAR (SUBSTITUIR POR TERMOS GENERICOS):
üîÑ Nomes de partes especificas ‚Üí "o reclamante", "a reclamada"
üîÑ Valores monetarios especificos ‚Üí "[valor]", "quantia devida"
üîÑ Datas especificas ‚Üí "periodo trabalhado", "data da rescisao"
üîÑ Locais especificos ‚Üí "local de trabalho", "estabelecimento"
üîÑ Documentos especificos do caso ‚Üí "prova documental", "laudo pericial"
üîÑ Testemunhas especificas ‚Üí "prova testemunhal"

O QUE NUNCA FAZER:
‚ùå N√ÉO remova citacoes de autores renomados
‚ùå N√ÉO remova referencias a precedentes e jurisprudencia
‚ùå N√ÉO remova fundamentacao teorica/doutrinaria
‚ùå N√ÉO substitua nomes de doutrinadores por termos genericos
‚ùå N√ÉO remova numeros de processos citados como precedentes

EXEMPLO CORRETO DE PRESERVA√á√ÉO:

ORIGINAL:
"A pretensao autoral merece acolhimento. Segundo Mauricio Godinho Delgado,
a configuracao de grupo economico exige demonstracao de direcao, controle
ou administracao comum (TST-AIRR-1234-56.2023.5.01.0000). No caso concreto,
a Empresa XYZ demonstrou..."

MODELO EXTRA√çDO (CORRETO):
"A pretensao autoral merece acolhimento. Segundo Mauricio Godinho Delgado,
a configuracao de grupo economico exige demonstracao de direcao, controle
ou administracao comum (TST-AIRR-1234-56.2023.5.01.0000). No caso concreto,
a reclamada demonstrou..."

‚úÖ Citacao de Godinho Delgado ‚Üí PRESERVADA
‚úÖ Precedente TST-AIRR ‚Üí PRESERVADO
üîÑ "Empresa XYZ" ‚Üí "a reclamada" (generalizado)

REGRA DE OURO:
Se o primeiro paragrafo fala sobre "o que o reclamante pede" ou "o que as partes alegam", ESTA ERRADO.
O primeiro paragrafo DEVE comecar com analise juridica do instituto/direito discutido.

EXEMPLO COMPARATIVO:

ERRADO (tem mini-relatorio):
"O reclamante pleiteia a condenacao solidaria das reclamadas, sob a alegacao de que integram o mesmo grupo economico. As reclamadas impugnaram o pedido."

CORRETO (sem mini-relatorio):
"A configuracao de grupo economico trabalhista demanda a presenca dos requisitos previstos no artigo 2 paragrafo 2 da CLT..."

ACAO REQUERIDA:
Se o texto original da decisao tiver mini-relatorio no inicio, voce DEVE REMOVE-LO completamente antes de generalizar.
Identifique onde termina o mini-relatorio e onde comeca a fundamentacao. Mantenha APENAS a fundamentacao.

Voce entendeu? INICIE DIRETAMENTE NA ANALISE JURIDICA. ZERO mini-relatorio.

${AI_PROMPTS.estiloRedacao}

CONTEXTO DO T√ìPICO ORIGINAL:
T√≠tulo: ${editingTopic.title}
Categoria: ${editingTopic.category || 'N√£o especificada'}

Crie UM √öNICO modelo baseado neste texto, extraindo:
1. **T√≠tulo**: Baseado no t√≥pico atual, mas ajustado se necess√°rio. IMPORTANTE: O titulo DEVE estar em LETRAS MAIUSCULAS. Exemplo: "GRUPO ECONOMICO - PROCEDENCIA"
2. **Categoria**: ${editingTopic.category || 'M√©rito'}
3. **Palavras-chave** (5 a 10 termos estrat√©gicos):

   INCLUA:
   - ‚úÖ Termos t√©cnicos jur√≠dicos principais
   - ‚úÖ Sin√¥nimos e varia√ß√µes do tema
   - ‚úÖ Palavras que um juiz digitaria na busca
   - ‚úÖ Conceitos-chave relacionados
   - ‚úÖ Artigos de lei relevantes (ex: "CLT art 59", "Lei 13467")

   EVITE:
   - ‚ùå Palavras muito gen√©ricas ("direito", "trabalho", "lei", "justi√ßa")
   - ‚ùå Verbos conjugados ("trabalhar", "receber", "pagar")
   - ‚ùå Artigos e preposi√ß√µes (o, a, de, da, para)
   - ‚ùå Nomes pr√≥prios ou espec√≠ficos

4. **Conte√∫do**: Vers√£o GEN√âRICA do texto fornecido em HTML, com reda√ß√£o fluida e coesa

FORMATO DE RESPOSTA - JSON v√°lido:
{
  "modelos": [
    {
      "titulo": "${editingTopic.title}",
      "categoria": "${editingTopic.category || 'M√©rito'}",
      "palavrasChave": "palavra1, palavra2, palavra3",
      "conteudo": "<p>Modelo completo em HTML GEN√âRICO, com reda√ß√£o fluida e coesa, sem mini-relat√≥rio...</p>"
    }
  ]
}

TEXTO DA DECIS√ÉO A GENERALIZAR:
${decisionText}`;

      // v1.21.26: Parametros para extracao/transformacao (moderado)
      const textResponse = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: analysisPrompt }]
      }], {
        maxTokens: 16000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.4,
        topP: 0.9,
        topK: 60
      });


      // Parse JSON
      const jsonMatch = textResponse.match(/\{[\s\S]*"modelos"[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error('Formato de resposta inv√°lido');
      }

      const parsed = JSON.parse(jsonMatch[0]);

      // üöÄ v1.8.2: Cachear resposta JSON parseada
      apiCache.set(cacheKey, jsonMatch[0]);

      if (!parsed.modelos || parsed.modelos.length === 0) {
        throw new Error('Nenhum modelo foi gerado');
      }

      // Preparar modelo para preview/edi√ß√£o
      const extractedModel = parsed.modelos[0];
      const modelId = generateModelId();
      // Converter HTML para texto plano preservando quebras de linha
      const rawContent = extractedModel.conteudo || '';
      const plainContent = rawContent
        .replace(/<\/p>\s*<p>/gi, '\n')    // </p><p> ‚Üí quebra simples
        .replace(/<br\s*\/?>/gi, '\n')     // <br> ‚Üí quebra simples
        .replace(/<\/?(p|div)[^>]*>/gi, '') // remove tags de bloco
        .replace(/<[^>]*>/g, '')           // remove outras tags
        .replace(/&nbsp;/g, ' ')           // &nbsp; ‚Üí espa√ßo
        .replace(/\n{2,}/g, '\n')          // m√°x 1 quebra seguida
        .trim();
      const previewModel = {
        id: modelId,
        title: extractedModel.titulo || editingTopic.title,
        category: extractedModel.categoria || editingTopic.category || 'M√©rito',
        content: plainContent,
        keywords: extractedModel.palavrasChave || '',
        isFavorite: false,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      // Mostrar modal de preview/edi√ß√£o ao inv√©s de salvar diretamente
      modelLibrary.setExtractedModelPreview(previewModel);
      openModal('extractedModelPreview');


    } catch (err) {
      setError(`Erro ao extrair modelo: ${err.message}`);
    } finally {
      modelLibrary.setExtractingModelFromDecision(false);
    }
  };

  // üîç v1.13.1: Executa salvamento de modelo extra√≠do (chamado ap√≥s verifica√ß√£o de similaridade)
  // v1.27.02: Gera embedding automaticamente se IA local estiver ativa
  const executeExtractedModelSave = async (modelData, isReplace = false, replaceId = null) => {
    // Gerar embedding se modelo de busca estiver pronto E op√ß√£o ativada
    if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady && !modelData.embedding) {
      await new Promise(resolve => setTimeout(resolve, 50));
      try {
        const stripHTML = (html) => {
          const div = document.createElement('div');
          div.innerHTML = html || '';
          return div.textContent || div.innerText || '';
        };
        const text = [modelData.title, modelData.keywords, stripHTML(modelData.content).slice(0, 2000)].filter(Boolean).join(' ');
        modelData.embedding = await AIModelService.getEmbedding(text, 'passage');
      } catch (err) {
        console.warn('[MODEL-EMBED] Erro ao gerar embedding:', err);
      }
    } else if (!aiIntegration.aiSettings.modelSemanticEnabled && modelData.embedding) {
      delete modelData.embedding;
    }

    if (isReplace && replaceId) {
      const updatedModel = { ...modelData, id: replaceId, updatedAt: new Date().toISOString() };
      const updated = modelLibrary.models.map(m => m.id === replaceId ? updatedModel : m);
      modelLibrary.setModels(updated);
      // v1.34.0: Rastrear update para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('update', updatedModel);
    } else {
      modelLibrary.setModels(prev => [...prev, modelData]);
      // v1.34.0: Rastrear create para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('create', modelData);
    }
    modelLibrary.setHasUnsavedChanges(true);
    TFIDFSimilarity.invalidate();
    apiCache.invalidate('suggestions_');
    showToast(`‚úÖ Modelo "${modelData.title}" ${isReplace ? 'substitu√≠do' : 'salvo'} com sucesso!`, 'success');
    closeModal('extractedModelPreview');
    modelLibrary.setExtractedModelPreview(null);
  };

  // Salva o modelo extra√≠do ap√≥s revis√£o/edi√ß√£o pelo usu√°rio
  const saveExtractedModel = () => {
    if (!modelLibrary.extractedModelPreview) {
      showToast('Nenhum modelo para salvar.', 'error');
      return;
    }

    // üîç v1.13.1: Verificar similaridade com TF-IDF
    const simResult = TFIDFSimilarity.findSimilar(modelLibrary.extractedModelPreview, modelLibrary.models, 0.80);
    if (simResult.hasSimilar) {
      modelLibrary.setSimilarityWarning({
        newModel: modelLibrary.extractedModelPreview,
        similarModel: simResult.similarModel,
        similarity: simResult.similarity,
        context: 'saveExtractedModel'
      });
      return;
    }

    executeExtractedModelSave(modelLibrary.extractedModelPreview);
  };

  // Cancela a cria√ß√£o do modelo extra√≠do
  const cancelExtractedModel = () => {
    closeModal('extractedModelPreview');
    modelLibrary.setExtractedModelPreview(null);
    showToast('Cria√ß√£o de modelo cancelada.', 'info');
  };

  // Calcula arquivos pendentes no processamento em lote
  const getBulkPendingFilesCount = React.useCallback(() => {
    return modelLibrary.bulkFiles.length - modelLibrary.bulkProcessedFiles.length;
  }, [modelLibrary.bulkFiles.length, modelLibrary.bulkProcessedFiles.length]);

  // Handler para confirmar cancelamento em lote
  const handleConfirmBulkCancel = React.useCallback(() => {
    closeModal('confirmBulkCancel');

    if (modelLibrary.bulkCancelController) {
      modelLibrary.bulkCancelController.abort();

      // Fechar modal de processamento ap√≥s cancelar
      setTimeout(() => {
        closeModal('bulkModal');
        // Reset estados relacionados
        modelLibrary.setBulkProcessing(false);
        modelLibrary.setBulkCurrentBatch(0);
        // Limpar controller abortado para permitir novo processamento
        modelLibrary.setBulkCancelController(null);
      }, 100); // Pequeno delay para garantir que abort() seja processado
    }
  }, [closeModal, modelLibrary.bulkCancelController, modelLibrary.setBulkProcessing, modelLibrary.setBulkCurrentBatch, modelLibrary.setBulkCancelController]);

  // üîç v1.14.1: Fun√ß√£o √∫nica para processar fila de salvamento bulk
  // v1.20.2: Otimizado para evitar memory leak - usa muta√ß√£o direta nos arrays
  // v1.27.02: Gera embeddings automaticamente se IA local estiver ativa
  const processBulkSaveNext = async (queue, saved, skipped, replacements) => {
    if (queue.length === 0) {
      if (saved.length > 0 || replacements.length > 0) {
        // v1.27.02: Gerar embeddings para todos os modelos novos se IA local ativa E op√ß√£o ativada
        if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady) {
          const stripHTML = (html) => {
            const div = document.createElement('div');
            div.innerHTML = html || '';
            return div.textContent || div.innerText || '';
          };
          for (const model of saved) {
            if (!model.embedding) {
              try {
                const text = [model.title, model.keywords, stripHTML(model.content).slice(0, 2000)].filter(Boolean).join(' ');
                model.embedding = await AIModelService.getEmbedding(text, 'passage');
              } catch (err) { /* ignore */ }
            }
          }
          for (const { newModel } of replacements) {
            if (!newModel.embedding) {
              try {
                const text = [newModel.title, newModel.keywords, stripHTML(newModel.content).slice(0, 2000)].filter(Boolean).join(' ');
                newModel.embedding = await AIModelService.getEmbedding(text, 'passage');
              } catch (err) { /* ignore */ }
            }
          }
        }

        let updatedModels = [...modelLibrary.models];
        const batchChanges = [];
        for (const { oldId, newModel } of replacements) {
          const replacedModel = { ...newModel, id: oldId, updatedAt: new Date().toISOString() };
          updatedModels = updatedModels.map(m => m.id === oldId ? replacedModel : m);
          // v1.35.23: Acumular para batch
          batchChanges.push({ operation: 'update', model: replacedModel });
        }
        modelLibrary.setModels([...updatedModels, ...saved]);
        // v1.35.23: Usar trackChangeBatch para bulk upload eficiente
        saved.forEach(model => batchChanges.push({ operation: 'create', model }));
        if (cloudSync?.trackChangeBatch && batchChanges.length > 0) {
          cloudSync.trackChangeBatch(batchChanges);
        }
        modelLibrary.setHasUnsavedChanges(true);
        TFIDFSimilarity.invalidate();
        apiCache.invalidate('suggestions_');
      }
      closeModal('bulkReview');
      closeModal('bulkModal');
      modelLibrary.resetBulkState();
      const total = saved.length + replacements.length;
      const msg = skipped > 0 ? `‚úÖ ${total} modelo(s) adicionado(s). ${skipped} ignorado(s).` : `‚úÖ ${total} modelo(s) adicionado(s) com sucesso!`;
      showToast(msg, 'success');
      return;
    }
    const [current, ...rest] = queue;
    const simResult = TFIDFSimilarity.findSimilar(current, [...modelLibrary.models, ...saved], 0.80);
    if (simResult.hasSimilar) {
      modelLibrary.setSimilarityWarning({ context: 'saveBulkModel', newModel: current, similarModel: simResult.similarModel, similarity: simResult.similarity, bulkQueue: rest, bulkSaved: saved, bulkSkipped: skipped, bulkReplacements: replacements });
    } else {
      // v1.20.2: Muta√ß√£o direta para evitar c√≥pias desnecess√°rias em recurs√£o
      saved.push(current);
      await processBulkSaveNext(rest, saved, skipped, replacements);
    }
  };

  // üîç v1.13.1: Handlers para SimilarityWarningModal
  const handleSimilarityCancel = () => {
    const w = modelLibrary.similarityWarning;
    if (w?.context === 'saveBulkModel') {
      modelLibrary.setSimilarityWarning(null);
      setTimeout(() => processBulkSaveNext(w.bulkQueue, w.bulkSaved, w.bulkSkipped + 1, w.bulkReplacements), 0);
    } else {
      modelLibrary.setSimilarityWarning(null);
    }
  };
  // v1.33.3: Feedback visual "Salvando..." no modal de similaridade
  const handleSimilaritySaveNew = async () => {
    const w = modelLibrary.similarityWarning;
    if (!w) return;

    setSavingFromSimilarity(true);
    await new Promise(resolve => setTimeout(resolve, 50)); // yield para UI

    if (w.context === 'saveModel') await executeSaveModel(w.newModel);
    else if (w.context === 'saveExtractedModel') await executeExtractedModelSave(w.newModel);
    else if (w.context === 'saveAsNew') await executeSaveAsNew(w.newModel);
    else if (w.context === 'saveBulkModel') {
      setSavingFromSimilarity(false);
      modelLibrary.setSimilarityWarning(null);
      // v1.20.2: Muta√ß√£o direta para evitar c√≥pias
      w.bulkSaved.push(w.newModel);
      setTimeout(() => processBulkSaveNext(w.bulkQueue, w.bulkSaved, w.bulkSkipped, w.bulkReplacements), 0);
      return;
    }
    setSavingFromSimilarity(false);
    modelLibrary.setSimilarityWarning(null);
  };
  const handleSimilarityReplace = async () => {
    const w = modelLibrary.similarityWarning;
    if (!w) return;

    setSavingFromSimilarity(true);
    await new Promise(resolve => setTimeout(resolve, 50)); // yield para UI

    if (w.context === 'saveModel') await executeSaveModel(w.newModel, true, w.similarModel.id);
    else if (w.context === 'saveExtractedModel') await executeExtractedModelSave(w.newModel, true, w.similarModel.id);
    else if (w.context === 'saveAsNew') await executeSaveAsNew(w.newModel, true, w.similarModel.id);
    else if (w.context === 'saveBulkModel') {
      setSavingFromSimilarity(false);
      modelLibrary.setSimilarityWarning(null);
      // v1.20.2: Muta√ß√£o direta para evitar c√≥pias
      w.bulkReplacements.push({ oldId: w.similarModel.id, newModel: w.newModel });
      setTimeout(() => processBulkSaveNext(w.bulkQueue, w.bulkSaved, w.bulkSkipped, w.bulkReplacements), 0);
      return;
    }
    setSavingFromSimilarity(false);
    modelLibrary.setSimilarityWarning(null);
  };

  // üöÄ v1.8.2: Gera m√∫ltiplos modelos a partir do conte√∫do de um arquivo usando IA (COM CACHE)
  const generateModelsFromFileContent = async (textContent, fileName, abortSignal = null) => {
    try {
      // Verificar cancelamento antes de come√ßar
      if (abortSignal?.aborted) {
        throw new Error('Processamento cancelado pelo usu√°rio');
      }

      // Validar texto
      if (!textContent || typeof textContent !== 'string' || textContent.trim().length < 50) {
        throw new Error('Texto muito curto ou inv√°lido para an√°lise');
      }

      // üöÄ v1.8.2: Cache key baseado em fileName + textContent
      const cacheKey = `bulkModels_${fileName}_${textContent}`;

      // üöÄ v1.8.2: Verificar cache antes de chamar API
      const cachedModels = apiCache.get(cacheKey);
      if (cachedModels) {
        return JSON.parse(cachedModels); // Retornar array de modelos cacheados
      }


      const textToAnalyze = textContent.trim();

      // Agora analisa o texto e gera modelos
      const analysisPrompt = `Voc√™ √© um assistente jur√≠dico especializado em criar modelos de decis√£o trabalhista GEN√âRICOS e REUTILIZ√ÅVEIS.

TAREFA: Analise o documento jur√≠dico fornecido e identifique TODOS os t√≥picos/assuntos jur√≠dicos distintos que podem se tornar modelos de decis√£o completos.

‚ö†Ô∏è ATEN√á√ÉO - REGRAS DE GENERALIZA√á√ÉO (MUITO IMPORTANTE):

1. **REMOVA informa√ß√µes espec√≠ficas do caso concreto:**
   - ‚ùå N√ÉO use nomes de partes (ex: "Jo√£o da Silva", "Empresa XYZ Ltda")
   - ‚ùå N√ÉO use valores monet√°rios espec√≠ficos (ex: "R$ 5.000,00")
   - ‚ùå N√ÉO use datas espec√≠ficas (ex: "10/05/2023")
   - ‚ùå N√ÉO use n√∫meros de processo
   - ‚ùå N√ÉO use endere√ßos ou locais espec√≠ficos

2. **USE termos gen√©ricos:**
   - ‚úÖ "o reclamante", "a reclamada", "a empresa"
   - ‚úÖ "o valor devido", "o montante apurado"
   - ‚úÖ "o per√≠odo trabalhado", "a data da rescis√£o"
   - ‚úÖ "os documentos apresentados", "as provas dos autos"

3. **FOQUE na fundamenta√ß√£o jur√≠dica:**
   - Argumenta√ß√£o legal aplic√°vel a casos similares
   - An√°lise de requisitos jur√≠dicos gen√©ricos
   - Racioc√≠nio jur√≠dico reproduz√≠vel
   - Conclus√µes adapt√°veis a diferentes situa√ß√µes

4. **TRANSFORME em TEMPLATE:**
   - O modelo deve servir para QUALQUER caso do mesmo tipo
   - Um juiz deve poder copiar e adaptar facilmente
   - Evite refer√™ncias muito espec√≠ficas ao caso original

üö® PRESERVA√á√ÉO LITERAL DO TEXTO (CR√çTICO - EXTREMAMENTE IMPORTANTE):

Esta √© a regra MAIS IMPORTANTE de todas. Se voc√™ n√£o seguir isso, o modelo ser√° IN√öTIL.

**O QUE VOC√ä DEVE FAZER:**
- Fazer APENAS substitui√ß√µes literais de informa√ß√µes espec√≠ficas por termos gen√©ricos
- Funcionar como "CTRL+F ‚Üí SUBSTITUIR": encontrar nomes/valores/datas e trocar por gen√©ricos
- PRESERVAR TODO O RESTO DO TEXTO EXATAMENTE COMO EST√Å
- Manter a reda√ß√£o, estrutura de frases, argumenta√ß√£o, conectivos, tudo ID√äNTICO

**O QUE VOC√ä N√ÉO DEVE FAZER:**
- ‚ùå N√ÉO resuma o texto
- ‚ùå N√ÉO reescreva com suas pr√≥prias palavras
- ‚ùå N√ÉO simplifique a argumenta√ß√£o
- ‚ùå N√ÉO altere a estrutura das frases
- ‚ùå N√ÉO mude conectivos ou express√µes jur√≠dicas
- ‚ùå N√ÉO "melhore" ou "otimize" o texto original

**EXEMPLO DO QUE FAZER:**

‚ùå ERRADO (resumindo/reescrevendo):
Texto original: "A pretens√£o autoral merece acolhimento. Com efeito, restou comprovado nos autos que o reclamante Jo√£o da Silva laborou para a empresa Acme Ltda no per√≠odo de 01/01/2020 a 31/12/2023, recebendo sal√°rio mensal de R$ 3.500,00. A jornada habitual era das 8h √†s 18h, com uma hora de intervalo, conforme cart√µes de ponto de fls. 45/89."

Modelo ERRADO: "A pretens√£o √© procedente. Ficou demonstrado que houve rela√ß√£o de trabalho com jornada superior √† legal."

‚úÖ CORRETO (apenas substituindo dados espec√≠ficos):
Modelo CORRETO: "A pretens√£o autoral merece acolhimento. Com efeito, restou comprovado nos autos que o reclamante laborou para a reclamada no per√≠odo trabalhado, recebendo o sal√°rio mensal contratado. A jornada habitual era das [hor√°rio de in√≠cio] √†s [hor√°rio de t√©rmino], com uma hora de intervalo, conforme cart√µes de ponto dos autos."

**REGRA DE OURO:**
Se voc√™ n√£o tem certeza se deve alterar algo, N√ÉO ALTERE. Preserve o texto original.
Seu trabalho √© fazer "buscar e substituir" de dados espec√≠ficos, N√ÉO reescrever.

**CHECKLIST FINAL - VERIFIQUE ANTES DE RESPONDER:**
‚úì Mantive a estrutura exata das frases do original?
‚úì Mantive os mesmos conectivos (ademais, com efeito, nesse sentido, etc.)?
‚úì Mantive a mesma argumenta√ß√£o jur√≠dica?
‚úì Mantive a mesma ordem dos argumentos?
‚úì Fiz APENAS substitui√ß√µes de nomes, valores, datas por termos gen√©ricos?
‚úì O texto tem o mesmo tamanho/extens√£o do original (n√£o resumi)?

EXCLUSAO OBRIGATORIA DE MINI-RELATORIO (CRITICO):

Esta e uma das regras MAIS IMPORTANTES. Se voce incluir mini-relatorio, o modelo sera INUTIL.

PROIBIDO ABSOLUTAMENTE (exemplos do que NAO fazer):
- "O reclamante pleiteia..."
- "O reclamante postula..."
- "O reclamante alega..."
- "As reclamadas impugnaram..."
- "A reclamada sustenta..."
- "Trata-se de..."
- "Cuida-se de..."
- "O reclamante ajuizou..."
- Qualquer resumo das alegacoes das partes
- Qualquer descricao do que foi pedido ou contestado

CORRETO - Como DEVE comecar o modelo:
- "A configuracao de grupo economico..."
- "O reconhecimento do vinculo empregaticio..."
- "A concessao de horas extras..."
- "Para caracterizacao da jornada..."
- "A caracterizacao do dano moral..."
- Diretamente com ANALISE JURIDICA, FUNDAMENTOS LEGAIS, DOUTRINA, PRECEDENTES

‚ö†Ô∏è IMPORTANTE - PRESERVA√á√ÉO DE CITA√á√ïES DOUTRIN√ÅRIAS E JURISPRUDENCIAIS:

Esta regra e CRITICA para manter a qualidade e fundamentacao do modelo extraido.

O QUE PRESERVAR (MANTER INTEGRALMENTE):
‚úÖ Citacoes de autores (ex: "Segundo Mauricio Godinho Delgado...")
‚úÖ Citacoes de jurisprudencia (ex: "Conforme TST-AIRR-1234-56.2023...")
‚úÖ Sumulas (ex: "A Sumula 437 do TST estabelece...")
‚úÖ Orientacoes Jurisprudenciais (ex: "A OJ 415 da SDI-1 dispoe...")
‚úÖ Precedentes vinculantes (ex: "Nos termos do Tema 1046 do TST...")
‚úÖ Referencias doutrinarias completas (autor, obra, citacao)
‚úÖ Referencias jurisprudenciais completas (tribunal, numero, ementa)
‚úÖ Fundamentos teoricos e academicos

O QUE GENERALIZAR (SUBSTITUIR POR TERMOS GENERICOS):
üîÑ Nomes de partes especificas ‚Üí "o reclamante", "a reclamada"
üîÑ Valores monetarios especificos ‚Üí "[valor]", "quantia devida"
üîÑ Datas especificas ‚Üí "periodo trabalhado", "data da rescisao"
üîÑ Locais especificos ‚Üí "local de trabalho", "estabelecimento"
üîÑ Documentos especificos do caso ‚Üí "prova documental", "laudo pericial"
üîÑ Testemunhas especificas ‚Üí "prova testemunhal"

O QUE NUNCA FAZER:
‚ùå N√ÉO remova citacoes de autores renomados
‚ùå N√ÉO remova referencias a precedentes e jurisprudencia
‚ùå N√ÉO remova fundamentacao teorica/doutrinaria
‚ùå N√ÉO substitua nomes de doutrinadores por termos genericos
‚ùå N√ÉO remova numeros de processos citados como precedentes

EXEMPLO CORRETO DE PRESERVA√á√ÉO:

ORIGINAL:
"A pretensao autoral merece acolhimento. Segundo Mauricio Godinho Delgado,
a configuracao de grupo economico exige demonstracao de direcao, controle
ou administracao comum (TST-AIRR-1234-56.2023.5.01.0000). No caso concreto,
a Empresa XYZ demonstrou..."

MODELO EXTRA√çDO (CORRETO):
"A pretensao autoral merece acolhimento. Segundo Mauricio Godinho Delgado,
a configuracao de grupo economico exige demonstracao de direcao, controle
ou administracao comum (TST-AIRR-1234-56.2023.5.01.0000). No caso concreto,
a reclamada demonstrou..."

‚úÖ Citacao de Godinho Delgado ‚Üí PRESERVADA
‚úÖ Precedente TST-AIRR ‚Üí PRESERVADO
üîÑ "Empresa XYZ" ‚Üí "a reclamada" (generalizado)

REGRA DE OURO:
Se o primeiro paragrafo fala sobre "o que o reclamante pede" ou "o que as partes alegam", ESTA ERRADO.
O primeiro paragrafo DEVE comecar com analise juridica do instituto/direito discutido.

EXEMPLO COMPARATIVO:

ERRADO (tem mini-relatorio):
"O reclamante pleiteia a condenacao solidaria das reclamadas, sob a alegacao de que integram o mesmo grupo economico. As reclamadas impugnaram o pedido."

CORRETO (sem mini-relatorio):
"A configuracao de grupo economico trabalhista demanda a presenca dos requisitos previstos no artigo 2 paragrafo 2 da CLT..."

ACAO REQUERIDA:
Se o texto original da decisao tiver mini-relatorio no inicio, voce DEVE REMOVE-LO completamente antes de generalizar.
Identifique onde termina o mini-relatorio e onde comeca a fundamentacao. Mantenha APENAS a fundamentacao.

Voce entendeu? INICIE DIRETAMENTE NA ANALISE JURIDICA. ZERO mini-relatorio.

${AI_PROMPTS.estiloRedacao}

A reda√ß√£o do modelo deve ser de EXCELENTE QUALIDADE, seguindo rigorosamente estes crit√©rios.

IMPORTANTE:
- Um documento pode conter 1, 2, 3 ou mais t√≥picos diferentes
- Cada t√≥pico deve ser tratado independentemente
- Crie modelos ROBUSTOS, COMPLETOS e PRONTOS PARA REUTILIZA√á√ÉO
- Os modelos devem seguir o estilo de um juiz do trabalho experiente e did√°tico
- Use linguagem formal, mas acess√≠vel e agrad√°vel de ler
- Fundamente em bases legais, doutrina e jurisprud√™ncia
- GENERALIZE apenas dados do caso concreto (nomes, valores, datas)
- PRESERVE cita√ß√µes doutrin√°rias, precedentes e jurisprud√™ncia integralmente

Para CADA t√≥pico identificado, crie:
1. **T√≠tulo**: Claro e objetivo. IMPORTANTE: O titulo DEVE estar em LETRAS MAIUSCULAS. Exemplos: "HORAS EXTRAS - PROCEDENCIA", "GRUPO ECONOMICO - IMPROCEDENCIA"
2. **Categoria**: Classifica√ß√£o jur√≠dica precisa (ex: "Verbas Rescis√≥rias", "Jornada de Trabalho", "Preliminares", "Estabilidade")

3. **Palavras-chave** (5 a 10 termos estrat√©gicos):

   INCLUA:
   - ‚úÖ Termos t√©cnicos jur√≠dicos principais
   - ‚úÖ Sin√¥nimos e varia√ß√µes do tema
   - ‚úÖ Palavras que um juiz digitaria na busca
   - ‚úÖ Conceitos-chave relacionados
   - ‚úÖ Artigos de lei relevantes (ex: "CLT art 59", "Lei 13467")

   EVITE:
   - ‚ùå Palavras muito gen√©ricas ("direito", "trabalho", "lei", "justi√ßa")
   - ‚ùå Verbos conjugados ("trabalhar", "receber", "pagar")
   - ‚ùå Artigos e preposi√ß√µes (o, a, de, da, para)
   - ‚ùå Nomes pr√≥prios ou espec√≠ficos

   EXEMPLOS:
   ‚ùå Ruins: "direito, trabalho, empregado, sal√°rio, lei"
   ‚úÖ Bons: "horas extras, sobrejornada, adicional hora extra, banco de horas, controle jornada, CLT art 59, 7¬∫ inciso XVI, prova hor√°rio"

4. **Conte√∫do**: Modelo de decis√£o GEN√âRICO em formato HTML com REDA√á√ÉO FLUIDA, COESA E CONT√çNUA:
   - INICIE DIRETAMENTE na an√°lise jur√≠dica (SEM mini-relat√≥rio)
   - An√°lise fundamentada em prosa corrida (SEM enumera√ß√µes ou t√≠tulos)
   - Use conectores textuais entre par√°grafos
   - Base legal pertinente integrada ao texto
   - Conclus√£o clara e adapt√°vel
   - Formata√ß√£o com <p>, <strong>, <em>, etc.
   - Texto agrad√°vel, did√°tico e bem articulado

EXEMPLO DE GENERALIZA√á√ÉO:

‚ùå ERRADO (espec√≠fico demais):
"Jo√£o da Silva trabalhou para a Empresa ABC Ltda de 01/01/2020 a 31/12/2022, fazendo jus a R$ 15.000,00 de horas extras conforme planilha de fls. 45."

‚úÖ CORRETO (gen√©rico e reutiliz√°vel):
"O reclamante comprovou o labor em sobrejornada durante o per√≠odo contratual, fazendo jus ao pagamento das horas extras apuradas em liquida√ß√£o de senten√ßa, conforme documenta√ß√£o apresentada nos autos."

FORMATO DE RESPOSTA - JSON valido:

IMPORTANTE: Retorne APENAS JSON puro. Nada de texto antes ou depois.

Sua resposta deve comecar com { e terminar com }

Use aspas duplas para strings.
Escape caracteres especiais corretamente.
Sem virgulas sobrando no ultimo elemento.

{
  "modelos": [
    {
      "titulo": "TITULO EM MAIUSCULAS - RESULTADO",
      "categoria": "Categoria Juridica",
      "palavrasChave": "palavra1, palavra2, palavra3",
      "conteudo": "<p>Modelo em HTML.</p><p>Tudo em uma string.</p>"
    }
  ]
}

LEMBRE-SE: O titulo DEVE estar em MAIUSCULAS!

DOCUMENTO A ANALISAR:
${textToAnalyze}`;


      // v1.21.26: Parametros para extracao bulk (moderado)
      const aiResponseText = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: analysisPrompt }]
      }], {
        maxTokens: 8000,
        useInstructions: true,
        timeout: 180000,  // 3 minutos (an√°lise pode ser mais demorada)
        abortSignal: abortSignal,  // Signal externo para cancelamento do usu√°rio
        logMetrics: true,
        temperature: 0.3,
        topP: 0.9,
        topK: 50
      });

      // Parse do JSON retornado
      const cleanText = aiResponseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      const parsed = JSON.parse(cleanText);

      if (!parsed.modelos || !Array.isArray(parsed.modelos) || parsed.modelos.length === 0) {
        throw new Error('Nenhum modelo identificado no documento');
      }

      // Formata os modelos
      const modelos = parsed.modelos.map((m, idx) => ({
        id: `bulk-${Date.now()}-${idx}`,
        title: m.titulo || `Modelo ${idx + 1}`,
        category: m.categoria || 'Sem categoria',
        keywords: m.palavrasChave || '',
        content: m.conteudo || '<p>Conte√∫do n√£o gerado</p>',
        sourceFile: fileName,
        createdAt: new Date().toISOString(),
        isFavorite: false
      }));

      // üöÄ v1.8.2: Cachear modelos gerados
      apiCache.set(cacheKey, JSON.stringify(modelos));

      return modelos;

    } catch (err) {
      throw err;
    }
  };

  const callWithRetry = async (fn, maxRetries = 3, fileName = '', abortSignal = null, timeoutMs = 180000) => {
    const TIMEOUT_MS = timeoutMs; // Default: 3 min, pode ser aumentado para "Todos"

    for (let attempt = 0; attempt < maxRetries; attempt++) {
      // Verificar se foi cancelado ANTES de tentar
      if (abortSignal?.aborted) {
        throw new Error('Processamento cancelado pelo usu√°rio');
      }

      try {
        // Adicionar timeout para evitar requisi√ß√µes que travam
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error(`Timeout: API n√£o respondeu em ${Math.round(TIMEOUT_MS/1000)}s`)), TIMEOUT_MS)
        );
        return await Promise.race([fn(), timeoutPromise]);
      } catch (err) {
        const isRetryable = err.message?.includes('Timeout') || err.status === 429 || err.status === 529 || err.status === 520 || err.status === 502 || err.message?.includes('rate limit') || err.message?.includes('429') || err.message?.includes('529') || err.message?.includes('520') || err.message?.includes('502') || err.message?.includes('Overloaded') || err.message?.includes('Failed to fetch') || err.message?.includes('parsear resposta');
        const isLastAttempt = attempt === maxRetries - 1;
        const attemptNum = attempt + 1;

        // Log de erro para debug
        console.warn(`[callWithRetry] ‚ùå Erro na tentativa ${attemptNum}/${maxRetries}${fileName ? ` (${fileName})` : ''}:`, err.message || err);

        if (isRetryable) {
          if (!isLastAttempt) {
            // Delay maior para 429: 4s, 8s, 16s (mais agressivo que erros normais)
            const delay = Math.pow(2, attempt + 2) * 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            // Verificar se foi cancelado DEPOIS do delay
            if (abortSignal?.aborted) {
              throw new Error('Processamento cancelado pelo usu√°rio');
            }
            continue;
          } else {
            console.error(`[callWithRetry] üíÄ FALHA FINAL: Todas as ${maxRetries} tentativas esgotadas${fileName ? ` (${fileName})` : ''}`);
            // Mensagem espec√≠fica para rate limit esgotado
            throw new Error(`Rate limit excedido ap√≥s ${maxRetries} tentativas. O sistema de lotes est√° ativo, mas a API ainda atingiu o limite. Aguarde alguns minutos antes de tentar novamente.`);
          }
        }

        // N√£o √© rate limit - propagar erro original
        console.error(`[callWithRetry] ‚ö†Ô∏è Erro n√£o-retryable${fileName ? ` (${fileName})` : ''}:`, err.message || err);
        throw err;
      }
    }
  };

  const processFileWithProgress = async (file, index, abortSignal) => {
    const startTime = Date.now();

    try {
      // Verificar cancelamento antes de iniciar
      if (abortSignal?.aborted) {
        throw new Error('Processamento cancelado pelo usu√°rio');
      }

      // PASSO 1: Extrair texto (local, r√°pido)
      const textContent = await documentServices.extractTextFromBulkFile(file);

      // Verificar cancelamento ap√≥s extra√ß√£o
      if (abortSignal?.aborted) {
        throw new Error('Processamento cancelado pelo usu√°rio');
      }

      // PASSO 2: Gerar modelos com IA (API call com retry)
      const models = await callWithRetry(
        () => generateModelsFromFileContent(textContent, file.name, abortSignal),
        3, // maxRetries
        file.name,
        abortSignal // Passar signal para retry logic
      );

      const duration = ((Date.now() - startTime) / 1000).toFixed(1);

      return {
        file: file.name,
        status: 'success',
        modelsCount: models.length,
        models,
        duration
      };

    } catch (err) {
      const duration = ((Date.now() - startTime) / 1000).toFixed(1);

      return {
        file: file.name,
        status: 'error',
        error: err.message,
        duration
      };
    }
  };

  // v1.33.11: Usar valor configur√°vel de requisi√ß√µes paralelas
  const BULK_BATCH_SIZE = aiIntegration.aiSettings.parallelRequests || 5;
  const INTER_BATCH_DELAY = 3000; // 3s entre batches

  const processBulkFiles = async () => {
    if (modelLibrary.bulkFiles.length === 0) return;

    try {
      modelLibrary.setBulkProcessing(true);
      modelLibrary.setBulkProcessedFiles([]);
      modelLibrary.setBulkGeneratedModels([]);
      modelLibrary.setBulkErrors([]);

      if (modelLibrary.bulkCancelController) {
        modelLibrary.setBulkCancelController(null);
      }

      // Criar AbortController NOVO para este processamento
      const cancelController = new AbortController();
      modelLibrary.setBulkCancelController(cancelController);

      // Processar em batches para evitar rate limit 429
      const allResults = [];
      const processedFiles = [];
      const generatedModels = [];
      const errors = [];

      for (let i = 0; i < modelLibrary.bulkFiles.length; i += BULK_BATCH_SIZE) {
        const batch = modelLibrary.bulkFiles.slice(i, i + BULK_BATCH_SIZE);
        const batchNumber = Math.floor(i / BULK_BATCH_SIZE) + 1;
        const totalBatches = Math.ceil(modelLibrary.bulkFiles.length / BULK_BATCH_SIZE);

        modelLibrary.setBulkCurrentBatch(batchNumber);

        // Criar promises para este batch
        const promises = batch.map((file, batchIndex) => {
          const globalIndex = i + batchIndex;
          const startDelay = batchIndex * modelLibrary.bulkStaggerDelay;

          return new Promise(resolve => setTimeout(resolve, startDelay))
            .then(() => processFileWithProgress(file, globalIndex, cancelController.signal));
        });

        // Aguardar batch atual
        const batchResults = await Promise.allSettled(promises);
        allResults.push(...batchResults);

        // Processar resultados deste batch em tempo real
        batchResults.forEach(result => {
          if (result.status === 'fulfilled' && result.value.status === 'success') {
            processedFiles.push(result.value);
            generatedModels.push(...result.value.models);
          } else {
            const errorData = result.status === 'rejected' ? result.reason : result.value;
            processedFiles.push(errorData);
            errors.push(errorData);
          }
        });

        // Atualizar UI em tempo real ap√≥s cada batch
        modelLibrary.setBulkProcessedFiles([...processedFiles]);
        modelLibrary.setBulkGeneratedModels([...generatedModels]);
        modelLibrary.setBulkErrors([...errors]);

        // Delay entre batches (exceto no √∫ltimo)
        if (i + BULK_BATCH_SIZE < modelLibrary.bulkFiles.length) {
          await new Promise(resolve => setTimeout(resolve, INTER_BATCH_DELAY));

          // Verificar se foi cancelado durante o delay
          if (cancelController.signal.aborted) {
            break; // Interrompe o loop de batches
          }
        }
      }

      // Atualizar estados finais
      modelLibrary.setBulkProcessedFiles(processedFiles);
      modelLibrary.setBulkGeneratedModels(generatedModels);
      modelLibrary.setBulkErrors(errors);

      // üîç v1.14.1: Pr√©-calcular similaridade para cada modelo gerado
      const modelsWithSimilarity = generatedModels.map(model => {
        const simResult = TFIDFSimilarity.findSimilar(model, modelLibrary.models, 0.80);
        if (simResult.hasSimilar) {
          return { ...model, similarityInfo: { similarity: simResult.similarity, similarModel: simResult.similarModel } };
        }
        return model;
      });
      modelLibrary.setBulkReviewModels(modelsWithSimilarity);

      // Limpar controller e resetar batch
      modelLibrary.setBulkCancelController(null);
      modelLibrary.setBulkCurrentBatch(0);

      // Abrir modal de revis√£o
      openModal('bulkReview');

    } catch (err) {
      setError(err.message);
    } finally {
      modelLibrary.setBulkProcessing(false);
    }
  };

  // üöÄ v1.8.3: Handler para upload de arquivos (MEMOIZADO)
  const handleBulkFileUpload = React.useCallback((event) => {
    const files = Array.from(event.target.files || []);

    if (files.length === 0) return;

    if (files.length > 20) {
      showToast('‚ö†Ô∏è Limite m√°ximo de 20 arquivos por lote. Por favor, selecione menos arquivos.', 'error');
      return;
    }

    // Validar tipos de arquivo - PDF, TXT, DOCX, DOC
    const validExtensions = ['.pdf', '.txt', '.docx', '.doc'];
    const validTypes = [
      'application/pdf',
      'text/plain',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/msword'
    ];

    const invalidFiles = files.filter(f => {
      const ext = '.' + f.name.split('.').pop().toLowerCase();
      return !validExtensions.includes(ext) && !validTypes.includes(f.type);
    });

    if (invalidFiles.length > 0) {
      showToast(`‚ö†Ô∏è Arquivos inv√°lidos detectados:\n${invalidFiles.map(f => f.name).join('\n')}\n\n‚úÖ Tipos suportados: PDF, DOCX, DOC, TXT`, 'error');
      return;
    }

    modelLibrary.setBulkFiles(files);
  }, [showToast, modelLibrary.setBulkFiles]); // üöÄ v1.8.3: Memoizado (GRUPO C)

  // üîç v1.14.1: Salva modelos revisados com verifica√ß√£o de similaridade interativa
  const saveBulkModels = () => {
    if (modelLibrary.bulkReviewModels.length === 0) {
      showToast('Nenhum modelo para salvar.', 'error');
      return;
    }
    processBulkSaveNext([...modelLibrary.bulkReviewModels], [], 0, []);
  };

  // Remove modelo da revis√£o
  const removeBulkReviewModel = (modelId) => {
    const updated = modelLibrary.bulkReviewModels.filter(m => m.id !== modelId);
    modelLibrary.setBulkReviewModels(updated);
  };

  const toggleFavorite = async (modelId) => {
    try {
      let updatedModel = null;
      const updated = modelLibrary.models.map(m => {
        if (m.id === modelId) {
          updatedModel = { ...m, favorite: !m.favorite, updatedAt: new Date().toISOString() };
          return updatedModel;
        }
        return m;
      });
      modelLibrary.setModels(updated);
      // v1.34.0: Rastrear update para sync
      if (cloudSync?.trackChange && updatedModel) cloudSync.trackChange('update', updatedModel);
      modelLibrary.setHasUnsavedChanges(true);
      // Atualizar sugest√µes se modelo estiver nelas
      if (updatedModel && modelLibrary.suggestions?.length > 0) {
        modelLibrary.setSuggestions(modelLibrary.suggestions.map(m => m.id === modelId ? updatedModel : m));
      }
      // Atualizar preview se modelo estiver aberto
      if (updatedModel && modelPreview.previewingModel?.id === modelId) {
        modelPreview.openPreview(updatedModel);
      }
    } catch (err) {
      setError('Erro ao favoritar modelo: ' + err.message);
    }
  };



  // üìÑ FUN√á√ïES: An√°lise de Documentos

  // v1.17.0: Wrapper que mostra modal de nomes antes de analisar
  const handleAnalyzeDocuments = () => {
    if (peticaoFiles.length === 0 && pastedPeticaoTexts.length === 0) {
      setError('Por favor, fa√ßa upload da peti√ß√£o inicial ou cole o texto');
      return;
    }

    const anonConfig = aiIntegration.aiSettings?.anonymization;
    if (anonConfig?.enabled) {
      // Mostrar modal para inserir nomes
      setShowAnonymizationModal(true);
    } else {
      // Analisar diretamente sem anonimiza√ß√£o de nomes
      analyzeDocuments([]);
    }
  };

  // Callback quando usu√°rio confirma nomes no modal
  // v1.21.3: Persistir nomes para reutiliza√ß√£o em provas e pr√≥ximas an√°lises
  const handleAnonymizationConfirm = (nomes) => {
    aiIntegration.setAiSettings(prev => ({
      ...prev,
      anonymization: {
        ...prev.anonymization,
        nomesUsuario: nomes
      }
    }));
    setShowAnonymizationModal(false);
    analyzeDocuments(nomes);
  };

  const analyzeDocuments = async (nomesParaAnonimizar = []) => {

    if (peticaoFiles.length === 0 && pastedPeticaoTexts.length === 0) {
      setError('Por favor, fa√ßa upload da peti√ß√£o inicial ou cole o texto');
      return;
    }

    setAnalyzing(true);
    openModal('analysis');
    setError('');
    await new Promise(resolve => setTimeout(resolve, 100)); // Aguardar modal abrir

    try {
      // üÜï v1.12.18: Processamento por modo individual (n√£o mais global)
      // Cada documento √© processado conforme seu modo em documentProcessingModes

      let contentArray = [];
      let extractedTextsData = { peticoes: [], contestacoes: [], complementares: [] };
      let peticoesBase64 = [];
      let peticoesTextFinal = [];

      // Obter configura√ß√£o global de OCR (dispon√≠vel para todos os documentos)
      const globalOcrEngine = aiIntegration.aiSettings?.ocrEngine;
      // v1.32.13: Se anonimiza√ß√£o ativa, bloquear apenas modos bin√°rios (pdf-puro, claude-vision)
      // PDF.js e Tesseract extraem texto ‚Üí podem ser anonimizados
      const anonConfig = aiIntegration.aiSettings?.anonymization;
      const anonymizationEnabled = anonConfig?.enabled;
      const blockedModes = ['claude-vision', 'pdf-puro'];
      const getEffectiveMode = (docMode) => {
        if (anonymizationEnabled && blockedModes.includes(docMode)) return 'pdfjs';
        return docMode || globalOcrEngine || 'pdfjs';
      };
      const maybeAnonymize = (text) => anonymizationEnabled ? anonymizeText(text, anonConfig, nomesParaAnonimizar) : text;

      // === PROCESSAR PETI√á√ïES (M√öLTIPLAS) ===
      const totalPeticoes = peticaoFiles.length + pastedPeticaoTexts.length;

      if (peticaoFiles.length > 0) {
        for (let i = 0; i < peticaoFiles.length; i++) {
          const peticaoMode = getEffectiveMode(documentProcessingModes.peticoes?.[i]);
          const label = i === 0 ? 'Peti√ß√£o Inicial' : `Documento do Autor ${i + 1}`;
          setAnalysisProgress(`üìÑ Processando ${label} (${i + 1}/${peticaoFiles.length}) - ${peticaoMode}...`);
          await new Promise(resolve => setTimeout(resolve, 100));

          const fileObj = peticaoFiles[i].file || peticaoFiles[i]; // Compatibilidade com formato antigo
          if (peticaoMode === 'pdf-puro') {
            const base64 = await storage.fileToBase64(fileObj);
            peticoesBase64.push(base64);
            // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
            contentArray.push({ type: 'text', text: `${label.toUpperCase()} (documento PDF a seguir):` });
            contentArray.push({
              type: 'document',
              source: { type: 'base64', media_type: 'application/pdf', data: base64 },
              cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
            });
          } else {
            try {
              let extractedText = null;

              if (peticaoMode === 'pdfjs') {
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current, total) => {
                  setAnalysisProgress(`üìÑ ${label} (PDF.js) - p√°gina ${current}/${total}...`);
                });
              } else if (peticaoMode === 'claude-vision') {
                extractedText = await documentServices.extractTextFromPDFWithClaudeVision(fileObj, (current, total) => {
                  setAnalysisProgress(`üìÑ ${label} (Claude Vision) - p√°gina ${current}/${total}...`);
                });
              } else if (peticaoMode === 'tesseract') {
                extractedText = await documentServices.extractTextFromPDFWithTesseract(fileObj, (current, total, status) => {
                  setAnalysisProgress(`üìÑ ${label} (Tesseract) - p√°gina ${current}/${total} ${status || ''}`);
                });
              } else {
                // Modo desconhecido (legado como 'gemini-vision'), usar pdfjs como fallback
                console.warn(`[analyzeDocuments] Modo desconhecido '${peticaoMode}', usando PDF.js`);
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current, total) => {
                  setAnalysisProgress(`üìÑ ${label} (PDF.js) - p√°gina ${current}/${total}...`);
                });
              }

              if (extractedText && extractedText.length > 100) {
                const anonText = maybeAnonymize(extractedText);
                extractedTextsData.peticoes[i] = { text: anonText, name: label };
                peticoesTextFinal.push({ text: anonText, name: label });
                contentArray.push({
                  type: 'text',
                  text: `${label.toUpperCase()}:\n\n${anonText}`,
                  cache_control: anonText.length > 2000 ? { type: "ephemeral" } : undefined
                });
              } else {
                if (anonymizationEnabled) {
                  console.warn(`[analyzeDocuments] Extra√ß√£o falhou em ${label}, PDF bloqueado (anonimiza√ß√£o ativa)`);
                  showToast(`‚ùå N√£o foi poss√≠vel extrair texto de ${label}. Com anonimiza√ß√£o ativa, PDF bin√°rio n√£o pode ser usado.`, 'error');
                } else {
                  console.warn(`[analyzeDocuments] Extra√ß√£o falhou em ${label}, usando PDF puro`);
                  const base64 = await storage.fileToBase64(fileObj);
                  peticoesBase64.push(base64);
                  // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
                  contentArray.push({ type: 'text', text: `${label.toUpperCase()} (documento PDF a seguir):` });
                  contentArray.push({
                    type: 'document',
                    source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                  });
                }
              }
            } catch (extractErr) {
              if (anonymizationEnabled) {
                console.warn(`[analyzeDocuments] Erro na extra√ß√£o de ${label}, PDF bloqueado (anonimiza√ß√£o ativa)`);
              } else {
                const base64 = await storage.fileToBase64(fileObj);
                peticoesBase64.push(base64);
                // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
                contentArray.push({ type: 'text', text: `${label.toUpperCase()} (documento PDF a seguir):` });
                contentArray.push({
                  type: 'document',
                  source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                });
              }
            }
          }
        }
      }

      // Textos colados de peti√ß√£o
      pastedPeticaoTexts.forEach((pastedItem, idx) => {
        const anonPasted = maybeAnonymize(pastedItem.text);
        peticoesTextFinal.push({ text: anonPasted, name: pastedItem.name });
        contentArray.push({
          type: 'text',
          text: `${pastedItem.name.toUpperCase()}:\n\n${anonPasted}`,
          cache_control: anonPasted.length > 2000 ? { type: "ephemeral" } : undefined
        });
      });

      // === PROCESSAR CONTESTA√á√ïES ===
      const totalContestacoes = contestacaoFiles.length + pastedContestacaoTexts.length;
      let contestacoesBase64 = [];
      let contestacoesTextFinal = [];

      if (contestacaoFiles.length > 0) {
        for (let i = 0; i < contestacaoFiles.length; i++) {
          // v1.14.1: Usar modo individual (global √© apenas padr√£o aplicado ao adicionar arquivo)
          // v1.16.2: Se anonimiza√ß√£o ativa, for√ßar pdfjs
          const mode = getEffectiveMode(documentProcessingModes.contestacoes?.[i]);
          setAnalysisProgress(`üìë Processando contesta√ß√£o ${i + 1}/${contestacaoFiles.length} (${mode})...`);
          await new Promise(resolve => setTimeout(resolve, 100));

          const fileObj = contestacaoFiles[i].file || contestacaoFiles[i]; // Compatibilidade
          if (mode === 'pdf-puro') {
            const base64 = await storage.fileToBase64(fileObj);
            contestacoesBase64.push(base64);
            // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
            contentArray.push({ type: 'text', text: `CONTESTA√á√ÉO ${i + 1} (documento PDF a seguir):` });
            contentArray.push({
              type: 'document',
              source: { type: 'base64', media_type: 'application/pdf', data: base64 }
            });
          } else {
            try {
              let extractedText = null;

              if (mode === 'pdfjs') {
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current, total) => {
                  setAnalysisProgress(`üìë Contesta√ß√£o ${i + 1} (PDF.js) - p√°gina ${current}/${total}...`);
                });
              } else if (mode === 'claude-vision') {
                extractedText = await documentServices.extractTextFromPDFWithClaudeVision(fileObj, (current, total) => {
                  setAnalysisProgress(`üìë Contesta√ß√£o ${i + 1} (Claude Vision) - p√°gina ${current}/${total}...`);
                });
              } else if (mode === 'tesseract') {
                extractedText = await documentServices.extractTextFromPDFWithTesseract(fileObj, (current, total, status) => {
                  setAnalysisProgress(`üìë Contesta√ß√£o ${i + 1} (Tesseract) - p√°gina ${current}/${total} ${status || ''}`);
                });
              } else {
                // Modo desconhecido (legado), usar pdfjs como fallback
                console.warn(`[analyzeDocuments] Contesta√ß√£o - modo desconhecido '${mode}', usando PDF.js`);
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current, total) => {
                  setAnalysisProgress(`üìë Contesta√ß√£o ${i + 1} (PDF.js) - p√°gina ${current}/${total}...`);
                });
              }

              if (extractedText && extractedText.length > 100) {
                const anonText = maybeAnonymize(extractedText);
                extractedTextsData.contestacoes[i] = { text: anonText, name: `Contesta√ß√£o ${i + 1}` };
                contestacoesTextFinal.push({ text: anonText, name: `Contesta√ß√£o ${i + 1}` });
                contentArray.push({
                  type: 'text',
                  text: `CONTESTA√á√ÉO ${i + 1}:\n\n${anonText}`
                });
              } else {
                if (anonymizationEnabled) {
                  showToast(`‚ùå N√£o foi poss√≠vel extrair texto da contesta√ß√£o ${i + 1}. PDF bloqueado (anonimiza√ß√£o ativa).`, 'error');
                } else {
                  showToast(`‚ö†Ô∏è Texto insuficiente na contesta√ß√£o ${i + 1}. Usando documento original.`, 'warning');
                  const base64 = await storage.fileToBase64(fileObj);
                  contestacoesBase64.push(base64);
                  // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
                  contentArray.push({ type: 'text', text: `CONTESTA√á√ÉO ${i + 1} (documento PDF a seguir):` });
                  contentArray.push({
                    type: 'document',
                    source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                  });
                }
              }
            } catch (extractErr) {
              if (anonymizationEnabled) {
                showToast(`‚ùå Erro ao extrair texto da contesta√ß√£o ${i + 1}. PDF bloqueado (anonimiza√ß√£o ativa).`, 'error');
              } else {
                const base64 = await storage.fileToBase64(fileObj);
                contestacoesBase64.push(base64);
                // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
                contentArray.push({ type: 'text', text: `CONTESTA√á√ÉO ${i + 1} (documento PDF a seguir):` });
                contentArray.push({
                  type: 'document',
                  source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                });
              }
            }
          }
        }
      }

      // Adicionar contesta√ß√µes coladas como texto - v1.16.4: Anonimizar
      pastedContestacaoTexts.forEach((contestacao, index) => {
        const anonText = maybeAnonymize(contestacao.text);
        contestacoesTextFinal.push({ ...contestacao, text: anonText });
        contentArray.push({
          type: 'text',
          text: `CONTESTA√á√ÉO ${index + 1 + contestacaoFiles.length}:\n\n${anonText}`
        });
      });

      // === PROCESSAR DOCUMENTOS COMPLEMENTARES ===
      const totalComplementares = complementaryFiles.length + pastedComplementaryTexts.length;
      let complementaryBase64 = [];
      let complementaresTextFinal = [];

      if (complementaryFiles.length > 0) {
        for (let i = 0; i < complementaryFiles.length; i++) {
          // v1.14.1: Usar modo individual (global √© apenas padr√£o aplicado ao adicionar arquivo)
          // v1.16.2: Se anonimiza√ß√£o ativa, for√ßar pdfjs
          const mode = getEffectiveMode(documentProcessingModes.complementares?.[i]);
          setAnalysisProgress(`üìé Processando complementar ${i + 1}/${complementaryFiles.length} (${mode})...`);
          await new Promise(resolve => setTimeout(resolve, 100));

          const fileObj = complementaryFiles[i].file || complementaryFiles[i]; // Compatibilidade
          if (mode === 'pdf-puro') {
            const base64 = await storage.fileToBase64(fileObj);
            complementaryBase64.push(base64);
            // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
            contentArray.push({ type: 'text', text: `DOCUMENTO COMPLEMENTAR ${i + 1} (documento PDF a seguir):` });
            contentArray.push({
              type: 'document',
              source: { type: 'base64', media_type: 'application/pdf', data: base64 }
            });
          } else {
            try {
              let extractedText = null;

              if (mode === 'pdfjs') {
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current, total) => {
                  setAnalysisProgress(`üìé Complementar ${i + 1} (PDF.js) - p√°gina ${current}/${total}...`);
                });
              } else if (mode === 'claude-vision') {
                extractedText = await documentServices.extractTextFromPDFWithClaudeVision(fileObj, (current, total) => {
                  setAnalysisProgress(`üìé Complementar ${i + 1} (Claude Vision) - p√°gina ${current}/${total}...`);
                });
              } else if (mode === 'tesseract') {
                extractedText = await documentServices.extractTextFromPDFWithTesseract(fileObj, (current, total, status) => {
                  setAnalysisProgress(`üìé Complementar ${i + 1} (Tesseract) - p√°gina ${current}/${total} ${status || ''}`);
                });
              } else {
                // Modo desconhecido (legado), usar pdfjs como fallback
                console.warn(`[analyzeDocuments] Complementar - modo desconhecido '${mode}', usando PDF.js`);
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current, total) => {
                  setAnalysisProgress(`üìé Complementar ${i + 1} (PDF.js) - p√°gina ${current}/${total}...`);
                });
              }

              if (extractedText && extractedText.length > 100) {
                const anonText = maybeAnonymize(extractedText);
                extractedTextsData.complementares[i] = { text: anonText, name: `Complementar ${i + 1}` };
                complementaresTextFinal.push({ text: anonText, name: `Complementar ${i + 1}` });
                contentArray.push({
                  type: 'text',
                  text: `DOCUMENTO COMPLEMENTAR ${i + 1}:\n\n${anonText}`
                });
              } else {
                if (anonymizationEnabled) {
                  showToast(`‚ùå N√£o foi poss√≠vel extrair texto do complementar ${i + 1}. PDF bloqueado (anonimiza√ß√£o ativa).`, 'error');
                } else {
                  showToast(`‚ö†Ô∏è Texto insuficiente no documento complementar ${i + 1}. Usando original.`, 'warning');
                  const base64 = await storage.fileToBase64(fileObj);
                  complementaryBase64.push(base64);
                  // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
                  contentArray.push({ type: 'text', text: `DOCUMENTO COMPLEMENTAR ${i + 1} (documento PDF a seguir):` });
                  contentArray.push({
                    type: 'document',
                    source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                  });
                }
              }
            } catch (extractErr) {
              if (anonymizationEnabled) {
                showToast(`‚ùå Erro ao extrair texto do complementar ${i + 1}. PDF bloqueado (anonimiza√ß√£o ativa).`, 'error');
              } else {
                const base64 = await storage.fileToBase64(fileObj);
                complementaryBase64.push(base64);
                // v1.35.14: Adicionar label antes de cada PDF para identifica√ß√£o expl√≠cita
                contentArray.push({ type: 'text', text: `DOCUMENTO COMPLEMENTAR ${i + 1} (documento PDF a seguir):` });
                contentArray.push({
                  type: 'document',
                  source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                });
              }
            }
          }
        }
      }

      // Salvar textos extra√≠dos no estado para persist√™ncia
      setExtractedTexts(extractedTextsData);

      // Adicionar documentos complementares colados como texto - v1.16.4: Anonimizar
      pastedComplementaryTexts.forEach((doc, index) => {
        const anonText = maybeAnonymize(doc.text);
        complementaresTextFinal.push({ ...doc, text: anonText });
        contentArray.push({
          type: 'text',
          text: `DOCUMENTO COMPLEMENTAR ${index + 1 + complementaryFiles.length}:\n\n${anonText}`
        });
      });

      const contestacoesText = totalContestacoes > 0 
        ? `${totalContestacoes} contesta√ß√£o${totalContestacoes > 1 ? '√µes' : ''}`
        : 'nenhuma contesta√ß√£o';

      setAnalysisProgress('ü§ñ Enviando documentos para an√°lise com IA...');
      await new Promise(resolve => setTimeout(resolve, 500));

      contentArray.push({
        type: 'text',
        text: `Analise a peti√ß√£o inicial ${totalContestacoes > 0 ? `e as ${totalContestacoes} contesta√ß√£o${totalContestacoes > 1 ? '√µes' : ''} fornecida${totalContestacoes > 1 ? 's' : ''}` : '(n√£o h√° contesta√ß√£o fornecida)'}. 

T√ìPICO OBRIGAT√ìRIO "RELAT√ìRIO":
Voc√™ DEVE criar um t√≥pico especial chamado "RELAT√ìRIO" (categoria PRELIMINAR) que descreva o hist√≥rico processual.
${totalComplementares > 0 ? `H√° ${totalComplementares} documento${totalComplementares > 1 ? 's' : ''} complementar${totalComplementares > 1 ? 'es' : ''} dispon√≠vel${totalComplementares > 1 ? 'eis' : ''} (atas, provas, documentos adicionais) que devem ser usados APENAS neste t√≥pico RELAT√ìRIO.` : 'Como n√£o h√° documentos complementares, base o relat√≥rio apenas nas informa√ß√µes da peti√ß√£o inicial e contesta√ß√µes sobre o andamento do processo.'}

Extraia e classifique todos os t√≥picos/pedidos em:

              1. QUEST√ïES PROCESSUAIS (impugna√ß√£o aos c√°lculos, regularidade de representa√ß√£o processual, impugna√ß√£o aos documentos, gratuidade de justi√ßa, etc.)
              2. PRELIMINARES (prescri√ß√£o, in√©pcia, ilegitimidade, incompet√™ncia, litispend√™ncia, coisa julgada, etc.)
              3. PREJUDICIAIS (quest√µes que impedem an√°lise do m√©rito - prescri√ß√£o bienal, prescri√ß√£o quinquenal, etc.)
              4. M√âRITO (pedidos principais - verbas rescis√≥rias, horas extras, danos morais, v√≠nculo empregat√≠cio, grupo econ√¥mico, etc.)
              
              Para cada t√≥pico, crie um mini-relat√≥rio em formato NARRATIVO, seguindo EXATAMENTE este modelo com PAR√ÅGRAFOS SEPARADOS:
              
              ${aiIntegration.aiSettings.modeloRelatorio ? `
              MODELO PERSONALIZADO DO USU√ÅRIO:
              ${aiIntegration.aiSettings.modeloRelatorio}
              
              Use este modelo como refer√™ncia, mas mantenha a estrutura de par√°grafos separados.
              ` : `
              MODELO PADR√ÉO:
              PRIMEIRO PAR√ÅGRAFO (alega√ß√µes do autor):
              "O reclamante narra [resumo dos fatos]. Sustenta [argumentos]. Indica que [situa√ß√£o]. Em decorr√™ncia, postula [pedido espec√≠fico]."
              
              SEGUNDO PAR√ÅGRAFO (primeira defesa):
              ${totalContestacoes > 0 ? '"A primeira reclamada, em defesa, alega [argumentos]. Sustenta que [posi√ß√£o]."' : '"N√£o houve apresenta√ß√£o de contesta√ß√£o."'}
              
              ${totalContestacoes > 1 ? 'TERCEIRO PAR√ÅGRAFO (segunda defesa):\n"A segunda r√©, por sua vez, nega [posi√ß√£o]. Aduz [argumentos]."' : ''}
              
              ${totalContestacoes > 2 ? 'QUARTO PAR√ÅGRAFO (terceira defesa):\n"A terceira reclamada tamb√©m contesta [argumentos]. Sustenta [posi√ß√£o]."' : ''}
              `}
              
              T√ìPICO ESPECIAL "RELAT√ìRIO" (OBRIGAT√ìRIO):
              O t√≥pico "RELAT√ìRIO" deve resumir o hist√≥rico processual:
              ${totalComplementares > 0 ? 
              `"A presente reclama√ß√£o foi distribu√≠da em [data se constar]. Realizou-se audi√™ncia em [data], na qual [ocorr√™ncias]. Foram juntados aos autos [documentos]. As partes apresentaram [manifesta√ß√µes]. O processo encontra-se [situa√ß√£o atual]."` 
              : 
              `"A presente reclama√ß√£o foi ajuizada em [data se constar]. ${totalContestacoes > 0 ? 'Foram apresentadas contesta√ß√µes.' : 'N√£o houve apresenta√ß√£o de contesta√ß√£o.'} ${totalContestacoes > 0 ? 'As partes manifestaram-se nos autos.' : ''} O processo encontra-se em fase de senten√ßa."`
              }
              
              ${AI_PROMPTS.formatacaoParagrafos("<p>O reclamante narra...</p><p>A primeira reclamada, em defesa...</p>")}

              ${aiIntegration.aiSettings.detailedMiniReports ? `‚ö†Ô∏è N√çVEL DE DETALHE - FATOS:
              Gere com alto n√≠vel de detalhe em rela√ß√£o aos FATOS alegados pelas partes.
              A descri√ß√£o f√°tica (postulat√≥ria e defensiva) deve ter alto n√≠vel de detalhe.
              ` : ''}

              ESTRUTURA DOS PAR√ÅGRAFOS:
              - PRIMEIRO PAR√ÅGRAFO (<p>): apenas alega√ß√µes do reclamante
              - PAR√ÅGRAFOS SEGUINTES (<p>): uma defesa por par√°grafo
              - Use "O reclamante narra...", "Sustenta...", "Postula..."
              - Para defesas use: "A primeira reclamada, em defesa...", "A segunda r√©, por sua vez...", "A terceira reclamada..."
              - O t√≥pico "RELAT√ìRIO" √© OBRIGAT√ìRIO e deve sempre ser o primeiro da lista
              ${totalComplementares > 0 ? '- Documentos complementares devem ser usados APENAS no t√≥pico "RELAT√ìRIO"' : '- Como n√£o h√° documentos complementares, o RELAT√ìRIO deve ser baseado apenas em peti√ß√£o e contesta√ß√µes'}

              ${AI_PROMPTS.numeracaoReclamadasInicial}

              IDENTIFICA√á√ÉO DAS PARTES:
              Extraia tamb√©m os nomes das partes do processo:
              - Nome completo do RECLAMANTE (autor da a√ß√£o)
              - Nomes completos de todas as RECLAMADAS (r√©s)

              FORMATO DO T√çTULO DOS T√ìPICOS (v1.32.23):
              Use o formato "PEDIDO - CAUSA DE PEDIR" quando a causa de pedir for espec√≠fica e distintiva.
              Exemplos com causa espec√≠fica:
              ‚Ä¢ RESCIS√ÉO INDIRETA - ASS√âDIO MORAL (n√£o apenas "RESCIS√ÉO INDIRETA")
              ‚Ä¢ ADICIONAL DE PERICULOSIDADE - ELETRICIDADE (n√£o apenas "ADICIONAL DE PERICULOSIDADE")
              ‚Ä¢ HORAS EXTRAS - NULIDADE DOS CART√ïES DE PONTO
              ‚Ä¢ DANO MORAL - ACIDENTE DE TRABALHO
              ‚Ä¢ V√çNCULO EMPREGAT√çCIO - FRAUDE √Ä CLT (PJ)
              Exemplos que N√ÉO precisam de complemento (causa √≥bvia ou √∫nica):
              ‚Ä¢ F√âRIAS, D√âCIMO TERCEIRO SAL√ÅRIO (verbas simples)
              ‚Ä¢ IN√âPCIA DA INICIAL, GRATUIDADE DE JUSTI√áA (preliminares gen√©ricas)

              Responda APENAS com um JSON v√°lido, sem markdown, no seguinte formato:
              {
                "partes": {
                  "reclamante": "Nome completo do reclamante",
                  "reclamadas": ["Nome da primeira reclamada", "Nome da segunda reclamada"]
                },
                "topics": [
                  {
                    "title": "PEDIDO - CAUSA ESPEC√çFICA (quando relevante)",
                    "category": "QUEST√ÉO PROCESSUAL | PRELIMINAR | PREJUDICIAL | M√âRITO"
                  }
                ]
              }

              IMPORTANTE: Retorne APENAS t√≠tulo e categoria de cada t√≥pico. N√ÉO inclua o campo "relatorio" - os mini-relat√≥rios ser√£o gerados separadamente para cada t√≥pico.`
      });

      const messages = [
        {
          role: 'user',
          content: contentArray
        }
      ];

      setAnalysisProgress('üß† Aguardando an√°lise da IA (isso pode levar alguns minutos)...');

      // v1.21.26: Parametros para analise critica (fidelidade ao documento)
      const data = await aiIntegration.callAI(messages, {
        maxTokens: 16000,
        useInstructions: true,
        extractText: false, // Retornar data bruto para valida√ß√µes customizadas
        temperature: 0.2,
        topP: 0.85,
        topK: 40
      });

      // Verificar se a resposta foi truncada por limite de tokens (provider-aware)
      const provider = aiIntegration.aiSettings.provider || 'claude';
      const isTruncated = provider === 'gemini'
        ? data.candidates?.[0]?.finishReason === 'MAX_TOKENS'
        : data.stop_reason === 'max_tokens';

      if (isTruncated) {
        throw new Error('O documento √© muito extenso e a an√°lise foi truncada. Tente: 1) Dividir o PDF em partes menores, 2) Usar documentos com menos p√°ginas, ou 3) Colar apenas trechos relevantes do texto.');
      }

      const textContent = aiIntegration.extractResponseText(data, provider);
      
      if (!textContent) {
        throw new Error('Nenhum conte√∫do de texto encontrado na resposta da API');
      }
      
      setAnalysisProgress('üîç Extraindo t√≥picos identificados...');
      await new Promise(resolve => setTimeout(resolve, 300));

      // Limpar markdown e espa√ßos
      let cleanText = textContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

      let parsed;
      try {
        // Tentar parse normal
        parsed = JSON.parse(cleanText);
      } catch (parseError) {

        // Tentar extrair JSON de dentro do texto (caso tenha texto antes/depois)
        const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          try {
            parsed = JSON.parse(jsonMatch[0]);
          } catch (matchError) {

            // √öltima tentativa: tentar corrigir strings n√£o terminadas
            let fixedText = jsonMatch[0];

            // Encontrar a √∫ltima string aberta e fech√°-la
            const lastQuote = fixedText.lastIndexOf('"');
            const lastBrace = fixedText.lastIndexOf('}');

            if (lastQuote > lastBrace) {
              // H√° uma string n√£o fechada
              fixedText = fixedText.substring(0, lastQuote + 1) + '"}]}';

              try {
                parsed = JSON.parse(fixedText);
              } catch (fixError) {
                throw new Error(`Erro ao parsear resposta da IA. Resposta pode estar incompleta ou mal formatada. Detalhes: ${parseError.message}`);
              }
            } else {
              throw new Error(`Erro ao parsear resposta da IA. Resposta pode estar incompleta ou mal formatada. Detalhes: ${parseError.message}`);
            }
          }
        } else {
          throw new Error(`N√£o foi poss√≠vel encontrar JSON v√°lido na resposta da IA. Detalhes: ${parseError.message}`);
        }
      }

      let topics = parsed.topics || [];

      // Armazenar informa√ß√µes das partes se dispon√≠veis
      if (parsed.partes) {
        setPartesProcesso({
          reclamante: parsed.partes.reclamante || '',
          reclamadas: parsed.partes.reclamadas || []
        });
      }

      // v1.14.3: Reordenar t√≥picos via LLM (processuais ‚Üí preliminares ‚Üí prejudiciais ‚Üí m√©rito)
      setAnalysisProgress('üìã Ordenando t√≥picos por categoria processual...');
      await new Promise(resolve => setTimeout(resolve, 300));
      topics = await reorderTopicsViaLLM(topics);

      setAnalysisProgress(`‚úÖ ${topics.length} t√≥pico${topics.length !== 1 ? 's' : ''} identificado${topics.length !== 1 ? 's' : ''}! Revisando...`);
      await new Promise(resolve => setTimeout(resolve, 300));

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // v1.35.30: PAUSA PARA CURADORIA DE T√ìPICOS
      // Permite ao usu√°rio revisar, reordenar, mesclar, separar e apagar t√≥picos
      // ANTES de gastar tokens com a gera√ß√£o de mini-relat√≥rios
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      // Criar contentArray para o relat√≥rio (ser√° usado ap√≥s confirma√ß√£o)
      const relatorioContentArray = [];

      // Usar textos extra√≠dos de peti√ß√µes se dispon√≠veis, sen√£o usar PDFs
      if (peticoesTextFinal.length > 0) {
        peticoesTextFinal.forEach((doc, idx) => {
          relatorioContentArray.push({
            type: 'text',
            text: `${doc.name?.toUpperCase() || `PETI√á√ÉO ${idx + 1}`}:\n\n${doc.text}`
          });
        });
      }
      if (peticoesBase64.length > 0) {
        peticoesBase64.forEach((base64) => {
          relatorioContentArray.push({
            type: 'document',
            source: { type: 'base64', media_type: 'application/pdf', data: base64 }
          });
        });
      }

      // Adicionar contesta√ß√µes (texto extra√≠do ou PDF)
      contestacoesTextFinal.forEach((contestacao, index) => {
        relatorioContentArray.push({
          type: 'text',
          text: `CONTESTA√á√ÉO ${index + 1}:\n\n${contestacao.text}`
        });
      });

      contestacoesBase64.forEach((base64) => {
        relatorioContentArray.push({
          type: 'document',
          source: { type: 'base64', media_type: 'application/pdf', data: base64 }
        });
      });

      // Adicionar documentos complementares (texto extra√≠do ou PDF)
      complementaresTextFinal.forEach((doc, index) => {
        relatorioContentArray.push({
          type: 'text',
          text: `DOCUMENTO COMPLEMENTAR ${index + 1}:\n\n${doc.text}`
        });
      });

      complementaryBase64.forEach((base64) => {
        relatorioContentArray.push({
          type: 'document',
          source: { type: 'base64', media_type: 'application/pdf', data: base64 }
        });
      });

      // Separar textos extra√≠dos de PDFs (novos) dos textos j√° colados (existentes)
      const contestacoesExtraidasDePDF_pre = contestacoesTextFinal.filter(c =>
        !pastedContestacaoTexts.some(p => p.text === c.text)
      );
      const contestacoesJaColadas_pre = contestacoesTextFinal.filter(c =>
        pastedContestacaoTexts.some(p => p.text === c.text)
      );

      const complementaresExtraidasDePDF_pre = complementaresTextFinal.filter(c =>
        !pastedComplementaryTexts.some(p => p.text === c.text)
      );
      const complementaresJaColadas_pre = complementaresTextFinal.filter(c =>
        pastedComplementaryTexts.some(p => p.text === c.text)
      );

      // Separar peti√ß√µes extra√≠das de PDF vs coladas
      const peticoesExtraidasDePDF_pre = peticoesTextFinal.filter(p =>
        !pastedPeticaoTexts.some(pt => pt.text === p.text)
      );
      const peticoesJaColadas_pre = peticoesTextFinal.filter(p =>
        pastedPeticaoTexts.some(pt => pt.text === p.text)
      );

      // Preparar dados para o modal de curadoria
      const curationData = {
        topics: topics,
        partes: parsed.partes || { reclamante: '', reclamadas: [] },
        relatorioContentArray: relatorioContentArray,
        documents: {
          peticoesText: peticoesTextFinal,
          contestacoesText: contestacoesTextFinal,
          complementaresText: complementaresTextFinal,
          peticoesBase64,
          contestacoesBase64,
          complementaryBase64,
          // Textos separados por origem
          contestacoesExtraidasDePDF: contestacoesExtraidasDePDF_pre,
          contestacoesJaColadas: contestacoesJaColadas_pre,
          complementaresExtraidasDePDF: complementaresExtraidasDePDF_pre,
          complementaresJaColadas: complementaresJaColadas_pre,
          peticoesExtraidasDePDF: peticoesExtraidasDePDF_pre,
          peticoesJaColadas: peticoesJaColadas_pre
        }
      };

      // Salvar dados e abrir modal de curadoria
      setPendingCurationData(curationData);
      setShowTopicCurationModal(true);
      setAnalyzing(false);
      setAnalysisProgress('');

      // PAUSA: O fluxo continua em handleCurationConfirm() ap√≥s o usu√°rio confirmar
      return;

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // C√ìDIGO ABAIXO N√ÉO √â MAIS EXECUTADO DIRETAMENTE
      // Foi movido para handleCurationConfirm()
      // Mantido aqui apenas como refer√™ncia (ser√° removido ap√≥s testes)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      const relatorioProcessual = await generateRelatorioProcessual(relatorioContentArray)

      // Normalizar espa√ßamento para remover linhas em branco entre tags HTML
      const relatorioHtml = normalizeHTMLSpacing(relatorioProcessual.trim());

      // Buscar t√≥picos complementares configurados pelo usu√°rio
      const topicosComplementaresConfig = aiIntegration.aiSettings?.topicosComplementares || [];
      const topicosComplementaresAtivos = topicosComplementaresConfig
        .filter(t => t.enabled)
        .sort((a, b) => a.ordem - b.ordem);

      // Gerar t√≥picos complementares baseados na configura√ß√£o
      const topicosComplementares = topicosComplementaresAtivos.map((config, idx) => ({
        title: config.title,
        category: config.category,
        relatorio: config.descricao || '', // v1.20.6: Vazio se n√£o houver descri√ß√£o configurada
        editedContent: '',
        order: topics.length + idx + 1,
        isComplementar: true // Marcador para identificar t√≥picos complementares
      }));
      
      // Filtrar t√≥picos para remover qualquer "RELAT√ìRIO" que possa ter sido gerado pela IA
      const topicsSemRelatorio = topics.filter(topic =>
        !topic.title || topic.title.toUpperCase() !== 'RELAT√ìRIO'
      );

      // ========== CONSTRUIR OBJETO DE DOCUMENTOS ==========
      // Separar textos extra√≠dos de PDFs (novos) dos textos j√° colados (existentes)
      const contestacoesExtraidasDePDF = contestacoesTextFinal.filter(c =>
        !pastedContestacaoTexts.some(p => p.text === c.text)
      );
      const contestacoesJaColadas = contestacoesTextFinal.filter(c =>
        pastedContestacaoTexts.some(p => p.text === c.text)
      );

      const complementaresExtraidasDePDF = complementaresTextFinal.filter(c =>
        !pastedComplementaryTexts.some(p => p.text === c.text)
      );
      const complementaresJaColadas = complementaresTextFinal.filter(c =>
        pastedComplementaryTexts.some(p => p.text === c.text)
      );

      // Separar peti√ß√µes extra√≠das de PDF vs coladas
      const peticoesExtraidasDePDF = peticoesTextFinal.filter(p =>
        !pastedPeticaoTexts.some(pt => pt.text === p.text)
      );
      const peticoesJaColadas = peticoesTextFinal.filter(p =>
        pastedPeticaoTexts.some(pt => pt.text === p.text)
      );

      // Construir objeto de documentos (usado diretamente E salvo no estado)
      const documentsForBatch = {
        peticoes: peticoesBase64,
        peticoesText: [...peticoesExtraidasDePDF, ...peticoesJaColadas],
        contestacoes: contestacoesBase64,
        contestacoesText: [...contestacoesExtraidasDePDF, ...contestacoesJaColadas],
        complementares: complementaryBase64,
        complementaresText: [...complementaresExtraidasDePDF, ...complementaresJaColadas]
      };

      // Salvar no estado (para regenera√ß√µes futuras, ap√≥s React atualizar)
      setAnalyzedDocuments(documentsForBatch);
      // ========== FIM: Documentos constru√≠dos ==========

      // ========== GERA√á√ÉO H√çBRIDA DE MINI-RELAT√ìRIOS (v1.15) ==========
      // Gerar mini-relat√≥rios em batches de 3 requisi√ß√µes paralelas
      let topicsComRelatorios = topicsSemRelatorio;

      if (topicsSemRelatorio.length > 0) {
        setAnalysisProgress(`üìù Gerando mini-relat√≥rios... 0/${topicsSemRelatorio.length}`);

        // CR√çTICO: Passar documentsForBatch diretamente (n√£o depende do estado React)
        const { results, errors } = await generateMiniReportsBatch(
          topicsSemRelatorio.map(t => ({
            title: t.title,
            category: t.category,
            isInitialGeneration: true,
            includeComplementares: false,
            documentsOverride: documentsForBatch
          })),
          {
            batchSize: aiIntegration.aiSettings.parallelRequests || 5,
            delayBetweenBatches: 1000,
            onProgress: (current, total, batchNum, totalBatches) => {
              setAnalysisProgress(`üìù Gerando mini-relat√≥rios... ${current}/${total} (Lote ${batchNum}/${totalBatches})`);
            }
          }
        );

        // Mesclar resultados com os t√≥picos originais
        topicsComRelatorios = topicsSemRelatorio.map(topic => {
          const resultado = results.find(r => r.title === topic.title);
          if (resultado) {
            return { ...topic, relatorio: resultado.relatorio };
          }
          // Se falhou, usar placeholder
          const erro = errors.find(e => e.title === topic.title);
          return {
            ...topic,
            relatorio: `<p>Erro ao gerar mini-relat√≥rio${erro ? `: ${erro.error}` : ''}. Use "Gerar com IA" para tentar novamente.</p>`
          };
        });

        if (errors.length > 0) {
          showToast(`${errors.length} t√≥pico(s) falharam na gera√ß√£o. Voc√™ pode regener√°-los individualmente.`, 'warning');
        }

        setAnalysisProgress(`‚úÖ Mini-relat√≥rios gerados! ${results.length}/${topicsSemRelatorio.length} com sucesso`);
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      // ========== FIM DA GERA√á√ÉO H√çBRIDA ==========

      // v1.19.2: Filtrar complementares que j√° existem nos t√≥picos gerados (case-insensitive)
      const titulosGeradosUpper = new Set(
        topicsComRelatorios.map(t => (t.title || '').toUpperCase().trim())
      );
      const topicosComplementaresUnicos = topicosComplementares.filter(
        t => !titulosGeradosUpper.has((t.title || '').toUpperCase().trim())
      );

      // Adicionar relat√≥rio como primeiro t√≥pico, depois os t√≥picos analisados, depois os complementares
      const allTopics = [
        {
          title: 'RELAT√ìRIO',
          category: 'RELAT√ìRIO',
          relatorio: relatorioHtml,
          editedFundamentacao: relatorioHtml,
          order: 0
        },
        ...topicsComRelatorios.map((topic, index) => ({ ...topic, order: index + 1 })),
        ...topicosComplementaresUnicos
      ];

      setExtractedTopics(allTopics);

      // Selecionar apenas RELAT√ìRIO e os t√≥picos analisados (n√£o os complementares)
      const topicosInicialmenteSelecionados = allTopics.filter((topic, index) => index < topicsComRelatorios.length + 1);
      setSelectedTopics(topicosInicialmenteSelecionados);

      // Limpar PDFs originais ap√≥s extra√ß√£o de texto (textos v√£o para analyzedDocuments)
      if (peticoesTextFinal.length > 0 && peticaoFiles.length > 0) {
        setPeticaoFiles([]);
      }

      if (contestacoesExtraidasDePDF.length > 0) {
        setContestacaoFiles([]);
      }

      if (complementaresExtraidasDePDF.length > 0) {
        setComplementaryFiles([]);
      }

      closeModal('analysis');
      setActiveTab('topics');
    } catch (err) {
      setError('Erro ao analisar documentos: ' + err.message);
      closeModal('analysis');
    } finally {
      setAnalyzing(false);
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // v1.35.30: HANDLERS DE CURADORIA DE T√ìPICOS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * Continua o fluxo de an√°lise ap√≥s o usu√°rio confirmar a curadoria de t√≥picos
   * @param {Array} curatedTopics - T√≥picos ap√≥s edi√ß√£o do usu√°rio (reordenados, mesclados, etc.)
   */
  const handleCurationConfirm = async (curatedTopics) => {
    if (!pendingCurationData) {
      console.error('[handleCurationConfirm] pendingCurationData is null');
      return;
    }

    try {
      setShowTopicCurationModal(false);
      setAnalyzing(true);
      openModal('analysis');

      const { relatorioContentArray, documents, partes } = pendingCurationData;

      // Gerar relat√≥rio processual
      setAnalysisProgress('üìã Gerando relat√≥rio processual...');
      await new Promise(resolve => setTimeout(resolve, 300));

      const relatorioProcessual = await generateRelatorioProcessual(relatorioContentArray);
      const relatorioHtml = normalizeHTMLSpacing(relatorioProcessual.trim());

      // Buscar t√≥picos complementares configurados pelo usu√°rio
      const topicosComplementaresConfig = aiIntegration.aiSettings?.topicosComplementares || [];
      const topicosComplementaresAtivos = topicosComplementaresConfig
        .filter(t => t.enabled)
        .sort((a, b) => a.ordem - b.ordem);

      // Gerar t√≥picos complementares baseados na configura√ß√£o
      const topicosComplementares = topicosComplementaresAtivos.map((config, idx) => ({
        title: config.title,
        category: config.category,
        relatorio: config.descricao || '',
        editedContent: '',
        order: curatedTopics.length + idx + 1,
        isComplementar: true
      }));

      // Filtrar t√≥picos para remover qualquer "RELAT√ìRIO" que possa ter sido inclu√≠do
      const topicsSemRelatorio = curatedTopics.filter(topic =>
        !topic.title || topic.title.toUpperCase() !== 'RELAT√ìRIO'
      );

      // Construir objeto de documentos
      const documentsForBatch = {
        peticoes: documents.peticoesBase64,
        peticoesText: [...documents.peticoesExtraidasDePDF, ...documents.peticoesJaColadas],
        contestacoes: documents.contestacoesBase64,
        contestacoesText: [...documents.contestacoesExtraidasDePDF, ...documents.contestacoesJaColadas],
        complementares: documents.complementaryBase64,
        complementaresText: [...documents.complementaresExtraidasDePDF, ...documents.complementaresJaColadas]
      };

      // Salvar no estado
      setAnalyzedDocuments(documentsForBatch);

      // Gerar mini-relat√≥rios em batches
      let topicsComRelatorios = topicsSemRelatorio;

      if (topicsSemRelatorio.length > 0) {
        setAnalysisProgress(`üìù Gerando mini-relat√≥rios... 0/${topicsSemRelatorio.length}`);

        const { results, errors } = await generateMiniReportsBatch(
          topicsSemRelatorio.map(t => ({
            title: t.title,
            category: t.category,
            isInitialGeneration: true,
            includeComplementares: false,
            documentsOverride: documentsForBatch
          })),
          {
            batchSize: aiIntegration.aiSettings.parallelRequests || 5,
            delayBetweenBatches: 1000,
            onProgress: (current, total, batchNum, totalBatches) => {
              setAnalysisProgress(`üìù Gerando mini-relat√≥rios... ${current}/${total} (Lote ${batchNum}/${totalBatches})`);
            }
          }
        );

        // Mesclar resultados com os t√≥picos
        topicsComRelatorios = topicsSemRelatorio.map(topic => {
          const resultado = results.find(r => r.title === topic.title);
          if (resultado) {
            return { ...topic, relatorio: resultado.relatorio };
          }
          const erro = errors.find(e => e.title === topic.title);
          return {
            ...topic,
            relatorio: `<p>Erro ao gerar mini-relat√≥rio${erro ? `: ${erro.error}` : ''}. Use "Gerar com IA" para tentar novamente.</p>`
          };
        });

        if (errors.length > 0) {
          showToast(`${errors.length} t√≥pico(s) falharam na gera√ß√£o. Voc√™ pode regener√°-los individualmente.`, 'warning');
        }

        setAnalysisProgress(`‚úÖ Mini-relat√≥rios gerados! ${results.length}/${topicsSemRelatorio.length} com sucesso`);
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      // Filtrar complementares que j√° existem nos t√≥picos gerados
      const titulosGeradosUpper = new Set(
        topicsComRelatorios.map(t => (t.title || '').toUpperCase().trim())
      );
      const topicosComplementaresUnicos = topicosComplementares.filter(
        t => !titulosGeradosUpper.has((t.title || '').toUpperCase().trim())
      );

      // Montar lista final de t√≥picos
      const allTopics = [
        {
          title: 'RELAT√ìRIO',
          category: 'RELAT√ìRIO',
          relatorio: relatorioHtml,
          editedFundamentacao: relatorioHtml,
          order: 0
        },
        ...topicsComRelatorios.map((topic, index) => ({ ...topic, order: index + 1 })),
        ...topicosComplementaresUnicos
      ];

      setExtractedTopics(allTopics);

      // Selecionar apenas RELAT√ìRIO e os t√≥picos analisados
      const topicosInicialmenteSelecionados = allTopics.filter((_, index) => index < topicsComRelatorios.length + 1);
      setSelectedTopics(topicosInicialmenteSelecionados);

      // Atualizar partes do processo se dispon√≠veis
      if (partes) {
        setPartesProcesso({
          reclamante: partes.reclamante || '',
          reclamadas: partes.reclamadas || []
        });
      }

      // Limpar PDFs originais ap√≥s extra√ß√£o
      if (documents.peticoesText?.length > 0 && peticaoFiles.length > 0) {
        setPeticaoFiles([]);
      }
      if (documents.contestacoesExtraidasDePDF?.length > 0) {
        setContestacaoFiles([]);
      }
      if (documents.complementaresExtraidasDePDF?.length > 0) {
        setComplementaryFiles([]);
      }

      // Limpar dados pendentes
      setPendingCurationData(null);

      closeModal('analysis');
      setActiveTab('topics');
      showToast('‚úÖ An√°lise conclu√≠da com sucesso!', 'success');

    } catch (err) {
      setError('Erro ao processar t√≥picos: ' + err.message);
      closeModal('analysis');
    } finally {
      setAnalyzing(false);
    }
  };

  /**
   * Cancela a curadoria e volta ao estado inicial
   */
  const handleCurationCancel = () => {
    setShowTopicCurationModal(false);
    setPendingCurationData(null);
    setAnalysisProgress('');
    showToast('An√°lise cancelada. Voc√™ pode reiniciar quando quiser.', 'info');
  };

  // v1.20.1: Usar storage.fileToBase64 com cache LRU (economia de mem√≥ria)
  // A fun√ß√£o storage.fileToBase64 j√° tem cache e evita reconvers√µes


  // üîç FUN√á√ïES: Sistema de Provas

  const analyzeProof = async (proof, analysisType, customInstructions = '', useOnlyMiniRelatorios = false, includeLinkedTopics = false) => {
    try {
      proofManager.addAnalyzingProof(proof.id);
      setError('');

      // v1.16.2: Anonimiza√ß√£o de provas (ProcessingModeSelector j√° for√ßa PDF.js quando ativo)
      // v1.21.3: Adicionado nomesUsuario para anonimizar nomes customizados
      const anonConfig = aiIntegration?.aiSettings?.anonymization;
      const shouldAnonymize = anonConfig?.enabled;
      const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
      const maybeAnonymize = (text) => shouldAnonymize ? anonymizeText(text, anonConfig, nomesParaAnonimizar) : text;

      // Preparar conte√∫do da prova
      let contentArray = [];

      if (proof.isPdf) {
        // Prova em PDF - v1.21.2: Respeita modo de processamento escolhido
        const proofMode = proofManager.proofProcessingModes?.[proof.id] || 'pdfjs';

        if (proofMode === 'pdf-puro') {
          // Usu√°rio escolheu PDF puro explicitamente
          if (shouldAnonymize) {
            // v1.21.9: Fallback para texto extra√≠do quando anonimiza√ß√£o ativa
            const extractedText = proofManager.extractedProofTexts[proof.id];
            if (extractedText) {
              contentArray.push({
                type: 'text',
                text: `PROVA (texto extra√≠do do PDF):\n\n${maybeAnonymize(extractedText)}`
              });
            } else {
              proofManager.removeAnalyzingProof(proof.id);
              showToast('‚ùå Anonimiza√ß√£o ativa: extraia o texto primeiro.', 'error');
              return;
            }
          } else {
            const base64 = await storage.fileToBase64(proof.file);
            contentArray.push({
              type: 'document',
              source: { type: 'base64', media_type: 'application/pdf', data: base64 }
            });
          }
        } else {
          // Usu√°rio escolheu modo de extra√ß√£o (pdfjs ou claude-vision)
          const extractedText = proofManager.extractedProofTexts[proof.id];
          if (extractedText) {
            contentArray.push({
              type: 'text',
              text: `PROVA (texto extra√≠do do PDF):\n\n${maybeAnonymize(extractedText)}`
            });
          } else {
            proofManager.removeAnalyzingProof(proof.id);
            showToast('‚ùå Texto n√£o extra√≠do. Extraia o texto da prova antes de analisar.', 'error');
            return;
          }
        }
      } else {
        // Prova em texto
        contentArray.push({
          type: 'text',
          text: `PROVA:\n\n${maybeAnonymize(proof.text)}`
        });
      }

      // Buscar t√≥picos vinculados a esta prova
      const linkedTopicTitles = proofManager.proofTopicLinks[proof.id] || [];
      const linkedTopics = selectedTopics.filter(t => linkedTopicTitles.includes(t.title));

      // Preparar prompt baseado no tipo de an√°lise
      let prompt = '';

      if (analysisType === 'livre') {
        if (includeLinkedTopics && linkedTopics.length > 0) {
          // Adicionar t√≥picos vinculados e mini-relat√≥rios ao contexto
          const topicsContext = linkedTopics.map((topic, idx) =>
            `üìã T√ìPICO ${idx + 1}: ${topic.title} (${topic.category})\n\n${topic.relatorio || 'Mini-relat√≥rio n√£o dispon√≠vel'}`
          ).join('\n\n---\n\n');

          contentArray.push({
            type: 'text',
            text: `üìö T√ìPICOS VINCULADOS:\n\n${topicsContext}`
          });

          prompt = customInstructions
            ? `Analise a prova a seguir considerando os t√≥picos vinculados fornecidos.\n\nInstru√ß√µes do usu√°rio:\n${customInstructions}`
            : `Analise a prova a seguir considerando os t√≥picos vinculados fornecidos. Seja objetivo e direto.`;
        } else {
          // An√°lise livre simples - apenas prova + instru√ß√µes
          prompt = customInstructions
            ? `Analise a prova a seguir conforme estas instru√ß√µes:\n\n${customInstructions}`
            : `Analise a prova a seguir e forne√ßa insights relevantes. Seja objetivo e direto.`;
        }
      } else {
        // An√°lise contextual - Escolher entre documentos completos ou apenas mini-relat√≥rios

        // Se useOnlyMiniRelatorios estiver ativado E houver t√≥picos vinculados, usar apenas mini-relat√≥rios
        if (useOnlyMiniRelatorios && linkedTopics.length > 0) {
          // Adicionar apenas mini-relat√≥rios dos t√≥picos vinculados
          const miniRelatoriosText = linkedTopics.map((topic, idx) =>
            `üìã T√ìPICO ${idx + 1}: ${topic.title} (${topic.category})\n\n${topic.relatorio || 'Mini-relat√≥rio n√£o dispon√≠vel'}`
          ).join('\n\n---\n\n');

          contentArray.push({
            type: 'text',
            text: `üìö CONTEXTO DOS PEDIDOS VINCULADOS:\n\n${miniRelatoriosText}`
          });
        } else {
          // Comportamento padr√£o: usar helper para documentos (evita duplica√ß√£o)
          const docsArray = buildDocumentContentArray({ includeComplementares: true });
          contentArray.push(...docsArray);
        }

        // Construir resumo do contexto para o prompt
        const totalPeticoes = (analyzedDocuments.peticoes?.length || 0) + (analyzedDocuments.peticoesText?.length || 0);
        const peticaoSummary = useOnlyMiniRelatorios && linkedTopics.length > 0 ?
          'N√£o enviado (usando apenas mini-relat√≥rios)' :
          (totalPeticoes > 0 ?
            `${totalPeticoes} documento${totalPeticoes > 1 ? 's' : ''} do autor fornecido${totalPeticoes > 1 ? 's' : ''} (veja acima)` :
            'Peti√ß√£o inicial n√£o dispon√≠vel');

        const totalContestacoes = (analyzedDocuments.contestacoes?.length || 0) + (analyzedDocuments.contestacoesText?.length || 0);
        const contestacoesSummary = useOnlyMiniRelatorios && linkedTopics.length > 0 ?
          'N√£o enviado (usando apenas mini-relat√≥rios)' :
          (totalContestacoes > 0 ?
            `${totalContestacoes} contesta√ß√£o${totalContestacoes > 1 ? '√µes' : ''} fornecida${totalContestacoes > 1 ? 's' : ''} (veja acima)` :
            'Nenhuma contesta√ß√£o dispon√≠vel');

        const totalComplementares = (analyzedDocuments.complementares?.length || 0) + (analyzedDocuments.complementaresText?.length || 0);
        const complementaresSummary = useOnlyMiniRelatorios && linkedTopics.length > 0 ?
          'N√£o enviado (usando apenas mini-relat√≥rios)' :
          (totalComplementares > 0 ?
            `${totalComplementares} documento${totalComplementares > 1 ? 's' : ''} complementar${totalComplementares > 1 ? 'es' : ''} fornecido${totalComplementares > 1 ? 's' : ''} (veja acima)` :
            'Nenhum documento complementar dispon√≠vel');

        prompt = `${customInstructions ? `**INSTRU√á√ïES ESPEC√çFICAS PARA ESTA PROVA:**\n${customInstructions}\n\n` : ''}Voc√™ est√° analisando uma prova no contexto de um processo trabalhista.

CONTEXTO DO PROCESSO:
- Peti√ß√£o inicial: ${peticaoSummary}
- Contesta√ß√µes: ${contestacoesSummary}
- Documentos complementares: ${complementaresSummary}

${linkedTopics.length > 0 ? `
üéØ **PEDIDOS ESPEC√çFICOS VINCULADOS A ESTA PROVA:**

Esta prova foi vinculada aos seguintes pedidos/t√≥picos do processo:

${linkedTopics.map((topic, idx) => `
${idx + 1}. **${topic.title}** (${topic.category})

   O que as partes alegaram sobre este pedido:
   ${topic.relatorio || 'Mini-relat√≥rio n√£o dispon√≠vel - verifique a peti√ß√£o e contesta√ß√£o acima'}

   ${topic.editedContent ? `Fundamenta√ß√£o parcial j√° escrita (considere ao analisar):
   ${topic.editedContent}
   ` : 'Fundamenta√ß√£o ainda n√£o iniciada para este pedido'}
   Resultado parcial: ${topic.resultado || 'Ainda n√£o definido'}
`).join('\n---\n')}

**IMPORTANTE:** Ao analisar esta prova no contexto do processo, PRIORIZE sua rela√ß√£o com os pedidos vinculados acima.

Para cada pedido vinculado, indique ESPECIFICAMENTE:
- Como esta prova impacta este pedido em particular
- Se a prova favorece o autor ou r√©u neste ponto espec√≠fico
- Qual conclus√£o a prova sugere para este pedido

` : `
‚ö†Ô∏è Esta prova n√£o foi vinculada a nenhum pedido espec√≠fico. A an√°lise ser√° gen√©rica em rela√ß√£o a todo o processo.

`}
Analise a prova fornecida e responda:

1. **O que esta prova demonstra?** Descreva objetivamente o conte√∫do probat√≥rio
2. **Rela√ß√£o com alega√ß√µes do autor**: Esta prova confirma, refuta ou √© neutra em rela√ß√£o √†s alega√ß√µes da peti√ß√£o inicial?
3. **Rela√ß√£o com defesa**: Esta prova confirma, refuta ou √© neutra em rela√ß√£o aos argumentos de defesa?
4. **For√ßa probat√≥ria**: Avalie a qualidade e relev√¢ncia desta prova para o deslinde do feito
5. **Conclus√£o**: De forma resumida, qual a contribui√ß√£o desta prova para a forma√ß√£o do convencimento?

Seja objetivo, t√©cnico e imparcial. Base-se exclusivamente no conte√∫do da prova.

Formato da resposta (use quebras de linha entre se√ß√µes):

CONTE√öDO DA PROVA:
[descreva o que a prova demonstra]

RELA√á√ÉO COM ALEGA√á√ïES DO AUTOR:
[an√°lise]

RELA√á√ÉO COM A DEFESA:
[an√°lise]

FOR√áA PROBAT√ìRIA:
[avalia√ß√£o]

CONCLUS√ÉO:
[s√≠ntese]`;
      }

      contentArray.push({
        type: 'text',
        text: prompt
      });

      // Fazer chamada √† API
      // v1.21.26: Parametros para analise critica de provas
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 20000,
        useInstructions: true,
        temperature: 0.3,
        topP: 0.9,
        topK: 50
      });

      // Armazenar resultado
      proofManager.setProofAnalysisResults(prev => ({
        ...prev,
        [proof.id]: {
          type: analysisType,
          result: textContent.trim()
        }
      }));

    } catch (err) {
      setError('Erro ao analisar prova: ' + err.message);
    } finally {
      proofManager.removeAnalyzingProof(proof.id);
    }
  };

  const generateRelatorioProcessual = async (contentArray) => {
    try {
      // Verificar se h√° modelo personalizado configurado
      const modeloPersonalizado = aiIntegration.aiSettings?.modeloTopicoRelatorio?.trim();
      
      // Definir o modelo a ser usado
      const modeloBase = modeloPersonalizado || AI_PROMPTS.instrucoesRelatorioPadrao;
      
      contentArray.push({
        type: 'text',
        text: `Analise todos os documentos fornecidos (peti√ß√£o inicial, contesta√ß√µes e documentos complementares, se houver) e gere um RELAT√ìRIO PROCESSUAL completo seguindo o modelo abaixo.

${modeloPersonalizado ? 'MODELO PERSONALIZADO DO USU√ÅRIO:' : 'MODELO BASE:'}
${modeloBase}

INSTRU√á√ïES IMPORTANTES:

1. ADAPTE o modelo conforme as informa√ß√µes REAIS encontradas nos documentos
2. Se uma informa√ß√£o N√ÉO existir nos documentos, N√ÉO a inclua no relat√≥rio
3. Se houver informa√ß√µes nos documentos que n√£o est√£o no modelo, adicione-as de forma apropriada
4. Mantenha a estrutura e formata√ß√£o do modelo
5. Use primeira pessoa quando apropriado
6. Seja objetivo e factual
7. Extraia informa√ß√µes precisas:
   - Nomes completos das partes
   - Per√≠odo de trabalho (datas)
   - Fun√ß√£o exercida
   - Remunera√ß√£o
   - Valor da causa
   - Pedidos principais
   - Defesas apresentadas
   - Provas produzidas (per√≠cias, testemunhas, documentos)
   - Audi√™ncias realizadas
   - Tentativas de concilia√ß√£o

8. Se houver m√∫ltiplas reclamadas, adapte o texto (primeira reclamada, segunda reclamada, etc.)
9. Se n√£o houver contesta√ß√£o, adapte o texto correspondente
10. Se n√£o houver prova pericial, omita esse par√°grafo
11. Se n√£o houver testemunhas, adapte o texto
12. Mantenha sempre "DECIDE-SE." no final

${AI_PROMPTS.numeracaoReclamadas}

${AI_PROMPTS.formatacaoHTML("<strong>JO√ÉO DA SILVA</strong>, qualificado na inicial...")}

${AI_PROMPTS.formatacaoParagrafos("<p>JO√ÉO DA SILVA, qualificado na inicial...</p><p>Em defesa, a reclamada...</p>")}

${AI_PROMPTS.estiloRedacao}

${AI_PROMPTS.preservarAnonimizacao}

Responda APENAS com o texto do relat√≥rio formatado em HTML, pronto para ser inserido na senten√ßa. N√£o adicione explica√ß√µes ou coment√°rios.`
      });

      // v1.21.26: Parametros para texto juridico (balanceado)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 8000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.4,
        topP: 0.9,
        topK: 60
      });

      // Normalizar espa√ßamento para evitar linhas em branco duplicadas
      return normalizeHTMLSpacing(textContent.trim());
    } catch (err) {
      return `SENTEN√áA

I - RELAT√ìRIO

Relat√≥rio processual n√£o p√¥de ser gerado automaticamente. Por favor, edite este t√≥pico manualmente.

DECIDE-SE.`;
    }
  };

  // v1.19.2: Normalizar compara√ß√µes case-insensitive
  const toggleTopicSelection = (topic) => {
    const topicTitleUpper = (topic.title || '').toUpperCase().trim();
    const exists = selectedTopics.find(t => (t.title || '').toUpperCase().trim() === topicTitleUpper);
    if (exists) {
      // Remover t√≥pico se j√° est√° selecionado
      setSelectedTopics(selectedTopics.filter(t => (t.title || '').toUpperCase().trim() !== topicTitleUpper));
    } else {
      // Adicionar t√≥pico
      const newTopic = { ...topic, order: selectedTopics.length };
      
      // Se for RELAT√ìRIO, adicionar no in√≠cio
      if (isRelatorio(topic)) {
        setSelectedTopics([newTopic, ...selectedTopics]);
        return;
      }

      // Se for DISPOSITIVO, adicionar no final
      if (isDispositivo(topic)) {
        setSelectedTopics([...selectedTopics, newTopic]);
        return;
      }

      // Para qualquer outro t√≥pico, inserir antes do DISPOSITIVO
      const dispositivoIndex = selectedTopics.findIndex(t => isDispositivo(t));
      
      if (dispositivoIndex !== -1) {
        // DISPOSITIVO existe - inserir antes dele
        const newTopics = [...selectedTopics];
        newTopics.splice(dispositivoIndex, 0, newTopic);
        setSelectedTopics(newTopics);
      } else {
        // DISPOSITIVO n√£o existe - adicionar no final
        setSelectedTopics([...selectedTopics, newTopic]);
      }
    }
  };

  const deleteTopic = (topicToDelete) => {
    setTopicToDelete(topicToDelete);
    openModal('deleteTopic');
  };

  const confirmDeleteTopic = () => {
    if (topicToDelete) {
      // Remove dos t√≥picos extra√≠dos
      setExtractedTopics(extractedTopics.filter(t => t.title !== topicToDelete.title));
      // Remove dos t√≥picos selecionados caso esteja l√°
      setSelectedTopics(selectedTopics.filter(t => t.title !== topicToDelete.title));
      // Remove dos t√≥picos para mesclar caso esteja l√°
      setTopicsToMerge(topicsToMerge.filter(t => t.title !== topicToDelete.title));
    }
    closeModal('deleteTopic');
    setTopicToDelete(null);
  };

  const moveTopicUp = (index) => {
    if (index === 0) return;
    
    // Bloquear movimento de RELAT√ìRIO e DISPOSITIVO
    const topic = selectedTopics[index];
    const targetTopic = selectedTopics[index - 1];
    
    if (isSpecialTopic(topic)) {
      return;
    }

    if (isSpecialTopic(targetTopic)) {
      return;
    }

    const newTopics = [...selectedTopics];
    [newTopics[index - 1], newTopics[index]] = [newTopics[index], newTopics[index - 1]];
    setSelectedTopics(newTopics);
  };

  const moveTopicDown = (index) => {
    if (index === selectedTopics.length - 1) return;

    // Bloquear movimento de RELAT√ìRIO e DISPOSITIVO
    const topic = selectedTopics[index];
    const targetTopic = selectedTopics[index + 1];

    if (isSpecialTopic(topic)) {
      return;
    }

    if (isSpecialTopic(targetTopic)) {
      return;
    }

    const newTopics = [...selectedTopics];
    [newTopics[index], newTopics[index + 1]] = [newTopics[index + 1], newTopics[index]];
    setSelectedTopics(newTopics);
  };

  const moveTopicToPosition = (currentIndex, newPosition) => {
    if (newPosition < 1 || newPosition > selectedTopics.length) return;
    const newIndex = newPosition - 1;
    if (currentIndex === newIndex) return;

    // Bloquear movimento de RELAT√ìRIO e DISPOSITIVO
    const topic = selectedTopics[currentIndex];
    const targetTopic = selectedTopics[newIndex];

    if (isSpecialTopic(topic)) {
      return;
    }

    if (isSpecialTopic(targetTopic)) {
      return;
    }

    const newTopics = [...selectedTopics];
    const [movedTopic] = newTopics.splice(currentIndex, 1);
    newTopics.splice(newIndex, 0, movedTopic);
    setSelectedTopics(newTopics);
  };

  // Lista de stopwords para filtrar
  const STOPWORDS = new Set([
    'de', 'da', 'do', 'dos', 'das', 'para', 'com', 'sem', 'por', 'pelo', 'pela',
    'em', 'no', 'na', 'nos', 'nas', 'ao', 'aos', '√†', '√†s', 'um', 'uma', 'uns', 'umas',
    'o', 'a', 'os', 'as', 'e', 'ou', 'mas', 'que', 'qual', 'quando', 'onde', 'como'
  ]);

  // Sistema de pontua√ß√£o local para filtrar candidatos
  const scoreModel = (model, topicTitle, topicCategory, topicRelatorio) => {
    let score = 0;

    const titleLower = topicTitle.toLowerCase();
    const modelTitleLower = model.title.toLowerCase();

    // Remover stopwords e pegar palavras relevantes
    const titleWords = titleLower.split(/\s+/)
      .filter(w => w.length > 2 && !STOPWORDS.has(w));
    const modelWords = modelTitleLower.split(/\s+/)
      .filter(w => w.length > 2 && !STOPWORDS.has(w));

    // 1. Correspond√™ncia exata de palavras (peso 10)
    titleWords.forEach(titleWord => {
      if (modelWords.includes(titleWord)) {
        score += 10;
      }
    });

    // 2. Correspond√™ncia parcial de palavras (peso 5)
    titleWords.forEach(titleWord => {
      modelWords.forEach(modelWord => {
        if (titleWord !== modelWord && (titleWord.includes(modelWord) || modelWord.includes(titleWord))) {
          score += 5;
        }
      });
    });

    // 3. Keywords (peso 12 - mais importante)
    if (model.keywords) {
      const keywords = model.keywords.toLowerCase().split(',')
        .map(k => k.trim())
        .filter(k => k.length > 0);

      keywords.forEach(keyword => {
        if (titleLower.includes(keyword) || keyword.includes(titleLower.replace(/\s+/g, ''))) {
          score += 12;
        }

        // Verificar tamb√©m no mini-relat√≥rio
        if (topicRelatorio && topicRelatorio.toLowerCase().includes(keyword)) {
          score += 3;
        }
      });
    }

    // 4. Palavras do t√≠tulo do modelo aparecem no mini-relat√≥rio (peso 2)
    if (topicRelatorio) {
      const relatorioLower = topicRelatorio.toLowerCase();
      modelWords.forEach(word => {
        if (relatorioLower.includes(word)) {
          score += 2;
        }
      });
    }

    return score;
  };

  // Refinamento sem√¢ntico com IA (para top candidatos)
  // v1.35.8: useCallback para evitar re-cria√ß√£o a cada render (causa lag no textarea)
  const refineWithAI = React.useCallback(async (topCandidates, topicTitle, topicCategory, topicRelatorio) => {
    if (topCandidates.length === 0) return [];

    try {
      const prompt = `${AI_PROMPTS.roles.relevancia}

CONTEXTO DO T√ìPICO:
T√≠tulo: ${topicTitle}
Categoria: ${topicCategory || 'N√£o especificada'}
Mini-relat√≥rio: ${topicRelatorio || 'N√£o dispon√≠vel'}

MODELOS CANDIDATOS:
${topCandidates.map((m, i) => `${i + 1}. [ID: ${m.id}] ${m.title}
   Categoria: ${m.category || 'N/A'}
   Keywords: ${m.keywords || 'N/A'}
   Resumo: ${m.content || 'N/A'}`).join('\n\n')}

TAREFA:
Analise semanticamente qual desses modelos √© mais relevante para o t√≥pico em quest√£o.
Considere:
1. Similaridade tem√°tica entre t√≠tulo do t√≥pico e t√≠tulo do modelo
2. Relev√¢ncia das keywords com o contexto do mini-relat√≥rio
3. Categoria compat√≠vel
4. Aplicabilidade do conte√∫do do modelo ao contexto do t√≥pico

Responda APENAS com um array JSON contendo os IDs dos modelos ordenados por relev√¢ncia (do mais relevante ao menos relevante).
Formato: ["id1", "id2", "id3", ...]

Inclua APENAS modelos que sejam realmente relevantes. Se nenhum for relevante, retorne array vazio: []`;

      // Usar Sonnet 4.5 (modelo padr√£o) para recomenda√ß√£o de modelos
      const apiRequest = aiIntegration.buildApiRequest([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], 1000);

      // Sobrescrever modelo para Sonnet 4.5 (modelo padr√£o recomendado)
      apiRequest.model = 'claude-sonnet-4-20250514';

      let textContent;
      try {
        // v1.21.26: Parametros deterministicos para ranking de modelos
        // v1.30: Removido model expl√≠cito - usa provider/modelo das configura√ß√µes
        textContent = await aiIntegration.callAI(apiRequest.messages, {
          maxTokens: 300,
          useInstructions: false,
          disableThinking: true,
          logMetrics: true,
          temperature: 0.0,
          topP: 0.9,
          topK: 40
        });
      } catch (err) {
        return topCandidates; // Retorna candidatos sem reordenar
      }

      // Extrair array JSON da resposta
      const jsonMatch = textContent.match(/\[[\s\S]*?\]/);
      if (!jsonMatch) {
        return topCandidates;
      }

      const rankedIds = JSON.parse(jsonMatch[0]);

      // Reordenar modelos baseado no ranking da IA
      const ranked = [];
      rankedIds.forEach(id => {
        const model = topCandidates.find(m => m.id === id);
        if (model) ranked.push(model);
      });

      // Adicionar modelos que n√£o foram ranqueados pela IA (se houver)
      topCandidates.forEach(m => {
        if (!ranked.find(r => r.id === m.id)) {
          ranked.push(m);
        }
      });

      return ranked;

    } catch (error) {
      return topCandidates; // Retorna candidatos sem reordenar em caso de erro
    }
  }, [aiIntegration.buildApiRequest, aiIntegration.callAI]);

  // üöÄ v1.8.2: Fun√ß√£o principal de busca de sugest√µes (h√≠brida - COM CACHE)
  // v1.28.02: Suporte a IA Local via embeddings
  // v1.35.8: useCallback para evitar re-cria√ß√£o a cada render (causa lag no textarea de "regenerar com IA")
  const findSuggestions = React.useCallback(async (topic) => {
    // v1.29.05: N√£o gerar sugest√µes para t√≥picos especiais (RELAT√ìRIO e DISPOSITIVO)
    if (isSpecialTopic(topic)) return { suggestions: [], source: null };
    // v1.28.02: IA Local para sugest√µes (sem API Claude)
    // v1.35.74: Usa aiSettings unificado
    if (aiIntegration.aiSettings.useLocalAIForSuggestions && searchModelReady && modelLibrary.models.some(m => m.embedding?.length === 768)) {
      if (!topic?.title || topic.title.length < 3) return { suggestions: [], source: null }; // v1.28.05
      // v1.32.22: Usar apenas t√≠tulo para query mais focada (categoria e relat√≥rio diluem relev√¢ncia)
      const topicText = topic.title;
      const cacheKey = `suggestions_local_${topicText}`;
      const cached = apiCache.get(cacheKey);
      if (cached) return JSON.parse(cached); // v1.28.05: cache j√° tem formato { suggestions, source }
      try {
        await new Promise(r => setTimeout(r, 0)); // v1.28.03: Yield para UI n√£o congelar
        // v1.32.20: toLowerCase para E5 case-sensitive
        const qEmb = await AIModelService.getEmbedding(topicText.toLowerCase(), 'query');
        const threshold = aiIntegration.aiSettings.modelSemanticThreshold / 100;
        const results = modelLibrary.models
          .filter(m => m.embedding?.length === 768)
          .map(m => ({ ...m, similarity: AIModelService.cosineSimilarity(qEmb, m.embedding) }))
          .filter(m => m.similarity >= threshold)
          .sort((a, b) => b.similarity - a.similarity)
          .slice(0, 5);
        const result = { suggestions: results, source: 'local' }; // v1.28.05
        apiCache.set(cacheKey, JSON.stringify(result));
        return result;
      } catch { /* fallback para sistema atual */ }
    }

    if (!topic || !topic.title || topic.title.length < 3) return { suggestions: [], source: null };
    if (modelLibrary.models.length === 0) return { suggestions: [], source: null };

    const topicTitle = topic.title;
    const topicCategory = topic.category;
    const topicRelatorio = topic.relatorio || topic.editedRelatorio || '';

    // üöÄ v1.8.2: Cache key baseado em t√≠tulo + categoria + relat√≥rio do t√≥pico
    const cacheKey = `suggestions_${topicTitle}_${topicCategory}_${topicRelatorio}`;

    // üöÄ v1.8.2: Verificar cache antes de processar
    const cachedResult = apiCache.get(cacheKey);
    if (cachedResult) {
      return JSON.parse(cachedResult); // v1.28.04: j√° inclui { suggestions, source }
    }

    // PASSO 1: Pontua√ß√£o local
    const scoredModels = modelLibrary.models.map(model => ({
      model,
      score: scoreModel(model, topicTitle, topicCategory, topicRelatorio)
    })).filter(item => item.score > 0); // Filtrar apenas com alguma relev√¢ncia

    // Ordenar por score
    scoredModels.sort((a, b) => b.score - a.score);

    // Pegar top 10 candidatos para refinamento com IA
    const topCandidates = scoredModels.slice(0, 10).map(item => item.model);

    if (topCandidates.length === 0) return { suggestions: [], source: null };

    // PASSO 2: Refinamento sem√¢ntico com IA (apenas para top candidatos)
    const refinedModels = await refineWithAI(topCandidates, topicTitle, topicCategory, topicRelatorio);

    // Retornar top 5 modelos mais relevantes
    const topSuggestions = refinedModels.slice(0, 5);
    const result = { suggestions: topSuggestions, source: 'api' }; // v1.28.04

    // üöÄ v1.8.2: Cachear sugest√µes refinadas
    apiCache.set(cacheKey, JSON.stringify(result));

    return result;
  }, [aiIntegration.aiSettings.useLocalAIForSuggestions, searchModelReady, modelLibrary.models, aiIntegration.aiSettings.modelSemanticThreshold, apiCache, refineWithAI]);

  const startEditing = async (topic) => {
    const topicCopy = {
      ...topic,
      editedFundamentacao: topic.editedFundamentacao || topic.fundamentacao || '',
      editedRelatorio: topic.editedRelatorio || topic.relatorio || ''
    };
    setEditingTopic(topicCopy);
    modelLibrary.setSuggestions([]); // Limpar sugest√µes antigas primeiro
    modelLibrary.setLoadingSuggestions(true); // Indicar que est√° carregando
    setActiveTab('editor');

    // Scroll suave para o in√≠cio da √°rea de edi√ß√£o
    setTimeout(() => {
      if (editorContainerRef.current) {
        editorContainerRef.current.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    }, 100);

    // Buscar sugest√µes de forma ass√≠ncrona (n√£o bloqueia a abertura do editor)
    try {
      const { suggestions, source } = await findSuggestions(topicCopy); // v1.28.04
      modelLibrary.setSuggestions(suggestions);
      modelLibrary.setSuggestionsSource(source);
    } catch (error) {
      modelLibrary.setSuggestions([]);
      modelLibrary.setSuggestionsSource(null);
    } finally {
      modelLibrary.setLoadingSuggestions(false);
    }
  };

  const insertModelContent = (content) => {
    if (editorRef.current) {
      const quill = editorRef.current;

      // Obter posi√ß√£o do cursor (ou fim do documento se n√£o houver sele√ß√£o)
      const range = quill.getSelection(true);
      const position = range ? range.index : quill.getLength() - 1;

      // Sanitizar conte√∫do antes de inserir
      const sanitizedContent = sanitizeHTML(content);

      // Inserir quebras de linha antes do conte√∫do
      quill.insertText(position, '\n\n', 'user');

      // Inserir HTML na posi√ß√£o do cursor + 2 (ap√≥s as quebras)
      quill.clipboard.dangerouslyPasteHTML(position + 2, sanitizedContent);

      // Mover cursor para o final do conte√∫do inserido
      try {
        const delta = quill.clipboard.convert(sanitizedContent);
        const insertedLength = delta.length ? delta.length() : 0;
        quill.setSelection(position + 2 + insertedLength);
      } catch (e) {
        // Fallback: mover para o final
        quill.setSelection(quill.getLength());
      }

      // Atualizar estado com o novo HTML
      const newHTML = sanitizeHTML(quill.root.innerHTML);
      setEditingTopic({
        ...editingTopic,
        editedFundamentacao: newHTML
      });
    }
  };

  // Fun√ß√£o para detectar automaticamente o resultado do julgamento usando IA
  const detectResultadoAutomatico = async (topicTitle, decisionText, topicCategory) => {
    // N√£o detectar para RELAT√ìRIO e DISPOSITIVO
    if (topicTitle.toUpperCase() === 'RELAT√ìRIO' || topicTitle.toUpperCase() === 'DISPOSITIVO') {
      return null;
    }

    // Se n√£o h√° texto de decis√£o, n√£o detectar
    if (!decisionText || decisionText.trim() === '') {
      return null;
    }

    try {
      const plainText = htmlToPlainText(decisionText);

      const prompt = `${AI_PROMPTS.roles.classificacao}

T√ìPICO SENDO ANALISADO:
T√≠tulo: ${topicTitle}
Categoria: ${topicCategory || 'N√£o especificada'}

TEXTO DA DECIS√ÉO ESCRITA PELO USU√ÅRIO:
${plainText}

TAREFA:
Analise o texto da decis√£o e identifique o resultado do julgamento.

OP√á√ïES POSS√çVEIS (escolha UMA):
1. PROCEDENTE - quando o pedido foi totalmente deferido/acolhido
2. IMPROCEDENTE - quando o pedido foi totalmente indeferido/rejeitado
3. PARCIALMENTE PROCEDENTE - quando o pedido foi parcialmente deferido
4. ACOLHIDO - quando uma preliminar, exce√ß√£o ou quest√£o processual foi acolhida
5. REJEITADO - quando uma preliminar, exce√ß√£o ou quest√£o processual foi rejeitada
6. SEM RESULTADO - para t√≥picos administrativos/acess√≥rios sem julgamento de m√©rito
7. INDEFINIDO - quando o texto n√£o deixa claro o resultado ou est√° incompleto

CRIT√âRIOS DE AN√ÅLISE:
- Procure por palavras-chave como: "defiro", "indefiro", "julgo procedente", "julgo improcedente", "parcialmente", "acolho", "rejeito"
- Considere o contexto geral do texto
- Se a categoria for PRELIMINAR, prefira ACOLHIDO/REJEITADO
- Se a categoria for M√âRITO, prefira PROCEDENTE/IMPROCEDENTE/PARCIALMENTE PROCEDENTE
- Se o t√≥pico tratar de dedu√ß√µes previdenci√°rias, prazos e condi√ß√µes para cumprimento da decis√£o, juros ou corre√ß√£o monet√°ria, retorne SEM RESULTADO
- Se houver d√∫vida ou o texto estiver incompleto, retorne INDEFINIDO

Responda APENAS com uma das palavras: PROCEDENTE, IMPROCEDENTE, PARCIALMENTE PROCEDENTE, ACOLHIDO, REJEITADO, SEM RESULTADO ou INDEFINIDO.
N√£o adicione explica√ß√µes, pontos finais ou outros caracteres. Apenas a palavra.`;

      // v1.21.26: Parametros deterministicos para classificacao
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], {
        maxTokens: 500,
        useInstructions: false,
        logMetrics: true,
        temperature: 0.0,
        topP: 0.9,
        topK: 20
      });

      const resultado = textContent.toUpperCase();

      // Validar resultado
      const resultadosValidos = ['PROCEDENTE', 'IMPROCEDENTE', 'PARCIALMENTE PROCEDENTE', 'ACOLHIDO', 'REJEITADO', 'SEM RESULTADO', 'INDEFINIDO'];

      if (resultadosValidos.includes(resultado)) {
        // Se for INDEFINIDO, retornar null para n√£o sobrescrever escolha manual do usu√°rio
        return resultado === 'INDEFINIDO' ? null : resultado;
      } else {
        return null;
      }

    } catch (error) {
      return null;
    }
  };

  const saveTopicEdit = async () => {
    setSavingTopic(true);
    try {
            const isRelatorio = editingTopic.title.toUpperCase() === 'RELAT√ìRIO';
      const isDispositivo = editingTopic.title.toUpperCase() === 'DISPOSITIVO';

      // Validar refs baseado no tipo de t√≥pico
      if (isRelatorio && !relatorioRef.current) return;
      if (isDispositivo && !editorRef.current) return;
      if (!isRelatorio && !isDispositivo && (!editorRef.current || !relatorioRef.current)) return;

      // Capturar conte√∫do dos editores (apenas os que existem)
            const content = editorRef.current ? sanitizeHTML(editorRef.current.root.innerHTML) : '';
            const relatorio = relatorioRef.current ? sanitizeHTML(relatorioRef.current.root.innerHTML) : '';

      let updatedTopic = {
        ...editingTopic,
        editedRelatorio: relatorio,
        relatorio: htmlToPlainText(relatorio)
      };

            if (isDispositivo) {
        updatedTopic.editedContent = content;
      } else if (!isRelatorio) {
        // Apenas t√≥picos normais (n√£o RELAT√ìRIO, n√£o DISPOSITIVO) usam editedFundamentacao
        updatedTopic.editedFundamentacao = content;
      }

      // Detectar resultado automaticamente APENAS se n√£o foi escolha manual do usu√°rio
      // Isso permite re-detec√ß√£o quando o usu√°rio muda o texto da decis√£o
      if (!updatedTopic.resultadoManual) {
        const resultadoDetectado = await detectResultadoAutomatico(
          updatedTopic.title,
          content,
          updatedTopic.category
        );

        if (resultadoDetectado) {
          updatedTopic.resultado = resultadoDetectado;
        }
      }

      const updatedTopics = selectedTopics.map(t =>
        t.title === editingTopic.title ? updatedTopic : t
      );
      setSelectedTopics(updatedTopics);

      // Atualizar tamb√©m em extractedTopics
      const extractedIndex = extractedTopics.findIndex(t => t.title === editingTopic.title);
      if (extractedIndex !== -1) {
        const newExtracted = [...extractedTopics];
        newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], resultado: updatedTopic.resultado };
        setExtractedTopics(newExtracted);
      }

      setLastEditedTopicTitle(editingTopic.title);
      setEditingTopic(null);
      modelLibrary.setSuggestions([]);
      setActiveTab('topics');
    } finally {
      setSavingTopic(false);
    }
  };

  const saveTopicEditWithoutClosing = async () => {
    setSavingTopic(true);
    try {
            const isRelatorio = editingTopic.title.toUpperCase() === 'RELAT√ìRIO';
      const isDispositivo = editingTopic.title.toUpperCase() === 'DISPOSITIVO';

      // Validar refs baseado no tipo de t√≥pico
      if (isRelatorio && !relatorioRef.current) return;
      if (isDispositivo && !editorRef.current) return;
      if (!isRelatorio && !isDispositivo && (!editorRef.current || !relatorioRef.current)) return;

      // Capturar conte√∫do dos editores (apenas os que existem)
            const content = editorRef.current ? sanitizeHTML(editorRef.current.root.innerHTML) : '';
            const relatorio = relatorioRef.current ? sanitizeHTML(relatorioRef.current.root.innerHTML) : '';

      let updatedTopic = {
        ...editingTopic,
        editedRelatorio: relatorio,
        relatorio: htmlToPlainText(relatorio)
      };

            if (isDispositivo) {
        updatedTopic.editedContent = content;
      } else if (!isRelatorio) {
        // Apenas t√≥picos normais (n√£o RELAT√ìRIO, n√£o DISPOSITIVO) usam editedFundamentacao
        updatedTopic.editedFundamentacao = content;
      }

      // Bot√£o "Salvar e Fechar" (saveTopicEdit) continua com detec√ß√£o autom√°tica

      const updatedTopics = selectedTopics.map(t =>
        t.title === editingTopic.title ? updatedTopic : t
      );
      setSelectedTopics(updatedTopics);

      // Atualizar tamb√©m em extractedTopics
      const extractedIndex = extractedTopics.findIndex(t => t.title === editingTopic.title);
      if (extractedIndex !== -1) {
        const newExtracted = [...extractedTopics];
        newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], resultado: updatedTopic.resultado };
        setExtractedTopics(newExtracted);
      }

      // Atualizar tamb√©m o editingTopic com os dados salvos
      setEditingTopic(updatedTopic);

      setLastEditedTopicTitle(editingTopic.title);

      // Feedback visual simples (sem detec√ß√£o de resultado)
      const successMsg = document.createElement('div');
      successMsg.className = 'fixed top-4 left-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-pulse';
      successMsg.innerHTML = '<span>‚úì</span> Salvo!';

      document.body.appendChild(successMsg);
      setTimeout(() => successMsg.remove(), 3000);
    } finally {
      setSavingTopic(false);
    }
  };

  const exportDecision = async () => {
    if (selectedTopics.length === 0) {
      setError('Nenhum t√≥pico selecionado para exportar');
      return;
    }

    setError('');
    
    try {
      let plainText = 'SENTEN√áA\n\n';

      // HTML otimizado para Google Docs e Word
      let htmlText = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
  body { 
    font-family: 'Times New Roman', Times, serif; 
    font-size: 12pt; 
    line-height: 1.5; 
    margin: 2.54cm;
  }
  h1 { 
    text-align: center; 
    font-size: 14pt; 
    font-weight: bold; 
    margin-bottom: 20px;
    text-transform: uppercase;
  }
  h2 { 
    font-size: 12pt; 
    font-weight: bold; 
    margin-top: 20px; 
    margin-bottom: 10px;
    text-transform: uppercase;
  }
  p { 
    margin: 0 0 12px 0; 
    text-align: justify; 
    text-indent: 0;
  }
  ul, ol { 
    margin: 10px 0; 
    padding-left: 40px; 
  }
  li { 
    margin-bottom: 6px; 
  }
  b, strong { 
    font-weight: bold; 
  }
  i, em { 
    font-style: italic; 
  }
  u { 
    text-decoration: underline; 
  }
  .section { 
    margin-bottom: 30px; 
  }
  .fundamentacao-header {
    text-align: left;
    font-weight: bold;
    font-size: 12pt;
    margin: 30px 0 20px 0;
    text-transform: uppercase;
  }
</style>
</head>
<body>
<h1>SENTEN√áA</h1>
`;

      selectedTopics.forEach((topic, index) => {
        // Remover numera√ß√£o romana do t√≠tulo
        let topicTitle = topic.title.toUpperCase();
        topicTitle = topicTitle.replace(/^I\s*[-‚Äì]\s*/i, '');
        topicTitle = topicTitle.replace(/^II\s*[-‚Äì]\s*/i, '');
        topicTitle = topicTitle.replace(/^III\s*[-‚Äì]\s*/i, '');
        topicTitle = topicTitle.replace(/^IV\s*[-‚Äì]\s*/i, '');
        topicTitle = topicTitle.replace(/^V\s*[-‚Äì]\s*/i, '');
        
        plainText += `\n${topicTitle}\n\n`;
        
        htmlText += `<div class="section">`;
        htmlText += `<h2>${topicTitle}</h2>`;
        
                const isRelatorio = topic.title.toUpperCase() === 'RELAT√ìRIO';
        const isDispositivo = topic.title.toUpperCase() === 'DISPOSITIVO';

        if (isRelatorio) {
          // RELAT√ìRIO: apenas editedRelatorio
          const relatorioHtml = topic.editedRelatorio || topic.relatorio || '';
          if (relatorioHtml) {
            htmlText += cleanHtmlForExport(relatorioHtml);
            plainText += htmlToFormattedText(relatorioHtml) + '\n\n';
          }
        } else if (isDispositivo) {
          // DISPOSITIVO: apenas editedContent
          if (topic.editedContent) {
            htmlText += cleanHtmlForExport(topic.editedContent);
            plainText += htmlToFormattedText(topic.editedContent) + '\n\n';
          }
        } else {
          // T√≥picos normais: mini-relat√≥rio + fundamenta√ß√£o
          const relatorioHtml = topic.editedRelatorio || topic.relatorio || '';
          if (relatorioHtml) {
            htmlText += cleanHtmlForExport(relatorioHtml);
            plainText += htmlToFormattedText(relatorioHtml) + '\n\n';
          }
          if (topic.editedFundamentacao) {
            htmlText += cleanHtmlForExport(topic.editedFundamentacao);
            plainText += htmlToFormattedText(topic.editedFundamentacao) + '\n\n';
          }
        }
        
        htmlText += `</div>`;
        
        // Adicionar "FUNDAMENTA√á√ÉO" ap√≥s o primeiro t√≥pico (RELAT√ìRIO)
        if (index === 0) {
          plainText += '\nFUNDAMENTA√á√ÉO\n\n';
          htmlText += `<div class="fundamentacao-header">FUNDAMENTA√á√ÉO</div>`;
        }
      });

      htmlText += `
</body>
</html>`;

      setExportedText(plainText);
      setExportedHtml(htmlText);
      openModal('export');
      
      try {
        // Tentar copiar com formata√ß√£o rica
        const htmlBlob = new Blob([htmlText], { type: 'text/html' });
        const textBlob = new Blob([plainText], { type: 'text/plain' });
        
        await navigator.clipboard.write([
          new ClipboardItem({
            'text/html': htmlBlob,
            'text/plain': textBlob
          })
        ]);
        
        if (copyTimeoutRef.current) clearTimeout(copyTimeoutRef.current);
        setCopySuccess(true);
        copyTimeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
      } catch (clipErr) {
        // Fallback: formato rico falhou, tentar texto simples
        try {
          await navigator.clipboard.writeText(plainText);
          if (copyTimeoutRef.current) clearTimeout(copyTimeoutRef.current);
          setCopySuccess(true);
          copyTimeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
        } catch (err2) {
          setError('N√£o foi poss√≠vel copiar automaticamente. Use o bot√£o "Copiar Novamente" no modal.');
        }
      }
    } catch (err) {
      setError('Erro ao exportar decis√£o: ' + err.message);
    }
  };

  const generateDispositivo = async () => {
    if (selectedTopics.length === 0) {
      setError('Nenhum t√≥pico selecionado. Adicione e preencha os t√≥picos antes de gerar o dispositivo.');
      return;
    }

    // üöÄ v1.14.1: Cache removido - dispositivo sempre deve refletir dados atuais

    // Verificar se h√° t√≥picos decididos sem resultado selecionado (exceto RELAT√ìRIO, DISPOSITIVO e complementares)
    const topicsWithoutResult = selectedTopics.filter(t =>
      isTopicDecidido(t) &&
      !t.resultado &&
      t.title.toUpperCase() !== 'RELAT√ìRIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO' &&
      !t.isComplementar // Ignora t√≥picos complementares
    );
    
    if (topicsWithoutResult.length > 0) {
      const titulosFaltando = topicsWithoutResult.map(t => `"${t.title}"`).join(', ');
      setError(`Os seguintes t√≥picos est√£o decididos mas sem resultado selecionado: ${titulosFaltando}. Por favor, selecione o resultado (Procedente/Improcedente/etc) antes de gerar o dispositivo.`);
      return;
    }

    aiIntegration.setGeneratingDispositivo(true);
    setError('');

    try {
      // Preparar resumo de cada t√≥pico com sua decis√£o

      // Filtrar o t√≥pico RELAT√ìRIO (n√£o √© um pedido) - usando valor memoizado
      const topicsSummary = topicsParaDispositivo.map(topic => {
        const relatorio = topic.editedRelatorio ? htmlToFormattedText(topic.editedRelatorio) : (topic.relatorio || '');

                const isDispositivo = topic.title.toUpperCase() === 'DISPOSITIVO';
        const decisao = isDispositivo
          ? (topic.editedContent ? htmlToFormattedText(topic.editedContent) : '')
          : (topic.editedFundamentacao ? htmlToFormattedText(topic.editedFundamentacao) : '');

        // Marcar explicitamente t√≥picos sem decis√£o
        const temDecisao = decisao && decisao.trim() !== '' && decisao.trim() !== 'Sem decis√£o preenchida';

        // Usar o resultado SELECIONADO PELO USU√ÅRIO (n√£o extrair do texto)
        const resultadoSelecionado = topic.resultado || 'N√ÉO DEFINIDO';

        return {
          titulo: topic.title,
          categoria: topic.category,
          relatorio: relatorio || '',
          decisao: temDecisao ? (decisao || '') : 'SEM DECIS√ÉO PREENCHIDA',
          resultado: resultadoSelecionado,
          temDecisao: temDecisao
        };
      });

      const topicosComDecisao = topicsSummary.filter(t => t.temDecisao);
      const topicosSemDecisao = topicsSummary.filter(t => !t.temDecisao);

      const topicoRelatorio = selectedTopics.find(isRelatorio);
      let primeiroParagrafoRelatorio = '';

      if (topicoRelatorio) {
        const relatorioCompleto = topicoRelatorio.editedRelatorio
          ? htmlToFormattedText(topicoRelatorio.editedRelatorio)
          : (topicoRelatorio.relatorio || '');

        // Divide em linhas e remove vazias
        const linhas = relatorioCompleto.split('\n').map(l => l.trim()).filter(l => l.length > 0);

        // Procura primeiro par√°grafo substancial (ignora t√≠tulos curtos sem pontua√ß√£o interna)
        let paragrafoEncontrado = '';
        for (const linha of linhas) {
          // Ignora se for muito curto (< 50 chars) ou se n√£o cont√©m v√≠rgula/ponto (provavelmente √© t√≠tulo)
          const ehTitulo = linha.length < 50 || (!linha.includes(',') && !linha.includes('. '));

          if (!ehTitulo) {
            // Achou o primeiro par√°grafo substancial
            paragrafoEncontrado = linha;
            break;
          }
        }

        // Se n√£o achou nenhum par√°grafo substancial, usa o primeiro n√£o-vazio
        primeiroParagrafoRelatorio = paragrafoEncontrado || (linhas[0] || '');

        if (!primeiroParagrafoRelatorio) {
          setError('Aviso: Primeiro par√°grafo do RELAT√ìRIO est√° vazio. Os placeholders podem n√£o funcionar corretamente.');
        }
      } else {
        setError('Erro: T√≥pico RELAT√ìRIO n√£o encontrado. Crie um t√≥pico chamado "RELAT√ìRIO" com os nomes das partes no primeiro par√°grafo.');
      }

      // Preparar prompt com contexto dos t√≥picos (SEM documentos processuais)
      const promptText = `${AI_PROMPTS.roles.redacao}

Com base nos t√≥picos decididos abaixo, gere um DISPOSITIVO completo.

ATEN√á√ÉO CR√çTICA: O usu√°rio SELECIONOU EXPLICITAMENTE o resultado de cada decis√£o. Use EXATAMENTE o resultado fornecido, sem interpreta√ß√£o.

Com base nos t√≥picos e resultados fornecidos abaixo, gere um DISPOSITIVO completo e bem estruturado para uma senten√ßa trabalhista.

${AI_PROMPTS.buildPartesDoProcesso(primeiroParagrafoRelatorio)}

${AI_PROMPTS.buildTopicosSection(topicosComDecisao, topicosSemDecisao)}

INSTRU√á√ïES PARA O DISPOSITIVO:

${AI_PROMPTS.regraFundamentalDispositivo}

${AI_PROMPTS.estiloRedacao}

${aiIntegration.aiSettings.modeloDispositivo ? `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
MODELO PERSONALIZADO DO USU√ÅRIO:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Use o seguinte modelo como refer√™ncia para estruturar o dispositivo:

${aiIntegration.aiSettings.modeloDispositivo}

‚ö†Ô∏è INSTRU√á√ïES PARA PLACEHOLDERS:
Se o modelo personalizado contiver placeholders como [RECLAMANTE], [RECLAMADA], [PRIMEIRA RECLAMADA], [SEGUNDA RECLAMADA], etc., substitua-os pelos nomes reais extra√≠dos da se√ß√£o "PARTES DO PROCESSO" acima.

Importante: Use o RESULTADO SELECIONADO PELO USU√ÅRIO para cada t√≥pico.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
` : AI_PROMPTS.instrucoesDispositivoPadrao}

IMPORTANTE:
- Use linguagem formal e t√©cnico-jur√≠dica adequada
- Mantenha primeira pessoa do singular (DECIDO, julgo, reconhe√ßo, etc.)
- Seja objetivo e claro em cada item
- **NUNCA USE NUMERA√á√ÉO ROMANA (I, II, III, IV)** - use apenas h√≠fens (-) ou bullets
- **N√ÉO INCLUA JUSTIFICATIVAS OU FUNDAMENTOS** - apenas o resultado
- **USE O "RESULTADO SELECIONADO PELO USU√ÅRIO"** - foi escolhido manualmente
- **N√ÉO INVERTA OS RESULTADOS** - se diz IMPROCEDENTE, escreva IMPROCEDENTE
- Organize os itens de forma l√≥gica (quest√µes processuais primeiro, depois m√©rito, pedidos n√£o decididos por √∫ltimo)
- Para resultados "N√ÉO DEFINIDO", deixe MUITO CLARO que n√£o foram apreciados

${AI_PROMPTS.formatacaoHTML("<strong>JULGAR PROCEDENTE</strong> o pedido de...")}

${AI_PROMPTS.formatacaoParagrafos("<p>Ante o exposto...</p><p>REJEITAR a preliminar...</p>")}

${AI_PROMPTS.numeracaoReclamadas}

CHECKLIST DE VERIFICA√á√ÉO FINAL:
1. ‚úì Usei o "RESULTADO SELECIONADO PELO USU√ÅRIO" para cada t√≥pico?
2. ‚úì Se diz "IMPROCEDENTE", escrevi "IMPROCEDENTE" (n√£o "PROCEDENTE")?
3. ‚úì Se diz "PROCEDENTE", escrevi "PROCEDENTE" (n√£o "IMPROCEDENTE")?
4. ‚úì N√£o inverti nenhum resultado escolhido pelo usu√°rio?
5. ‚úì Omiti justificativas e inclu√≠ apenas o resultado?
6. ‚úì N√ÉO usei numera√ß√£o romana (I, II, III, IV)?
7. ‚úì Usei HTML (<strong>, <em>, <br>) ao inv√©s de markdown (**, *, ##)?

Responda APENAS com o texto completo do dispositivo em HTML, sem explica√ß√µes adicionais.`;

      // Preparar contentArray APENAS com o prompt (sem documentos processuais)
      const contentArray = [{
        type: 'text',
        text: promptText
      }];

      // v1.21.26: Parametros para dispositivo (mais restrito)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 8000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.3,
        topP: 0.9,
        topK: 50
      });

      // Normalizar espa√ßamento para evitar linhas em branco duplicadas
      const dispositivoFinal = normalizeHTMLSpacing(textContent.trim());

      // v1.14.1: Cache removido - dispositivo sempre deve refletir dados atuais

      aiIntegration.setDispositivoText(dispositivoFinal);
      openModal('dispositivo');
      aiIntegration.setGeneratingDispositivo(false);
    } catch (err) {
      setError('Erro ao gerar dispositivo: ' + err.message);
      aiIntegration.setGeneratingDispositivo(false);
    }
  };

  const regenerateDispositivoWithInstruction = async () => {
    if (!editingTopic || editingTopic.title.toUpperCase() !== 'DISPOSITIVO') {
      setError('Esta fun√ß√£o s√≥ pode ser usada para o t√≥pico DISPOSITIVO');
      return;
    }

    // Validar que h√° t√≥picos decididos
    if (selectedTopics.length === 0) {
      setError('Nenhum t√≥pico selecionado. Adicione e preencha os t√≥picos antes de regenerar o dispositivo.');
      return;
    }

    const topicsWithoutResult = selectedTopics.filter(t =>
      isTopicDecidido(t) &&
      !t.resultado &&
      t.title.toUpperCase() !== 'RELAT√ìRIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO' &&
      !t.isComplementar
    );

    if (topicsWithoutResult.length > 0) {
      const titulosFaltando = topicsWithoutResult.map(t => `"${t.title}"`).join(', ');
      setError(`Os seguintes t√≥picos est√£o decididos mas sem resultado selecionado: ${titulosFaltando}. Por favor, selecione o resultado (Procedente/Improcedente/etc) antes de regenerar o dispositivo.`);
      return;
    }

    aiIntegration.setRegeneratingDispositivo(true);
    setAnalysisProgress('üîÑ Regenerando DISPOSITIVO...');

    try {
      // Preparar resumo dos t√≥picos com decis√µes (SEM documentos processuais)
      const topicsSummary = topicsParaDispositivo.map(topic => {
        const relatorio = topic.editedRelatorio ? htmlToFormattedText(topic.editedRelatorio) : (topic.relatorio || '');
        const decisao = topic.editedFundamentacao ? htmlToFormattedText(topic.editedFundamentacao) : '';
        const temDecisao = decisao && decisao.trim() !== '' && decisao.trim() !== 'Sem decis√£o preenchida';

        return {
          titulo: topic.title,
          categoria: topic.category,
          relatorio: relatorio || '',
          decisao: temDecisao ? (decisao || '') : 'SEM DECIS√ÉO PREENCHIDA',
          resultado: topic.resultado || 'N√ÉO DEFINIDO',
          temDecisao: temDecisao
        };
      });

      // Extrair primeiro par√°grafo do RELAT√ìRIO para placeholders
      const topicoRelatorio = selectedTopics.find(isRelatorio);
      let primeiroParagrafoRelatorio = '';
      if (topicoRelatorio) {
        const relatorioCompleto = htmlToFormattedText(topicoRelatorio.editedRelatorio || topicoRelatorio.relatorio || '');
        const linhas = relatorioCompleto.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        for (const linha of linhas) {
          const ehTitulo = linha.length < 50 || (!linha.includes(',') && !linha.includes('. '));
          if (!ehTitulo) {
            primeiroParagrafoRelatorio = linha;
            break;
          }
        }
        primeiroParagrafoRelatorio = primeiroParagrafoRelatorio || (linhas[0] || '');
      }

      // Construir prompt completo (SEM documentos processuais)
      const topicosComDecisao = topicsSummary.filter(t => t.temDecisao);
      const topicosSemDecisao = topicsSummary.filter(t => !t.temDecisao);

      // Instru√ß√£o customizada do usu√°rio
      const instrucaoCustomizada = aiIntegration.dispositivoInstruction?.trim() || '';

      const promptText = `${AI_PROMPTS.roles.redacao}

Com base nos t√≥picos decididos abaixo, gere um DISPOSITIVO completo.

${instrucaoCustomizada ? `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìù INSTRU√á√ÉO CUSTOMIZADA DO USU√ÅRIO:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${instrucaoCustomizada}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
` : ''}

ATEN√á√ÉO CR√çTICA: O usu√°rio SELECIONOU EXPLICITAMENTE o resultado de cada decis√£o. Use EXATAMENTE o resultado fornecido, sem interpreta√ß√£o.

Com base nos t√≥picos e resultados fornecidos abaixo, gere um DISPOSITIVO completo e bem estruturado para uma senten√ßa trabalhista.

${AI_PROMPTS.buildPartesDoProcesso(primeiroParagrafoRelatorio)}

${AI_PROMPTS.buildTopicosSection(topicosComDecisao, topicosSemDecisao)}

INSTRU√á√ïES PARA O DISPOSITIVO:

${AI_PROMPTS.regraFundamentalDispositivo}

${AI_PROMPTS.estiloRedacao}

${aiIntegration.aiSettings.modeloDispositivo ? `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
MODELO PERSONALIZADO DO USU√ÅRIO:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Use o seguinte modelo como refer√™ncia para estruturar o dispositivo:

${aiIntegration.aiSettings.modeloDispositivo}

‚ö†Ô∏è INSTRU√á√ïES PARA PLACEHOLDERS:
Se o modelo personalizado contiver placeholders como [RECLAMANTE], [RECLAMADA], [PRIMEIRA RECLAMADA], [SEGUNDA RECLAMADA], etc., substitua-os pelos nomes reais extra√≠dos da se√ß√£o "PARTES DO PROCESSO" acima.

Importante: Use o RESULTADO SELECIONADO PELO USU√ÅRIO para cada t√≥pico.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
` : AI_PROMPTS.instrucoesDispositivoPadrao}${aiIntegration.dispositivoInstruction.trim() ? `

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è INSTRU√á√ÉO ADICIONAL DO USU√ÅRIO (v1.5.8c):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${aiIntegration.dispositivoInstruction.trim()}

Por favor, considere esta instru√ß√£o adicional ao gerar o dispositivo, mantendo todas as demais regras e estruturas definidas acima.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
` : ''}

IMPORTANTE:
- Use linguagem formal e t√©cnico-jur√≠dica adequada
- Mantenha primeira pessoa do singular (DECIDO, julgo, reconhe√ßo, etc.)
- Seja objetivo e claro em cada item
- **NUNCA USE NUMERA√á√ÉO ROMANA (I, II, III, IV)** - use apenas h√≠fens (-) ou bullets
- **N√ÉO INCLUA JUSTIFICATIVAS OU FUNDAMENTOS** - apenas o resultado
- **USE O "RESULTADO SELECIONADO PELO USU√ÅRIO"** - foi escolhido manualmente
- **N√ÉO INVERTA OS RESULTADOS** - se diz IMPROCEDENTE, escreva IMPROCEDENTE
- Organize os itens de forma l√≥gica (quest√µes processuais primeiro, depois m√©rito, pedidos n√£o decididos por √∫ltimo)
- Para resultados "N√ÉO DEFINIDO", deixe MUITO CLARO que n√£o foram apreciados

${AI_PROMPTS.formatacaoHTML("<strong>JULGAR PROCEDENTE</strong> o pedido de...")}

${AI_PROMPTS.formatacaoParagrafos("<p>Ante o exposto...</p><p>REJEITAR a preliminar...</p>")}

${AI_PROMPTS.numeracaoReclamadas}

CHECKLIST DE VERIFICA√á√ÉO FINAL:
1. ‚úì Usei o "RESULTADO SELECIONADO PELO USU√ÅRIO" para cada t√≥pico?
2. ‚úì Se diz "IMPROCEDENTE", escrevi "IMPROCEDENTE" (n√£o "PROCEDENTE")?
3. ‚úì Se diz "PROCEDENTE", escrevi "PROCEDENTE" (n√£o "IMPROCEDENTE")?
4. ‚úì N√£o inverti nenhum resultado escolhido pelo usu√°rio?
5. ‚úì Omiti justificativas e inclu√≠ apenas o resultado?
6. ‚úì N√ÉO usei numera√ß√£o romana (I, II, III, IV)?
7. ‚úì Usei HTML (<strong>, <em>, <br>) ao inv√©s de markdown (**, *, ##)?

Responda APENAS com o texto completo do dispositivo em HTML, sem explica√ß√µes adicionais.`;

      // Preparar contentArray APENAS com o prompt (sem documentos processuais)
      const contentArray = [{
        type: 'text',
        text: promptText
      }];

      // Fazer chamada √† API
      // v1.21.26: Parametros para dispositivo (mais restrito)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 8000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.3,
        topP: 0.9,
        topK: 50
      });

      if (!textContent || textContent.trim() === '') {
        throw new Error('Dispositivo gerado est√° vazio');
      }

            // Normalizar espa√ßamento para evitar linhas em branco duplicadas
      const htmlContent = normalizeHTMLSpacing(textContent.trim());

      // Atualizar o editingTopic
      const updatedTopic = {
        ...editingTopic,
        editedContent: htmlContent
      };
      setEditingTopic(updatedTopic);

            if (editorRef.current) {
        editorRef.current.root.innerHTML = sanitizeHTML(htmlContent);
      }

      // Atualizar os arrays de t√≥picos
      setSelectedTopics(selectedTopics.map(t =>
        t.title === editingTopic.title ? updatedTopic : t
      ));
      setExtractedTopics(extractedTopics.map(t =>
        t.title === editingTopic.title ? updatedTopic : t
      ));

      setAnalysisProgress('');
      aiIntegration.setDispositivoInstruction('');
      showToast('‚úÖ DISPOSITIVO regenerado com sucesso!', 'success');

    } catch (err) {
      setError('Erro ao regenerar DISPOSITIVO: ' + err.message);
      setAnalysisProgress('');
    } finally {
      aiIntegration.setRegeneratingDispositivo(false);
    }
  };

  // v1.21.21: Fun√ß√£o para montar texto completo da decis√£o (RELAT√ìRIO + T√ìPICOS + DISPOSITIVO)
  const buildDecisionText = React.useCallback(() => {
    const parts = [];

    // RELAT√ìRIO
    const relatorio = selectedTopics.find(isRelatorio);
    if (relatorio) {
      parts.push('=== RELAT√ìRIO ===\n\n' +
        htmlToFormattedText(relatorio.editedRelatorio || relatorio.relatorio || ''));
    }

    // T√ìPICOS (exceto RELAT√ìRIO e DISPOSITIVO)
    parts.push('\n\n=== FUNDAMENTA√á√ÉO ===\n');
    selectedTopics
      .filter(t => !isRelatorio(t) && !isDispositivo(t))
      .forEach(topic => {
        const miniRelatorio = htmlToFormattedText(topic.editedRelatorio || topic.relatorio || '');
        const decisao = htmlToFormattedText(topic.editedFundamentacao || '');
        parts.push(`\n### ${topic.title.toUpperCase()} (${topic.category || 'Sem categoria'})\nResultado: ${topic.resultado || 'N√ÉO DEFINIDO'}\n\nMini-relat√≥rio:\n${miniRelatorio || 'N√£o preenchido'}\n\nDecis√£o:\n${decisao || 'N√£o preenchida'}`);
      });

    // DISPOSITIVO
    const dispositivo = selectedTopics.find(isDispositivo);
    if (dispositivo?.editedContent) {
      parts.push('\n\n=== DISPOSITIVO ===\n\n' +
        htmlToFormattedText(dispositivo.editedContent));
    }

    return parts.join('');
  }, [selectedTopics]);

  // v1.21.21: Fun√ß√£o para revisar senten√ßa buscando omiss√µes, contradi√ß√µes e obscuridades
  const reviewSentence = async () => {
    if (!canGenerateDispositivo.enabled) {
      setError('Complete todos os t√≥picos antes de revisar a senten√ßa.');
      return;
    }

    setGeneratingReview(true);
    setError('');

    try {
      const contentArray = [];

      // Se escopo inclui documentos, usar buildDocumentContentArray existente
      if (reviewScope === 'decisionWithDocs') {
        const docsArray = buildDocumentContentArray({ includeComplementares: true });
        contentArray.push(...docsArray);
      }

      // Adicionar decis√£o completa
      contentArray.push({
        type: 'text',
        text: `DECIS√ÉO PARA REVIS√ÉO:\n\n${buildDecisionText()}`
      });

      // v1.21.25: Parametros especificos para revisao critica (mais rigoroso, menos criativo)
      const result = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 8192,
        systemPrompt: AI_PROMPTS.revisaoSentenca(reviewScope === 'decisionWithDocs'),
        useInstructions: false,
        logMetrics: true,
        temperature: 0.2,
        topP: 0.9,
        topK: 40
      });

      setReviewResult(normalizeHTMLSpacing(result.trim()));
      closeModal('sentenceReview');
      openModal('sentenceReviewResult');
    } catch (err) {
      setError('Erro ao revisar senten√ßa: ' + err.message);
    } finally {
      setGeneratingReview(false);
    }
  };

  // üöÄ OTIMIZA√á√ÉO v1.15.0: Busca inteligente unificada com sin√¥nimos e normaliza√ß√£o
  const filteredModels = React.useMemo(() => {
    let results = modelLibrary.models;

    // Aplicar busca inteligente se houver termo
    if (modelLibrary.searchTerm.trim()) {
      results = searchModelsInLibrary(results, modelLibrary.searchTerm, {
        includeContent: true,
        limit: null
      });
    }

    // Aplicar filtros adicionais (categoria, favoritos e propriedade)
    return results.filter(m => {
      const matchesCategory = modelLibrary.selectedCategory === 'all' || m.category === modelLibrary.selectedCategory;
      const matchesFavorite = !modelLibrary.showFavoritesOnly || m.favorite;
      // v1.35.0: Filtro de propriedade (todos/meus/compartilhados)
      const matchesOwnership =
        modelLibrary.ownershipFilter === 'all' ||
        (modelLibrary.ownershipFilter === 'mine' && !m.isShared) ||
        (modelLibrary.ownershipFilter === 'shared' && m.isShared);
      return matchesCategory && matchesFavorite && matchesOwnership;
    });
  }, [modelLibrary.models, modelLibrary.searchTerm, modelLibrary.selectedCategory, modelLibrary.showFavoritesOnly, modelLibrary.ownershipFilter]);

  // üöÄ OTIMIZA√á√ÉO v1.4.1: Memoizar pagina√ß√£o para evitar rec√°lculo e slice desnecess√°rios
  const { currentModels, totalModelPages, indexOfFirstModel, indexOfLastModel } = React.useMemo(() => {
    const totalPages = Math.ceil(filteredModels.length / modelLibrary.modelsPerPage);
    const lastIdx = modelLibrary.currentModelPage * modelLibrary.modelsPerPage;
    const firstIdx = lastIdx - modelLibrary.modelsPerPage;
    const paginatedModels = filteredModels.slice(firstIdx, lastIdx);
    return {
      currentModels: paginatedModels,
      totalModelPages: totalPages,
      indexOfFirstModel: firstIdx,
      indexOfLastModel: lastIdx
    };
  }, [filteredModels, modelLibrary.currentModelPage, modelLibrary.modelsPerPage]);

  // üöÄ v1.4.3: Memoizar c√°lculo de provas vinculadas (evita rec√°lculo durante digita√ß√£o)
  const linkedProofs = React.useMemo(() => {
    if (!editingTopic) return [];

    const linkedProofIds = Object.keys(proofManager.proofTopicLinks).filter(proofId =>
      proofManager.proofTopicLinks[proofId]?.includes(editingTopic.title)
    );

    return [
      ...proofManager.proofFiles.filter(p => linkedProofIds.includes(String(p.id))).map(p => ({ ...p, isPdf: true })),
      ...proofManager.proofTexts.filter(p => linkedProofIds.includes(String(p.id))).map(p => ({ ...p, isPdf: false }))
    ];
  }, [editingTopic?.title, proofManager.proofTopicLinks]);

  // üì¶ v1.27.01: Contagem de modelos com embedding e estados de busca sem√¢ntica
  const modelEmbeddingsCount = React.useMemo(() =>
    modelLibrary.models.filter(m => m.embedding?.length === 768).length,
    [modelLibrary.models]
  );
  // v1.28.01: Usa toggle global como padr√£o se n√£o houver valor no localStorage
  // v1.35.74: Usa aiSettings unificado
  const [useModelSemanticSearch, setUseModelSemanticSearch] = React.useState(() => {
    try {
      const stored = localStorage.getItem('modelSemanticMode');
      if (stored !== null) return stored === 'true';
      return aiIntegration.aiSettings.modelSemanticEnabled; // Usa toggle global como fallback
    } catch { return false; }
  });
  const [modelSemanticResults, setModelSemanticResults] = React.useState(null);
  const [searchingModelSemantics, setSearchingModelSemantics] = React.useState(false);

  // Busca sem√¢ntica de modelos dispon√≠vel se: toggle global ativo + modelo pronto + modelos com embedding
  const modelSemanticAvailable = aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady && modelEmbeddingsCount > 0;

  // Handler para busca sem√¢ntica de modelos
  // v1.35.74: Usa aiSettings unificado
  const performModelSemanticSearch = React.useCallback(async (query) => {
    if (!query || query.length < 3 || !modelSemanticAvailable) {
      setModelSemanticResults(null);
      return;
    }
    setSearchingModelSemantics(true);
    try {
      const threshold = aiIntegration.aiSettings.modelSemanticThreshold / 100;
      const results = await searchModelsBySimilarity(modelLibrary.models, query, { threshold, limit: 30 });
      setModelSemanticResults(results);
    } catch (err) {
      console.error('[Model Semantic] Erro na busca:', err);
      setModelSemanticResults(null);
    } finally {
      setSearchingModelSemantics(false);
    }
  }, [modelSemanticAvailable, aiIntegration.aiSettings.modelSemanticThreshold, modelLibrary.models]);

  // Debounce para busca sem√¢ntica de modelos
  const modelSemanticSearchTimeoutRef = React.useRef(null);
  React.useEffect(() => {
    if (useModelSemanticSearch && modelSemanticAvailable && modelLibrary.searchTerm) {
      clearTimeout(modelSemanticSearchTimeoutRef.current);
      modelSemanticSearchTimeoutRef.current = setTimeout(() => {
        performModelSemanticSearch(modelLibrary.searchTerm);
      }, 500);
    } else {
      setModelSemanticResults(null);
    }
    return () => clearTimeout(modelSemanticSearchTimeoutRef.current);
  }, [modelLibrary.searchTerm, useModelSemanticSearch, modelSemanticAvailable, performModelSemanticSearch]);

  // üöÄ v1.4.3: Pr√©-calcular categorias e contagens (1 loop em vez de N+2)
  const { categories, categoryCounts } = React.useMemo(() => {
    const cats = new Set();
    const counts = {};
    let withoutCategory = 0;
    let favorites = 0;

    modelLibrary.models.forEach(m => {
      if (m.category) {
        cats.add(m.category);
        counts[m.category] = (counts[m.category] || 0) + 1;
      } else {
        withoutCategory++;
      }
      if (m.favorite) favorites++;
    });

    return {
      categories: Array.from(cats).sort(),
      categoryCounts: { counts, withoutCategory, favorites }
    };
  }, [modelLibrary.models]);

  // üé® JSX: RENDERIZA√á√ÉO DO COMPONENTE

  return (
    <>
      <GlobalHoverStyles />
      <ThemeStyles />
      <div className="min-h-screen theme-gradient-app theme-text-primary">
      <div className="container mx-auto p-6 max-w-7xl">
        <div className="theme-bg-primary rounded-lg shadow-2xl border theme-border-secondary" style={{ backgroundColor: 'var(--bg-primary)', opacity: 0.95 }}>
          <div className={CSS.modalHeader}>
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent">
                  SENTENCIFY.AI
                </h1>

                {/* Campo de N√∫mero do Processo (v1.3.5.1) */}
                <div className="mt-2 mb-1">
                  <input
                    type="text"
                    value={processoNumero}
                    onChange={(e) => setProcessoNumero(e.target.value)}
                    placeholder="N¬∫ do Processo (ex: ATOrd 0000313-98.2025.5.08.0110)"
                    className="w-full max-w-md px-3 py-1.5 rounded text-sm font-mono theme-bg-secondary border theme-border-primary theme-text-secondary theme-placeholder focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all theme-hover-bg"
                    style={{ transition: 'all 0.2s ease' }}
                  />
                </div>

                <p className="theme-text-muted mt-1">Ferramenta integrada com IA para aux√≠lio na minuta de senten√ßas trabalhistas</p>
              </div>
              <div className="text-right">
                <div className="flex items-center justify-end gap-2 mb-2">
                  <p className="text-xs theme-text-disabled">
                    <button onClick={() => setShowChangelogModal(true)} className="hover:text-blue-400 transition-colors cursor-pointer" title="Ver hist√≥rico de altera√ß√µes">
                      Vers√£o {APP_VERSION}
                    </button>
                    {' '}- <span className="text-amber-500 font-semibold">PROT√ìTIPO</span> (n√£o utilizar com processos reais)
                  </p>
                </div>
                <p className="text-xs theme-text-muted mt-1">Made by <span className="text-blue-400">Rodrigo Nohlack Corr√™a Cesar</span></p>
                <p className="text-xs theme-text-disabled">Juiz do Trabalho no TRT8</p>

                <div className="mt-2 flex gap-2 justify-end flex-wrap">
                  {/* üìñ v1.32.11: Bot√£o Manual do Usu√°rio */}
                  <button
                    onClick={() => window.open('/MANUAL_USUARIO_AVANCADO.html', '_blank')}
                    className="px-2 py-1 rounded text-base flex items-center justify-center theme-btn-secondary transition-colors duration-200"
                    title="Manual do Usu√°rio Avan√ßado"
                  >
                    üìñ
                  </button>
                  {/* üé® v1.9.13: Toggle Tema Claro/Escuro */}
                  <button
                    onClick={toggleAppTheme}
                    className="px-2 py-1 rounded text-base flex items-center justify-center theme-btn-secondary transition-colors duration-200"
                    title={appTheme === 'dark' ? 'Mudar para Tema Claro' : 'Mudar para Tema Escuro'}
                  >
                    {appTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
                  </button>
                  <button
                    onClick={() => openModal('settings')}
                    className="px-3 py-1 rounded text-xs flex items-center gap-1 theme-btn-secondary transition-colors duration-200"
                  >
                    ‚öôÔ∏è Configura√ß√µes IA
                  </button>
                  {/* ‚òÅÔ∏è v1.35.40: Google Drive */}
                  <GoogleDriveButton
                    isConnected={googleDrive.isConnected}
                    isLoading={googleDrive.isLoading}
                    userEmail={googleDrive.userEmail}
                    userPhoto={googleDrive.userPhoto}
                    onConnect={googleDrive.connect}
                    onDisconnect={googleDrive.disconnect}
                    onSave={async () => {
                      try {
                        const allStatesWithAI = {
                          processoNumero,
                          pastedPeticaoTexts,
                          pastedContestacaoTexts,
                          pastedComplementaryTexts,
                          extractedTopics,
                          selectedTopics,
                          partesProcesso,
                          activeTab,
                          analyzedDocuments,
                          proofFiles: proofManager.proofFiles,
                          proofTexts: proofManager.proofTexts,
                          proofUsePdfMode: proofManager.proofUsePdfMode,
                          extractedProofTexts: proofManager.extractedProofTexts,
                          proofExtractionFailed: proofManager.proofExtractionFailed,
                          proofTopicLinks: proofManager.proofTopicLinks,
                          proofAnalysisResults: proofManager.proofAnalysisResults,
                          proofConclusions: proofManager.proofConclusions,
                          aiSettings: aiIntegration.aiSettings,
                          peticaoFiles,
                          contestacaoFiles,
                          complementaryFiles,
                          extractedTexts,
                          documentProcessingModes,
                          tokenMetrics: aiIntegration.tokenMetrics
                        };
                        // Converter PDFs para base64 para salvar no Drive
                        const projectJson = await storage.buildProjectJson(allStatesWithAI);
                        const fileName = `sentencify-${processoNumero || 'projeto'}-${new Date().toISOString().split('T')[0]}.json`;
                        await googleDrive.saveFile(fileName, projectJson);
                        setError({ type: 'success', message: `Projeto salvo no Google Drive: ${fileName}` });
                      } catch (err) {
                        setError({ type: 'error', message: `Erro ao salvar no Drive: ${err.message}` });
                      }
                    }}
                    onLoadClick={async () => {
                      try {
                        const files = await googleDrive.listFiles();
                        setDriveFiles(files);
                        setDriveFilesModalOpen(true);
                      } catch (err) {
                        setError({ type: 'error', message: `Erro ao listar arquivos: ${err.message}` });
                      }
                    }}
                    // v1.35.51: Props para salvar/carregar local (consolidado no dropdown)
                    onSaveLocal={() => {
                      const allStatesWithAI = {
                        processoNumero,
                        pastedPeticaoTexts,
                        pastedContestacaoTexts,
                        pastedComplementaryTexts,
                        extractedTopics,
                        selectedTopics,
                        partesProcesso,
                        activeTab,
                        analyzedDocuments,
                        proofFiles: proofManager.proofFiles,
                        proofTexts: proofManager.proofTexts,
                        proofUsePdfMode: proofManager.proofUsePdfMode,
                        extractedProofTexts: proofManager.extractedProofTexts,
                        proofExtractionFailed: proofManager.proofExtractionFailed,
                        proofTopicLinks: proofManager.proofTopicLinks,
                        proofAnalysisResults: proofManager.proofAnalysisResults,
                        proofConclusions: proofManager.proofConclusions,
                        aiSettings: aiIntegration.aiSettings,
                        peticaoFiles,
                        contestacaoFiles,
                        complementaryFiles,
                        extractedTexts,
                        documentProcessingModes,
                        tokenMetrics: aiIntegration.tokenMetrics
                      };
                      storage.exportProject(allStatesWithAI, setError);
                    }}
                    onLoadLocal={(e) => {
                      const callbacks = {
                        setPastedPeticaoTexts,
                        setPastedContestacaoTexts,
                        setPastedComplementaryTexts,
                        setExtractedTopics,
                        setSelectedTopics,
                        setPartesProcesso,
                        setAnalyzedDocuments,
                        setProofFiles: proofManager.setProofFiles,
                        setProofTexts: proofManager.setProofTexts,
                        setProofUsePdfMode: proofManager.setProofUsePdfMode,
                        setExtractedProofTexts: proofManager.setExtractedProofTexts,
                        setProofExtractionFailed: proofManager.setProofExtractionFailed,
                        setProofTopicLinks: proofManager.setProofTopicLinks,
                        setProofAnalysisResults: proofManager.setProofAnalysisResults,
                        setProofConclusions: proofManager.setProofConclusions,
                        setProofSendFullContent: proofManager.setProofSendFullContent,
                        setActiveTab,
                        setAiSettings: aiIntegration.setAiSettings,
                        setError,
                        setProcessoNumero,
                        setPeticaoFiles,
                        setContestacaoFiles,
                        setComplementaryFiles,
                        setExtractedTexts,
                        setDocumentProcessingModes,
                        setTokenMetrics: aiIntegration.setTokenMetrics
                      };

                      const autoSaveFn = (allStates, setError) => {
                        storage.autoSaveSession(allStates, setError, true);
                      };

                      storage.importProject(e, callbacks, autoSaveFn);
                    }}
                    // v1.35.52: Limpar projeto consolidado no dropdown
                    onClear={() => openModal('clearProject')}
                    isDarkMode={appTheme === 'dark'}
                  />
                  {/* üîÑ v1.35.57: Bot√£o Sair na mesma linha */}
                  {cloudSync?.isAuthenticated && onLogout && (
                    <button
                      onClick={() => openModal('logout')}
                      className="px-3 py-1 rounded text-xs flex items-center gap-1 bg-red-600/20 hover:bg-red-600/40 text-red-400 border border-red-500/30 transition-colors duration-200"
                      title="Sair do sistema"
                    >
                      <LogOut className="w-3 h-3" />
                      Sair
                    </button>
                  )}
                </div>
              </div>
            </div>
            
            {/* Aviso sobre responsabilidade */}
            <div className="mt-4 p-3 theme-bg-amber-accent border border-amber-500/30 rounded-lg">
              <div className="flex items-start gap-2">
                <span className="theme-text-amber text-lg flex-shrink-0">‚ö†Ô∏è</span>
                <div className="text-xs theme-text-amber-muted">
                  <span className="font-semibold">Aviso Importante:</span> Esta ferramenta utiliza Intelig√™ncia Artificial para auxiliar na reda√ß√£o de senten√ßas.
                  A IA pode cometer erros, omitir informa√ß√µes relevantes ou gerar conte√∫do impreciso.
                  <span className="block mt-1 font-semibold theme-text-amber">√â responsabilidade do usu√°rio revisar, verificar e validar todas as informa√ß√µes geradas antes de utiliz√°-las.</span>
                  <span className="block mt-1 theme-text-amber-muted">Sua revis√£o √© fundamental, na forma estabelecida pela <span className="font-semibold">Resolu√ß√£o 615/2025 do CNJ</span>.</span>
                </div>
              </div>
            </div>
          </div>

          {error && (
            <div className={`mx-6 mt-4 p-4 rounded-lg flex items-start gap-3 ${
              typeof error === 'object' && error.type === 'success'
                ? 'bg-green-500/10 border border-green-500/50'
                : 'bg-red-500/10 border border-red-500/50'
            }`}>
              <AlertCircle className={`w-5 h-5 flex-shrink-0 mt-0.5 ${
                typeof error === 'object' && error.type === 'success' ? 'text-green-400' : 'text-red-400'
              }`} />
              <p className="theme-text-primary flex-1">
                {typeof error === 'object' ? error.message : error}
              </p>
              <button onClick={() => setError('')} className={`p-1 rounded transition-colors error-close-btn ${
                typeof error === 'object' && error.type === 'success' ? 'text-green-400' : 'text-red-400'
              }`}>
                <X className="w-4 h-4" />
              </button>
            </div>
          )}

          <div className="border-b theme-border-secondary">
            {/* v1.20.5: Flex-wrap para quebrar linha em telas estreitas */}
            <div className="flex flex-wrap gap-2 p-2">
              {[
                { id: 'upload', label: 'Upload & An√°lise', icon: Upload },
                { id: 'topics', label: 'T√≥picos', icon: FileText },
                { id: 'proofs', label: 'Provas', icon: Scale },
                { id: 'jurisprudencia', label: 'Jurisprud√™ncia', icon: BookOpen },
                { id: 'legislacao', label: 'Legisla√ß√£o', icon: Book },
                { id: 'editor', label: 'Editor', icon: FileText },
                { id: 'models', label: 'Modelos', icon: Save }
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${
                    activeTab === tab.id
                      ? 'bg-blue-600 text-white shadow-lg hover-blue-700-from-600'
                      : 'theme-text-tertiary hover-tab-inactive'
                  }`}
                >
                  <tab.icon className="w-4 h-4" />
                  {tab.label}
                </button>
              ))}
            </div>
          </div>

          <div className="p-6">
            {activeTab === 'upload' && (
              <div className="space-y-6">
                <div className="space-y-6">
                  <div className="space-y-3">
                    <label className="block text-sm font-medium theme-text-tertiary">
                      Peti√ß√£o Inicial / Emendas √† Peti√ß√£o * (m√∫ltiplos)
                    </label>
                    <div
                      style={{ borderColor: '#475569', transition: 'border-color 0.3s ease' }}
                      className="border-2 border-dashed rounded-lg p-8 text-center hover-border-blue-500"
                    >
                      <input
                        type="file"
                        accept=".pdf"
                        multiple
                        onChange={async (e) => {
                          const files = Array.from(e.target.files);
                          if (files.length === 0) return;

                          handleUploadPeticao(files);

                          const defaultMode = getDefaultProcessingMode();
                          setDocumentProcessingModes(prev => ({
                            ...prev,
                            peticoes: [...(prev.peticoes || []), ...files.map(() => defaultMode)]
                          }));

                          if (!processoNumero) {
                            try {
                              const numeroDetectado = await documentServices.autoDetectProcessoNumero({
                                peticao: files[0],
                                contestacoes: contestacaoFiles,
                                complementares: complementaryFiles
                              });
                              if (numeroDetectado) {
                                setProcessoNumero(numeroDetectado);
                              }
                            } catch (err) { }
                          }
                        }}
                        className="hidden"
                        id="peticao"
                      />
                      <label htmlFor="peticao" className="cursor-pointer">
                        <Upload className="w-12 h-12 mx-auto mb-3 theme-text-muted" />
                        <p className="theme-text-tertiary font-medium">
                          {peticaoFiles.length > 0 || pastedPeticaoTexts.length > 0 ||
                           analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0
                            ? `${peticaoFiles.length + (pastedPeticaoTexts?.length || 0) + (analyzedDocuments.peticoes?.length || 0) + (analyzedDocuments.peticoesText?.length || 0)} documento(s) carregado(s)`
                            : 'Clique para fazer upload (m√∫ltiplos)'}
                        </p>
                        <p className="theme-text-disabled text-sm mt-1">
                          PDFs at√© 10MB cada | Peti√ß√£o Inicial + Emendas
                        </p>
                      </label>
                    </div>

                    {/* Lista de arquivos de peti√ß√£o */}
                    {(peticaoFiles.length > 0 || pastedPeticaoTexts.length > 0 ||
                      analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0) && (
                      <div className="theme-bg-secondary-30 rounded-lg p-3 space-y-2">
                        <p className="text-xs theme-text-muted font-medium mb-2">Documentos do Autor:</p>

                        {/* Arquivos PDF novos */}
                        {peticaoFiles.map((fileObj, idx) => (
                          <div key={`peticao-file-${fileObj.id || idx}`} className="flex items-center justify-between text-sm bg-blue-900/20 p-2 rounded">
                            <span className="theme-text-tertiary truncate flex-1 flex items-center gap-2">
                              <FileText className="w-3 h-3 text-blue-400 flex-shrink-0" />
                              {idx + 1}. {idx === 0 ? 'Peti√ß√£o Inicial' : (fileObj.file?.name || fileObj.name)}
                            </span>
                            <ProcessingModeSelector
                              value={documentProcessingModes.peticoes?.[idx] || 'pdfjs'}
                              onChange={(mode) => setPeticaoMode(idx, mode)}
                              anonymizationEnabled={aiIntegration.aiSettings?.anonymization?.enabled}
                            />
                            <button
                              onClick={() => removePeticaoFile(idx)}
                              className="ml-2 hover-text-red-400-from-300"
                              title="Remover"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}

                        {/* PDFs importados (j√° processados) */}
                        {peticaoFiles.length === 0 && analyzedDocuments.peticoes?.map((_, idx) => (
                          <div key={`peticao-imported-${idx}`} className="flex items-center justify-between text-sm bg-blue-900/20 p-2 rounded">
                            <span className="theme-text-blue truncate flex-1 flex items-center gap-2">
                              <FileText className="w-3 h-3 text-blue-400 flex-shrink-0" />
                              {idx + 1}. {idx === 0 ? 'Peti√ß√£o Inicial' : `Documento ${idx + 1}`} (PDF importado)
                            </span>
                            <button
                              onClick={() => setAnalyzedDocuments(prev => ({
                                ...prev,
                                peticoes: prev.peticoes.filter((_, i) => i !== idx)
                              }))}
                              className="ml-2 hover-text-red-400-from-300"
                              title="Remover"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}

                        {/* Textos colados - v1.21.16: clic√°vel para preview */}
                        {pastedPeticaoTexts.map((doc, idx) => (
                          <div key={`peticao-pasted-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 p-2 rounded">
                            <span
                              className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                              onClick={() => setTextPreview({ isOpen: true, title: doc.name, text: doc.text })}
                            >
                              <FileText className="w-3 h-3 text-green-400 flex-shrink-0" />
                              {doc.name} ({doc.text.length.toLocaleString()} caracteres)
                            </span>
                            <button
                              onClick={() => removePastedText('peticao', idx)}
                              className="ml-2 hover-text-red-400-from-300"
                              title="Remover"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}

                        {/* Textos extra√≠dos/importados - v1.21.16: clic√°vel para preview */}
                        {analyzedDocuments.peticoesText?.map((doc, idx) => (
                          <div key={`peticao-text-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 p-2 rounded">
                            <span
                              className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                              onClick={() => setTextPreview({ isOpen: true, title: doc.name, text: doc.text })}
                            >
                              <FileText className="w-3 h-3 text-green-400 flex-shrink-0" />
                              {doc.name} (Texto - {doc.text.length.toLocaleString()} caracteres)
                            </span>
                            <button
                              onClick={() => setAnalyzedDocuments(prev => ({
                                ...prev,
                                peticoesText: prev.peticoesText.filter((_, i) => i !== idx)
                              }))}
                              className="ml-2 hover-text-red-400-from-300"
                              title="Remover"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                      </div>
                    )}

                    {/* Op√ß√£o de colar texto */}
                    <div className="text-center">
                      <p className="theme-text-disabled text-xs mb-2">‚Äî OU ‚Äî</p>
                      {!showPasteArea.peticao ? (
                        <button
                          onClick={() => setShowPasteArea({ ...showPasteArea, peticao: true })}
                          className="text-sm flex items-center gap-2 mx-auto hover-text-blue-400-from-300"
                        >
                          <FileText className="w-4 h-4" />
                          Colar texto (Ctrl+V)
                        </button>
                      ) : (
                        <div className="theme-bg-secondary-30 rounded-lg p-4">
                          <p className="text-xs theme-text-muted mb-2">Cole o texto da peti√ß√£o/emenda abaixo:</p>
                          <textarea
                            className="w-full h-32 theme-bg-primary border theme-border-input rounded p-2 text-sm theme-text-secondary resize-none focus:border-blue-500 focus:outline-none"
                            placeholder="Cole o texto aqui (Ctrl+V)..."
                            onPaste={(e) => {
                              const text = e.clipboardData.getData('text');
                              handlePastedText(text, 'peticao');
                            }}
                            onKeyDown={(e) => {
                              if (e.ctrlKey && e.key === 'Enter') {
                                const text = e.target.value;
                                handlePastedText(text, 'peticao');
                              }
                            }}
                          />
                          <div className="flex gap-2 mt-2">
                            <button
                              onClick={(e) => {
                                const textarea = e.target.closest('.theme-bg-secondary-30').querySelector('textarea');
                                handlePastedText(textarea.value, 'peticao');
                              }}
                              className="hover-blue-700 flex-1 py-2 rounded text-sm bg-blue-600 text-white"
                            >
                              Confirmar
                            </button>
                            <button
                              onClick={() => setShowPasteArea({ ...showPasteArea, peticao: false })}
                              className="px-4 py-2 rounded text-sm theme-bg-tertiary hover-slate-700-from-600"
                            >
                              Cancelar
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="space-y-3">
                    <label className="block text-sm font-medium theme-text-tertiary">
                      Contesta√ß√µes (Opcional - m√∫ltiplas)
                    </label>
                    <div
                      style={{ borderColor: '#475569', transition: 'border-color 0.3s ease' }}
                      className="border-2 border-dashed rounded-lg p-8 text-center hover-border-blue-500"
                    >
                      <input
                        type="file"
                        accept=".pdf"
                        multiple
                        onChange={async (e) => {
                          const files = Array.from(e.target.files);
                          if (files.length === 0) return;

                          // v1.13.7: Usar handleUploadContestacao para salvar no IndexedDB
                          handleUploadContestacao(files);

                          // v1.12.18: Definir modos de processamento padr√£o para contesta√ß√µes
                          const defaultMode = getDefaultProcessingMode();
                          setDocumentProcessingModes(prev => ({
                            ...prev,
                            contestacoes: files.map(() => defaultMode)
                          }));

                          if (!processoNumero) {
                            try {
                              const numeroDetectado = await documentServices.autoDetectProcessoNumero({
                                peticao: peticaoFiles[0]?.file || peticaoFiles[0],
                                contestacoes: files,
                                complementares: complementaryFiles.map(f => f.file || f)
                              });

                              if (numeroDetectado) {
                                setProcessoNumero(numeroDetectado);
                              }
                            } catch (err) {
                              // Silencioso - n√£o bloqueia upload se falhar
                            }
                          }
                        }}
                        className="hidden"
                        id="contestacao"
                      />
                      <label htmlFor="contestacao" className="cursor-pointer">
                        <Upload className="w-12 h-12 mx-auto mb-3 theme-text-muted" />
                        <p className="theme-text-tertiary font-medium">
                          {contestacaoFiles.length > 0
                            ? `${contestacaoFiles.length} arquivo${contestacaoFiles.length > 1 ? 's' : ''} selecionado${contestacaoFiles.length > 1 ? 's' : ''}`
                            : (analyzedDocuments.contestacoes?.length > 0 || pastedContestacaoTexts.length > 0)
                            ? `‚úì ${(analyzedDocuments.contestacoes?.length || 0) + pastedContestacaoTexts.length} importado${((analyzedDocuments.contestacoes?.length || 0) + pastedContestacaoTexts.length) > 1 ? 's' : ''}`
                            : 'Clique para fazer upload'}
                        </p>
                        <p className="theme-text-disabled text-sm mt-1">M√∫ltiplos PDFs at√© 10MB cada</p>
                      </label>
                    </div>
                    
                    {/* Op√ß√£o de colar texto */}
                    <div className="text-center mt-3">
                      <p className="theme-text-disabled text-xs mb-2">‚Äî OU ‚Äî</p>
                      {!showPasteArea.contestacao ? (
                        <button
                          onClick={() => setShowPasteArea({ ...showPasteArea, contestacao: true })}
                          className="text-sm flex items-center gap-2 mx-auto hover-text-blue-400-from-300"
                        >
                          <FileText className="w-4 h-4" />
                          Colar texto de contesta√ß√£o (Ctrl+V)
                        </button>
                      ) : (
                        <div className="theme-bg-secondary-30 rounded-lg p-4">
                          <p className="text-xs theme-text-muted mb-2">Cole o texto da contesta√ß√£o abaixo:</p>
                          <textarea
                            className="w-full h-32 theme-bg-primary border theme-border-input rounded p-2 text-sm theme-text-secondary resize-none focus:border-blue-500 focus:outline-none"
                            placeholder="Cole o texto aqui (Ctrl+V)..."
                            onPaste={(e) => {
                              const text = e.clipboardData.getData('text');
                              handlePastedText(text, 'contestacao');
                            }}
                            onKeyDown={(e) => {
                              if (e.ctrlKey && e.key === 'Enter') {
                                const text = e.target.value;
                                handlePastedText(text, 'contestacao');
                              }
                            }}
                          />
                          <div className="flex gap-2 mt-2">
                            <button
                              onClick={(e) => {
                                const textarea = e.target.closest('.theme-bg-secondary\\/30').querySelector('textarea');
                                handlePastedText(textarea.value, 'contestacao');
                              }}
                              className="hover-blue-700 flex-1 py-2 rounded text-sm bg-blue-600 text-white"
                            >
                              Confirmar
                            </button>
                            <button
                              onClick={() => setShowPasteArea({ ...showPasteArea, contestacao: false })}
                              className="px-4 py-2 rounded text-sm theme-bg-tertiary hover-slate-700-from-600"
                            >
                              Cancelar
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    {(contestacaoFiles.length > 0 || pastedContestacaoTexts.length > 0 || analyzedDocuments.contestacoes?.length > 0 || analyzedDocuments.contestacoesText?.length > 0) && (
                      <div className="theme-bg-secondary-30 rounded-lg p-3 space-y-2 mt-3">
                        <p className="text-xs theme-text-muted font-medium">Contesta√ß√µes:</p>
                        {/* v1.12.16: Contesta√ß√µes com indicador de status - respeita config */}
                        {contestacaoFiles.map((fileObj, idx) => (
                          <div key={`file-${fileObj.id || idx}`} className="flex items-center justify-between text-sm theme-bg-primary-50 p-2 rounded">
                            <span className="theme-text-tertiary truncate flex-1 flex items-center gap-2">
                              <FileText className="w-3 h-3 text-blue-400" />
                              {idx + 1}. {fileObj.file?.name || fileObj.name}
                            </span>
                            {/* v1.14.1: Seletor sempre vis√≠vel */}
                            <ProcessingModeSelector
                              value={documentProcessingModes.contestacoes?.[idx] || 'pdfjs'}
                              onChange={(mode) => setContestacaoMode(idx, mode)}
                              className="mx-2"
                              anonymizationEnabled={aiIntegration.aiSettings?.anonymization?.enabled}
                            />
                            <button
                              onClick={async () => {
                                const fileToRemove = contestacaoFiles[idx];
                                if (fileToRemove?.id) {
                                  try { await removePdfFromIndexedDB(`upload-contestacao-${fileToRemove.id}`); } catch {}
                                }
                                setContestacaoFiles(prev => prev.filter((_, i) => i !== idx));
                                setDocumentProcessingModes(prev => ({
                                  ...prev,
                                  contestacoes: (prev.contestacoes || []).filter((_, i) => i !== idx)
                                }));
                              }}
                              className="text-red-400 hover-text-red-300"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                        {/* v1.12.17: S√≥ mostra PDFs importados se n√£o houver contestacaoFiles (evita duplica√ß√£o) */}
                        {contestacaoFiles.length === 0 && analyzedDocuments.contestacoes?.map((_, idx) => (
                          <div key={`imported-pdf-${idx}`} className="flex items-center justify-between text-sm bg-blue-900/20 p-2 rounded border border-blue-500/30">
                            <span className="theme-text-blue truncate flex-1 flex items-center gap-2">
                              <FileText className="w-3 h-3 text-blue-400" />
                              {idx + 1}. Contesta√ß√£o {idx + 1} (PDF importado)
                            </span>
                            <button
                              onClick={() => {
                                const newDocs = { ...analyzedDocuments };
                                newDocs.contestacoes = newDocs.contestacoes.filter((_, i) => i !== idx);
                                setAnalyzedDocuments(newDocs);
                              }}
                              className="ml-2 text-red-400 hover-text-red-300"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                        {pastedContestacaoTexts.map((contestacao, idx) => (
                          <div key={`text-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 p-2 rounded border border-green-500/30">
                            <span
                              className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                              onClick={() => setTextPreview({ isOpen: true, title: contestacao.name, text: contestacao.text })}
                            >
                              <FileText className="w-3 h-3 text-green-400" />
                              {contestacaoFiles.length + (analyzedDocuments.contestacoes?.length || 0) + idx + 1}. {contestacao.name} (Texto - {contestacao.text.length.toLocaleString()} caracteres)
                            </span>
                            <button
                              onClick={() => removePastedText('contestacao', idx)}
                              className="ml-2 text-red-400 hover-text-red-300"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                        {analyzedDocuments.contestacoesText?.map((doc, idx) => (
                          <div key={`imported-text-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 p-2 rounded border border-green-500/30">
                            <span
                              className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                              onClick={() => setTextPreview({ isOpen: true, title: doc.name, text: doc.text })}
                            >
                              <FileText className="w-3 h-3 text-green-400" />
                              {contestacaoFiles.length + (analyzedDocuments.contestacoes?.length || 0) + pastedContestacaoTexts.length + idx + 1}. {doc.name} (Texto importado - {doc.text.length.toLocaleString()} caracteres)
                            </span>
                            <button
                              onClick={() => {
                                const newDocs = { ...analyzedDocuments };
                                newDocs.contestacoesText = newDocs.contestacoesText.filter((_, i) => i !== idx);
                                setAnalyzedDocuments(newDocs);
                              }}
                              className="ml-2 text-red-400 hover-text-red-300"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>

                {/* Se√ß√£o de Documentos Complementares */}
                <div className="border-t theme-border-secondary pt-6">
                  <div className="mb-4">
                    <h3 className="text-lg font-semibold theme-text-secondary mb-1">
                      üìé Documentos Complementares (Opcional)
                    </h3>
                    <p className={CSS.textMuted}>
                      Atas de audi√™ncia, transcri√ß√µes, impugna√ß√µes, provas, etc. Estes documentos N√ÉO s√£o usados nos mini-relat√≥rios autom√°ticos, mas podem ser consultados pela IA quando voc√™ solicitar durante a reda√ß√£o.
                    </p>
                  </div>
                  
                  <div
                    style={{ borderColor: '#475569', transition: 'border-color 0.3s ease' }}
                    className="border-2 border-dashed rounded-lg p-6 text-center hover-border-purple-500"
                  >
                    <input
                      type="file"
                      accept=".pdf"
                      multiple
                      onChange={async (e) => {
                        const files = Array.from(e.target.files);
                        if (files.length === 0) return;

                        // v1.13.7: Usar handleUploadComplementary para salvar no IndexedDB
                        handleUploadComplementary(files);

                        // v1.12.18: Definir modos de processamento padr√£o para complementares
                        const defaultMode = getDefaultProcessingMode();
                        setDocumentProcessingModes(prev => ({
                          ...prev,
                          complementares: files.map(() => defaultMode)
                        }));

                        if (!processoNumero) {
                          try {
                            const numeroDetectado = await documentServices.autoDetectProcessoNumero({
                              peticao: peticaoFiles[0]?.file || peticaoFiles[0],
                              contestacoes: contestacaoFiles.map(f => f.file || f),
                              complementares: files
                            });

                            if (numeroDetectado) {
                              setProcessoNumero(numeroDetectado);
                            }
                          } catch (err) {
                            // Silencioso - n√£o bloqueia upload se falhar
                          }
                        }
                      }}
                      className="hidden"
                      id="complementary"
                    />
                    <label htmlFor="complementary" className="cursor-pointer">
                      <Upload className="w-10 h-10 mx-auto mb-2 theme-text-muted" />
                      <p className="theme-text-tertiary font-medium">
                        {complementaryFiles.length > 0
                          ? `${complementaryFiles.length} documento${complementaryFiles.length > 1 ? 's' : ''} complementar${complementaryFiles.length > 1 ? 'es' : ''}`
                          : (analyzedDocuments.complementares?.length > 0 || pastedComplementaryTexts.length > 0)
                          ? `‚úì ${(analyzedDocuments.complementares?.length || 0) + pastedComplementaryTexts.length} importado${((analyzedDocuments.complementares?.length || 0) + pastedComplementaryTexts.length) > 1 ? 's' : ''}`
                          : 'Clique para adicionar documentos complementares'}
                      </p>
                      <p className="theme-text-disabled text-sm mt-1">M√∫ltiplos PDFs at√© 10MB cada</p>
                    </label>
                  </div>
                  
                  {/* Op√ß√£o de colar texto */}
                  <div className="text-center mt-3">
                    <p className="theme-text-disabled text-xs mb-2">‚Äî OU ‚Äî</p>
                    {!showPasteArea.complementary ? (
                      <button
                        onClick={() => setShowPasteArea({ ...showPasteArea, complementary: true })}
                        className="text-sm flex items-center gap-2 mx-auto hover-text-purple-400-from-400"
                      >
                        <FileText className="w-4 h-4" />
                        Colar texto de documento complementar (Ctrl+V)
                      </button>
                    ) : (
                      <div className="theme-bg-secondary-30 rounded-lg p-4">
                        <p className="text-xs theme-text-muted mb-2">Cole o texto do documento complementar abaixo:</p>
                        <textarea
                          className="w-full h-32 theme-bg-primary border theme-border-input rounded p-2 text-sm theme-text-secondary resize-none focus:border-purple-500 focus:outline-none"
                          placeholder="Cole o texto aqui (Ctrl+V)..."
                          onPaste={(e) => {
                            const text = e.clipboardData.getData('text');
                            handlePastedText(text, 'complementary');
                          }}
                          onKeyDown={(e) => {
                            if (e.ctrlKey && e.key === 'Enter') {
                              const text = e.target.value;
                              handlePastedText(text, 'complementary');
                            }
                          }}
                        />
                        <div className="flex gap-2 mt-2">
                          <button
                            onClick={(e) => {
                              const textarea = e.target.closest('.theme-bg-secondary\\/30').querySelector('textarea');
                              handlePastedText(textarea.value, 'complementary');
                            }}
                            className="hover-purple-700 flex-1 py-2 rounded text-sm bg-purple-600 text-white"
                          >
                            Confirmar
                          </button>
                          <button
                            onClick={() => setShowPasteArea({ ...showPasteArea, complementary: false })}
                            className="px-4 py-2 theme-bg-tertiary rounded hover-slate-700 text-sm"
                          >
                            Cancelar
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  {(complementaryFiles.length > 0 || pastedComplementaryTexts.length > 0 || analyzedDocuments.complementares?.length > 0 || analyzedDocuments.complementaresText?.length > 0) && (
                    <div className="mt-3 bg-purple-900/20 border border-purple-500/30 rounded-lg p-4 space-y-2">
                      <p className="text-xs theme-text-purple font-medium flex items-center gap-2">
                        <FileText className="w-4 h-4" />
                        Documentos complementares anexados:
                      </p>
                      {/* v1.12.18: Complementares com seletor de modo de processamento */}
                      {complementaryFiles.map((fileObj, idx) => (
                        <div key={`file-${fileObj.id || idx}`} className="flex items-center justify-between text-sm theme-bg-primary-50 rounded p-2">
                          <span className="theme-text-tertiary truncate flex-1 flex items-center gap-2">
                            <FileText className="w-3 h-3 text-purple-400" />
                            {idx + 1}. {fileObj.file?.name || fileObj.name}
                          </span>
                          {/* v1.14.1: Seletor sempre vis√≠vel */}
                          <ProcessingModeSelector
                            value={documentProcessingModes.complementares?.[idx] || 'pdfjs'}
                            onChange={(mode) => setComplementarMode(idx, mode)}
                            className="mx-2"
                            anonymizationEnabled={aiIntegration.aiSettings?.anonymization?.enabled}
                          />
                          <button
                            onClick={async () => {
                              const fileToRemove = complementaryFiles[idx];
                              if (fileToRemove?.id) {
                                try { await removePdfFromIndexedDB(`upload-complementar-${fileToRemove.id}`); } catch {}
                              }
                              setComplementaryFiles(prev => prev.filter((_, i) => i !== idx));
                              setDocumentProcessingModes(prev => ({
                                ...prev,
                                complementares: (prev.complementares || []).filter((_, i) => i !== idx)
                              }));
                            }}
                            className="hover-text-red-400-from-300"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                      {/* v1.12.17: S√≥ mostra PDFs importados se n√£o houver complementaryFiles (evita duplica√ß√£o) */}
                      {complementaryFiles.length === 0 && analyzedDocuments.complementares?.map((_, idx) => (
                        <div key={`imported-pdf-${idx}`} className="flex items-center justify-between text-sm bg-purple-900/20 rounded p-2 border border-purple-500/30">
                          <span className="theme-text-purple truncate flex-1 flex items-center gap-2">
                            <FileText className="w-3 h-3 text-purple-400" />
                            {idx + 1}. Documento complementar {idx + 1} (PDF importado)
                          </span>
                          <button
                            onClick={() => {
                              const newDocs = { ...analyzedDocuments };
                              newDocs.complementares = newDocs.complementares.filter((_, i) => i !== idx);
                              setAnalyzedDocuments(newDocs);
                            }}
                            className="ml-2 hover-text-red-400-from-300"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                      {pastedComplementaryTexts.map((doc, idx) => (
                        <div key={`text-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 rounded p-2 border border-green-500/30">
                          <span
                            className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                            onClick={() => setTextPreview({ isOpen: true, title: doc.name, text: doc.text })}
                          >
                            <FileText className="w-3 h-3 text-green-400" />
                            {complementaryFiles.length + (analyzedDocuments.complementares?.length || 0) + idx + 1}. {doc.name} (Texto - {doc.text.length.toLocaleString()} caracteres)
                          </span>
                          <button
                            onClick={() => removePastedText('complementary', idx)}
                            className="ml-2 hover-text-red-400-from-300"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                      {analyzedDocuments.complementaresText?.map((doc, idx) => (
                        <div key={`imported-text-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 rounded p-2 border border-green-500/30">
                          <span
                            className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                            onClick={() => setTextPreview({ isOpen: true, title: doc.name, text: doc.text })}
                          >
                            <FileText className="w-3 h-3 text-green-400" />
                            {complementaryFiles.length + (analyzedDocuments.complementares?.length || 0) + pastedComplementaryTexts.length + idx + 1}. {doc.name} (Texto importado - {doc.text.length.toLocaleString()} caracteres)
                          </span>
                          <button
                            onClick={() => {
                              const newDocs = { ...analyzedDocuments };
                              newDocs.complementaresText = newDocs.complementaresText.filter((_, i) => i !== idx);
                              setAnalyzedDocuments(newDocs);
                            }}
                            className="ml-2 hover-text-red-400-from-300"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <button
                  onClick={handleAnalyzeDocuments}
                  disabled={analyzing || (peticaoFiles.length === 0 && pastedPeticaoTexts.length === 0)}
                  className="w-full py-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg bg-gradient-to-r from-blue-600 to-purple-600 text-white hover-gradient-blue-purple"
                >
                  {analyzing ? 'Analisando documentos...' : 'Analisar Documentos'}
                </button>
              </div>
            )}

            {activeTab === 'topics' && (
              <div className="space-y-6">
                {extractedTopics.length === 0 ? (
                  <div className="text-center py-12 theme-text-muted">
                    <FileText className="w-16 h-16 mx-auto mb-4 opacity-50" />
                    <p>Nenhum t√≥pico extra√≠do ainda. Fa√ßa upload e an√°lise dos documentos.</p>
                  </div>
                ) : (
                  <>
                    <div>
                      <div className="mb-4 space-y-3">
                        {/* Linha 1: T√≠tulo e Bot√µes */}
                        <div className="flex items-start justify-between gap-4">
                          <div>
                            <h3 className="text-xl font-bold text-blue-400">
                              Gerenciar T√≥picos {selectedTopics.length > 0 && `(${selectedTopics.length} selecionados)`}
                            </h3>
                            <p className="text-xs theme-text-muted mt-1 flex items-center gap-2">
                              Clique para selecionar ‚Ä¢ <GripVertical className="w-3 h-3" /> Arraste para reordenar ‚Ä¢ Use setas e n√∫meros
                            </p>
                          </div>
                          <div className="flex gap-2 flex-nowrap overflow-x-auto">
                            {topicsToMerge.length >= 2 && (
                              <button
                                onClick={() => openModal('merge')}
                                disabled={aiIntegration.regenerating}
                                className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm disabled:opacity-50 hover-amber-700-from-600 bg-amber-600 text-white transition-colors duration-300"
                              >
                                <Merge className="w-4 h-4" />
                                Unir {topicsToMerge.length} Selecionados
                              </button>
                            )}
                            <button
                              onClick={() => openModal('newTopic')}
                              className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm hover-green-700-from-600 bg-emerald-600 text-white transition-colors duration-300"
                            >
                              <PlusCircle className="w-4 h-4" />
                              Novo T√≥pico
                            </button>
                            {/* v1.11.0: Bot√£o de Edi√ß√£o Global */}
                            {selectedTopics.length > 0 && (
                              <button
                                onClick={() => openModal('globalEditor')}
                                className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm hover-cyan-700-from-600 bg-cyan-600 text-white transition-colors duration-300"
                              >
                                <Edit className="w-4 h-4" />
                                Edi√ß√£o Global
                              </button>
                            )}
                            {selectedTopics.length > 0 && (
                              <>
                                {/* v1.21.21: Bot√£o Revisar Senten√ßa */}
                                <div className="relative group">
                                  <button
                                    onClick={() => openModal('sentenceReview')}
                                    disabled={!canGenerateDispositivo.enabled || generatingReview}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm text-white transition-all ${
                                      !canGenerateDispositivo.enabled || generatingReview
                                        ? 'opacity-50 cursor-not-allowed'
                                        : 'hover-amber-700-from-600'
                                    }`}
                                    style={{
                                      backgroundColor: canGenerateDispositivo.enabled && !generatingReview ? '#d97706' : '#6b7280',
                                      transition: 'background-color 0.3s ease'
                                    }}
                                  >
                                    {generatingReview ? (
                                      <>
                                        <div className={CSS.spinner}></div>
                                        <span>Revisando...</span>
                                      </>
                                    ) : (
                                      <>
                                        <Scale className="w-4 h-4" />
                                        Revisar Senten√ßa
                                      </>
                                    )}
                                  </button>
                                  {/* Tooltip quando desabilitado */}
                                  {!canGenerateDispositivo.enabled && !generatingReview && (
                                    <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 theme-bg-primary text-white text-xs rounded-lg shadow-lg border border-amber-500/50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 max-w-xs">
                                      <div className="flex items-start gap-2">
                                        <span className="text-xl flex-shrink-0">‚ö†Ô∏è</span>
                                        <span>{canGenerateDispositivo.reason}</span>
                                      </div>
                                      <div className="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-amber-500/50"></div>
                                    </div>
                                  )}
                                </div>
                                {/* v1.5.14: Bot√£o com valida√ß√£o e tooltip */}
                                <div className="relative group">
                                  <button
                                    onClick={generateDispositivo}
                                    disabled={!canGenerateDispositivo.enabled || aiIntegration.generatingDispositivo}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm text-white transition-all ${
                                      !canGenerateDispositivo.enabled || aiIntegration.generatingDispositivo
                                        ? 'opacity-50 cursor-not-allowed'
                                        : 'hover-purple-700-from-600'
                                    }`}
                                    style={{
                                      backgroundColor: canGenerateDispositivo.enabled && !aiIntegration.generatingDispositivo ? '#9333ea' : '#6b7280',
                                      transition: 'background-color 0.3s ease'
                                    }}
                                  >
                                    {aiIntegration.generatingDispositivo ? (
                                      <>
                                        <div className={CSS.spinner}></div>
                                        <span>Gerando...</span>
                                      </>
                                    ) : (
                                      <>
                                        <Sparkles className="w-4 h-4" />
                                        Gerar Dispositivo
                                      </>
                                    )}
                                  </button>

                                  {/* Tooltip explicativo quando desabilitado - v1.5.14: Otimizado para m√∫ltiplos t√≥picos */}
                                  {!canGenerateDispositivo.enabled && !aiIntegration.generatingDispositivo && (
                                    <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 theme-bg-primary text-white text-xs rounded-lg shadow-lg border border-amber-500/50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 max-w-xs">
                                      <div className="flex items-start gap-2">
                                        <span className="text-xl flex-shrink-0">‚ö†Ô∏è</span>
                                        <span>{canGenerateDispositivo.reason}</span>
                                      </div>
                                      <div className="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-amber-500/50"></div>
                                    </div>
                                  )}
                                </div>
                                <button
                                  onClick={exportDecision}
                                  className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm hover-blue-700-from-600 bg-blue-600 text-white transition-colors duration-300"
                                >
                                  <Download className="w-4 h-4" />
                                  Exportar Minuta Completa
                                </button>
                              </>
                            )}
                          </div>
                        </div>
                        
                        {/* Linha 2: Contadores de Status */}
                        <div className="flex items-center gap-3 flex-wrap">
                          <div className="flex items-center gap-2 px-3 py-1.5 theme-bg-green-accent rounded-lg border border-green-500/30">
                            <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                            <span className="text-xs theme-text-green font-medium">
                              {topicsDecididos} Decididos
                            </span>
                          </div>
                          <div className="flex items-center gap-2 px-3 py-1.5 theme-bg-amber-accent rounded-lg border border-amber-500/30">
                            <span className="w-2 h-2 bg-amber-500 rounded-full"></span>
                            <span className="text-xs theme-text-amber font-medium">
                              {topicsPendentes} Pendentes
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* Aviso sobre mini-relat√≥rios gerados por IA */}
                      <div className="mb-4 p-3 theme-bg-blue-accent border border-blue-500/30 rounded-lg">
                        <div className="flex items-start gap-2">
                          <span className="theme-text-blue text-sm">‚ÑπÔ∏è</span>
                          <div className="text-xs theme-text-blue-muted">
                            <p>Os mini-relat√≥rios foram gerados automaticamente por IA. Revise-os e complemente com informa√ß√µes relevantes antes de decidir.</p>
                            <p className="mt-1 theme-text-blue-muted">Sua revis√£o √© fundamental, na forma estabelecida pela <span className="font-semibold">Resolu√ß√£o 615/2025 do CNJ</span>.</p>
                          </div>
                        </div>
                      </div>
                      
                      <div className="space-y-2">
                        {/* v1.33.59: DndContext com collision detection customizado (ignora RELAT√ìRIO/DISPOSITIVO) */}
                        <DndContext
                          sensors={dndSensors}
                          collisionDetection={customCollisionDetection}
                          onDragEnd={handleDndDragEnd}
                        >
                          <SortableContext
                            items={selectedTopics.map(t => t.id || t.title)}
                            strategy={verticalListSortingStrategy}
                          >
                            {/* Renderizar t√≥picos selecionados primeiro (na ordem correta) - v1.33.58: SortableTopicCard */}
                            {selectedTopics.map((topic, selectedIdx) => (
                              <SortableTopicCard
                                key={topic.id || topic.title}
                                id={topic.id || topic.title}
                                topic={topic}
                                selectedIdx={selectedIdx}
                                topicRefs={topicRefs}
                                lastEditedTopicTitle={lastEditedTopicTitle}
                                selectedTopics={selectedTopics}
                                extractedTopics={extractedTopics}
                                topicsToMerge={topicsToMerge}
                                toggleTopicSelection={toggleTopicSelection}
                                moveTopicUp={moveTopicUp}
                                moveTopicDown={moveTopicDown}
                                moveTopicToPosition={moveTopicToPosition}
                                setSelectedTopics={setSelectedTopics}
                                setExtractedTopics={setExtractedTopics}
                                startEditing={startEditing}
                                setTopicToRename={setTopicToRename}
                                setNewTopicName={setNewTopicName}
                                openModal={openModal}
                                setTopicToSplit={setTopicToSplit}
                                setTopicsToMerge={setTopicsToMerge}
                              />
                            ))}
                          </SortableContext>
                        </DndContext>

                        {/* Renderizar t√≥picos N√ÉO selecionados por √∫ltimo */}
                        {/* v1.4.6.2: OPT-01 - Memoizado no corpo do componente (linha 10546) */}
                        {unselectedTopics.map((topic, idx) => {
                            const isRelatorioOrDispositivo = isSpecialTopic(topic);
                            
                            return (
                          <div
                            key={topic.title}
                            className="p-4 rounded-lg border-2 transition-all theme-bg-secondary-30 theme-border-input hover-theme-border hover-slate-700/50"
                          >
                            <div className="flex items-start justify-between gap-4">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2 flex-wrap">
                                  {/* Seletor de categoria - edit√°vel (n√£o mostrar para RELAT√ìRIO e DISPOSITIVO) */}
                                  {!isRelatorioOrDispositivo && (
                                    <select
                                      value={topic.category || 'M√âRITO'}
                                      onChange={(e) => {
                                        e.stopPropagation();
                                        const newExtracted = [...extractedTopics];
                                        const extractedIndex = extractedTopics.findIndex(t => t.title === topic.title);
                                        if (extractedIndex !== -1) {
                                          newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], category: e.target.value };
                                          setExtractedTopics(newExtracted);
                                        }
                                      }}
                                      onClick={(e) => e.stopPropagation()}
                                      className="text-xs px-2 py-1 rounded cursor-pointer font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 border-2 theme-border theme-text-secondary hover-category-select"
                                      title="Clique para alterar a categoria"
                                    >
                                      <option value="PRELIMINAR">üìã Preliminar</option>
                                      <option value="PREJUDICIAL">‚ö†Ô∏è Prejudicial</option>
                                      <option value="M√âRITO">‚öñÔ∏è M√©rito</option>
                                      <option value="PROCESSUAL">üìù Processual</option>
                                    </select>
                                  )}
                                  
                                  <h4 
                                    className="font-semibold theme-text-primary cursor-pointer"
                                    onClick={() => toggleTopicSelection(topic)}
                                  >
                                    {topic.title.toUpperCase()}
                                  </h4>
                                  {/* Indicador de status de decis√£o - n√£o mostrar para RELAT√ìRIO e DISPOSITIVO */}
                                  {topic.title.toUpperCase() !== 'RELAT√ìRIO' && topic.title.toUpperCase() !== 'DISPOSITIVO' && (
                                    isTopicDecidido(topic) ? (
                                      <span className="flex items-center gap-1 text-xs theme-bg-green-accent theme-text-green px-2 py-1 rounded border border-green-500/30">
                                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                        Decidido
                                      </span>
                                    ) : (
                                      <span className="flex items-center gap-1 text-xs theme-bg-amber-accent theme-text-amber px-2 py-1 rounded border border-amber-500/30">
                                        <span className="w-2 h-2 bg-amber-500 rounded-full"></span>
                                        Pendente
                                      </span>
                                    )
                                  )}
                                </div>
                              </div>
                              <div className={CSS.flexGap2}>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    deleteTopic(topic);
                                  }}
                                  className="p-2 rounded hover-delete-topic"
                                  title="Excluir t√≥pico"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                                <div className="flex flex-col items-center gap-1">
                                  <span className="text-xs theme-text-disabled">Clique para selecionar</span>
                                  <input
                                    type="checkbox"
                                    checked={false}
                                    onChange={(e) => {
                                      e.stopPropagation();
                                      toggleTopicSelection(topic);
                                    }}
                                    className="w-5 h-5 rounded cursor-pointer"
                                  />
                                </div>
                              </div>
                            </div>
                          </div>
                          );
                        })}
                      </div>
                    </div>
                  </>
                )}
              </div>
            )}

            {activeTab === 'proofs' && (
              <div className="space-y-6">
                <div className="theme-gradient-card-50 rounded-lg p-6 border theme-border-secondary">
                  <div className="flex items-start justify-between mb-6">
                    <div>
                      <h3 className="text-xl font-bold text-blue-400 mb-2">Gest√£o de Provas</h3>
                      <p className="text-sm theme-text-muted">
                        Fa√ßa upload de documentos probat√≥rios, analise com IA e vincule aos t√≥picos da decis√£o
                      </p>
                    </div>
                    <Scale className="w-8 h-8 text-blue-400 opacity-50" />
                  </div>

                  {/* Se√ß√£o de Upload */}
                  <div className="space-y-4 mb-8">
                    <h4 className="text-lg font-semibold theme-text-secondary flex items-center gap-2">
                      <Upload className="w-5 h-5" />
                      Upload de Provas
                    </h4>

                    {/* Upload de PDF */}
                    <div className="border-2 border-dashed theme-border-input rounded-lg p-6 hover-border-blue-500 transition-colors">
                      <input
                        type="file"
                        accept="application/pdf"
                        multiple
                        onChange={(e) => {
                          const files = Array.from(e.target.files);
                          if (files.length > 0) {
                            proofManager.handleUploadProofPdf(files);
                          }
                          e.target.value = '';
                        }}
                        className="hidden"
                        id="proof-pdf-upload"
                      />
                      <label
                        htmlFor="proof-pdf-upload"
                        className="flex flex-col items-center cursor-pointer"
                      >
                        <Upload className="w-12 h-12 theme-text-muted mb-3" />
                        <p className="theme-text-tertiary font-medium mb-1">Clique para fazer upload de PDFs</p>
                        <p className="text-sm theme-text-disabled">Suporta m√∫ltiplos arquivos PDF</p>
                      </label>
                    </div>

                    {/* √Årea para colar texto */}
                    <div className="space-y-2">
                      <button
                        onClick={() => {
                          proofManager.setNewProofTextData({ name: '', text: '' });
                          openModal('addProofText');
                        }}
                        className="w-full py-3 theme-bg-secondary rounded-lg hover-slate-600 transition-colors flex items-center justify-center gap-2"
                      >
                        <FileText className="w-4 h-4" />
                        Colar Texto como Prova
                      </button>
                    </div>
                  </div>

                  {/* Lista de Provas */}
                  <div className="space-y-4">
                    <h4 className="text-lg font-semibold theme-text-secondary flex items-center gap-2">
                      <FileText className="w-5 h-5" />
                      Provas Enviadas ({proofManager.proofFiles.length + proofManager.proofTexts.length})
                    </h4>

                    {proofManager.proofFiles.length === 0 && proofManager.proofTexts.length === 0 ? (
                      <div className="text-center py-12 theme-text-muted border border-dashed theme-border-input rounded-lg">
                        <Scale className="w-16 h-16 mx-auto mb-4 opacity-30" />
                        <p>Nenhuma prova enviada ainda</p>
                        <p className="text-sm mt-2">Fa√ßa upload de PDFs ou cole textos acima</p>
                      </div>
                    ) : extractedTopics.length === 0 ? (
                      <div className="bg-amber-900/20 border border-amber-500/30 rounded-lg p-4">
                        <p className="text-sm theme-text-amber flex items-start gap-2">
                          <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                          <span>
                            <strong>Aten√ß√£o:</strong> Para vincular provas a t√≥picos, primeiro analise os documentos na aba "Upload & An√°lise".
                          </span>
                        </p>
                      </div>
                    ) : (
                      <div className="space-y-3">
                        {/* üöÄ v1.8.2: Componentizado com ProofCard - PROVAS EM PDF */}
                        {proofManager.proofFiles.map((proof) => (
                          <ProofCard
                            key={proof.id}
                            proof={proof}
                            isPdf={true}
                            proofManager={proofManager}
                            openModal={openModal}
                            setError={setError}
                            extractTextFromPDFWithMode={documentServices.extractTextFromPDFWithMode}
                            anonymizationEnabled={aiIntegration.aiSettings?.anonymization?.enabled}
                            anonConfig={aiIntegration.aiSettings?.anonymization}
                            nomesParaAnonimizar={aiIntegration.aiSettings?.anonymization?.nomesUsuario || []}
                            editorTheme={appTheme}
                            setTextPreview={setTextPreview}
                          />
                        ))}

                        {/* üöÄ v1.8.2: Componentizado com ProofCard - PROVAS EM TEXTO */}
                        {proofManager.proofTexts.map((proof) => (
                          <ProofCard
                            key={proof.id}
                            proof={proof}
                            isPdf={false}
                            proofManager={proofManager}
                            openModal={openModal}
                            setError={setError}
                            extractTextFromPDFWithMode={documentServices.extractTextFromPDFWithMode}
                            anonymizationEnabled={aiIntegration.aiSettings?.anonymization?.enabled}
                            anonConfig={aiIntegration.aiSettings?.anonymization}
                            nomesParaAnonimizar={aiIntegration.aiSettings?.anonymization?.nomesUsuario || []}
                            editorTheme={appTheme}
                            setTextPreview={setTextPreview}
                          />
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'editor' && (
              <div ref={editorContainerRef} className="space-y-6">
                {!editingTopic ? (
                  <div className="text-center py-12 theme-text-muted">
                    <FileText className="w-16 h-16 mx-auto mb-4 opacity-50" />
                    <p>Selecione um t√≥pico na aba "T√≥picos" para editar</p>
                  </div>
                ) : (
                  <div className="relative grid lg:grid-cols-3 gap-6">
                    {/* v1.32.00: Overlay removido - IA roda em worker */}
                    <div className="lg:col-span-2">
                      {/* Componente Extra√É¬≠do - DecisionEditorContainer */}
                      <DecisionEditorContainer
                        ref={editorContainerRef}
                        editorRef={editorRef}
                        relatorioRef={relatorioRef}
                        topic={editingTopic}
                        onSave={saveTopicEdit}
                        onCancel={() => {
                          setLastEditedTopicTitle(editingTopic.title);
                          setEditingTopic(null);
                          modelLibrary.setSuggestions([]);
                          setActiveTab('topics');
                        }}
                        onSaveWithoutClosing={saveTopicEditWithoutClosing}
                        onCategoryChange={handleCategoryChange}
                        onFundamentacaoChange={handleFundamentacaoChange}
                        onRelatorioChange={handleRelatorioChange}
                        onOpenAIAssistant={() => openModal('aiAssistant')}
                        onOpenJurisModal={() => openModal('jurisIndividual')}
                        onExtractModel={confirmExtractModel}
                        onSaveAsModel={saveAsModel}
                        onRegenerateRelatorio={
                          isRelatorio(editingTopic)
                            ? regenerateRelatorioProcessual
                            : regenerateRelatorioWithInstruction
                        }
                        savingTopic={savingTopic}
                        extractingModel={modelLibrary.extractingModelFromDecision}
                        showExtractButton={modelLibrary.showExtractModelButton}
                        regeneratingRelatorio={aiIntegration.regeneratingRelatorio}
                        relatorioInstruction={aiIntegration.relatorioInstruction}
                        onInstructionChange={aiIntegration.setRelatorioInstruction}
                        sanitizeHTML={sanitizeHTML}
                        selectedTopics={selectedTopics}
                        setSelectedTopics={setSelectedTopics}
                        extractedTopics={extractedTopics}
                        setExtractedTopics={setExtractedTopics}
                                              getTopicEditorConfig={getTopicEditorConfig}
                                              quillReady={quillReady}
                        quillError={quillError}
                                              onRegenerateDispositivo={regenerateDispositivoWithInstruction}
                        dispositivoInstruction={aiIntegration.dispositivoInstruction}
                        onDispositivoInstructionChange={aiIntegration.setDispositivoInstruction}
                        regeneratingDispositivo={aiIntegration.regeneratingDispositivo}
                        editorTheme={editorTheme}
                        toggleEditorTheme={toggleEditorTheme}
                        models={modelLibrary.models}
                        onInsertModel={insertModelContent}
                        onPreviewModel={modelPreview.openPreview}
                        findSuggestions={findSuggestions}
                        onSlashCommand={openSlashMenu}
                        isDirty={isIndividualDirty}
                        versioning={fieldVersioning}
                      />
                    </div>

                    <div className="space-y-4">
                          {/* Painel de Provas Vinculadas */}
                          {linkedProofs.length > 0 && (
                          <div className="theme-bg-green-accent rounded-lg border border-green-500/30 overflow-hidden">
                            <div
                              className="p-4 border-b border-green-500/30 flex items-center justify-between cursor-pointer hover-proof-panel"
                              onClick={() => proofManager.setShowProofPanel(!proofManager.showProofPanel)}
                            >
                              <div className={CSS.flexGap2}>
                                <Scale className="w-5 h-5 theme-text-green" />
                                <h4 className="font-bold theme-text-green">
                                  Provas Vinculadas ({linkedProofs.length})
                                </h4>
                              </div>
                              <button className="theme-text-green hover-text-green-300">
                                {proofManager.showProofPanel ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
                              </button>
                            </div>

                            {proofManager.showProofPanel && (
                              <div className="p-4 space-y-3 max-h-96 overflow-y-auto">
                                {linkedProofs.map((proof) => (
                                  <div
                                    key={proof.id}
                                    className="theme-bg-secondary-50 rounded-lg p-3 border theme-border-input"
                                  >
                                    <div className="flex items-center gap-2 mb-2">
                                      <FileText className="w-4 h-4 text-blue-400 flex-shrink-0" />
                                      <h5 className="font-medium theme-text-secondary text-sm flex-1 truncate">{proof.name}</h5>
                                      <span className={`px-2 py-0.5 text-xs rounded ${
                                        (proof.isPdf && proofManager.proofUsePdfMode[proof.id] !== false)
                                          ? 'theme-bg-red-accent theme-text-red'
                                          : 'theme-bg-blue-accent theme-text-blue'
                                      }`}>
                                        {(proof.isPdf && proofManager.proofUsePdfMode[proof.id] !== false) ? 'PDF' : 'TEXTO'}
                                      </span>
                                    </div>

                                    {/* An√°lise IA */}
                                    {proofManager.proofAnalysisResults[proof.id] && (
                                      <div className="mb-2 p-2 theme-bg-blue-accent border border-blue-500/30 rounded text-xs">
                                        <div className="flex items-center gap-1 mb-1">
                                          <Sparkles className="w-3 h-3 theme-text-blue" />
                                          <span className="font-medium theme-text-blue">
                                            {proofManager.proofAnalysisResults[proof.id].type === 'livre' ? 'An√°lise Livre' : 'An√°lise Contextual'}
                                          </span>
                                        </div>
                                        <div className="max-h-32 overflow-y-auto">
                                          <p className="theme-text-tertiary whitespace-pre-wrap">
                                            {proofManager.proofAnalysisResults[proof.id].result}
                                          </p>
                                        </div>
                                      </div>
                                    )}

                                    {/* Conclus√µes Manuais */}
                                    {proofManager.proofConclusions[proof.id] && (
                                      <div className="p-2 theme-bg-green-accent border border-green-500/30 rounded text-xs">
                                        <div className="flex items-center gap-1 mb-1">
                                          <Edit className="w-3 h-3 theme-text-green" />
                                          <span className="font-medium theme-text-green">Minhas Conclus√µes</span>
                                        </div>
                                        <div className="max-h-24 overflow-y-auto">
                                          <p className="theme-text-tertiary whitespace-pre-wrap">
                                            {proofManager.proofConclusions[proof.id]}
                                          </p>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                          )}

                          <h4 className="font-bold text-purple-400">üí° Sugest√µes de Modelos</h4>

                      {/* Campo de busca manual */}
                      <div className="theme-bg-secondary-30 rounded-lg p-3 border theme-border-input">
                        <label className={CSS.label}>
                          üîç Busca Manual
                        </label>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={modelLibrary.manualSearchTerm}
                            onChange={(e) => {
                              modelLibrary.setManualSearchTerm(e.target.value);
                              // v1.33.19: S√≥ faz busca textual se n√£o estiver em modo sem√¢ntico
                              if (!useSemanticManualSearch) {
                                modelLibrary.debouncedManualSearch(e.target.value);
                              }
                            }}
                            placeholder={useSemanticManualSearch ? "Busca por significado..." : "Digite para buscar modelos por t√≠tulo, palavras-chave ou conte√∫do..."}
                            className="flex-1 px-3 py-2 theme-bg-primary border theme-border-input rounded-lg theme-text-primary text-sm theme-placeholder focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all"
                          />
                          {modelLibrary.manualSearchTerm && (
                            <button
                              onClick={() => {
                                modelLibrary.setManualSearchTerm('');
                                modelLibrary.setManualSearchResults([]);
                                setSemanticManualSearchResults(null);
                              }}
                              className="px-3 py-2 theme-bg-tertiary rounded-lg hover-slate-700 transition-colors text-sm"
                              title="Limpar busca"
                            >
                              ‚úï
                            </button>
                          )}
                          {/* v1.33.19: Toggle busca sem√¢ntica/textual */}
                          {searchModelReady && (
                            <button
                              onClick={() => {
                                setUseSemanticManualSearch(prev => !prev);
                                // Limpar resultados ao alternar modo
                                modelLibrary.setManualSearchResults([]);
                                setSemanticManualSearchResults(null);
                              }}
                              className={`px-2 py-1 rounded text-sm transition-colors ${
                                useSemanticManualSearch
                                  ? 'bg-purple-600 text-white hover:bg-purple-700'
                                  : 'theme-bg-tertiary theme-text-secondary hover:bg-slate-600'
                              }`}
                              title={useSemanticManualSearch ? 'Busca sem√¢ntica (por significado)' : 'Busca textual (por palavras)'}
                            >
                              {useSemanticManualSearch ? 'üß†' : 'üî§'}
                            </button>
                          )}
                        </div>
                        {semanticManualSearching && (
                          <p className="text-xs text-purple-400 mt-2 flex items-center gap-1">
                            <span className="animate-spin inline-block w-3 h-3 border border-purple-400 border-t-transparent rounded-full"></span>
                            Buscando por significado...
                          </p>
                        )}
                        {!semanticManualSearching && modelLibrary.manualSearchTerm && modelLibrary.manualSearchResults.length > 0 && (
                          <p className="text-xs theme-text-muted mt-2">
                            {modelLibrary.manualSearchResults.length} modelo{modelLibrary.manualSearchResults.length > 1 ? 's' : ''} encontrado{modelLibrary.manualSearchResults.length > 1 ? 's' : ''}
                            {useSemanticManualSearch && <span className="ml-1 text-purple-400">(sem√¢ntica)</span>}
                          </p>
                        )}
                      </div>

                      {/* Resultados da busca manual */}
                      {modelLibrary.manualSearchResults.length > 0 ? (
                        <div className="space-y-3">
                          <p className="text-sm text-blue-400 font-medium">Resultados da Busca:</p>
                          {modelLibrary.manualSearchResults.map((model, idx) => (
                            <SuggestionCard
                              key={model.id || `manual-${idx}`}
                              model={model}
                              similarity={model.similarity}
                              index={idx}
                              totalSuggestions={modelLibrary.manualSearchResults.length}
                              onPreview={modelPreview.openPreview}
                              onInsert={insertModelContent}
                              sanitizeHTML={sanitizeHTML}
                              showRanking={false}
                            />
                          ))}
                        </div>
                      ) : modelLibrary.manualSearchTerm && modelLibrary.manualSearchResults.length === 0 ? (
                        <p className="theme-text-muted text-sm">Nenhum modelo encontrado para "{modelLibrary.manualSearchTerm}"</p>
                      ) : (
                        <>
                          {/* Sugest√µes autom√°ticas */}
                          <div className="border-t theme-border-input pt-4">
                            <p className="text-sm theme-text-muted font-medium mb-3 flex items-center gap-2">Sugest√µes Autom√°ticas:{modelLibrary.suggestionsSource === 'local' && <span className="bg-purple-600 text-white px-1.5 py-0.5 rounded text-[10px]">ü§ñ IA Local</span>}</p>
                            {modelLibrary.loadingSuggestions ? (
                              <div className="flex flex-col items-center justify-center py-8 space-y-3">
                                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400"></div>
                                <p className="theme-text-muted text-sm text-center">
                                  Analisando modelos relevantes com IA...
                                </p>
                              </div>
                            ) : modelLibrary.suggestions.length === 0 ? (
                              <p className="theme-text-muted text-sm">Nenhum modelo sugerido automaticamente</p>
                            ) : (
                              <div className="space-y-3">
                                {modelLibrary.suggestions.map((model, idx) => (
                                  <SuggestionCard
                                    key={model.id || idx}
                                    model={model}
                                    similarity={model.similarity}
                                    index={idx}
                                    totalSuggestions={modelLibrary.suggestions.length}
                                    onPreview={modelPreview.openPreview}
                                    onInsert={insertModelContent}
                                    sanitizeHTML={sanitizeHTML}
                                    showRanking={true}
                                  />
                                ))}
                              </div>
                              )
                            }
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'jurisprudencia' && (
              <JurisprudenciaTab
                openModal={openModal}
                closeModal={closeModal}
                modals={modals}
                isReadOnly={!primaryTabLock.isPrimaryTab}
                jurisSemanticEnabled={aiIntegration.aiSettings.jurisSemanticEnabled}
                searchModelReady={searchModelReady}
                jurisEmbeddingsCount={jurisEmbeddingsCount}
                jurisSemanticThreshold={aiIntegration.aiSettings.jurisSemanticThreshold}
              />
            )}

            {activeTab === 'legislacao' && (
              <LegislacaoTab
                openModal={openModal}
                closeModal={closeModal}
                modals={modals}
                isReadOnly={!primaryTabLock.isPrimaryTab}
                semanticSearchEnabled={aiIntegration.aiSettings.semanticSearchEnabled}
                searchModelReady={searchModelReady}
                embeddingsCount={embeddingsCount}
                semanticThreshold={aiIntegration.aiSettings.semanticThreshold}
              />
            )}

            {activeTab === 'models' && (
              <div className="space-y-6">
                {/* v1.6.1: Banner de aviso - Apenas quando h√° mudan√ßas n√£o exportadas */}
                {modelLibrary.hasUnsavedChanges && modelLibrary.models.length > 0 && (
                  <div className="theme-warning-box p-4 flex items-start gap-3">
                    <svg className="w-6 h-6 text-yellow-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <div className="flex-1">
                      <h4 className="theme-text-primary font-semibold mb-1">‚ö†Ô∏è Voc√™ tem mudan√ßas n√£o exportadas</h4>
                      <p className="theme-text-secondary text-sm mb-2">
                        H√° altera√ß√µes em seus modelos que ainda n√£o foram exportadas.
                        Para fazer backup do seu trabalho, <strong>exporte seus modelos antes de sair</strong>.
                      </p>
                      <button
                        onClick={exportModels}
                        className="hover-warning-yellow-btn px-4 py-2 rounded-lg font-semibold shadow-lg"
                        style={{
                          color: '#000',
                          transform: 'scale(1)'
                        }}
                      >
                        üíæ Exportar Modelos Agora
                      </button>
                    </div>
                  </div>
                )}

                <div className="flex items-center justify-between flex-wrap gap-4">
                  <div className="flex items-center gap-3 flex-wrap">
                    <h3 className="text-xl font-bold text-purple-400">Banco de Modelos</h3>
                    {/* üîÑ v1.35.55: Bloco de sync movido do header */}
                    {cloudSync?.isAuthenticated && (
                      <div className="flex items-center gap-2">
                        <SyncStatusIndicator
                          status={cloudSync.syncStatus}
                          pendingCount={cloudSync.pendingCount}
                          lastSyncAt={cloudSync.lastSyncAt}
                          onSync={() => {
                            const initialPushDone = localStorage.getItem('sentencify-initial-push-done');
                            if (!initialPushDone && modelLibrary.models.length > 0) {
                              cloudSync.pushAllModels(modelLibrary.models).then(result => {
                                if (result.success) {
                                  localStorage.setItem('sentencify-initial-push-done', 'true');
                                }
                              });
                            } else {
                              cloudSync.sync();
                            }
                          }}
                        />
                        {cloudSync.user?.email && (
                          <span className="text-slate-400 text-xs" title={cloudSync.user.email}>
                            {cloudSync.user.email.length > 25 ? cloudSync.user.email.slice(0, 22) + '...' : cloudSync.user.email}
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                  <div className="flex gap-2 flex-wrap">
                    <button
                      onClick={() => openModal('bulkModal')}
                      className="hover-gradient-blue-purple flex items-center gap-2 px-4 py-2 rounded-lg shadow-lg text-white"
                      style={{
                        backgroundImage: 'linear-gradient(to right, #2563eb, #9333ea)'
                      }}
                      title="Criar m√∫ltiplos modelos automaticamente a partir de arquivos usando IA"
                    >
                      <Sparkles className="w-4 h-4" />
                      <Upload className="w-4 h-4" />
                      Criar de Arquivos
                    </button>
                    <button
                      onClick={() => fileInputRef.current?.click()}
                      className="flex items-center gap-2 px-4 py-2 rounded-lg hover-green-700-from-600 bg-emerald-600 text-white transition-colors duration-300"
                      title="Carregar modelos de um arquivo JSON previamente exportado"
                    >
                      <Upload className="w-4 h-4" />
                      Importar
                    </button>
                    <input
                      ref={fileInputRef}
                      type="file"
                      accept=".json"
                      onChange={importModels}
                      className="hidden"
                    />
                    <button
                      onClick={exportModels}
                      className="flex items-center gap-2 px-4 py-2 rounded-lg hover-purple-700-from-600 bg-purple-600 text-white transition-colors duration-300"
                      title="Salvar todos os modelos em um arquivo JSON (necess√°rio para backup)"
                    >
                      <Download className="w-4 h-4" />
                      Exportar
                    </button>
                    <button
                      onClick={() => {
                        if (modals.modelForm) {
                          closeModal('modelForm');
                          modelLibrary.setNewModel({ title: '', content: '', keywords: '', category: '' });
                          modelLibrary.setEditingModel(null);
                          if (modelEditorRef.current?.root) {
                            modelEditorRef.current.root.innerHTML = '';
                          }
                        } else {
                          modelLibrary.setNewModel({ title: '', content: '', keywords: '', category: '' });
                          modelLibrary.setEditingModel(null);
                          openModal('modelForm');

                          // Scroll suave para o topo da p√°gina
                          window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                          });

                          setTimeout(() => {
                            if (modelEditorRef.current?.root) {
                              modelEditorRef.current.root.innerHTML = '';
                              modelEditorRef.current.focus();
                            }
                          }, 50);
                        }
                      }}
                      className="flex items-center gap-2 px-4 py-2 rounded-lg hover-blue-700-from-600 bg-blue-600 text-white transition-colors duration-300"
                    >
                      <Plus className="w-4 h-4" />
                      Novo Modelo
                    </button>

                    {/* v1.35.0: Bot√£o para compartilhar biblioteca */}
                    {cloudSync.isAuthenticated && (
                      <button
                        onClick={() => openModal('shareLibrary')}
                        className="flex items-center gap-2 px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white transition-colors duration-300"
                        title="Compartilhar biblioteca de modelos"
                      >
                        <Share2 className="w-4 h-4" />
                        Compartilhar
                      </button>
                    )}

                    {/* Bot√£o minimalista para excluir todos os modelos */}
                    {modelLibrary.models.length > 0 && (
                      <button
                        onClick={() => openModal('deleteAllModels')}
                        className="p-2 rounded hover-delete-all"
                        title="Excluir todos os modelos"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    )}
                  </div>
                </div>

                {/* Formul√°rio de Modelo Extra√≠do */}
                <ModelFormModal
                  ref={modelFormRef}
                  isOpen={modals.modelForm}
                  editingModel={modelLibrary.editingModel}
                  newModel={modelLibrary.newModel}
                  setNewModel={modelLibrary.setNewModel}
                  models={modelLibrary.models}
                  onSave={saveModel}
                  onCancel={() => {
                    closeModal('modelForm');
                    modelLibrary.setNewModel({ title: '', content: '', keywords: '', category: '' });
                    modelLibrary.setEditingModel(null);
                    if (modelEditorRef.current?.root) {
                      modelEditorRef.current.root.innerHTML = '';
                    }
                    setModelSaved(false);
                  }}
                  onGenerateKeywords={generateKeywordsWithAI}
                  generatingKeywords={aiIntegration.generatingKeywords}
                  onGenerateTitle={generateTitleWithAI}
                  generatingTitle={aiIntegration.generatingTitle}
                  onSaveWithoutClosing={saveModelWithoutClosing}
                  onOpenAIAssistant={() => openModal('aiAssistantModel')}
                  sanitizeHTML={sanitizeHTML}
                  modelEditorRef={modelEditorRef}
                  quillReady={quillReady}
                  quillError={quillError}
                  editorTheme={editorTheme}
                  toggleEditorTheme={toggleEditorTheme}
                  modelSaved={modelSaved}
                  savingModel={savingModel}
                />

                <div>
                      <div className="grid md:grid-cols-2 gap-4 mb-4">
                        <div className="relative flex items-center gap-2">
                          <div className="relative flex-1">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 theme-text-muted" />
                            <input
                              type="text"
                              value={modelLibrary.searchTerm}
                              onChange={(e) => modelLibrary.setSearchTerm(e.target.value)}
                              onKeyDown={(e) => e.key === 'Escape' && modelLibrary.setSearchTerm('')}
                              className="w-full theme-bg-primary border theme-border-input rounded-lg pl-10 pr-10 py-3 theme-text-primary focus:border-blue-500"
                              placeholder={useModelSemanticSearch ? "Buscar por significado..." : "Buscar modelos..."}
                            />
                            {modelLibrary.searchTerm && (
                              <button onClick={() => modelLibrary.setSearchTerm('')} className="absolute right-3 top-1/2 -translate-y-1/2 p-0.5 theme-text-muted hover-text-primary" title="Limpar (Esc)">
                                <X className="w-4 h-4" />
                              </button>
                            )}
                          </div>
                          {/* v1.27.01: Toggle busca sem√¢ntica */}
                          {modelSemanticAvailable && (
                            <button
                              onClick={() => {
                                setUseModelSemanticSearch(prev => !prev);
                                setModelSemanticResults(null);
                              }}
                              className={`px-3 py-3 rounded-lg text-lg transition-colors ${
                                useModelSemanticSearch
                                  ? 'bg-purple-600 text-white hover:bg-purple-700'
                                  : 'theme-bg-secondary theme-text-secondary hover-slate-600'
                              }`}
                              title={useModelSemanticSearch ? 'Busca sem√¢ntica (por significado)' : 'Busca textual (por palavras)'}
                            >
                              {useModelSemanticSearch ? 'üß†' : 'üî§'}
                            </button>
                          )}
                        </div>
                        <div>
                          <select
                            value={modelLibrary.selectedCategory}
                            onChange={(e) => modelLibrary.setSelectedCategory(e.target.value)}
                            className="w-full theme-bg-primary border theme-border-input rounded-lg px-4 py-3 theme-text-primary focus:border-blue-500"
                          >
                            <option value="all">Todas as categorias ({modelLibrary.models.length})</option>
                            {categories.map((cat, idx) => (
                              <option key={idx} value={cat}>
                                {cat} ({categoryCounts.counts[cat] || 0})
                              </option>
                            ))}
                            <option value="">Sem categoria ({categoryCounts.withoutCategory})</option>
                      </select>
                    </div>
                  </div>
                  
                  {/* Controles de visualiza√ß√£o e favoritos */}
                  <div className="flex items-center justify-between mb-4 gap-4 flex-wrap">
                    <div className={CSS.flexGap2}>
                      <button
                        onClick={() => modelLibrary.setShowFavoritesOnly(!modelLibrary.showFavoritesOnly)}
                        className={`flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${
                          modelLibrary.showFavoritesOnly
                            ? 'bg-yellow-600 hover-yellow-600'
                            : 'theme-bg-secondary hover-slate-600'
                        }`}
                        title="Mostrar apenas favoritos"
                      >
                        <span className="text-lg">{modelLibrary.showFavoritesOnly ? '‚≠ê' : '‚òÜ'}</span>
                        <span className="text-sm">
                          {modelLibrary.showFavoritesOnly ? 'Favoritos' : 'Todos'}
                          {modelLibrary.showFavoritesOnly && ` (${categoryCounts.favorites})`}
                        </span>
                      </button>

                      {/* v1.35.0: Filtro de propriedade (Meus/Compartilhados) */}
                      <div className="flex items-center theme-bg-primary rounded-lg p-1">
                        <button
                          onClick={() => modelLibrary.setOwnershipFilter('all')}
                          className={`px-3 py-1.5 rounded text-sm transition-colors ${
                            modelLibrary.ownershipFilter === 'all'
                              ? 'bg-purple-600 text-white'
                              : 'theme-text-muted hover-theme-text-secondary'
                          }`}
                          title="Mostrar todos os modelos"
                        >
                          Todos
                        </button>
                        <button
                          onClick={() => modelLibrary.setOwnershipFilter('mine')}
                          className={`px-3 py-1.5 rounded text-sm transition-colors ${
                            modelLibrary.ownershipFilter === 'mine'
                              ? 'bg-purple-600 text-white'
                              : 'theme-text-muted hover-theme-text-secondary'
                          }`}
                          title="Mostrar apenas meus modelos"
                        >
                          Meus
                        </button>
                        <button
                          onClick={() => modelLibrary.setOwnershipFilter('shared')}
                          className={`px-3 py-1.5 rounded text-sm transition-colors flex items-center gap-1 ${
                            modelLibrary.ownershipFilter === 'shared'
                              ? 'bg-purple-600 text-white'
                              : 'theme-text-muted hover-theme-text-secondary'
                          }`}
                          title="Mostrar apenas modelos compartilhados"
                        >
                          <Users className="w-3 h-3" />
                          Compartilhados
                        </button>
                      </div>

                      <span className={CSS.textMuted}>
                        {filteredModels.length} modelo{filteredModels.length !== 1 ? 's' : ''}
                      </span>
                    </div>
                    
                    <div className="flex items-center gap-2 theme-bg-primary rounded-lg p-1">
                      <button
                        onClick={() => modelLibrary.setModelViewMode('cards')}
                        className={`px-3 py-1.5 rounded transition-colors text-sm ${
                          modelLibrary.modelViewMode === 'cards'
                            ? 'bg-blue-600 text-white'
                            : 'theme-text-muted hover-theme-text-secondary'
                        }`}
                        title="Visualiza√ß√£o em cards"
                      >
                        üìá Cards
                      </button>
                      <button
                        onClick={() => modelLibrary.setModelViewMode('list')}
                        className={`px-3 py-1.5 rounded transition-colors text-sm ${
                          modelLibrary.modelViewMode === 'list'
                            ? 'bg-blue-600 text-white'
                            : 'theme-text-muted hover-theme-text-secondary'
                        }`}
                        title="Visualiza√ß√£o em lista"
                      >
                        üìã Lista
                      </button>
                    </div>
                  </div>

                  {/* v1.27.01: Resultados sem√¢nticos - v1.33.4: Usando ModelCard para UI consistente */}
                  {useModelSemanticSearch && modelSemanticResults && modelSemanticResults.length > 0 ? (
                    <div className="space-y-3">
                      <div className="flex items-center gap-2 mb-3 text-sm theme-text-muted">
                        <span className="text-purple-400">üß†</span>
                        <span>{modelSemanticResults.length} resultado(s) sem√¢ntico(s)</span>
                        {searchingModelSemantics && <RefreshCw className="w-4 h-4 animate-spin" />}
                      </div>
                      {/* v1.33.5: 1 card por linha na busca sem√¢ntica */}
                      {modelLibrary.modelViewMode === 'cards' ? (
                        <div className="grid grid-cols-1 gap-4">
                          {modelSemanticResults.map((model) => (
                            <ModelCard
                              key={model.id}
                              model={model}
                              viewMode="cards"
                              onEdit={startEditingModel}
                              onToggleFavorite={toggleFavorite}
                              onDuplicate={duplicateModel}
                              onDelete={confirmDeleteModel}
                              sanitizeHTML={sanitizeHTML}
                              isShared={model.isShared}
                              ownerEmail={model.ownerEmail}
                              sharedPermission={model.sharedPermission}
                            />
                          ))}
                        </div>
                      ) : (
                        <div className="space-y-1">
                          {modelSemanticResults.map((model) => (
                            <ModelCard
                              key={model.id}
                              model={model}
                              viewMode="list"
                              onEdit={startEditingModel}
                              onToggleFavorite={toggleFavorite}
                              onDuplicate={duplicateModel}
                              onDelete={confirmDeleteModel}
                              sanitizeHTML={sanitizeHTML}
                              isShared={model.isShared}
                              ownerEmail={model.ownerEmail}
                              sharedPermission={model.sharedPermission}
                            />
                          ))}
                        </div>
                      )}
                    </div>
                  ) : useModelSemanticSearch && modelSemanticResults && modelSemanticResults.length === 0 ? (
                    <div className="text-center py-12 theme-text-muted">
                      <Search className="w-12 h-12 mx-auto mb-3 opacity-30" />
                      <p className="text-sm">Nenhum resultado sem√¢ntico encontrado</p>
                      <p className="text-xs mt-1">Tente reduzir o threshold nas configura√ß√µes</p>
                    </div>
                  ) : filteredModels.length === 0 ? (
                    <div className="text-center py-12 theme-text-muted">
                      <Save className="w-16 h-16 mx-auto mb-4 opacity-50" />
                      <p>Nenhum modelo {modelLibrary.showFavoritesOnly ? 'favorito' : 'cadastrado'} ainda</p>
                    </div>
                  ) : modelLibrary.modelViewMode === 'cards' ? (
                    /* Visualiza√ß√£o em CARDS - v1.2.7: Componentizado (mant√©m pagina√ß√£o) */
                    /* v1.33.6: 1 card por linha */
                    <>
                      <div className="grid grid-cols-1 gap-4">
                        {currentModels.map((model) => (
                          <ModelCard
                            key={model.id}
                            model={model}
                            viewMode="cards"
                            onEdit={startEditingModel}
                            onToggleFavorite={toggleFavorite}
                            onDuplicate={duplicateModel}
                            onDelete={confirmDeleteModel}
                            sanitizeHTML={sanitizeHTML}
                            isShared={model.isShared}
                            ownerEmail={model.ownerEmail}
                            sharedPermission={model.sharedPermission}
                          />
                        ))}
                      </div>

                      {/* Pagina√ß√£o apenas no modo CARDS */}
                      {filteredModels.length > modelLibrary.modelsPerPage && (() => {
                        // Helper: Gera array de p√°ginas truncado com elipse (null = "...")
                        const getPaginationRange = (current, total) => {
                          if (total <= 7) {
                            return Array.from({ length: total }, (_, i) => i + 1);
                          }
                          const pages = new Set([1, total]);
                          for (let i = Math.max(2, current - 2); i <= Math.min(total - 1, current + 2); i++) {
                            pages.add(i);
                          }
                          const sorted = Array.from(pages).sort((a, b) => a - b);
                          const result = [];
                          for (let i = 0; i < sorted.length; i++) {
                            if (i > 0 && sorted[i] - sorted[i - 1] > 1) {
                              result.push(null);
                            }
                            result.push(sorted[i]);
                          }
                          return result;
                        };

                        const paginationRange = getPaginationRange(modelLibrary.currentModelPage, totalModelPages);

                        return (
                          <div className="mt-6 flex items-center justify-between border-t theme-border-input pt-4">
                            <div className="text-sm theme-text-muted">
                              Mostrando {indexOfFirstModel + 1}-{Math.min(indexOfLastModel, filteredModels.length)} de {filteredModels.length} modelos
                            </div>
                            <div className={CSS.flexGap2}>
                              <button
                                onClick={() => modelLibrary.setCurrentModelPage(prev => Math.max(prev - 1, 1))}
                                disabled={modelLibrary.currentModelPage === 1}
                                className="px-3 py-2 rounded-lg disabled:theme-bg-primary disabled:theme-text-disabled disabled:cursor-not-allowed flex items-center justify-center hover-pagination-btn"
                                title="P√°gina anterior"
                              >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                </svg>
                              </button>
                              <div className="flex items-center gap-1">
                                {paginationRange.map((pageNum, idx) => (
                                  pageNum === null ? (
                                    <span key={`ellipsis-${idx}`} className="px-2 theme-text-muted select-none">...</span>
                                  ) : (
                                    <button
                                      key={pageNum}
                                      onClick={() => modelLibrary.setCurrentModelPage(pageNum)}
                                      data-active={modelLibrary.currentModelPage === pageNum ? "true" : undefined}
                                      className={`px-3 py-2 rounded-lg text-white min-w-[40px] ${
                                        modelLibrary.currentModelPage === pageNum
                                          ? 'bg-gradient-to-r from-blue-600 to-purple-600'
                                          : 'theme-bg-secondary hover-pagination-page'
                                      }`}
                                    >
                                      {pageNum}
                                    </button>
                                  )
                                ))}
                              </div>
                              <button
                                onClick={() => modelLibrary.setCurrentModelPage(prev => Math.min(prev + 1, totalModelPages))}
                                disabled={modelLibrary.currentModelPage === totalModelPages}
                                className="px-3 py-2 rounded-lg disabled:theme-bg-primary disabled:theme-text-disabled disabled:cursor-not-allowed flex items-center justify-center hover-pagination-btn"
                                title="Pr√≥xima p√°gina"
                              >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                </svg>
                              </button>
                            </div>
                          </div>
                        );
                      })()}
                    </>
                  ) : (
                    /* üöÄ Visualiza√ß√£o em LISTA - v1.7 FASE 1.4: Virtual Scrolling */
                    <VirtualList
                      items={filteredModels}
                      itemHeight={90}
                      renderItem={(model) => (
                        <ModelCard
                          key={model.id}
                          model={model}
                          viewMode="list"
                          onEdit={startEditingModel}
                          onToggleFavorite={toggleFavorite}
                          onDuplicate={duplicateModel}
                          onDelete={confirmDeleteModel}
                          sanitizeHTML={sanitizeHTML}
                          isShared={model.isShared}
                          ownerEmail={model.ownerEmail}
                          sharedPermission={model.sharedPermission}
                        />
                      )}
                      className="space-y-1"
                    />
                  )}
                </div>
              </div>
            )}
          </div>
        </div>

        <div className="mt-6 text-center">
          <div className="inline-block theme-bg-primary/90 rounded-lg px-6 py-3 border theme-border-secondary">
            <p className="text-sm theme-text-muted">
              <span className="bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent font-semibold">SENTENCIFY.AI</span>
              {' '}- Vers√£o {APP_VERSION} - <span className="text-amber-500 font-semibold">PROT√ìTIPO</span>
            </p>
            <p className="text-xs theme-text-disabled mt-1">
              Desenvolvido por <span className="text-blue-400 font-medium">Rodrigo Nohlack Corr√™a Cesar</span>, Juiz do Trabalho no TRT8
            </p>
          </div>
        </div>
      </div>

      <ExportModal
        isOpen={modals.export}
        onClose={() => closeModal('export')}
        exportedText={exportedText}
        exportedHtml={exportedHtml}
        copySuccess={copySuccess}
        setCopySuccess={setCopySuccess}
        setError={setError}
      />

      <DispositivoModal
        isOpen={modals.dispositivo}
        onClose={() => closeModal('dispositivo')}
        dispositivoText={aiIntegration.dispositivoText}
        setDispositivoText={aiIntegration.setDispositivoText}
        copySuccess={copySuccess}
        setCopySuccess={setCopySuccess}
        setError={setError}
        extractedTopics={extractedTopics}
        setExtractedTopics={setExtractedTopics}
        selectedTopics={selectedTopics}
        setSelectedTopics={setSelectedTopics}
        sanitizeHTML={sanitizeHTML}
      />

      {/* v1.21.21: Modal de op√ß√µes para revis√£o de senten√ßa */}
      {modals.sentenceReview && (
        <div className={CSS.modalOverlay}>
          <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-lg`}>
            <div className={CSS.modalHeader}>
              <div className="flex items-center justify-between w-full">
                <div className="flex items-center gap-3">
                  <div className="p-3 rounded-xl bg-amber-500/20">
                    <Scale className="w-6 h-6 text-amber-400" />
                  </div>
                  <h3 className="text-lg font-semibold theme-text-primary">Revisar Senten√ßa</h3>
                </div>
                <button
                  onClick={() => closeModal('sentenceReview')}
                  className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
                  title="Fechar"
                >
                  <X className="w-5 h-5 theme-text-tertiary" />
                </button>
              </div>
            </div>
            <div className="p-6 space-y-4">
              <p className="text-sm theme-text-tertiary mb-4">
                An√°lise cr√≠tica da decis√£o buscando omiss√µes, contradi√ß√µes e obscuridades que poderiam fundamentar embargos de declara√ß√£o.
              </p>
              {/* Radio 1: Apenas decis√£o */}
              <label className={`flex items-start gap-3 p-4 rounded-lg border cursor-pointer transition-all ${
                reviewScope === 'decisionOnly' ? 'border-amber-500 bg-amber-500/10' : 'theme-border-input theme-bg-secondary-30'
              }`}>
                <input
                  type="radio"
                  name="reviewScope"
                  checked={reviewScope === 'decisionOnly'}
                  onChange={() => setReviewScope('decisionOnly')}
                  className="w-4 h-4 text-amber-600 mt-1"
                />
                <div>
                  <span className="text-sm font-medium theme-text-primary">Apenas a decis√£o completa</span>
                  <p className="text-xs theme-text-muted mt-1">RELAT√ìRIO + todos os t√≥picos (mini-relat√≥rios + decis√µes) + DISPOSITIVO</p>
                </div>
              </label>
              {/* Radio 2: Decis√£o + documentos */}
              <label className={`flex items-start gap-3 p-4 rounded-lg border cursor-pointer transition-all ${
                reviewScope === 'decisionWithDocs' ? 'border-amber-500 bg-amber-500/10' : 'theme-border-input theme-bg-secondary-30'
              } ${!(analyzedDocuments?.peticoesText?.length > 0 || analyzedDocuments?.contestacoesText?.length > 0) ? 'opacity-50 cursor-not-allowed' : ''}`}>
                <input
                  type="radio"
                  name="reviewScope"
                  disabled={!(analyzedDocuments?.peticoesText?.length > 0 || analyzedDocuments?.contestacoesText?.length > 0)}
                  checked={reviewScope === 'decisionWithDocs'}
                  onChange={() => (analyzedDocuments?.peticoesText?.length > 0 || analyzedDocuments?.contestacoesText?.length > 0) && setReviewScope('decisionWithDocs')}
                  className="w-4 h-4 text-amber-600 mt-1"
                />
                <div>
                  <span className="text-sm font-medium theme-text-primary">Decis√£o + pe√ßas processuais</span>
                  <p className="text-xs theme-text-muted mt-1">Inclui peti√ß√£o inicial, contesta√ß√µes e documentos complementares</p>
                  {!(analyzedDocuments?.peticoesText?.length > 0 || analyzedDocuments?.contestacoesText?.length > 0) && (
                    <p className="text-xs text-red-400 mt-1">Nenhum documento extra√≠do dispon√≠vel</p>
                  )}
                </div>
              </label>
            </div>
            <div className={CSS.modalFooter}>
              <button onClick={() => closeModal('sentenceReview')} disabled={generatingReview} className={CSS.btnSecondary}>
                Cancelar
              </button>
              <button
                onClick={reviewSentence}
                disabled={generatingReview}
                className="flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover-amber-700 disabled:opacity-50"
              >
                {generatingReview ? (
                  <>
                    <div className={CSS.spinner}></div>
                    Analisando...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-4 h-4" />
                    Iniciar Revis√£o
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* v1.21.21: Modal de resultado da revis√£o de senten√ßa */}
      {modals.sentenceReviewResult && reviewResult && (
        <div className={`${CSS.modalOverlay} overflow-auto`}>
          <div className={`${CSS.modalContainer} max-w-5xl w-full max-h-[95vh] flex flex-col my-auto`}>
            <div className={`${CSS.modalHeader} flex-shrink-0`}>
              <div className="flex items-center justify-between w-full">
                <div className="flex items-center gap-3">
                  <Scale className="w-6 h-6 text-amber-400" />
                  <div>
                    <h3 className="text-xl font-bold text-amber-400">Revis√£o Cr√≠tica da Senten√ßa</h3>
                    <p className="text-sm theme-text-muted">An√°lise detalhada por IA - revise os apontamentos abaixo</p>
                  </div>
                </div>
                <button onClick={() => closeModal('sentenceReviewResult')} className="p-2 rounded-lg hover-slate-700">
                  <X className="w-5 h-5 theme-text-muted" />
                </button>
              </div>
            </div>
            {/* Aviso */}
            <div className="mx-6 mt-4 p-4 bg-amber-500/15 border border-amber-500/30 rounded-lg flex-shrink-0">
              <div className="flex items-start gap-3">
                <AlertTriangle className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" />
                <div className="text-sm">
                  <p className="font-medium text-amber-400 mb-1">REVIS√ÉO POR IA - AVALIE CRITICAMENTE</p>
                  <p className="text-xs theme-text-muted">Esta an√°lise foi gerada por intelig√™ncia artificial e pode conter falsos positivos ou n√£o identificar todos os problemas. Use como ferramenta de apoio, n√£o como decis√£o final.</p>
                </div>
              </div>
            </div>
            {/* Conte√∫do com scroll */}
            <div className="flex-1 overflow-y-auto px-6 py-4">
              <div
                className="prose prose-sm max-w-none theme-text-secondary dark:prose-invert"
                dangerouslySetInnerHTML={{ __html: sanitizeHTML(reviewResult) }}
              />
            </div>
            {/* Footer */}
            <div className={`${CSS.modalFooter} flex-shrink-0`}>
              <button
                onClick={async () => {
                  try {
                    // v1.25.18: Usar helper ao inv√©s de DOM (memory leak fix)
                    const plainText = extractPlainText(reviewResult);
                    await navigator.clipboard.writeText(plainText);
                    if (copyTimeoutRef.current) clearTimeout(copyTimeoutRef.current);
                    setCopySuccess(true);
                    copyTimeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
                  } catch (err) {
                    setError('Erro ao copiar: ' + err.message);
                  }
                }}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg ${copySuccess ? 'bg-green-600 text-white' : 'theme-bg-secondary hover-slate-600'}`}
              >
                {copySuccess ? (
                  <><Check className="w-4 h-4" /> Copiado!</>
                ) : (
                  <><Copy className="w-4 h-4" /> Copiar Texto</>
                )}
              </button>
              <button
                onClick={() => closeModal('sentenceReviewResult')}
                className="px-6 py-2 bg-amber-600 text-white rounded-lg hover-amber-700"
              >
                Fechar
              </button>
            </div>
          </div>
        </div>
      )}

      <RenameTopicModal
        isOpen={modals.rename}
        onClose={() => closeModal('rename')}
        topicToRename={topicToRename}
        setTopicToRename={setTopicToRename}
        newTopicName={newTopicName}
        setNewTopicName={setNewTopicName}
        handleRenameTopic={handleRenameTopic}
        isRegenerating={aiIntegration.regenerating}
        hasDocuments={!!(analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0)}
      />

      <DeleteTopicModal
        isOpen={modals.deleteTopic}
        onClose={() => closeModal('deleteTopic')}
        topicToDelete={topicToDelete}
        setTopicToDelete={setTopicToDelete}
        onConfirmDelete={confirmDeleteTopic}
      />

      <MergeTopicsModal
        isOpen={modals.merge}
        onClose={() => closeModal('merge')}
        topicsToMerge={topicsToMerge}
        onConfirmMerge={handleMergeTopics}
        isRegenerating={aiIntegration.regenerating}
        hasDocuments={!!(analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0)}
      />

      <SplitTopicModal
        isOpen={modals.split}
        onClose={() => closeModal('split')}
        topicToSplit={topicToSplit}
        setTopicToSplit={setTopicToSplit}
        splitNames={splitNames}
        setSplitNames={setSplitNames}
        onConfirmSplit={handleSplitTopic}
        isRegenerating={aiIntegration.regenerating}
        hasDocuments={!!(analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0)}
      />

      <NewTopicModal
        isOpen={modals.newTopic}
        onClose={() => closeModal('newTopic')}
        newTopicData={newTopicData}
        setNewTopicData={setNewTopicData}
        onConfirmCreate={handleCreateNewTopic}
        isRegenerating={aiIntegration.regenerating}
        hasDocuments={!!(analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0)}
      />

      <AIAssistantModal
        isOpen={modals.aiAssistant}
        onClose={() => {
          closeModal('aiAssistant');
          chatAssistant.clear();
        }}
        contextScope={topicContextScope}
        setContextScope={setTopicContextScope}
        topicTitle={editingTopic?.title}
        chatHistory={chatAssistant.history}
        onSendMessage={handleSendChatMessage}
        onInsertResponse={handleInsertChatResponse}
        generating={chatAssistant.generating}
        onClear={chatAssistant.clear}
        lastResponse={chatAssistant.lastResponse}
        sanitizeHTML={sanitizeHTML}
        quickPrompts={aiIntegration.aiSettings.quickPrompts}
        proofManager={proofManager}
      />

      {/* v1.20.0: Modal de Jurisprud√™ncia (editor individual) */}
      {/* v1.32.18: Props para busca sem√¢ntica */}
      {/* v1.33.16: jurisSemanticEnabled para toggle interno */}
      <JurisprudenciaModal
        isOpen={modals.jurisIndividual}
        onClose={() => closeModal('jurisIndividual')}
        topicTitle={editingTopic?.title}
        topicRelatorio={editingTopic?.relatorio || editingTopic?.editedRelatorio}
        callAI={aiIntegration?.callAI}
        useLocalAI={aiIntegration.aiSettings.useLocalAIForJuris && searchModelReady && jurisEmbeddingsCount > 0}
        jurisSemanticThreshold={aiIntegration.aiSettings.jurisSemanticThreshold}
        jurisSemanticEnabled={searchModelReady && jurisEmbeddingsCount > 0}
      />

      <AIAssistantModelModal
        isOpen={modals.aiAssistantModel}
        onClose={() => {
          closeModal('aiAssistantModel');
          aiIntegration.setAiInstructionModel('');
          aiIntegration.setAiGeneratedTextModel('');
        }}
        aiInstructionModel={aiIntegration.aiInstructionModel}
        setAiInstructionModel={aiIntegration.setAiInstructionModel}
        generatingAiModel={aiIntegration.generatingAiModel}
        aiGeneratedTextModel={aiIntegration.aiGeneratedTextModel}
        setAiGeneratedTextModel={aiIntegration.setAiGeneratedTextModel}
        onGenerateText={generateAiTextForModel}
        onInsertText={insertAiTextModel}
        sanitizeHTML={sanitizeHTML}
      />

      <AnalysisModal
        isOpen={modals.analysis}
        analysisProgress={analysisProgress}
        peticaoFiles={peticaoFiles}
        pastedPeticaoTexts={pastedPeticaoTexts}
        contestacaoFiles={contestacaoFiles}
        pastedContestacaoTexts={pastedContestacaoTexts}
        complementaryFiles={complementaryFiles}
        pastedComplementaryTexts={pastedComplementaryTexts}
      />

      {/* v1.35.30: Modal de Curadoria de T√≥picos */}
      <TopicCurationModal
        isOpen={showTopicCurationModal}
        onConfirm={handleCurationConfirm}
        onCancel={handleCurationCancel}
        initialTopics={pendingCurationData?.topics || []}
        model={aiIntegration.aiSettings?.provider === 'gemini'
          ? (aiIntegration.aiSettings?.geminiModel || 'gemini-3-flash-preview')
          : (aiIntegration.aiSettings?.model || 'claude-sonnet-4-20250514')}
        parallelRequests={aiIntegration.aiSettings?.parallelRequests || 5}
        isDarkMode={appTheme === 'dark'}
        provider={aiIntegration.aiSettings?.provider || 'anthropic'}
        thinkingBudget={aiIntegration.aiSettings?.thinkingBudget || '10000'}
        useExtendedThinking={aiIntegration.aiSettings?.useExtendedThinking ?? true}
        geminiThinkingLevel={aiIntegration.aiSettings?.geminiThinkingLevel || 'high'}
        topicsPerRequest={aiIntegration.aiSettings?.topicsPerRequest || 1}
      />

      {/* v1.35.40: Modal de arquivos do Google Drive */}
      <DriveFilesModal
        isOpen={driveFilesModalOpen}
        onClose={() => setDriveFilesModalOpen(false)}
        files={driveFiles}
        isLoading={googleDrive.isLoading}
        onLoad={async (file) => {
          try {
            const projectData = await googleDrive.loadFile(file.id);
            // Simular evento de importa√ß√£o de arquivo
            const callbacks = {
              setPastedPeticaoTexts,
              setPastedContestacaoTexts,
              setPastedComplementaryTexts,
              setExtractedTopics,
              setSelectedTopics,
              setPartesProcesso,
              setAnalyzedDocuments,
              setProofFiles: proofManager.setProofFiles,
              setProofTexts: proofManager.setProofTexts,
              setProofUsePdfMode: proofManager.setProofUsePdfMode,
              setExtractedProofTexts: proofManager.setExtractedProofTexts,
              setProofExtractionFailed: proofManager.setProofExtractionFailed,
              setProofTopicLinks: proofManager.setProofTopicLinks,
              setProofAnalysisResults: proofManager.setProofAnalysisResults,
              setProofConclusions: proofManager.setProofConclusions,
              setProofSendFullContent: proofManager.setProofSendFullContent,
              setActiveTab,
              setAiSettings: aiIntegration.setAiSettings,
              setError,
              setProcessoNumero,
              setPeticaoFiles,
              setContestacaoFiles,
              setComplementaryFiles,
              setExtractedTexts,
              setDocumentProcessingModes,
              setTokenMetrics: aiIntegration.setTokenMetrics
            };
            await storage.importProjectFromJson(projectData, callbacks, (allStates) => {
              storage.autoSaveSession(allStates, setError, true);
            });
            setDriveFilesModalOpen(false);
            setError({ type: 'success', message: `Projeto carregado do Google Drive: ${file.name}` });
          } catch (err) {
            setError({ type: 'error', message: `Erro ao carregar projeto: ${err.message}` });
          }
        }}
        onDelete={async (file) => {
          try {
            await googleDrive.deleteFile(file.id);
            setDriveFiles(prev => prev.filter(f => f.id !== file.id));
            setError({ type: 'success', message: `Arquivo exclu√≠do: ${file.name}` });
          } catch (err) {
            setError({ type: 'error', message: `Erro ao excluir: ${err.message}` });
          }
        }}
        onShare={async (fileId, email, role) => {
          try {
            await googleDrive.shareFile(fileId, email, role);
            const roleText = role === 'writer' ? 'edi√ß√£o' : 'visualiza√ß√£o';
            setError({ type: 'success', message: `Compartilhado com ${email} (${roleText})` });
          } catch (err) {
            setError({ type: 'error', message: `Erro ao compartilhar: ${err.message}` });
          }
        }}
        onRefresh={async () => {
          try {
            const files = await googleDrive.listFiles();
            setDriveFiles(files);
          } catch (err) {
            setError({ type: 'error', message: `Erro ao atualizar: ${err.message}` });
          }
        }}
        onGetPermissions={googleDrive.getPermissions}
        onRemovePermission={googleDrive.removePermission}
        userEmail={googleDrive.userEmail}
        isDarkMode={appTheme === 'dark'}
      />

      {/* v1.35.69: Modal de Gera√ß√£o de Modelo a partir de Exemplos */}
      <ModelGeneratorModal
        isOpen={modelGeneratorModal.isOpen}
        onClose={closeModelGenerator}
        targetField={modelGeneratorModal.targetField}
        onSave={handleModelGenerated}
        callAI={aiIntegration.callAI}
        hardcodedPrompt={getHardcodedPrompt(modelGeneratorModal.targetField)}
      />

      {modals.settings && (
        <div className={`${CSS.modalOverlay} overflow-auto`}>
          <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-2xl w-full my-auto`}>
            <div className={CSS.modalHeader}>
              <div className="flex items-center justify-between w-full">
                <div className="flex items-center gap-3">
                  <div className="p-3 rounded-xl bg-blue-500/20">
                    <Zap className="w-6 h-6 text-blue-400" />
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold theme-text-primary">Configura√ß√µes de IA</h3>
                    <p className="text-sm theme-text-muted">Escolha o modelo e as configura√ß√µes para an√°lise de documentos</p>
                  </div>
                </div>
                <button
                  onClick={() => closeModal('settings')}
                  className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
                  title="Fechar"
                >
                  <X className="w-5 h-5 theme-text-tertiary" />
                </button>
              </div>
            </div>
            
            <div className="p-6 space-y-6 max-h-[60vh] overflow-y-auto">
              {/* v1.30: Provider Selection */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">Provedor de IA</label>
                <div className="grid grid-cols-2 gap-3">
                  <button
                    onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, provider: 'claude' })}
                    className={`p-4 rounded-lg border-2 transition-all text-left ${
                      aiIntegration.aiSettings.provider !== 'gemini'
                        ? 'bg-purple-600/20 border-purple-500'
                        : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      <span className="text-xl">üü£</span>
                      <div>
                        <div className="font-semibold theme-text-primary">Claude</div>
                        <div className="text-xs theme-text-muted">Anthropic</div>
                      </div>
                    </div>
                  </button>
                  <button
                    onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, provider: 'gemini' })}
                    className={`p-4 rounded-lg border-2 transition-all text-left ${
                      aiIntegration.aiSettings.provider === 'gemini'
                        ? 'bg-blue-600/20 border-blue-500'
                        : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      <span className="text-xl">üîµ</span>
                      <div>
                        <div className="font-semibold theme-text-primary">Gemini</div>
                        <div className="text-xs theme-text-muted">Google</div>
                      </div>
                    </div>
                  </button>
                </div>

                {/* Model Selection based on provider */}
                <div className="mt-3">
                  <label className="block text-xs theme-text-muted mb-1">
                    Modelo {aiIntegration.aiSettings.provider === 'gemini' ? 'Gemini' : 'Claude'}:
                  </label>
                  {aiIntegration.aiSettings.provider === 'gemini' ? (
                    <select
                      value={aiIntegration.aiSettings.geminiModel || 'gemini-3-flash-preview'}
                      onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, geminiModel: e.target.value })}
                      className="w-full px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                    >
                      {/* v1.32.36: Removido Gemini 2.5, apenas Gemini 3 */}
                      <option value="gemini-3-flash-preview">Gemini 3 Flash ($0.50/$3.00 por 1M)</option>
                      <option value="gemini-3-pro-preview">Gemini 3 Pro ($2.00/$12 por 1M)</option>
                    </select>
                  ) : (
                    <select
                      value={aiIntegration.aiSettings.claudeModel || 'claude-sonnet-4-20250514'}
                      onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, claudeModel: e.target.value, model: e.target.value })}
                      className="w-full px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                    >
                      <option value="claude-sonnet-4-20250514">Sonnet 4.5 ($3/$15 por 1M)</option>
                      <option value="claude-opus-4-5-20251101">Opus 4.5 ($15/$75 por 1M)</option>
                    </select>
                  )}
                </div>
              </div>

              {/* v1.30: API Keys */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Chaves API <span className="text-xs font-normal theme-text-muted">(armazenadas localmente)</span>
                </label>
                <div className="space-y-3">
                  {/* Claude API Key */}
                  <div>
                    <label className="block text-xs theme-text-muted mb-1">Anthropic (Claude):</label>
                    <div className="flex gap-2">
                      <input
                        type="password"
                        value={aiIntegration.aiSettings.apiKeys?.claude || ''}
                        onChange={(e) => aiIntegration.setAiSettings({
                          ...aiIntegration.aiSettings,
                          apiKeys: { ...aiIntegration.aiSettings.apiKeys, claude: e.target.value }
                        })}
                        placeholder="sk-ant-..."
                        className="flex-1 px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                      />
                      <button
                        onClick={async () => {
                          setClaudeTestStatus('testing');
                          try {
                            const resp = await fetch(`${API_BASE}/api/claude/messages`, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json', 'x-api-key': aiIntegration.aiSettings.apiKeys?.claude || '' },
                              body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 10, messages: [{ role: 'user', content: 'Ol√°' }] })
                            });
                            setClaudeTestStatus(resp.ok ? 'ok' : 'error');
                          } catch { setClaudeTestStatus('error'); }
                          setTimeout(() => setClaudeTestStatus(null), 2000);
                        }}
                        disabled={claudeTestStatus === 'testing'}
                        className={`px-3 py-2 text-white rounded text-sm min-w-[60px] transition-colors ${
                          claudeTestStatus === 'ok' ? 'bg-green-600' :
                          claudeTestStatus === 'error' ? 'bg-red-600' :
                          'bg-purple-600 hover:bg-purple-700'
                        }`}
                      >
                        {claudeTestStatus === 'testing' ? '...' :
                         claudeTestStatus === 'ok' ? '‚úì' :
                         claudeTestStatus === 'error' ? '‚úó' : 'Testar'}
                      </button>
                    </div>
                  </div>
                  {/* Gemini API Key */}
                  <div>
                    <label className="block text-xs theme-text-muted mb-1">Google (Gemini):</label>
                    <div className="flex gap-2">
                      <input
                        type="password"
                        value={aiIntegration.aiSettings.apiKeys?.gemini || ''}
                        onChange={(e) => aiIntegration.setAiSettings({
                          ...aiIntegration.aiSettings,
                          apiKeys: { ...aiIntegration.aiSettings.apiKeys, gemini: e.target.value }
                        })}
                        placeholder="AIza..."
                        className="flex-1 px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                      />
                      <button
                        onClick={async () => {
                          setGeminiTestStatus('testing');
                          try {
                            const resp = await fetch(`${API_BASE}/api/gemini/generate`, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                model: 'gemini-3-flash-preview',
                                apiKey: aiIntegration.aiSettings.apiKeys?.gemini || '',
                                request: { contents: [{ role: 'user', parts: [{ text: 'Ol√°' }] }], generationConfig: { maxOutputTokens: 100, thinking_config: { thinking_level: 'minimal' } } }
                              })
                            });
                            setGeminiTestStatus(resp.ok ? 'ok' : 'error');
                          } catch { setGeminiTestStatus('error'); }
                          setTimeout(() => setGeminiTestStatus(null), 2000);
                        }}
                        disabled={geminiTestStatus === 'testing'}
                        className={`px-3 py-2 text-white rounded text-sm min-w-[60px] transition-colors ${
                          geminiTestStatus === 'ok' ? 'bg-green-600' :
                          geminiTestStatus === 'error' ? 'bg-red-600' :
                          'bg-blue-600 hover:bg-blue-700'
                        }`}
                      >
                        {geminiTestStatus === 'testing' ? '...' :
                         geminiTestStatus === 'ok' ? '‚úì' :
                         geminiTestStatus === 'error' ? '‚úó' : 'Testar'}
                      </button>
                    </div>
                  </div>
                </div>
                <p className="text-xs theme-text-muted mt-2">
                  As chaves s√£o armazenadas apenas no seu navegador (localStorage). Nunca s√£o enviadas para servidores externos.
                </p>
              </div>

              {/* Pensamento Prolongado - ADAPTADO POR PROVIDER */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Pensamento Prolongado (Extended Thinking)
                </label>

                {/* v1.32.36: CLAUDE: Toggle + Budget num√©rico */}
                {aiIntegration.aiSettings.provider === 'claude' && (
                  <>
                    <button
                      onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, useExtendedThinking: !aiIntegration.aiSettings.useExtendedThinking })}
                      className={`w-full p-4 rounded-lg border-2 transition-all text-left ${
                        aiIntegration.aiSettings.useExtendedThinking
                          ? 'bg-purple-600/20 border-purple-500'
                          : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className={CSS.flexGap2}>
                            <span className="font-semibold theme-text-primary">
                              {aiIntegration.aiSettings.useExtendedThinking ? '‚úì Ativado' : 'Desativado'}
                            </span>
                            {aiIntegration.aiSettings.useExtendedThinking && (
                              <span className="text-xs bg-purple-500 text-white px-2 py-0.5 rounded">+{parseInt(aiIntegration.aiSettings.thinkingBudget || '10000')/1000}k tokens</span>
                            )}
                          </div>
                          <p className="text-xs theme-text-muted mt-1">
                            {aiIntegration.aiSettings.useExtendedThinking
                              ? `A IA usar√° at√© ${(parseInt(aiIntegration.aiSettings.thinkingBudget || '10000')/1000).toFixed(0)}K tokens extras para pensar antes de responder.`
                              : 'A IA responder√° mais rapidamente, com an√°lise padr√£o.'
                            }
                          </p>
                        </div>
                        <div className={`w-12 h-6 rounded-full transition-colors relative ${
                          aiIntegration.aiSettings.useExtendedThinking ? 'bg-purple-500' : 'theme-bg-tertiary'
                        }`}>
                          <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${
                            aiIntegration.aiSettings.useExtendedThinking ? 'translate-x-7' : 'translate-x-1'
                          }`}></div>
                        </div>
                      </div>
                    </button>

                    {aiIntegration.aiSettings.useExtendedThinking && (
                      <div className="mt-3 pl-4">
                        <label className="block text-xs theme-text-muted mb-1">Budget de Pensamento:</label>
                        <select
                          value={aiIntegration.aiSettings.thinkingBudget || '10000'}
                          onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, thinkingBudget: e.target.value })}
                          className="w-full px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                        >
                          {/* v1.32.32: Op√ß√µes din√¢micas por modelo Claude */}
                          {(aiIntegration.aiSettings.claudeModel || aiIntegration.aiSettings.model)?.includes('opus') ? (
                            <>
                              <option value="10000">10K tokens (Padr√£o)</option>
                              <option value="20000">20K tokens (Recomendado)</option>
                              <option value="30000">30K tokens (M√°ximo Opus)</option>
                            </>
                          ) : (
                            <>
                              <option value="10000">10K tokens (Padr√£o)</option>
                              <option value="20000">20K tokens (Recomendado)</option>
                              <option value="40000">40K tokens (Alta qualidade)</option>
                              <option value="62000">62K tokens (M√°ximo Sonnet)</option>
                            </>
                          )}
                        </select>
                        {/* v1.32.33: Warning para budgets altos (timeout aumentado para 5 min) */}
                        {parseInt(aiIntegration.aiSettings.thinkingBudget || '10000') >= 40000 && (
                          <p className="text-xs text-amber-400 mt-1">
                            ‚ö†Ô∏è Respostas podem demorar mais com budgets altos
                          </p>
                        )}
                      </div>
                    )}
                  </>
                )}

                {/* v1.32.36: GEMINI 3: Dropdown de thinking_level (sempre ativo, n√£o pode desativar) */}
                {aiIntegration.aiSettings.provider === 'gemini' && (
                  <div className="p-4 rounded-lg border-2 border-amber-500/50 bg-amber-500/10">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-amber-400">‚ö†Ô∏è</span>
                      <span className="font-semibold theme-text-primary">Gemini 3 sempre usa Thinking</span>
                    </div>
                    <p className="text-xs theme-text-muted mb-3">
                      O Gemini 3 n√£o permite desativar o pensamento prolongado. Escolha o n√≠vel de profundidade:
                    </p>
                    <select
                      value={aiIntegration.aiSettings.geminiThinkingLevel || 'high'}
                      onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, geminiThinkingLevel: e.target.value })}
                      className="w-full px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                    >
                      {aiIntegration.aiSettings.geminiModel?.includes('flash') && (
                        <option value="minimal">Minimal (mais r√°pido, menos preciso)</option>
                      )}
                      <option value="low">Low (equil√≠brio velocidade/qualidade)</option>
                      {aiIntegration.aiSettings.geminiModel?.includes('flash') && (
                        <option value="medium">Medium (recomendado)</option>
                      )}
                      <option value="high">High (mais lento, mais preciso)</option>
                    </select>
                    <p className="text-xs theme-text-muted mt-2">
                      {aiIntegration.aiSettings.geminiModel?.includes('pro')
                        ? 'üí° Gemini 3 Pro suporta apenas Low e High'
                        : 'üí° Gemini 3 Flash suporta todos os n√≠veis'
                      }
                    </p>
                  </div>
                )}

                {/* v1.32.40: Log Thinking no Console */}
                <label className="flex items-center gap-3 p-3 rounded-lg theme-bg-secondary-30 border theme-border-input cursor-pointer hover:theme-bg-secondary transition-colors">
                  <input
                    type="checkbox"
                    checked={aiIntegration.aiSettings.logThinking || false}
                    onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, logThinking: e.target.checked })}
                    className="w-4 h-4 rounded border-gray-300 text-blue-500 focus:ring-blue-500"
                  />
                  <div className="flex-1">
                    <span className="font-medium theme-text-primary text-sm">Log thinking no console</span>
                    <p className="text-xs theme-text-muted mt-0.5">Exibe o racioc√≠nio da IA no console do navegador (F12) para debug</p>
                  </div>
                </label>
              </div>

              {/* N√≠vel de Detalhe nos Mini-Relat√≥rios */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">N√≠vel de Detalhe nos Mini-Relat√≥rios</label>
                <button
                  onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, detailedMiniReports: !aiIntegration.aiSettings.detailedMiniReports })}
                  className={`w-full p-4 rounded-lg border-2 transition-all text-left ${
                    aiIntegration.aiSettings.detailedMiniReports
                      ? 'bg-green-600/20 border-green-500'
                      : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                  }`}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className={CSS.flexGap2}>
                        <span className="font-semibold theme-text-primary">
                          {aiIntegration.aiSettings.detailedMiniReports ? '‚úì Ativado' : 'Desativado'}
                        </span>
                        {aiIntegration.aiSettings.detailedMiniReports && (
                          <span className="text-xs bg-green-500 text-white px-2 py-0.5 rounded">Alto Detalhe</span>
                        )}
                      </div>
                      <p className="text-xs theme-text-muted mt-1">
                        {aiIntegration.aiSettings.detailedMiniReports
                          ? 'Os mini-relat√≥rios ser√£o gerados com descri√ß√£o f√°tica detalhada, incluindo mais informa√ß√µes sobre os fatos alegados pelas partes (postulat√≥rios e defensivos).'
                          : 'Os mini-relat√≥rios ser√£o gerados com n√≠vel de detalhe padr√£o. Recomendado para a maioria dos casos.'
                        }
                      </p>
                    </div>
                    <div className={`w-12 h-6 rounded-full transition-colors relative ${
                      aiIntegration.aiSettings.detailedMiniReports ? 'bg-green-500' : 'theme-bg-tertiary'
                    }`}>
                      <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${
                        aiIntegration.aiSettings.detailedMiniReports ? 'translate-x-7' : 'translate-x-1'
                      }`}></div>
                    </div>
                  </div>
                </button>
              </div>

              {/* v1.14.1: T√≥picos por Requisi√ß√£o */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">T√≥picos por Requisi√ß√£o</label>
                <div className="flex items-center justify-between p-4 rounded-lg theme-bg-secondary-30 theme-border-input border-2">
                  <div className="flex-1">
                    <p className="text-sm theme-text-primary font-medium">Quantos mini-relat√≥rios gerar por chamada √† API</p>
                    <p className="text-xs theme-text-muted mt-1">
                      Mais t√≥picos = menos chamadas = mais r√°pido. "Todos" usa 1 requisi√ß√£o com limite maior (48K tokens).
                    </p>
                  </div>
                  <select
                    value={aiIntegration.aiSettings.topicsPerRequest || 1}
                    onChange={(e) => {
                      const val = e.target.value;
                      aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, topicsPerRequest: val === 'all' ? 'all' : parseInt(val) });
                    }}
                    className="ml-4 px-3 py-2 rounded-lg theme-bg-primary theme-text-primary theme-border-input border text-sm font-medium"
                  >
                    <option value={1}>1 (padr√£o)</option>
                    <option value={3}>3 t√≥picos</option>
                    <option value={5}>5 t√≥picos</option>
                    <option value="all">Todos (1 requisi√ß√£o)</option>
                  </select>
                </div>
              </div>

              {/* v1.33.11: Requisi√ß√µes Paralelas */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">Requisi√ß√µes Paralelas</label>
                <div className="flex items-center justify-between p-4 rounded-lg theme-bg-secondary-30 theme-border-input border-2">
                  <div className="flex-1">
                    <p className="text-sm theme-text-primary font-medium">Quantas requisi√ß√µes enviar simultaneamente</p>
                    <p className="text-xs theme-text-muted mt-1">
                      Mais paralelas = mais r√°pido, mas pode causar erro 429 se exceder limite da API.
                    </p>
                  </div>
                  <select
                    value={aiIntegration.aiSettings.parallelRequests || 5}
                    onChange={(e) => {
                      aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, parallelRequests: parseInt(e.target.value) });
                    }}
                    className="ml-4 px-3 py-2 rounded-lg theme-bg-primary theme-text-primary theme-border-input border text-sm font-medium"
                  >
                    <option value={3}>3 (Conservador)</option>
                    <option value={5}>5 (Padr√£o)</option>
                    <option value={10}>10 (R√°pido)</option>
                    <option value={15}>15 (Alto volume)</option>
                    <option value={20}>20 (M√°ximo)</option>
                  </select>
                </div>
                {/* Texto explicativo com limites */}
                <div className="mt-2 p-3 rounded-lg theme-bg-tertiary text-xs theme-text-muted">
                  <p className="font-semibold theme-text-secondary mb-1">Limites por API (RPM = requisi√ß√µes/minuto):</p>
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <span className="text-purple-400 font-medium">Claude:</span>
                      <ul className="ml-2 mt-0.5 space-y-0.5">
                        <li>‚Ä¢ Tier 1 ($5): 50 RPM ‚Üí usar 3-5</li>
                        <li>‚Ä¢ Tier 2+ ($40+): 1000+ RPM ‚Üí 10-15</li>
                      </ul>
                    </div>
                    <div>
                      <span className="text-blue-400 font-medium">Gemini:</span>
                      <ul className="ml-2 mt-0.5 space-y-0.5">
                        <li>‚Ä¢ Free: 5-10 RPM ‚Üí usar 3</li>
                        <li>‚Ä¢ Pago: 300+ RPM ‚Üí 10-20</li>
                      </ul>
                    </div>
                  </div>
                  <p className="mt-2 text-orange-600 dark:text-orange-300 font-medium">‚ö†Ô∏è Erro 429 = limite excedido. Reduza o valor.</p>
                </div>
              </div>

              {/* v1.12.25: Modo de Processamento de PDF (PDF Puro | Extrair Texto ‚Üí PDF.js | Claude Vision) */}
              {/* Nota: "Extra√ß√£o Autom√°tica de Texto de PDFs" foi removido por ser redundante */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Modo de Processamento de PDF
                </label>
                <div className="space-y-3">
                  {/* Op√ß√£o 1: PDF Puro */}
                  <button
                    onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, ocrEngine: 'pdf-puro' })}
                    className={`w-full p-3 rounded-lg border-2 transition-all text-left ${
                      aiIntegration.aiSettings.ocrEngine === 'pdf-puro'
                        ? 'bg-stone-600/20 border-stone-500'
                        : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                    }`}
                  >
                    <div className="flex items-start gap-3">
                      <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                        aiIntegration.aiSettings.ocrEngine === 'pdf-puro'
                          ? 'border-stone-500 bg-stone-500'
                          : 'theme-border'
                      }`}>
                        {aiIntegration.aiSettings.ocrEngine === 'pdf-puro' && (
                          <div className="w-2 h-2 bg-white rounded-full"></div>
                        )}
                      </div>
                      <div className="flex-1">
                        <span className="font-semibold theme-text-primary text-sm">PDF Puro (Bin√°rio)</span>
                        <p className="text-xs theme-text-muted mt-1">
                          Envia o PDF como arquivo bin√°rio, sem extra√ß√£o de texto. Usa mais tokens mas preserva 100% do documento.
                        </p>
                      </div>
                    </div>
                  </button>

                  {/* Op√ß√£o 2: Extrair Texto */}
                  <button
                    onClick={() => {
                      // Se n√£o estava em modo extra√ß√£o, muda para pdfjs (padr√£o)
                      if (aiIntegration.aiSettings.ocrEngine === 'pdf-puro') {
                        aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, ocrEngine: 'pdfjs' });
                      }
                    }}
                    className={`w-full p-3 rounded-lg border-2 transition-all text-left ${
                      ['pdfjs', 'tesseract', 'claude-vision'].includes(aiIntegration.aiSettings.ocrEngine)
                        ? 'bg-blue-600/20 border-blue-500'
                        : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                    }`}
                  >
                    <div className="flex items-start gap-3">
                      <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                        ['pdfjs', 'tesseract', 'claude-vision'].includes(aiIntegration.aiSettings.ocrEngine)
                          ? 'border-blue-500 bg-blue-500'
                          : 'theme-border'
                      }`}>
                        {['pdfjs', 'tesseract', 'claude-vision'].includes(aiIntegration.aiSettings.ocrEngine) && (
                          <div className="w-2 h-2 bg-white rounded-full"></div>
                        )}
                      </div>
                      <div className="flex-1">
                        <div className={CSS.flexGap2}>
                          <span className="font-semibold theme-text-primary text-sm">Extrair Texto</span>
                          <span className="text-xs bg-green-500 text-white px-2 py-0.5 rounded">Recomendado</span>
                        </div>
                        <p className="text-xs theme-text-muted mt-1">
                          Extrai o texto do PDF antes de enviar. Economiza tokens e permite busca no texto.
                        </p>
                      </div>
                    </div>
                  </button>

                  {/* Sub-op√ß√µes de extra√ß√£o (s√≥ aparece se "Extrair Texto" selecionado) */}
                  {['pdfjs', 'tesseract', 'claude-vision'].includes(aiIntegration.aiSettings.ocrEngine) && (
                    <div className="ml-4 border-l-2 border-blue-500/30 pl-4 space-y-3">
                      <p className="text-xs font-semibold theme-text-blue mb-2">M√©todo de extra√ß√£o:</p>

                      {/* Sub-op√ß√£o: PDF.js */}
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, ocrEngine: 'pdfjs' })}
                        className={`w-full p-3 rounded-lg border-2 transition-all text-left ${
                          aiIntegration.aiSettings.ocrEngine === 'pdfjs'
                            ? 'bg-green-600/20 border-green-500'
                            : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                        }`}
                      >
                        <div className="flex items-start gap-3">
                          <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                            aiIntegration.aiSettings.ocrEngine === 'pdfjs'
                              ? 'border-green-500 bg-green-500'
                              : 'theme-border'
                          }`}>
                            {aiIntegration.aiSettings.ocrEngine === 'pdfjs' && (
                              <div className="w-2 h-2 bg-white rounded-full"></div>
                            )}
                          </div>
                          <div className="flex-1">
                            <div className={CSS.flexGap2}>
                              <span className="font-semibold theme-text-primary text-sm">PDF.js - Padr√£o</span>
                              <span className="text-xs bg-green-500 text-white px-2 py-0.5 rounded">Gratuito</span>
                            </div>
                            <p className="text-xs theme-text-muted mt-1">
                              ‚úÖ R√°pido e gratuito | ‚ö†Ô∏è N√£o funciona com PDFs escaneados (imagens)
                            </p>
                          </div>
                        </div>
                      </button>

                      {/* Sub-op√ß√£o: Tesseract OCR */}
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, ocrEngine: 'tesseract' })}
                        className={`w-full p-3 rounded-lg border-2 transition-all text-left ${
                          aiIntegration.aiSettings.ocrEngine === 'tesseract'
                            ? 'bg-cyan-600/20 border-cyan-500'
                            : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                        }`}
                      >
                        <div className="flex items-start gap-3">
                          <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                            aiIntegration.aiSettings.ocrEngine === 'tesseract'
                              ? 'border-cyan-500 bg-cyan-500'
                              : 'theme-border'
                          }`}>
                            {aiIntegration.aiSettings.ocrEngine === 'tesseract' && (
                              <div className="w-2 h-2 bg-white rounded-full"></div>
                            )}
                          </div>
                          <div className="flex-1">
                            <div className={CSS.flexGap2}>
                              <span className="font-semibold theme-text-primary text-sm">Tesseract OCR - Offline</span>
                              <span className="text-xs bg-cyan-500 text-white px-2 py-0.5 rounded">Gratuito</span>
                            </div>
                            <p className="text-xs theme-text-muted mt-1">
                              ‚úÖ 100% offline e gratuito | ‚úÖ Funciona com PDFs escaneados | ‚è±Ô∏è ~15-30s por p√°gina
                            </p>
                          </div>
                        </div>
                      </button>

                      {/* Sub-op√ß√£o: Claude Vision */}
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, ocrEngine: 'claude-vision' })}
                        className={`w-full p-3 rounded-lg border-2 transition-all text-left ${
                          aiIntegration.aiSettings.ocrEngine === 'claude-vision'
                            ? 'bg-purple-600/20 border-purple-500'
                            : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                        }`}
                      >
                        <div className="flex items-start gap-3">
                          <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                            aiIntegration.aiSettings.ocrEngine === 'claude-vision'
                              ? 'border-purple-500 bg-purple-500'
                              : 'theme-border'
                          }`}>
                            {aiIntegration.aiSettings.ocrEngine === 'claude-vision' && (
                              <div className="w-2 h-2 bg-white rounded-full"></div>
                            )}
                          </div>
                          <div className="flex-1">
                            <div className={CSS.flexGap2}>
                              <span className="font-semibold theme-text-primary text-sm">Claude Vision - OCR Avan√ßado</span>
                              <span className="text-xs bg-yellow-500 text-stone-900 px-2 py-0.5 rounded">API</span>
                            </div>
                            <p className="text-xs theme-text-muted mt-1">
                              üí∞ ~$0.04/10 p√°ginas | ‚úÖ Funciona com PDFs escaneados | ‚è±Ô∏è ~3-8s por p√°gina
                            </p>
                          </div>
                        </div>
                      </button>

                      {/* Aviso de custo para Claude Vision */}
                      {aiIntegration.aiSettings.ocrEngine === 'claude-vision' && (
                        <div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3">
                          <div className="flex items-start gap-2">
                            <AlertCircle className="w-4 h-4 text-yellow-500 flex-shrink-0 mt-0.5" />
                            <div className="flex-1">
                              <p className="text-xs font-semibold text-yellow-500 mb-1">Aten√ß√£o: Consumo de Tokens</p>
                              <ul className="text-xs theme-text-tertiary space-y-1">
                                <li>‚Ä¢ ~100-500 tokens/p√°gina (entrada) + ~100-300 tokens/p√°gina (sa√≠da)</li>
                                <li>‚Ä¢ Estimativa: ~$0.04 USD para 10 p√°ginas</li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* v1.16.0: Anonimiza√ß√£o de Documentos */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">Anonimiza√ß√£o de Documentos</label>
                {!['pdfjs', 'tesseract'].includes(aiIntegration.aiSettings.ocrEngine) ? (
                  <div className="p-4 rounded-lg bg-stone-700/30 border border-stone-600/50">
                    <div className="flex items-start gap-3">
                      <span className="text-xl">üîí</span>
                      <div>
                        <p className="text-sm font-medium theme-text-muted">Indispon√≠vel com o m√©todo atual</p>
                        <p className="text-xs theme-text-muted mt-1">
                          A anonimiza√ß√£o s√≥ funciona com extra√ß√£o via PDF.js ou Tesseract. Com "{aiIntegration.aiSettings.ocrEngine === 'pdf-puro' ? 'PDF Puro' : 'Claude Vision'}", o documento j√° √© enviado √† IA antes da anonimiza√ß√£o.
                        </p>
                      </div>
                    </div>
                  </div>
                ) : (
                  <>
                    <button
                      onClick={() => aiIntegration.setAiSettings({
                        ...aiIntegration.aiSettings,
                        anonymization: { ...aiIntegration.aiSettings.anonymization, enabled: !aiIntegration.aiSettings.anonymization?.enabled }
                      })}
                      className={`w-full p-4 rounded-lg border-2 transition-all text-left ${
                        aiIntegration.aiSettings.anonymization?.enabled
                          ? 'bg-amber-600/20 border-amber-500'
                          : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className={CSS.flexGap2}>
                            <span className="text-xl">üîí</span>
                            <span className="font-semibold theme-text-primary">
                              {aiIntegration.aiSettings.anonymization?.enabled ? '‚úì Ativada' : 'Desativada'}
                            </span>
                          </div>
                          <p className="text-xs theme-text-muted mt-1">
                            {aiIntegration.aiSettings.anonymization?.enabled
                              ? 'Dados sens√≠veis ser√£o removidos do texto antes do envio √† IA (CPF, RG, telefones, etc.)'
                              : 'O texto ser√° enviado √† IA sem modifica√ß√µes.'
                            }
                          </p>
                        </div>
                        <div className={`w-12 h-6 rounded-full transition-colors relative ${
                          aiIntegration.aiSettings.anonymization?.enabled ? 'bg-amber-500' : 'theme-bg-tertiary'
                        }`}>
                          <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${
                            aiIntegration.aiSettings.anonymization?.enabled ? 'translate-x-7' : 'translate-x-1'
                          }`}></div>
                        </div>
                      </div>
                    </button>

                    {aiIntegration.aiSettings.anonymization?.enabled && (
                      <div className="mt-3 p-4 rounded-lg theme-bg-secondary-30 border theme-border-input">
                        <p className="text-xs font-semibold theme-text-muted mb-3">Tipos de dados a anonimizar:</p>
                        <div className="grid grid-cols-2 gap-2">
                          {[
                            { key: 'cpf', label: 'CPF' },
                            { key: 'rg', label: 'RG' },
                            { key: 'pis', label: 'PIS/PASEP' },
                            { key: 'ctps', label: 'CTPS' },
                            { key: 'telefone', label: 'Telefones' },
                            { key: 'email', label: 'E-mails' },
                            { key: 'contaBancaria', label: 'Dados Banc√°rios' },
                            { key: 'processo', label: 'N¬∫ Processo (CNJ)' },
                            { key: 'valores', label: 'Valores (R$)' },
                            { key: 'nomes', label: 'Nomes das Partes' }
                          ].map(({ key, label }) => (
                            <label key={key} className="flex items-center gap-2 text-xs theme-text-secondary cursor-pointer">
                              <input
                                type="checkbox"
                                checked={aiIntegration.aiSettings.anonymization?.[key] !== false}
                                onChange={(e) => aiIntegration.setAiSettings({
                                  ...aiIntegration.aiSettings,
                                  anonymization: { ...aiIntegration.aiSettings.anonymization, [key]: e.target.checked }
                                })}
                                className="w-4 h-4 rounded border-gray-500 text-amber-500 focus:ring-amber-500"
                              />
                              {label}
                            </label>
                          ))}
                        </div>
                        <p className="text-xs theme-text-muted mt-3 italic">
                          Valores (R$) est√° desativado por padr√£o pois s√£o relevantes para an√°lise de pedidos.
                        </p>

                        {/* v1.32.00: IA Local - Detec√ß√£o de Nomes (NER) - Simplificado (download autom√°tico) */}
                        <div className="border-t theme-border-secondary pt-4 mt-4">
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <span className="text-sm font-medium theme-text-primary">üß† Detec√ß√£o Autom√°tica de Nomes</span>
                              <span className="text-xs bg-purple-500/20 text-purple-600 dark:text-purple-400 px-2 py-0.5 rounded">IA Local</span>
                            </div>
                            <div
                              className={`toggle-switch ${nerEnabled ? 'active' : ''}`}
                              onClick={async () => {
                                const newVal = !nerEnabled;
                                setNerEnabled(newVal);
                                localStorage.setItem('nerEnabled', JSON.stringify(newVal));
                                // v1.32.17: NER agora √© carregado sob demanda (ao clicar "Detectar Nomes")
                                // Removido auto-init para economizar ~2GB de RAM
                                if (!newVal && nerModelReady) {
                                  // Descarregar ao desativar
                                  await AIModelService.unload('ner');
                                  setNerModelReady(false);
                                }
                              }}
                            >
                              <div className="toggle-knob"></div>
                            </div>
                          </div>

                          {nerEnabled && (
                            <div className="theme-bg-tertiary rounded-lg p-3 border theme-border-input">
                              <p className="text-xs theme-text-muted mb-3">
                                Modelo NER multil√≠ngue - baixado automaticamente do HuggingFace (~150MB).
                              </p>
                              <div className="space-y-2 mb-3">
                                <div className="flex items-center justify-between">
                                  <div className="flex items-center gap-2">
                                    {nerModelReady ? (
                                      <span className="flex items-center gap-1.5 text-xs text-green-600 dark:text-green-400">
                                        <Check className="w-4 h-4" />
                                        <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                                        Pronto
                                      </span>
                                    ) : nerInitializing ? (
                                      <span className="flex items-center gap-1.5 text-xs text-blue-400">
                                        <RefreshCw className="w-4 h-4 animate-spin" />
                                        Baixando modelo... {nerDownloadProgress > 0 && `${nerDownloadProgress}%`}
                                      </span>
                                    ) : (
                                      <button
                                        onClick={initNerModel}
                                        className="flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-xs font-medium"
                                      >
                                        <Download className="w-3 h-3" />
                                        Baixar Agora (~150MB)
                                      </button>
                                    )}
                                  </div>
                                  {nerModelReady && (
                                    <button
                                      onClick={() => AIModelService.unload('ner').then(() => setNerModelReady(false))}
                                      className="text-xs text-red-400 hover:text-red-300"
                                      title="Descarregar modelo da mem√≥ria"
                                    >
                                      <X className="w-4 h-4" />
                                    </button>
                                  )}
                                </div>
                                {nerInitializing && nerDownloadProgress > 0 && (
                                  <div className="h-1.5 bg-gray-600 rounded-full overflow-hidden">
                                    <div className="h-full bg-purple-500 transition-all duration-300" style={{ width: `${nerDownloadProgress}%` }} />
                                  </div>
                                )}
                              </div>

                              {/* v1.29: Toggle para incluir empresas (ORG) */}
                              <div className="pt-3 border-t theme-border-secondary">
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <div
                                    className={`toggle-switch ${nerIncludeOrg ? 'active' : ''}`}
                                    onClick={() => {
                                      const newVal = !nerIncludeOrg;
                                      setNerIncludeOrg(newVal);
                                      localStorage.setItem('nerIncludeOrg', JSON.stringify(newVal));
                                    }}
                                  >
                                    <div className="toggle-knob"></div>
                                  </div>
                                  <span className="text-xs theme-text-secondary">
                                    Incluir empresas (reclamadas)
                                  </span>
                                </label>
                                <p className="text-xs theme-text-muted mt-1 ml-10">
                                  Detecta nomes de empresas (ORG) com score ‚â• 90%. Filtra tribunais e √≥rg√£os p√∫blicos.
                                </p>
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </>
                )}
              </div>

              {/* v1.33.61: Base de Dados - Legisla√ß√£o e Jurisprud√™ncia */}
              <div className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input">
                <div className="flex items-center justify-between">
                  <label className="flex items-center gap-2 text-sm font-medium theme-text-tertiary">
                    üìö Base de Dados
                    <span className="text-xs theme-text-muted">
                      ({legislacao.artigos?.length || 0} artigos, {jurisprudencia.precedentes?.length || 0} precedentes)
                    </span>
                  </label>
                  <button
                    onClick={async () => {
                      // Re-verificar IndexedDB diretamente (n√£o usar cache)
                      const legNeeded = await EmbeddingsCDNService.needsDataDownload('legislacao');
                      const jurisNeeded = await EmbeddingsCDNService.needsDataDownload('jurisprudencia');
                      setDataDownloadStatus({
                        legislacao: { needed: legNeeded, downloading: false, progress: 0, error: null, completed: false },
                        jurisprudencia: { needed: jurisNeeded, downloading: false, progress: 0, error: null, completed: false }
                      });
                      localStorage.removeItem('dismissedDataPrompt');
                      setShowDataDownloadModal(true);
                    }}
                    className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors"
                  >
                    <Download className="w-3 h-3" /> Baixar/Atualizar
                  </button>
                </div>
              </div>

              {/* v1.28.00: Busca Sem√¢ntica - Toggle MASTER + Sub-toggles independentes */}
              <div className="space-y-4">
                {/* Toggle Master - Controla carregamento do modelo E5 */}
                <div className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input">
                  <div className="flex items-center justify-between mb-3">
                    <label className="flex items-center gap-2 text-sm font-medium theme-text-tertiary">
                      üß† IA Local (Busca Sem√¢ntica)
                      <span className="text-xs bg-blue-500/20 text-blue-600 dark:text-blue-400 px-2 py-0.5 rounded">E5-base</span>
                    </label>
                    <div
                      className={`toggle-switch ${searchEnabled ? 'active' : ''}`}
                      onClick={() => handleSearchToggle(!searchEnabled)}
                    >
                      <div className="toggle-knob"></div>
                    </div>
                  </div>

                  {searchEnabled && (
                    <div className="space-y-3">
                      <p className="text-xs theme-text-muted">
                        Modelo E5-base multilingual - baixado automaticamente do HuggingFace na primeira vez (~400MB)
                      </p>

                      {/* v1.32.00: Status do modelo E5 */}
                      <div className="theme-bg-tertiary rounded-lg p-3 border theme-border-input space-y-2">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            {searchModelReady ? (
                              <span className="flex items-center gap-1.5 text-xs text-green-600 dark:text-green-400">
                                <Check className="w-4 h-4" />
                                <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                                Modelo Pronto
                              </span>
                            ) : searchInitializing ? (
                              <span className="flex items-center gap-1.5 text-xs text-blue-400">
                                <RefreshCw className="w-4 h-4 animate-spin" />
                                Baixando modelo... {searchDownloadProgress > 0 && `${searchDownloadProgress}%`}
                              </span>
                            ) : (
                              <button
                                onClick={initSearchModel}
                                className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors"
                              >
                                <Download className="w-3 h-3" />
                                Baixar Agora (~400MB)
                              </button>
                            )}
                          </div>
                          {searchModelReady && (
                            <button
                              onClick={() => AIModelService.unload('search').then(() => setSearchModelReady(false))}
                              className="text-xs text-red-400 hover:text-red-300"
                              title="Descarregar modelo da mem√≥ria"
                            >
                              <X className="w-4 h-4" />
                            </button>
                          )}
                        </div>
                        {searchInitializing && searchDownloadProgress > 0 && (
                          <div className="h-1.5 bg-gray-600 rounded-full overflow-hidden">
                            <div className="h-full bg-blue-500 transition-all duration-300" style={{ width: `${searchDownloadProgress}%` }} />
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                {/* Sub-toggles - S√≥ aparecem quando modelo E5 carregado */}
                {searchEnabled && searchModelReady && (
                  <div className="space-y-3 pl-4 border-l-2 border-blue-500/30">
                    {/* üìú Legisla√ß√£o */}
                    <div className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input">
                      <div className="flex items-center justify-between mb-2">
                        <label className="flex items-center gap-2 text-sm font-medium theme-text-tertiary">
                          üìú Legisla√ß√£o
                          <span className="text-xs theme-text-muted">({embeddingsCount} embeddings)</span>
                        </label>
                        <div className={`toggle-switch ${aiIntegration.aiSettings.semanticSearchEnabled ? 'active' : ''}`} onClick={() => handleLegislacaoToggle(!aiIntegration.aiSettings.semanticSearchEnabled)}>
                          <div className="toggle-knob"></div>
                        </div>
                      </div>

                      {aiIntegration.aiSettings.semanticSearchEnabled && (
                        <div className="space-y-3 pt-2 border-t theme-border-subtle">
                          <div className="flex items-center gap-2 flex-wrap">
                            {embeddingsCount === 0 ? (
                              <button onClick={() => setShowEmbeddingsDownloadModal(true)}
                                className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                                <Download className="w-3 h-3" /> Baixar do CDN
                              </button>
                            ) : (
                              <span className="text-xs text-green-500 flex items-center gap-1"><Check className="w-3 h-3" /> Instalado</span>
                            )}
                            {embeddingsCount > 0 && (<button onClick={clearEmbeddings} className="px-2 py-1.5 text-red-500 dark:text-red-400 text-xs"><Trash2 className="w-3 h-3" /></button>)}
                          </div>
                          <div className="flex items-center gap-3">
                            <span className="text-xs theme-text-muted">Threshold:</span>
                            <input type="range" min="20" max="80" value={aiIntegration.aiSettings.semanticThreshold} onChange={(e) => aiIntegration.setAiSettings(prev => ({ ...prev, semanticThreshold: Number(e.target.value) }))} className="flex-1 h-1.5 bg-gray-600 rounded-lg appearance-none cursor-pointer" />
                            <span className="text-xs theme-text-primary w-10 text-right">{aiIntegration.aiSettings.semanticThreshold}%</span>
                          </div>
                        </div>
                      )}
                    </div>

                    {/* üìö Jurisprud√™ncia */}
                    <div className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input">
                      <div className="flex items-center justify-between mb-2">
                        <label className="flex items-center gap-2 text-sm font-medium theme-text-tertiary">
                          üìö Jurisprud√™ncia
                          <span className="text-xs theme-text-muted">({jurisEmbeddingsCount} embeddings)</span>
                        </label>
                        <div className={`toggle-switch ${aiIntegration.aiSettings.jurisSemanticEnabled ? 'active' : ''}`} onClick={() => handleJurisToggle(!aiIntegration.aiSettings.jurisSemanticEnabled)}>
                          <div className="toggle-knob"></div>
                        </div>
                      </div>

                      {aiIntegration.aiSettings.jurisSemanticEnabled && (
                        <div className="space-y-3 pt-2 border-t theme-border-subtle">
                          <div className="flex items-center gap-2 flex-wrap">
                            {jurisEmbeddingsCount === 0 ? (
                              <button onClick={() => setShowEmbeddingsDownloadModal(true)}
                                className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                                <Download className="w-3 h-3" /> Baixar do CDN
                              </button>
                            ) : (
                              <span className="text-xs text-green-500 flex items-center gap-1"><Check className="w-3 h-3" /> Instalado</span>
                            )}
                            {jurisEmbeddingsCount > 0 && (<button onClick={clearJurisEmbeddings} className="px-2 py-1.5 text-red-500 dark:text-red-400 text-xs"><Trash2 className="w-3 h-3" /></button>)}
                          </div>
                          <div className="flex items-center gap-3">
                            <span className="text-xs theme-text-muted">Threshold:</span>
                            <input type="range" min="20" max="80" value={aiIntegration.aiSettings.jurisSemanticThreshold} onChange={(e) => aiIntegration.setAiSettings(prev => ({ ...prev, jurisSemanticThreshold: Number(e.target.value) }))} className="flex-1 h-1.5 bg-gray-600 rounded-lg appearance-none cursor-pointer" />
                            <span className="text-xs theme-text-primary w-10 text-right">{aiIntegration.aiSettings.jurisSemanticThreshold}%</span>
                          </div>
                          {/* v1.32.18: Toggle para usar IA Local nos editores */}
                          {jurisEmbeddingsCount > 0 && searchModelReady && (
                            <div className="flex items-center justify-between mt-3 pt-3 border-t theme-border-subtle">
                              <label className="text-xs theme-text-muted">ü§ñ Jurisprud√™ncia via IA Local<span className="block opacity-70">Busca sem√¢ntica nos editores</span></label>
                              <div className={`toggle-switch ${aiIntegration.aiSettings.useLocalAIForJuris ? 'active' : ''}`}
                                   onClick={() => aiIntegration.setAiSettings(prev => ({ ...prev, useLocalAIForJuris: !prev.useLocalAIForJuris }))}>
                                <div className="toggle-knob"></div>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>

                    {/* üì¶ Modelos */}
                    <div className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input">
                      <div className="flex items-center justify-between mb-2">
                        <label className="flex items-center gap-2 text-sm font-medium theme-text-tertiary">
                          üì¶ Modelos
                          <span className="text-xs theme-text-muted">({modelEmbeddingsCount}/{modelLibrary.models.length})</span>
                        </label>
                        <div className={`toggle-switch ${aiIntegration.aiSettings.modelSemanticEnabled ? 'active' : ''}`} onClick={() => handleModelToggle(!aiIntegration.aiSettings.modelSemanticEnabled)}>
                          <div className="toggle-knob"></div>
                        </div>
                      </div>

                      {aiIntegration.aiSettings.modelSemanticEnabled && (
                        <div className="space-y-3 pt-2 border-t theme-border-subtle">
                          <div className="flex items-center gap-2 flex-wrap">
                            <button onClick={generateModelEmbeddings} disabled={generatingModelEmbeddings}
                              className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${!generatingModelEmbeddings ? 'bg-purple-600 text-white hover-purple-700' : 'bg-gray-400 dark:bg-gray-600 text-gray-600 dark:text-gray-400 cursor-not-allowed'}`}>
                              {generatingModelEmbeddings ? (<><RefreshCw className="w-3 h-3 animate-spin" /> Gerando... {modelEmbeddingsProgress.current}/{modelEmbeddingsProgress.total}</>) : (<><Sparkles className="w-3 h-3" /> Gerar Embeddings</>)}
                            </button>
                            {modelEmbeddingsCount > 0 && (<button onClick={clearModelEmbeddings} className="px-2 py-1.5 text-red-500 dark:text-red-400 text-xs"><Trash2 className="w-3 h-3" /></button>)}
                          </div>
                          {generatingModelEmbeddings && modelEmbeddingsProgress.total > 0 && (
                            <div className="h-1.5 bg-gray-600 rounded-full overflow-hidden">
                              <div className="h-full bg-purple-500 transition-all duration-300" style={{ width: `${(modelEmbeddingsProgress.current / modelEmbeddingsProgress.total) * 100}%` }} />
                            </div>
                          )}
                          <div className="flex items-center gap-3">
                            <span className="text-xs theme-text-muted">Threshold:</span>
                            <input type="range" min="20" max="80" value={aiIntegration.aiSettings.modelSemanticThreshold} onChange={(e) => aiIntegration.setAiSettings(prev => ({ ...prev, modelSemanticThreshold: Number(e.target.value) }))} className="flex-1 h-1.5 bg-gray-600 rounded-lg appearance-none cursor-pointer" />
                            <span className="text-xs theme-text-primary w-10 text-right">{aiIntegration.aiSettings.modelSemanticThreshold}%</span>
                          </div>
                          {modelEmbeddingsCount > 0 && searchModelReady && (
                            <div className="flex items-center justify-between mt-3 pt-3 border-t theme-border-subtle">
                              <label className="text-xs theme-text-muted">ü§ñ Sugest√µes via IA Local<span className="block opacity-70">Busca sem√¢ntica instant√¢nea</span></label>
                              <div className={`toggle-switch ${aiIntegration.aiSettings.useLocalAIForSuggestions ? 'active' : ''}`}
                                   onClick={() => aiIntegration.setAiSettings(prev => ({ ...prev, useLocalAIForSuggestions: !prev.useLocalAIForSuggestions }))}>
                                <div className="toggle-knob"></div>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>

              {/* Modelo de Mini-Relat√≥rio */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Modelo de Mini-Relat√≥rio (Opcional)
                </label>
                <div className="space-y-3">
                  <textarea
                    value={aiIntegration.aiSettings.modeloRelatorio || ''}
                    onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloRelatorio: e.target.value })}
                    placeholder="Ex: O reclamante sustenta que [fatos]. Alega [argumentos]. Requer [pedido]. A reclamada, por sua vez, defende que [argumentos da defesa]."
                    className="w-full h-32 theme-bg-secondary-50 border-2 theme-border-input rounded-lg p-3 theme-text-primary text-sm focus:border-blue-500 focus:outline-none resize-none"
                  />
                  {/* v1.35.69: Bot√£o Gerar a partir de exemplos */}
                  <button
                    onClick={() => openModelGenerator('modeloRelatorio')}
                    className="flex items-center gap-2 px-3 py-1.5 text-xs bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 rounded-lg transition-colors"
                  >
                    <Wand2 className="w-3.5 h-3.5" />
                    Gerar a partir de exemplos
                  </button>
                  <p className="text-xs theme-text-muted flex items-start gap-2">
                    <FileText className="w-4 h-4 flex-shrink-0 mt-0.5 text-blue-400" />
                    <span>
                      Defina um modelo personalizado para os mini-relat√≥rios gerados automaticamente.
                      Se deixar vazio, ser√° usado o modelo padr√£o do sistema.
                    </span>
                  </p>
                  {aiIntegration.aiSettings.modeloRelatorio && (
                    <div className="flex items-center justify-between bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                      <div className="flex items-center gap-2 text-xs theme-text-green">
                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                        Modelo personalizado ativo ({aiIntegration.aiSettings.modeloRelatorio.length} caracteres)
                      </div>
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloRelatorio: '' })}
                        className="text-xs text-red-400 hover-text-red-300 underline"
                      >
                        Limpar
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Modelo de Dispositivo */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Modelo de Dispositivo (Opcional)
                </label>
                <div className="space-y-3">
                  <textarea
                    value={aiIntegration.aiSettings.modeloDispositivo || ''}
                    onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloDispositivo: e.target.value })}
                    placeholder="Ex: Ante o exposto, DECIDO: a) Julgar [resultado] o pedido de [t√≥pico]; b) Deferir/Indeferir [especifica√ß√£o]..."
                    className="w-full h-32 theme-bg-secondary-50 border-2 theme-border-input rounded-lg p-3 theme-text-primary text-sm focus:border-blue-500 focus:outline-none resize-none"
                  />
                  {/* v1.35.69: Bot√£o Gerar a partir de exemplos */}
                  <button
                    onClick={() => openModelGenerator('modeloDispositivo')}
                    className="flex items-center gap-2 px-3 py-1.5 text-xs bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 rounded-lg transition-colors"
                  >
                    <Wand2 className="w-3.5 h-3.5" />
                    Gerar a partir de exemplos
                  </button>
                  <p className="text-xs theme-text-muted flex items-start gap-2">
                    <Scale className="w-4 h-4 flex-shrink-0 mt-0.5 text-purple-400" />
                    <span>
                      Defina um modelo personalizado para o dispositivo da senten√ßa.
                      Se deixar vazio, ser√° usado o modelo padr√£o do sistema.
                    </span>
                  </p>
                  {aiIntegration.aiSettings.modeloDispositivo && (
                    <div className="flex items-center justify-between bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                      <div className="flex items-center gap-2 text-xs theme-text-green">
                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                        Modelo personalizado ativo ({aiIntegration.aiSettings.modeloDispositivo.length} caracteres)
                      </div>
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloDispositivo: '' })}
                        className="text-xs text-red-400 hover-text-red-300 underline"
                      >
                        Limpar
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Modelo do T√≥pico RELAT√ìRIO */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Modelo do T√≥pico RELAT√ìRIO (Opcional)
                </label>
                <div className="space-y-3">
                  <textarea
                    value={aiIntegration.aiSettings.modeloTopicoRelatorio || ''}
                    onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloTopicoRelatorio: e.target.value })}
                    placeholder='Ex: A presente reclama√ß√£o foi ajuizada em [data]. Realizou-se audi√™ncia em [data]. Foram juntados [documentos]. O processo encontra-se [situa√ß√£o].'
                    className="w-full h-32 theme-bg-secondary-50 border-2 theme-border-input rounded-lg p-3 theme-text-primary text-sm focus:border-blue-500 focus:outline-none resize-none"
                  />
                  {/* v1.35.69: Bot√£o Gerar a partir de exemplos */}
                  <button
                    onClick={() => openModelGenerator('modeloTopicoRelatorio')}
                    className="flex items-center gap-2 px-3 py-1.5 text-xs bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 rounded-lg transition-colors"
                  >
                    <Wand2 className="w-3.5 h-3.5" />
                    Gerar a partir de exemplos
                  </button>
                  <p className="text-xs theme-text-muted flex items-start gap-2">
                    <BookOpen className="w-4 h-4 flex-shrink-0 mt-0.5 text-green-400" />
                    <span>
                      Defina um modelo personalizado para o t√≥pico especial "RELAT√ìRIO" que resume o hist√≥rico processual. 
                      Se deixar vazio, ser√° usado o modelo padr√£o do sistema.
                    </span>
                  </p>
                  {aiIntegration.aiSettings.modeloTopicoRelatorio && (
                    <div className="flex items-center justify-between bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                      <div className="flex items-center gap-2 text-xs theme-text-green">
                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                        Modelo personalizado ativo ({aiIntegration.aiSettings.modeloTopicoRelatorio.length} caracteres)
                      </div>
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloTopicoRelatorio: '' })}
                        className="text-xs text-red-400 hover-text-red-300 underline"
                      >
                        Limpar
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Prompt Personalizado */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Estilo de Reda√ß√£o Personalizado (Opcional)
                </label>
                <div className="space-y-3">
                  <textarea
                    value={aiIntegration.aiSettings.customPrompt || ''}
                    onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, customPrompt: e.target.value })}
                    placeholder="Ex: Use linguagem mais coloquial, evite termos t√©cnicos em excesso, seja mais direto e objetivo, etc."
                    className="w-full h-32 theme-bg-secondary-50 border-2 theme-border-input rounded-lg p-3 theme-text-primary text-sm focus:border-blue-500 focus:outline-none resize-none"
                  />
                  <p className="text-xs theme-text-muted flex items-start gap-2">
                    <Sparkles className="w-4 h-4 flex-shrink-0 mt-0.5 text-purple-400" />
                    <span>
                      Defina instru√ß√µes adicionais para personalizar o estilo de reda√ß√£o da IA.
                      Estas instru√ß√µes ser√£o aplicadas em mini-relat√≥rios, no assistente de texto do editor e nos modelos.
                    </span>
                  </p>
                  {aiIntegration.aiSettings.customPrompt && (
                    <div className="flex items-center justify-between bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                      <div className="flex items-center gap-2 text-xs theme-text-green">
                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                        Estilo personalizado ativo ({aiIntegration.aiSettings.customPrompt.length} caracteres)
                      </div>
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, customPrompt: '' })}
                        className="text-xs text-red-400 hover-text-red-300 underline"
                      >
                        Limpar
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* v1.20.0: Prompts R√°pidos */}
              <div className="mt-6">
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  ‚ö° Prompts R√°pidos
                </label>
                <p className="text-xs theme-text-muted mb-3">
                  Atalhos para perguntas frequentes ao assistente IA. Clique para enviar instantaneamente.
                </p>
                <div className="space-y-2 mb-3">
                  {(aiIntegration.aiSettings.quickPrompts || []).map((qp, idx) => (
                    <div key={qp.id} className="flex items-start gap-2 p-2 theme-bg-secondary rounded-lg">
                      <input
                        value={qp.icon}
                        onChange={(e) => {
                          const updated = [...aiIntegration.aiSettings.quickPrompts];
                          updated[idx] = { ...updated[idx], icon: e.target.value };
                          aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, quickPrompts: updated });
                        }}
                        className="w-10 text-center theme-bg-app border theme-border-input rounded p-1 text-sm"
                        maxLength={2}
                        placeholder="üìù"
                      />
                      <input
                        value={qp.name}
                        onChange={(e) => {
                          const updated = [...aiIntegration.aiSettings.quickPrompts];
                          updated[idx] = { ...updated[idx], name: e.target.value };
                          aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, quickPrompts: updated });
                        }}
                        className="w-28 theme-bg-app border theme-border-input rounded p-1 text-sm"
                        placeholder="Nome"
                      />
                      <textarea
                        value={qp.prompt}
                        onChange={(e) => {
                          const updated = [...aiIntegration.aiSettings.quickPrompts];
                          updated[idx] = { ...updated[idx], prompt: e.target.value };
                          aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, quickPrompts: updated });
                        }}
                        className="flex-1 theme-bg-app border theme-border-input rounded p-1 text-xs resize-none"
                        rows={2}
                        placeholder="Texto do prompt..."
                      />
                      <button
                        onClick={() => {
                          const updated = aiIntegration.aiSettings.quickPrompts.filter((_, i) => i !== idx);
                          aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, quickPrompts: updated });
                        }}
                        className="p-1 text-red-500 hover-text-red-400"
                        title="Remover"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  ))}
                </div>
                <button
                  onClick={() => {
                    const newPrompt = {
                      id: `qp-${Date.now()}`,
                      name: '',
                      prompt: '',
                      icon: 'üìù'
                    };
                    const updated = [...(aiIntegration.aiSettings.quickPrompts || []), newPrompt];
                    aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, quickPrompts: updated });
                  }}
                  className="text-sm text-blue-600 dark:text-blue-400 hover-blue-700"
                >
                  + Adicionar Prompt R√°pido
                </button>
              </div>

              {/* v1.20.4: Uso de Tokens - Se√ß√£o de m√©tricas */}
              {(() => {
                const tokenMetrics = aiIntegration.tokenMetrics || {};
                const totalTokens = (tokenMetrics.totalInput || 0) + (tokenMetrics.totalOutput || 0) +
                                    (tokenMetrics.totalCacheRead || 0) + (tokenMetrics.totalCacheCreation || 0);
                const cacheRate = totalTokens > 0
                  ? Math.round(((tokenMetrics.totalCacheRead || 0) / totalTokens) * 100)
                  : 0;
                const formatNumber = (n) => {
                  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
                  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
                  return (n || 0).toString();
                };
                const calculateCost = (m, prices) => {
                  const inputCost = ((m.totalInput || 0) / 1000000) * prices.input;
                  const cacheWriteCost = ((m.totalCacheCreation || 0) / 1000000) * prices.cacheWrite;
                  const cacheReadCost = ((m.totalCacheRead || 0) / 1000000) * prices.cacheRead;
                  const outputCost = ((m.totalOutput || 0) / 1000000) * prices.output;
                  return inputCost + cacheWriteCost + cacheReadCost + outputCost;
                };
                const sonnetPrices = { input: 3.00, output: 15.00, cacheWrite: 3.75, cacheRead: 0.30 };
                const opusPrices = { input: 5.00, output: 25.00, cacheWrite: 6.25, cacheRead: 0.50 };
                const geminiPrices = { input: 2.00, output: 12.00, cacheWrite: 2.50, cacheRead: 0.20 };
                const geminiFlashPrices = { input: 0.50, output: 3.00, cacheWrite: 0.625, cacheRead: 0.05 };

                return (
                  <div className="border-t theme-border-secondary pt-4 mt-4">
                    <label className="block text-sm font-medium theme-text-tertiary mb-3">
                      üìä Uso de Tokens (Projeto Atual)
                    </label>

                    {tokenMetrics.requestCount > 0 ? (
                      <div className="theme-bg-secondary-30 rounded-lg p-4 border theme-border-input space-y-3">
                        <div className="flex justify-between items-center">
                          <span className="theme-text-secondary text-sm">Total de Tokens:</span>
                          <span className="font-mono font-semibold theme-text-primary">{formatNumber(totalTokens)}</span>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="theme-text-secondary text-sm">Requisi√ß√µes:</span>
                          <span className="font-mono theme-text-primary">{tokenMetrics.requestCount}</span>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="theme-text-secondary text-sm">Taxa de Cache:</span>
                          <span className="font-mono text-green-400">{cacheRate}%</span>
                        </div>

                        <div className="border-t theme-border-secondary pt-3 mt-3 space-y-2 text-sm">
                          <div className="flex justify-between">
                            <span className="theme-text-muted">üì• Input:</span>
                            <span className="font-mono theme-text-secondary">{formatNumber(tokenMetrics.totalInput)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="theme-text-muted">üì§ Output:</span>
                            <span className="font-mono theme-text-secondary">{formatNumber(tokenMetrics.totalOutput)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-green-400">üíæ Cache Read:</span>
                            <span className="font-mono text-green-400">{formatNumber(tokenMetrics.totalCacheRead)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-yellow-400">üÜï Cache Write:</span>
                            <span className="font-mono text-yellow-400">{formatNumber(tokenMetrics.totalCacheCreation)}</span>
                          </div>
                        </div>

                        <div className="border-t theme-border-secondary pt-3 mt-3 space-y-2">
                          <span className="theme-text-secondary text-sm block mb-2">üí∞ Custo Estimado:</span>
                          <div className="flex justify-between items-center">
                            <span className="text-xs theme-text-muted">Sonnet 4/4.5:</span>
                            <span className="font-mono text-sm text-blue-400">${calculateCost(tokenMetrics, sonnetPrices).toFixed(4)}</span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-xs theme-text-muted">Opus 4.5:</span>
                            <span className="font-mono text-sm text-purple-400">${calculateCost(tokenMetrics, opusPrices).toFixed(4)}</span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-xs theme-text-muted">Gemini 3 Pro:</span>
                            <span className="font-mono text-sm text-emerald-400">${calculateCost(tokenMetrics, geminiPrices).toFixed(4)}</span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-xs theme-text-muted">Gemini 3 Flash:</span>
                            <span className="font-mono text-sm text-cyan-400">${calculateCost(tokenMetrics, geminiFlashPrices).toFixed(4)}</span>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <p className="theme-text-muted text-sm">Nenhuma requisi√ß√£o realizada ainda neste projeto.</p>
                    )}
                  </div>
                );
              })()}

              {/* T√≥picos Complementares Autom√°ticos - dentro da √°rea scroll√°vel */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  üìã T√≥picos Complementares Autom√°ticos
                </label>
                <div className="theme-bg-secondary-30 rounded-lg p-4 border theme-border-input">
                  <p className="text-xs theme-text-muted mb-3">
                    T√≥picos que ser√£o adicionados automaticamente ao final da an√°lise de documentos (n√£o selecionados por padr√£o).
                    <br />
                    <span className="text-blue-400">üí° Dica: Arraste os t√≥picos para reorden√°-los</span>
                  </p>

                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {aiIntegration.aiSettings.topicosComplementares.map((topico, idx) => (
                      <div
                        key={topico.id}
                        draggable
                        onDragStart={(e) => handleComplementaryDragStart(e, idx)}
                        onDragEnd={handleComplementaryDragEnd}
                        onDragOver={(e) => handleComplementaryDragOver(e, idx)}
                        onDragLeave={handleComplementaryDragLeave}
                        onDrop={(e) => handleComplementaryDrop(e, idx)}
                        className={`flex items-center gap-3 p-3 rounded-lg border transition-colors cursor-move ${
                          topico.enabled
                            ? 'theme-bg-tertiary-30 theme-border'
                            : 'theme-bg-secondary/20 theme-border-input opacity-60'
                        } ${
                          draggedComplementaryIndex === idx
                            ? 'opacity-50 border-blue-500'
                            : ''
                        } ${
                          dragOverComplementaryIndex === idx
                            ? 'border-green-500 border-2 scale-105'
                            : ''
                        }`}
                      >
                        <div className="cursor-grab active:cursor-grabbing theme-text-disabled hover-theme-text-tertiary transition-colors" title="Arrastar para reordenar">
                          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M7 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 2zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 14zm6-8a2 2 0 1 0-.001-4.001A2 2 0 0 0 13 6zm0 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 14z"></path>
                          </svg>
                        </div>
                        <input
                          type="checkbox"
                          checked={topico.enabled}
                          onChange={(e) => {
                            const updated = [...aiIntegration.aiSettings.topicosComplementares];
                            updated[idx] = { ...updated[idx], enabled: e.target.checked };
                            aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, topicosComplementares: updated });
                          }}
                          className="w-4 h-4 rounded theme-border text-blue-500 focus:ring-blue-500 focus:ring-offset-0"
                        />
                        <div className="flex-1 min-w-0">
                          <div className="text-sm theme-text-primary font-medium truncate">{topico.title}</div>
                          <div className={CSS.textMuted}>{topico.category}</div>
                        </div>
                        <button
                          onClick={() => {
                            const updated = aiIntegration.aiSettings.topicosComplementares.filter((_, i) => i !== idx);
                            aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, topicosComplementares: updated });
                          }}
                          className="text-red-400 hover-text-red-300 transition-colors p-1"
                          title="Remover t√≥pico"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                  </div>

                  {aiIntegration.aiSettings.topicosComplementares.length === 0 && (
                    <p className="text-xs theme-text-disabled text-center py-4">
                      Nenhum t√≥pico complementar configurado
                    </p>
                  )}

                  <div className="mt-3 pt-3 border-t theme-border-input">
                    <p className="text-xs theme-text-muted mb-2">Adicionar novo t√≥pico:</p>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        placeholder="T√≠tulo do t√≥pico..."
                        id="newComplementaryTitle"
                        className="flex-1 px-3 py-2 theme-bg-primary border theme-border-input rounded text-sm theme-text-primary theme-placeholder focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <select
                        id="newComplementaryCategory"
                        defaultValue="M√âRITO"
                        className="px-3 py-2 theme-bg-primary border theme-border-input rounded text-sm theme-text-primary focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="PRELIMINAR">Preliminar</option>
                        <option value="M√âRITO">M√©rito</option>
                        <option value="PEDIDOS">Pedidos</option>
                        <option value="OUTROS">Outros</option>
                      </select>
                      <button
                        onClick={() => {
                          const titleInput = document.getElementById('newComplementaryTitle');
                          const categorySelect = document.getElementById('newComplementaryCategory');
                          const title = titleInput.value.trim();

                          if (title) {
                            const newId = Math.max(0, ...aiIntegration.aiSettings.topicosComplementares.map(t => t.id)) + 1;
                            const newOrdem = aiIntegration.aiSettings.topicosComplementares.length + 1;
                            const newTopico = {
                              id: newId,
                              title: title,
                              category: categorySelect.value,
                              enabled: true,
                              ordem: newOrdem
                            };

                            aiIntegration.setAiSettings({
                              ...aiIntegration.aiSettings,
                              topicosComplementares: [...aiIntegration.aiSettings.topicosComplementares, newTopico]
                            });

                            titleInput.value = '';
                            showToast('T√≥pico complementar adicionado!', 'success');
                          } else {
                            showToast('Digite um t√≠tulo para o t√≥pico', 'error');
                          }
                        }}
                        className="px-4 py-2 bg-green-600 text-white rounded hover-green-700 transition-colors text-sm font-medium"
                      >
                        <Plus className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Footer fixo com bot√µes */}
            <div className="p-6 border-t theme-border-secondary space-y-4">
              {/* Bot√µes de Exportar/Importar Configura√ß√µes */}
              <div className="flex gap-3">
                <button
                  onClick={exportAiSettings}
                  className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover-green-700 transition-colors text-sm font-medium"
                >
                  <Download className="w-4 h-4" />
                  Exportar Configura√ß√µes
                </button>
                <label className="flex-1">
                  <input
                    type="file"
                    accept=".json"
                    onChange={importAiSettings}
                    className="hidden"
                  />
                  <div className="flex items-center justify-center gap-2 px-4 py-2 bg-amber-600 rounded-lg hover-amber-700 transition-colors text-sm font-medium cursor-pointer">
                    <Upload className="w-4 h-4" />
                    Importar Configura√ß√µes
                  </div>
                </label>
              </div>

              <div className="flex justify-between items-center">
                <div className="text-xs theme-text-muted space-y-1">
                  <div>
                    Modelo atual: <span className="theme-text-secondary font-medium">
                      {aiIntegration.aiSettings.provider === 'gemini'
                        ? aiIntegration.getModelDisplayName(aiIntegration.aiSettings.geminiModel)
                        : aiIntegration.getModelDisplayName(aiIntegration.aiSettings.claudeModel || aiIntegration.aiSettings.model)}
                    </span>
                    {aiIntegration.aiSettings.useExtendedThinking && <span className="ml-2 text-purple-400">‚Ä¢ Pensamento prolongado ativo</span>}
                    {aiIntegration.aiSettings.provider === 'gemini' && aiIntegration.aiSettings.geminiThinkingLevel && aiIntegration.aiSettings.geminiThinkingLevel !== 'none' && (
                      <span className="ml-2 text-blue-400">‚Ä¢ Thinking: {aiIntegration.aiSettings.geminiThinkingLevel}</span>
                    )}
                  </div>
                  {aiIntegration.aiSettings.customPrompt && (
                    <div className="flex items-center gap-2 text-green-400">
                      <Sparkles className="w-3 h-3" />
                      <span>Estilo personalizado configurado</span>
                    </div>
                  )}
                </div>
                <button
                  onClick={() => closeModal('settings')}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg hover-blue-700 transition-colors font-medium"
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* v1.32.24: Modal de Changelog - v1.33.51: migrado para BaseModal */}
      <BaseModal
        isOpen={showChangelogModal}
        onClose={() => setShowChangelogModal(false)}
        title="Hist√≥rico de Altera√ß√µes"
        icon={<Clock />}
        iconColor="blue"
        size="md"
      >
        <div className="p-4 overflow-y-auto max-h-[60vh]">
          {CHANGELOG.map((item, i) => (
            <div key={i} className="mb-3 pb-3 border-b theme-border-secondary last:border-0">
              <span className="text-blue-400 font-mono text-sm font-semibold">v{item.version}</span>
              <p className="theme-text-secondary text-sm mt-1">{item.feature}</p>
            </div>
          ))}
        </div>
      </BaseModal>

      {/* üì• v1.33.61: Modal de Download de Dados Essenciais (legisla√ß√£o e jurisprud√™ncia) - v1.35.67: migrado para BaseModal */}
      <BaseModal
        isOpen={showDataDownloadModal}
        onClose={handleDismissDataPrompt}
        title="Baixar Base de Dados"
        icon={<Download />}
        iconColor="blue"
        size="md"
        footer={
          <div className="flex justify-end gap-2">
            <button
              onClick={handleDismissDataPrompt}
              disabled={dataDownloadStatus.legislacao.downloading || dataDownloadStatus.jurisprudencia.downloading}
              className="px-4 py-2 text-sm theme-text-secondary hover:theme-text-primary disabled:opacity-50"
            >
              Depois
            </button>
            <button
              onClick={handleStartDataDownload}
              disabled={dataDownloadStatus.legislacao.downloading || dataDownloadStatus.jurisprudencia.downloading ||
                       (!dataDownloadStatus.legislacao.needed && !dataDownloadStatus.jurisprudencia.needed)}
              className="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
            >
              {(dataDownloadStatus.legislacao.downloading || dataDownloadStatus.jurisprudencia.downloading) ? (
                <><RefreshCw className="w-4 h-4 animate-spin" /> Baixando...</>
              ) : (
                <><Download className="w-4 h-4" /> Baixar Agora</>
              )}
            </button>
          </div>
        }
      >
        <div className="p-4 space-y-4">
          <p className="text-sm theme-text-secondary">
            Para usar o Sentencify, √© necess√°rio baixar a base de dados de legisla√ß√£o e jurisprud√™ncia (~5 MB total, download √∫nico e r√°pido).
          </p>

          {/* Legisla√ß√£o */}
          {dataDownloadStatus.legislacao.needed && (
            <div className="p-3 rounded-lg theme-bg-secondary border theme-border-input">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium theme-text-primary">üìú Legisla√ß√£o (~3 MB)</span>
                {dataDownloadStatus.legislacao.downloading && (
                  <span className="text-xs theme-text-muted">
                    {Math.round(dataDownloadStatus.legislacao.progress * 100)}%
                  </span>
                )}
                {dataDownloadStatus.legislacao.completed && (
                  <span className="text-xs text-green-500">‚úì Conclu√≠do</span>
                )}
              </div>
              {dataDownloadStatus.legislacao.downloading && (
                <div className="h-2 bg-gray-600 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-blue-500 transition-all duration-300"
                    style={{ width: `${dataDownloadStatus.legislacao.progress * 100}%` }}
                  />
                </div>
              )}
              {dataDownloadStatus.legislacao.error && (
                <p className="text-xs text-red-400 mt-1">{dataDownloadStatus.legislacao.error}</p>
              )}
            </div>
          )}

          {/* Jurisprud√™ncia */}
          {dataDownloadStatus.jurisprudencia.needed && (
            <div className="p-3 rounded-lg theme-bg-secondary border theme-border-input">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium theme-text-primary">‚öñÔ∏è Jurisprud√™ncia (~2 MB)</span>
                {dataDownloadStatus.jurisprudencia.downloading && (
                  <span className="text-xs theme-text-muted">
                    {Math.round(dataDownloadStatus.jurisprudencia.progress * 100)}%
                  </span>
                )}
                {dataDownloadStatus.jurisprudencia.completed && (
                  <span className="text-xs text-green-500">‚úì Conclu√≠do</span>
                )}
              </div>
              {dataDownloadStatus.jurisprudencia.downloading && (
                <div className="h-2 bg-gray-600 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-green-500 transition-all duration-300"
                    style={{ width: `${dataDownloadStatus.jurisprudencia.progress * 100}%` }}
                  />
                </div>
              )}
              {dataDownloadStatus.jurisprudencia.error && (
                <p className="text-xs text-red-400 mt-1">{dataDownloadStatus.jurisprudencia.error}</p>
              )}
            </div>
          )}

          {/* Mensagem se ambos j√° foram baixados */}
          {!dataDownloadStatus.legislacao.needed && !dataDownloadStatus.jurisprudencia.needed && (
            <div className="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
              <p className="text-sm text-green-400 flex items-center gap-2">
                <Check className="w-4 h-4" /> Base de dados instalada!
              </p>
            </div>
          )}
        </div>
      </BaseModal>

      {/* üåê v1.33.0: Modal de Download de Embeddings do CDN - v1.35.67: migrado para BaseModal */}
      <BaseModal
        isOpen={showEmbeddingsDownloadModal}
        onClose={handleDismissEmbeddingsPrompt}
        title="Baixar Dados para Busca Sem√¢ntica"
        icon={<Download />}
        iconColor="blue"
        size="md"
        footer={
          <div className="flex justify-end gap-2">
            <button
              onClick={handleDismissEmbeddingsPrompt}
              disabled={embeddingsDownloadStatus.legislacao.downloading || embeddingsDownloadStatus.jurisprudencia.downloading}
              className="px-4 py-2 text-sm theme-text-secondary hover:theme-text-primary disabled:opacity-50"
            >
              Depois
            </button>
            <button
              onClick={handleStartEmbeddingsDownload}
              disabled={embeddingsDownloadStatus.legislacao.downloading || embeddingsDownloadStatus.jurisprudencia.downloading ||
                       (!embeddingsDownloadStatus.legislacao.needed && !embeddingsDownloadStatus.jurisprudencia.needed)}
              className="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
            >
              {(embeddingsDownloadStatus.legislacao.downloading || embeddingsDownloadStatus.jurisprudencia.downloading) ? (
                <><RefreshCw className="w-4 h-4 animate-spin" /> Baixando...</>
              ) : (
                <><Download className="w-4 h-4" /> Baixar Agora</>
              )}
            </button>
          </div>
        }
      >
        <div className="p-4 space-y-4">
          <p className="text-sm theme-text-secondary">
            Para usar a busca sem√¢ntica de legisla√ß√£o e jurisprud√™ncia, √© necess√°rio baixar os dados de embeddings (~250 MB total, download √∫nico).
          </p>

          {/* Legisla√ß√£o */}
          {embeddingsDownloadStatus.legislacao.needed && (
            <div className="p-3 rounded-lg theme-bg-secondary border theme-border-input">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium theme-text-primary">üìú Legisla√ß√£o (~211 MB)</span>
                {embeddingsDownloadStatus.legislacao.downloading && (
                  <span className="text-xs theme-text-muted">
                    {Math.round(embeddingsDownloadStatus.legislacao.progress * 100)}%
                  </span>
                )}
                {!embeddingsDownloadStatus.legislacao.needed && embeddingsDownloadStatus.legislacao.progress === 1 && (
                  <span className="text-xs text-green-500">‚úì Conclu√≠do</span>
                )}
              </div>
              {embeddingsDownloadStatus.legislacao.downloading && (
                <div className="h-2 bg-gray-600 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-blue-500 transition-all duration-300"
                    style={{ width: `${embeddingsDownloadStatus.legislacao.progress * 100}%` }}
                  />
                </div>
              )}
              {embeddingsDownloadStatus.legislacao.error && (
                <p className="text-xs text-red-400 mt-1">{embeddingsDownloadStatus.legislacao.error}</p>
              )}
            </div>
          )}

          {/* Jurisprud√™ncia */}
          {embeddingsDownloadStatus.jurisprudencia.needed && (
            <div className="p-3 rounded-lg theme-bg-secondary border theme-border-input">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium theme-text-primary">üìö Jurisprud√™ncia (~38 MB)</span>
                {embeddingsDownloadStatus.jurisprudencia.downloading && (
                  <span className="text-xs theme-text-muted">
                    {Math.round(embeddingsDownloadStatus.jurisprudencia.progress * 100)}%
                  </span>
                )}
                {!embeddingsDownloadStatus.jurisprudencia.needed && embeddingsDownloadStatus.jurisprudencia.progress === 1 && (
                  <span className="text-xs text-green-500">‚úì Conclu√≠do</span>
                )}
              </div>
              {embeddingsDownloadStatus.jurisprudencia.downloading && (
                <div className="h-2 bg-gray-600 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-green-500 transition-all duration-300"
                    style={{ width: `${embeddingsDownloadStatus.jurisprudencia.progress * 100}%` }}
                  />
                </div>
              )}
              {embeddingsDownloadStatus.jurisprudencia.error && (
                <p className="text-xs text-red-400 mt-1">{embeddingsDownloadStatus.jurisprudencia.error}</p>
              )}
            </div>
          )}

          {/* Mensagem se ambos j√° foram baixados */}
          {!embeddingsDownloadStatus.legislacao.needed && !embeddingsDownloadStatus.jurisprudencia.needed && (
            <div className="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
              <p className="text-sm text-green-400 flex items-center gap-2">
                <Check className="w-4 h-4" /> Todos os embeddings j√° est√£o instalados!
              </p>
            </div>
          )}
        </div>
      </BaseModal>

      {/* Modal de Restaurar Sess√£o */}
      <RestoreSessionModal
        isOpen={modals.restoreSession}
        onClose={() => closeModal('restoreSession')}
        sessionLastSaved={storage.sessionLastSaved}
        onRestoreSession={() => {
          const callbacks = {
            setPastedPeticaoTexts,
            setPastedContestacaoTexts,
            setPastedComplementaryTexts,
            setExtractedTopics,
            setSelectedTopics,
            setPartesProcesso,
            setAnalyzedDocuments,
            // v1.13.7: Adicionar setters de arquivos de Upload para restaurar PDFs do IndexedDB
            setPeticaoFiles,
            setContestacaoFiles,
            setComplementaryFiles,
            setExtractedTexts,
            setDocumentProcessingModes,
            setProofFiles: proofManager.setProofFiles,
            setProofTexts: proofManager.setProofTexts,
            setProofUsePdfMode: proofManager.setProofUsePdfMode,
            setExtractedProofTexts: proofManager.setExtractedProofTexts,
            setProofExtractionFailed: proofManager.setProofExtractionFailed,
            setProofTopicLinks: proofManager.setProofTopicLinks,
            setProofAnalysisResults: proofManager.setProofAnalysisResults,
            setProofConclusions: proofManager.setProofConclusions,
            setProofSendFullContent: proofManager.setProofSendFullContent,
            setActiveTab,
            closeModal,
            setError,
            setProcessoNumero,
            setTokenMetrics: aiIntegration.setTokenMetrics // v1.20.3: Contador de tokens
          };
          storage.restoreSession(callbacks);
        }}
        onStartNew={() => {
          closeModal('restoreSession');
          openModal('clearProject');
        }}
      />

      {/* Modal de Confirma√ß√£o de Limpeza de Projeto */}
      <ClearProjectModal
        isOpen={modals.clearProject}
        onClose={() => {
          closeModal('clearProject');
          openModal('restoreSession');
        }}
        onConfirmClear={() => {
          const callbacks = {
            // Callbacks de restaura√ß√£o
            setPastedPeticaoTexts,
            setPastedContestacaoTexts,
            setPastedComplementaryTexts,
            setExtractedTopics,
            setSelectedTopics,
            setPartesProcesso,
            setAnalyzedDocuments,
            setProofFiles: proofManager.setProofFiles,
            setProofTexts: proofManager.setProofTexts,
            setProofUsePdfMode: proofManager.setProofUsePdfMode,
            setExtractedProofTexts: proofManager.setExtractedProofTexts,
            setProofExtractionFailed: proofManager.setProofExtractionFailed,
            setProofTopicLinks: proofManager.setProofTopicLinks,
            setProofAnalysisResults: proofManager.setProofAnalysisResults,
            setProofConclusions: proofManager.setProofConclusions,
            setProofSendFullContent: proofManager.setProofSendFullContent,
            setActiveTab,
            closeModal,
            setError,
            setProcessoNumero,
            // Callbacks adicionais para limpeza (m√∫ltiplos)
            setPeticaoFiles,
            setContestacaoFiles,
            setComplementaryFiles,
            // v1.13.7: Adicionar setters de textos extra√≠dos e modos de processamento
            setExtractedTexts,
            setDocumentProcessingModes,
            setProofToDelete: proofManager.setProofToDelete,
            setProofToLink: proofManager.setProofToLink,
            setProofToAnalyze: proofManager.setProofToAnalyze,
            clearAnalyzingProofs: proofManager.clearAnalyzingProofs,
            setShowProofPanel: proofManager.setShowProofPanel,
            setNewProofTextData: proofManager.setNewProofTextData,
            setTokenMetrics: aiIntegration.setTokenMetrics // v1.20.3: Contador de tokens
          };
          storage.clearProject(callbacks);
          // v1.25.19: Limpar nomes de anonimiza√ß√£o ao limpar projeto
          aiIntegration.setAiSettings(prev => ({
            ...prev,
            anonymization: { ...prev.anonymization, nomesUsuario: [] }
          }));
          setAnonymizationNamesText('');
        }}
      />

      {/* v1.33.57: Modal de Confirma√ß√£o de Logout */}
      {onLogout && (
        <LogoutConfirmModal
          isOpen={modals.logout}
          onClose={() => closeModal('logout')}
          onConfirm={() => {
            closeModal('logout');
            onLogout();
            window.location.reload();
          }}
        />
      )}

      {/* v1.35.0: Modal de Compartilhamento de Biblioteca */}
      <ShareLibraryModal
        isOpen={modals.shareLibrary}
        onClose={() => closeModal('shareLibrary')}
        user={cloudSync?.user}
        onRemoveSharedModels={(ownerId) => {
          // v1.35.23: Remover modelos compartilhados desse owner ao remover acesso
          modelLibrary.setModels(prev => {
            const filtered = prev.filter(m => !(m.isShared && m.ownerId === ownerId));
            console.log(`[Share] Removidos ${prev.length - filtered.length} modelos do owner ${ownerId}`);
            saveToIndexedDB(filtered);
            return filtered;
          });
        }}
      />

      {/* Modal de Nomes para Anonimiza√ß√£o - v1.17.0 (v1.25: + NER) */}
      <AnonymizationNamesModal
        isOpen={showAnonymizationModal}
        onClose={() => setShowAnonymizationModal(false)}
        onConfirm={handleAnonymizationConfirm}
        nomesTexto={anonymizationNamesText}
        setNomesTexto={setAnonymizationNamesText}
        nerEnabled={nerEnabled}
        detectingNames={detectingNames}
        onDetectNames={detectarNomesAutomaticamente}
        onOpenAiSettings={() => { setShowAnonymizationModal(false); openModal('settings'); }}
      />

      {/* Modal de Confirma√ß√£o de Exclus√£o de Modelo */}
      <DeleteModelModal
        isOpen={modals.deleteModel}
        onClose={() => closeModal('deleteModel')}
        modelToDelete={modelLibrary.modelToDelete}
        setModelToDelete={modelLibrary.setModelToDelete}
        onConfirmDelete={executeDeleteModel}
      />

      {/* ============= MODAIS DE GERA√á√ÉO EM MASSA ============= */}

      {/* Modal 1: Upload de Arquivos */}
      {/* Modal de Upload/Processamento em Lote */}
      <BulkUploadModal
        isOpen={modals.bulkModal}
        onClose={() => {
          closeModal('bulkModal');
          modelLibrary.setBulkFiles([]);
        }}
        isProcessing={modelLibrary.bulkProcessing}
        isReviewOpen={modals.bulkReview}
        bulkFiles={modelLibrary.bulkFiles}
        bulkFileInputRef={bulkFileInputRef}
        onFileUpload={handleBulkFileUpload}
        onRemoveFile={modelLibrary.removeBulkFile}
        onProcess={processBulkFiles}
        currentFileIndex={modelLibrary.bulkCurrentFileIndex}
        processedFiles={modelLibrary.bulkProcessedFiles}
        bulkStaggerDelay={modelLibrary.bulkStaggerDelay}
        setBulkStaggerDelay={modelLibrary.setBulkStaggerDelay}
        bulkCancelController={modelLibrary.bulkCancelController}
        generatedModels={modelLibrary.bulkGeneratedModels}
        bulkCurrentBatch={modelLibrary.bulkCurrentBatch}
        bulkBatchSize={aiIntegration.aiSettings.parallelRequests || 5}
        openModal={openModal}
      />

      {/* üîç v1.13.1: Modal de Aviso de Similaridade */}
      <SimilarityWarningModal
        warning={modelLibrary.similarityWarning}
        saving={savingFromSimilarity}
        onCancel={handleSimilarityCancel}
        onSaveNew={handleSimilaritySaveNew}
        onReplace={handleSimilarityReplace}
        sanitizeHTML={sanitizeHTML}
      />

      {/* Modal 3: Revis√£o de Modelos Gerados */}
      {/* Modal de Revis√£o de Modelos Gerados em Lote */}
      <BulkReviewModal
        isOpen={modals.bulkReview}
        onClose={() => closeModal('bulkReview')}
        bulkReviewModels={modelLibrary.bulkReviewModels}
        bulkFiles={modelLibrary.bulkFiles}
        bulkGeneratedModels={modelLibrary.bulkGeneratedModels}
        bulkErrors={modelLibrary.bulkErrors}
        onRemoveModel={removeBulkReviewModel}
        onDiscard={() => {
          closeModal('bulkReview');
          openModal('bulkDiscardConfirm');
        }}
        onSave={saveBulkModels}
        sanitizeHTML={sanitizeHTML}
      />

      {/* Modal de Confirma√ß√£o - Descartar Modelos Gerados */}
      <BulkDiscardConfirmModal
        isOpen={modals.bulkDiscardConfirm}
        onClose={() => {
          closeModal('bulkDiscardConfirm');
          openModal('bulkReview'); // Reabre o modal de revis√£o se cancelar
        }}
        totalModels={modelLibrary.bulkReviewModels.length}
        onConfirm={() => {
          closeModal('bulkDiscardConfirm');
          closeModal('bulkModal');
          modelLibrary.resetBulkState();
        }}
      />

      {/* v1.5.15: Modal de Confirma√ß√£o - Cancelar Processamento */}
      <ConfirmBulkCancelModal
        isOpen={modals.confirmBulkCancel}
        onClose={() => closeModal('confirmBulkCancel')}
        filesInProgress={getBulkPendingFilesCount()}
        onConfirm={handleConfirmBulkCancel}
      />

      {/* ============= FIM DOS MODAIS DE GERA√á√ÉO EM MASSA ============= */}

      {/* Modal de Confirma√ß√£o de Exclus√£o em Massa */}
      <DeleteAllModelsModal
        isOpen={modals.deleteAllModels}
        onClose={() => closeModal('deleteAllModels')}
        totalModels={modelLibrary.models.length}
        confirmText={modelLibrary.deleteAllConfirmText}
        setConfirmText={modelLibrary.setDeleteAllConfirmText}
        onConfirmDelete={deleteAllModels}
      />


      {/* Modal de Confirma√ß√£o - Extrair Modelo */}
      <ExtractModelConfirmModal
        isOpen={modals.extractModelConfirm}
        onClose={() => closeModal('extractModelConfirm')}
        editingTopic={editingTopic}
        editorRef={editorRef}
        onConfirmExtract={extractModelFromDecisionText}
      />

      {/* Modal de Preview/Edi√ß√£o - Modelo Extra√≠do */}
      <ExtractedModelPreviewModal
        isOpen={modals.extractedModelPreview}
        onClose={() => closeModal('extractedModelPreview')}
        extractedModel={modelLibrary.extractedModelPreview}
        setExtractedModel={modelLibrary.setExtractedModelPreview}
        onSave={saveExtractedModel}
        onCancel={cancelExtractedModel}
        sanitizeHTML={sanitizeHTML}
      />

      {/* v1.15.3: Modal de "Salvar como Novo Modelo" (reutiliza ExtractedModelPreviewModal) */}
      <ExtractedModelPreviewModal
        isOpen={modelPreview.saveAsNewData !== null}
        onClose={() => modelPreview.closeSaveAsNew()}
        extractedModel={modelPreview.saveAsNewData}
        setExtractedModel={(data) => modelPreview.setSaveAsNewData(data)}
        onSave={confirmSaveAsNew}
        onCancel={() => modelPreview.closeSaveAsNew()}
        sanitizeHTML={sanitizeHTML}
      />

      {/* v1.11.0: Modal de Edi√ß√£o Global */}
      <GlobalEditorModal
        isOpen={modals.globalEditor}
        onClose={() => closeModal('globalEditor')}
        selectedTopics={selectedTopics}
        setSelectedTopics={setSelectedTopics}
        setExtractedTopics={setExtractedTopics}
        models={modelLibrary.models}
        findSuggestions={findSuggestions}
        sanitizeHTML={sanitizeHTML}
        showToast={showToast}
        fontSize={fontSize}
        spacing={spacing}
        setFontSize={setFontSize}
        setSpacing={setSpacing}
        editorTheme={appTheme}
        quillReady={quillReady}
        quillError={quillError}
        modelPreview={modelPreview}
        analyzedDocuments={analyzedDocuments}
        proofManager={proofManager}
        aiIntegration={aiIntegration}
        detectResultadoAutomatico={detectResultadoAutomatico}
        onSlashCommand={openSlashMenu}
        fileToBase64={storage.fileToBase64}
        openModal={openModal}
        closeModal={closeModal}
        useLocalAIForSuggestions={aiIntegration.aiSettings.useLocalAIForSuggestions}
        useLocalAIForJuris={aiIntegration.aiSettings.useLocalAIForJuris}
        jurisSemanticThreshold={aiIntegration.aiSettings.jurisSemanticThreshold}
        searchModelReady={searchModelReady}
        jurisEmbeddingsCount={jurisEmbeddingsCount}
        searchModelsBySimilarity={searchModelsBySimilarity}
        modelSemanticEnabled={aiIntegration.aiSettings.modelSemanticEnabled}
      />

      {/* Modal de Preview de Modelo (Sugest√µes) - GLOBAL (v1.12.2: movido para depois do GlobalEditorModal) */}
      {/* v1.15.2: Usa fun√ß√£o contextual se dispon√≠vel (ex: GlobalEditorModal) */}
      <ModelPreviewModal
        isOpen={modelPreview.isPreviewOpen}
        model={modelPreview.previewingModel}
        onInsert={modelPreview.contextualInsertFnRef?.current || insertModelContent}
        onClose={modelPreview.closePreview}
        sanitizeHTML={sanitizeHTML}
        showToast={showToast}
        // Props para Quick Edit
        isEditing={modelPreview.isEditing}
        editedContent={modelPreview.editedContent}
        onStartEditing={modelPreview.startEditing}
        onCancelEditing={modelPreview.cancelEditing}
        onSaveEdit={saveQuickEdit}
        onContentChange={modelPreview.setEditedContent}
        quillReady={quillReady}
        quillError={quillError}
        // Props para configura√ß√µes globais de editor
        fontSize={fontSize}
        spacing={spacing}
        editorTheme={appTheme}
        // Prop para exclus√£o de modelo
        onDelete={confirmDeleteModel}
        // Prop para favoritar modelo
        onToggleFavorite={toggleFavorite}
        // v1.15.3: Prop para "Salvar como Novo Modelo"
        onOpenSaveAsNew={modelPreview.openSaveAsNew}
      />

      {/* v1.15.3: Slash Command Menu - Acesso r√°pido a modelos com / */}
      {/* v1.33.8: Adicionado suporte a busca sem√¢ntica e tooltip preview */}
      <SlashCommandMenu
        isOpen={slashMenu.isOpen}
        position={slashMenu.position}
        models={modelLibrary.models}
        searchTerm={slashMenu.searchTerm}
        selectedIndex={slashMenu.selectedIndex}
        onSelect={selectModelFromSlash}
        onClose={() => closeSlashMenu(true)}
        onSearchChange={updateSlashSearchTerm}
        onNavigate={navigateSlashMenu}
        semanticAvailable={modelSemanticAvailable}
        searchModelsBySimilarity={searchModelsBySimilarity}
      />

      {/* Toast Notification */}
      {toast.show && (
        <div className="fixed top-4 left-4 z-[9999] animate-slide-in-right">
          <div className={`
            rounded-lg shadow-2xl border p-4 min-w-[320px] max-w-md
            ${toast.type === 'success' ? 'theme-toast-success' : ''}
            ${toast.type === 'error' ? 'theme-toast-error' : ''}
            ${toast.type === 'info' ? 'theme-toast-info' : ''}
            ${toast.type === 'warning' ? 'theme-toast-warning' : ''}
          `}>
            <div className="flex items-start gap-3">
              <div className="flex-shrink-0 text-2xl">
                {toast.type === 'success' && '‚úÖ'}
                {toast.type === 'error' && '‚ùå'}
                {toast.type === 'info' && '‚ÑπÔ∏è'}
                {toast.type === 'warning' && '‚ö†Ô∏è'}
              </div>
              <div className="flex-1">
                <p className="text-sm theme-text-primary whitespace-pre-line">{toast.message}</p>
              </div>
              <button
                onClick={() => setToast({ show: false, message: '', type: 'success' })}
                className="flex-shrink-0 text-white/60 hover-text-white transition-colors"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      )}

      {/* v1.4.6: Removido Mini-toolbar flutuante (76 linhas) */}
      {/* v1.4.8: Removido Toolbar Fixa no Topo (82 linhas) - n√£o mais necess√°ria com editor de altura fixa */}

      {/* Modal: Adicionar Prova (Texto) */}
      <AddProofTextModal
        isOpen={modals.addProofText}
        onClose={() => closeModal('addProofText')}
        newProofData={proofManager.newProofTextData}
        setNewProofData={proofManager.setNewProofTextData}
        onAddProof={() => {
          if (proofManager.newProofTextData.text.trim()) {
            const anonConfig = aiIntegration?.aiSettings?.anonymization;
            const anonymizationEnabled = anonConfig?.enabled;

            // v1.21.3: Se anonimiza√ß√£o ativa, abrir modal para confirmar nomes
            if (anonymizationEnabled) {
              proofManager.setPendingProofText({
                name: proofManager.newProofTextData.name.trim() || 'Prova (texto)',
                text: proofManager.newProofTextData.text.trim()
              });
              closeModal('addProofText');
              openModal('proofTextAnonymization');
            } else {
              // Salvar diretamente sem anonimiza√ß√£o
              const id = Date.now() + Math.random();
              const name = proofManager.newProofTextData.name.trim() || 'Prova (texto)';
              proofManager.setProofTexts(prev => [...prev, {
                id,
                text: proofManager.newProofTextData.text.trim(),
                name,
                type: 'text',
                uploadDate: new Date().toISOString()
              }]);
              closeModal('addProofText');
              proofManager.setNewProofTextData({ name: '', text: '' });
            }
          }
        }}
      />

      {/* v1.21.3: Modal de Nomes para Anonimiza√ß√£o de Prova de Texto */}
      <AnonymizationNamesModal
        isOpen={modals.proofTextAnonymization}
        onClose={() => {
          closeModal('proofTextAnonymization');
          proofManager.setPendingProofText(null);
          proofManager.setNewProofTextData({ name: '', text: '' });
        }}
        onConfirm={(nomes) => {
          if (proofManager.pendingProofText) {
            const anonConfig = aiIntegration?.aiSettings?.anonymization;
            // Persistir nomes para uso futuro
            aiIntegration.setAiSettings(prev => ({
              ...prev,
              anonymization: {
                ...prev.anonymization,
                nomesUsuario: nomes
              }
            }));
            // Anonimizar e salvar prova
            const id = Date.now() + Math.random();
            const anonText = anonymizeText(proofManager.pendingProofText.text, anonConfig, nomes);
            proofManager.setProofTexts(prev => [...prev, {
              id,
              text: anonText,
              name: proofManager.pendingProofText.name,
              type: 'text',
              uploadDate: new Date().toISOString()
            }]);
            closeModal('proofTextAnonymization');
            proofManager.setPendingProofText(null);
            proofManager.setNewProofTextData({ name: '', text: '' });
            showToast('‚úÖ Prova de texto adicionada com anonimiza√ß√£o', 'success');
          }
        }}
        nomesTexto={anonymizationNamesText}
        setNomesTexto={setAnonymizationNamesText}
        nerEnabled={nerEnabled}
        detectingNames={detectingNames}
        onDetectNames={async () => {
          setDetectingNames(true);
          try { await detectarNomesAutomaticamente(proofManager.pendingProofText?.text, true); }
          catch { setDetectingNames(false); }
        }}
        onOpenAiSettings={() => { closeModal('proofTextAnonymization'); openModal('settings'); }}
      />

      {/* v1.21.5: Modal de Nomes para Anonimiza√ß√£o de Extra√ß√£o de PDF */}
      <AnonymizationNamesModal
        isOpen={modals.proofExtractionAnonymization}
        onClose={() => {
          closeModal('proofExtractionAnonymization');
          proofManager.setPendingExtraction(null);
        }}
        onConfirm={(nomes) => {
          if (proofManager.pendingExtraction) {
            // Persistir nomes para uso futuro
            aiIntegration.setAiSettings(prev => ({
              ...prev,
              anonymization: {
                ...prev.anonymization,
                nomesUsuario: nomes
              }
            }));
            // Executar extra√ß√£o com nomes confirmados
            proofManager.pendingExtraction.executeExtraction(nomes);
            closeModal('proofExtractionAnonymization');
            proofManager.setPendingExtraction(null);
            showToast('üìù Extraindo texto com anonimiza√ß√£o...', 'info');
          }
        }}
        nomesTexto={anonymizationNamesText}
        setNomesTexto={setAnonymizationNamesText}
        nerEnabled={nerEnabled}
        detectingNames={detectingNames}
        onDetectNames={async () => {
          // v1.28.09: Feedback visual imediato
          setDetectingNames(true);
          try {
            const file = proofManager.pendingExtraction?.proof?.file;
            if (file) {
              const extractedText = await documentServices.extractTextFromPDFPure(file);
              await detectarNomesAutomaticamente(extractedText, true);
            } else {
              await detectarNomesAutomaticamente(null, true);
            }
          } catch (err) {
            console.error('[NER] Erro ao extrair PDF para NER:', err);
            showToast('Erro ao extrair texto do PDF', 'error');
            setDetectingNames(false);
          }
        }}
        onOpenAiSettings={() => { closeModal('proofExtractionAnonymization'); openModal('settings'); }}
      />

      {/* v1.21.16: Modal de Preview de Texto Extra√≠do */}
      <TextPreviewModal
        isOpen={textPreview.isOpen}
        onClose={() => setTextPreview({ isOpen: false, title: '', text: '' })}
        title={textPreview.title}
        text={textPreview.text}
      />

      {/* Modal: Sele√ß√£o de Tipo de An√°lise de Prova */}
      <ProofAnalysisModal
        isOpen={modals.proofAnalysis}
        onClose={() => {
          closeModal('proofAnalysis');
          proofManager.setProofToAnalyze(null);
          proofManager.setProofAnalysisCustomInstructions('');
          proofManager.setUseOnlyMiniRelatorios(false);
          proofManager.setIncludeLinkedTopicsInFree(false);
        }}
        proofToAnalyze={proofManager.proofToAnalyze}
        customInstructions={proofManager.proofAnalysisCustomInstructions}
        setCustomInstructions={proofManager.setProofAnalysisCustomInstructions}
        useOnlyMiniRelatorios={proofManager.useOnlyMiniRelatorios}
        setUseOnlyMiniRelatorios={proofManager.setUseOnlyMiniRelatorios}
        includeLinkedTopicsInFree={proofManager.includeLinkedTopicsInFree}
        setIncludeLinkedTopicsInFree={proofManager.setIncludeLinkedTopicsInFree}
        proofTopicLinks={proofManager.proofTopicLinks}
        editorTheme={editorTheme}
        onAnalyzeContextual={async () => {
          closeModal('proofAnalysis');
          await analyzeProof(proofManager.proofToAnalyze, 'contextual', proofManager.proofAnalysisCustomInstructions, proofManager.useOnlyMiniRelatorios, false);
          proofManager.setProofToAnalyze(null);
          proofManager.setProofAnalysisCustomInstructions('');
          proofManager.setUseOnlyMiniRelatorios(false);
          proofManager.setIncludeLinkedTopicsInFree(false);
        }}
        onAnalyzeFree={async () => {
          closeModal('proofAnalysis');
          await analyzeProof(proofManager.proofToAnalyze, 'livre', proofManager.proofAnalysisCustomInstructions, false, proofManager.includeLinkedTopicsInFree);
          proofManager.setProofToAnalyze(null);
          proofManager.setProofAnalysisCustomInstructions('');
          proofManager.setUseOnlyMiniRelatorios(false);
          proofManager.setIncludeLinkedTopicsInFree(false);
        }}
      />

      {/* Modal: Vincular Prova a T√≥picos */}
      <LinkProofModal
        isOpen={modals.linkProof}
        onClose={() => {
          closeModal('linkProof');
          proofManager.setProofToLink(null);
        }}
        proofToLink={proofManager.proofToLink}
        extractedTopics={extractedTopics}
        proofTopicLinks={proofManager.proofTopicLinks}
        setProofTopicLinks={proofManager.setProofTopicLinks}
      />

      {/* Modal: Confirmar Exclus√£o de Prova */}
      <DeleteProofModal
        isOpen={modals.deleteProof}
        onClose={() => {
          closeModal('deleteProof');
          proofManager.setProofToDelete(null);
        }}
        proofToDelete={proofManager.proofToDelete}
        onConfirmDelete={async () => {
          if (proofManager.proofToDelete.isPdf) {
            // Limpar do IndexedDB antes de remover do estado
            try {
              await removePdfFromIndexedDB(`proof-${proofManager.proofToDelete.id}`);
            } catch (err) { }
            // Remover prova PDF
            proofManager.setProofFiles(prev => prev.filter(p => p.id !== proofManager.proofToDelete.id));
            proofManager.setProofUsePdfMode(prev => {
              const newMode = { ...prev };
              delete newMode[proofManager.proofToDelete.id];
              return newMode;
            });
            proofManager.setExtractedProofTexts(prev => {
              const newTexts = { ...prev };
              delete newTexts[proofManager.proofToDelete.id];
              return newTexts;
            });
          } else {
            // Remover prova texto
            proofManager.setProofTexts(prev => prev.filter(p => p.id !== proofManager.proofToDelete.id));
          }
          closeModal('deleteProof');
          proofManager.setProofToDelete(null);
        }}
      />

      {/* √çcone de Auto-Save Discreto */}
      {storage.showAutoSaveIndicator && (
        <div className="fixed bottom-4 right-4 z-[9999] animate-in fade-in duration-300">
          <div className="theme-autosave p-2 rounded-full shadow-lg border">
            <svg className="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
          </div>
        </div>
      )}

      {/* v1.9.5: Overlay para abas bloqueadas (n√£o-prim√°rias) */}
      <LockedTabOverlay
        isPrimaryTab={primaryTabLock.isPrimaryTab}
        activeTab={activeTab}
        setActiveTab={setActiveTab}
      />
    </div>
    </>
  );
};

// üîí DOCUMENTA√á√ÉO DE SEGURAN√áA - DOMPURIFY
/*
SANITIZA√á√ÉO DE HTML IMPLEMENTADA COM DOMPURIFY

‚úÖ Implementa√ß√£o conclu√≠da em: 2025-11-12
üì¶ Biblioteca: DOMPurify 3.0.6 (carregada via CDN)
üéØ Objetivo: Prevenir ataques XSS (Cross-Site Scripting)

LOCAIS PROTEGIDOS:
1. ‚úÖ Editores de t√≥picos (editorRef, relatorioRef) - Linhas 884-885
2. ‚úÖ Editor de modelos (modelEditorRef) - Linha 1218
3. ‚úÖ Regenera√ß√£o de relat√≥rios - Linha 1554
4. ‚úÖ Inser√ß√£o de texto gerado por IA (decis√µes) - Linhas 2580-2586
5. ‚úÖ Inser√ß√£o de texto gerado por IA (modelos) - Linhas 2716-2722
6. ‚úÖ Convers√£o HTML para texto plano - Linha 2781
7. ‚úÖ Inser√ß√£o de conte√∫do de modelos - Linha 5107
8. ‚úÖ Mensagens de feedback com interpola√ß√£o - Linhas 5315-5317

CONFIGURA√á√ÉO DE SANITIZA√á√ÉO (linha 503-522):
- Tags permitidas: p, br, div, span, strong, b, em, i, u, ul, ol, li, h1-h6
- Atributos permitidos: class, id, style (limitado)
- Estilos permitidos: font-weight, font-style, text-decoration
- Remove scripts, eventos onclick, e outros vetores de ataque

CASOS N√ÉO SANITIZADOS (seguros):
- innerHTML = '' (limpeza de editores) - Linhas 1142, 7517, 7532, 8014
- innerHTML com texto est√°tico (mensagens) - Linhas 1188, 5319

TESTES SUGERIDOS:
1. Tentar inserir <script>alert('XSS')</script> em editor
2. Tentar inserir <img src=x onerror=alert('XSS')>
3. Verificar que formata√ß√£o b√°sica (negrito, it√°lico) continua funcionando
4. Confirmar que links e estilos maliciosos s√£o removidos

COMPORTAMENTO EM CASO DE FALHA:
- Se DOMPurify n√£o carregar: retorna string vazia (seguro por padr√£o)
- Console mostra avisos quando DOMPurify n√£o est√° pronto
- Loading ass√≠ncrono n√£o bloqueia inicializa√ß√£o da aplica√ß√£o

DEPEND√äNCIAS:
- CDN: https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js
- Carregamento: useEffect na linha 250-276
- Estado: domPurifyReady (linha 247)
*/

// üé® CSS GLOBAL - HOVER EFFECTS (v1.9.13 - Theme-aware)
// Solu√ß√£o: CSS :hover em vez de onMouseEnter/onMouseLeave (elimina re-renders)
const GlobalHoverStyles = () => (
  <style>{`
    /* SPINNER ANIMATION */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-spin { animation: spin 1s linear infinite; }

    /* TOGGLE SWITCH */
    .toggle-switch {
      position: relative;
      width: 36px;
      height: 20px;
      background-color: #4b5563;
      border-radius: 9999px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .toggle-switch.active {
      background-color: #2563eb;
    }
    .toggle-switch .toggle-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background-color: white;
      border-radius: 9999px;
      transition: transform 0.2s;
    }
    .toggle-switch.active .toggle-knob {
      transform: translateX(16px);
    }

    /* HOVER CLASSES - Theme-aware */
    .hover-slate-600:hover:not(:disabled) { background-color: var(--hover-slate-600) !important; }

    /* Accent colors (cores fixas) */
    .hover-blue-700:hover:not(:disabled) { background-color: #1d4ed8 !important; }
    .hover-blue-500:hover:not(:disabled) { background-color: #3b82f6 !important; }
    .hover-purple-700:hover:not(:disabled) { background-color: #7e22ce !important; }
    .hover-green-700:hover:not(:disabled) { background-color: #15803d !important; }
    .hover-red-700:hover:not(:disabled) { background-color: #b91c1c !important; }
    .hover-amber-700:hover:not(:disabled) { background-color: #b45309 !important; }
    .hover-yellow-600:hover:not(:disabled) { background-color: #ca8a04 !important; }
    /* Slate hovers - theme-aware */
    .hover-slate-700:hover:not(:disabled) { background-color: var(--hover-slate-700) !important; }
    .hover-slate-800:hover:not(:disabled) { background-color: var(--hover-slate-800) !important; }
    .hover-orange-700:hover:not(:disabled) { background-color: #c2410c !important; }
    .hover-slate-500:hover:not(:disabled) { background-color: var(--hover-slate-500) !important; }

    /* BACKGROUND HOVERS */
    .hover-red-alpha-20:hover:not(:disabled) { background-color: rgba(239, 68, 68, 0.2) !important; }
    .hover-green-900-alpha-40:hover:not(:disabled) { background-color: rgba(20, 83, 45, 0.4) !important; }

    /* TEXT COLOR HOVERS */
    .hover-text-red-300:hover:not(:disabled) { color: #fca5a5 !important; }
    .hover-text-red-400:hover:not(:disabled) { color: #f87171 !important; }
    .error-close-btn:hover { color: #fca5a5 !important; background-color: rgba(239, 68, 68, 0.2) !important; }
    .hover-theme-text-secondary:hover:not(:disabled) { color: #e2e8f0 !important; }
    .hover-theme-text-tertiary:hover:not(:disabled) { color: #cbd5e1 !important; }
    .hover-text-green-300:hover:not(:disabled) { color: #86efac !important; }
    .hover-text-white:hover:not(:disabled) { color: #ffffff !important; }

    /* v1.20.0: Quick Prompt Buttons */
    .hover-quick-prompt:hover:not(:disabled) {
      background-color: #dbeafe !important;
      border-color: #60a5fa !important;
    }
    .dark .hover-quick-prompt:hover:not(:disabled) {
      background-color: rgba(59, 130, 246, 0.2) !important;
      border-color: #3b82f6 !important;
    }

    /* BACKGROUND HOVERS - Theme-aware */
    .hover-theme-bg-secondary:hover:not(:disabled) { background-color: var(--bg-secondary) !important; }
    .hover-theme-bg-tertiary:hover:not(:disabled) { background-color: var(--bg-tertiary) !important; }

    /* Tab inactive hover - alto contraste */
    .hover-tab-inactive {
      background-color: var(--bg-secondary);
      transition: background-color 0.2s ease;
    }
    .hover-tab-inactive:hover:not(:disabled) {
      background-color: var(--bg-tertiary) !important;
    }

    /* BORDER HOVERS */
    .hover-theme-border:hover { border-color: var(--hover-slate-500) !important; }
    .hover-border-blue-500:hover { border-color: #3b82f6 !important; }
    .hover-border-purple-alpha-30:hover { border-color: rgba(168, 85, 247, 0.3) !important; }

    /* Input com hover - theme-aware */
    .hover-input-slate:hover {
      background-color: var(--bg-hover) !important;
    }

    /* Transform scale hover */
    .hover-scale:hover {
      transform: scale(1.05) !important;
    }

    /* Hover com bases n√£o-transparentes */
    .hover-green-700-from-600:hover {
      background-color: #047857 !important;
    }
    .hover-green-600-from-700:hover {
      background-color: #16a34a !important;
    }
    .hover-blue-600-from-700:hover {
      background-color: #2563eb !important;
    }
    .hover-red-600-from-700:hover {
      background-color: #dc2626 !important;
    }
    .hover-amber-700-from-600:hover {
      background-color: #b45309 !important;
    }
    .hover-purple-700-from-600:hover {
      background-color: #7e22ce !important;
    }
    .hover-blue-alpha-3-from-2:hover:not(:disabled) {
      background-color: rgba(37, 99, 235, 0.3) !important;
    }
    .hover-purple-alpha-3-from-2:hover {
      background-color: rgba(147, 51, 234, 0.3) !important;
    }
    .hover-blue-700-from-600:hover {
      background-color: #1d4ed8 !important;
    }
    .hover-slate-600-from-700:hover {
      background-color: var(--hover-slate-600) !important;
    }

    /* BACKGROUND COLORS - Cores S√≥lidas Adicionais */
    .hover-pink-700:hover:not(:disabled) { background-color: #be185d !important; }
    .hover-blue-alpha-10:hover:not(:disabled) { background-color: rgba(59, 130, 246, 0.1) !important; }
    .hover-slate-alpha-30:hover:not(:disabled) { background-color: rgba(71, 85, 105, 0.3) !important; }
    .hover-purple-400:hover:not(:disabled) { color: #c084fc !important; }
    .hover-yellow-alpha:hover:not(:disabled) { background-color: rgba(234, 179, 8, 0.15) !important; }
    .hover-green-500:hover:not(:disabled) { background-color: #22c55e !important; }

    /* GRADIENTS - Linear Gradient Hovers */
    .hover-gradient-purple-pink:hover:not(:disabled) {
      background-image: linear-gradient(to right, #7e22ce, #db2777) !important;
    }
    .hover-gradient-purple-blue:hover:not(:disabled) {
      background-image: linear-gradient(to right, #7e22ce, #1d4ed8) !important;
    }
    .hover-gradient-blue-purple:hover:not(:disabled) {
      background-image: linear-gradient(to right, #1d4ed8, #7e22ce) !important;
    }
    .hover-gradient-green:hover:not(:disabled) {
      background-image: linear-gradient(to right, #15803d, #047857) !important;
    }

    /* BORDERS - Additional Border Colors */
    .hover-border-purple-500:hover { border-color: #a855f7 !important; }
    .hover-border-purple-alpha-50:hover { border-color: rgba(168, 85, 247, 0.5) !important; }

    /* TRANSFORMS - Scale Effects */
    .hover-scale-125:hover:not(:disabled) {
      transform: scale(1.25) !important;
    }

    /* NESTED HOVERS - Parent:hover Child Effect */
    .hover-label-text-blue:hover span {
      color: #bfdbfe !important;
    }

    .hover-button-contextual {
      background-color: rgba(51, 65, 85, 0.5);
      border-color: #475569;
      transition: all 0.3s ease;
    }
    .hover-button-contextual:hover {
      background-color: rgba(147, 51, 234, 0.2) !important;
      border-color: #a855f7 !important;
    }
    .hover-button-contextual:hover .icon-wrapper {
      background-color: rgba(147, 51, 234, 0.3) !important;
    }

    /* v1.10.9: Bot√£o An√°lise Livre */
    .hover-button-free {
      background-color: rgba(51, 65, 85, 0.5);
      border-color: #475569;
      transition: all 0.3s ease;
    }
    .hover-button-free:hover {
      background-color: rgba(34, 197, 94, 0.2) !important;
      border-color: #22c55e !important;
    }
    .hover-button-free:hover .icon-wrapper {
      background-color: rgba(34, 197, 94, 0.3) !important;
    }

    /* v1.21.16: Tema claro - Bot√£o An√°lise Contextual */
    .hover-button-contextual-light {
      background-color: rgba(147, 51, 234, 0.08);
      border: 1px solid rgba(147, 51, 234, 0.2);
      transition: all 0.3s ease;
    }
    .hover-button-contextual-light:hover {
      background-color: rgba(147, 51, 234, 0.15) !important;
      border-color: #a855f7 !important;
    }
    .hover-button-contextual-light:hover .icon-wrapper {
      background-color: rgba(147, 51, 234, 0.25) !important;
    }

    /* v1.21.16: Tema claro - Bot√£o An√°lise Livre */
    .hover-button-free-light {
      background-color: rgba(34, 197, 94, 0.08);
      border: 1px solid rgba(34, 197, 94, 0.2);
      transition: all 0.3s ease;
    }
    .hover-button-free-light:hover {
      background-color: rgba(34, 197, 94, 0.15) !important;
      border-color: #22c55e !important;
    }
    .hover-button-free-light:hover .icon-wrapper {
      background-color: rgba(34, 197, 94, 0.25) !important;
    }

    /* v1.10.9: Label hover para checkbox purple */
    .hover-label-text-purple:hover span {
      color: #a855f7 !important;
    }

    /* v1.10.10: Label hover para checkbox green */
    .hover-label-text-green:hover span {
      color: #22c55e !important;
    }

    .hover-category-select {
      background-color: var(--hover-slate-600);
      transition: background-color 0.3s ease;
    }
    .hover-category-select:hover:not(:disabled) {
      background-color: var(--hover-slate-500) !important;
    }

    .hover-delete-topic {
      color: #f87171;
      transition: all 0.3s ease;
    }
    .hover-delete-topic:hover:not(:disabled) {
      color: #fca5a5 !important;
      background-color: rgba(127, 29, 29, 0.2) !important;
    }

    .hover-delete-proof {
      transition: background-color 0.3s ease;
    }
    .hover-delete-proof:hover:not(:disabled) {
      background-color: rgba(239, 68, 68, 0.2) !important;
    }

    .hover-proof-panel {
      background-color: rgba(20, 83, 45, 0.3);
      transition: background-color 0.3s ease;
    }
    .hover-proof-panel:hover {
      background-color: rgba(20, 83, 45, 0.4) !important;
    }

    .hover-delete-all {
      color: #94a3b8;
      transition: all 0.3s ease;
    }
    .hover-delete-all:hover:not(:disabled) {
      color: #f87171 !important;
      background-color: rgba(127, 29, 29, 0.2) !important;
    }

    /* BACKGROUNDS - From Transparent (theme-aware) */
    .hover-slate-600-from-transparent:hover:not(:disabled) {
      background-color: var(--hover-slate-600) !important;
    }
    .hover-slate-700-from-transparent:hover:not(:disabled) {
      background-color: var(--hover-slate-700) !important;
    }

    /* BORDERS with Background Combo */
    .hover-border-blue-from-slate {
      transition: all 0.3s ease;
    }
    .hover-border-blue-from-slate:hover {
      border-color: #3b82f6 !important;
    }

    /* TEXT COLORS */
    .hover-text-blue-300:hover:not(:disabled) {
      color: #93c5fd !important;
    }
    .hover-text-purple-400:hover:not(:disabled) {
      color: #c084fc !important;
    }

    /* COMPLEX NESTED - Specific Components */
    .hover-pagination-prev:hover:not(:disabled) {
      background-color: var(--hover-slate-600) !important;
    }
    .hover-pagination-next:hover:not(:disabled) {
      background-color: var(--hover-slate-600) !important;
    }

    /* RED DELETE BUTTONS - From red-600 to red-700 */
    .hover-red-700-from-600 {
      background-color: #dc2626;
      transition: background-color 0.3s ease;
    }
    .hover-red-700-from-600:hover:not(:disabled) {
      background-color: #b91c1c !important;
    }

    /* BORDER COLORS - Model Cards (theme-aware) */
    .hover-theme-border-from-600 {
      border-color: var(--hover-slate-600);
      transition: border-color 0.3s ease;
    }
    .hover-theme-border-from-600:hover {
      border-color: var(--hover-slate-500) !important;
    }

    /* TEXT COLORS - Proof Elements */
    .hover-text-blue-400-from-300 {
      color: #60a5fa;
      transition: color 0.3s ease;
    }
    .hover-text-blue-400-from-300:hover:not(:disabled) {
      color: #93c5fd !important;
    }

    .hover-text-red-400-from-300 {
      color: #f87171;
      transition: color 0.3s ease;
    }
    .hover-text-red-400-from-300:hover:not(:disabled) {
      color: #fca5a5 !important;
    }

    .hover-text-purple-400-from-400 {
      color: #c084fc;
      transition: color 0.3s ease;
    }
    .hover-text-purple-400-from-400:hover:not(:disabled) {
      color: #e9d5ff !important;
    }

    .hover-text-white-from-slate {
      color: #94a3b8;
      transition: color 0.3s ease;
    }
    .hover-text-white-from-slate:hover:not(:disabled) {
      color: #ffffff !important;
    }

    /* SLATE BACKGROUNDS (theme-aware) */
    .hover-slate-700-from-600 {
      background-color: var(--hover-slate-600);
      transition: background-color 0.3s ease;
    }
    .hover-slate-700-from-600:hover:not(:disabled) {
      background-color: var(--hover-slate-700) !important;
    }

    /* ALPHA BACKGROUNDS - From Transparent */
    .hover-blue-alpha-10-from-transparent {
      background-color: transparent;
      transition: all 0.2s ease;
    }
    .hover-blue-alpha-10-from-transparent:hover:not(:disabled) {
      background-color: rgba(59, 130, 246, 0.1) !important;
    }

    .hover-slate-alpha-30-from-transparent {
      background-color: transparent;
      transition: background-color 0.3s ease;
    }
    .hover-slate-alpha-30-from-transparent:hover:not(:disabled) {
      background-color: var(--bg-hover) !important;
      opacity: 0.3;
    }

    /* SuggestionCard insert button */
    .hover-suggestion-insert {
      background-color: #2563eb;
      transition: all 0.3s ease;
    }
    .hover-suggestion-insert:hover:not(:disabled) {
      background-color: #3b82f6 !important;
      transform: scale(1.02) !important;
    }

    /* 2. TopicCard drag area - bg rgba with subtle change */
    .hover-topic-drag-area {
      background-color: rgba(37, 99, 235, 0.1);
      transition: background-color 0.2s ease;
    }
    .hover-topic-drag-area:hover {
      background-color: rgba(37, 99, 235, 0.15) !important;
    }

    /* 3. Merge confirm button - green bg + scale */
    .hover-merge-confirm-btn {
      background-color: #059669;
      transition: all 0.3s ease;
    }
    .hover-merge-confirm-btn:hover:not(:disabled) {
      background-color: #10b981 !important;
      transform: scale(1.05) !important;
    }

    /* 4. Merge cancel button - red bg + scale */
    .hover-merge-cancel-btn {
      background-color: #dc2626;
      transition: all 0.3s ease;
    }
    .hover-merge-cancel-btn:hover:not(:disabled) {
      background-color: #ef4444 !important;
      transform: scale(1.05) !important;
    }

    /* 5. Icon hover blue - bg alpha + scale 1.1 */
    .hover-icon-blue-scale {
      background-color: transparent;
      transition: all 0.3s ease;
    }
    .hover-icon-blue-scale:hover:not(:disabled) {
      background-color: rgba(59, 130, 246, 0.3) !important;
      transform: scale(1.1) !important;
    }

    /* 6. Icon hover green - bg alpha + scale 1.1 */
    .hover-icon-green-scale {
      background-color: transparent;
      transition: all 0.3s ease;
    }
    .hover-icon-green-scale:hover:not(:disabled) {
      background-color: rgba(34, 197, 94, 0.3) !important;
      transform: scale(1.1) !important;
    }

    /* 7. Icon hover red - bg alpha + scale 1.1 */
    .hover-icon-red-scale {
      background-color: transparent;
      transition: all 0.3s ease;
    }
    .hover-icon-red-scale:hover:not(:disabled) {
      background-color: rgba(239, 68, 68, 0.3) !important;
      transform: scale(1.1) !important;
    }

    .hover-bg-red-alpha {
      transition: background-color 0.3s ease;
    }
    .hover-bg-red-alpha:hover:not(:disabled) {
      background-color: rgba(239, 68, 68, 0.2) !important;
    }

    /* 8. Bulk upload drop area - border + bg combo */
    .hover-bulk-upload-area {
      border-color: #475569;
      background-color: transparent;
      transition: all 0.3s ease;
    }
    .hover-bulk-upload-area:hover {
      border-color: #a855f7 !important;
      background-color: rgba(51, 65, 85, 0.3) !important;
    }

    /* 9. Warning button (yellow) - bg + scale */
    .hover-warning-yellow-btn {
      background-color: #eab308;
      transition: all 0.3s ease;
    }
    .hover-warning-yellow-btn:hover:not(:disabled) {
      background-color: #facc15 !important;
      transform: scale(1.05) !important;
    }

    /* Anima√ß√£o pulse */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.05);
      }
    }

    /* Classes para hovers simples */
    .hover-slate-600-from-slate-500 {
      background-color: #64748b;
      transition: background-color 0.3s ease;
    }
    .hover-slate-600-from-slate-500:hover:not(:disabled) {
      background-color: #475569 !important;
    }

    .hover-orange-700-from-600 {
      background-color: #ea580c;
      transition: background-color 0.3s ease;
    }
    .hover-orange-700-from-600:hover:not(:disabled) {
      background-color: #c2410c !important;
    }

    /* FASE 4-5: Classes para gradientes com hover mais escuro */
    .hover-gradient-purple-pink-darker {
      background-image: linear-gradient(to right, #9333ea, #ec4899);
      transition: background-image 0.3s ease;
    }
    .hover-gradient-purple-pink-darker:hover:not(:disabled) {
      background-image: linear-gradient(to right, #7e22ce, #db2777) !important;
    }

    .hover-gradient-purple-blue-darker {
      background-image: linear-gradient(to right, #9333ea, #2563eb);
      transition: background-image 0.3s ease;
    }
    .hover-gradient-purple-blue-darker:hover:not(:disabled) {
      background-image: linear-gradient(to right, #7e22ce, #1d4ed8) !important;
    }

    /* FASE 6: Classes para bot√µes condicionais */
    .hover-extract-model {
      background-color: #db2777;
      transition: background-color 0.3s ease;
    }
    .hover-extract-model:hover:not(:disabled) {
      background-color: #be185d !important;
    }
    .hover-extract-model.disabled {
      background-color: #9ca3af !important;
      cursor: not-allowed;
    }

    .hover-regenerate-btn {
      background-color: #9333ea;
      transition: background-color 0.3s ease;
    }
    .hover-regenerate-btn:hover:not(:disabled) {
      background-color: #7e22ce !important;
    }
    .hover-regenerate-btn.disabled {
      background-color: #6b7280 !important;
      cursor: not-allowed;
    }

    /* FASE 9: Classes para pagina√ß√£o (theme-aware) */
    .hover-pagination-btn {
      background-color: var(--hover-slate-700);
      transition: background-color 0.3s ease;
    }
    .hover-pagination-btn:hover:not(:disabled) {
      background-color: var(--hover-slate-600) !important;
    }

    .hover-pagination-page {
      transition: background-color 0.3s ease;
    }
    .hover-pagination-page:hover:not([data-active]) {
      background-color: var(--hover-slate-600) !important;
    }

    /* ModelPreviewModal - Performance Otimizado */
    .model-preview-content {
      color: var(--text-tertiary);
      line-height: 1.75;
      font-size: 1rem;
      user-select: text;
      -webkit-user-select: text;
    }
    .model-preview-content p {
      margin-bottom: 1em;
      color: var(--text-tertiary);
    }
    /* Sele√ß√£o otimizada - cor s√≥lida sem transpar√™ncia */
    .model-preview-content ::selection {
      background-color: var(--selection-bg);
      color: var(--selection-text);
    }
    .model-preview-content ::-moz-selection {
      background-color: var(--selection-bg);
      color: var(--selection-text);
    }
    .model-preview-content strong {
      font-weight: 600;
      color: var(--text-primary);
    }
    .model-preview-content em {
      font-style: italic;
    }
    .model-preview-content ul,
    .model-preview-content ol {
      margin-left: 1.5em;
      margin-bottom: 1em;
      padding-left: 0.5em;
    }
    .model-preview-content li {
      margin-bottom: 0.5em;
      color: var(--text-tertiary);
    }
    .model-preview-content h1,
    .model-preview-content h2,
    .model-preview-content h3,
    .model-preview-content h4 {
      font-weight: 700;
      color: var(--text-primary);
      margin-top: 1.5em;
      margin-bottom: 0.75em;
      line-height: 1.3;
    }
    .model-preview-content h1 { font-size: 1.875rem; }
    .model-preview-content h2 { font-size: 1.5rem; }
    .model-preview-content h3 { font-size: 1.25rem; }
    .model-preview-content h4 { font-size: 1.125rem; }
    .model-preview-content blockquote {
      margin: 1.5em 0;
      padding-left: 1em;
      border-left: 4px solid var(--border-primary);
      color: var(--text-muted);
      font-style: italic;
    }

    /* GLOBAL EDITOR */
    .hover-cyan-700-from-600:hover:not(:disabled) {
      background-color: #0e7490 !important;
    }

    /* Se√ß√µes do Editor Global */
    .global-section {
      margin: 1.5rem 0;
      border-radius: 0.5rem;
      border: 1px solid var(--border-secondary);
      background-color: var(--bg-secondary);
    }

    .global-section:first-child {
      margin-top: 0;
    }

    .section-header {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), transparent);
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-secondary);
      border-radius: 0.5rem 0.5rem 0 0;
      user-select: none;
      pointer-events: none;
    }

    .section-header[contenteditable="false"] {
      cursor: default;
    }

    .section-title {
      font-weight: 700;
      font-size: 1rem;
      color: #60a5fa;
    }

    .section-category {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-left: 0.5rem;
    }

    .section-content {
      padding: 1rem;
      min-height: 80px;
    }

    .section-content:focus {
      outline: none;
    }

    .subsection {
      margin: 0.75rem 0;
      padding-left: 0.5rem;
      border-left: 3px solid var(--border-secondary);
    }

    .subsection-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
      user-select: none;
      pointer-events: none;
    }

    .subsection-label[contenteditable="false"] {
      cursor: default;
    }

    /* Container do editor global (v1.11.2 - altura 100%) */
    .global-editor-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .global-editor-container .ql-toolbar {
      flex-shrink: 0;
    }

    .global-editor-container .ql-container {
      flex: 1;
      overflow-y: auto;
      min-height: 0; /* Importante para flexbox */
    }

    .global-editor-container .ql-editor {
      min-height: 100%;
    }

    /* v1.12.1: FieldEditor - Fix dupla scrollbar */
    .field-editor-content .ql-container {
      border: none !important;
    }

    .field-editor-content .ql-editor {
      max-height: 400px;
      overflow-y: auto;
      padding: 0.75rem;
    }

    .field-editor-content .ql-editor:focus {
      outline: none;
    }

  `}</style>
);

// üé® THEME STYLES - CSS Variables para Tema Claro/Escuro
const ThemeStyles = () => (
  <style>{`
    /* DARK THEME (Default) */
    :root {

      /* Backgrounds */
      --bg-app: #0f172a;
      --bg-primary: #1e293b;
      --bg-secondary: #334155;
      --bg-tertiary: #475569;
      --bg-input: #334155;
      --bg-hover: #475569;
      --bg-card: rgba(51, 65, 85, 0.3);
      --bg-card-solid: #334155;

      /* Text */
      --text-primary: #ffffff;
      --text-secondary: #e2e8f0;
      --text-tertiary: #cbd5e1;
      --text-muted: #94a3b8;
      --text-disabled: #64748b;

      /* Borders */
      --border-primary: #475569;
      --border-secondary: #334155;
      --border-input: #475569;

      /* Modal/Overlay */
      --overlay-bg: rgba(0, 0, 0, 0.8);
      --modal-bg: #1e293b;
      --modal-border: #334155;
      --modal-glow: 0 0 40px rgba(139, 92, 246, 0.15), 0 0 80px rgba(59, 130, 246, 0.1);

      /* Gradients */
      --gradient-app-from: #0f172a;
      --gradient-app-via: #1e293b;
      --gradient-app-to: #0f172a;

      /* Hover state colors (for GlobalHoverStyles) */
      --hover-slate-500: #64748b;
      --hover-slate-600: #475569;
      --hover-slate-700: #334155;
      --hover-slate-800: #1e293b;

      /* Semi-transparent backgrounds */
      --bg-app-50: rgba(15, 23, 42, 0.5);
      --bg-primary-50: rgba(30, 41, 59, 0.5);
      --bg-secondary-50: rgba(51, 65, 85, 0.5);
      --bg-secondary-30: rgba(51, 65, 85, 0.3);
      --bg-tertiary-50: rgba(71, 85, 105, 0.5);
      --bg-tertiary-30: rgba(71, 85, 105, 0.3);

      /* Accent Colors - Dark Theme */
      --accent-amber: #fbbf24;
      --accent-amber-muted: #fcd34d;
      --accent-blue: #60a5fa;
      --accent-blue-muted: #93c5fd;
      --accent-purple: #c084fc;
      --accent-green: #4ade80;
      --accent-red: #f87171;

      /* Accent Backgrounds - Dark Theme */
      --accent-amber-bg: rgba(251, 191, 36, 0.15);
      --accent-blue-bg: rgba(96, 165, 250, 0.15);
      --accent-purple-bg: rgba(192, 132, 252, 0.15);
      --accent-green-bg: rgba(74, 222, 128, 0.15);
      --accent-red-bg: rgba(248, 113, 113, 0.15);

      /* Result Dropdown Colors - Dark Theme (light text on dark bg) */
      --result-green: #d1fae5;
      --result-red: #fee2e2;
      --result-amber: #fef3c7;
      --result-muted: #94a3b8;

      /* Special */
      --shadow-color: rgba(0, 0, 0, 0.5);
      --selection-bg: #3b82f6;
      --selection-text: #ffffff;
    }

    /* LIGHT THEME */
    [data-theme="light"] {
      /* Backgrounds */
      --bg-app: #f5f3ef;
      --bg-primary: #fefcf3;
      --bg-secondary: #e8e6e1;
      --bg-tertiary: #d4d2cd;
      --bg-input: #fefcf3;
      --bg-hover: #d4d2cd;
      --bg-card: rgba(254, 252, 243, 0.9);
      --bg-card-solid: #fefcf3;

      /* Text - Stone (warm gray) */
      --text-primary: #1c1917;
      --text-secondary: #292524;
      --text-tertiary: #44403c;
      --text-muted: #78716c;
      --text-disabled: #a8a29e;

      /* Borders - Stone (warm gray) */
      --border-primary: #a8a29e;
      --border-secondary: #d6d3d1;
      --border-input: #a8a29e;

      /* Modal/Overlay */
      --overlay-bg: rgba(0, 0, 0, 0.5);
      --modal-bg: #fefcf3;
      --modal-border: #d4d2cd;
      --modal-glow: 0 0 30px rgba(0, 0, 0, 0.1), 0 0 60px rgba(0, 0, 0, 0.05);

      /* Gradients */
      --gradient-app-from: #f5f3ef;
      --gradient-app-via: #fefcf3;
      --gradient-app-to: #f5f3ef;

      /* Hover state colors - Stone (warm gray) */
      --hover-slate-500: #78716c;
      --hover-slate-600: #a8a29e;
      --hover-slate-700: #d6d3d1;
      --hover-slate-800: #e7e5e3;

      /* Semi-transparent backgrounds - Stone (warm gray) */
      --bg-app-50: rgba(245, 243, 239, 0.5);
      --bg-primary-50: rgba(254, 252, 243, 0.5);
      --bg-secondary-50: rgba(214, 211, 209, 0.5);
      --bg-secondary-30: rgba(214, 211, 209, 0.3);
      --bg-tertiary-50: rgba(168, 162, 158, 0.5);
      --bg-tertiary-30: rgba(168, 162, 158, 0.3);

      /* Accent Colors - Light Theme (DARKER for contrast) */
      --accent-amber: #b45309;
      --accent-amber-muted: #d97706;
      --accent-blue: #1d4ed8;
      --accent-blue-muted: #2563eb;
      --accent-purple: #7c3aed;
      --accent-green: #15803d;
      --accent-red: #b91c1c;

      /* Accent Backgrounds - Light Theme (more visible) */
      --accent-amber-bg: rgba(251, 191, 36, 0.25);
      --accent-blue-bg: rgba(96, 165, 250, 0.25);
      --accent-purple-bg: rgba(192, 132, 252, 0.25);
      --accent-green-bg: rgba(74, 222, 128, 0.25);
      --accent-red-bg: rgba(248, 113, 113, 0.25);

      /* Result Dropdown Colors - Light Theme (DARKER for contrast) */
      --result-green: #047857;
      --result-red: #b91c1c;
      --result-amber: #b45309;
      --result-muted: #475569;

      /* Special */
      --shadow-color: rgba(0, 0, 0, 0.1);
      --selection-bg: #3b82f6;
      --selection-text: #ffffff;
    }

    /* UTILITY CLASSES - Backgrounds */
    .theme-bg-app { background-color: var(--bg-app); }
    .theme-bg-primary { background-color: var(--bg-primary); }
    .theme-bg-secondary { background-color: var(--bg-secondary); }
    .theme-bg-tertiary { background-color: var(--bg-tertiary); }
    .theme-bg-input { background-color: var(--bg-input); }
    .theme-bg-card { background-color: var(--bg-card); }
    .theme-bg-card-solid { background-color: var(--bg-card-solid); }
    .theme-bg-modal { background-color: var(--modal-bg); }
    .theme-bg-overlay { background-color: var(--overlay-bg); }
    .theme-bg-app-50 { background-color: var(--bg-app-50); }
    .theme-bg-primary-50 { background-color: var(--bg-primary-50); }
    .theme-bg-secondary-50 { background-color: var(--bg-secondary-50); }
    .theme-bg-secondary-30 { background-color: var(--bg-secondary-30); }
    .theme-bg-tertiary-50 { background-color: var(--bg-tertiary-50); }
    .theme-bg-tertiary-30 { background-color: var(--bg-tertiary-30); }

    /* Text */
    .theme-text-primary { color: var(--text-primary); }
    .theme-text-secondary { color: var(--text-secondary); }
    .theme-text-tertiary { color: var(--text-tertiary); }
    .theme-text-muted { color: var(--text-muted); }
    .theme-text-disabled { color: var(--text-disabled); }

    /* Accent Text (theme-aware) */
    .theme-text-amber { color: var(--accent-amber); }
    .theme-text-amber-muted { color: var(--accent-amber-muted); }
    .theme-text-blue { color: var(--accent-blue); }
    .theme-text-blue-muted { color: var(--accent-blue-muted); }
    .theme-text-purple { color: var(--accent-purple); }
    .theme-text-green { color: var(--accent-green); }
    .theme-text-red { color: var(--accent-red); }

    /* Accent Backgrounds (theme-aware) */
    .theme-bg-amber-accent { background-color: var(--accent-amber-bg); }
    .theme-bg-blue-accent { background-color: var(--accent-blue-bg); }
    .theme-bg-purple-accent { background-color: var(--accent-purple-bg); }
    .theme-bg-green-accent { background-color: var(--accent-green-bg); }
    .theme-bg-red-accent { background-color: var(--accent-red-bg); }

    /* Borders */
    .theme-border { border-color: var(--border-primary); }
    .theme-border-primary { border-color: var(--border-primary); }
    .theme-border-secondary { border-color: var(--border-secondary); }
    .theme-border-input { border-color: var(--border-input); }
    .theme-border-modal { border-color: var(--modal-border); }

    /* Dividers */
    .theme-divide { border-color: var(--border-secondary); }

    /* Placeholders */
    .theme-placeholder::placeholder { color: var(--text-muted); }

    /* Gradients */
    .theme-gradient-app {
      background: linear-gradient(to bottom right, var(--gradient-app-from), var(--gradient-app-via), var(--gradient-app-to));
    }
    .theme-gradient-card-50 {
      background: linear-gradient(to bottom right, var(--bg-primary-50), var(--bg-app-50));
    }

    /* Selection */
    .theme-selection::selection {
      background-color: var(--selection-bg);
      color: var(--selection-text);
    }

    /* Shadows */
    .theme-shadow {
      box-shadow: 0 25px 50px -12px var(--shadow-color);
    }

    /* Combined utility classes for common patterns */
    .theme-modal-overlay {
      background-color: var(--overlay-bg);
    }

    .theme-modal-container {
      background-color: var(--modal-bg);
      border-color: var(--modal-border);
    }

    .theme-input {
      background-color: var(--bg-input);
      border-color: var(--border-input);
      color: var(--text-primary);
    }
    .theme-input::placeholder {
      color: var(--text-muted);
    }

    .theme-card {
      background-color: var(--bg-card);
      border-color: var(--border-primary);
    }

    /* Hover utilities using CSS variables */
    .theme-hover-bg:hover:not(:disabled) {
      background-color: var(--bg-hover) !important;
    }

    .theme-hover-border:hover {
      border-color: var(--border-primary) !important;
    }

    /* Theme-aware button base (for slate buttons) */
    .theme-btn-secondary {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-primary);
    }
    .theme-btn-secondary:hover:not(:disabled) {
      background-color: var(--bg-tertiary) !important;
    }

    /* Theme-aware tabs */
    .theme-tab {
      background-color: var(--bg-card);
      color: var(--text-tertiary);
      border-color: var(--border-secondary);
    }
    .theme-tab-active {
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    /* Info box base styles (dark theme default) */
    .theme-info-box {
      background-color: rgba(30, 58, 138, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 0.5rem;
      padding: 0.75rem;
    }
    .theme-warning-box {
      background-color: rgba(120, 53, 15, 0.2);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 0.5rem;
      padding: 0.75rem;
    }
    .theme-error-box {
      background-color: rgba(127, 29, 29, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 0.5rem;
      padding: 0.75rem;
    }
    .theme-success-box {
      background-color: rgba(20, 83, 45, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 0.5rem;
      padding: 0.75rem;
    }

    /* Info box variants for light theme */
    [data-theme="light"] .theme-info-box {
      background-color: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
    }
    [data-theme="light"] .theme-warning-box {
      background-color: rgba(245, 158, 11, 0.1);
      border-color: rgba(245, 158, 11, 0.3);
    }
    [data-theme="light"] .theme-error-box {
      background-color: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
    }
    [data-theme="light"] .theme-success-box {
      background-color: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.3);
    }

    /* v1.22.02: Badge variants for status tags - dark theme default */
    .theme-badge-success {
      background-color: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }
    .theme-badge-error {
      background-color: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    .theme-badge-purple {
      background-color: rgba(168, 85, 247, 0.2);
      color: #a855f7;
    }
    .theme-badge-blue {
      background-color: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    /* Light theme badge adjustments */
    [data-theme="light"] .theme-badge-success {
      background-color: rgba(22, 163, 74, 0.15);
      color: #15803d;
    }
    [data-theme="light"] .theme-badge-error {
      background-color: rgba(220, 38, 38, 0.15);
      color: #b91c1c;
    }
    [data-theme="light"] .theme-badge-purple {
      background-color: rgba(147, 51, 234, 0.15);
      color: #7c3aed;
    }
    [data-theme="light"] .theme-badge-blue {
      background-color: rgba(37, 99, 235, 0.15);
      color: #1d4ed8;
    }

    /* Toast notification styles - dark theme default */
    .theme-toast-success {
      background-color: rgba(20, 83, 45, 0.95);
      border-color: rgba(34, 197, 94, 0.5);
      color: white;
    }
    .theme-toast-error {
      background-color: rgba(127, 29, 29, 0.95);
      border-color: rgba(239, 68, 68, 0.5);
      color: white;
    }
    .theme-toast-info {
      background-color: rgba(30, 58, 138, 0.95);
      border-color: rgba(59, 130, 246, 0.5);
      color: white;
    }
    .theme-toast-warning {
      background-color: rgba(120, 53, 15, 0.95);
      border-color: rgba(245, 158, 11, 0.5);
      color: white;
    }
    .theme-autosave {
      background-color: rgba(22, 101, 52, 0.95);
      border-color: rgba(34, 197, 94, 0.3);
      color: white;
    }

    /* Toast notification styles - light theme */
    [data-theme="light"] .theme-toast-success {
      background-color: rgba(34, 197, 94, 0.95);
      border-color: rgba(22, 101, 52, 0.5);
      color: white;
    }
    [data-theme="light"] .theme-toast-error {
      background-color: rgba(239, 68, 68, 0.95);
      border-color: rgba(185, 28, 28, 0.5);
      color: white;
    }
    [data-theme="light"] .theme-toast-info {
      background-color: rgba(59, 130, 246, 0.95);
      border-color: rgba(30, 64, 175, 0.5);
      color: white;
    }
    [data-theme="light"] .theme-toast-warning {
      background-color: rgba(254, 243, 199, 0.98);
      border-color: rgba(245, 158, 11, 0.5);
      color: #78350f;
    }
    [data-theme="light"] .theme-autosave {
      background-color: rgba(34, 197, 94, 0.95);
      border-color: rgba(22, 101, 52, 0.3);
      color: white;
    }

    /* v1.9.20: Fullscreen Editor - v1.9.31: SEM padding para eliminar gap */
    .editor-fullscreen {
      position: fixed !important;
      inset: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 9999 !important;
      background: var(--bg-primary) !important;
      padding: 0.5rem !important;
      margin: 0 !important;
      display: flex !important;
      flex-direction: column !important;
      overflow: hidden !important;
      box-sizing: border-box !important;
    }
    /* v1.9.31: Garantir altura total do fullscreen - N√ÉO afeta split-divider */
    .editor-fullscreen > .split-editor-pane,
    .editor-fullscreen > div:first-child:not(.split-divider) {
      flex: 1 1 0% !important;
      min-height: 0 !important;
      display: flex !important;
      flex-direction: column !important;
      margin: 0 !important;
    }
    /* v1.9.31: Sem gap no in√≠cio */
    .editor-fullscreen > div:first-child > *:first-child {
      margin-top: 0 !important;
    }
    /* v1.9.32: Removido override de .split-divider - a regra original √© suficiente */
    /* v1.9.27: CSS simplificado para fullscreen (Quill recriado via key) */
    /* v1.9.32: CSS LIMPO - removido > * que afetava toolbar */
    .fullscreen-editor-wrapper {
      flex: 1 1 0% !important;
      display: flex !important;
      flex-direction: column !important;
      min-height: 0 !important;
      max-height: none !important;
      height: 100% !important;
      overflow: hidden !important;
    }
    /* v1.9.32: Regra espec√≠fica para ql-container (n√£o usa > * wildcard) */
    .fullscreen-editor-wrapper .ql-container {
      flex: 1 1 0% !important;
      min-height: 0 !important;
      overflow: hidden !important;
    }
    .fullscreen-editor-wrapper .ql-editor {
      height: 100% !important;
      max-height: 100% !important;
      overflow-y: auto !important;
    }

    /* v1.9.28/v1.9.31: For√ßar altura 100% no QuillEditorBase em fullscreen */
    .fullscreen-quill-fill {
      flex: 1 1 0% !important;
      display: flex !important;
      flex-direction: column !important;
      min-height: 0 !important;
      max-height: 100% !important;
      height: 100% !important;
      overflow: hidden !important;
    }
    /* v1.9.32: Toolbar N√ÉO expande - usa flex shorthand */
    .fullscreen-quill-fill .ql-toolbar {
      flex: 0 0 auto !important;
    }
    .fullscreen-quill-fill .ql-container {
      flex: 1 1 0% !important;
      min-height: 0 !important;
      max-height: 100% !important;
      height: 100% !important;
      overflow: hidden !important;
    }
    .fullscreen-quill-fill .ql-editor {
      height: 100% !important;
      overflow-y: auto !important;
    }

    /* v1.10.13: Quick Edit no ModelPreviewModal - for√ßa scroll interno no editor */
    .quick-edit-wrapper {
      display: flex !important;
      flex-direction: column !important;
    }
    .quick-edit-wrapper .ql-toolbar {
      flex: 0 0 auto !important;
    }
    .quick-edit-wrapper .ql-container {
      flex: 1 1 0% !important;
      display: flex !important;
      flex-direction: column !important;
      min-height: 0 !important;
      overflow: hidden !important;
    }
    .quick-edit-wrapper .ql-editor {
      flex: 1 1 0% !important;
      overflow-y: auto !important;
      min-height: 0 !important;
    }

    /* v1.9.22: Esconder tooltip do Quill (link removido) */
    .ql-tooltip {
      display: none !important;
    }

    /* v1.9.21: Split Window */
    .editor-fullscreen-split {
      display: flex !important;
      flex-direction: row !important;
    }
    .split-editor-pane {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }
    /* v1.9.34: Permitir width controlar tamanho em split mode (override flex: 1) */
    .editor-fullscreen.editor-fullscreen-split > .split-editor-pane {
      flex: none !important;
    }
    /* v1.9.33: Garantir interatividade do divider */
    .split-divider {
      width: 8px;
      background: var(--bg-secondary);
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background-color 0.2s;
      z-index: 10;
      position: relative;
      pointer-events: auto !important;
      user-select: none;
    }
    .split-divider:hover {
      background: var(--bg-tertiary);
    }
    .split-divider-handle {
      color: var(--text-muted);
      opacity: 0.5;
    }
    .split-divider:hover .split-divider-handle {
      opacity: 1;
    }
    .model-search-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--bg-primary);
      border-left: 1px solid var(--border-primary);
    }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  `}</style>
);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üõ°Ô∏è SE√á√ÉO 9: ERROR BOUNDARY & EXPORT
// Tratamento de erros com fallback, wrapper SentencifyAI, export default
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// üõ°Ô∏è ERROR BOUNDARY (v1.8.5) - Previne tela branca em erros
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      hasError: false,
      error: null,
      errorInfo: null
    };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {

    this.setState({ error, errorInfo });

    // Salvar log de erro
    try {
      const errorLog = {
        timestamp: new Date().toISOString(),
        error: error.toString(),
        stack: error.stack,
        componentStack: errorInfo.componentStack,
        userAgent: navigator.userAgent
      };
      localStorage.setItem('sentencify-last-error', JSON.stringify(errorLog));
    } catch (e) {
    }
  }

  exportEmergencyData = () => {
    try {
      const session = localStorage.getItem('sentencifySession');
      const aiSettings = localStorage.getItem('sentencify-ai-settings');
      const models = localStorage.getItem('sentencify-models');

      const emergencyData = {
        exportDate: new Date().toISOString(),
        session: session ? JSON.parse(session) : null,
        aiSettings: aiSettings ? JSON.parse(aiSettings) : null,
        models: models ? JSON.parse(models) : null,
        error: {
          message: this.state.error?.toString(),
          stack: this.state.error?.stack,
          componentStack: this.state.errorInfo?.componentStack
        }
      };

      const blob = new Blob([JSON.stringify(emergencyData, null, 2)], {
        type: 'application/json'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sentencify-emergency-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert('‚úÖ Dados exportados! Verifique seus downloads.');
    } catch (e) {
      alert('‚ùå Erro ao exportar: ' + e.message);
    }
  };

  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen bg-gray-900 text-white p-8 flex items-center justify-center">
          <div className="max-w-2xl w-full bg-gray-800 rounded-lg p-6 shadow-2xl border border-red-500/30">

            {/* Header */}
            <div className="flex items-center gap-3 mb-4">
              <AlertCircle className="w-10 h-10 text-red-400" />
              <div>
                <h1 className="text-2xl font-bold text-red-400">Erro na Aplica√ß√£o</h1>
                <p className="text-gray-400 text-sm">Algo inesperado aconteceu</p>
              </div>
            </div>

            {/* Mensagem */}
            <div className="bg-gray-700/50 rounded p-4 mb-4 border border-gray-600">
              <p className="theme-text-secondary mb-2">
                <strong className="text-green-400">Boa not√≠cia:</strong> Seus dados est√£o seguros.
              </p>
              <p className="theme-text-muted text-sm">
                Todas suas informa√ß√µes foram salvas automaticamente no navegador.
              </p>
            </div>

            {/* Bot√µes */}
            <div className="flex gap-3 mb-4">
              <button
                onClick={() => window.location.reload()}
                className="flex-1 bg-blue-600 hover:bg-blue-500 text-white px-4 py-3 rounded font-semibold flex items-center justify-center gap-2 transition-colors"
              >
                <RefreshCw className="w-4 h-4" />
                Recarregar
              </button>

              <button
                onClick={this.exportEmergencyData}
                className="flex-1 bg-green-600 hover:bg-green-500 text-white px-4 py-3 rounded font-semibold flex items-center justify-center gap-2 transition-colors"
              >
                <Download className="w-4 h-4" />
                Exportar Backup
              </button>
            </div>

            {/* Instru√ß√µes */}
            <div className="theme-info-box mb-4">
              <h3 className="font-semibold theme-text-blue mb-1 flex items-center gap-2 text-sm">
                <Info className="w-4 h-4" />
                O que fazer:
              </h3>
              <ol className="theme-text-muted text-sm ml-5 list-decimal space-y-1">
                <li>Clique em "Recarregar"</li>
                <li>Se persistir, exporte o backup</li>
                <li>Recarregue o navegador (F5)</li>
              </ol>
            </div>

            {/* Stack trace */}
            <details className="bg-gray-900/50 rounded border border-gray-700">
              <summary className="cursor-pointer p-3 hover:bg-gray-700/30 flex items-center gap-2 font-semibold text-sm">
                <Code className="w-4 h-4 text-yellow-400" />
                Detalhes T√©cnicos
              </summary>
              <div className="p-3 border-t border-gray-700">
                <pre className="text-xs theme-text-red bg-gray-950 p-2 rounded overflow-auto max-h-48">
                  {this.state.error?.toString()}
                  {this.state.error?.stack && '\n\n' + this.state.error.stack}
                  {this.state.errorInfo?.componentStack && '\n\nComponent Stack:' + this.state.errorInfo.componentStack}
                </pre>
              </div>
            </details>

            {/* Footer */}
            <div className="mt-4 text-center text-gray-500 text-xs">
              <p>SentencifyAI v{APP_VERSION} - <span className="text-amber-500">PROT√ìTIPO</span></p>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

// üì§ EXPORT
// v1.34.4: Cloud Sync + Admin Panel
const SentencifyAI = () => {
  // v1.34.4: Rota /admin abre painel de administra√ß√£o
  if (window.location.pathname === '/admin') {
    return <AdminPanel />;
  }

  // v1.35.0: Rota /share/:token abre p√°gina de aceite de compartilhamento
  const shareMatch = window.location.pathname.match(/^\/share\/([a-f0-9]+)$/i);

  // v1.34.1: Estado para modelos recebidos do servidor (para merge)
  const [receivedModels, setReceivedModels] = React.useState(null);
  // v1.35.24: Lista de bibliotecas compartilhadas ativas (para filtrar modelos de owners revogados)
  const [activeSharedLibraries, setActiveSharedLibraries] = React.useState(null);

  // v1.35.1: Memoizar callbacks para evitar re-cria√ß√£o de pull/sync a cada render
  // v1.35.24: Receber sharedLibraries junto com models
  const handleModelsReceived = React.useCallback((models, sharedLibraries) => {
    setReceivedModels(models);
    setActiveSharedLibraries(sharedLibraries || []);
  }, []);
  const clearReceivedModels = React.useCallback(() => {
    setReceivedModels(null);
    setActiveSharedLibraries(null);
  }, []);

  const cloudSync = useCloudSync({
    onModelsReceived: handleModelsReceived
  });

  // Fallback para auth legada durante transi√ß√£o
  const legacyAuth = useAuth();

  // Mostrar loading enquanto verifica auth
  if (cloudSync.authLoading || legacyAuth.isLoading) {
    return (
      <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center gap-6">
        {/* Spinner Neon + Ripple - v1.33.50 */}
        <div className="spinner-neon-ripple">
          <div className="ripple"></div>
          <div className="ripple"></div>
          <div className="ripple"></div>
          <div className="core">
            <div className="outer"></div>
            <div className="inner"></div>
          </div>
        </div>
        <span className="text-slate-400 animate-pulse">Carregando...</span>
      </div>
    );
  }

  // v1.35.0: Se estiver em rota de compartilhamento
  if (shareMatch) {
    const shareToken = shareMatch[1];

    // Se n√£o autenticado, mostrar login primeiro (ap√≥s login volta para a mesma URL)
    if (!cloudSync.isAuthenticated) {
      return (
        <div className="min-h-screen bg-slate-900">
          <LoginMagicModal
            isOpen={true}
            onClose={() => {}}
            onRequestLink={cloudSync.requestMagicLink}
            onVerify={cloudSync.verifyToken}
            devLink={cloudSync.devLink}
          />
        </div>
      );
    }

    // Usu√°rio autenticado, mostrar p√°gina de aceite
    return <AcceptSharePage token={shareToken} />;
  }

  // v1.34.0: Mostrar modal de login Magic Link se n√£o autenticado
  if (!cloudSync.isAuthenticated) {
    return (
      <div className="min-h-screen bg-slate-900">
        <LoginMagicModal
          isOpen={true}
          onClose={() => {}} // Modal n√£o pode ser fechado sem autenticar
          onRequestLink={cloudSync.requestMagicLink}
          onVerify={cloudSync.verifyToken}
          devLink={cloudSync.devLink}
        />
      </div>
    );
  }

  // App normal com ErrorBoundary
  return (
    <ErrorBoundary>
      <LegalDecisionEditor
        onLogout={cloudSync.logout}
        cloudSync={cloudSync}
        receivedModels={receivedModels}
        activeSharedLibraries={activeSharedLibraries}
        clearReceivedModels={clearReceivedModels}
      />
    </ErrorBoundary>
  );
};

// v1.35.40: Wrapper com GoogleOAuthProvider para integra√ß√£o com Google Drive
const SentencifyAIWithGoogleDrive = () => (
  <GoogleOAuthProvider clientId={GOOGLE_CLIENT_ID}>
    <SentencifyAI />
  </GoogleOAuthProvider>
);

export default SentencifyAIWithGoogleDrive;
