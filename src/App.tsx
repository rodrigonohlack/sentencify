/**
 * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
 * â•‘                              SENTENCIFY AI - ÃNDICE DO CÃ“DIGO                          â•‘
 * â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
 * â•‘ SEÃ‡ÃƒO                                    â”‚ LINHAS          â”‚ DESCRIÃ‡ÃƒO                 â•‘
 * â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
 * â•‘ 1. IMPORTS & CONFIG                      â”‚ 1-390           â”‚ React, Lucide, constantes â•‘
 * â•‘    â””â”€ APP_VERSION                        â”‚ ~141            â”‚ VersÃ£o atual da app       â•‘
 * â•‘    â””â”€ CHANGELOG                          â”‚ src/constants/  â”‚ Movido para arquivo separ.â•‘
 * â•‘    â””â”€ CSS (classes utilitÃ¡rias)          â”‚ 285-330         â”‚ Tailwind helpers          â•‘
 * â•‘                                          â”‚                 â”‚                           â•‘
 * â•‘ 2. UTILITÃRIOS & SERVIÃ‡OS                â”‚ 428-970         â”‚ Embeddings, CDN           â•‘
 * â•‘    â””â”€ AIModelService                     â”‚ src/services/   â”‚ NER/E5 (EXTRAÃDO v1.36.60)â•‘
 * â•‘    â””â”€ EmbeddingsService                  â”‚ 438-580         â”‚ IndexedDB legislaÃ§Ã£o      â•‘
 * â•‘    â””â”€ JurisEmbeddingsService             â”‚ 580-720         â”‚ IndexedDB jurisprudÃªncia  â•‘
 * â•‘    â””â”€ EmbeddingsCDNService               â”‚ 720-830         â”‚ Download GitHub CDN       â•‘
 * â•‘                                          â”‚                 â”‚                           â•‘
 * â•‘ 3. HOOKS CUSTOMIZADOS                    â”‚ 1325-8170       â”‚ 21 hooks React            â•‘
 * â•‘    â””â”€ useModalManager                    â”‚ stores/useUI    â”‚ Zustand (v1.36.61)        â•‘
 * â•‘    â””â”€ useAIIntegration                   â”‚ stores/useAI    â”‚ Zustand (v1.36.62)        â•‘
 * â•‘    â””â”€ useIndexedDB                       â”‚ 2750-3165       â”‚ PersistÃªncia modelos      â•‘
 * â•‘    â””â”€ usePrimaryTabLock                  â”‚ 3165-3525       â”‚ SincronizaÃ§Ã£o abas        â•‘
 * â•‘    â””â”€ useFieldVersioning                 â”‚ 3625-3700       â”‚ HistÃ³rico de versÃµes      â•‘
 * â•‘    â””â”€ useLocalStorage                    â”‚ 3700-4680       â”‚ SessÃ£o (980 linhas)       â•‘
 * â•‘    â””â”€ useModelLibrary                    â”‚ stores/useMod   â”‚ Zustand (v1.36.63)        â•‘
 * â•‘    â””â”€ useProofManager                    â”‚ 5615-6000       â”‚ GestÃ£o de provas          â•‘
 * â•‘    â””â”€ useDocumentManager                 â”‚ 6000-6390       â”‚ Upload documentos         â•‘
 * â•‘    â””â”€ useTopicManager                    â”‚ 6390-6575       â”‚ CRUD tÃ³picos              â•‘
 * â•‘    â””â”€ useChatAssistant                   â”‚ 6575-6690       â”‚ Chat interativo           â•‘
 * â•‘    â””â”€ useJurisprudencia                  â”‚ 6690-6820       â”‚ Busca precedentes         â•‘
 * â•‘    â””â”€ useLegislacao                      â”‚ 6820-8170       â”‚ 7000+ artigos             â•‘
 * â•‘                                          â”‚                 â”‚                           â•‘
 * â•‘ 4. COMPONENTES DE UI                     â”‚ 8170-9835       â”‚ VirtualList, Modais base  â•‘
 * â•‘    â””â”€ VirtualList                        â”‚ 8178-8264       â”‚ Scroll virtualizado       â•‘
 * â•‘    â””â”€ JurisprudenciaModalContent         â”‚ 8930-9355       â”‚ Modal de jurisprudÃªncia   â•‘
 * â•‘    â””â”€ LegislacaoModalContent             â”‚ 9360-9640       â”‚ Modal de legislaÃ§Ã£o       â•‘
 * â•‘    â””â”€ BaseModal                          â”‚ 9838-9990       â”‚ Template de modal         â•‘
 * â•‘                                          â”‚                 â”‚                           â•‘
 * â•‘ 5. MODAIS ESPECÃFICOS                    â”‚ 9835-16450      â”‚ ~50 modais da aplicaÃ§Ã£o   â•‘
 * â•‘    â””â”€ RenameTopicModal                   â”‚ 9991            â”‚ Renomear tÃ³pico           â•‘
 * â•‘    â””â”€ DeleteTopicModal                   â”‚ 10021           â”‚ Excluir tÃ³pico            â•‘
 * â•‘    â””â”€ GlobalEditorModal                  â”‚ ~12555          â”‚ Editor em tela cheia      â•‘
 * â•‘    â””â”€ ConfigModal                        â”‚ ~14055          â”‚ ConfiguraÃ§Ãµes IA          â•‘
 * â•‘                                          â”‚                 â”‚                           â•‘
 * â•‘ 6. QUILL EDITOR                          â”‚ 16450-17530     â”‚ Rich text editor          â•‘
 * â•‘    â””â”€ QuillEditorBase                    â”‚ 16609-16881     â”‚ Editor base               â•‘
 * â•‘    â””â”€ QuillModelEditor                   â”‚ 16884-17009     â”‚ Editor de modelos         â•‘
 * â•‘    â””â”€ QuillDecisionEditor                â”‚ 17013-17349     â”‚ Editor de fundamentaÃ§Ã£o   â•‘
 * â•‘    â””â”€ QuillMiniRelatorioEditor           â”‚ 17448-17521     â”‚ Editor mini-relatÃ³rio     â•‘
 * â•‘                                          â”‚                 â”‚                           â•‘
 * â•‘ 7. AI_PROMPTS                            â”‚ src/prompts/    â”‚ Movido para arquivo separ.â•‘
 * â•‘    â””â”€ AI_INSTRUCTIONS                    â”‚ system.js       â”‚ System prompt para LLM    â•‘
 * â•‘    â””â”€ AI_PROMPTS (object)                â”‚ ai-prompts.js   â”‚ 20+ prompts estruturados  â•‘
 * â•‘                                          â”‚                 â”‚                           â•‘
 * â•‘ 8. LEGALDECISIONEDITOR                   â”‚ 18425-33700     â”‚ Componente principal      â•‘
 * â•‘    â””â”€ reorderTopicsViaLLM                â”‚ 22449           â”‚ OrdenaÃ§Ã£o IA (Art.337)    â•‘
 * â•‘    â””â”€ handleAnalyzeDocuments             â”‚ 25045           â”‚ AnÃ¡lise inicial           â•‘
 * â•‘    â””â”€ analyzeProof                       â”‚ 25828           â”‚ AnÃ¡lise de provas         â•‘
 * â•‘    â””â”€ generateDispositivo                â”‚ 26921           â”‚ Gerar dispositivo         â•‘
 * â•‘                                          â”‚                 â”‚                           â•‘
 * â•‘ 9. ERROR BOUNDARY & EXPORT               â”‚ 33700-33959     â”‚ Tratamento de erros       â•‘
 * â•‘    â””â”€ SentencifyAI (ErrorBoundary)       â”‚ 33700           â”‚ Wrapper com fallback      â•‘
 * â•‘    â””â”€ export default                     â”‚ 33959           â”‚ ExportaÃ§Ã£o do componente  â•‘
 * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * FLUXOS CRÃTICOS (para navegaÃ§Ã£o rÃ¡pida)
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * ğŸ“„ ANÃLISE INICIAL DE DOCUMENTOS:
 *    handleAnalyzeDocuments() â†’ extractTopics() â†’ reorderTopicsViaLLM() â†’ setTopics()
 *    Linha inicial: ~24735 | OrdenaÃ§Ã£o: ~22170
 *
 * âœï¸ GERAÃ‡ÃƒO DE SENTENÃ‡A (por tÃ³pico):
 *    generateReportForTopic() â†’ callAI() â†’ updateTopic()
 *    Linha inicial: ~22795
 *
 * ğŸ” BUSCA SEMÃ‚NTICA (IA Local):
 *    AIModelService.getEmbedding() â†’ cosineSimilarity() â†’ rankResults()
 *    Embeddings: linha ~460 | Busca: linha ~5320
 *
 * ğŸ“‹ ANÃLISE DE PROVAS:
 *    analyzeProof() â†’ extractText() â†’ anonimizar() â†’ callAI()
 *    Linha inicial: ~25500
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * HOOKS DISPONÃVEIS (ordem alfabÃ©tica)
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * useAIIntegration    - ComunicaÃ§Ã£o com Claude/Gemini APIs
 * useAPICache         - Cache de respostas da IA
 * useChatAssistant    - Chat interativo com contexto
 * useDocumentManager  - Upload e processamento de documentos
 * useFeatureFlags     - Feature toggles
 * useFieldVersioning  - HistÃ³rico de versÃµes dos campos
 * useFontSizeControl  - Controle de tamanho de fonte
 * useFullscreen       - Modo tela cheia
 * useIndexedDB        - PersistÃªncia de modelos no IndexedDB
 * useJurisprudencia   - Busca de precedentes (TST/STF)
 * useLegislacao       - Busca de legislaÃ§Ã£o (7000+ artigos)
 * useLocalStorage     - PersistÃªncia de sessÃ£o
 * useModelLibrary     - CRUD de modelos de texto
 * useModelPreview     - Preview de modelos no editor
 * useModalManager     - Controle de abertura/fechamento de modais
 * usePrimaryTabLock   - SincronizaÃ§Ã£o entre abas do navegador
 * useProofManager     - GestÃ£o de provas documentais
 * useSpacingControl   - Controle de espaÃ§amento
 * useThrottledBroadcast - Broadcast throttled entre abas
 * useTopicManager     - CRUD de tÃ³picos da sentenÃ§a
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¦ SEÃ‡ÃƒO 1: IMPORTS & CONFIGURAÃ‡ÃƒO
// React, Ã­cones Lucide, constantes globais
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import React, { useState, useEffect, useRef } from 'react';
import { CHANGELOG } from './constants/changelog';
import { EXPORT_STYLES } from './constants/export-styles';
import { Upload, FileText, Plus, Search, Save, Trash2, ChevronDown, ChevronUp, Download, AlertCircle, AlertTriangle, Edit2, Edit3, Merge, Split, PlusCircle, Sparkles, Edit, GripVertical, BookOpen, Book, Zap, Scale, Loader2, Check, X, Clock, RefreshCw, Info, Code, Copy, ArrowRight, Eye, Wand2, LogOut, Share2, Link, Users, Mail, RotateCcw } from 'lucide-react';
import LoginScreen, { useAuth } from './components/LoginScreen';

// v1.34.0: Cloud Sync - Magic Link Authentication + SQLite Sync
import useCloudSync, { type UseCloudSyncReturn, type SharedLibrary } from './hooks/useCloudSync';
import LoginMagicModal from './components/LoginMagicModal';
import SyncStatusIndicator from './components/SyncStatusIndicator';

// v1.36.61+: Zustand Stores - Estado global gerenciado
import { useModalManagerCompat } from './stores/useUIStore';
import { useAISettingsCompat } from './stores/useAIStore';
import { useModelLibraryCompat } from './stores/useModelsStore';
import { useTopicManagerCompat } from './stores/useTopicsStore';
import { useProofManagerCompat } from './stores/useProofsStore';

// v1.36.66: Hooks TIER 0 extraÃ­dos para arquivos separados
// v1.36.69: useIndexedDB (TIER 1), validateModel, sanitizeModel extraÃ­dos
import { useFullscreen, useSpacingControl, useFontSizeControl, useFeatureFlags, useThrottledBroadcast, useAPICache, usePrimaryTabLock, useFieldVersioning, useIndexedDB, validateModel, sanitizeModel } from './hooks';
import { SPACING_PRESETS, FONTSIZE_PRESETS } from './constants/presets';

// v1.34.4: Admin Panel - Gerenciamento de emails autorizados
import AdminPanel from './components/AdminPanel';

// v1.35.30: Modal de curadoria de tÃ³picos prÃ©-geraÃ§Ã£o
import TopicCurationModal from './components/TopicCurationModal';

// v1.35.40: Google Drive - Salvar/Carregar projetos na nuvem
import { GoogleOAuthProvider } from '@react-oauth/google';
import { useGoogleDrive, GOOGLE_CLIENT_ID } from './hooks/useGoogleDrive';
import { GoogleDriveButton, DriveFilesModal } from './components/GoogleDriveButton';
import { VoiceButton } from './components/VoiceButton';
import { ModelGeneratorModal } from './components/ModelGeneratorModal';
import { FactsComparisonModalContent } from './components/FactsComparisonModal';
import useFactsComparisonCache, { openFactsDB, FACTS_STORE_NAME } from './hooks/useFactsComparisonCache';
import useSentenceReviewCache, { openReviewDB, REVIEW_STORE_NAME } from './hooks/useSentenceReviewCache';

// v1.35.26: Prompts de IA movidos para src/prompts/
import { AI_INSTRUCTIONS, AI_INSTRUCTIONS_CORE, AI_INSTRUCTIONS_STYLE, AI_INSTRUCTIONS_SAFETY, AI_PROMPTS } from './prompts';
import { buildMiniRelatorioComparisonPrompt, buildDocumentosComparisonPrompt, buildPdfComparisonPrompt } from './prompts/facts-comparison-prompts';

// v1.36.60: AIModelService extraÃ­do para src/services/
import AIModelService from './services/AIModelService';

// v1.35.79: Tipos TypeScript centralizados (ETAPA 0 reorganizaÃ§Ã£o completa)
import type {
  // Core Types
  ModalKey, ModalState, TextPreviewState, AISettings, TokenMetrics,
  Topic, TopicCategory, TopicResultado, TopicoComplementar, Model, NewModelData, Proof, ProofFile, ProofText, ProofAnalysisResult,
  ProcessingMode, InsertMode, FieldVersion, DriveFile, GeminiThinkingLevel,
  ProgressState, ToastState, SlashMenuState, ModelGeneratorModalState,
  FiltrosJuris, FiltrosLegislacao, PastedText, ChatMessage, Precedente, Artigo,
  JurisSuggestion, ShareInfo, DownloadStatus, EmbeddingsDownloadStatus, DataDownloadStatus,
  DocumentAnalysis, PartesProcesso, QuillInstance, QuillDelta, NewProofTextData, CacheEntry, CacheStats,
  TargetField,
  // FASE 8.2: Tipos adicionais para useState com objetos
  LocalModelForm, SlashMenuStateExtended, DownloadItemStatus,
  EmbeddingsDownloadStatusExtended, DataDownloadStatusExtended, ActiveFormatsState,
  // FASE 8.7: Tipos para AIModelService e serviÃ§os
  AIModelType, AIModelStatus, AIModelServiceStatus, AIModelServiceProgress,
  NERRawEntity, NERProcessedEntity, AIModelStatusCallback, AIWorkerMessage, PendingWorkerPromise,
  LegislacaoEmbeddingItem, JurisEmbeddingItem, JurisEmbeddingWithSimilarity, SimilaritySearchResult, JurisFiltros,
  CDNDownloadType, DownloadProgressCallback, BatchCompleteCallback, CDNFileName, EstimatedSizes,
  BulkFile, BulkGeneratedModel, BulkError,
  AIGenContextItem, AIGenContext, AIGenState, AIGenAction, AnonymizationSettings,
  QuickPrompt, AIMessage, AIMessageContent, AITextContent, AIDocumentContent, AICallOptions, AIProvider, GeminiRequest, GeminiGenerationConfig,
  OpenAIMessage, OpenAIMessagePart, OpenAIReasoningConfig, OpenAIReasoningLevel,
  FactsComparisonSource, FactsComparisonResult,  // v1.36.12
  DoubleCheckSettings, DoubleCheckOperations, DoubleCheckResult, DoubleCheckCorrection,  // v1.36.50
  // MODAL PROPS (movido de App.tsx v1.35.79)
  ModelFormModalProps, ModelPreviewModalProps, RenameTopicModalProps, DeleteTopicModalProps, MergeTopicsModalProps, SplitTopicModalProps,
  NewTopicModalProps, DeleteModelModalProps, DeleteAllModelsModalProps, DeleteAllPrecedentesModalProps,
  ExportModalProps, JurisprudenciaModalProps, SimilarityWarningState, SimilarityWarningModalProps, ShareLibraryModalProps, AnalysisModalProps, DispositivoModalProps, BulkReviewModalProps, BulkUploadModalProps, SlashCommandMenuProps, LinkedProofsModalProps,
  LogoutConfirmModalProps, RestoreSessionModalProps, ClearProjectModalProps,
  AddProofTextModalProps, ProofAnalysisModalProps, DeleteProofModalProps,
  ConfirmBulkCancelModalProps, BulkDiscardConfirmModalProps, TextPreviewModalProps,
  ExtractModelConfirmModalProps, ExtractedModelPreviewModalProps, LinkProofModalProps,
  // COMPONENT PROPS (movido de App.tsx v1.35.79)
  FieldEditorProps, FieldEditorRef, GlobalEditorSectionProps,
  QuillEditorBaseProps, QuillModelEditorProps, QuillDecisionEditorProps, QuillMiniRelatorioEditorProps,
  DecisionEditorContainerProps, GlobalEditorModalProps, TopicCardProps, SortableTopicCardProps, ModelCardProps, ProofCardProps,
  SuggestionCardProps, ArtigoCardProps, JurisprudenciaCardProps, ChatBubbleProps,
  // UI/PANEL PROPS (movido de App.tsx v1.35.79)
  VirtualListProps, ProcessingModeSelectorProps, InsertDropdownProps,
  SpacingDropdownProps, FontSizeDropdownProps, ChatInputProps, ChatHistoryAreaProps,
  LockedTabOverlayProps, LegislacaoTabProps, JurisprudenciaTabProps,
  FullscreenModelPanelProps, ModelSearchPanelProps, AcceptSharePageProps,
  // AI ASSISTANT PROPS (movido de App.tsx v1.35.79)
  AIAssistantBaseLegacyProps, AIAssistantBaseProps, AIAssistantModalProps,
  AIAssistantGlobalModalProps, AIAssistantModelModalProps,
  // FUNCTION TYPES
  CallAIFunction,
  // SESSION/PROJECT TYPES (movido de App.tsx v1.35.79)
  AnalyzedDocuments, ExtractedTexts, DocumentProcessingModes, UploadedFile,
  SessionState, ProjectState, UploadPdfData, UploadPdfs, ImportedProject, ImportCallbacks, RestoreSessionCallbacks, ImportProjectCallbacks, ClearProjectCallbacks,
  // BASE COMPONENT PROPS (movido de App.tsx v1.35.91)
  BaseModalProps, AnonymizationNamesModalProps, ErrorBoundaryProps, ErrorBoundaryState,
  // LIBRARY TYPES
  PdfjsLib, PdfDocument, PdfPage, MammothLib, TesseractLib, TesseractWorker, TesseractScheduler
} from './types';

// v1.33.58: dnd-kit para drag and drop com suporte a wheel scroll
import { DndContext, closestCenter, PointerSensor, useSensor, useSensors } from '@dnd-kit/core';
import { SortableContext, verticalListSortingStrategy, useSortable, arrayMove } from '@dnd-kit/sortable';
import { CSS as DndCSS } from '@dnd-kit/utilities';

// ğŸ”§ VERSÃƒO DA APLICAÃ‡ÃƒO
const APP_VERSION = '1.36.70'; // v1.36.70: Testes REAIS para 9 hooks extraÃ­dos + regra #10 CLAUDE.md (testes devem importar cÃ³digo de produÃ§Ã£o)

// v1.33.31: URL base da API (detecta host automaticamente: Render, Vercel, ou localhost)
const getApiBase = () => {
  // Desenvolvimento local
  if (!import.meta.env.PROD) {
    return 'http://localhost:3001';
  }
  // ProduÃ§Ã£o: usar mesmo domÃ­nio (funciona tanto no Render quanto no Vercel)
  return '';
};
const API_BASE = getApiBase();

// v1.35.25: CHANGELOG movido para src/constants/changelog.js

const AUTO_SAVE_DEBOUNCE_MS = 5000;

// v1.19.0: Limite de mensagens no chat do assistente IA
const MAX_CHAT_HISTORY_MESSAGES = 20;

// v1.19.3: InstruÃ§Ã£o reformulada - CONSULTAR DOCUMENTOS antes de perguntar
const INSTRUCAO_NAO_PRESUMIR = `ğŸš¨ REGRA CRÃTICA - CONSULTAR DOCUMENTOS ANTES DE PERGUNTAR:

ğŸ“š VOCÃŠ TEM ACESSO AOS DOCUMENTOS DO PROCESSO (petiÃ§Ã£o inicial, contestaÃ§Ã£o, provas).
SEMPRE consulte os documentos anexados no contexto ANTES de fazer qualquer pergunta.

âœ… SE A INFORMAÃ‡ÃƒO ESTIVER NOS DOCUMENTOS ANEXADOS:
- Use-a diretamente para fundamentar a decisÃ£o
- NÃƒO pergunte ao usuÃ¡rio o que jÃ¡ estÃ¡ documentado
- Cite a fonte: "Conforme narrado na petiÃ§Ã£o inicial..." ou "A contestaÃ§Ã£o alega que..."

â“ PERGUNTE AO USUÃRIO (REGRA IMPORTANTE):
Sempre que uma informaÃ§Ã£o necessÃ¡ria Ã  redaÃ§Ã£o NÃƒO estiver EXPRESSAMENTE indicada no contexto, vocÃª DEVE perguntar ao usuÃ¡rio antes de redigir. NÃ£o presuma, nÃ£o infira, nÃ£o deduza.

PERGUNTE QUANDO:
- A informaÃ§Ã£o NÃƒO estiver nos documentos anexados
- Precisar da CONCLUSÃƒO ou INTERPRETAÃ‡ÃƒO do juiz sobre uma prova
- O resultado de um pedido nÃ£o estiver definido (procedente/improcedente)
- Houver ambiguidade que sÃ³ o magistrado pode resolver
- O documento mencionar prova que nÃ£o foi anexada (ex: "conforme perÃ­cia...")
- Faltar dado essencial: valor, perÃ­odo, percentual, conclusÃ£o sobre prova

PREFERIR PERGUNTAR a presumir. Na dÃºvida, pergunte.

âŒ VOCÃŠ NÃƒO PODE, EM HIPÃ“TESE ALGUMA:
1. INVENTAR fatos que NÃƒO estÃ£o nos documentos (testemunhas, valores, datas, percentuais)
2. PRESUMIR controvÃ©rsia/incontroversia sem verificar a contestaÃ§Ã£o anexada
3. CONCLUIR o que uma prova "demonstra" sem anÃ¡lise expressa do juiz
4. AFIRMAR autoria de documentos sem essa informaÃ§Ã£o estar no contexto

âœ… VOCÃŠ PODE REDIGIR SEM PERGUNTAR:
- Fatos expressamente narrados nos documentos anexados
- Teses da petiÃ§Ã£o inicial e argumentos da contestaÃ§Ã£o (quando anexadas)
- FundamentaÃ§Ã£o jurÃ­dica (lei, sÃºmulas, OJs, jurisprudÃªncia)
- ConclusÃµes de premissas JÃ FORNECIDAS pelo juiz
- Estrutura e formataÃ§Ã£o da decisÃ£o`;

// v1.25.18: Helper para extrair texto sem criar DOM (memory leak fix)
const extractPlainText = (html: string): string => {
  if (!html) return '';
  return html
    .replace(/<br\s*\/?>/gi, '\n')
    .replace(/<\/p>\s*<p[^>]*>/gi, '\n')
    .replace(/<[^>]*>/g, ' ')
    .replace(/&nbsp;/g, ' ')
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/\s+/g, ' ')
    .replace(/\n\s+/g, '\n')
    .trim();
};

// ğŸ¨ CSS CLASSES CENTRALIZADAS (v1.12.5 - Classes utilitÃ¡rias consolidadas)
// v1.33.43: Fix tema claro - usa variÃ¡veis CSS de tema
const CSS = {
  // Modal system - v1.33.43: usa variÃ¡veis de tema para suportar tema claro/escuro
  modalOverlay: "fixed inset-0 theme-modal-overlay backdrop-blur-sm flex items-center justify-center z-[90] p-4",
  modalContainer: "theme-modal-container backdrop-blur-md rounded-2xl shadow-2xl theme-border-modal border theme-modal-glow max-h-[90vh] flex flex-col",
  modalHeader: "p-5 border-b theme-border-modal",
  modalFooter: "flex gap-3 p-4 border-t theme-border-modal",
  // Input
  inputField: "w-full px-4 py-3 theme-input border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all",
  inputBase: "w-full theme-bg-secondary border theme-border-input rounded-lg theme-text-primary theme-placeholder focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all",
  input: "w-full px-4 py-3 theme-bg-secondary border theme-border-input rounded-lg theme-text-primary theme-placeholder focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all",
  // Info boxes
  infoBox: "theme-info-box",
  spinner: "w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin",
  // Text
  label: "block text-sm font-medium theme-text-tertiary mb-2",
  textMuted: "text-xs theme-text-muted",
  // Flex
  flexCenter: "flex items-center",
  flexGap1: "flex items-center gap-1",
  flexGap2: "flex items-center gap-2",
  flexGap3: "flex items-center gap-3",
  flexBetween: "flex items-center justify-between",
  flexCenterJustify: "flex items-center justify-center gap-2",
  // Buttons - v1.33.43: cores que funcionam em ambos os temas
  btnBase: "rounded-xl font-medium transition-all",
  btnPrimary: "px-4 py-2.5 rounded-xl font-medium text-white bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 shadow-lg shadow-purple-500/25",
  btnSecondary: "px-4 py-2.5 rounded-xl font-medium theme-bg-secondary theme-hover-bg border theme-border-modal theme-text-primary transition-all",
  btnDanger: "px-4 py-2.5 rounded-xl font-medium bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white shadow-lg shadow-red-500/25",
  btnSuccess: "px-4 py-2.5 rounded-xl font-medium bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white shadow-lg shadow-green-500/25",
  btnBlue: "px-4 py-2.5 rounded-xl font-medium bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white shadow-lg shadow-blue-500/25",
  btnRed: "px-4 py-2.5 rounded-xl font-medium bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white shadow-lg shadow-red-500/25",
  btnGreen: "px-4 py-2.5 rounded-xl font-medium bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white shadow-lg shadow-green-500/25",
  btnSmall: "px-2 py-1 rounded text-xs",
  // Cards
  cardBase: "rounded-lg border theme-border-input theme-bg-secondary",
  // Common
  hoverSlate: "theme-bg-tertiary hover-slate-500",
  roundedLg: "rounded-lg",
  textXs: "text-xs",
  textSm: "text-sm",
};

// ğŸ¨ ESTILOS DE RESULTADO (cores por tipo de decisÃ£o)
const RESULTADO_STYLES = {
  PROCEDENTE: { borderColor: '#10b981', color: 'var(--result-green)' },
  IMPROCEDENTE: { borderColor: '#ef4444', color: 'var(--result-red)' },
  'PARCIALMENTE PROCEDENTE': { borderColor: '#f59e0b', color: 'var(--result-amber)' },
  ACOLHIDO: { borderColor: '#10b981', color: 'var(--result-green)' },
  REJEITADO: { borderColor: '#ef4444', color: 'var(--result-red)' },
  'SEM RESULTADO': { borderColor: '#64748b', color: 'var(--result-muted)' },
  default: { borderColor: '#64748b', color: 'var(--result-muted)' }
};
const getResultadoStyle = (r: string | null | undefined) => RESULTADO_STYLES[r as keyof typeof RESULTADO_STYLES] || RESULTADO_STYLES.default;

// v1.32.00: LocalAIProcessingOverlay removido - IA agora roda em Web Worker (nÃ£o bloqueia UI)

// ğŸ” TF-IDF SIMILARITY ENGINE (v1.13.1 - DetecÃ§Ã£o de modelos similares)
const TFIDFSimilarity = {
  STOPWORDS: new Set(['de','da','do','das','dos','em','na','no','nas','nos','para','por','com','sem','sob','sobre','entre','ate','o','a','os','as','um','uma','uns','umas','e','ou','mas','porem','contudo','todavia','que','qual','quais','quando','onde','como','porque','ser','estar','ter','haver','fazer','ir','vir','foi','era','sido','sendo','seja','foram','sao','ao','aos','pela','pelo','pelas','pelos','este','esta','estes','estas','esse','essa','esses','essas','isso','isto','aquilo','aquele','aquela','se','nao','sim','mais','menos','muito','pouco','art','artigo','paragrafo','inciso','alinea','fls','folhas','pag','pagina','id','processo','autos','requerente','requerido','reclamante','reclamada','autor','reu','parte','partes','assim','ainda','ja','tambem','apenas','mesmo','so','entao','pois']),
  cache: { vectors: new Map<string, Map<number, number>>(), vocab: new Map<string, number>(), idf: new Map<string, number>(), valid: false },
  tokenize(t: string): string[] {
    return (t||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/<[^>]+>/g,' ').replace(/[^\w\s]/g,' ').replace(/\d+/g,' ').split(/\s+/).filter((w: string)=>w.length>2&&!this.STOPWORDS.has(w));
  },
  buildIndex(models: Model[]) {
    const df=new Map<string, number>(), N=models.length;
    models.forEach((m: Model)=>{const terms=new Set(this.tokenize(m.content));terms.forEach((t: string)=>df.set(t,(df.get(t)||0)+1));});
    this.cache.vocab.clear();this.cache.idf.clear();let i=0;
    df.forEach((f: number,t: string)=>{if(f>=2&&f<N*0.9){this.cache.vocab.set(t,i++);this.cache.idf.set(t,Math.log(N/f)+1);}});
    this.cache.vectors.clear();
    models.forEach((m: Model)=>this.cache.vectors.set(m.id,this.computeVector(m.content)));
    this.cache.valid=true;
  },
  computeVector(text: string): Map<number, number> {
    const tokens=this.tokenize(text),tf=new Map<string, number>();
    tokens.forEach((t: string)=>{if(this.cache.vocab.has(t))tf.set(t,(tf.get(t)||0)+1);});
    const vec=new Map<number, number>();let norm=0;
    tf.forEach((f: number,t: string)=>{const idf=this.cache.idf.get(t);const idx=this.cache.vocab.get(t);if(idf===undefined||idx===undefined)return;const v=(1+Math.log(f))*idf;vec.set(idx,v);norm+=v*v;});
    norm=Math.sqrt(norm);if(norm>0)vec.forEach((v: number,k: number)=>vec.set(k,v/norm));
    return vec;
  },
  cosine(a: Map<number, number>,b: Map<number, number>){let dot=0;a.forEach((v: number,k: number)=>{if(typeof k==='number'&&b.has(k))dot+=v*(b.get(k) || 0);});return dot;},
  findSimilar(newModel: Model,models: Model[],threshold=0.80): { hasSimilar: true; similarModel: Model; similarity: number } | { hasSimilar: false; similarModel?: undefined; similarity?: undefined } {
    if(!this.cache.valid||this.cache.vectors.size!==models.length)this.buildIndex(models);
    const vec=this.computeVector(newModel.content);
    let best: Model | null=null,bestSim=0;
    models.forEach((m: Model)=>{if(m.id===newModel.id)return;const ev=this.cache.vectors.get(m.id);if(!ev)return;const s=this.cosine(vec,ev);if(s>=threshold&&s>bestSim){bestSim=s;best=m;}});
    return best?{hasSimilar:true as const,similarModel:best,similarity:bestSim}:{hasSimilar:false as const};
  },
  invalidate(){this.cache.valid=false;this.cache.vectors.clear();}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ› ï¸ SEÃ‡ÃƒO 2: UTILITÃRIOS & SERVIÃ‡OS
// AIModelService (extraÃ­do para src/services/AIModelService.ts)
// EmbeddingsService, JurisEmbeddingsService, EmbeddingsCDNService
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸ§  AI MODEL SERVICE - ExtraÃ­do para src/services/AIModelService.ts v1.36.60
// Importado como: import AIModelService from './services/AIModelService';

// ğŸ” EMBEDDINGS SERVICE - IndexedDB para busca semÃ¢ntica v1.26.00
const EmbeddingsService = {
  DB_NAME: 'sentencify-legislacao-embeddings',
  STORE_NAME: 'embeddings',
  VERSION: 1,

  openDB(): Promise<IDBDatabase> {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.DB_NAME, this.VERSION);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => resolve(req.result);
      req.onupgradeneeded = (e: IDBVersionChangeEvent) => {
        const db = (e.target as IDBOpenDBRequest).result;
        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
          const store = db.createObjectStore(this.STORE_NAME, { keyPath: 'id' });
          store.createIndex('artigoId', 'artigoId', { unique: false });
          store.createIndex('type', 'type', { unique: false });
          store.createIndex('lei', 'lei', { unique: false });
        }
      };
    });
  },

  async saveEmbedding(item: LegislacaoEmbeddingItem): Promise<void> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      tx.objectStore(this.STORE_NAME).put(item);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },

  async saveEmbeddingsBatch(items: LegislacaoEmbeddingItem[]): Promise<void> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      const store = tx.objectStore(this.STORE_NAME);
      items.forEach((item: LegislacaoEmbeddingItem) => store.put(item));
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },

  async getAllEmbeddings(): Promise<LegislacaoEmbeddingItem[]> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  },

  async getEmbeddingsByLei(lei: string): Promise<LegislacaoEmbeddingItem[]> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const index = tx.objectStore(this.STORE_NAME).index('lei');
      const req = index.getAll(lei);
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  },

  async getCount(): Promise<number> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).count();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  },

  // v1.26.02: Obter apenas os IDs dos embeddings (para verificaÃ§Ã£o incremental)
  async getAllIds(): Promise<IDBValidKey[]> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).getAllKeys();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  },

  async clearAll(): Promise<void> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      tx.objectStore(this.STORE_NAME).clear();
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },

  async clearByLei(lei: string): Promise<void> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      const store = tx.objectStore(this.STORE_NAME);
      const index = store.index('lei');
      const req = index.openCursor(lei);
      req.onsuccess = (e: Event) => {
        const cursor = (e.target as IDBRequest<IDBCursorWithValue | null>).result;
        if (cursor) {
          store.delete(cursor.primaryKey);
          cursor.continue();
        }
      };
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },

  // Buscar por similaridade (retorna top N resultados, deduplicado por artigoId)
  async searchBySimilarity(queryEmbedding: number[], threshold = 0.5, limit = 20): Promise<(LegislacaoEmbeddingItem & { similarity: number })[]> {
    const allEmbeddings = await this.getAllEmbeddings();
    const results = allEmbeddings
      .map((item: LegislacaoEmbeddingItem) => ({
        ...item,
        similarity: AIModelService.cosineSimilarity(queryEmbedding, item.embedding)
      }))
      .filter((item: LegislacaoEmbeddingItem & { similarity: number }) => item.similarity >= threshold);

    // Deduplicar por artigoId (manter chunk com maior similaridade)
    const deduped = Object.values(
      results.reduce((acc: Record<string, LegislacaoEmbeddingItem & { similarity: number }>, item: LegislacaoEmbeddingItem & { similarity: number }) => {
        const key = item.artigoId || item.id;
        if (!acc[key] || item.similarity > acc[key].similarity) {
          acc[key] = item;
        }
        return acc;
      }, {} as Record<string, LegislacaoEmbeddingItem & { similarity: number }>)
    );

    return (deduped as (LegislacaoEmbeddingItem & { similarity: number })[])
      .sort((a: LegislacaoEmbeddingItem & { similarity: number }, b: LegislacaoEmbeddingItem & { similarity: number }) => b.similarity - a.similarity)
      .slice(0, limit);
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“š JURIS EMBEDDINGS SERVICE - IndexedDB para busca semÃ¢ntica de jurisprudÃªncia
// v1.27.00: Suporte a chunking para textos longos (IRR, IAC)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const JURIS_CHUNK_THRESHOLD = 1500;
const JURIS_CHUNK_SIZE = 1200;
const JURIS_CHUNK_OVERLAP = 200;

interface JurisChunk {
  text: string;
  chunkIndex: number;
  totalChunks: number;
}

const chunkJurisText = (text: string): JurisChunk[] => {
  if (!text || text.length < JURIS_CHUNK_THRESHOLD) {
    return [{ text, chunkIndex: 0, totalChunks: 1 }];
  }
  const teseRegex = /(?:^|\n)\s*(?:\d+[ÂªÂºÂ°]?\)|\d+\s*[\.\)]\s)/;
  const parts = text.split(teseRegex).filter((t: string) => t && t.trim().length > 50);
  if (parts.length > 1) {
    return parts.map((t: string, i: number) => ({ text: t.trim(), chunkIndex: i, totalChunks: parts.length }));
  }
  const chunks: JurisChunk[] = [];
  let start = 0;
  while (start < text.length) {
    const end = Math.min(start + JURIS_CHUNK_SIZE, text.length);
    chunks.push({ text: text.slice(start, end), chunkIndex: chunks.length, totalChunks: 0 });
    start = end - JURIS_CHUNK_OVERLAP;
    if (start >= text.length - 50) break;
  }
  chunks.forEach((c: JurisChunk) => c.totalChunks = chunks.length);
  return chunks;
};

const JurisEmbeddingsService = {
  DB_NAME: 'sentencify-juris-embeddings',
  STORE_NAME: 'embeddings',
  VERSION: 1,

  openDB(): Promise<IDBDatabase> {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.DB_NAME, this.VERSION) as IDBOpenDBRequest;
      req.onerror = () => reject(req.error);
      req.onsuccess = () => resolve(req.result);
      req.onupgradeneeded = (e: IDBVersionChangeEvent) => {
        const db = (e.target as IDBOpenDBRequest).result;
        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
          const store = db.createObjectStore(this.STORE_NAME, { keyPath: 'id' });
          store.createIndex('precedenteId', 'precedenteId', { unique: false });
          store.createIndex('tribunal', 'tribunal', { unique: false });
          store.createIndex('tipoProcesso', 'tipoProcesso', { unique: false });
        }
      };
    });
  },

  async saveEmbedding(item: JurisEmbeddingItem): Promise<void> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      tx.objectStore(this.STORE_NAME).put(item);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },

  async saveEmbeddingsBatch(items: JurisEmbeddingItem[]): Promise<void> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      const store = tx.objectStore(this.STORE_NAME);
      items.forEach(item => store.put(item));
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },

  async getAllEmbeddings(): Promise<JurisEmbeddingItem[]> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).getAll() as IDBRequest<JurisEmbeddingItem[]>;
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  },

  async getCount(): Promise<number> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).count();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  },

  async getAllIds(): Promise<IDBValidKey[]> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readonly');
      const req = tx.objectStore(this.STORE_NAME).getAllKeys();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  },

  async clearAll(): Promise<void> {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      tx.objectStore(this.STORE_NAME).clear();
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },

  // v1.32.21: Aceita filtros para aplicar ANTES do limit
  async searchBySimilarity(
    queryEmbedding: number[],
    threshold = 0.5,
    limit = 30,
    filters: JurisFiltros = {}
  ): Promise<JurisEmbeddingWithSimilarity[]> {
    const allEmbeddings = await this.getAllEmbeddings();
    let results: JurisEmbeddingWithSimilarity[] = allEmbeddings
      .map(item => ({
        ...item,
        similarity: AIModelService.cosineSimilarity(queryEmbedding, item.embedding)
      }) as JurisEmbeddingWithSimilarity)
      .filter(item => item.similarity >= threshold);

    // v1.32.21: Aplicar filtros ANTES de limitar (para ter atÃ© 30 do tipo desejado)
    if (filters.tipo && filters.tipo.length > 0) {
      const IRR_TYPES = new Set(['IRR', 'RR', 'RRAG', 'INCJULGRREMBREP', 'INCJULGRREPETITIVO']);
      results = results.filter(r => {
        if (filters.tipo!.includes('IRR') && IRR_TYPES.has((r.tipoProcesso || '').toUpperCase().replace(/-/g, ''))) return true;
        return filters.tipo!.includes(r.tipoProcesso || '');
      });
    }
    if (filters.tribunal && filters.tribunal.length > 0) {
      results = results.filter(r => filters.tribunal!.includes(r.tribunal || ''));
    }

    const deduped = Object.values(
      results.reduce((acc: Record<string, JurisEmbeddingWithSimilarity>, item) => {
        const key = item.precedenteId || item.id;
        if (!acc[key] || item.similarity > acc[key].similarity) {
          acc[key] = item;
        }
        return acc;
      }, {})
    );
    return deduped
      .sort((a, b) => b.similarity - a.similarity)
      .slice(0, limit);
  }
};

// ğŸŒ CDN SERVICE para download automÃ¡tico de embeddings (v1.33.0)
const EmbeddingsCDNService = {
  VERSION: '1.0.0',

  // v1.35.20: Tamanhos estimados para fallback quando Content-Length nÃ£o disponÃ­vel
  ESTIMATED_SIZES: {
    'legis-embeddings.json': 211_000_000,  // ~211MB
    'juris-embeddings.json': 50_000_000,   // ~50MB
    'legis-data.json': 5_000_000,          // ~5MB
    'juris-data.json': 2_000_000,          // ~2MB
  } as EstimatedSizes,

  // Retorna URL do proxy (funciona local e Vercel, resolve CORS)
  getProxyUrl(file: CDNFileName): string {
    return `${API_BASE}/api/embeddings?file=${file}`;
  },

  // Verifica se precisa baixar embeddings
  async needsDownload(type: CDNDownloadType): Promise<boolean> {
    try {
      const count = type === 'legislacao'
        ? await EmbeddingsService.getCount()
        : await JurisEmbeddingsService.getCount();
      return count === 0;
    } catch {
      return true;
    }
  },

  // Download com progresso e retry
  // v1.35.20: Usa tamanhos estimados como fallback quando Content-Length nÃ£o disponÃ­vel
  async downloadFile(
    url: string,
    onProgress?: DownloadProgressCallback,
    maxRetries = 3
  ): Promise<string> {
    // Extrair nome do arquivo da URL (ex: ?file=legis-embeddings.json)
    const fileMatch = url.match(/[?&]file=([^&]+)/);
    const filename = fileMatch ? fileMatch[1] as CDNFileName : null;

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const contentLength = res.headers.get('Content-Length');
        let total = contentLength ? parseInt(contentLength, 10) : 0;

        // v1.35.20: Fallback para tamanho estimado quando Content-Length nÃ£o disponÃ­vel
        if (!total && filename && this.ESTIMATED_SIZES[filename]) {
          total = this.ESTIMATED_SIZES[filename];
          console.log(`[CDN] Usando tamanho estimado para ${filename}: ${(total / 1_000_000).toFixed(1)}MB`);
        }

        const reader = res.body!.getReader();
        const chunks: Uint8Array[] = [];
        let received = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          chunks.push(value);
          received += value.length;
          // v1.35.20: Reportar progresso mesmo com tamanho estimado (cap em 99% atÃ© done)
          if (onProgress && total) {
            const progress = Math.min(received / total, 0.99);
            onProgress(progress);
          }
        }

        // v1.35.20: Garantir 100% ao finalizar
        if (onProgress) onProgress(1);

        const blob = new Blob(chunks as BlobPart[]);
        return blob.text();
      } catch (err) {
        if (attempt === maxRetries) throw err;
        // Exponential backoff: 1s, 2s, 4s
        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt - 1)));
      }
    }
    // TypeScript: unreachable, but needed for type safety
    throw new Error('Download failed after max retries');
  },

  // Baixa e salva embeddings de legislaÃ§Ã£o
  async downloadLegislacao(
    onProgress?: DownloadProgressCallback,
    onBatchComplete?: BatchCompleteCallback
  ): Promise<number> {
    const url = this.getProxyUrl('legis-embeddings.json');
    const text = await this.downloadFile(url, onProgress);
    const items = JSON.parse(text) as LegislacaoEmbeddingItem[];

    // Salvar em batches de 100 para nÃ£o travar
    const batchSize = 100;
    for (let i = 0; i < items.length; i += batchSize) {
      const batch = items.slice(i, i + batchSize);
      await EmbeddingsService.saveEmbeddingsBatch(batch);
      onBatchComplete?.(Math.min(i + batchSize, items.length), items.length);
      // Yield para UI
      await new Promise(r => setTimeout(r, 0));
    }

    return items.length;
  },

  // Baixa e salva embeddings de jurisprudÃªncia
  async downloadJurisprudencia(
    onProgress?: DownloadProgressCallback,
    onBatchComplete?: BatchCompleteCallback
  ): Promise<number> {
    const url = this.getProxyUrl('juris-embeddings.json');
    const text = await this.downloadFile(url, onProgress);
    const items = JSON.parse(text) as JurisEmbeddingItem[];

    // Salvar em batches de 100
    const batchSize = 100;
    for (let i = 0; i < items.length; i += batchSize) {
      const batch = items.slice(i, i + batchSize);
      await JurisEmbeddingsService.saveEmbeddingsBatch(batch);
      onBatchComplete?.(Math.min(i + batchSize, items.length), items.length);
      await new Promise(r => setTimeout(r, 0));
    }

    return items.length;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // v1.33.61: AUTO-DOWNLOAD DE DADOS (legislaÃ§Ã£o e jurisprudÃªncia)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Verifica se precisa baixar dados (nÃ£o embeddings)
  async needsDataDownload(type: CDNDownloadType): Promise<boolean> {
    try {
      if (type === 'legislacao') {
        const artigos = await loadArtigosFromIndexedDB();
        return artigos.length === 0;
      } else {
        const precedentes = await loadPrecedentesFromIndexedDB();
        return precedentes.length === 0;
      }
    } catch {
      return true;
    }
  },

  // Baixa e salva dados de legislaÃ§Ã£o
  async downloadLegislacaoData(
    onProgress?: DownloadProgressCallback,
    onBatchComplete?: BatchCompleteCallback
  ): Promise<number> {
    const url = this.getProxyUrl('legis-data.json');
    const text = await this.downloadFile(url, onProgress);
    const json = JSON.parse(text);
    const items = (json.data || json) as Artigo[];

    // Salvar em batches de 500 (artigos sÃ£o menores que embeddings)
    const batchSize = 500;
    for (let i = 0; i < items.length; i += batchSize) {
      const batch = items.slice(i, i + batchSize);
      await saveArtigosToIndexedDB(batch);
      onBatchComplete?.(Math.min(i + batchSize, items.length), items.length);
      await new Promise(r => setTimeout(r, 0));
    }

    return items.length;
  },

  // Baixa e salva dados de jurisprudÃªncia
  async downloadJurisprudenciaData(
    onProgress?: DownloadProgressCallback,
    onBatchComplete?: BatchCompleteCallback
  ): Promise<number> {
    const url = this.getProxyUrl('juris-data.json');
    const text = await this.downloadFile(url, onProgress);
    const json = JSON.parse(text);
    const items = (json.data || json) as Precedente[];

    // Salvar em batches de 200
    const batchSize = 200;
    for (let i = 0; i < items.length; i += batchSize) {
      const batch = items.slice(i, i + batchSize);
      await savePrecedentesToIndexedDB(batch);
      onBatchComplete?.(Math.min(i + batchSize, items.length), items.length);
      await new Promise(r => setTimeout(r, 0));
    }

    return items.length;
  }
};

// ğŸ”’ ANONIMIZAÃ‡ÃƒO DE TEXTO (v1.17.0 - Nomes inseridos pelo usuÃ¡rio)
const anonymizeText = (text: string, config: AnonymizationSettings | null | undefined, nomesUsuario: string[] = []): string => {
  if (!text || !config?.enabled) return text;

  // Normalizar: juntar dÃ­gitos separados por quebras de linha (PDF.js Ã s vezes quebra nÃºmeros)
  let result = text.replace(/(\d)\s+(\d)/g, '$1$2');
  const encontrados: Record<string, string[]> = { cnpj: [], cpf: [], rg: [], pis: [], ctps: [], cep: [], processo: [], oab: [], telefone: [], email: [], conta: [], valor: [], pessoa: [] };

  // CNPJ: 00.000.000/0000-00
  if (config.cnpj !== false) {
    result = result.replace(/\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}/g, (m: string) => { encontrados.cnpj.push(m); return '[CNPJ]'; });
  }

  // CPF: 000.000.000-00 (apÃ³s CNPJ para evitar conflito)
  if (config.cpf !== false) {
    result = result.replace(/\d{3}\.?\d{3}\.?\d{3}-?\d{2}/g, (m: string) => { encontrados.cpf.push(m); return '[CPF]'; });
  }

  // RG: 00.000.000-0 ou similar
  if (config.rg !== false) {
    result = result.replace(/\d{1,2}\.?\d{3}\.?\d{3}-?[\dXx]/g, (m: string) => { encontrados.rg.push(m); return '[RG]'; });
  }

  // PIS/PASEP: 000.00000.00-0
  if (config.pis !== false) {
    result = result.replace(/\d{3}\.?\d{5}\.?\d{2}-?\d/g, (m: string) => { encontrados.pis.push(m); return '[PIS]'; });
  }

  // CTPS: 0000000/00000 ou similar
  if (config.ctps !== false) {
    result = result.replace(/\d{5,7}[/-]\d{3,5}/g, (m: string) => { encontrados.ctps.push(m); return '[CTPS]'; });
  }

  // CEP: 00.000-000 ou 00000-000
  if (config.cep !== false) {
    result = result.replace(/\d{2}\.?\d{3}-?\d{3}/g, (m: string) => { encontrados.cep.push(m); return '[CEP]'; });
  }

  // NÃºmero de processo CNJ: 0000000-00.0000.0.00.0000 (com espaÃ§os antes/depois de separadores)
  if (config.processo !== false) {
    result = result.replace(/\d{7}\s*-\s*\d{2}\s*\.\s*\d{4}\s*\.\s*\d\s*\.\s*\d{2}\s*\.\s*\d{4}/g, (m: string) => { encontrados.processo.push(m); return '[PROCESSO]'; });
  }

  // OAB: OAB/XX 0000
  if (config.oab !== false) {
    result = result.replace(/OAB\/?\s*[A-Z]{2}\s*\d+/gi, (m: string) => { encontrados.oab.push(m); return '[OAB]'; });
  }

  // Telefone: (00) 00000-0000 ou variaÃ§Ãµes
  if (config.telefone !== false) {
    result = result.replace(/\(?\d{2}\)?\s*\d{4,5}-?\d{4}/g, (m: string) => { encontrados.telefone.push(m); return '[TELEFONE]'; });
  }

  // E-mail
  if (config.email !== false) {
    result = result.replace(/[\w.-]+@[\w.-]+\.\w{2,}/gi, (m: string) => { encontrados.email.push(m); return '[EMAIL]'; });
  }

  // Conta bancÃ¡ria: Ag. 0000 C/C 00000-0 ou variaÃ§Ãµes
  if (config.contaBancaria !== false) {
    result = result.replace(/[Aa]g[Ãªe]?n?c?i?a?\.?\s*:?\s*\d[\d.-]*\s*[Cc]\.?\/?\s*[Cc]\.?\s*:?\s*\d[\d.-]*/g, (m: string) => { encontrados.conta.push(m); return '[CONTA]'; });
  }

  // Valores monetÃ¡rios R$
  if (config.valores === true) {
    result = result.replace(/R\$\s*[\d.,]+/g, (m: string) => { encontrados.valor.push(m); return '[VALOR]'; });
  }

  // Nomes inseridos pelo usuÃ¡rio (v1.17.0)
  if (nomesUsuario && nomesUsuario.length > 0) {
    // Helper: escapar caracteres especiais de regex
    const escapeRegex = (str: string): string => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    // Normalizar texto (remover acentos para comparaÃ§Ã£o)
    const normalize = (str: string): string => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

    // Criar regex flexÃ­vel para uma palavra
    const buildFlexRegex = (palavra: string): string => {
      let escaped = escapeRegex(palavra);
      // Permitir espaÃ§o opcional antes de caracteres acentuados (PDF.js bug)
      escaped = escaped.replace(/([ÃÃ€Ã‚ÃƒÃ‰ÃˆÃŠÃÃŒÃÃ“Ã’Ã”Ã•ÃšÃ™Ã›Ã‡])/gi, '\\s*$1');
      // Permitir espaÃ§o opcional apÃ³s pontos (W.P â†’ W. P)
      escaped = escaped.replace(/\\\./g, '\\.\\s*');
      return escaped;
    };

    nomesUsuario.forEach((nome, index) => {
      if (!nome || nome.trim().length < 2) return;
      // Remover anotaÃ§Ãµes entre parÃªnteses: "EMPRESA LTDA (1Âª reclamada)" â†’ "EMPRESA LTDA"
      let nomeClean = nome.trim().replace(/\s*\([^)]*\)\s*$/, '').trim();
      if (nomeClean.length < 2) return;
      // Limitar tamanho do nome para evitar ReDoS
      if (nomeClean.length > 200) nomeClean = nomeClean.substring(0, 200);

      const placeholder = `[PESSOA ${index + 1}]`;
      let matchCount = 0;

      // TENTATIVA 1: Busca normal (com espaÃ§os flexÃ­veis)
      // Limitar a 10 palavras para evitar regex muito complexa
      const palavras = nomeClean.split(/\s+/).slice(0, 10).map(buildFlexRegex);
      let regexStr = palavras.join('\\s+');
      regexStr = regexStr.replace(/\\s\+&\\s\+/g, '\\s*[&ï¼†]\\s*');
      const nomeRegex = new RegExp(regexStr, 'gi');

      matchCount = (result.match(nomeRegex) || []).length;
      if (matchCount > 0) {
        result = result.replace(nomeRegex, (match: string) => {
          encontrados.pessoa.push(match);
          return placeholder;
        });
      }

      // TENTATIVA 2: Busca normalizada (sem acentos) se nÃ£o encontrou
      if (matchCount === 0) {
        const nomeNorm = normalize(nomeClean);
        // Limitar a 10 palavras tambÃ©m na busca normalizada
        const palavrasNorm = nomeNorm.split(/\s+/).slice(0, 10).map(buildFlexRegex);
        let regexStrNorm = palavrasNorm.join('\\s+');
        regexStrNorm = regexStrNorm.replace(/\\s\+&\\s\+/g, '\\s*[&ï¼†]\\s*');
        const regexNorm = new RegExp(regexStrNorm, 'gi');
        const resultNorm = normalize(result);

        // Encontrar posiÃ§Ãµes no texto normalizado (limitar a 100 matches para evitar loops)
        const matches: Array<{ start: number; len: number; original: string }> = [];
        let match: RegExpExecArray | null;
        let matchLimit = 100;
        while ((match = regexNorm.exec(resultNorm)) !== null && matchLimit-- > 0) {
          matches.push({ start: match.index, len: match[0].length, original: result.substring(match.index, match.index + match[0].length) });
        }

        if (matches.length > 0) {
          // Substituir de trÃ¡s para frente (para manter Ã­ndices)
          for (let i = matches.length - 1; i >= 0; i--) {
            const m = matches[i];
            encontrados.pessoa.push(m.original);
            result = result.substring(0, m.start) + placeholder + result.substring(m.start + m.len);
          }
          matchCount = matches.length;
        }
      }
    });
  }

  return result;
};

// ğŸ”§ NORMALIZAÃ‡ÃƒO HTML (Remove espaÃ§amento extra entre tags)
const normalizeHTMLSpacing = (html: string | null | undefined): string => {
  if (!html) return html ?? '';
  return html
    .replace(/>\s*\n\s*\n+\s*</g, '><')
    .replace(/>\s*\n\s*</g, '><')
    .trim();
};

// ğŸ”§ v1.35.29: Remove meta-comentÃ¡rios de revisÃ£o que a IA pode adicionar ao final do texto
const removeMetaComments = (text: string | null | undefined): string => {
  if (!text) return text ?? '';

  // PadrÃµes de meta-comentÃ¡rios que a IA pode adicionar
  const patterns = [
    /\n*\**\s*Revis(Ã£o|ei)[^<]*$/i,
    /\n*\**\s*Identifica(Ã§Ã£o|do)[^<]*alucinaÃ§[^<]*$/i,
    /\n*\**\s*Confirmo que nÃ£o houve[^<]*$/i,
    /\n*\**\s*NÃ£o houve alucinaÃ§Ã£o[^<]*$/i,
    /\n*\**\s*REVISÃƒO[:\s][^<]*$/i,
    /\n*\*{3,}[^<]*$/,  // *** linha final
  ];

  let cleaned = text;
  let removed = false;
  for (const pattern of patterns) {
    if (pattern.test(cleaned)) {
      cleaned = cleaned.replace(pattern, '');
      removed = true;
    }
  }

  // Log quando fallback Ã© ativado (meta-comentÃ¡rio detectado e removido)
  if (removed) {
    console.warn('[Mini-RelatÃ³rio] Meta-comentÃ¡rio de revisÃ£o removido automaticamente');
  }

  return cleaned.trim();
};

// ğŸ”§ HELPERS: VerificaÃ§Ã£o de tÃ³picos especiais
const SPECIAL_TOPICS = ['RELATÃ“RIO', 'DISPOSITIVO'];
const isSpecialTopic = (topic: Topic | null | undefined): boolean => Boolean(topic && SPECIAL_TOPICS.includes(topic.title?.toUpperCase()));
const isRelatorio = (topic: Topic | null | undefined): boolean => topic?.title?.toUpperCase() === 'RELATÃ“RIO';
const isDispositivo = (topic: Topic | null | undefined): boolean => topic?.title?.toUpperCase() === 'DISPOSITIVO';

// ğŸ“¦ HOOKS CUSTOMIZADOS - Ver CLAUDE.md para documentaÃ§Ã£o completa
// ğŸ¤– v1.35.26: AI_INSTRUCTIONS movido para src/prompts/system.js

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ£ SEÃ‡ÃƒO 3: HOOKS CUSTOMIZADOS
// 21 hooks React para gerenciamento de estado, integraÃ§Ã£o com IA, persistÃªncia e UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸ£ CUSTOM HOOK: useModalManager
// v1.36.61: Migrado para Zustand - ver src/stores/useUIStore.ts
const useModalManager = useModalManagerCompat;

// ğŸ£ CUSTOM HOOK: useAIIntegration
// ğŸ”§ Reducer para estados de geraÃ§Ã£o de IA (consolidado)
const aiGenerationInitialState: AIGenState = {
  generic: { instruction: '', text: '', generating: false },
  model: { instruction: '', text: '', generating: false },
  relatorio: { instruction: '', regenerating: false },
  dispositivo: { instruction: '', text: '', generating: false, regenerating: false },
  keywords: { generating: false },
  title: { generating: false }
};

const aiGenerationReducer = (state: AIGenState, action: AIGenAction): AIGenState => {
  const ctx = action.context;
  const base = state[ctx] || aiGenerationInitialState[ctx] || {};
  switch (action.type) {
    case 'SET_INSTRUCTION':
      return { ...state, [ctx]: { ...base, instruction: action.value } };
    case 'SET_TEXT':
      return { ...state, [ctx]: { ...base, text: action.value } };
    case 'SET_GENERATING':
      return { ...state, [ctx]: { ...base, generating: action.value } };
    case 'SET_REGENERATING':
      return { ...state, [ctx]: { ...base, regenerating: action.value } };
    case 'RESET_CONTEXT':
      return { ...state, [ctx]: aiGenerationInitialState[ctx] };
    case 'RESET_ALL':
      return aiGenerationInitialState;
    default:
      return state;
  }
};

const useAIIntegration = () => {
  // v1.36.62: Estado migrado para Zustand - ver src/stores/useAIStore.ts
  const { aiSettings, setAiSettings, tokenMetrics, setTokenMetrics, addTokenUsage } = useAISettingsCompat();

  // ğŸ”§ Estado consolidado de geraÃ§Ã£o de IA (useReducer)
  const [aiGeneration, dispatchAI] = React.useReducer(aiGenerationReducer, aiGenerationInitialState);

  // v1.35.9: Todos os setters memoizados com useCallback para evitar re-renders
  // (createSetter retornava nova funÃ§Ã£o a cada render, causando lag em inputs)

  // GenÃ©rica
  const aiInstruction = aiGeneration.generic.instruction;
  const setAiInstruction = React.useCallback(
    (value: string) => dispatchAI({ type: 'SET_INSTRUCTION', context: 'generic', value }),
    []
  );
  const aiGeneratedText = aiGeneration.generic.text;
  const setAiGeneratedText = React.useCallback(
    (value: string) => dispatchAI({ type: 'SET_TEXT', context: 'generic', value }),
    []
  );
  const generatingAi = aiGeneration.generic.generating;
  const setGeneratingAi = React.useCallback(
    (value: boolean) => dispatchAI({ type: 'SET_GENERATING', context: 'generic', value }),
    []
  );

  // Modelo
  const aiInstructionModel = aiGeneration.model.instruction;
  const setAiInstructionModel = React.useCallback(
    (value: string) => dispatchAI({ type: 'SET_INSTRUCTION', context: 'model', value }),
    []
  );
  const aiGeneratedTextModel = aiGeneration.model.text;
  const setAiGeneratedTextModel = React.useCallback(
    (value: string) => dispatchAI({ type: 'SET_TEXT', context: 'model', value }),
    []
  );
  const generatingAiModel = aiGeneration.model.generating;
  const setGeneratingAiModel = React.useCallback(
    (value: boolean) => dispatchAI({ type: 'SET_GENERATING', context: 'model', value }),
    []
  );

  // Keywords e Title
  const generatingKeywords = aiGeneration.keywords.generating;
  const setGeneratingKeywords = React.useCallback(
    (value: boolean) => dispatchAI({ type: 'SET_GENERATING', context: 'keywords', value }),
    []
  );
  const generatingTitle = aiGeneration.title.generating;
  const setGeneratingTitle = React.useCallback(
    (value: boolean) => dispatchAI({ type: 'SET_GENERATING', context: 'title', value }),
    []
  );

  // RelatÃ³rio
  const relatorioInstruction = aiGeneration.relatorio.instruction;
  const setRelatorioInstruction = React.useCallback(
    (value: string) => dispatchAI({ type: 'SET_INSTRUCTION', context: 'relatorio', value }),
    []
  );
  const regeneratingRelatorio = aiGeneration.relatorio.regenerating;
  const setRegeneratingRelatorio = React.useCallback(
    (value: boolean) => dispatchAI({ type: 'SET_REGENERATING', context: 'relatorio', value }),
    []
  );
  const regenerating = aiGeneration.relatorio.regenerating;
  const setRegenerating = React.useCallback(
    (value: boolean) => dispatchAI({ type: 'SET_REGENERATING', context: 'relatorio', value }),
    []
  );

  // Dispositivo
  const dispositivoText = aiGeneration.dispositivo.text;
  const setDispositivoText = React.useCallback(
    (value: string) => dispatchAI({ type: 'SET_TEXT', context: 'dispositivo', value }),
    []
  );
  const generatingDispositivo = aiGeneration.dispositivo.generating;
  const setGeneratingDispositivo = React.useCallback(
    (value: boolean) => dispatchAI({ type: 'SET_GENERATING', context: 'dispositivo', value }),
    []
  );
  const dispositivoInstruction = aiGeneration.dispositivo.instruction;
  const setDispositivoInstruction = React.useCallback(
    (value: string) => dispatchAI({ type: 'SET_INSTRUCTION', context: 'dispositivo', value }),
    []
  );
  const regeneratingDispositivo = aiGeneration.dispositivo.regenerating;
  const setRegeneratingDispositivo = React.useCallback(
    (value: boolean) => dispatchAI({ type: 'SET_REGENERATING', context: 'dispositivo', value }),
    []
  );

  // v1.36.62: Load/Save AI Settings agora Ã© gerenciado pelo Zustand store (useAIStore.ts)
  // A persistÃªncia acontece automaticamente via middleware 'persist'

  // Utilities
  // v1.20.3: Modificado para acumular tokens no estado persistente
  // v1.36.62: Usa addTokenUsage do Zustand store
  const logCacheMetrics = React.useCallback((data: { usage?: { input_tokens?: number; output_tokens?: number; cache_read_input_tokens?: number; cache_creation_input_tokens?: number } }) => {
    if (data.usage) {
      addTokenUsage({
        input: data.usage.input_tokens || 0,
        output: data.usage.output_tokens || 0,
        cacheRead: data.usage.cache_read_input_tokens || 0,
        cacheCreation: data.usage.cache_creation_input_tokens || 0
      });
    }
  }, [addTokenUsage]);

  // Retorna array com cache_control para Prompt Caching
  // v1.35.76: Estilo personalizado SUBSTITUI (nÃ£o complementa) o estilo default
  const getAiInstructions = React.useCallback(() => {
    const customPrompt = aiSettings?.customPrompt?.trim();

    if (customPrompt) {
      // SUBSTITUTIVO: customPrompt substitui STYLE, mas CORE e SAFETY permanecem
      const customInstructions = `${AI_INSTRUCTIONS_CORE}

ğŸ“ ESTILO DE REDAÃ‡ÃƒO PERSONALIZADO PELO MAGISTRADO:
${customPrompt}

${AI_INSTRUCTIONS_SAFETY}`;

      return [
        {
          type: "text",
          text: customInstructions,
          cache_control: { type: "ephemeral" }
        }
      ];
    }

    // Sem customizaÃ§Ã£o: usa AI_INSTRUCTIONS completo (inclui STYLE default)
    return [
      {
        type: "text",
        text: AI_INSTRUCTIONS,
        cache_control: { type: "ephemeral" }
      }
    ];
  }, [aiSettings]);

  // Build API Request
  const buildApiRequest = React.useCallback((messages: AIMessage[], optionsOrMaxTokens: AICallOptions | number = {}) => {
    const options = typeof optionsOrMaxTokens === 'number'
      ? { maxTokens: optionsOrMaxTokens }
      : optionsOrMaxTokens;

    const {
      maxTokens = 4000,
      systemPrompt = null,
      useInstructions = false,
      model = null,
      disableThinking = false,
      temperature = null,
      topP = null,
      topK = null
    } = options;

    let savedModel = null;
    try {
      const saved = localStorage.getItem('sentencify-ai-settings');
      if (saved) savedModel = JSON.parse(saved).model;
    } catch (e) { /* localStorage indisponÃ­vel */ }
    const modelToUse = model || aiSettings?.model || savedModel || 'claude-sonnet-4-20250514';

    const useThinking = !disableThinking && (aiSettings?.useExtendedThinking || false);

    const MODEL_MAX_TOKENS: Record<string, number> = {
      'claude-sonnet-4-20250514': 64000,
      'claude-opus-4-5-20251101': 32000
    };
    const modelMaxTokens = MODEL_MAX_TOKENS[modelToUse] || 64000;

    const parsedBudget = parseInt(aiSettings?.thinkingBudget || '10000', 10);
    const rawThinkingBudget = isNaN(parsedBudget) ? 10000 : parsedBudget;

    const maxAllowedBudget = useThinking ? Math.max(modelMaxTokens - 2000, 1024) : 0;
    const thinkingBudget = useThinking ? Math.min(rawThinkingBudget, maxAllowedBudget) : 0;

    const rawAdjustedTokens = useThinking ? Math.max(maxTokens + thinkingBudget, thinkingBudget + 2000) : maxTokens;
    const adjustedMaxTokens = Math.min(rawAdjustedTokens, modelMaxTokens);

    const processedMessages = messages.map((message: AIMessage) => {
      if (message.content && Array.isArray(message.content)) {
        let cacheBlocksCount = 0;
        const MAX_CACHE_BLOCKS = 3; // 3 nas messages + 1 no system = 4 total (limite da API)

        const processedContent = message.content.map((block: AIMessageContent, index: number, array: AIMessageContent[]) => {
          const isLastBlock = index === array.length - 1;

          if (isLastBlock) {
            return block;
          }

          if (cacheBlocksCount >= MAX_CACHE_BLOCKS) {
            return block;
          }

          // Type guard: strings don't have .type property
          if (typeof block === 'string') {
            return block;
          }

          if (block.type === 'document') {
            cacheBlocksCount++;
            return {
              ...block,
              cache_control: { type: "ephemeral" as const }
            };
          }

          if (block.type === 'text' && block.text && block.text.length > 2000) {
            cacheBlocksCount++;
            return {
              ...block,
              cache_control: { type: "ephemeral" as const }
            };
          }

          return block;
        });

        return {
          ...message,
          content: processedContent
        };
      }

      return message;
    });

    const requestBody: Record<string, unknown> = {
      model: modelToUse,
      max_tokens: adjustedMaxTokens,
      messages: processedMessages
    };

    // v1.21.25: Parametros opcionais de geracao (apenas se explicitamente passados)
    if (temperature !== null) requestBody.temperature = temperature;
    if (topP !== null) requestBody.top_p = topP;
    if (topK !== null) requestBody.top_k = topK;

    // System prompt com Prompt Caching
    let finalSystemPrompt: unknown = null;
    if (systemPrompt) {
      // systemPrompt customizado: wrap em array com cache
      finalSystemPrompt = [
        {
          type: "text",
          text: systemPrompt,
          cache_control: { type: "ephemeral" }
        }
      ];
    } else if (useInstructions) {
      // getAiInstructions() jÃ¡ retorna array com cache_control
      finalSystemPrompt = getAiInstructions();
    }

    if (finalSystemPrompt) {
      requestBody.system = finalSystemPrompt;
    }

    if (useThinking) {
      requestBody.thinking = {
        type: "enabled",
        budget_tokens: thinkingBudget
      };
    }

    return requestBody;
  }, [aiSettings, getAiInstructions]);

  // Retorna headers HTTP para API Anthropic
  const getApiHeaders = React.useCallback(() => {
    return {
      'Content-Type': 'application/json',
      'anthropic-beta': 'prompt-caching-2024-07-31'
    };
  }, []);

  // Wrapper para chamadas Ã  API Anthropic (com retry, timeout e caching)
  // Constantes para retry com backoff exponencial
  const RETRY_MAX_ATTEMPTS = 3;
  const RETRY_INITIAL_DELAY = 5000; // 5 segundos
  const RETRY_BACKOFF_MULTIPLIER = 2; // 5s, 10s, 20s

  const callLLM = React.useCallback(async (messages: AIMessage[], options: AICallOptions = {}) => {
    const {
      maxTokens = 4000,
      useInstructions = true,
      systemPrompt = null,
      model = null,
      disableThinking = false,
      timeout = null,
      abortSignal = null,
      logMetrics = true,
      extractText = true,
      validateResponse = true
    } = options;

    // v1.32.33: Auto-aumentar timeout para 5 min quando thinking budget >= 40K
    const thinkingBudget = parseInt(aiSettings?.thinkingBudget || '10000', 10);
    const useThinking = !disableThinking && (aiSettings?.useExtendedThinking || false);
    const effectiveTimeout = timeout || (useThinking && thinkingBudget >= 40000 ? 300000 : null); // 5 min para budgets altos

    // Criar AbortController interno se timeout especificado
    const internalController = effectiveTimeout ? new AbortController() : null;
    const timeoutId = effectiveTimeout && internalController ? setTimeout(() => internalController.abort(), effectiveTimeout) : null;

    // Combinar signals: externo tem prioridade, senÃ£o interno
    const signal = abortSignal || internalController?.signal;

    let lastError = null;

    // Loop de retry para erros 429
    for (let attempt = 0; attempt < RETRY_MAX_ATTEMPTS; attempt++) {
      try {
        // Log summary (debug only)
        const _contentSummary: string[] = [];

        // Fazer requisiÃ§Ã£o Ã  API (v1.30: via proxy local)
        const response = await fetch(`${API_BASE}/api/claude/messages`, {
          method: 'POST',
          headers: {
            ...getApiHeaders(),
            'x-api-key': aiSettings.apiKeys?.claude || ''
          },
          body: JSON.stringify(buildApiRequest(messages, {
            maxTokens,
            useInstructions,
            systemPrompt: systemPrompt ?? undefined,
            model: model ?? undefined,
            disableThinking
          })),
          signal
        });

        // Se erro 429 (rate limit), 529 (overloaded) ou 520 (cloudflare), aguardar e tentar novamente
        if ((response.status === 429 || response.status === 529 || response.status === 520 || response.status === 502) && attempt < RETRY_MAX_ATTEMPTS - 1) {
          const delay = RETRY_INITIAL_DELAY * Math.pow(RETRY_BACKOFF_MULTIPLIER, attempt);
          await new Promise(resolve => setTimeout(resolve, delay));
          continue;
        }

        // Limpar timeout se completou
        if (timeoutId) clearTimeout(timeoutId);

        // Validar status HTTP
        if (validateResponse && !response.ok) {
          const errorText = await response.text();
          throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
        }

        // Parsear JSON
        const data = await response.json();

        // v1.32.39: Log thinking no console do browser (v1.32.40: toggle)
        if (aiSettings.logThinking) {
          const thinkingBlock = data.content?.find((c: Record<string, unknown>) => c.type === 'thinking');
          if (thinkingBlock?.thinking) {
            console.group('[Claude] Thinking');
            console.log(thinkingBlock.thinking);
            console.groupEnd();
          }
        }

        if (data.usage) {
          const u = data.usage;
          const cacheRead = u.cache_read_input_tokens || 0;
          const cacheCreation = u.cache_creation_input_tokens || 0;
          const regularInput = u.input_tokens || 0;
          const output = u.output_tokens || 0;
        }

        // Logar mÃ©tricas de cache
        if (logMetrics) {
          logCacheMetrics(data);
        }

        // Verificar erros da API
        if (validateResponse && data.error) {
          throw new Error(`Erro da API: ${data.error.message || JSON.stringify(data.error)}`);
        }

        // Retornar resposta bruta se solicitado
        if (!extractText) {
          return data;
        }

        // Extrair texto da resposta
        const textContent = data.content?.find((c: Record<string, unknown>) => c.type === 'text')?.text || '';

        // Validar se encontrou conteÃºdo
        if (validateResponse && !textContent) {
          throw new Error('Nenhum conteÃºdo de texto encontrado na resposta da API');
        }

        return textContent.trim();

      } catch (err) {
        lastError = err;

        // Limpar timeout em caso de erro
        if (timeoutId) clearTimeout(timeoutId);

        // Tratar erros de abort (nÃ£o retentar)
        const errObj = err as Error;
        if (errObj.name === 'AbortError') {
          if (abortSignal?.aborted) {
            throw new Error('OperaÃ§Ã£o cancelada pelo usuÃ¡rio');
          } else {
            throw new Error(`Timeout: operaÃ§Ã£o demorou mais de ${(effectiveTimeout || 0) / 1000}s`);
          }
        }

        // Se nÃ£o Ã© Ãºltima tentativa e erro parece ser de rate limit, overload, conexÃ£o ou JSON malformado da API
        const errMsg = errObj.message || '';
        if (attempt < RETRY_MAX_ATTEMPTS - 1 && (errMsg.includes('429') || errMsg.includes('529') || errMsg.includes('520') || errMsg.includes('502') || errMsg.includes('Overloaded') || errMsg.includes('Failed to fetch') || errMsg.includes('parsear resposta'))) {
          const delay = RETRY_INITIAL_DELAY * Math.pow(RETRY_BACKOFF_MULTIPLIER, attempt);
          await new Promise(resolve => setTimeout(resolve, delay));
          continue;
        }

        // Re-lanÃ§ar outros erros
        throw err;
      }
    }

    // Se chegou aqui, todas as tentativas falharam
    throw lastError || new Error('Todas as tentativas falharam');
  }, [getApiHeaders, buildApiRequest, logCacheMetrics, aiSettings]);

  // ========================================
  // v1.30: MULTI-PROVIDER SUPPORT (Gemini)
  // ========================================

  // Converter formato de mensagens Claude â†’ Gemini
  const convertToGeminiFormat = React.useCallback((claudeMessages: AIMessage[], systemPrompt: string | null | Record<string, unknown>[] = null): GeminiRequest => {
    const contents = claudeMessages.map((msg: AIMessage) => ({
      role: msg.role === 'assistant' ? 'model' : 'user',
      parts: Array.isArray(msg.content)
        ? msg.content.map((c: AIMessageContent) => {
            // String direta
            if (typeof c === 'string') return { text: c };
            // Texto simples
            if (c.type === 'text') return { text: c.text };
            // Imagem (base64)
            if (c.type === 'image') return {
              inlineData: { mimeType: c.source.media_type || 'image/png', data: c.source.data }
            };
            // PDF/Documento
            if (c.type === 'document' && c.source.type === 'base64') {
              return {
                inlineData: {
                  mimeType: c.source.media_type || 'application/pdf',
                  data: c.source.data
                }
              };
            }
            // Fallback
            return { text: JSON.stringify(c) };
          })
        : [{ text: msg.content as string }]
    }));

    const result: GeminiRequest = { contents };

    // System prompt â†’ systemInstruction
    if (systemPrompt) {
      const systemText = Array.isArray(systemPrompt)
        ? systemPrompt.map((s: Record<string, unknown>) => s.text || s).join('\n\n')
        : systemPrompt;
      result.systemInstruction = { parts: [{ text: systemText as string }] };
    }

    return result;
  }, []);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OPENAI/GROK FORMAT CONVERSION (v1.35.97)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Converte mensagens do formato Claude para formato OpenAI (tambÃ©m usado pelo Grok)
   * @param claudeMessages - Array de mensagens no formato Claude (AIMessage[])
   * @param systemPrompt - System prompt opcional (string ou array de objetos)
   * @returns Array de mensagens no formato OpenAI (OpenAIMessage[])
   */
  const convertToOpenAIFormat = React.useCallback((claudeMessages: AIMessage[], systemPrompt: string | null = null): OpenAIMessage[] => {
    const messages: OpenAIMessage[] = [];

    // System prompt primeiro (se houver)
    if (systemPrompt) {
      const systemText = Array.isArray(systemPrompt)
        ? systemPrompt.map((s: Record<string, unknown>) => s.text || s).join('\n\n')
        : systemPrompt;
      messages.push({ role: 'system', content: systemText });
    }

    // Converter mensagens
    for (const msg of claudeMessages) {
      if (Array.isArray(msg.content)) {
        // Mensagem com mÃºltiplos conteÃºdos (texto + imagem)
        const parts: OpenAIMessagePart[] = [];

        for (const c of msg.content as unknown as Record<string, unknown>[]) {
          if (c.type === 'text') {
            parts.push({ type: 'text', text: c.text as string });
          } else if (c.type === 'image') {
            // Converter formato Claude â†’ OpenAI para imagens
            const source = c.source as Record<string, unknown>;
            const mediaType = source?.media_type || 'image/png';
            const data = source?.data as string;
            parts.push({
              type: 'image_url',
              image_url: { url: `data:${mediaType};base64,${data}` }
            });
          } else if (c.type === 'document') {
            // v1.36.29: OpenAI suporta PDF via base64 (Grok nÃ£o - requer Files API)
            // Nota: Para Grok, UI mostra aviso para usar texto extraÃ­do
            const source = c.source as Record<string, unknown>;
            const mediaType = source?.media_type || 'application/pdf';
            const data = source?.data as string;
            parts.push({
              type: 'file',
              file: {
                filename: 'document.pdf',
                file_data: `data:${mediaType};base64,${data}`
              }
            });
          }
        }

        messages.push({ role: msg.role as 'user' | 'assistant', content: parts });
      } else {
        messages.push({ role: msg.role as 'user' | 'assistant', content: msg.content as string });
      }
    }

    return messages;
  }, []);

  // Extrair mÃ©tricas de tokens da resposta (provider-aware)
  const extractTokenMetrics = React.useCallback((data: Record<string, unknown>, provider: AIProvider) => {
    // v1.35.97: OpenAI e Grok usam mesmo formato (OpenAI-compatible)
    if (provider === 'openai' || provider === 'grok') {
      const usage = (data.usage || {}) as Record<string, unknown>;
      const promptDetails = (usage.prompt_tokens_details || {}) as Record<string, number>;
      return {
        input: (usage.prompt_tokens as number) || 0,
        output: (usage.completion_tokens as number) || 0,
        cacheRead: promptDetails.cached_tokens || 0,
        cacheCreation: 0
      };
    }
    if (provider === 'gemini') {
      const usage = (data.usageMetadata || {}) as Record<string, number>;
      return {
        input: usage.promptTokenCount || 0,
        output: usage.candidatesTokenCount || 0,
        cacheRead: usage.cachedContentTokenCount || 0,
        cacheCreation: 0
      };
    }
    // Claude (default)
    const usage = (data.usage || {}) as Record<string, number>;
    return {
      input: usage.input_tokens || 0,
      output: usage.output_tokens || 0,
      cacheRead: usage.cache_read_input_tokens || 0,
      cacheCreation: usage.cache_creation_input_tokens || 0
    };
  }, []);

  // Extrair texto da resposta (provider-aware)
  const extractResponseText = React.useCallback((data: Record<string, unknown>, provider: AIProvider) => {
    // v1.35.97: OpenAI e Grok usam mesmo formato (OpenAI-compatible)
    if (provider === 'openai' || provider === 'grok') {
      const choices = data.choices as Record<string, unknown>[] | undefined;
      const message = choices?.[0]?.message as Record<string, unknown> | undefined;

      // Log reasoning se logThinking ativo (OpenAI apenas)
      if (provider === 'openai' && aiSettings.logThinking && message?.reasoning_details) {
        console.log('[OpenAI Reasoning]', message.reasoning_details);
      }

      // Verificar finish_reason para erros
      const finishReason = choices?.[0]?.finish_reason;
      if (finishReason === 'content_filter') {
        throw new Error('Resposta bloqueada pelo filtro de conteÃºdo.');
      }
      if (finishReason === 'length') {
        console.warn(`[${provider}] Resposta truncada por limite de tokens`);
      }

      return (message?.content as string) || '';
    }
    if (provider === 'gemini') {
      const candidates = data.candidates as Record<string, unknown>[] | undefined;
      const candidate = candidates?.[0];
      const finishReason = candidate?.finishReason;

      // Verificar bloqueio de seguranÃ§a
      if (finishReason === 'SAFETY') {
        throw new Error('Resposta bloqueada por seguranÃ§a. Reformule a pergunta.');
      }
      if (finishReason === 'RECITATION') {
        throw new Error('Resposta bloqueada por direitos autorais.');
      }
      const promptFeedback = data.promptFeedback as Record<string, unknown> | undefined;
      if (promptFeedback?.blockReason) {
        throw new Error(`Prompt bloqueado: ${promptFeedback.blockReason}`);
      }

      // v1.32.35: Com thinking habilitado, parts[0] Ã© o thinking block
      // Buscar o primeiro part que NÃƒO seja thinking (thought !== true)
      const content = candidate?.content as Record<string, unknown> | undefined;
      const parts = (content?.parts || []) as Record<string, unknown>[];
      const textPart = parts.find((p: Record<string, unknown>) => !p.thought && p.text);
      return (textPart?.text as string) || '';
    }
    // Claude (default)
    const content = data.content as Record<string, unknown>[] | undefined;
    return (content?.find((c: Record<string, unknown>) => c.type === 'text')?.text as string) || '';
  }, [aiSettings.logThinking]);

  // v1.32.37: Configurar thinking para Gemini 3 (removido suporte a 2.5)
  // Docs: https://ai.google.dev/gemini-api/docs/thinking
  // Gemini 3: usa thinking_level enum (nÃ£o pode desativar)
  // - Flash: minimal, low, medium, high
  // - Pro: low, high (nÃ£o tem minimal nem medium)
  const getGeminiThinkingConfig = React.useCallback((model: string) => {
    let level = aiSettings.geminiThinkingLevel || 'high';

    // v1.32.37: Pro sÃ³ suporta low/high - converter valores invÃ¡lidos
    const isPro = model?.includes('pro');
    if (isPro && (level === 'minimal' || level === 'medium')) {
      level = 'low';  // Fallback para nÃ­vel vÃ¡lido mais prÃ³ximo
    }

    return { thinking_level: level };
  }, [aiSettings.geminiThinkingLevel]);

  // CÃ³digos de status para retry por provider
  const GEMINI_RETRY_CODES = [429, 500, 502, 503, 529];

  // Chamada Ã  API Gemini
  const callGeminiAPI = React.useCallback(async (messages: AIMessage[], options: AICallOptions = {}) => {
    const {
      maxTokens = 4000,
      systemPrompt = null,
      useInstructions = false,  // v1.32.29: Suporte a useInstructions igual ao Claude
      model = aiSettings.geminiModel || 'gemini-3-flash-preview',
      temperature = null,
      topP = null,
      topK = null,
      timeout = null,
      abortSignal = null,
      logMetrics = true,
      extractText = true
    } = options;

    // v1.32.29: Resolver systemPrompt igual ao Claude (useInstructions â†’ getAiInstructions)
    let finalSystemPrompt = systemPrompt;
    if (!finalSystemPrompt && useInstructions) {
      const instructions = getAiInstructions();
      // getAiInstructions() retorna array [{text: "...", cache_control: ...}]
      // Converter para string para o Gemini
      finalSystemPrompt = Array.isArray(instructions)
        ? instructions.map(i => i.text || i).join('\n\n')
        : instructions;
    }

    const RETRY_MAX = 3;
    const RETRY_DELAY = 5000;

    // AbortController para timeout
    const internalController = timeout ? new AbortController() : null;
    const timeoutId = timeout && internalController ? setTimeout(() => internalController.abort(), timeout) : null;
    const signal = abortSignal || internalController?.signal;

    let lastError = null;

    for (let attempt = 0; attempt < RETRY_MAX; attempt++) {
      try {
        // Converter mensagens para formato Gemini
        const geminiRequest = convertToGeminiFormat(messages, finalSystemPrompt);

        // v1.32.38: Gemini thinking consome maxOutputTokens - adicionar buffer
        const thinkingLevel = aiSettings.geminiThinkingLevel || 'high';
        const thinkingBuffer = {
          'minimal': 2000,
          'low': 4000,
          'medium': 8000,
          'high': 16000
        }[thinkingLevel] || 8000;

        // Configurar generationConfig com buffer para thinking
        geminiRequest.generationConfig = {
          maxOutputTokens: maxTokens + thinkingBuffer
        };

        // Gemini 3: forÃ§ar temperature 1.0 para evitar bugs
        // Gemini 2.x: mÃ­nimo 0.5 para evitar filtro RECITATION (Google recomenda temp alta)
        const isGemini3 = model.includes('gemini-3') || model.includes('3-flash') || model.includes('3-pro');
        if (isGemini3) {
          geminiRequest.generationConfig.temperature = 1.0;  // Recomendado pelo Google
        } else {
          // Gemini 2.x: usar temperatura fornecida, mas mÃ­nimo 0.7 para evitar RECITATION
          const minTemp = 0.7;
          geminiRequest.generationConfig.temperature = temperature !== null
            ? Math.max(temperature, minTemp)
            : minTemp;
        }

        if (topP !== null) geminiRequest.generationConfig.topP = topP;
        if (topK !== null) geminiRequest.generationConfig.topK = topK;

        // v1.32.36: Gemini 3 sempre usa thinking (nÃ£o pode desativar)
        // v1.32.39: includeThoughts para retornar pensamentos na resposta
        geminiRequest.generationConfig.thinking_config = {
          ...getGeminiThinkingConfig(model),
          includeThoughts: true
        };

        // Fazer requisiÃ§Ã£o via proxy local
        const response = await fetch(`${API_BASE}/api/gemini/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model,
            apiKey: aiSettings.apiKeys?.gemini || '',
            request: geminiRequest
          }),
          signal
        });

        // Retry em caso de rate limit ou erro temporÃ¡rio
        if (GEMINI_RETRY_CODES.includes(response.status) && attempt < RETRY_MAX - 1) {
          const delay = RETRY_DELAY * Math.pow(2, attempt);
          console.warn(`[Gemini] Retry ${attempt + 1}/${RETRY_MAX} apÃ³s ${delay}ms`);
          await new Promise(r => setTimeout(r, delay));
          continue;
        }

        if (timeoutId) clearTimeout(timeoutId);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();

        // v1.32.39: Log thinking no console do browser (v1.32.40: toggle)
        if (aiSettings.logThinking) {
          const parts = data.candidates?.[0]?.content?.parts || [];
          const thinkingPart = parts.find((p: { thought?: boolean; text?: string }) => p.thought === true);
          if (thinkingPart?.text) {
            console.group('[Gemini] Thinking');
            console.log(thinkingPart.text);
            console.groupEnd();
          }
        }

        // Logar mÃ©tricas
        if (logMetrics && data.usageMetadata) {
          const metrics = extractTokenMetrics(data, 'gemini');
          setTokenMetrics(prev => ({
            totalInput: (prev.totalInput ?? 0) + metrics.input,
            totalOutput: (prev.totalOutput ?? 0) + metrics.output,
            totalCacheRead: (prev.totalCacheRead ?? 0) + metrics.cacheRead,
            totalCacheCreation: (prev.totalCacheCreation ?? 0) + metrics.cacheCreation,
            requestCount: (prev.requestCount ?? 0) + 1,
            lastUpdated: new Date().toISOString()
          }));
        }

        // Retornar resposta bruta se solicitado
        if (!extractText) {
          return data;
        }

        // Extrair texto
        const textContent = extractResponseText(data, 'gemini');
        return textContent.trim();

      } catch (err) {
        lastError = err;
        if (timeoutId) clearTimeout(timeoutId);

        if ((err as Error).name === 'AbortError') {
          throw new Error(abortSignal?.aborted ? 'OperaÃ§Ã£o cancelada' : `Timeout apÃ³s ${(timeout ?? 0)/1000}s`);
        }

        if (attempt < RETRY_MAX - 1) {
          const delay = RETRY_DELAY * Math.pow(2, attempt);
          await new Promise(r => setTimeout(r, delay));
          continue;
        }

        throw err;
      }
    }

    throw lastError || new Error('Todas as tentativas falharam');
  }, [aiSettings, convertToGeminiFormat, extractTokenMetrics, extractResponseText, getGeminiThinkingConfig, setTokenMetrics, getAiInstructions]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OPENAI GPT-5.2 INTEGRATION (v1.35.97)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /** CÃ³digos HTTP que disparam retry automÃ¡tico */
  const OPENAI_RETRY_CODES = [429, 500, 502, 503, 529];

  /** ConfiguraÃ§Ãµes padrÃ£o OpenAI */
  const OPENAI_CONFIG = {
    MAX_TOKENS_DEFAULT: 4000,
    REASONING_TIMEOUT_MS: 300000,  // 5 min para reasoning xhigh
    RETRY_MAX_ATTEMPTS: 3,
    RETRY_DELAY_MS: 5000
  } as const;

  /**
   * Faz chamada Ã  API OpenAI (GPT-5.2)
   */
  const callOpenAIAPI = React.useCallback(async (messages: AIMessage[], options: AICallOptions = {}) => {
    const {
      maxTokens = OPENAI_CONFIG.MAX_TOKENS_DEFAULT,
      systemPrompt = null,
      useInstructions = false,
      model = aiSettings.openaiModel || 'gpt-5.2-chat-latest',
      timeout = null,
      abortSignal = null,
      logMetrics = true,
      extractText = true,
      disableThinking = false
    } = options;

    // Resolver systemPrompt
    let finalSystemPrompt = systemPrompt as string | null;
    if (!finalSystemPrompt && useInstructions) {
      const instructions = getAiInstructions();
      finalSystemPrompt = Array.isArray(instructions)
        ? instructions.map((i: Record<string, unknown>) => i.text || i).join('\n\n')
        : instructions;
    }

    // Timeout maior para reasoning xhigh
    const reasoningLevel = aiSettings.openaiReasoningLevel || 'medium';
    const effectiveTimeout = timeout || (
      model === 'gpt-5.2' && reasoningLevel === 'xhigh'
        ? OPENAI_CONFIG.REASONING_TIMEOUT_MS
        : null
    );

    const internalController = effectiveTimeout ? new AbortController() : null;
    const timeoutId = effectiveTimeout ? setTimeout(() => internalController?.abort(), effectiveTimeout) : null;
    const signal = abortSignal || internalController?.signal;

    let lastError: Error | null = null;

    for (let attempt = 0; attempt < OPENAI_CONFIG.RETRY_MAX_ATTEMPTS; attempt++) {
      try {
        const openaiMessages = convertToOpenAIFormat(messages, finalSystemPrompt);

        const requestBody: Record<string, unknown> = {
          model,
          messages: openaiMessages,
          max_tokens: maxTokens
        };

        // Adicionar reasoning apenas para gpt-5.2 (nÃ£o gpt-5.2-chat-latest)
        if (model === 'gpt-5.2' && !disableThinking) {
          requestBody.reasoning = { effort: reasoningLevel };
        }

        const response = await fetch(`${API_BASE}/api/openai/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': aiSettings.apiKeys?.openai || ''
          },
          body: JSON.stringify(requestBody),
          signal
        });

        if (timeoutId) clearTimeout(timeoutId);

        if (OPENAI_RETRY_CODES.includes(response.status) && attempt < OPENAI_CONFIG.RETRY_MAX_ATTEMPTS - 1) {
          console.warn(`[OpenAI] Retry ${attempt + 1}/${OPENAI_CONFIG.RETRY_MAX_ATTEMPTS} - status ${response.status}`);
          await new Promise(r => setTimeout(r, OPENAI_CONFIG.RETRY_DELAY_MS * (attempt + 1)));
          continue;
        }

        const data = await response.json();

        if (!response.ok) {
          const errorMsg = data.error?.message || `OpenAI API error: ${response.status}`;
          throw new Error(errorMsg);
        }

        if (logMetrics) {
          const metrics = extractTokenMetrics(data, 'openai');
          setTokenMetrics(prev => ({
            totalInput: (prev.totalInput || 0) + metrics.input,
            totalOutput: (prev.totalOutput || 0) + metrics.output,
            totalCacheRead: (prev.totalCacheRead || 0) + metrics.cacheRead,
            totalCacheCreation: (prev.totalCacheCreation || 0) + metrics.cacheCreation,
            requestCount: (prev.requestCount || 0) + 1,
            lastUpdated: new Date().toISOString()
          }));
        }

        if (extractText) {
          return extractResponseText(data, 'openai');
        }
        return data;

      } catch (err: unknown) {
        lastError = err as Error;
        if (timeoutId) clearTimeout(timeoutId);

        if (lastError.name === 'AbortError') {
          throw new Error('RequisiÃ§Ã£o cancelada (timeout)');
        }

        if (attempt < OPENAI_CONFIG.RETRY_MAX_ATTEMPTS - 1) {
          console.warn(`[OpenAI] Retry ${attempt + 1}/${OPENAI_CONFIG.RETRY_MAX_ATTEMPTS} - ${lastError.message}`);
          await new Promise(r => setTimeout(r, OPENAI_CONFIG.RETRY_DELAY_MS * (attempt + 1)));
          continue;
        }
        throw lastError;
      }
    }

    throw lastError || new Error('OpenAI: todas as tentativas falharam');
  }, [aiSettings, convertToOpenAIFormat, extractTokenMetrics, extractResponseText, setTokenMetrics, getAiInstructions]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // XAI GROK 4.1 INTEGRATION (v1.35.97)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /** CÃ³digos HTTP que disparam retry automÃ¡tico (mesmo do OpenAI) */
  const GROK_RETRY_CODES = [429, 500, 502, 503, 529];

  /** ConfiguraÃ§Ãµes padrÃ£o Grok */
  const GROK_CONFIG = {
    MAX_TOKENS_DEFAULT: 4000,
    RETRY_MAX_ATTEMPTS: 3,
    RETRY_DELAY_MS: 5000
  } as const;

  /**
   * Faz chamada Ã  API xAI Grok (OpenAI-compatible)
   */
  const callGrokAPI = React.useCallback(async (messages: AIMessage[], options: AICallOptions = {}) => {
    const {
      maxTokens = GROK_CONFIG.MAX_TOKENS_DEFAULT,
      systemPrompt = null,
      useInstructions = false,
      model = aiSettings.grokModel || 'grok-4-1-fast-reasoning',
      abortSignal = null,
      logMetrics = true,
      extractText = true
    } = options;

    let finalSystemPrompt = systemPrompt as string | null;
    if (!finalSystemPrompt && useInstructions) {
      const instructions = getAiInstructions();
      finalSystemPrompt = Array.isArray(instructions)
        ? instructions.map((i: Record<string, unknown>) => i.text || i).join('\n\n')
        : instructions;
    }

    let lastError: Error | null = null;

    for (let attempt = 0; attempt < GROK_CONFIG.RETRY_MAX_ATTEMPTS; attempt++) {
      try {
        const grokMessages = convertToOpenAIFormat(messages, finalSystemPrompt);

        const requestBody = {
          model,
          messages: grokMessages,
          max_tokens: maxTokens
        };

        const response = await fetch(`${API_BASE}/api/grok/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': aiSettings.apiKeys?.grok || ''
          },
          body: JSON.stringify(requestBody),
          signal: abortSignal
        });

        if (GROK_RETRY_CODES.includes(response.status) && attempt < GROK_CONFIG.RETRY_MAX_ATTEMPTS - 1) {
          console.warn(`[Grok] Retry ${attempt + 1}/${GROK_CONFIG.RETRY_MAX_ATTEMPTS} - status ${response.status}`);
          await new Promise(r => setTimeout(r, GROK_CONFIG.RETRY_DELAY_MS * (attempt + 1)));
          continue;
        }

        const data = await response.json();

        // v1.36.17: Log thinking no console para Grok
        if (aiSettings.logThinking) {
          const choices = data.choices as Record<string, unknown>[] | undefined;
          const message = choices?.[0]?.message as Record<string, unknown> | undefined;
          // Grok pode retornar reasoning em diferentes campos
          const reasoning = message?.reasoning || message?.reasoning_content || message?.thinking;
          if (reasoning) {
            console.group('[Grok] Thinking');
            console.log(reasoning);
            console.groupEnd();
          }
        }

        if (!response.ok) {
          const errorMsg = data.error?.message || `Grok API error: ${response.status}`;
          throw new Error(errorMsg);
        }

        if (logMetrics) {
          const metrics = extractTokenMetrics(data, 'grok');
          setTokenMetrics(prev => ({
            totalInput: (prev.totalInput || 0) + metrics.input,
            totalOutput: (prev.totalOutput || 0) + metrics.output,
            totalCacheRead: (prev.totalCacheRead || 0) + metrics.cacheRead,
            totalCacheCreation: (prev.totalCacheCreation || 0) + metrics.cacheCreation,
            requestCount: (prev.requestCount || 0) + 1,
            lastUpdated: new Date().toISOString()
          }));
        }

        if (extractText) {
          return extractResponseText(data, 'grok');
        }
        return data;

      } catch (err: unknown) {
        lastError = err as Error;

        if (lastError.name === 'AbortError') {
          throw new Error('RequisiÃ§Ã£o cancelada');
        }

        if (attempt < GROK_CONFIG.RETRY_MAX_ATTEMPTS - 1) {
          console.warn(`[Grok] Retry ${attempt + 1}/${GROK_CONFIG.RETRY_MAX_ATTEMPTS} - ${lastError.message}`);
          await new Promise(r => setTimeout(r, GROK_CONFIG.RETRY_DELAY_MS * (attempt + 1)));
          continue;
        }
        throw lastError;
      }
    }

    throw lastError || new Error('Grok: todas as tentativas falharam');
  }, [aiSettings, convertToOpenAIFormat, extractTokenMetrics, extractResponseText, setTokenMetrics, getAiInstructions]);

  // FunÃ§Ã£o unificada que escolhe Claude, Gemini, OpenAI ou Grok baseado no provider
  const callAI = React.useCallback(async (messages: AIMessage[], options: AICallOptions = {}) => {
    const provider = aiSettings.provider || 'claude';

    // v1.35.97: OpenAI GPT-5.2
    if (provider === 'openai') {
      return await callOpenAIAPI(messages, {
        ...options,
        model: options.model || aiSettings.openaiModel || 'gpt-5.2-chat-latest'
      });
    }

    // v1.35.97: xAI Grok 4.1
    if (provider === 'grok') {
      return await callGrokAPI(messages, {
        ...options,
        model: options.model || aiSettings.grokModel || 'grok-4-1-fast-reasoning'
      });
    }

    if (provider === 'gemini') {
      return await callGeminiAPI(messages, {
        ...options,
        model: options.model || aiSettings.geminiModel || 'gemini-3-flash-preview'
      });
    }

    // Default: Claude
    return await callLLM(messages, {
      ...options,
      model: options.model || aiSettings.claudeModel || 'claude-sonnet-4-20250514'
    });
  }, [aiSettings, callLLM, callGeminiAPI, callOpenAIAPI, callGrokAPI]);

  // ========================================
  // END MULTI-PROVIDER SUPPORT
  // ========================================

  const getModelDisplayName = React.useCallback((modelId: string) => {
    const models: Record<string, string> = {
      // Claude
      'claude-sonnet-4-20250514': 'Claude Sonnet 4.5',
      'claude-opus-4-5-20251101': 'Claude Opus 4.5',
      // Gemini 3 (v1.32.36: removido 2.5)
      'gemini-3-flash-preview': 'Gemini 3 Flash',
      'gemini-3-pro-preview': 'Gemini 3 Pro',
      // v1.35.97: OpenAI GPT-5.2
      'gpt-5.2': 'GPT-5.2 Thinking',
      'gpt-5.2-chat-latest': 'GPT-5.2 Instant',
      // v1.35.97: xAI Grok 4.1
      'grok-4-1-fast-reasoning': 'Grok 4.1 Fast',
      'grok-4-1-fast-non-reasoning': 'Grok 4.1 Instant'
    };
    return models[modelId] || modelId;
  }, []);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DOUBLE CHECK - VerificaÃ§Ã£o secundÃ¡ria de respostas da IA
  // v1.36.50
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Chama a API com provider/modelo especÃ­fico (para double check)
   * v1.36.56: Atualizado para usar thinking config do Double Check
   */
  const callDoubleCheckAPI = React.useCallback(async (
    provider: AIProvider,
    model: string,
    prompt: string,
    maxTokens: number = 8000
  ): Promise<string> => {
    const messages: AIMessage[] = [
      { role: 'user', content: prompt }
    ];

    // v1.36.56: Construir opÃ§Ãµes com thinking config do Double Check
    const dcSettings = aiSettings.doubleCheck;
    const options: AICallOptions = { maxTokens, model };

    // Aplicar thinking config baseado no provider
    if (provider === 'claude' && dcSettings?.claudeThinkingBudget && dcSettings.claudeThinkingBudget > 0) {
      // Para Claude, o thinking Ã© gerenciado internamente via aiSettings.thinkingBudget
      // Precisamos criar uma versÃ£o temporÃ¡ria das settings para a chamada
      // Por simplicidade, vamos passar como disableThinking = false quando tiver budget
      options.disableThinking = false;
    } else if (provider === 'claude') {
      options.disableThinking = true;
    }

    // Nota: Para Gemini e OpenAI, o thinking Ã© configurado nas funÃ§Ãµes callGeminiAPI e callOpenAIAPI
    // que lÃªem de aiSettings. Por ora, o Double Check usarÃ¡ as configuraÃ§Ãµes padrÃ£o do provider.
    // Uma melhoria futura seria passar o thinking config diretamente.

    // Chamar a API especÃ­fica do provider
    if (provider === 'openai') {
      return await callOpenAIAPI(messages, options);
    }
    if (provider === 'grok') {
      return await callGrokAPI(messages, options);
    }
    if (provider === 'gemini') {
      return await callGeminiAPI(messages, options);
    }
    // Default: Claude
    return await callLLM(messages, options);
  }, [callLLM, callGeminiAPI, callOpenAIAPI, callGrokAPI, aiSettings.doubleCheck]);

  /**
   * Executa o double check em uma resposta da IA
   * @param operation - Tipo de operaÃ§Ã£o (topicExtraction, etc)
   * @param originalResponse - Resposta original em JSON
   * @param context - Documentos/contexto original
   * @param onProgress - Callback de progresso opcional
   */
  // v1.36.58: Atualizado para suportar factsComparison
  const performDoubleCheck = React.useCallback(async (
    operation: 'topicExtraction' | 'dispositivo' | 'sentenceReview' | 'factsComparison',
    originalResponse: string,
    context: string,
    onProgress?: (msg: string) => void
  ): Promise<{ verified: string; corrections: DoubleCheckCorrection[]; summary: string }> => {
    const { doubleCheck } = aiSettings;

    // Se double check desabilitado ou operaÃ§Ã£o nÃ£o selecionada, retornar original
    if (!doubleCheck?.enabled || !doubleCheck.operations[operation]) {
      return { verified: originalResponse, corrections: [], summary: '' };
    }

    onProgress?.('ğŸ”„ Verificando resposta com Double Check...');

    try {
      // Importar dinamicamente o prompt builder
      const { buildDoubleCheckPrompt } = await import('./prompts/double-check-prompts');
      const verificationPrompt = buildDoubleCheckPrompt(operation, originalResponse, context);

      // Chamar API com o modelo de double check
      const response = await callDoubleCheckAPI(
        doubleCheck.provider,
        doubleCheck.model,
        verificationPrompt,
        8000
      );

      // v1.36.56: Parsear resposta JSON baseado no tipo de operaÃ§Ã£o
      // v1.36.60: Adicionado factsComparison (verifiedResult)
      const verifiedFieldPattern = operation === 'topicExtraction'
        ? '"verifiedTopics"'
        : operation === 'dispositivo'
          ? '"verifiedDispositivo"'
          : operation === 'factsComparison'
            ? '"verifiedResult"'
            : '"verifiedReview"';

      const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/) ||
                        response.match(new RegExp(`\\{[\\s\\S]*${verifiedFieldPattern}[\\s\\S]*\\}`));

      if (!jsonMatch) {
        console.warn('[DoubleCheck] Resposta nÃ£o contÃ©m JSON vÃ¡lido:', response.substring(0, 200));
        return { verified: originalResponse, corrections: [], summary: 'Falha ao parsear resposta' };
      }

      const jsonStr = jsonMatch[1] || jsonMatch[0];
      const result = JSON.parse(jsonStr);

      // Extrair campo verificado baseado na operaÃ§Ã£o
      // v1.36.60: Adicionado factsComparison (verifiedResult)
      const verified = operation === 'topicExtraction'
        ? JSON.stringify(result.verifiedTopics)
        : operation === 'dispositivo'
          ? result.verifiedDispositivo || originalResponse
          : operation === 'factsComparison'
            ? JSON.stringify(result.verifiedResult) || originalResponse
            : result.verifiedReview || originalResponse;

      return {
        verified,
        corrections: result.corrections || [],
        summary: result.summary || ''
      };
    } catch (error) {
      console.error('[DoubleCheck] Erro:', error);
      return { verified: originalResponse, corrections: [], summary: 'Erro na verificaÃ§Ã£o' };
    }
  }, [aiSettings, callDoubleCheckAPI]);

  return {
    // Estados
    aiSettings,
    aiInstruction,
    aiGeneratedText,
    generatingAi,
    aiInstructionModel,
    aiGeneratedTextModel,
    generatingAiModel,
    generatingKeywords,
    relatorioInstruction,
    regeneratingRelatorio,
    regenerating,
    dispositivoText,
    generatingDispositivo,
    dispositivoInstruction,
    regeneratingDispositivo,

    // Setters
    setAiSettings,
    setAiInstruction,
    setAiGeneratedText,
    setGeneratingAi,
    setAiInstructionModel,
    setAiGeneratedTextModel,
    setGeneratingAiModel,
    setGeneratingKeywords,
    generatingTitle,
    setGeneratingTitle,
    setRelatorioInstruction,
    setRegeneratingRelatorio,
    setRegenerating,
    setDispositivoText,
    setGeneratingDispositivo,
    setDispositivoInstruction,
    setRegeneratingDispositivo,

    // FunÃ§Ãµes
    buildApiRequest,
    getApiHeaders,
    callLLM,
    logCacheMetrics,
    getAiInstructions,
    getModelDisplayName,

    // v1.30: Multi-provider support
    callGeminiAPI,
    callOpenAIAPI,   // v1.35.97
    callGrokAPI,     // v1.35.97
    callAI,
    convertToGeminiFormat,
    convertToOpenAIFormat,  // v1.35.97
    extractTokenMetrics,
    extractResponseText,

    // v1.36.50: Double Check
    performDoubleCheck,

    // v1.20.3: Contador de tokens persistente
    tokenMetrics,
    setTokenMetrics
  };
};

// ğŸ£ CUSTOM HOOKS extraÃ­dos para src/hooks/ (v1.36.69):
// TIER 0: useFullscreen, useSpacingControl, useFontSizeControl, useFeatureFlags, useThrottledBroadcast,
//         useAPICache, usePrimaryTabLock, useFieldVersioning
// TIER 1: useIndexedDB (+ validateModel, sanitizeModel)

// ğŸ“¦ SERVIÃ‡O IndexedDB para PDFs (v1.12.14)
const PDF_DB_NAME = 'sentencify-pdfs';
const PDF_STORE_NAME = 'pdfs';
const PDF_DB_VERSION = 1;

const openPdfDB = (): Promise<IDBDatabase> => {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(PDF_DB_NAME, PDF_DB_VERSION);

    request.onerror = () => {
      reject(request.error);
    };

    request.onsuccess = () => {
      resolve(request.result);
    };

    request.onupgradeneeded = (event) => {
      const db = (event.target as IDBOpenDBRequest).result;
      if (!db.objectStoreNames.contains(PDF_STORE_NAME)) {
        // Store com chave 'id' (formato: 'upload-{index}' ou 'proof-{id}')
        db.createObjectStore(PDF_STORE_NAME, { keyPath: 'id' });
      }
    };
  });
};

// Salva um PDF no IndexedDB
const savePdfToIndexedDB = async (id: string, file: File, type: string) => {
  try {
    // Converter File para ArrayBuffer ANTES de abrir transaÃ§Ã£o
    // (evita TransactionInactiveError quando chamado em paralelo)
    const arrayBuffer = await file.arrayBuffer();

    const db = await openPdfDB();
    const transaction = db.transaction([PDF_STORE_NAME], 'readwrite');
    const store = transaction.objectStore(PDF_STORE_NAME);

    const pdfRecord = {
      id,
      type,
      fileName: file.name,
      fileSize: file.size,
      mimeType: file.type,
      data: arrayBuffer,
      savedAt: Date.now()
    };

    await new Promise<void>((resolve, reject) => {
      const request = store.put(pdfRecord);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });

    db.close();
  } catch (error) {
    throw error;
  }
};

// Tipo para registro de PDF no IndexedDB
interface PdfRecord {
  id: string;
  data: ArrayBuffer;
  mimeType: string;
  fileName: string;
  savedAt: number;
}

// Recupera um PDF do IndexedDB
const getPdfFromIndexedDB = async (id: string) => {
  try {
    const db = await openPdfDB();
    const transaction = db.transaction([PDF_STORE_NAME], 'readonly');
    const store = transaction.objectStore(PDF_STORE_NAME);

    const record = await new Promise<PdfRecord | undefined>((resolve, reject) => {
      const request = store.get(id);
      request.onsuccess = () => resolve(request.result as PdfRecord | undefined);
      request.onerror = () => reject(request.error);
    });

    db.close();

    if (!record) {
      return null;
    }

    // Reconstruir File a partir do ArrayBuffer
    const blob = new Blob([record.data], { type: record.mimeType });
    const file = new File([blob], record.fileName, {
      type: record.mimeType,
      lastModified: record.savedAt
    });

    return file;
  } catch (error) {
    return null;
  }
};

// Remove um PDF especÃ­fico do IndexedDB
const removePdfFromIndexedDB = async (id: string) => {
  try {
    const db = await openPdfDB();
    const transaction = db.transaction([PDF_STORE_NAME], 'readwrite');
    const store = transaction.objectStore(PDF_STORE_NAME);

    await new Promise<void>((resolve, reject) => {
      const request = store.delete(id);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });

    db.close();
  } catch (error) {
    throw error;
  }
};

// Remove todos os PDFs do IndexedDB
const clearAllPdfsFromIndexedDB = async () => {
  try {
    const db = await openPdfDB();
    const transaction = db.transaction([PDF_STORE_NAME], 'readwrite');
    const store = transaction.objectStore(PDF_STORE_NAME);

    await new Promise<void>((resolve, reject) => {
      const request = store.clear();
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });

    db.close();
  } catch (error) {
    throw error;
  }
};

// ğŸ“¦ SERVIÃ‡O IndexedDB para JurisprudÃªncia
const JURIS_DB_NAME = 'sentencify-jurisprudencia';
const JURIS_STORE_NAME = 'precedentes';

const openJurisDB = (): Promise<IDBDatabase> => new Promise((resolve, reject) => {
  const request = indexedDB.open(JURIS_DB_NAME, 2);
  request.onerror = () => reject(request.error);
  request.onsuccess = () => resolve(request.result);
  request.onupgradeneeded = (e: IDBVersionChangeEvent) => {
    const db = (e.target as IDBOpenDBRequest).result;
    if (!db.objectStoreNames.contains(JURIS_STORE_NAME)) {
      const store = db.createObjectStore(JURIS_STORE_NAME, { keyPath: 'id' });
      store.createIndex('byCategory', 'category', { unique: false });
      store.createIndex('byTipo', 'tipoProcesso', { unique: false });
      store.createIndex('byTribunal', 'tribunal', { unique: false });
    } else if (e.oldVersion < 2) {
      const store = ((e.target as IDBOpenDBRequest).transaction as IDBTransaction).objectStore(JURIS_STORE_NAME);
      if (!store.indexNames.contains('byTribunal')) {
        store.createIndex('byTribunal', 'tribunal', { unique: false });
      }
    }
  };
});

const savePrecedentesToIndexedDB = async (precedentes: Precedente[]): Promise<void> => {
  const db = await openJurisDB();
  const tx = db.transaction([JURIS_STORE_NAME], 'readwrite');
  const store = tx.objectStore(JURIS_STORE_NAME);
  for (const p of precedentes) store.put(p);
  db.close();
};

const loadPrecedentesFromIndexedDB = async (): Promise<Precedente[]> => {
  try {
    const db = await openJurisDB();
    const tx = db.transaction([JURIS_STORE_NAME], 'readonly');
    const store = tx.objectStore(JURIS_STORE_NAME);
    const result = await new Promise<Precedente[]>((resolve, reject) => {
      const req = store.getAll() as IDBRequest<Precedente[]>;
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
    db.close();
    return result;
  } catch { return []; }
};

const clearPrecedentesFromIndexedDB = async (): Promise<void> => {
  try {
    const db = await openJurisDB();
    const tx = db.transaction([JURIS_STORE_NAME], 'readwrite');
    const store = tx.objectStore(JURIS_STORE_NAME);
    await new Promise<void>((resolve, reject) => {
      const req = store.clear();
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
    db.close();
  } catch { /* silenciado */ }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“œ LEGISLAÃ‡ÃƒO - IndexedDB Storage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const LEGIS_DB_NAME = 'sentencify-legislacao';
const LEGIS_STORE_NAME = 'artigos';

const LEIS_METADATA: Record<string, { nome: string; nomeCompleto: string; numero: string }> = {
  'clt': { nome: 'CLT', nomeCompleto: 'ConsolidaÃ§Ã£o das Leis do Trabalho', numero: 'Decreto-Lei 5.452/1943' },
  'cf': { nome: 'CF/88', nomeCompleto: 'ConstituiÃ§Ã£o Federal', numero: 'CF 1988' },
  'cpc': { nome: 'CPC', nomeCompleto: 'CÃ³digo de Processo Civil', numero: 'Lei 13.105/2015' },
  'cc': { nome: 'CC', nomeCompleto: 'CÃ³digo Civil', numero: 'Lei 10.406/2002' },
  'cdc': { nome: 'CDC', nomeCompleto: 'CÃ³digo de Defesa do Consumidor', numero: 'Lei 8.078/1990' },
  'l605': { nome: 'Lei 605', nomeCompleto: 'Repouso Semanal Remunerado', numero: 'Lei 605/1949' },
  'l6019': { nome: 'Lei 6.019', nomeCompleto: 'Trabalho TemporÃ¡rio', numero: 'Lei 6.019/1974' },
  'l9029': { nome: 'Lei 9.029', nomeCompleto: 'PrÃ¡ticas DiscriminatÃ³rias', numero: 'Lei 9.029/1995' }
};

const getLeiFromId = (id: string) => {
  const prefix = id?.split('-art-')[0] || id?.split('-')[0];
  return LEIS_METADATA[prefix] || { nome: prefix?.toUpperCase() || '?', nomeCompleto: prefix, numero: '' };
};

const openLegisDB = (): Promise<IDBDatabase> => new Promise((resolve, reject) => {
  const request = indexedDB.open(LEGIS_DB_NAME, 1);
  request.onerror = () => reject(request.error);
  request.onsuccess = () => resolve(request.result);
  request.onupgradeneeded = (event: IDBVersionChangeEvent) => {
    const db = (event.target as IDBOpenDBRequest).result;
    if (!db.objectStoreNames.contains(LEGIS_STORE_NAME)) {
      const store = db.createObjectStore(LEGIS_STORE_NAME, { keyPath: 'id' });
      store.createIndex('byLei', 'lei', { unique: false });
      store.createIndex('byNumero', 'numero', { unique: false });
    }
  };
});

const saveArtigosToIndexedDB = async (artigos: Artigo[]): Promise<void> => {
  try {
    const db = await openLegisDB();
    const tx = db.transaction([LEGIS_STORE_NAME], 'readwrite');
    const store = tx.objectStore(LEGIS_STORE_NAME);
    for (const artigo of artigos) {
      const lei = artigo.id?.split('-art-')[0] || artigo.id?.split('-')[0];
      store.put({ ...artigo, lei });
    }
    await new Promise<void>((resolve, reject) => {
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
    db.close();
  } catch (err) { console.error('Erro ao salvar artigos:', err); }
};

const loadArtigosFromIndexedDB = async (): Promise<Artigo[]> => {
  try {
    const db = await openLegisDB();
    const tx = db.transaction([LEGIS_STORE_NAME], 'readonly');
    const store = tx.objectStore(LEGIS_STORE_NAME);
    const result = await new Promise<Artigo[]>((resolve, reject) => {
      const req = store.getAll() as IDBRequest<Artigo[]>;
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
    db.close();
    return result;
  } catch { return []; }
};

const clearArtigosFromIndexedDB = async (): Promise<void> => {
  try {
    const db = await openLegisDB();
    const tx = db.transaction([LEGIS_STORE_NAME], 'readwrite');
    const store = tx.objectStore(LEGIS_STORE_NAME);
    await new Promise<void>((resolve, reject) => {
      const req = store.clear();
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
    db.close();
  } catch { /* silenciado */ }
};

// useFieldVersioning extraÃ­do para src/hooks/useFieldVersioning.ts (v1.36.68)

const sortArtigosNatural = (artigos: Artigo[]) => {
  return [...artigos].sort((a, b) => {
    const parseId = (id: string) => {
      const match = id.match(/^(.+)-art-(\d+)(?:-([a-z]))?$/i);
      if (!match) return { lei: id, num: 0, suffix: '' };
      return { lei: match[1], num: parseInt(match[2]), suffix: match[3] || '' };
    };
    const pa = parseId(a.id);
    const pb = parseId(b.id);
    if (pa.lei !== pb.lei) return pa.lei.localeCompare(pb.lei);
    if (pa.num !== pb.num) return pa.num - pb.num;
    return pa.suffix.localeCompare(pb.suffix);
  });
};

// ğŸ£ CUSTOM HOOK: useLocalStorage (persistÃªncia e localStorage)
const useLocalStorage = () => {
  // Estados de PersistÃªncia
  const [sessionLastSaved, setSessionLastSaved] = React.useState<string | null>(null);
  const [showAutoSaveIndicator, setShowAutoSaveIndicator] = React.useState(false);

  // ğŸš€ OTIMIZAÃ‡ÃƒO v1.4.1: Cache de conversÃµes PDFâ†’base64
  // Evita re-converter mesmos PDFs (key: fileName-size-lastModified)
  // v1.20.2: Adicionado limite LRU para evitar memory leak
  const PDF_CACHE_MAX_SIZE = 5; // MÃ¡ximo 5 PDFs em cache (~50MB worst case)
  const pdfCacheRef = React.useRef<Map<string, string>>(new Map());
  const pdfCacheOrderRef = React.useRef<string[]>([]); // Track insertion order para LRU

  // Adiciona ao cache com eviction LRU
  const addToPdfCache = (key: string, value: string) => {
    if (pdfCacheRef.current.has(key)) {
      pdfCacheRef.current.set(key, value);
      return;
    }
    while (pdfCacheRef.current.size >= PDF_CACHE_MAX_SIZE) {
      const oldestKey = pdfCacheOrderRef.current.shift();
      if (oldestKey) pdfCacheRef.current.delete(oldestKey);
    }
    pdfCacheRef.current.set(key, value);
    pdfCacheOrderRef.current.push(key);
  };

  // Limpa cache completamente (usado no reset de sessÃ£o)
  const clearPdfCache = () => {
    pdfCacheRef.current.clear();
    pdfCacheOrderRef.current = [];
  };

  // FunÃ§Ãµes Auxiliares

  // Converte File para base64 (com cache LRU)
  const fileToBase64 = React.useCallback((file: File): Promise<string> => {
    // Criar chave Ãºnica baseada em propriedades do arquivo
    const cacheKey = `${file.name}-${file.size}-${file.lastModified}`;

    // Verificar cache primeiro
    if (pdfCacheRef.current.has(cacheKey)) {
      return Promise.resolve(pdfCacheRef.current.get(cacheKey)!);
    }

    // Se nÃ£o estÃ¡ no cache, converter e cachear
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const result = reader.result;
        if (!result || typeof result !== 'string') {
          return reject(new Error('Falha ao ler arquivo: resultado vazio'));
        }
        const parts = result.split(',');
        const base64 = parts[1] || '';
        if (!base64) {
          return reject(new Error('Falha ao converter arquivo para base64'));
        }
        addToPdfCache(cacheKey, base64);
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }, []);

  // Converte base64 para File
  const base64ToFile = React.useCallback((base64: string, fileName: string, mimeType = 'application/pdf') => {
    const byteCharacters = atob(base64);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
      byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], { type: mimeType });
    const file = new File([blob], fileName, { type: mimeType });
    return file;
  }, []);

  // Verifica se existe sessÃ£o salva
  const checkSavedSession = React.useCallback((openModal: (modalName: ModalKey) => void) => {
    try {
      const saved = localStorage.getItem('sentencifySession');
      if (saved) {
        const session = JSON.parse(saved);
        setSessionLastSaved(session.savedAt);
        openModal('restoreSession');
      }
    } catch (err) {
    }
  }, []);

  const autoSaveSession = React.useCallback(async (allStates: SessionState, setError: (err: string | null) => void, immediate = false) => {
    try {
      const {
        processoNumero,
        pastedPeticaoTexts,
        pastedContestacaoTexts,
        pastedComplementaryTexts,
        extractedTopics,
        selectedTopics,
        partesProcesso,
        activeTab,
        analyzedDocuments,
        proofFiles,
        proofTexts,
        proofUsePdfMode,
        extractedProofTexts,
        proofExtractionFailed,
        proofTopicLinks,
        proofAnalysisResults,
        proofConclusions,
        extractedTexts,
        documentProcessingModes,
        peticaoFiles,
        contestacaoFiles,
        complementaryFiles,
        tokenMetrics // v1.20.3: Contador de tokens persistente
      } = allStates;

      const proofFilesSerializable = proofFiles.map((proof: Proof) => ({
        id: proof.id,
        name: proof.name,
        type: proof.type,
        size: proof.size,
        uploadDate: proof.uploadDate
        // Sem fileData - PDFs estÃ£o no IndexedDB
      }));

      const session = {
        version: APP_VERSION,
        savedAt: new Date().toISOString(),
        processoNumero,
        pastedPeticaoTexts,
        pastedContestacaoTexts,
        pastedComplementaryTexts,
        extractedTopics,
        selectedTopics,
        partesProcesso,
        activeTab,
        // v1.20.1: NÃƒO persistir base64 de PDFs (economia de memÃ³ria ~200-500MB)
        // Base64 Ã© regenerado quando necessÃ¡rio via fileToBase64()
        analyzedDocuments: {
          peticoes: [], // NÃƒO salvar base64 (pode ser 50MB+ por PDF)
          peticoesText: analyzedDocuments?.peticoesText || [],
          contestacoes: [], // NÃƒO salvar base64
          contestacoesText: analyzedDocuments?.contestacoesText || [],
          complementares: [], // NÃƒO salvar base64
          complementaresText: analyzedDocuments?.complementaresText || [],
        },
        extractedTexts: extractedTexts || { peticoes: [], contestacoes: [], complementares: [] },
        documentProcessingModes: documentProcessingModes || { peticoes: [], contestacoes: [], complementares: [] },
        // IDs dos arquivos para restauraÃ§Ã£o do IndexedDB
        peticaoFileIds: (peticaoFiles || []).map((f: { id?: string }) => f.id).filter(Boolean),
        contestacaoFileIds: (contestacaoFiles || []).map((f: { id?: string }) => f.id).filter(Boolean),
        complementaryFileIds: (complementaryFiles || []).map((f: { id?: string }) => f.id).filter(Boolean),
        // Dados de provas (apenas metadados, PDFs no IndexedDB)
        proofFiles: proofFilesSerializable,
        proofTexts: proofTexts,
        proofUsePdfMode: proofUsePdfMode,
        extractedProofTexts: extractedProofTexts,
        proofExtractionFailed: proofExtractionFailed,
        proofTopicLinks: proofTopicLinks,
        proofAnalysisResults: proofAnalysisResults,
        proofConclusions: proofConclusions,
        proofSendFullContent: allStates.proofSendFullContent || {},
        // v1.20.3: Contador de tokens persistente
        tokenMetrics: tokenMetrics || { totalInput: 0, totalOutput: 0, totalCacheRead: 0, totalCacheCreation: 0, requestCount: 0, lastUpdated: null }
      };

      if (immediate) {
        try {
          const serialized = JSON.stringify(session);
          localStorage.setItem('sentencifySession', serialized);
          setSessionLastSaved(session.savedAt);
          setShowAutoSaveIndicator(true);
          setTimeout(() => setShowAutoSaveIndicator(false), 3000);
        } catch (storageErr) {
          if ((storageErr as Error).name === 'QuotaExceededError') {
            setError('âŒ LocalStorage cheio. Considere limpar dados antigos.');
            setTimeout(() => setError(''), 8000);
          }
        }
      } else {
        // ğŸš€ OTIMIZAÃ‡ÃƒO v1.4.1: Save assÃ­ncrono nÃ£o-bloqueante usando requestIdleCallback
        const saveAsync = () => {
          const scheduleTask = window.requestIdleCallback || ((cb) => setTimeout(cb, 0));
          scheduleTask(() => {
            try {
              const serialized = JSON.stringify(session);
              localStorage.setItem('sentencifySession', serialized);
              setSessionLastSaved(session.savedAt);
              setShowAutoSaveIndicator(true);
              setTimeout(() => setShowAutoSaveIndicator(false), 3000);
            } catch (storageErr) {
              if ((storageErr as Error).name === 'QuotaExceededError') {
                setError('âŒ LocalStorage cheio. Considere limpar dados antigos.');
                setTimeout(() => setError(''), 8000);
              }
            }
          });
        };
        saveAsync();
      }
    } catch (err) {
    }
  }, [setShowAutoSaveIndicator, setSessionLastSaved]);

  // Restaura sessÃ£o (PDFs do IndexedDB, metadados do localStorage)
  const restoreSession = React.useCallback(async (callbacks: RestoreSessionCallbacks) => {
    try {
      const saved = localStorage.getItem('sentencifySession');
      if (!saved) return;

      const session = JSON.parse(saved);

      const {
        setPastedPeticaoTexts,
        setPastedContestacaoTexts,
        setPastedComplementaryTexts,
        setExtractedTopics,
        setSelectedTopics,
        setPartesProcesso,
        setAnalyzedDocuments,
        setProofFiles,
        setProofTexts,
        setProofUsePdfMode,
        setExtractedProofTexts,
        setProofExtractionFailed,
        setProofTopicLinks,
        setProofAnalysisResults,
        setProofConclusions,
        setProofSendFullContent,
        setActiveTab,
        closeModal,
        setError,
        setProcessoNumero,
        setPeticaoFiles,
        setContestacaoFiles,
        setComplementaryFiles,
        setExtractedTexts,
        setDocumentProcessingModes,
        setTokenMetrics // v1.20.3: Contador de tokens persistente
      } = callbacks;

      // ğŸ†• v1.21: MigraÃ§Ã£o de sessÃµes antigas (peticao singular â†’ peticoes array)
      if (session.pastedPeticaoText && !session.pastedPeticaoTexts) {
        session.pastedPeticaoTexts = [{ text: session.pastedPeticaoText, name: 'PetiÃ§Ã£o Inicial' }];
      }
      if (session.analyzedDocuments?.peticao && !session.analyzedDocuments?.peticoes) {
        session.analyzedDocuments.peticoes = session.analyzedDocuments.peticaoType === 'pdf'
          ? [session.analyzedDocuments.peticao] : [];
        session.analyzedDocuments.peticoesText = session.analyzedDocuments.peticaoType === 'text'
          ? [{ text: session.analyzedDocuments.peticao, name: 'PetiÃ§Ã£o Inicial' }] : [];
      }

      setProcessoNumero(session.processoNumero || '');
      setPastedPeticaoTexts(session.pastedPeticaoTexts || []);
      setPastedContestacaoTexts(session.pastedContestacaoTexts || []);
      setPastedComplementaryTexts(session.pastedComplementaryTexts || []);
      setExtractedTopics(session.extractedTopics || []);
      setSelectedTopics(session.selectedTopics || []);
      setPartesProcesso(session.partesProcesso || { reclamante: '', reclamadas: [] });
      setAnalyzedDocuments(session.analyzedDocuments || {
        peticoes: [],
        peticoesText: [],
        contestacoes: [],
        contestacoesText: [],
        complementares: [],
        complementaresText: []
      });

      if (setExtractedTexts) {
        setExtractedTexts(session.extractedTexts || { peticoes: [], contestacoes: [], complementares: [] });
      }

      if (setDocumentProcessingModes) {
        // Migrar modos legados (ex: 'gemini-vision') para 'pdfjs'
        const validModes = ['pdfjs', 'tesseract', 'pdf-puro', 'claude-vision'];
        const migrateMode = (mode: ProcessingMode) => validModes.includes(mode) ? mode : 'pdfjs';
        const migrateModes = (modes: ProcessingMode[]) => (modes || []).map(migrateMode);
        const rawModes = session.documentProcessingModes || { peticoes: [], contestacoes: [], complementares: [] };
        setDocumentProcessingModes({
          peticoes: migrateModes(rawModes.peticoes),
          contestacoes: migrateModes(rawModes.contestacoes),
          complementares: migrateModes(rawModes.complementares)
        });
      }

      // Restaurar PDFs usando UUIDs (novo formato) ou migrar do formato antigo (Ã­ndices)
      if (setPeticaoFiles) {
        const peticaoPdfs = [];
        if (session.peticaoFileIds?.length > 0) {
          // Novo formato: usar UUIDs salvos
          for (const id of session.peticaoFileIds) {
            const pPdf = await getPdfFromIndexedDB(`upload-peticao-${id}`);
            if (pPdf) peticaoPdfs.push({ file: pPdf, id });
          }
        } else {
          // MigraÃ§Ã£o: formato antigo com Ã­ndices â†’ novo com UUIDs
          const oldPdf = await getPdfFromIndexedDB('upload-peticao');
          if (oldPdf) {
            const newId = crypto.randomUUID();
            peticaoPdfs.push({ file: oldPdf, id: newId });
            await savePdfToIndexedDB(`upload-peticao-${newId}`, oldPdf, 'upload');
            await removePdfFromIndexedDB('upload-peticao');
          }
          for (let i = 0; i < 20; i++) {
            const pPdf = await getPdfFromIndexedDB(`upload-peticao-${i}`);
            if (pPdf) {
              const newId = crypto.randomUUID();
              peticaoPdfs.push({ file: pPdf, id: newId });
              await savePdfToIndexedDB(`upload-peticao-${newId}`, pPdf, 'upload');
              await removePdfFromIndexedDB(`upload-peticao-${i}`);
            } else if (i > 0) break;
          }
        }
        if (peticaoPdfs.length > 0) setPeticaoFiles(peticaoPdfs);
      }
      if (setContestacaoFiles) {
        const contestFiles = [];
        if (session.contestacaoFileIds?.length > 0) {
          for (const id of session.contestacaoFileIds) {
            const cPdf = await getPdfFromIndexedDB(`upload-contestacao-${id}`);
            if (cPdf) contestFiles.push({ file: cPdf, id });
          }
        } else {
          for (let i = 0; i < 20; i++) {
            const cPdf = await getPdfFromIndexedDB(`upload-contestacao-${i}`);
            if (cPdf) {
              const newId = crypto.randomUUID();
              contestFiles.push({ file: cPdf, id: newId });
              await savePdfToIndexedDB(`upload-contestacao-${newId}`, cPdf, 'upload');
              await removePdfFromIndexedDB(`upload-contestacao-${i}`);
            } else break;
          }
        }
        if (contestFiles.length > 0) setContestacaoFiles(contestFiles);
      }
      if (setComplementaryFiles) {
        const compFiles = [];
        if (session.complementaryFileIds?.length > 0) {
          for (const id of session.complementaryFileIds) {
            const cpPdf = await getPdfFromIndexedDB(`upload-complementar-${id}`);
            if (cpPdf) compFiles.push({ file: cpPdf, id });
          }
        } else {
          for (let i = 0; i < 20; i++) {
            const cpPdf = await getPdfFromIndexedDB(`upload-complementar-${i}`);
            if (cpPdf) {
              const newId = crypto.randomUUID();
              compFiles.push({ file: cpPdf, id: newId });
              await savePdfToIndexedDB(`upload-complementar-${newId}`, cpPdf, 'upload');
              await removePdfFromIndexedDB(`upload-complementar-${i}`);
            } else break;
          }
        }
        if (compFiles.length > 0) setComplementaryFiles(compFiles);
      }

      if (session.proofFiles && Array.isArray(session.proofFiles)) {
        const results = await Promise.allSettled(
          session.proofFiles.map(async (proof: Proof) => {
            const pdfFile = await getPdfFromIndexedDB(`proof-${proof.id}`);
            return {
              id: proof.id,
              file: pdfFile,
              name: proof.name,
              type: proof.type,
              size: proof.size,
              uploadDate: proof.uploadDate
            };
          })
        );
        const restoredProofFiles = results
          .filter(r => r.status === 'fulfilled')
          .map(r => r.value);
        setProofFiles(restoredProofFiles);
      } else {
        setProofFiles([]);
      }

      setProofTexts(session.proofTexts || []);
      setProofUsePdfMode(session.proofUsePdfMode || {});
      setExtractedProofTexts(session.extractedProofTexts || {});
      setProofExtractionFailed(session.proofExtractionFailed || {});
      setProofTopicLinks(session.proofTopicLinks || {});
      setProofAnalysisResults(session.proofAnalysisResults || {});
      setProofConclusions(session.proofConclusions || {});
      setProofSendFullContent(session.proofSendFullContent || {});  // ğŸ†• v1.19.2

      // Ir para a aba upload se houver documentos, senÃ£o manter a aba salva
      const hasDocuments = (session.analyzedDocuments?.peticoes?.length > 0) ||
                          (session.analyzedDocuments?.peticoesText?.length > 0) ||
                          (session.pastedPeticaoTexts?.length > 0) ||
                          (session.analyzedDocuments?.contestacoes?.length > 0) ||
                          (session.pastedContestacaoTexts?.length > 0);

      setActiveTab(hasDocuments ? 'upload' : (session.activeTab || 'topics'));

      // v1.20.3: Restaurar contador de tokens
      if (setTokenMetrics && session.tokenMetrics) {
        setTokenMetrics(session.tokenMetrics);
      }

      closeModal('restoreSession');

      // SessÃ£o restaurada silenciosamente
    } catch (err) {
      console.error('[useLocalStorage] Erro ao restaurar sessÃ£o:', (err as Error).message);
    }
  }, [setSessionLastSaved]);

  // v1.35.40: ConstrÃ³i JSON do projeto para salvar no Google Drive (sem download)
  // v1.35.41: Movido para antes de exportProject (usado por ambos)
  const buildProjectJson = React.useCallback(async (allStates: ProjectState) => {
    const {
      processoNumero,
      pastedPeticaoTexts,
      pastedContestacaoTexts,
      pastedComplementaryTexts,
      extractedTopics,
      selectedTopics,
      partesProcesso,
      aiSettings,
      analyzedDocuments,
      proofFiles,
      proofTexts,
      proofUsePdfMode,
      extractedProofTexts,
      proofExtractionFailed,
      proofTopicLinks,
      proofAnalysisResults,
      proofConclusions,
      peticaoFiles,
      contestacaoFiles,
      complementaryFiles,
      extractedTexts,
      documentProcessingModes,
      tokenMetrics
    } = allStates;

    const uploadPdfs: {
      peticoes: Array<{ name: string; id: string; fileData: string }>;
      contestacoes: Array<{ name: string; id: string; fileData: string }>;
      complementares: Array<{ name: string; id: string; fileData: string }>;
    } = {
      peticoes: [],
      contestacoes: [],
      complementares: []
    };

    if (peticaoFiles && peticaoFiles.length > 0) {
      uploadPdfs.peticoes = await Promise.all(
        peticaoFiles.map(async (f: UploadedFile) => {
          const fileObj = f.file;
          return { name: fileObj.name, id: f.id, fileData: await fileToBase64(fileObj) };
        })
      );
    }

    if (contestacaoFiles && contestacaoFiles.length > 0) {
      uploadPdfs.contestacoes = await Promise.all(
        contestacaoFiles.map(async (f: UploadedFile) => {
          const fileObj = f.file;
          return { name: fileObj.name, id: f.id, fileData: await fileToBase64(fileObj) };
        })
      );
    }

    if (complementaryFiles && complementaryFiles.length > 0) {
      uploadPdfs.complementares = await Promise.all(
        complementaryFiles.map(async (f: UploadedFile) => {
          const fileObj = f.file;
          return { name: fileObj.name, id: f.id, fileData: await fileToBase64(fileObj) };
        })
      );
    }

    const proofFilesSerializable = await Promise.all(
      (proofFiles || []).map(async (proof: Proof) => {
        if (!proof.file) {
          return {
            id: proof.id,
            name: proof.name,
            type: proof.type,
            size: proof.size,
            uploadDate: proof.uploadDate,
            fileData: null
          };
        }
        const base64 = await fileToBase64(proof.file);
        return {
          id: proof.id,
          name: proof.name,
          type: proof.type,
          size: proof.size,
          uploadDate: proof.uploadDate,
          fileData: base64
        };
      })
    );

    // v1.35.74: NÃ£o exportar apiKeys por seguranÃ§a
    // eslint-disable-next-line no-unused-vars
    const { apiKeys: _excluded, ...aiSettingsWithoutKeys } = aiSettings;

    // v1.36.12: Exportar cache de confronto de fatos
    let factsComparison: Record<string, FactsComparisonResult> = {};
    try {
      const db = await openFactsDB();
      const store = db.transaction(FACTS_STORE_NAME).objectStore(FACTS_STORE_NAME);
      const entries = await new Promise<Array<{ topicTitle: string; source: string; result: FactsComparisonResult }>>((resolve) => {
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => resolve([]);
      });
      db.close();
      for (const entry of entries) {
        factsComparison[`${entry.topicTitle}_${entry.source}`] = entry.result;
      }
    } catch (e) {
      console.warn('[Export] Erro ao exportar factsComparison:', e);
    }

    // v1.36.57: Exportar cache de revisÃ£o de sentenÃ§a
    let sentenceReviewCacheExport: Record<string, string> = {};
    try {
      const db = await openReviewDB();
      const store = db.transaction(REVIEW_STORE_NAME).objectStore(REVIEW_STORE_NAME);
      const entries = await new Promise<Array<{ scope: string; result: string }>>((resolve) => {
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => resolve([]);
      });
      db.close();
      for (const entry of entries) {
        sentenceReviewCacheExport[entry.scope] = entry.result;
      }
    } catch (e) {
      console.warn('[Export] Erro ao exportar sentenceReviewCache:', e);
    }

    return {
      version: APP_VERSION,
      exportedAt: new Date().toISOString(),
      processoNumero,
      pastedPeticaoTexts,
      pastedContestacaoTexts,
      pastedComplementaryTexts,
      extractedTopics,
      selectedTopics,
      partesProcesso,
      aiSettings: aiSettingsWithoutKeys,
      analyzedDocuments,
      extractedTexts: extractedTexts || { peticoes: [], contestacoes: [], complementares: [] },
      uploadPdfs,
      proofFiles: proofFilesSerializable,
      proofTexts: proofTexts || {},
      proofUsePdfMode: proofUsePdfMode || {},
      extractedProofTexts: extractedProofTexts || {},
      proofExtractionFailed: proofExtractionFailed || {},
      proofTopicLinks: proofTopicLinks || {},
      proofAnalysisResults: proofAnalysisResults || {},
      proofConclusions: proofConclusions || {},
      proofSendFullContent: allStates.proofSendFullContent || {},
      documentProcessingModes: documentProcessingModes || { peticao: 'pdfjs', contestacoes: [], complementares: [] },
      tokenMetrics: tokenMetrics || { totalInput: 0, totalOutput: 0, totalCacheRead: 0, totalCacheCreation: 0, requestCount: 0, lastUpdated: null },
      factsComparison,  // v1.36.12
      sentenceReviewCache: sentenceReviewCacheExport  // v1.36.57
    };
  }, [fileToBase64]);

  // Exporta projeto completo em JSON (PDFs em base64)
  // v1.35.41: Refatorado para usar buildProjectJson (elimina duplicaÃ§Ã£o)
  const exportProject = React.useCallback(async (allStates: ProjectState, setError: (err: string | null) => void) => {
    try {
      const project = await buildProjectJson(allStates);
      const dataStr = JSON.stringify(project, null, 2);

      // Copiar para clipboard
      await navigator.clipboard.writeText(dataStr);

      // Download do arquivo
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;

      // Gerar nome do arquivo baseado no nÃºmero do processo (se disponÃ­vel)
      const processoPart = project.processoNumero
        ? project.processoNumero.replace(/\s+/g, '-').replace(/\//g, '-')
        : '';
      const datePart = new Date().toISOString().split('T')[0];
      a.download = processoPart
        ? `sentencify-${processoPart}-${datePart}.json`
        : `sentencify-projeto-${datePart}.json`;

      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (err) {
      setError('Erro ao exportar projeto: ' + (err as Error).message);
    }
  }, [buildProjectJson]);

  // v1.35.40: Importa projeto a partir de JSON (para Google Drive)
  // v1.35.41: Adicionadas migraÃ§Ãµes de projetos antigos (formato singular)
  const importProjectFromJson = React.useCallback(async (project: ImportedProject, callbacks: ImportCallbacks, autoSaveSessionFn: (states: SessionState, setError: (err: string | null) => void, immediate: boolean) => Promise<void>) => {
    if (!project || !project.version) {
      throw new Error('Arquivo invÃ¡lido ou incompatÃ­vel.');
    }

    const {
      setPastedPeticaoTexts,
      setPastedContestacaoTexts,
      setPastedComplementaryTexts,
      setExtractedTopics,
      setSelectedTopics,
      setPartesProcesso,
      setAnalyzedDocuments,
      setProofFiles,
      setProofTexts,
      setProofUsePdfMode,
      setExtractedProofTexts,
      setProofExtractionFailed,
      setProofTopicLinks,
      setProofAnalysisResults,
      setProofConclusions,
      setProofSendFullContent,
      setAiSettings,
      setActiveTab,
      setError,
      setProcessoNumero,
      setPeticaoFiles,
      setContestacaoFiles,
      setComplementaryFiles,
      setExtractedTexts,
      setDocumentProcessingModes,
      setTokenMetrics
    } = callbacks;

    try {
      await clearAllPdfsFromIndexedDB();
    } catch (err) {
      // Ignore
    }

    // MigraÃ§Ã£o de projetos antigos (formato singular â†’ plural)
    if (project.pastedPeticaoText && !project.pastedPeticaoTexts) {
      project.pastedPeticaoTexts = [{ id: crypto.randomUUID(), text: project.pastedPeticaoText, name: 'PetiÃ§Ã£o Inicial' }];
    }
    if (project.analyzedDocuments?.peticao && !project.analyzedDocuments?.peticoes) {
      project.analyzedDocuments.peticoes = project.analyzedDocuments.peticaoType === 'pdf'
        ? [project.analyzedDocuments.peticao as string] : [];
      project.analyzedDocuments.peticoesText = project.analyzedDocuments.peticaoType === 'text'
        ? [{ id: crypto.randomUUID(), text: project.analyzedDocuments.peticao as string, name: 'PetiÃ§Ã£o Inicial' }] : [];
    }

    // Restaurar dados
    setProcessoNumero(project.processoNumero || '');
    setPastedPeticaoTexts(project.pastedPeticaoTexts || []);
    setPastedContestacaoTexts(project.pastedContestacaoTexts || []);
    setPastedComplementaryTexts(project.pastedComplementaryTexts || []);
    setExtractedTopics(project.extractedTopics || []);
    setSelectedTopics(project.selectedTopics || []);
    setPartesProcesso(project.partesProcesso || { reclamante: '', reclamadas: [] });
    setAnalyzedDocuments(project.analyzedDocuments || {
      peticoes: [], peticoesText: [], contestacoes: [], contestacoesText: [],
      complementares: [], complementaresText: []
    });

    if (setExtractedTexts) {
      setExtractedTexts(project.extractedTexts || { peticoes: [], contestacoes: [], complementares: [] });
    }

    if (setDocumentProcessingModes) {
      const validModes = ['pdfjs', 'tesseract', 'pdf-puro', 'claude-vision'];
      const migrateMode = (mode: ProcessingMode) => validModes.includes(mode) ? mode : 'pdfjs';
      const migrateModes = (modes: ProcessingMode[]) => (modes || []).map(migrateMode);
      const rawModes = project.documentProcessingModes || { peticoes: [], contestacoes: [], complementares: [] };
      setDocumentProcessingModes({
        peticoes: migrateModes(rawModes.peticoes),
        contestacoes: migrateModes(rawModes.contestacoes),
        complementares: migrateModes(rawModes.complementares)
      });
    }

    // Restaurar PDFs
    if (project.uploadPdfs) {
      // PetiÃ§Ãµes (novo formato com UUID)
      if (project.uploadPdfs.peticoes && setPeticaoFiles) {
        const petFiles = [];
        for (const pData of project.uploadPdfs.peticoes) {
          const pFile = base64ToFile(pData.fileData, pData.name, 'application/pdf');
          const id = pData.id || crypto.randomUUID();
          petFiles.push({ file: pFile, id });
          await savePdfToIndexedDB(`upload-peticao-${id}`, pFile, 'upload');
        }
        setPeticaoFiles(petFiles);
      }
      // PetiÃ§Ã£o (formato antigo singular - migraÃ§Ã£o)
      else if (project.uploadPdfs.peticao && setPeticaoFiles) {
        const pData = project.uploadPdfs.peticao;
        const pFile = base64ToFile(pData.fileData, pData.name, 'application/pdf');
        const id = crypto.randomUUID();
        setPeticaoFiles([{ file: pFile, id }]);
        await savePdfToIndexedDB(`upload-peticao-${id}`, pFile, 'upload');
      }
      if (project.uploadPdfs.contestacoes && setContestacaoFiles) {
        const contestFiles = [];
        for (const cData of project.uploadPdfs.contestacoes) {
          const cFile = base64ToFile(cData.fileData, cData.name, 'application/pdf');
          const id = cData.id || crypto.randomUUID();
          contestFiles.push({ file: cFile, id });
          await savePdfToIndexedDB(`upload-contestacao-${id}`, cFile, 'upload');
        }
        setContestacaoFiles(contestFiles);
      }
      if (project.uploadPdfs.complementares && setComplementaryFiles) {
        const compFiles = [];
        for (const cpData of project.uploadPdfs.complementares) {
          const cpFile = base64ToFile(cpData.fileData, cpData.name, 'application/pdf');
          const id = cpData.id || crypto.randomUUID();
          compFiles.push({ file: cpFile, id });
          await savePdfToIndexedDB(`upload-complementar-${id}`, cpFile, 'upload');
        }
        setComplementaryFiles(compFiles);
      }
    }

    // Restaurar provas
    let restoredProofFiles: Proof[] = [];
    if (project.proofFiles && Array.isArray(project.proofFiles)) {
      restoredProofFiles = await Promise.all(
        project.proofFiles.map(async (proof: Proof): Promise<Proof> => {
          if (proof.type === 'text') {
            // ProofText - return as-is
            return proof;
          }
          if (!proof.fileData) {
            // ProofFile without data - mark as placeholder
            return { id: proof.id, name: proof.name, type: 'pdf' as const, size: proof.size, uploadDate: proof.uploadDate, isPlaceholder: true };
          }
          const byteCharacters = atob(proof.fileData);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: 'application/pdf' });
          const restoredFile = new File([blob], proof.name, { type: 'application/pdf' });
          await savePdfToIndexedDB(`proof-${proof.id}`, restoredFile, 'proof');
          return { id: proof.id, file: restoredFile, name: proof.name, type: 'pdf' as const, size: proof.size, uploadDate: proof.uploadDate };
        })
      );
      // Filtrar apenas PDFs para setProofFiles (textos vÃ£o em setProofTexts)
      setProofFiles(restoredProofFiles.filter((p): p is ProofFile => p.type === 'pdf'));
    } else {
      setProofFiles([]);
    }

    setProofTexts((project.proofTexts as unknown as ProofText[]) || []);
    setProofUsePdfMode(project.proofUsePdfMode || {});
    setExtractedProofTexts(project.extractedProofTexts || {});
    setProofExtractionFailed(project.proofExtractionFailed || {});
    setProofTopicLinks(project.proofTopicLinks || {});
    setProofAnalysisResults((project.proofAnalysisResults as unknown as Record<string, ProofAnalysisResult>) || {});
    setProofConclusions(project.proofConclusions || {});
    setProofSendFullContent(project.proofSendFullContent || {});

    if (setTokenMetrics && project.tokenMetrics) {
      setTokenMetrics(project.tokenMetrics);
    }

    // v1.35.74: Migrar projetos antigos + preservar apiKeys do localStorage
    if (project.aiSettings) {
      // Defaults para campos novos de IA Local
      const iaLocalDefaults = {
        semanticSearchEnabled: false,
        semanticThreshold: 50,
        jurisSemanticEnabled: false,
        jurisSemanticThreshold: 50,
        modelSemanticEnabled: false,
        modelSemanticThreshold: 40,
        useLocalAIForSuggestions: false,
        useLocalAIForJuris: false
      };

      // Obter apiKeys ATUAIS do localStorage (nunca sobrescrever!)
      let currentApiKeys = { claude: '', gemini: '', openai: '', grok: '' };
      try {
        const saved = localStorage.getItem('sentencify-ai-settings');
        if (saved) {
          const parsed = JSON.parse(saved);
          currentApiKeys = { ...currentApiKeys, ...parsed.apiKeys };
        }
      } catch (e) { /* ignore */ }

      // Merge: defaults â†’ projeto â†’ apiKeys atuais (nunca sobrescreve chaves)
      const mergedAiSettings = {
        ...iaLocalDefaults,
        ...project.aiSettings,
        apiKeys: currentApiKeys  // Sempre preserva as chaves do usuÃ¡rio
      };
      setAiSettings(mergedAiSettings);
    }

    setActiveTab('upload');

    if (autoSaveSessionFn) {
      const allStates: SessionState = {
        processoNumero: project.processoNumero || '',
        pastedPeticaoTexts: project.pastedPeticaoTexts || [],
        pastedContestacaoTexts: project.pastedContestacaoTexts || [],
        pastedComplementaryTexts: project.pastedComplementaryTexts || [],
        extractedTopics: project.extractedTopics || [],
        selectedTopics: project.selectedTopics || [],
        partesProcesso: project.partesProcesso || { reclamante: '', reclamadas: [] },
        activeTab: 'upload' as const,
        analyzedDocuments: project.analyzedDocuments || { peticoes: [], peticoesText: [], contestacoes: [], contestacoesText: [], complementares: [], complementaresText: [] },
        extractedTexts: project.extractedTexts || { peticoes: [], contestacoes: [], complementares: [] },
        proofFiles: restoredProofFiles || [],
        proofTexts: (project.proofTexts as unknown as ProofText[]) || [],
        proofUsePdfMode: project.proofUsePdfMode || {},
        extractedProofTexts: project.extractedProofTexts || {},
        proofExtractionFailed: project.proofExtractionFailed || {},
        proofTopicLinks: project.proofTopicLinks || {},
        proofAnalysisResults: (project.proofAnalysisResults as unknown as Record<string, { type: string; result: string }>) || {},
        proofConclusions: project.proofConclusions || {},
        proofSendFullContent: project.proofSendFullContent || {},
        documentProcessingModes: project.documentProcessingModes || { peticoes: ['pdfjs'], contestacoes: [], complementares: [] },
        tokenMetrics: project.tokenMetrics || { totalInput: 0, totalOutput: 0, totalCacheRead: 0, totalCacheCreation: 0, requestCount: 0, lastUpdated: null },
        peticaoFiles: [],
        contestacaoFiles: [],
        complementaryFiles: []
      };
      autoSaveSessionFn(allStates, (err) => err && setError(err), true);
    }

    // v1.36.12: Importar cache de confronto de fatos
    if (project.factsComparison && typeof project.factsComparison === 'object') {
      try {
        const db = await openFactsDB();
        const tx = db.transaction(FACTS_STORE_NAME, 'readwrite');
        const store = tx.objectStore(FACTS_STORE_NAME);

        for (const [key, result] of Object.entries(project.factsComparison as Record<string, FactsComparisonResult>)) {
          const lastUnderscore = key.lastIndexOf('_');
          if (lastUnderscore === -1) continue;

          const topicTitle = key.substring(0, lastUnderscore);
          const source = key.substring(lastUnderscore + 1) as FactsComparisonSource;

          if (topicTitle && (source === 'mini-relatorio' || source === 'documentos-completos')) {
            store.add({
              topicTitle,
              source,
              result,
              createdAt: Date.now()
            });
          }
        }

        await new Promise<void>((resolve) => {
          tx.oncomplete = () => resolve();
          tx.onerror = () => resolve();
        });
        db.close();
      } catch (e) {
        console.warn('[Import] Erro ao importar factsComparison:', e);
      }
    }

    // v1.36.57: Importar cache de revisÃ£o de sentenÃ§a
    if (project.sentenceReviewCache && typeof project.sentenceReviewCache === 'object') {
      try {
        const db = await openReviewDB();
        const tx = db.transaction(REVIEW_STORE_NAME, 'readwrite');
        const store = tx.objectStore(REVIEW_STORE_NAME);

        for (const [scope, result] of Object.entries(project.sentenceReviewCache)) {
          if (scope === 'decisionOnly' || scope === 'decisionWithDocs') {
            store.add({
              scope,
              result,
              createdAt: Date.now()
            });
          }
        }

        await new Promise<void>((resolve) => {
          tx.oncomplete = () => resolve();
          tx.onerror = () => resolve();
        });
        db.close();
      } catch (e) {
        console.warn('[Import] Erro ao importar sentenceReviewCache:', e);
      }
    }
  }, [base64ToFile, clearAllPdfsFromIndexedDB, savePdfToIndexedDB]);

  // Importa projeto de arquivo JSON
  // v1.35.41: Refatorado para usar importProjectFromJson (elimina duplicaÃ§Ã£o)
  const importProject = React.useCallback(async (event: React.ChangeEvent<HTMLInputElement>, callbacks: ImportCallbacks & ImportProjectCallbacks, autoSaveSessionFn: (states: SessionState, setError: (err: string | null) => void, immediate: boolean) => Promise<void>) => {
    const files = event.target.files;
    if (!files || !files[0]) return;
    const file = files[0];

    try {
      const text = await file.text();
      const project = JSON.parse(text);

      if (!project.version) {
        callbacks.setError('Arquivo invÃ¡lido ou incompatÃ­vel.');
        event.target.value = '';
        return;
      }

      await importProjectFromJson(project, callbacks, autoSaveSessionFn);

      // Limpar input para permitir reimportar o mesmo arquivo
      event.target.value = '';
    } catch (err) {
      callbacks.setError('Erro ao importar projeto: ' + (err as Error).message);
      event.target.value = '';
    }
  }, [importProjectFromJson]);

  // Limpa todos os dados do projeto
  const clearProject = React.useCallback((callbacks: ClearProjectCallbacks) => {
    try {
      const {
        closeModal,
        setPastedPeticaoTexts,
        setPastedContestacaoTexts,
        setPastedComplementaryTexts,
        setExtractedTopics,
        setSelectedTopics,
        setPartesProcesso,
        setAnalyzedDocuments,
        setPeticaoFiles,
        setContestacaoFiles,
        setComplementaryFiles,
        setActiveTab,
        setProofFiles,
        setProofTexts,
        setProofUsePdfMode,
        setExtractedProofTexts,
        setProofExtractionFailed,
        setProofTopicLinks,
        setProofAnalysisResults,
        setProofConclusions,
        setProofToDelete,
        setProofToLink,
        setProofToAnalyze,
        clearAnalyzingProofs,
        setShowProofPanel,
        setNewProofTextData,
        setError,
        setProcessoNumero,
        setTokenMetrics // v1.20.3: Contador de tokens persistente
      } = callbacks;

      // Resetar estados de sessÃ£o e modais
      setSessionLastSaved(null);
      closeModal('restoreSession');
      closeModal('clearProject');

      // Limpar estados de documentos
      setProcessoNumero('');
      setPastedPeticaoTexts([]);
      setPastedContestacaoTexts([]);
      setPastedComplementaryTexts([]);
      setExtractedTopics([]);
      setSelectedTopics([]);
      setPartesProcesso({ reclamante: '', reclamadas: [] });
      setAnalyzedDocuments({
        peticoes: [],
        peticoesText: [],
        contestacoes: [],
        contestacoesText: [],
        complementares: [],
        complementaresText: []
      });
      setPeticaoFiles?.([]);
      setContestacaoFiles?.([]);
      setComplementaryFiles?.([]);
      setActiveTab('upload');

      // Limpar estados do sistema de provas - Dados (v1.2.0)
      setProofFiles([]);
      setProofTexts([]);
      setProofUsePdfMode({});
      setExtractedProofTexts({});
      setProofExtractionFailed({});
      setProofTopicLinks({});
      setProofAnalysisResults({});
      setProofConclusions({});

      // Limpar estados do sistema de provas - UI/Modais (v1.2.0)
      setProofToDelete(null);
      setProofToLink(null);
      setProofToAnalyze(null);
      clearAnalyzingProofs();
      setShowProofPanel(true);
      closeModal('addProofText');
      setNewProofTextData({ name: '', text: '' });
      closeModal('deleteProof');
      closeModal('linkProof');
      closeModal('proofAnalysis');

      // Remover dados salvos do localStorage (deve ser feito apÃ³s resetar estados)
      localStorage.removeItem('sentencifySession');

      // v1.12.14: Limpar todos os PDFs do IndexedDB
      clearAllPdfsFromIndexedDB().catch(err => {
      });

      // v1.20.2: Limpar cache de PDFs em memÃ³ria para liberar RAM
      clearPdfCache();

      // v1.20.3: Resetar contador de tokens
      if (setTokenMetrics) {
        setTokenMetrics({
          totalInput: 0,
          totalOutput: 0,
          totalCacheRead: 0,
          totalCacheCreation: 0,
          requestCount: 0,
          lastUpdated: null
        });
      }

    } catch (err) {
      console.error('[useLocalStorage] Erro ao limpar sessÃ£o:', (err as Error).message);
    }
  }, [setSessionLastSaved]);

  // Return
  return {
    // Estados
    sessionLastSaved,
    showAutoSaveIndicator,

    // Setters
    setSessionLastSaved,
    setShowAutoSaveIndicator,

    // FunÃ§Ãµes Auxiliares
    fileToBase64,
    base64ToFile,
    clearPdfCache,

    // FunÃ§Ãµes de VerificaÃ§Ã£o
    checkSavedSession,

    // FunÃ§Ãµes de PersistÃªncia (ETAPA 4/5)
    autoSaveSession,
    restoreSession,
    exportProject,
    importProject,
    importProjectFromJson,  // v1.35.40: Para carregar do Google Drive
    clearProject,
    buildProjectJson  // v1.35.40: Para salvar no Google Drive
  };
};

// ğŸ£ CUSTOM HOOK: useModelLibrary (v1.2.5) - Biblioteca de modelos jurÃ­dicos
// =============================================================================
// useModelLibrary - Biblioteca de Modelos (v2.0 - LLM-friendly)
// SeÃ§Ãµes: 1.DADOS | 2.BUSCA | 3.FORMULÃRIO | 4.BULK | 5.PERSISTÃŠNCIA
// =============================================================================
const useModelLibrary = () => {

  // ===========================================================================
  // v1.36.63: Estado migrado para Zustand - ver src/stores/useModelsStore.ts
  // SeÃ§Ãµes 1, 2 e 3 agora usam o store global
  // ===========================================================================
  const {
    // SeÃ§Ã£o 1: Dados Core
    models, setModels,
    hasUnsavedChanges, setHasUnsavedChanges,
    isLoadingModels, setIsLoadingModels,
    persistenceError, setPersistenceError,
    // SeÃ§Ã£o 2: Busca e Filtros
    searchTerm, setSearchTerm,
    selectedCategory, setSelectedCategory,
    showFavoritesOnly, setShowFavoritesOnly,
    ownershipFilter, setOwnershipFilter,
    currentModelPage, setCurrentModelPage,
    manualSearchTerm, setManualSearchTerm,
    manualSearchResults, setManualSearchResults,
    suggestions, setSuggestions,
    suggestionsSource, setSuggestionsSource,
    loadingSuggestions, setLoadingSuggestions,
    modelViewMode, setModelViewMode,
    modelsPerPage,
    // SeÃ§Ã£o 3: FormulÃ¡rio
    newModel, setNewModel,
    editingModel, setEditingModel,
    extractingModelFromDecision, setExtractingModelFromDecision,
    showExtractModelButton, setShowExtractModelButton,
    extractedModelPreview, setExtractedModelPreview,
    exportedModelsText, setExportedModelsText,
    modelToDelete, setModelToDelete,
    similarityWarning, setSimilarityWarning,
    resetForm, startEditingModel
  } = useModelLibraryCompat();

  // --- Busca manual por termo (lÃ³gica encapsulada) ---
  const performManualSearch = React.useCallback((term: string) => {
    if (!term?.trim()) {
      setManualSearchResults([]);
      return;
    }
    const results = searchModelsInLibrary(models, term, { limit: 10, includeContent: true });
    setManualSearchResults(results);
  }, [models, setManualSearchResults]);

  // --- Busca com debounce 300ms ---
  const debouncedSearchTimeoutRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);
  const debouncedManualSearch = React.useCallback((term: string) => {
    if (debouncedSearchTimeoutRef.current) clearTimeout(debouncedSearchTimeoutRef.current);
    debouncedSearchTimeoutRef.current = setTimeout(() => performManualSearch(term), 300);
  }, [performManualSearch]);

  // ===========================================================================
  // SEÃ‡ÃƒO 4: PROCESSAMENTO EM LOTE (BULK)
  // ===========================================================================
  type BulkProcessedFile = { file: string; status: string; modelsCount?: number; models?: Model[]; error?: string; duration: string };
  type BulkError = { file: string; error?: string; status?: string; duration?: string };
  type BulkFile = { file: File; name: string; size: number; status?: 'pending' | 'processing' | 'done' | 'error'; error?: string };
  type BulkGeneratedModel = { id?: string; title: string; content: string; keywords?: string | string[]; category?: string; embedding?: number[]; sourceFile?: string; similarityInfo?: { similarity: number; similarModel: Model } };

  const [deleteAllConfirmText, setDeleteAllConfirmText] = React.useState<string>('');
  const [bulkFiles, setBulkFiles] = React.useState<BulkFile[]>([]);
  const [bulkProcessing, setBulkProcessing] = React.useState<boolean>(false);
  const [bulkCurrentFileIndex, setBulkCurrentFileIndex] = React.useState<number>(0);
  const [bulkProcessedFiles, setBulkProcessedFiles] = React.useState<BulkProcessedFile[]>([]);
  const [bulkGeneratedModels, setBulkGeneratedModels] = React.useState<BulkGeneratedModel[]>([]);
  const [bulkErrors, setBulkErrors] = React.useState<BulkError[]>([]);
  const [bulkReviewModels, setBulkReviewModels] = React.useState<BulkGeneratedModel[]>([]);
  const [bulkEditingModel, setBulkEditingModel] = React.useState<BulkGeneratedModel | null>(null);
  const [bulkCancelController, setBulkCancelController] = React.useState<AbortController | null>(null);
  const [bulkStaggerDelay, setBulkStaggerDelay] = React.useState<number>(0);
  const [bulkCurrentBatch, setBulkCurrentBatch] = React.useState<number>(0);

  // --- Cancelar processamento bulk ---
  const cancelBulkProcessing = React.useCallback(() => {
    if (bulkCancelController) {
      bulkCancelController.abort();
      setBulkCancelController(null);
    }
    setBulkProcessing(false);
    setBulkCurrentBatch(0);
  }, [bulkCancelController]);

  // --- Remover arquivo da fila ---
  const removeBulkFile = React.useCallback((index: number) => {
    setBulkFiles(prev => prev.filter((_, i: number) => i !== index));
  }, []);

  // --- Resetar estados bulk ---
  const resetBulkState = React.useCallback(() => {
    setBulkFiles([]);
    setBulkProcessedFiles([]);
    setBulkGeneratedModels([]);
    setBulkReviewModels([]);
    setBulkErrors([]);
    setBulkEditingModel(null);
  }, []);

  // --- Cleanup ao desmontar ---
  React.useEffect(() => {
    return () => {
      if (bulkCancelController) {
        bulkCancelController.abort();
        setBulkCancelController(null);
      }
    };
  }, [bulkCancelController]);

  // ===========================================================================
  // RETORNO - Interface PÃºblica
  // ===========================================================================
  return {
    // --- SeÃ§Ã£o 1: Dados Core ---
    models, setModels,
    hasUnsavedChanges, setHasUnsavedChanges,
    isLoadingModels, setIsLoadingModels,
    persistenceError, setPersistenceError,

    // --- SeÃ§Ã£o 2: Busca ---
    searchTerm, setSearchTerm,
    selectedCategory, setSelectedCategory,
    showFavoritesOnly, setShowFavoritesOnly,
    ownershipFilter, setOwnershipFilter, // v1.35.0
    currentModelPage, setCurrentModelPage,
    manualSearchTerm, setManualSearchTerm,
    manualSearchResults, setManualSearchResults,
    suggestions, setSuggestions,
    suggestionsSource, setSuggestionsSource,
    loadingSuggestions, setLoadingSuggestions,
    modelViewMode, setModelViewMode,
    modelsPerPage,
    performManualSearch, debouncedManualSearch,

    // --- SeÃ§Ã£o 3: FormulÃ¡rio ---
    newModel, setNewModel,
    editingModel, setEditingModel,
    extractingModelFromDecision, setExtractingModelFromDecision,
    showExtractModelButton, setShowExtractModelButton,
    extractedModelPreview, setExtractedModelPreview,
    exportedModelsText, setExportedModelsText,
    modelToDelete, setModelToDelete,
    similarityWarning, setSimilarityWarning,
    resetForm, startEditingModel,

    // --- SeÃ§Ã£o 4: Bulk ---
    deleteAllConfirmText, setDeleteAllConfirmText,
    bulkFiles, setBulkFiles,
    bulkProcessing, setBulkProcessing,
    bulkCurrentFileIndex, setBulkCurrentFileIndex,
    bulkProcessedFiles, setBulkProcessedFiles,
    bulkGeneratedModels, setBulkGeneratedModels,
    bulkErrors, setBulkErrors,
    bulkReviewModels, setBulkReviewModels,
    bulkEditingModel, setBulkEditingModel,
    bulkCancelController, setBulkCancelController,
    bulkStaggerDelay, setBulkStaggerDelay,
    bulkCurrentBatch, setBulkCurrentBatch,
    cancelBulkProcessing, removeBulkFile, resetBulkState
  };
};

// ğŸ” Busca Inteligente Unificada de Modelos - v1.15.0
const removeAccents = (str: string) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

// âš–ï¸ v1.20.0: Helpers de JurisprudÃªncia (reutilizÃ¡veis)
const STATUS_INVALIDOS = new Set(['cancelada', 'revogada', 'convertida', 'superado', 'convertida em sÃºmula']);
const isStatusValido = (status: string | null | undefined) => {
  if (!status) return true;
  return !STATUS_INVALIDOS.has(status.toLowerCase());
};
const IRR_TYPES = new Set(['IRR', 'RR', 'RRAG', 'INCJULGRREMBREP', 'INCJULGRREPETITIVO']);
const isIRRType = (tipo: string | null | undefined) => IRR_TYPES.has((tipo || '').toUpperCase().replace(/-/g, ''));

// Cache global para resultados de jurisprudÃªncia
const jurisCache = new Map();
const JURIS_CACHE_TTL = 5 * 60 * 1000; // 5 minutos
const hashJurisKey = (str: string) => {
  let hash = 0;
  for (let i = 0; i < (str || '').length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash = hash & hash;
  }
  return hash.toString(36);
};

const refineJurisWithAIHelper = async (title: string, context: string, candidates: Precedente[], callLLM: CallAIFunction) => {
  if (!callLLM || typeof callLLM !== 'function') {
    console.warn('[JurisAI] callLLM nÃ£o disponÃ­vel, retornando candidatos sem refinamento');
    return candidates.slice(0, 10);
  }
  try {
    // Formatar candidatos com mais informaÃ§Ã£o para a IA decidir melhor
    const candidatosFormatados = candidates.map((c: Precedente, i: number) => {
      const tipo = c.tipoProcesso || 'Precedente';
      const num = c.numero ? ` ${c.numero}` : '';
      const tribunal = c.tribunal ? ` (${c.tribunal})` : '';
      const titulo = c.titulo ? `\n   TÃ­tulo: ${c.titulo}` : '';
      const tese = (c.tese || c.enunciado || '').substring(0, 150);
      return `${i}: ${tipo}${num}${tribunal}${titulo}\n   Tese: ${tese}...`;
    }).join('\n\n');

    const prompt = `VocÃª Ã© um especialista em jurisprudÃªncia trabalhista brasileira.

TÃ“PICO DA SENTENÃ‡A: "${title}"

CONTEXTO/RELATÃ“RIO:
${context || 'NÃ£o disponÃ­vel'}

PRECEDENTES CANDIDATOS:
${candidatosFormatados}

TAREFA: Selecione os 10 precedentes MAIS RELEVANTES para fundamentar este tÃ³pico especÃ­fico.

CRITÃ‰RIOS DE PRIORIZAÃ‡ÃƒO:
1. Precedentes que tratam EXATAMENTE do tema especÃ­fico (nÃ£o apenas mencionam palavras similares)
2. SÃºmulas e OJs vinculantes diretamente aplicÃ¡veis
3. Teses de repercussÃ£o geral ou recursos repetitivos sobre o assunto
4. Hierarquia: TST = STF > TRT > STJ

IMPORTANTE: Foque na PERTINÃŠNCIA TEMÃTICA REAL, nÃ£o apenas em palavras coincidentes.

Retorne APENAS os Ã­ndices dos 10 selecionados, do mais ao menos relevante.
Formato: 5,12,3,8,15,1,9,7,2,11`;

    const messages: AIMessage[] = [{ role: 'user', content: [{ type: 'text', text: prompt }] }];
    // v1.21.26: Parametros deterministicos para ranking
    const response = await callLLM(messages, { maxTokens: 300, disableThinking: true, useInstructions: false, temperature: 0.0, topP: 0.9, topK: 40 });
    // CallAIFunction always returns string
    const text = response || '';
    const indices = text.match(/\d+/g)?.map(Number) || [];
    const result = indices.filter((i: number) => i < candidates.length).map((i: number) => candidates[i]);
    return result.length > 0 ? result.slice(0, 10) : candidates.slice(0, 10);
  } catch (err) {
    console.warn('[JurisAI] Refinamento falhou:', err instanceof Error ? (err as Error).message : err);
    return candidates.slice(0, 10);
  }
};

const findJurisprudenciaHelper = async (topicTitle: string, miniRelatorio: string, callLLM: CallAIFunction, filtros: JurisFiltros = {}) => {
  // Verificar cache primeiro (incluindo filtros na chave)
  const cacheKey = `juris_${topicTitle}_${hashJurisKey(miniRelatorio)}_${filtros.tipo?.join(',') || ''}_${filtros.tribunal?.join(',') || ''}_${filtros.searchTerm || ''}`;
  const cached = jurisCache.get(cacheKey);
  if (cached && (Date.now() - cached.timestamp) < JURIS_CACHE_TTL) {
    return cached.results;
  }

  const allPrecedentes = await loadPrecedentesFromIndexedDB();
  if (!allPrecedentes || allPrecedentes.length === 0) return [];

  // Filtrar apenas precedentes vÃ¡lidos (excluir canceladas/revogadas/convertidas)
  let validPrecedentes = allPrecedentes.filter(p => isStatusValido(p.status));

  // Aplicar filtros por tipo
  if (filtros.tipo && filtros.tipo.length > 0) {
    const tipoFilter = filtros.tipo;
    validPrecedentes = validPrecedentes.filter(p => {
      if (!p.tipoProcesso) return false;
      if (tipoFilter.includes('IRR') && isIRRType(p.tipoProcesso)) return true;
      return tipoFilter.includes(p.tipoProcesso);
    });
  }

  // Aplicar filtros por tribunal
  if (filtros.tribunal && filtros.tribunal.length > 0) {
    const tribunalFilter = filtros.tribunal;
    validPrecedentes = validPrecedentes.filter(p => p.tribunal && tribunalFilter.includes(p.tribunal));
  }

  // Filtro por busca textual do usuÃ¡rio
  if (filtros.searchTerm?.trim()) {
    const searchTermNorm = removeAccents(filtros.searchTerm.toLowerCase().trim());
    const rawTerms = searchTermNorm.split(/\s+/).filter((w: string) => w.length > 2 && !SEARCH_STOPWORDS.has(w));
    if (rawTerms.length === 0) return [];

    // SÃ³ expande sinÃ´nimos se a frase COMPLETA corresponder a uma chave do dicionÃ¡rio
    const expandedFromPhrase: string[] = [];
    for (const [termo, sinonimos] of Object.entries(SINONIMOS_JURIDICOS)) {
      const termoNorm = removeAccents(termo.toLowerCase());
      if (searchTermNorm.includes(termoNorm) || termoNorm.includes(searchTermNorm)) {
        expandedFromPhrase.push(termoNorm, ...sinonimos.map(s => removeAccents(s.toLowerCase())));
      }
    }

    // Termos para busca: originais + stems + sinÃ´nimos de frase completa (sem sinÃ´nimos genÃ©ricos)
    const rawStems = rawTerms.map(stemJuridico).filter((s: string) => s.length > 3);

    // Pontuar cada precedente por quantos termos deram match
    const scored = validPrecedentes.map(p => {
      const searchable = removeAccents(
        `${p.tese || ''} ${p.enunciado || ''} ${p.titulo || ''} ${(Array.isArray(p.keywords) ? p.keywords : []).join(' ')}`
      ).toLowerCase();

      let score = 0;
      let matchedTerms = 0;

      // Match de termos originais (mais importante)
      for (const term of rawTerms) {
        if (searchable.includes(term)) {
          score += 30;
          matchedTerms++;
        }
      }

      // Match por stems (se nÃ£o houve match direto)
      if (matchedTerms < rawTerms.length) {
        for (const stem of rawStems) {
          if (searchable.includes(stem)) {
            score += 15;
            matchedTerms++;
          }
        }
      }

      // Match por sinÃ´nimos de frase completa
      for (const syn of expandedFromPhrase) {
        if (searchable.includes(syn)) {
          score += 20;
          matchedTerms++;
          break; // sÃ³ conta uma vez
        }
      }

      // EXIGIR que pelo menos metade dos termos originais deem match (ou sinÃ´nimo da frase)
      const minMatches = Math.max(1, Math.ceil(rawTerms.length / 2));
      if (matchedTerms < minMatches && expandedFromPhrase.length === 0) {
        return { ...p, score: 0 };
      }
      if (matchedTerms === 0) return { ...p, score: 0 };

      // Boost por hierarquia de tribunal
      if (isIRRType(p.tipoProcesso) && p.tribunal === 'TST') score += 500;
      else if (p.tipoProcesso && ['ADI', 'ADC', 'ADPF', 'RE', 'ARE'].some(t => p.tipoProcesso?.includes(t))) score += 500;
      else if (p.tipoProcesso && ['IRDR', 'IAC'].includes(p.tipoProcesso) && p.tribunal === 'TRT8') score += 450;
      else if (p.tipoProcesso === 'SÃºmula' && p.tribunal === 'STF') score += 100;
      else if (p.tipoProcesso && ['SÃºmula', 'OJ'].includes(p.tipoProcesso) && p.tribunal === 'TST') score += 100;
      else if (p.tribunal === 'STF') score += 50;
      else if (p.tribunal === 'TST') score += 50;
      else if (p.tribunal === 'TRT8') score += 30;
      else if (p.tribunal === 'STJ') score += 5;

      return { ...p, score };
    });

    const filtered = scored.filter(p => p.score > 0).sort((a, b) => b.score - a.score);
    const top = filtered.slice(0, 40);
    jurisCache.set(cacheKey, { results: top, timestamp: Date.now() });
    return top;
  }

  // 1. Limpar e normalizar tÃ­tulo (remover pontuaÃ§Ã£o e stopwords)
  const cleanTitle = topicTitle.replace(/[.,;:!?()\[\]{}]/g, ' ').toLowerCase();
  const rawWords = cleanTitle.split(/\s+/).filter((w: string) => w.length > 2);
  const titleWords = rawWords.filter((w: string) => !SEARCH_STOPWORDS.has(w));

  // 2. TambÃ©m extrair termos do relatÃ³rio (contexto adicional)
  const cleanRelatorio = (miniRelatorio || '').replace(/[.,;:!?()\[\]{}]/g, ' ').toLowerCase();
  const relatorioWords = cleanRelatorio.split(/\s+/)
    .filter((w: string) => w.length > 3 && !SEARCH_STOPWORDS.has(w))
    .slice(0, 30); // Limitar para nÃ£o sobrecarregar

  // 3. Expandir com sinÃ´nimos
  const expandedTitle = expandWithSynonyms(titleWords);
  const expandedRelatorio = expandWithSynonyms(relatorioWords);

  // 4. Criar stems para busca fuzzy
  const titleStems = new Set(titleWords.map((w: string) => stemJuridico(w)).filter((s: string) => s.length > 2));
  const allSearchTerms = new Set([...expandedTitle, ...titleWords]);
  const allSearchStems = new Set([...titleStems, ...titleWords.map((w: string) => removeAccents(w))]);

  // 5. Pontuar cada precedente
  const scored = validPrecedentes.map(p => {
    let score = 0;
    const keywordsRaw = typeof p.keywords === 'string' ? p.keywords.split(/[,;]/).map((k: string) => k.trim()) : (Array.isArray(p.keywords) ? p.keywords : []);
    const keywords = keywordsRaw.map((k: string) => removeAccents(k.toLowerCase()));
    const keywordStems = keywords.map((k: string) => k.split(/\s+/).map((w: string) => stemJuridico(w))).flat();
    const tese = removeAccents((p.tese || p.enunciado || '').toLowerCase());
    const titulo = removeAccents((p.titulo || '').toLowerCase());
    const teseStems = tese.split(/\s+/).map((w: string) => stemJuridico(w));

    // Match em keywords (mais importante)
    for (const term of allSearchTerms) {
      const termNorm = removeAccents(term);
      if (keywords.some((k: string) => k.includes(termNorm) || termNorm.includes(k))) score += 20;
    }

    // Match por stem em keywords (captura variaÃ§Ãµes morfolÃ³gicas)
    for (const stem of allSearchStems) {
      if (stem.length > 3 && keywordStems.some((ks: string) => ks.includes(stem) || stem.includes(ks))) score += 15;
    }

    // Match em tÃ­tulo do precedente
    for (const term of allSearchTerms) {
      const termNorm = removeAccents(term);
      if (titulo.includes(termNorm)) score += 15;
    }

    // Match em tese/enunciado
    for (const term of allSearchTerms) {
      const termNorm = removeAccents(term);
      if (tese.includes(termNorm)) score += 10;
    }

    // Match por stemming em tese (mais flexÃ­vel)
    for (const stem of allSearchStems) {
      if (stem.length > 3 && teseStems.some((ts: string) => ts.includes(stem) || stem.includes(ts))) score += 8;
    }

    // Match com termos do relatÃ³rio (contexto)
    for (const term of expandedRelatorio) {
      const termNorm = removeAccents(term);
      if (tese.includes(termNorm) || titulo.includes(termNorm)) score += 3;
    }

    // Boost para status vÃ¡lido
    if (isStatusValido(p.status)) score += 5;

    // Boost FORTE para precedentes vinculantes/obrigatÃ³rios
    const tipoProc = (p.tipoProcesso || '').toUpperCase();
    const tribunal = (p.tribunal || '').toUpperCase();
    const orgao = (p.orgao || '').toUpperCase();
    const category = (p.category || '').toUpperCase();

    // IRR/IAC do TST (mÃ¡xima prioridade - vinculantes obrigatÃ³rios)
    if (tribunal === 'TST' && (isIRRType(tipoProc) || tipoProc === 'IAC' || category.includes('IRR') || category.includes('IAC'))) {
      score += 500;
    }
    // ADI/ADC/ADPF e RepercussÃ£o Geral do STF (vinculantes)
    else if (tribunal === 'STF' && (tipoProc === 'ADI' || tipoProc === 'ADC' || tipoProc === 'ADPF' || tipoProc === 'RE' || tipoProc === 'ARE' || category.includes('REPERCUSSAO'))) {
      score += 480;
    }
    // IRDR/IAC do TRT8 (vinculantes regionais)
    else if ((tribunal === 'TRT8' || tribunal === 'TRT-8' || orgao.includes('TRT')) && (tipoProc === 'IRDR' || tipoProc === 'IAC' || category.includes('IRDR') || category.includes('IAC'))) {
      score += 450;
    }
    // SÃºmulas vinculantes STF
    else if (tribunal === 'STF' && tipoProc === 'SÃšMULA') {
      score += 80;
    }
    // SÃºmulas TST
    else if (tribunal === 'TST' && (tipoProc === 'SÃšMULA' || tipoProc === 'OJ')) {
      score += 70;
    }
    // Outros STF/STJ/TST
    else if (tribunal === 'STF') score += 15;
    else if (tribunal === 'STJ') score += 12;
    else if (tribunal === 'TST') score += 10;

    return { ...p, score };
  });

  // 6. Filtrar e ordenar (mais candidatos para a IA refinar)
  const candidates = scored.filter(p => p.score > 0).sort((a, b) => b.score - a.score).slice(0, 40);

  // 7. Se tiver candidatos suficientes, usar IA para refinar
  let results;
  if (candidates.length > 3 && callLLM) {
    results = await refineJurisWithAIHelper(topicTitle, miniRelatorio, candidates, callLLM);
  } else {
    results = candidates.slice(0, 10);
  }

  // Salvar no cache
  jurisCache.set(cacheKey, { results, timestamp: Date.now() });
  return results;
};

const SEARCH_STOPWORDS = new Set(['de', 'do', 'da', 'dos', 'das', 'em', 'no', 'na', 'nos', 'nas',
  'para', 'com', 'por', 'pelo', 'pela', 'pelos', 'pelas', 'ao', 'aos',
  'um', 'uma', 'uns', 'umas', 'o', 'a', 'os', 'as', 'e', 'ou', 'que', 'se']);

const SINONIMOS_JURIDICOS = {
  'horas extras': ['sobrejornada', 'jornada extraordinaria', 'horas suplementares', 'hora extra'],
  'rescisao indireta': ['despedida indireta', 'justa causa do empregador', 'resilicao indireta'],
  'verbas rescisorias': ['haveres rescisorios', 'parcelas rescisorias', 'direitos rescisorios', 'saldo de salario', 'aviso previo'],
  'rescisao': ['verbas rescisorias', 'rescisao contratual', 'dispensa', 'desligamento', 'termino do contrato'],
  'adicional noturno': ['hora noturna', 'trabalho noturno'],
  'danos morais': ['indenizacao por dano moral', 'reparacao moral', 'dano extrapatrimonial', 'dano moral', 'lesao moral'],
  'dano moral': ['danos morais', 'indenizacao por dano moral', 'reparacao moral', 'dano extrapatrimonial'],
  'danos materiais': ['dano patrimonial', 'prejuizo material'],
  'assedio moral': ['mobbing', 'perseguicao no trabalho'],
  'insalubridade': ['adicional de insalubridade', 'agente insalubre'],
  'periculosidade': ['adicional de periculosidade', 'risco de vida'],
  'vinculo empregaticio': ['relacao de emprego', 'contrato de trabalho'],
  'aviso previo': ['pre-aviso', 'denuncia do contrato'],
  'ferias': ['ferias vencidas', 'ferias proporcionais', 'terco constitucional'],
  'fgts': ['fundo de garantia', 'fundiario', 'deposito fundiario'],
  'multa 477': ['multa rescisoria', 'atraso nas verbas'],
  'multa 467': ['verbas incontroversos'],
  'equiparacao salarial': ['isonomia salarial', 'salario igual'],
  'desvio de funcao': ['acumulo de funcao', 'diferencas salariais'],
  'justa causa': ['dispensa por justa causa', 'falta grave'],
  'estabilidade': ['garantia de emprego', 'estabilidade provisoria'],
  'acidente de trabalho': ['acidente laboral', 'sinistro ocupacional'],
  'doenca ocupacional': ['doenca profissional', 'doenca do trabalho'],
  'intervalo intrajornada': ['intervalo para refeicao', 'hora de almoco'],
  'intervalo interjornada': ['descanso entre jornadas'],
  'banco de horas': ['compensacao de jornada'],
  'terceirizacao': ['outsourcing', 'prestacao de servicos'],
  'responsabilidade subsidiaria': ['condenacao subsidiaria'],
  'responsabilidade solidaria': ['condenacao solidaria'],
  'prescricao': ['prazo prescricional', 'prescricao quinquenal', 'prescricao bienal'],
  'litigancia de ma-fe': ['ma-fe processual'],
  'honorarios': ['honorarios advocaticios', 'honorarios sucumbenciais'],
  'justica gratuita': ['gratuidade de justica', 'assistencia judiciaria'],
  'inss': ['contribuicao previdenciaria', 'previdencia social', 'inss patronal', 'cota parte'],
  'contribuicao sindical': ['imposto sindical', 'contribuicao confederativa'],
  'salario': ['remuneracao', 'contraprestacao', 'vencimentos'],
  'demissao': ['dispensa', 'desligamento', 'rescisao contratual'],
  'contrato': ['vinculo', 'pacto laboral', 'relacao contratual'],
  'inadimplemento': ['mora salarial', 'falta de pagamento', 'atraso salarial'],
  'gestante': ['gravidez', 'licenca maternidade', 'estabilidade gestante', 'gravida'],
  'cipeiro': ['cipa', 'estabilidade cipeiro', 'membro da cipa'],
  'dirigente sindical': ['estabilidade sindical', 'garantia sindical', 'representante sindical'],
  'dispensa discriminatoria': ['dispensa arbitraria', 'demissao discriminatoria', 'dispensa ilicita'],
  'acumulo de funcao': ['desvio funcional', 'funcao diversa', 'plus salarial'],
  'sobreaviso': ['plantao', 'prontidao', 'tempo a disposicao'],
  'pejotizacao': ['fraude trabalhista', 'contrato fraudulento', 'simulacao'],
  'grupo economico': ['responsabilidade solidaria', 'conglomerado', 'empresas coligadas'],
  'sucessao trabalhista': ['sucessao de empregadores', 'transferencia de empresa'],
};

// Stemming simplificado para portuguÃªs jurÃ­dico
const stemJuridico = (word: string) => {
  if (!word || word.length < 3) return word;
  const w = removeAccents(word.toLowerCase());
  return w
    .replace(/(Ã§Ã£o|Ã§Ãµes|sÃ£o|sÃµes|mento|mentos)$/i, '')
    .replace(/(Ã³rio|Ã³ria|Ã³rios|Ã³rias|ivo|iva|ivos|ivas)$/i, '')
    .replace(/(ista|istas|ante|antes|ente|entes)$/i, '')
    .replace(/(ade|ades|dade|dades)$/i, '')
    .replace(/(eiro|eira|eiros|eiras)$/i, '')
    .replace(/(al|ais|el|eis|il|is|ol|ois|ul|uis)$/i, '')
    .replace(/(ar|er|ir|or|ur)$/i, '')
    .replace(/(s|es)$/i, '');
};

// Expande termos com sinÃ´nimos jurÃ­dicos
const expandWithSynonyms = (words: string[]) => {
  const expanded = new Set(words);
  for (const word of words) {
    const wordNorm = removeAccents(word.toLowerCase());
    for (const [termo, sinonimos] of Object.entries(SINONIMOS_JURIDICOS)) {
      const termoNorm = removeAccents(termo.toLowerCase());
      // Se a palavra estÃ¡ no termo ou vice-versa
      if (termoNorm.includes(wordNorm) || wordNorm.includes(termoNorm) ||
          termoNorm.split(' ').some(t => t === wordNorm)) {
        expanded.add(termoNorm);
        sinonimos.forEach((s: string) => expanded.add(removeAccents(s.toLowerCase())));
      }
      // Se a palavra estÃ¡ em algum sinÃ´nimo
      for (const sin of sinonimos) {
        const sinNorm = removeAccents(sin.toLowerCase());
        if (sinNorm.includes(wordNorm) || wordNorm.includes(sinNorm)) {
          expanded.add(termoNorm);
          sinonimos.forEach((s: string) => expanded.add(removeAccents(s.toLowerCase())));
          break;
        }
      }
    }
  }
  return Array.from(expanded);
};

const fuzzyMatch = (term: string, text: string, threshold = 0.7) => {
  if (!term || !text) return false;
  const t = removeAccents(term.toLowerCase());
  const s = removeAccents(text.toLowerCase());
  if (s.includes(t)) return true;
  if (t.length < 4) return false;
  const maxDist = Math.floor(t.length * (1 - threshold));
  for (let i = 0; i <= s.length - t.length; i++) {
    let dist = 0;
    for (let j = 0; j < t.length && dist <= maxDist; j++) {
      if (s[i + j] !== t[j]) dist++;
    }
    if (dist <= maxDist) return true;
  }
  return false;
};

const searchModelsInLibrary = (models: Model[], term: string, options: { limit?: number | null; includeContent?: boolean; useSynonyms?: boolean; boostByUsage?: boolean } = {}) => {
  if (!term || !term.trim()) return [];

  const {
    limit = null,
    includeContent = true,
    useSynonyms = true,
    boostByUsage = true
  } = options;

  const normalizedTerm = removeAccents(term.toLowerCase().trim());

  // Extrair termos entre aspas (busca exata) e termos normais (fuzzy)
  const exactTerms: string[] = [];
  const quotedRegex = /"([^"]+)"/g;
  let match;
  while ((match = quotedRegex.exec(normalizedTerm)) !== null) {
    exactTerms.push(match[1].trim());
  }

  // Remover termos entre aspas e processar palavras restantes como fuzzy
  const termWithoutQuotes = normalizedTerm.replace(quotedRegex, '').trim();
  const fuzzyTerms = termWithoutQuotes.split(/\s+/).filter((w: string) => w.length > 2 && !SEARCH_STOPWORDS.has(w));

  if (exactTerms.length === 0 && fuzzyTerms.length === 0) return [];

  // Expandir sinÃ´nimos apenas para termos fuzzy
  const expandedFuzzy = new Set(fuzzyTerms);
  if (useSynonyms) {
    fuzzyTerms.forEach((word: string) => {
      Object.entries(SINONIMOS_JURIDICOS).forEach(([key, synonyms]) => {
        if (key.includes(word) || word.includes(key)) {
          synonyms.forEach(s => expandedFuzzy.add(s));
        }
      });
    });
  }

  const scored = models.map(model => {
    const titleNorm = removeAccents((model.title || '').toLowerCase());
    const keywordsRaw = Array.isArray(model.keywords) ? model.keywords.join(' ') : (model.keywords || '');
    const keywordsNorm = removeAccents(keywordsRaw.toLowerCase());
    const contentNorm = includeContent ? removeAccents((model.content || '').toLowerCase()) : '';

    let score = 0;
    let matchedExact = 0;
    let matchedFuzzy = 0;

    // Verificar termos EXATOS (entre aspas) - busca por palavra inteira
    for (const word of exactTerms) {
      const wordRegex = new RegExp(`\\b${word}\\b`, 'i');
      const inTitle = wordRegex.test(titleNorm);
      const inKeywords = wordRegex.test(keywordsNorm);
      const inContent = wordRegex.test(contentNorm);

      if (inTitle) { score += 15; matchedExact++; }
      if (inKeywords) { score += 8; matchedExact++; }
      if (inContent) { score += 3; matchedExact++; }
    }

    // Verificar termos FUZZY (sem aspas) - busca por substring
    for (const word of expandedFuzzy) {
      const inTitle = titleNorm.includes(word);
      const inKeywords = keywordsNorm.includes(word);
      const inContent = contentNorm.includes(word);

      if (inTitle) score += 10;
      if (inKeywords) score += 5;
      if (inContent) score += 2;
      if (fuzzyTerms.includes(word) && (inTitle || inKeywords || inContent)) matchedFuzzy++;
    }

    // Termos exatos sÃ£o OBRIGATÃ“RIOS - zerar score se nÃ£o encontrou todos
    if (exactTerms.length > 0 && matchedExact < exactTerms.length) score = 0;

    // Boost se todos os termos fuzzy originais foram encontrados
    if (matchedFuzzy >= fuzzyTerms.length && fuzzyTerms.length > 0) score += 20;

    // Aplicar boosts APENAS se houve algum match (evita favoritos sem match aparecerem)
    if (score > 0) {
      if (boostByUsage && model.usageCount) score += Math.min(model.usageCount * 0.5, 10);
      if (model.favorite) score += 5;
    }

    return { model, score };
  });

  const results = scored
    .filter(({ score }) => score > 0)
    .sort((a, b) => b.score - a.score)
    .map(({ model }) => model);

  return limit ? results.slice(0, limit) : results;
};

// v1.27.01: Busca semÃ¢ntica de modelos (usa embeddings inline)
const searchModelsBySimilarity = async (models: Model[], query: string, options: { threshold?: number; limit?: number } = {}) => {
  const { threshold = 0.4, limit = 20 } = options;

  if (!query || query.length < 3) return [];

  // Filtrar apenas modelos com embedding
  const modelsWithEmbedding = models.filter((m: Model) => m.embedding?.length === 768);
  if (modelsWithEmbedding.length === 0) return [];

  // Gerar embedding da query (v1.32.20: toLowerCase para E5 case-sensitive)
  const queryEmbedding = await AIModelService.getEmbedding(query.toLowerCase(), 'query');

  // Calcular similaridade
  const scored = modelsWithEmbedding.map((model: Model) => ({
    ...model,
    similarity: AIModelService.cosineSimilarity(queryEmbedding, model.embedding!)
  }));

  // Filtrar por threshold e ordenar
  return scored
    .filter(m => m.similarity >= threshold)
    .sort((a, b) => b.similarity - a.similarity)
    .slice(0, limit);
};

// ğŸ£ CUSTOM HOOK: useModelPreview - Preview de modelos de texto
const useModelPreview = () => {
  const [previewingModel, setPreviewingModel] = React.useState<Model | null>(null);
  const [isPreviewOpen, setIsPreviewOpen] = React.useState(false);
  const [isEditing, setIsEditing] = React.useState(false);
  const [editedContent, setEditedContent] = React.useState('');
  // v1.15.2: FunÃ§Ã£o de inserÃ§Ã£o contextual (para GlobalEditorModal)
  // v1.33.25: Usar ref em vez de state para nÃ£o causar recriaÃ§Ã£o do objeto modelPreview
  const contextualInsertFnRef = React.useRef<((content: string) => void) | null>(null);
  const setContextualInsertFn = React.useCallback((fn: ((content: string) => void) | null) => {
    contextualInsertFnRef.current = fn;
  }, []);
  // v1.15.3: Estado para "Salvar como Novo Modelo"
  const [saveAsNewData, setSaveAsNewData] = React.useState<{ title: string; content: string; keywords?: string; category?: string } | null>(null);
  // v1.19.2: Callback para notificar quando modelo Ã© atualizado (sincroniza sugestÃµes do GlobalEditor)
  const onModelUpdatedRef = React.useRef<((model: Model) => void) | null>(null);

  const openPreview = React.useCallback((model: Model) => {
    if (!model || !model.content) {
      return;
    }

    setPreviewingModel(model);
    setIsPreviewOpen(true);
  }, []);

  const closePreview = React.useCallback(() => {
    setIsPreviewOpen(false);
    setIsEditing(false);
    setEditedContent('');
    // Delay para animaÃ§Ã£o de saÃ­da
    setTimeout(() => setPreviewingModel(null), 200);
  }, []);

  const startEditing = React.useCallback(() => {
    if (previewingModel) {
      setEditedContent(previewingModel.content);
      setIsEditing(true);
    }
  }, [previewingModel]);

  const cancelEditing = React.useCallback(() => {
    setIsEditing(false);
    setEditedContent('');
  }, []);

  // v1.15.3: FunÃ§Ãµes para "Salvar como Novo Modelo"
  const openSaveAsNew = React.useCallback((content: string, originalModel: Model | null) => {
    const keywords = originalModel?.keywords;
    setSaveAsNewData({
      title: '',
      content: content,
      keywords: Array.isArray(keywords) ? keywords.join(', ') : (keywords || ''),
      category: originalModel?.category || 'MÃ©rito'
    });
  }, []);

  const closeSaveAsNew = React.useCallback(() => {
    setSaveAsNewData(null);
  }, []);

  // Atalho Esc para fechar/cancelar ediÃ§Ã£o
  React.useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && isPreviewOpen) {
        if (isEditing) {
          // Em modo ediÃ§Ã£o: cancelar ediÃ§Ã£o (volta para visualizaÃ§Ã£o)
          cancelEditing();
        } else {
          // Em modo visualizaÃ§Ã£o: fechar modal
          closePreview();
        }
      }
    };

    window.addEventListener('keydown', handleEscape);
    return () => window.removeEventListener('keydown', handleEscape);
  }, [isPreviewOpen, isEditing, cancelEditing, closePreview]);

  // v1.33.22: useMemo para evitar novo objeto a cada render (causa infinite loop em GlobalEditorModal)
  return React.useMemo(() => ({
    previewingModel,
    isPreviewOpen,
    isEditing,
    editedContent,
    openPreview,
    closePreview,
    startEditing,
    cancelEditing,
    setEditedContent,
    // v1.15.2: FunÃ§Ã£o de inserÃ§Ã£o contextual
    contextualInsertFnRef,
    setContextualInsertFn,
    // v1.15.3: Salvar como Novo Modelo
    saveAsNewData,
    setSaveAsNewData,
    openSaveAsNew,
    closeSaveAsNew,
    // v1.19.2: Callback para sincronizar sugestÃµes do GlobalEditor
    onModelUpdatedRef,
  }), [
    previewingModel, isPreviewOpen, isEditing, editedContent,
    openPreview, closePreview, startEditing, cancelEditing,
    saveAsNewData, openSaveAsNew, closeSaveAsNew
  ]);
};

// ğŸ”§ UTILITY FUNCTIONS (v1.6.1)

const generateModelId = () => {
  // Tentar usar crypto.randomUUID() (disponÃ­vel em contextos seguros HTTPS)
  if (typeof crypto !== 'undefined' && crypto.randomUUID) {
    return `model:${crypto.randomUUID()}`;
  }

  // Fallback: Date.now() + random string
  // Random string: base36 (0-9, a-z), 9 caracteres
  const randomStr = Math.random().toString(36).substr(2, 9);
  return `model:${Date.now()}_${randomStr}`;
};

// ğŸ” MODEL VALIDATION & SANITIZATION (v1.36.69) - extraÃ­dos para src/hooks/useIndexedDB.ts

// ğŸ£ CUSTOM HOOK: useProofManager (v1.36.65) - Sistema de Provas
// v1.36.65: Estado migrado para Zustand (useProofsStore.ts)
const useProofManager = (_documentServices: ReturnType<typeof useDocumentServices> | null = null) => {
  // Delega estado e aÃ§Ãµes simples para o store Zustand
  const storeState = useProofManagerCompat();

  // ğŸ”§ v1.14.1: Helpers utilitÃ¡rios (permanecem aqui pois sÃ£o usados nos handlers abaixo)
  const removeById = React.useCallback(<T extends { id: string | number }>(arr: T[], id: string | number): T[] => arr.filter((item: T) => item.id !== id), []);
  const toFilesArray = React.useCallback((value: FileList | File[] | null) => Array.isArray(value) ? value : Array.from(value || []), []);

  // Handler: Upload de provas em PDF (usa savePdfToIndexedDB externo)
  const handleUploadProofPdf = React.useCallback(async (files: FileList | File[]) => {
    const filesArray = toFilesArray(files);

    for (const file of filesArray) {
      const id = Date.now() + Math.random();
      const newProof: ProofFile = {
        id,
        file,
        name: file.name,
        type: 'pdf',
        size: file.size,
        uploadDate: new Date().toISOString()
      };

      storeState.setProofFiles(prev => [...prev, newProof]);
      storeState.setProofUsePdfMode(prev => ({ ...prev, [id]: true }));
      storeState.setProofProcessingModes(prev => ({ ...prev, [id]: 'pdfjs' }));

      // Salvar no IndexedDB para persistÃªncia entre reloads
      try {
        await savePdfToIndexedDB(`proof-${id}`, file, 'proof');
      } catch (err) {
        // Silently ignore - PDF won't persist but app continues working
      }
    }
  }, [toFilesArray, storeState]);

  // Handler: Adicionar prova em texto
  const handleAddProofText = React.useCallback(() => {
    if (!storeState.newProofTextData.name.trim() || !storeState.newProofTextData.text.trim()) {
      return;
    }

    const id = Date.now() + Math.random();
    const newProof: ProofText = {
      id,
      text: storeState.newProofTextData.text,
      name: storeState.newProofTextData.name,
      type: 'text',
      uploadDate: new Date().toISOString()
    };

    storeState.setProofTexts(prev => [...prev, newProof]);
    storeState.setNewProofTextData({ name: '', text: '' });
  }, [storeState]);

  // Handler: Deletar prova (PDF ou texto)
  const handleDeleteProof = React.useCallback((proof: Proof) => {
    if (proof.isPdf || proof.type === 'pdf') {
      storeState.setProofFiles(prev => removeById(prev, proof.id));
    } else {
      storeState.setProofTexts(prev => removeById(prev, proof.id));
    }
    // Limpar dados relacionados
    storeState.setProofUsePdfMode(prev => { const { [proof.id]: _, ...rest } = prev; return rest; });
    storeState.setExtractedProofTexts(prev => { const { [proof.id]: _, ...rest } = prev; return rest; });
    storeState.setProofExtractionFailed(prev => { const { [proof.id]: _, ...rest } = prev; return rest; });
    storeState.setProofTopicLinks(prev => { const { [proof.id]: _, ...rest } = prev; return rest; });
    storeState.setProofAnalysisResults(prev => { const { [proof.id]: _, ...rest } = prev; return rest; });
    storeState.setProofConclusions(prev => { const { [proof.id]: _, ...rest } = prev; return rest; });
    storeState.setProofProcessingModes(prev => { const { [proof.id]: _, ...rest } = prev; return rest; });
  }, [removeById, storeState]);

  // Retorno combinado: store + handlers com IO
  return {
    ...storeState,
    handleUploadProofPdf,
    handleAddProofText,
    handleDeleteProof
  };
};

// ğŸ£ CUSTOM HOOK: useDocumentManager (v1.2.7a) - Sistema de AnÃ¡lise de Documentos
const useDocumentManager = (clearPdfCache?: () => void) => {
  // ğŸ“¦ ESTADOS CORE (13 total)

  // Arquivos de Documentos (3)
  const [peticaoFiles, setPeticaoFiles] = React.useState<UploadedFile[]>([]);
  // Array de {file: File, id: string} dos PDFs da petiÃ§Ã£o inicial e emendas

  const [contestacaoFiles, setContestacaoFiles] = React.useState<UploadedFile[]>([]);
  // Array de {file: File, id: string} dos PDFs de contestaÃ§Ãµes

  const [complementaryFiles, setComplementaryFiles] = React.useState<UploadedFile[]>([]);
  // Array de File objects dos PDFs de documentos complementares

  // Textos Colados (Alternativa aos PDFs) (3)
  const [pastedPeticaoTexts, setPastedPeticaoTexts] = React.useState<PastedText[]>([]);
  // Array de {text: string, name: string} - petiÃ§Ã£o e emendas coladas

  const [pastedContestacaoTexts, setPastedContestacaoTexts] = React.useState<PastedText[]>([]);
  // Array de {text: string, name: string} - contestaÃ§Ãµes coladas

  const [pastedComplementaryTexts, setPastedComplementaryTexts] = React.useState<PastedText[]>([]);
  // Array de {text: string, name: string} - documentos complementares colados

  // Metadados de Documentos Processados (1)
  const [analyzedDocuments, setAnalyzedDocuments] = React.useState<{
    peticoes: string[];
    peticoesText: PastedText[];
    contestacoes: string[];
    contestacoesText: PastedText[];
    complementares: string[];
    complementaresText: PastedText[];
  }>({
    peticoes: [],            // Array de base64 (PDFs nÃ£o extraÃ­dos)
    peticoesText: [],        // Array de {text, name} (textos extraÃ­dos/colados)
    contestacoes: [],        // Array de base64 (PDFs nÃ£o extraÃ­dos)
    contestacoesText: [],    // Array de {text, name} (textos extraÃ­dos/colados)
    complementares: [],      // Array de base64 (PDFs nÃ£o extraÃ­dos)
    complementaresText: []   // Array de {text, name} (textos extraÃ­dos/colados)
  });
  // Objeto contendo documentos processados apÃ³s anÃ¡lise

  // Estados de UI e Progresso (6)
  const [analyzing, setAnalyzing] = React.useState<boolean>(false);
  // Flag indicando se anÃ¡lise estÃ¡ em andamento

  const [analysisProgress, setAnalysisProgress] = React.useState<string>('');
  // Mensagem de progresso exibida durante anÃ¡lise (ex: "Extraindo texto da petiÃ§Ã£o...")

  const [extractingText, setExtractingText] = React.useState<boolean>(false);
  // Flag indicando se extraÃ§Ã£o de texto de PDF estÃ¡ em andamento

  const [showPasteArea, setShowPasteArea] = React.useState<Record<string, boolean>>({
    peticao: false,
    contestacao: false,
    complementary: false
  });
  // Controla visibilidade das Ã¡reas de colagem de texto para cada tipo de documento

  const [extractedTexts, setExtractedTexts] = React.useState<ExtractedTexts>({
    peticoes: [],
    contestacoes: [],
    complementares: []
  });
  // Cache de textos extraÃ­dos de PDFs (para nÃ£o reprocessar)

  // ğŸ†• v1.12.18: Modo de processamento por documento (v1.12.22: removido OCRAD)
  // Cada documento pode ter seu prÃ³prio modo: 'pdf-puro' | 'pdfjs' | 'claude-vision'
  const [documentProcessingModes, setDocumentProcessingModes] = React.useState<{
    peticoes: ProcessingMode[];
    contestacoes: ProcessingMode[];
    complementares: ProcessingMode[];
  }>({
    peticoes: [],               // Array de modos, um por arquivo de petiÃ§Ã£o
    contestacoes: [],           // Array de modos, um por arquivo
    complementares: []          // Array de modos, um por arquivo
  });

  const [showTextPreview, setShowTextPreview] = React.useState<boolean>(false);
  // Controla exibiÃ§Ã£o de modal de preview de texto extraÃ­do

  // ğŸ†• v1.12.18: Helpers para definir modo de processamento por Ã­ndice
  const setPeticaoMode = React.useCallback((index: number, mode: ProcessingMode) => {
    setDocumentProcessingModes(prev => {
      const newPeticoes = [...(prev.peticoes || [])];
      newPeticoes[index] = mode;
      return { ...prev, peticoes: newPeticoes };
    });
  }, []);

  const setContestacaoMode = React.useCallback((index: number, mode: ProcessingMode) => {
    setDocumentProcessingModes(prev => {
      const newContestacoes = [...prev.contestacoes];
      newContestacoes[index] = mode;
      return { ...prev, contestacoes: newContestacoes };
    });
  }, []);

  const setComplementarMode = React.useCallback((index: number, mode: ProcessingMode) => {
    setDocumentProcessingModes(prev => {
      const newComplementares = [...prev.complementares];
      newComplementares[index] = mode;
      return { ...prev, complementares: newComplementares };
    });
  }, []);

  // ğŸ› ï¸ HANDLERS SIMPLES (5) - ETAPA 7b

  // Helper para garantir array (usado por handleUploadContestacao e handleUploadComplementary)
  const toUploadFilesArray = (value: FileList | File[] | null) => Array.isArray(value) ? value : Array.from(value || []);

  // Handler: Processa texto colado (petiÃ§Ã£o, contestaÃ§Ã£o ou complementar)
  const handlePastedText = React.useCallback((text: string, type: string, setError: ((msg: string) => void) | null = null) => {
    if (!text.trim()) {
      if (setError) setError('O texto colado estÃ¡ vazio');
      return;
    }

    if (type === 'peticao') {
      setPastedPeticaoTexts(prev => [...prev, {
        id: `pasted-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`,
        text,
        name: prev.length === 0 ? 'PetiÃ§Ã£o Inicial' : `Emenda/Doc Autor ${prev.length + 1}`
      }]);
      setShowPasteArea(prev => ({ ...prev, peticao: false }));
    } else if (type === 'contestacao') {
      setPastedContestacaoTexts(prev => [...prev, {
        id: `pasted-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`,
        text,
        name: `ContestaÃ§Ã£o ${prev.length + 1}`
      }]);
      setShowPasteArea(prev => ({ ...prev, contestacao: false }));
    } else if (type === 'complementary') {
      setPastedComplementaryTexts(prev => [...prev, {
        id: `pasted-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`,
        text,
        name: `Documento Complementar ${prev.length + 1}`
      }]);
      setShowPasteArea(prev => ({ ...prev, complementary: false }));
    }

    if (setError) setError('');
  }, []); // ğŸš€ v1.8.1: Memoizado (3 textareas)

  // Handler: Remove texto colado
  const removePastedText = (type: string, index: number | null = null) => {
    if (type === 'peticao' && index !== null) {
      setPastedPeticaoTexts(prev => prev.filter((_, i: number) => i !== index));
    } else if (type === 'contestacao' && index !== null) {
      setPastedContestacaoTexts(prev => prev.filter((_, i: number) => i !== index));
    } else if (type === 'complementary' && index !== null) {
      setPastedComplementaryTexts(prev => prev.filter((_, i: number) => i !== index));
    }
  };

  // Handler: Remove arquivo de petiÃ§Ã£o por Ã­ndice (com limpeza IndexedDB)
  const removePeticaoFile = React.useCallback(async (index: number) => {
    const fileToRemove = peticaoFiles[index];
    if (fileToRemove?.id) {
      try {
        await removePdfFromIndexedDB(`upload-peticao-${fileToRemove.id}`);
      } catch (err) { /* ignore */ }
    }
    setPeticaoFiles(prev => prev.filter((_, i: number) => i !== index));
    setDocumentProcessingModes(prev => ({
      ...prev,
      peticoes: (prev.peticoes || []).filter((_, i: number) => i !== index)
    }));
  }, [peticaoFiles]);

  const handleUploadPeticao = React.useCallback(async (files: FileList | File[]) => {
    const filesArray = toUploadFilesArray(files);
    const pdfFiles = filesArray.filter(f => f.type === 'application/pdf');
    if (pdfFiles.length === 0) return;

    const filesWithIds = pdfFiles.map(file => ({
      file,
      id: crypto.randomUUID()
    }));

    setPeticaoFiles(prev => [...prev, ...filesWithIds]);

    for (const { file, id } of filesWithIds) {
      try {
        await savePdfToIndexedDB(`upload-peticao-${id}`, file, 'upload');
      } catch (err) { /* ignore */ }
    }
  }, []);

  const handleUploadContestacao = React.useCallback(async (files: FileList | File[]) => {
    const filesArray = toUploadFilesArray(files);
    const pdfFiles = filesArray.filter(f => f.type === 'application/pdf');
    if (pdfFiles.length === 0) return;

    const filesWithIds = pdfFiles.map(file => ({
      file,
      id: crypto.randomUUID()
    }));

    setContestacaoFiles(prev => [...prev, ...filesWithIds]);

    for (const { file, id } of filesWithIds) {
      try {
        await savePdfToIndexedDB(`upload-contestacao-${id}`, file, 'upload');
      } catch (err) { /* ignore */ }
    }
  }, []);

  // Handler: Upload de complementares
  const handleUploadComplementary = React.useCallback(async (files: FileList | File[]) => {
    const filesArray = toUploadFilesArray(files);
    const pdfFiles = filesArray.filter(f => f.type === 'application/pdf');
    if (pdfFiles.length === 0) return;

    const filesWithIds = pdfFiles.map(file => ({
      file,
      id: crypto.randomUUID()
    }));

    setComplementaryFiles(prev => [...prev, ...filesWithIds]);

    for (const { file, id } of filesWithIds) {
      try {
        await savePdfToIndexedDB(`upload-complementar-${id}`, file, 'upload');
      } catch (err) { /* ignore */ }
    }
  }, []);

  // ğŸ’¾ MÃ‰TODOS DE PERSISTÃŠNCIA (3) - ETAPA 7c

  // Serializa dados para persistÃªncia
  const serializeForPersistence = () => {
    return {
      // Arquivos (serÃ£o convertidos para base64 pelo useLocalStorage)
      peticaoFiles,
      contestacaoFiles,
      complementaryFiles,

      // Textos colados
      pastedPeticaoTexts,
      pastedContestacaoTexts,
      pastedComplementaryTexts,

      // Metadados processados
      analyzedDocuments,

      // Estados de UI (nÃ£o precisa salvar analyzing/extractingText - temporÃ¡rios)
      showPasteArea,
      extractedTexts,

      // v1.12.18: Modos de processamento por documento
      documentProcessingModes

      // showTextPreview nÃ£o precisa persistir (modal temporÃ¡rio)
    };
  };

  // Restaura dados do localStorage
  const restoreFromPersistence = (data: Record<string, unknown> | null) => {
    if (!data) return;

    // Restaurar arquivos (File objects reconstruÃ­dos pelo useLocalStorage)
    if (data.peticaoFiles) setPeticaoFiles(data.peticaoFiles as UploadedFile[]);
    if (data.contestacaoFiles) setContestacaoFiles(data.contestacaoFiles as UploadedFile[]);
    if (data.complementaryFiles) setComplementaryFiles(data.complementaryFiles as UploadedFile[]);

    // Restaurar textos colados
    if (data.pastedPeticaoTexts) setPastedPeticaoTexts(data.pastedPeticaoTexts as PastedText[]);
    if (data.pastedContestacaoTexts) setPastedContestacaoTexts(data.pastedContestacaoTexts as PastedText[]);
    if (data.pastedComplementaryTexts) setPastedComplementaryTexts(data.pastedComplementaryTexts as PastedText[]);

    // Restaurar metadados
    if (data.analyzedDocuments) setAnalyzedDocuments(data.analyzedDocuments as AnalyzedDocuments);

    // Restaurar estados de UI
    if (data.showPasteArea) setShowPasteArea(data.showPasteArea as Record<string, boolean>);
    if (data.extractedTexts) setExtractedTexts(data.extractedTexts as ExtractedTexts);

    // v1.12.18: Restaurar modos de processamento
    if (data.documentProcessingModes) setDocumentProcessingModes(data.documentProcessingModes as DocumentProcessingModes);
  };

  // Limpa TODOS os estados de documentos
  const clearAll = async () => {
    // Limpar IndexedDB por ID antes de limpar estados
    for (const fileObj of peticaoFiles) {
      if (fileObj?.id) try { await removePdfFromIndexedDB(`upload-peticao-${fileObj.id}`); } catch {}
    }
    for (const fileObj of contestacaoFiles) {
      if (fileObj?.id) try { await removePdfFromIndexedDB(`upload-contestacao-${fileObj.id}`); } catch {}
    }
    for (const fileObj of complementaryFiles) {
      if (fileObj?.id) try { await removePdfFromIndexedDB(`upload-complementar-${fileObj.id}`); } catch {}
    }
    clearPdfCache?.();

    // Limpar arquivos
    setPeticaoFiles([]);
    setContestacaoFiles([]);
    setComplementaryFiles([]);

    // Limpar textos colados
    setPastedPeticaoTexts([]);
    setPastedContestacaoTexts([]);
    setPastedComplementaryTexts([]);

    // Limpar metadados
    setAnalyzedDocuments({
      peticoes: [],
      peticoesText: [],
      contestacoes: [],
      contestacoesText: [],
      complementares: [],
      complementaresText: []
    });

    // Limpar estados de UI/Progresso
    setAnalyzing(false);
    setAnalysisProgress('');
    setExtractingText(false);
    setShowPasteArea({
      peticao: false,
      contestacao: false,
      complementary: false
    });
    setExtractedTexts({
      peticoes: [],
      contestacoes: [],
      complementares: []
    });
    setShowTextPreview(false);

    // v1.12.18: Resetar modos de processamento
    setDocumentProcessingModes({
      peticoes: [],
      contestacoes: [],
      complementares: []
    });
  };

  // ğŸ¯ RETURN: Estados, Setters, Handlers e PersistÃªncia
  return {
    // Arquivos (3)
    peticaoFiles,
    contestacaoFiles,
    complementaryFiles,

    // Textos Colados (3)
    pastedPeticaoTexts,
    pastedContestacaoTexts,
    pastedComplementaryTexts,

    // Metadados (1)
    analyzedDocuments,

    // UI/Progresso (6)
    analyzing,
    analysisProgress,
    extractingText,
    showPasteArea,
    extractedTexts,
    showTextPreview,

    // v1.12.18: Modos de processamento por documento
    documentProcessingModes,

    // Setters Arquivos (3)
    setPeticaoFiles,
    setContestacaoFiles,
    setComplementaryFiles,

    // Setters Textos Colados (3)
    setPastedPeticaoTexts,
    setPastedContestacaoTexts,
    setPastedComplementaryTexts,

    // Setters Metadados (1)
    setAnalyzedDocuments,

    // Setters UI/Progresso (6)
    setAnalyzing,
    setAnalysisProgress,
    setExtractingText,
    setShowPasteArea,
    setExtractedTexts,
    setShowTextPreview,

    // v1.12.18: Setters de modos de processamento
    setDocumentProcessingModes,
    setPeticaoMode,
    setContestacaoMode,
    setComplementarMode,

    // Handlers (5) - ETAPA 7b
    handlePastedText,
    removePastedText,
    removePeticaoFile,
    handleUploadPeticao,
    handleUploadContestacao,
    handleUploadComplementary,

    // MÃ©todos de PersistÃªncia (3) - ETAPA 7c
    serializeForPersistence,
    restoreFromPersistence,
    clearAll
  };
};

// ğŸ¯ HOOK: useTopicManager (v1.36.64) - Gerenciador de tÃ³picos de decisÃ£o
// v1.36.64: Estado migrado para Zustand (useTopicsStore.ts)
const useTopicManager = () => {
  // Delega todo o estado e aÃ§Ãµes para o store Zustand
  return useTopicManagerCompat();
};

// ğŸ’¬ HOOK: useChatAssistant (v1.19.0) - Gerenciador de chat interativo para assistente IA
const useChatAssistant = (aiIntegration: { callAI?: CallAIFunction } | null) => {
  const [history, setHistory] = React.useState<ChatMessage[]>([]);
  const [generating, setGenerating] = React.useState(false);

  // Limpa histÃ³rico
  const clear = React.useCallback(() => setHistory([]), []);

  // Ãšltima resposta da IA
  const lastResponse = React.useMemo(() =>
    [...history].reverse().find(m => m.role === 'assistant')?.content || null
  , [history]);

  // Envia mensagem e atualiza histÃ³rico
  // ğŸ†• v1.19.5: Suporta contextBuilder assÃ­ncrono
  const send = React.useCallback(async (message: string, contextBuilder: (msg: string) => AIMessageContent[] | string | Promise<AIMessageContent[] | string>) => {
    if (!message?.trim()) return { success: false, error: 'Mensagem vazia' };
    if (!aiIntegration?.callAI) return { success: false, error: 'IA nÃ£o disponÃ­vel' };

    setGenerating(true);

    try {
      const apiMessages = [];
      // ğŸ†• v1.19.5: Calcular contexto antes (suporta async)
      let contextContent = null;

      if (history.length === 0) {
        // Primeira interaÃ§Ã£o: contexto completo + mensagem
        contextContent = await Promise.resolve(contextBuilder(message));
        apiMessages.push({
          role: 'user' as const,
          content: contextContent || ''
        });
      } else {
        // InteraÃ§Ãµes seguintes: reconstrÃ³i histÃ³rico completo
        // Primeira mensagem com contexto (para cache hit)
        apiMessages.push({
          role: 'user' as const,
          content: history[0].contentForApi || ''
        });

        // Resto do histÃ³rico
        for (let i = 1; i < history.length; i++) {
          apiMessages.push({
            role: history[i].role as 'user' | 'assistant',
            content: history[i].content
          });
        }

        // Nova mensagem
        apiMessages.push({
          role: 'user' as const,
          content: message
        });
      }

      // v1.21.26: Parametros para assistente interativo (criativo moderado)
      // v1.32.26: maxTokens aumentado para 16000 (respostas longas no chat)
      const response = await aiIntegration.callAI(apiMessages, {
        maxTokens: 16000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.5,
        topP: 0.9,
        topK: 80
      });

      const trimmedResponse = response.trim();

      // Atualiza histÃ³rico (com limite)
      setHistory(prev => {
        let newHistory: ChatMessage[];
        if (prev.length === 0) {
          // Primeira interaÃ§Ã£o: salvar content completo para cache
          newHistory = [
            { role: 'user', content: message, contentForApi: contextContent ?? undefined, ts: Date.now() },
            { role: 'assistant', content: trimmedResponse, ts: Date.now() }
          ];
        } else {
          // InteraÃ§Ãµes seguintes
          newHistory = [
            ...prev,
            { role: 'user', content: message, ts: Date.now() },
            { role: 'assistant', content: trimmedResponse, ts: Date.now() }
          ];
        }

        // Aplicar limite de mensagens (manter primeira msg com contexto + Ãºltimas N)
        if (newHistory.length > MAX_CHAT_HISTORY_MESSAGES) {
          const firstMsg = newHistory[0]; // Manter contexto
          const recentMsgs = newHistory.slice(-(MAX_CHAT_HISTORY_MESSAGES - 1));
          return [firstMsg, ...recentMsgs];
        }

        return newHistory;
      });

      return { success: true };

    } catch (err) {
      // Adiciona mensagem de erro ao histÃ³rico
      setHistory(prev => [
        ...prev,
        { role: 'user', content: message, ts: Date.now(), error: (err as Error).message }
      ]);
      return { success: false, error: (err as Error).message };
    } finally {
      setGenerating(false);
    }
  }, [history, aiIntegration]);

  return { history, generating, send, clear, lastResponse };
};

const useJurisprudencia = () => {
  const [precedentes, setPrecedentes] = React.useState<Precedente[]>([]);
  const [searchTerm, setSearchTerm] = React.useState('');
  const [filtros, setFiltros] = React.useState<FiltrosJuris>({ fonte: [], tipo: [] });
  const [currentPage, setCurrentPage] = React.useState(1);
  const [isLoading, setIsLoading] = React.useState(false);
  const [deleteAllConfirmText, setDeleteAllConfirmText] = React.useState('');
  const [copiedId, setCopiedId] = React.useState<string | null>(null);  // v1.36.54: Feedback visual copiar
  const itemsPerPage = 10;
  const searchTimeoutRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);

  const removeAccents = React.useCallback((str: string) =>
    str.normalize('NFD').replace(/[\u0300-\u036f]/g, ''), []);

  const searchPrecedentes = React.useCallback((term: string) => {
    if (!term?.trim()) return precedentes;
    const normalizedTerm = removeAccents(term.toLowerCase());
    const terms = normalizedTerm.split(/\s+/).filter(t => t.length > 2);
    return precedentes
      .map(p => {
        const teseNorm = removeAccents((p.tese || p.enunciado || '').toLowerCase());
        const keywordsNorm = removeAccents(Array.isArray(p.keywords) ? p.keywords.join(' ').toLowerCase() : (p.keywords || '').toLowerCase());
        const numeroNorm = (p.numeroProcesso || String(p.numero || '') || '').toLowerCase();
        let score = 0;
        for (const t of terms) {
          if (keywordsNorm.includes(t)) score += 10;
          if (teseNorm.includes(t)) score += 5;
          if (numeroNorm.includes(t)) score += 15;
        }
        return { precedente: p, score };
      })
      .filter(({ score }) => score > 0)
      .sort((a, b) => b.score - a.score)
      .map(({ precedente }) => precedente);
  }, [precedentes, removeAccents]);

  const filteredPrecedentes = React.useMemo(() => {
    let result = searchTerm ? searchPrecedentes(searchTerm) : precedentes;
    if (filtros.fonte.length > 0) {
      result = result.filter(p => p.category && filtros.fonte.includes(p.category));
    }
    if (filtros.tipo.length > 0) {
      result = result.filter(p => {
        if (!p.tipoProcesso) return false;
        if (filtros.tipo.includes('IRR') && isIRRType(p.tipoProcesso)) return true;
        return filtros.tipo.includes(p.tipoProcesso);
      });
    }
    if (filtros.tribunal && filtros.tribunal.length > 0) {
      const tribunalFilter = filtros.tribunal;
      result = result.filter(p => p.tribunal && tribunalFilter.includes(p.tribunal));
    }
    return result;
  }, [precedentes, searchTerm, filtros, searchPrecedentes]);

  const paginatedPrecedentes = React.useMemo(() => {
    const start = (currentPage - 1) * itemsPerPage;
    return filteredPrecedentes.slice(start, start + itemsPerPage);
  }, [filteredPrecedentes, currentPage]);

  const totalPages = Math.ceil(filteredPrecedentes.length / itemsPerPage);

  const handleSearchChange = React.useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const term = e.target.value;
    setSearchTerm(term);
    setCurrentPage(1);
  }, []);

  const handleImportJSON = React.useCallback(async (file: File) => {
    setIsLoading(true);
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      const items = Array.isArray(data) ? data : (data.precedentes || []);
      setPrecedentes(prev => {
        const existingMap = new Map(prev.map(p => [p.id, p]));
        for (const item of items) {
          existingMap.set(item.id, item);
        }
        return Array.from(existingMap.values());
      });
      await savePrecedentesToIndexedDB(items);
      return { success: true, count: items.length };
    } catch (err) {
      return { success: false, error: 'JSON invÃ¡lido' };
    } finally {
      setIsLoading(false);
    }
  }, []);

  const handleCopyTese = React.useCallback(async (precedente: Precedente) => {
    const tipo = precedente.tipoProcesso || '';
    const identificador = precedente.tema ? `Tema ${precedente.tema}` : (precedente.numero ? `nÂº ${precedente.numero}` : '');
    const titulo = precedente.titulo ? `\n${precedente.titulo}` : '';
    // v1.36.52: Adiciona fallback para fullText/texto (embeddings semÃ¢nticos nÃ£o tÃªm tese/enunciado)
    const conteudo = precedente.tese || precedente.enunciado || precedente.fullText || precedente.texto || '';
    const texto = `${tipo}${identificador ? ` - ${identificador}` : ''}${titulo}\n${conteudo}`;
    await navigator.clipboard.writeText(texto);
    // v1.36.54: Feedback visual
    setCopiedId(precedente.id);
    setTimeout(() => setCopiedId(null), 2000);
  }, []);

  const handleClearAll = React.useCallback(async () => {
    setPrecedentes([]);
    await clearPrecedentesFromIndexedDB();
  }, []);

  // v1.33.61: Recarregar precedentes do IndexedDB (usado apÃ³s download automÃ¡tico)
  const reloadPrecedentes = React.useCallback(async () => {
    const data = await loadPrecedentesFromIndexedDB();
    setPrecedentes(data);
    return data.length;
  }, []);

  React.useEffect(() => {
    loadPrecedentesFromIndexedDB().then(setPrecedentes);
  }, []);

  React.useEffect(() => {
    return () => {
      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);
    };
  }, []);

  return {
    precedentes,
    searchTerm,
    filtros,
    currentPage,
    totalPages,
    isLoading,
    paginatedPrecedentes,
    filteredCount: filteredPrecedentes.length,
    deleteAllConfirmText,
    setDeleteAllConfirmText,
    setFiltros,
    setCurrentPage,
    handleSearchChange,
    handleImportJSON,
    handleCopyTese,
    handleClearAll,
    reloadPrecedentes, // v1.33.61: Para atualizar apÃ³s download automÃ¡tico
    copiedId // v1.36.54: Feedback visual copiar
  };
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“œ HOOK: useLegislacao - GestÃ£o de artigos de leis
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const useLegislacao = () => {
  const [artigos, setArtigos] = React.useState<Artigo[]>([]);
  const [leisDisponiveis, setLeisDisponiveis] = React.useState<string[]>([]);
  const [leiAtiva, setLeiAtiva] = React.useState<string | null>(null);
  const [searchTerm, setSearchTerm] = React.useState('');
  const [currentPage, setCurrentPage] = React.useState(1);
  const [isLoading, setIsLoading] = React.useState(false);
  const [deleteConfirmText, setDeleteConfirmText] = React.useState('');
  const [copiedId, setCopiedId] = React.useState<string | null>(null);

  const ITEMS_PER_PAGE = 15;

  const removeAccents = React.useCallback((str: string) => {
    return str?.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase() || '';
  }, []);

  const searchArtigos = React.useCallback((term: string, lista: Artigo[]) => {
    if (!term?.trim()) return lista;
    const termNorm = removeAccents(term.trim());
    const terms = termNorm.split(/\s+/).filter(t => t.length > 1);
    const numeroMatch = term.match(/\d+[ÂºÂ°]?(?:-[a-z])?/i);

    return lista.map((artigo: Artigo) => {
      let score = 0;
      const caputNorm = removeAccents(artigo.caput || '');
      const numeroNorm = removeAccents(artigo.numero || '');
      const keywordsArr = Array.isArray(artigo.keywords) ? artigo.keywords : (artigo.keywords ? [artigo.keywords] : []);
      const keywordsNorm = keywordsArr.map((k: string) => removeAccents(k));
      // v1.21.1: Buscar tambÃ©m em parÃ¡grafos, incisos e alÃ­neas
      const paragrafosText = (artigo.paragrafos || []).map((p: { texto?: string }) => p.texto || '').join(' ');
      const incisosText = (artigo.incisos || []).map((i: { texto?: string }) => i.texto || '').join(' ');
      const alineasText = (artigo.alineas || []).map((a: { texto?: string }) => a.texto || '').join(' ');
      const subTextoNorm = removeAccents(paragrafosText + ' ' + incisosText + ' ' + alineasText);

      if (numeroMatch && numeroNorm.includes(removeAccents(numeroMatch[0]))) {
        score += 50;
      }

      for (const t of terms) {
        if (keywordsNorm.some((k: string) => k.includes(t))) score += 15;
        if (caputNorm.includes(t)) score += 10;
        if (subTextoNorm.includes(t)) score += 8; // parÃ¡grafos, incisos, alÃ­neas
        if (numeroNorm === t) score += 30;
      }

      return { artigo, score };
    })
    .filter(({ score }) => score > 0)
    .sort((a: { score: number }, b: { score: number }) => b.score - a.score)
    .map(({ artigo }) => artigo);
  }, [removeAccents]);

  const filteredArtigos = React.useMemo(() => {
    let result = artigos;
    if (leiAtiva) {
      result = result.filter(a => a.lei === leiAtiva || a.id?.startsWith(leiAtiva + '-'));
    }
    if (searchTerm?.trim()) {
      result = searchArtigos(searchTerm, result);
    }
    return result;
  }, [artigos, leiAtiva, searchTerm, searchArtigos]);

  const totalPages = Math.ceil(filteredArtigos.length / ITEMS_PER_PAGE);

  const paginatedArtigos = React.useMemo(() => {
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    return filteredArtigos.slice(start, start + ITEMS_PER_PAGE);
  }, [filteredArtigos, currentPage]);

  const handleImportJSON = React.useCallback(async (file: File) => {
    setIsLoading(true);
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      const items = Array.isArray(data) ? data : (data.artigos || []);

      if (items.length === 0) {
        throw new Error('Arquivo nÃ£o contÃ©m artigos vÃ¡lidos');
      }

      await saveArtigosToIndexedDB(items);
      const allArtigos = await loadArtigosFromIndexedDB();
      setArtigos(sortArtigosNatural(allArtigos));

      const leis = [...new Set(allArtigos.map(a => a.lei || a.id?.split('-art-')[0] || a.id?.split('-')[0]))].filter(Boolean);
      setLeisDisponiveis(leis.sort());
      setCurrentPage(1);

      return { success: true, count: items.length };
    } catch (err) {
      console.error('Erro ao importar JSON:', err);
      return { success: false, error: (err as Error).message };
    } finally {
      setIsLoading(false);
    }
  }, []);

  const handleCopyArtigo = React.useCallback(async (artigo: Artigo) => {
    try {
      const lei = getLeiFromId(artigo.id);
      let texto = `Art. ${artigo.numero} - ${lei.nome}\n${artigo.caput}`;

      if (artigo.paragrafos && artigo.paragrafos.length > 0) {
        texto += '\n';
        for (const p of artigo.paragrafos) {
          texto += `\nÂ§ ${p.numero}Âº ${p.texto}`;
        }
      }

      if (artigo.incisos && artigo.incisos.length > 0) {
        texto += '\n';
        for (const inc of artigo.incisos) {
          texto += `\n${inc.numero} - ${inc.texto}`;
        }
      }

      await navigator.clipboard.writeText(texto);
      setCopiedId(artigo.id);
      setTimeout(() => setCopiedId(null), 2000);
      return true;
    } catch (err) {
      console.error('Erro ao copiar:', err);
      return false;
    }
  }, []);

  const handleClearAll = React.useCallback(async () => {
    setArtigos([]);
    setLeisDisponiveis([]);
    setDeleteConfirmText('');
    await clearArtigosFromIndexedDB();
  }, []);

  // v1.33.61: Recarregar artigos do IndexedDB (usado apÃ³s download automÃ¡tico)
  const reloadArtigos = React.useCallback(async () => {
    const data = await loadArtigosFromIndexedDB();
    setArtigos(sortArtigosNatural(data));
    const leis = [...new Set(data.map(a => a.lei || a.id?.split('-art-')[0] || a.id?.split('-')[0]))].filter(Boolean);
    setLeisDisponiveis(leis.sort());
    return data.length;
  }, []);

  React.useEffect(() => {
    loadArtigosFromIndexedDB().then(data => {
      setArtigos(sortArtigosNatural(data));
      const leis = [...new Set(data.map(a => a.lei || a.id?.split('-art-')[0] || a.id?.split('-')[0]))].filter(Boolean);
      setLeisDisponiveis(leis.sort());
    });
  }, []);

  React.useEffect(() => {
    setCurrentPage(1);
  }, [searchTerm, leiAtiva]);

  return {
    artigos,
    leisDisponiveis,
    leiAtiva,
    setLeiAtiva,
    searchTerm,
    setSearchTerm,
    currentPage,
    setCurrentPage,
    totalPages,
    isLoading,
    filteredArtigos,
    paginatedArtigos,
    filteredCount: filteredArtigos.length,
    deleteConfirmText,
    setDeleteConfirmText,
    copiedId,
    handleImportJSON,
    handleCopyArtigo,
    handleClearAll,
    reloadArtigos // v1.33.61: Para atualizar apÃ³s download automÃ¡tico
  };
};

// ğŸ’¡ COMPONENTE: SpacingDropdown - Controle de espaÃ§amento de parÃ¡grafos
const SpacingDropdown = React.memo(({
  value,
  onChange,
  ariaLabel = 'EspaÃ§amento de parÃ¡grafo'
}: SpacingDropdownProps) => {
  // Classes de Tema (v1.9.39: Suporte a tema claro/escuro)
  const themeClasses = {
    select: 'theme-bg-secondary theme-text-primary theme-border-input',
    option: 'theme-bg-secondary theme-text-primary'
  };

  // Render
  return (
    <div className="relative">
      <select
        value={value}
        onChange={(e) => onChange(e.target.value as 'compact' | 'normal' | 'wide')}
        className={`px-2 py-1 border rounded text-sm cursor-pointer hover-border-blue-500 transition-colors ${themeClasses.select}`}
        aria-label={ariaLabel}
        title="EspaÃ§amento entre linhas e parÃ¡grafos"
      >
        {Object.entries(SPACING_PRESETS).map(([key, preset]) => (
          <option
            key={key}
            value={key}
            className={themeClasses.option}
          >
            {preset.icon} {preset.label}
          </option>
        ))}
      </select>
    </div>
  );
});

SpacingDropdown.displayName = 'SpacingDropdown';

// ğŸ’¡ COMPONENTE: FontSizeDropdown - Controle de tamanho de fonte v1.10.8
const FontSizeDropdown = React.memo(({
  value,
  onChange,
  ariaLabel = 'Tamanho da fonte'
}: FontSizeDropdownProps) => {
  const themeClasses = {
    select: 'theme-bg-secondary theme-text-primary theme-border-input',
    option: 'theme-bg-secondary theme-text-primary'
  };

  return (
    <div className="relative">
      <select
        value={value}
        onChange={(e) => onChange(e.target.value as 'small' | 'normal' | 'large')}
        className={`px-2 py-1 border rounded text-sm cursor-pointer hover-border-blue-500 transition-colors ${themeClasses.select}`}
        aria-label={ariaLabel}
        title="Tamanho da fonte do editor"
      >
        {Object.entries(FONTSIZE_PRESETS).map(([key, preset]) => (
          <option
            key={key}
            value={key}
            className={themeClasses.option}
          >
            {preset.icon} {preset.label}
          </option>
        ))}
      </select>
    </div>
  );
});

FontSizeDropdown.displayName = 'FontSizeDropdown';

// ğŸ’¡ COMPONENTE: VersionCompareModal - Modal de comparaÃ§Ã£o com diff visual
const VersionCompareModal = React.memo(({ oldContent, newContent, timestamp, onRestore, onClose }: { oldContent: string; newContent: string; timestamp: number; onRestore: () => void; onClose: () => void }) => {
  const stripHtml = (html: string) => (html || '').replace(/<[^>]*>/g, '');
  const oldText = stripHtml(oldContent);
  const newText = stripHtml(newContent);

  const formatTimeAgo = (ts: number) => {
    const diff = Math.floor((Date.now() - ts) / 60000);
    if (diff < 60) return `${diff} minuto${diff !== 1 ? 's' : ''}`;
    if (diff < 1440) return `${Math.floor(diff / 60)} hora${Math.floor(diff / 60) !== 1 ? 's' : ''}`;
    return `${Math.floor(diff / 1440)} dia${Math.floor(diff / 1440) !== 1 ? 's' : ''}`;
  };

  // Algoritmo LCS para diff por palavras
  const computeDiff = React.useMemo(() => {
    const oldWords = oldText.split(/(\s+)/);
    const newWords = newText.split(/(\s+)/);
    const m = oldWords.length, n = newWords.length;
    const lcs = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        lcs[i][j] = oldWords[i-1] === newWords[j-1] ? lcs[i-1][j-1] + 1 : Math.max(lcs[i-1][j], lcs[i][j-1]);
      }
    }
    const result = [];
    let i = m, j = n;
    while (i > 0 || j > 0) {
      if (i > 0 && j > 0 && oldWords[i-1] === newWords[j-1]) {
        result.unshift({ type: 'same', text: oldWords[i-1] });
        i--; j--;
      } else if (j > 0 && (i === 0 || lcs[i][j-1] >= lcs[i-1][j])) {
        result.unshift({ type: 'added', text: newWords[j-1] });
        j--;
      } else {
        result.unshift({ type: 'removed', text: oldWords[i-1] });
        i--;
      }
    }
    return result;
  }, [oldText, newText]);

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center overflow-auto" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
      <div className="theme-bg-secondary rounded-lg shadow-xl w-full max-w-3xl mx-4 my-auto">
        <div className="flex items-center justify-between p-4 border-b theme-border-primary">
          <h3 className="font-semibold theme-text-primary">Comparar VersÃµes</h3>
          <button onClick={onClose} className="text-xl theme-text-muted cursor-pointer">Ã—</button>
        </div>
        <div className="p-4">
          <div className="flex items-center gap-4 text-xs mb-3">
            <span className="theme-text-muted">VersÃ£o salva hÃ¡ {formatTimeAgo(timestamp)}</span>
            <span className="flex items-center gap-1"><span className="inline-block w-3 h-3 bg-red-200 rounded"></span> Removido</span>
            <span className="flex items-center gap-1"><span className="inline-block w-3 h-3 bg-green-200 rounded"></span> Adicionado</span>
          </div>
          <div className="border theme-border-input rounded p-3 max-h-80 overflow-auto text-sm theme-text-primary theme-bg-primary leading-relaxed">
            {computeDiff.map((item, i: number) => {
              if (item.type === 'removed') return <span key={i} className="bg-red-200 text-red-900 line-through">{item.text}</span>;
              if (item.type === 'added') return <span key={i} className="bg-green-200 text-green-900">{item.text}</span>;
              return <span key={i}>{item.text}</span>;
            })}
          </div>
          <div className="flex justify-end gap-2 mt-4">
            <button onClick={onClose} className="px-4 py-2 text-sm border rounded theme-border-input theme-text-primary cursor-pointer hover-slate-600">Cancelar</button>
            <button onClick={onRestore} className="px-4 py-2 text-sm rounded bg-blue-600 text-white cursor-pointer hover-blue-700">Restaurar VersÃ£o Anterior</button>
          </div>
        </div>
      </div>
    </div>
  );
});
VersionCompareModal.displayName = 'VersionCompareModal';

// ğŸ’¡ COMPONENTE: VersionSelect - BotÃ£o compacto com dropdown de versÃµes
const VersionSelect = React.memo(({ topicTitle, versioning, currentContent, onRestore, className = '' }: { topicTitle: string; versioning: { getVersions: (title: string) => Promise<FieldVersion[]> } | null; currentContent: string; onRestore: (content: string) => void; className?: string }) => {
  const [isOpen, setIsOpen] = React.useState(false);
  const [versions, setVersions] = React.useState<FieldVersion[]>([]);
  const [compareVersion, setCompareVersion] = React.useState<FieldVersion | null>(null);
  const dropdownRef = React.useRef<HTMLDivElement | null>(null);

  const loadVersions = React.useCallback(async () => {
    if (!versioning || !topicTitle) return;
    const v = await versioning.getVersions(topicTitle);
    setVersions(v);
  }, [versioning, topicTitle]);

  // Carregar versÃµes ao montar e quando topicTitle mudar
  React.useEffect(() => { loadVersions(); }, [loadVersions]);

  const formatTime = (ts: number) => {
    const diff = Math.floor((Date.now() - ts) / 60000);
    if (diff < 60) return `${diff}min`;
    if (diff < 1440) return `${Math.floor(diff / 60)}h`;
    return `${Math.floor(diff / 1440)}d`;
  };

  const handleToggle = async () => {
    if (!isOpen) await loadVersions();
    setIsOpen(!isOpen);
  };

  const handleVersionClick = (version: FieldVersion) => {
    setCompareVersion(version);
    setIsOpen(false);
  };

  const handleRestore = () => {
    if (compareVersion && onRestore) {
      onRestore(compareVersion.content);
      setCompareVersion(null);
      loadVersions();
    }
  };

  // Fechar ao clicar fora
  React.useEffect(() => {
    if (!isOpen) return;
    const handleClickOutside = (e: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target as Node)) setIsOpen(false);
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isOpen]);

  if (!versioning || !topicTitle) return null;

  return (
    <>
      <div ref={dropdownRef} className={`relative inline-block ${className}`}>
        <button
          onClick={handleToggle}
          className="px-2 py-1 text-xs border rounded theme-bg-secondary theme-text-primary theme-border-input cursor-pointer hover-slate-600 focus:ring-2 focus:ring-purple-500 focus:outline-none transition-all"
          title="HistÃ³rico de versÃµes"
        >
          ğŸ“œ {versions.length > 0 ? `(${versions.length})` : ''}
        </button>
        {isOpen && versions.length > 0 && (
          <div className="absolute right-0 mt-1 z-50 min-w-32 max-h-48 overflow-y-auto rounded border theme-border-input theme-bg-secondary shadow-lg">
            {versions.map(v => (
              <div
                key={v.id}
                onClick={() => handleVersionClick(v)}
                title={v.preview}
                className="px-3 py-2 text-xs cursor-pointer theme-text-primary hover-slate-600 border-b theme-border-input last:border-b-0"
              >
                ğŸ• {formatTime(v.timestamp)} atrÃ¡s
              </div>
            ))}
          </div>
        )}
        {isOpen && versions.length === 0 && (
          <div className="absolute right-0 mt-1 z-50 px-3 py-2 text-xs rounded border theme-border-input theme-bg-secondary theme-text-muted">
            Sem versÃµes salvas
          </div>
        )}
      </div>
      {compareVersion && (
        <VersionCompareModal
          oldContent={compareVersion.content}
          newContent={currentContent}
          timestamp={compareVersion.timestamp}
          onRestore={handleRestore}
          onClose={() => setCompareVersion(null)}
        />
      )}
    </>
  );
});

VersionSelect.displayName = 'VersionSelect';

// ğŸ’¡ COMPONENTE: SuggestionCard - Card de sugestÃ£o de modelo
const SuggestionCard = React.memo(({
  model,
  index = 0,
  totalSuggestions = 5,
  onPreview,
  onInsert,
  sanitizeHTML,
  showRanking = true,
  similarity, // v1.33.18: % similaridade (opcional, vem de busca semÃ¢ntica)
}: SuggestionCardProps) => {
  // ValidaÃ§Ã£o de Props
  if (!model) {
    return null;
  }

  // CÃ¡lculo de Estrelas (5 para 1Âº, 4 para 2Âº, etc.)
  const stars = showRanking ? Math.max(1, totalSuggestions - index) : 0;

  // Preview Sanitizado (Memoizado para Performance)
  const sanitizedPreview = React.useMemo(
    () => sanitizeHTML ? sanitizeHTML(model.content?.substring(0, 300) || '') : (model.content?.substring(0, 300) || ''),
    [model.content, sanitizeHTML]
  );

  // Labels de Ranking
  const rankingLabels: Record<number, string> = {
    5: 'Mais relevante',
    4: '2Âº lugar',
    3: '3Âº lugar',
    2: '4Âº lugar',
    1: '5Âº lugar',
  };

  // v1.4.8: Hovers otimizados (sem state, manipulaÃ§Ã£o direta do DOM)
  // Removidos states previewHover/insertHover para evitar re-renders

  return (
    <div className="theme-bg-secondary-50 p-4 rounded-lg border theme-border-input hover-theme-border transition-all card-hover-lift">

      {/* â”€â”€â”€ Header: TÃ­tulo + Categoria + Favorito â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="flex items-start justify-between mb-2">
        <div className="flex-1">
          <h5 className="theme-text-primary font-semibold text-sm mb-1">
            {model.title}
          </h5>

          {/* Ranking com Estrelas */}
          {showRanking && stars > 0 && (
            <div className="flex items-center gap-2 mb-1">
              <span className="text-yellow-400 text-xs">
                {'â­'.repeat(stars)}
              </span>
              <span className="text-yellow-400/80 text-xs">
                ({rankingLabels[stars]})
              </span>
            </div>
          )}
          {/* v1.33.20: Badge de similaridade (independente do ranking) */}
          {similarity && (
            <span className="text-xs px-1.5 py-0.5 rounded bg-green-600 text-white inline-block mb-1 animate-badge">
              {Math.round(similarity * 100)}% similar
            </span>
          )}
        </div>

        {/* Badge de Categoria */}
        {model.category && (
          <span className="px-2 py-1 theme-bg-purple-accent theme-text-purple rounded text-xs ml-2 max-w-[120px] truncate" title={model.category}>
            {model.category}
          </span>
        )}

        {/* Ãcone de Favorito */}
        {model.favorite && (
          <span className="text-yellow-400 ml-1" title="Modelo favorito">â˜…</span>
        )}
      </div>

      {/* â”€â”€â”€ Keywords â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */}
      {model.keywords && (
        <div className="theme-text-muted text-xs mb-2">
          ğŸ·ï¸ {model.keywords}
        </div>
      )}

      {/* â”€â”€â”€ Preview do ConteÃºdo (3 linhas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */}
      <div
        className="theme-text-muted text-xs mb-3 line-clamp-3"
        dangerouslySetInnerHTML={{ __html: sanitizedPreview }}
      />

      {/* â”€â”€â”€ BotÃµes de AÃ§Ã£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */}
      <div className="flex gap-2">

        {/* BotÃ£o Visualizar */}
        <button
          onClick={() => onPreview(model)}
          className="flex-1 py-2 border border-blue-500 text-blue-400 rounded text-sm font-medium flex items-center justify-center gap-2 hover-blue-alpha-10-from-transparent"
          aria-label={`Visualizar modelo ${model.title}`}
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          Visualizar
        </button>

        {/* BotÃ£o Inserir */}
        <button
          onClick={() => onInsert(model.content)}
          className="hover-suggestion-insert flex-1 py-2 text-white rounded text-sm font-medium"
          aria-label={`Inserir modelo ${model.title} no editor`}
        >
          Inserir
        </button>
      </div>
    </div>
  );
});

SuggestionCard.displayName = 'SuggestionCard';

// ğŸ”€ COMPONENTE: SplitDivider (v1.9.21) - Divisor arrastÃ¡vel para split window
const SplitDivider = React.memo(({ onDragStart }: { onDragStart: (e: React.MouseEvent) => void }) => {
  const handleMouseDown = React.useCallback((e: React.MouseEvent) => {
    e.preventDefault();
    onDragStart(e);
  }, [onDragStart]);

  return (
    <div
      className="split-divider"
      onMouseDown={handleMouseDown}
    >
      <div className="split-divider-handle">
        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M8 5h2v14H8zM14 5h2v14h-2z" />
        </svg>
      </div>
    </div>
  );
});

SplitDivider.displayName = 'SplitDivider';

// ğŸ“š COMPONENTE: FullscreenModelPanel (v1.9.32) - SugestÃµes de modelos em split
const FullscreenModelPanel = React.memo(({
  models,
  topicTitle = '',
  topicCategory = '',
  topicRelatorio = '',
  onInsert,
  onPreview,
  sanitizeHTML,
  onFindSuggestions
}: FullscreenModelPanelProps) => {
  const [searchTerm, setSearchTerm] = React.useState('');
  const [searchResults, setSearchResults] = React.useState<Model[]>([]);
  const [suggestions, setSuggestions] = React.useState<Model[]>([]);
  const [suggestionsSource, setSuggestionsSource] = React.useState<string | null>(null); // v1.28.04
  const [loading, setLoading] = React.useState(false);

  // Stopwords para scoring local (fallback se IA nÃ£o disponÃ­vel)
  const STOPWORDS = React.useMemo(() => new Set([
    'de', 'da', 'do', 'das', 'dos', 'em', 'na', 'no', 'nas', 'nos', 'para', 'por', 'com', 'sem',
    'o', 'a', 'os', 'as', 'e', 'ou', 'mas', 'que', 'qual', 'quando', 'onde', 'como'
  ]), []);

  // FunÃ§Ã£o de scoring local (fallback)
  const scoreModelLocal = React.useCallback((model: Model) => {
    if (!topicTitle) return 0;
    let score = 0;

    const titleLower = topicTitle.toLowerCase();
    const modelTitleLower = (model.title || '').toLowerCase();

    const titleWords = titleLower.split(/\s+/).filter((w: string) => w.length > 2 && !STOPWORDS.has(w));
    const modelWords = modelTitleLower.split(/\s+/).filter((w: string) => w.length > 2 && !STOPWORDS.has(w));

    titleWords.forEach((titleWord: string) => {
      if (modelWords.includes(titleWord)) score += 10;
    });

    titleWords.forEach((titleWord: string) => {
      modelWords.forEach((modelWord: string) => {
        if (titleWord !== modelWord && (titleWord.includes(modelWord) || modelWord.includes(titleWord))) {
          score += 5;
        }
      });
    });

    if (model.category && topicCategory && model.category.toUpperCase() === topicCategory.toUpperCase()) {
      score += 8;
    }

    if (model.keywords) {
      const keywordsStr = Array.isArray(model.keywords) ? model.keywords.join(',') : model.keywords;
      const keywords = keywordsStr.toLowerCase().split(',').map((k: string) => k.trim()).filter((k: string) => k.length > 0);
      keywords.forEach((keyword: string) => {
        if (titleLower.includes(keyword) || keyword.includes(titleLower.replace(/\s+/g, ''))) {
          score += 12;
        }
      });
    }

    return score;
  }, [topicTitle, topicCategory, STOPWORDS]);

  React.useEffect(() => {
    if (!models || models.length === 0 || !topicTitle) {
      setSuggestions([]);
      return;
    }

    // Se temos funÃ§Ã£o de IA, usar ela
    if (onFindSuggestions) {
      setLoading(true);
      // v1.28.06: Yield para UI nÃ£o travar + async para aguardar
      (async () => {
        await new Promise(r => setTimeout(r, 0));
        try {
          const result = await onFindSuggestions({
            title: topicTitle,
            category: (topicCategory || 'MÃ‰RITO') as TopicCategory,
            relatorio: topicRelatorio || ''
          });
          // v1.28.04: Suporta novo formato { suggestions, source }
          if (result?.suggestions) {
            setSuggestions(result.suggestions);
            setSuggestionsSource(result.source);
          } else if (Array.isArray(result)) {
            setSuggestions(result);
            setSuggestionsSource(null);
          } else {
            setSuggestions([]);
            setSuggestionsSource(null);
          }
        } catch (err) {
          // Fallback para scoring local em caso de erro
          type ScoredModel = Model & { score: number };
          const scoredModels = models
            .map((m: Model): ScoredModel => ({ ...m, score: scoreModelLocal(m) }))
            .filter((m: ScoredModel) => m.score > 0)
            .sort((a: ScoredModel, b: ScoredModel) => b.score - a.score)
            .slice(0, 5);
          setSuggestions(scoredModels);
          setSuggestionsSource(null);
        } finally {
          setLoading(false);
        }
      })();
    } else {
      // Fallback: scoring local
      type ScoredModel = Model & { score: number };
      const scoredModels = models
        .map((m: Model): ScoredModel => ({ ...m, score: scoreModelLocal(m) }))
        .filter((m: ScoredModel) => m.score > 0)
        .sort((a: ScoredModel, b: ScoredModel) => b.score - a.score)
        .slice(0, 5);
      setSuggestions(scoredModels);
    }
  }, [models, topicTitle, topicCategory, topicRelatorio, onFindSuggestions, scoreModelLocal]);

  // Busca manual com debounce
  const searchTimeoutRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);

  const handleSearchChange = React.useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const term = e.target.value;
    setSearchTerm(term);

    // Debounce 300ms
    if (searchTimeoutRef.current) {
      clearTimeout(searchTimeoutRef.current);
    }

    searchTimeoutRef.current = setTimeout(() => {
      if (!term.trim()) {
        setSearchResults([]);
        return;
      }

      const termLower = term.toLowerCase();
      const results = (models || [])
        .filter((m: Model) => {
          const titleMatch = (m.title || '').toLowerCase().includes(termLower);
          const kwStr = Array.isArray(m.keywords) ? m.keywords.join(' ') : (m.keywords || '');
          const keywordsMatch = kwStr.toLowerCase().includes(termLower);
          const contentMatch = (m.content || '').toLowerCase().includes(termLower);
          return titleMatch || keywordsMatch || contentMatch;
        })
        .slice(0, 10); // Max 10 resultados

      setSearchResults(results);
    }, 300);
  }, [models]);

  // Cleanup timeout on unmount
  React.useEffect(() => {
    return () => {
      if (searchTimeoutRef.current) {
        clearTimeout(searchTimeoutRef.current);
      }
    };
  }, []);

  return (
    <div className="model-search-panel">
      {/* Header */}
      <div className="p-3 border-b theme-border-primary">
        <h3 className="text-sm font-semibold theme-text-primary mb-2 flex items-center gap-2">
          <BookOpen className="w-4 h-4" />
          Modelos Sugeridos
        </h3>

        {/* Campo de busca */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 theme-text-muted" />
          <input
            type="text"
            value={searchTerm}
            onChange={handleSearchChange}
            onKeyDown={(e) => e.key === 'Escape' && handleSearchChange({ target: { value: '' } } as React.ChangeEvent<HTMLInputElement>)}
            placeholder="Buscar modelos..."
            className="w-full pl-9 pr-8 py-2 text-sm rounded theme-bg-secondary theme-border-input border theme-text-primary"
          />
          {searchTerm && (
            <button onClick={() => handleSearchChange({ target: { value: '' } } as React.ChangeEvent<HTMLInputElement>)} className="absolute right-2 top-1/2 -translate-y-1/2 p-0.5 theme-text-muted hover-text-primary" title="Limpar (Esc)">
              <X className="w-3.5 h-3.5" />
            </button>
          )}
        </div>
      </div>

      {/* ConteÃºdo scrollÃ¡vel */}
      <div className="flex-1 overflow-y-auto p-3 space-y-3">

        {/* Resultados da busca manual (se houver) */}
        {searchResults.length > 0 && (
          <div>
            <h4 className="text-xs font-medium theme-text-muted mb-2 flex items-center gap-1">
              <Search className="w-3 h-3" />
              Resultados da Busca ({searchResults.length})
            </h4>
            <div className="space-y-2">
              {searchResults.map((model: Model) => (
                <SuggestionCard
                  key={`search-${model.id}`}
                  model={model}
                  similarity={model.similarity}
                  onPreview={onPreview}
                  onInsert={onInsert}
                  sanitizeHTML={sanitizeHTML}
                  showRanking={false}
                />
              ))}
            </div>
          </div>
        )}

        {/* Separador se houver busca e sugestÃµes */}
        {searchResults.length > 0 && suggestions.length > 0 && (
          <div className="border-t theme-border-primary my-3" />
        )}

        {/* v1.9.32: Loading da IA */}
        {loading ? (
          <div className="flex flex-col items-center justify-center py-8">
            <div className="w-8 h-8 border-2 border-purple-500 border-t-transparent rounded-full animate-spin mb-3"></div>
            <p className="text-sm theme-text-muted">Analisando modelos com IA...</p>
          </div>
        ) : suggestions.length > 0 ? (
          <div>
            <h4 className="text-xs font-medium theme-text-muted mb-2 flex items-center gap-2">
              <Sparkles className="w-3 h-3" />
              SugestÃµes para "{topicTitle}" ({suggestions.length})
              {suggestionsSource === 'local' && <span className="bg-purple-600 text-white px-1.5 py-0.5 rounded text-[10px]">ğŸ¤– IA Local</span>}
            </h4>
            <div className="space-y-2">
              {suggestions.map((model, idx) => (
                <SuggestionCard
                  key={`suggestion-${model.id}`}
                  model={model}
                  similarity={model.similarity}
                  index={idx}
                  totalSuggestions={suggestions.length}
                  onPreview={onPreview}
                  onInsert={onInsert}
                  sanitizeHTML={sanitizeHTML}
                  showRanking={true}
                />
              ))}
            </div>
          </div>
        ) : !searchResults.length && (
          <p className="text-sm theme-text-muted text-center py-4">
            {topicTitle
              ? 'Nenhuma sugestÃ£o encontrada para este tÃ³pico'
              : 'Selecione um tÃ³pico para ver sugestÃµes'}
          </p>
        )}
      </div>

      {/* Footer com contagem */}
      <div className="p-2 border-t theme-border-primary text-xs theme-text-muted text-center">
        {searchResults.length > 0
          ? `${searchResults.length} resultado(s) da busca`
          : `${suggestions.length} sugestÃ£o(Ãµes) automÃ¡tica(s)`}
      </div>
    </div>
  );
}, (prevProps, nextProps) => {
  return (
    prevProps.models === nextProps.models &&
    prevProps.topicTitle === nextProps.topicTitle &&
    prevProps.topicCategory === nextProps.topicCategory &&
    prevProps.topicRelatorio === nextProps.topicRelatorio &&
    prevProps.onInsert === nextProps.onInsert &&
    prevProps.onPreview === nextProps.onPreview &&
    prevProps.sanitizeHTML === nextProps.sanitizeHTML &&
    prevProps.onFindSuggestions === nextProps.onFindSuggestions
  );
});

FullscreenModelPanel.displayName = 'FullscreenModelPanel';

// ğŸ“š COMPONENTE: ModelSearchPanel (v1.9.23) - Busca de modelos em split
const ModelSearchPanel = React.memo(({
  models,
  onInsert,
  onPreview,
  sanitizeHTML
}: ModelSearchPanelProps) => {
  const [searchTerm, setSearchTerm] = React.useState('');
  const [selectedCategory, setSelectedCategory] = React.useState('all');

  const filteredModels = React.useMemo(() => {
    return (models || []).filter((m: Model) => {
      const matchesSearch = !searchTerm ||
        (m.title || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
        (Array.isArray(m.keywords) ? m.keywords.join(' ') : (m.keywords || '')).toLowerCase().includes(searchTerm.toLowerCase());
      const matchesCategory = selectedCategory === 'all' || m.category === selectedCategory;
      return matchesSearch && matchesCategory;
    });
  }, [models, searchTerm, selectedCategory]);

  const categories = React.useMemo(() => {
    const cats = new Set((models || []).map((m: Model) => m.category).filter(Boolean));
    return ['all', ...Array.from(cats)];
  }, [models]);

  return (
    <div className="model-search-panel">
      {/* Header */}
      <div className="p-3 border-b theme-border-primary">
        <h3 className="text-sm font-semibold theme-text-primary mb-2 flex items-center gap-2">
          <BookOpen className="w-4 h-4" />
          Biblioteca de Modelos
        </h3>

        {/* Campo de busca */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 theme-text-muted" />
          <input
            type="text"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            onKeyDown={(e) => e.key === 'Escape' && setSearchTerm('')}
            placeholder="Buscar por tÃ­tulo ou palavras-chave..."
            className="w-full pl-9 pr-8 py-2 text-sm rounded theme-bg-secondary theme-border-input border theme-text-primary"
          />
          {searchTerm && (
            <button onClick={() => setSearchTerm('')} className="absolute right-2 top-1/2 -translate-y-1/2 p-0.5 theme-text-muted hover-text-primary" title="Limpar (Esc)">
              <X className="w-3.5 h-3.5" />
            </button>
          )}
        </div>

        {/* Filtro de categoria */}
        <select
          value={selectedCategory}
          onChange={(e) => setSelectedCategory(e.target.value)}
          className="w-full mt-2 px-3 py-2 text-sm rounded theme-bg-secondary theme-border-input border theme-text-primary"
        >
          {categories.map(cat => (
            <option key={cat} value={cat}>
              {cat === 'all' ? 'Todas as categorias' : cat}
            </option>
          ))}
        </select>
      </div>

      {/* Lista de modelos */}
      <div className="flex-1 overflow-y-auto p-3 space-y-2">
        {filteredModels.length === 0 ? (
          <p className="text-sm theme-text-muted text-center py-4">
            Nenhum modelo encontrado
          </p>
        ) : (
          filteredModels.map((model: Model) => (
            <div
              key={model.id}
              className="p-3 rounded border theme-border-primary theme-bg-secondary"
            >
              <h4 className="text-sm font-medium theme-text-primary truncate">
                {model.title}
              </h4>
              {model.keywords && (
                <p className="text-xs theme-text-muted mt-1 truncate">
                  {model.keywords}
                </p>
              )}
              <div
                className="text-xs theme-text-secondary mt-2 line-clamp-2"
                dangerouslySetInnerHTML={{ __html: sanitizeHTML ? sanitizeHTML(model.content || '').substring(0, 150) + '...' : '' }}
              />
              <div className="flex gap-2 mt-2">
                <button
                  onClick={() => onPreview && onPreview(model)}
                  className="flex-1 px-2 py-1.5 text-xs rounded theme-bg-tertiary theme-text-primary hover-slate-600 flex items-center justify-center gap-1"
                >
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  Ver
                </button>
                <button
                  onClick={() => onInsert && onInsert(model.content)}
                  className="flex-1 px-2 py-1.5 text-xs rounded bg-blue-600 text-white hover-blue-700 flex items-center justify-center gap-1"
                >
                  <Plus className="w-3 h-3" />
                  Inserir
                </button>
              </div>
            </div>
          ))
        )}
      </div>

      {/* Footer com contagem */}
      <div className="p-2 border-t theme-border-primary text-xs theme-text-muted text-center">
        {filteredModels.length} modelo(s) encontrado(s)
      </div>
    </div>
  );
}, (prevProps, nextProps) => {
  return (
    prevProps.models === nextProps.models &&
    prevProps.onInsert === nextProps.onInsert &&
    prevProps.onPreview === nextProps.onPreview &&
    prevProps.sanitizeHTML === nextProps.sanitizeHTML
  );
});

ModelSearchPanel.displayName = 'ModelSearchPanel';

// ğŸ´ COMPONENTE: TopicCard (v1.2.7) - Card de tÃ³pico com drag-and-drop

// ğŸ†• v1.12.18: Seletor de modo de processamento de PDF
// Componente reutilizÃ¡vel para selecionar como o PDF serÃ¡ processado antes de enviar para a IA
// v1.14.1: Restaurado PDF Puro como opÃ§Ã£o (config global Ã© apenas padrÃ£o, usuÃ¡rio pode mudar por arquivo)
// v1.32.13: anonymizationEnabled bloqueia apenas modos que nÃ£o extraem texto (claude-vision, pdf-puro)
// v1.36.36: grokEnabled bloqueia apenas pdf-puro (Grok nÃ£o suporta binÃ¡rio, mas texto ok)
const ProcessingModeSelector = React.memo(({ value, onChange, disabled = false, anonymizationEnabled = false, grokEnabled = false, className = '' }: ProcessingModeSelectorProps) => {
  // Grok: sÃ³ bloqueia pdf-puro | AnonimizaÃ§Ã£o: bloqueia pdf-puro E claude-vision
  const isPdfPuroBlocked = anonymizationEnabled || grokEnabled;
  const isClaudeVisionBlocked = anonymizationEnabled;

  // Determinar valor efetivo (fallback para pdfjs se bloqueado)
  const blockedModes = [
    ...(isPdfPuroBlocked ? ['pdf-puro'] : []),
    ...(isClaudeVisionBlocked ? ['claude-vision'] : [])
  ];
  const isValueBlocked = blockedModes.includes(value);
  const effectiveValue = isValueBlocked ? 'pdfjs' : (value || 'pdfjs');

  // Labels com motivo do bloqueio
  const getPdfPuroLabel = () => {
    if (anonymizationEnabled) return 'ğŸ”’ PDF BinÃ¡rio (anonimizaÃ§Ã£o)';
    if (grokEnabled) return 'ğŸ”’ PDF BinÃ¡rio (Grok)';
    return 'PDF Puro (binÃ¡rio)';
  };

  const getTitle = () => {
    if (anonymizationEnabled) return 'AnonimizaÃ§Ã£o ativa: modos binÃ¡rios bloqueados';
    if (grokEnabled) return 'Grok nÃ£o suporta PDF binÃ¡rio';
    return undefined;
  };

  return (
    <select
      value={effectiveValue}
      onChange={(e) => onChange(e.target.value as ProcessingMode)}
      disabled={disabled}
      title={getTitle()}
      className={`text-xs theme-bg-secondary theme-border-input border rounded px-2 py-1 cursor-pointer theme-text-primary hover-border-blue-500 transition-colors ${className}`}
      onClick={(e) => e.stopPropagation()}
    >
      <option value="pdfjs" className="theme-bg-secondary theme-text-primary">PDF.js (Texto)</option>
      <option value="tesseract" className="theme-bg-secondary theme-text-primary">Tesseract OCR (Offline)</option>
      <option value="claude-vision" className="theme-bg-secondary theme-text-primary" disabled={isClaudeVisionBlocked}>{isClaudeVisionBlocked ? 'ğŸ”’ Claude Vision' : 'Claude Vision (API)'}</option>
      <option value="pdf-puro" className="theme-bg-secondary theme-text-primary" disabled={isPdfPuroBlocked}>{getPdfPuroLabel()}</option>
    </select>
  );
});

// v1.33.58: TopicCard refatorado para dnd-kit (isDragging/isOver ao invÃ©s de handlers HTML5)
const TopicCard = React.memo(({
  topic,
  selectedIdx,
  topicRefs,
  lastEditedTopicTitle,
  isDragging,  // v1.33.58: dnd-kit
  isOver,      // v1.33.58: dnd-kit
  selectedTopics,
  extractedTopics,
  topicsToMerge,
  toggleTopicSelection,
  moveTopicUp,
  moveTopicDown,
  moveTopicToPosition,
  setSelectedTopics,
  setExtractedTopics,
  startEditing,
  setTopicToRename,
  setNewTopicName,
  openModal,
  setTopicToSplit,
  setTopicsToMerge
}: TopicCardProps) => {
  const isRelatorioOrDispositivo = isSpecialTopic(topic);

  // Helper para verificar se o tÃ³pico estÃ¡ decidido (v1.3.5.1 - bug fix)
  const isDecidido = () => {
    // DISPOSITIVO usa editedContent
    if (isDispositivo(topic)) {
      return topic.editedContent && topic.editedContent.trim() !== '';
    }
    if (isRelatorio(topic)) {
      return (topic.editedRelatorio && topic.editedRelatorio.trim() !== '') ||
             (topic.relatorio && topic.relatorio.trim() !== '');
    }
    // TÃ³picos normais precisam de conteÃºdo E resultado selecionado
    const temConteudo = topic.editedFundamentacao && topic.editedFundamentacao.trim() !== '';
    const temResultado = topic.resultado && topic.resultado.trim() !== '';
    return temConteudo && temResultado;
  };

  // v1.33.58: Removido draggable e handlers HTML5 - agora controlado pelo SortableTopicCard
  return (
    <div
      key={topic.title}
      ref={(el) => { topicRefs.current[topic.title] = el; }}
      className={`hover-topic-drag-area rounded-lg p-3 border-2 transition-all duration-300 ${
        isRelatorioOrDispositivo ? 'cursor-default' : 'cursor-move'
      } ${
        lastEditedTopicTitle === topic.title
          ? 'border-green-500 shadow-lg shadow-green-500/20'
          : isDragging
            ? 'border-blue-500 shadow-2xl shadow-blue-500/40'
            : isOver
              ? 'border-purple-500 shadow-xl shadow-purple-500/30'
              : 'border-blue-500 card-hover-lift'
      }`}
      style={{ backgroundColor: 'rgba(37, 99, 235, 0.1)' }}
    >
      <div className="flex items-center gap-3">
        {/* Checkbox para desselecionar - nÃ£o mostrar para RELATÃ“RIO e DISPOSITIVO */}
        {!isRelatorioOrDispositivo && (
          <input
            type="checkbox"
            checked={true}
            onChange={(e) => {
              e.stopPropagation();
              toggleTopicSelection(topic);
            }}
            className="w-5 h-5 rounded flex-shrink-0 cursor-pointer"
            title="Desmarcar tÃ³pico"
          />
        )}

        {/* Ãcone de arrastar - nÃ£o mostrar para RELATÃ“RIO e DISPOSITIVO */}
        {!isRelatorioOrDispositivo && (
          <div className="flex-shrink-0 cursor-grab active:cursor-grabbing">
            <GripVertical className={`w-5 h-5 transition-colors ${
              isDragging ? 'text-blue-400' : 'theme-text-muted hover-theme-text-secondary'
            }`} />
          </div>
        )}

        {/* Controles de posiÃ§Ã£o - nÃ£o mostrar para RELATÃ“RIO e DISPOSITIVO */}
        {!isRelatorioOrDispositivo && (
          <div className="flex flex-col gap-1">
            <button
              onClick={() => moveTopicUp(selectedIdx)}
              disabled={selectedIdx === 0}
              className="p-1 rounded disabled:opacity-40 disabled:cursor-not-allowed hover-slate-600 bg-transparent transition-all duration-200"
            >
              <ChevronUp className="w-4 h-4" />
            </button>
            <input
              type="number"
              min="1"
              max={selectedTopics.length}
              value={selectedIdx + 1}
              className="w-12 theme-bg-primary border theme-border-input rounded text-center text-xs py-1 theme-text-primary"
              onKeyDown={(e) => {
                if (e.key === 'Enter') {
                  const newPos = parseInt((e.target as HTMLInputElement).value);
                  moveTopicToPosition(selectedIdx, newPos);
                }
              }}
              onChange={(e) => {
                const newPos = parseInt(e.target.value);
                if (!isNaN(newPos)) {
                  moveTopicToPosition(selectedIdx, newPos);
                }
              }}
            />
            <button
              onClick={() => moveTopicDown(selectedIdx)}
              disabled={selectedIdx === selectedTopics.length - 1}
              className="p-1 rounded disabled:opacity-40 disabled:cursor-not-allowed hover-slate-600 bg-transparent transition-all duration-200"
            >
              <ChevronDown className="w-4 h-4" />
            </button>
          </div>
        )}

        {/* Badge de posiÃ§Ã£o fixa para RELATÃ“RIO e DISPOSITIVO */}
        {isRelatorioOrDispositivo && (
          <div className="flex items-center gap-2 px-3 py-2 theme-bg-purple-accent border border-purple-500/30 rounded-lg">
            <span className="text-xs theme-text-purple font-medium">
              ğŸ“Œ PosiÃ§Ã£o Fixa
            </span>
          </div>
        )}

        {/* ConteÃºdo do tÃ³pico */}
        <div className="flex-1">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2 flex-wrap">
              {/* Seletor de categoria - editÃ¡vel (nÃ£o mostrar para RELATÃ“RIO e DISPOSITIVO) */}
              {!isRelatorioOrDispositivo && (
                <select
                  value={topic.category || 'MÃ‰RITO'}
                  onChange={(e) => {
                    const newTopics = [...selectedTopics];
                    newTopics[selectedIdx] = { ...topic, category: e.target.value as TopicCategory };
                    setSelectedTopics(newTopics);

                    // Atualizar tambÃ©m em extractedTopics se existir
                    const extractedIndex = extractedTopics.findIndex((t: Topic) => t.title === topic.title);
                    if (extractedIndex !== -1) {
                      const newExtracted = [...extractedTopics];
                      newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], category: e.target.value as TopicCategory };
                      setExtractedTopics(newExtracted);
                    }
                  }}
                  onClick={(e) => e.stopPropagation()}
                  className="text-xs px-2 py-1 rounded cursor-pointer font-medium focus:outline-none focus:ring-2 focus:ring-blue-400 border-2 border-blue-500 hover-blue-700 bg-blue-600 text-white transition-colors duration-200"
                  title="Clique para alterar a categoria"
                >
                  <option value="PRELIMINAR">ğŸ“‹ Preliminar</option>
                  <option value="PREJUDICIAL">âš ï¸ Prejudicial</option>
                  <option value="MÃ‰RITO">âš–ï¸ MÃ©rito</option>
                  <option value="PROCESSUAL">ğŸ“ Processual</option>
                </select>
              )}

              <h4 className="font-semibold theme-text-primary">{topic.title.toUpperCase()}</h4>
              <span className="text-xs theme-bg-blue-accent theme-text-blue px-2 py-1 rounded">
                #{selectedIdx + 1}
              </span>

              {/* Seletor de resultado do julgamento - nÃ£o mostrar para RELATÃ“RIO e DISPOSITIVO */}
              {topic.title.toUpperCase() !== 'RELATÃ“RIO' && topic.title.toUpperCase() !== 'DISPOSITIVO' && (
                <select
                  value={topic.resultado || ''}
                  onChange={(e) => {
                    const newTopics = [...selectedTopics];
                    // Marcar como escolha manual se usuÃ¡rio selecionar algo (nÃ£o vazio)
                    const resultadoManual = e.target.value !== '';
                    newTopics[selectedIdx] = {
                      ...topic,
                      resultado: (e.target.value || undefined) as TopicResultado | undefined,
                      resultadoManual
                    };
                    setSelectedTopics(newTopics);

                    // Atualizar tambÃ©m em extractedTopics se existir
                    const extractedIndex = extractedTopics.findIndex((t: Topic) => t.title === topic.title);
                    if (extractedIndex !== -1) {
                      const newExtracted = [...extractedTopics];
                      newExtracted[extractedIndex] = {
                        ...newExtracted[extractedIndex],
                        resultado: (e.target.value || undefined) as TopicResultado | undefined,
                        resultadoManual
                      };
                      setExtractedTopics(newExtracted);
                    }
                  }}
                  onClick={(e) => e.stopPropagation()}
                  className="text-xs px-3 py-1 rounded border-2 theme-bg-secondary cursor-pointer font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                  style={getResultadoStyle(topic.resultado)}
                >
                  <option value="">âš–ï¸ Selecione o resultado...</option>
                  <option value="PROCEDENTE">âœ… Procedente</option>
                  <option value="IMPROCEDENTE">âŒ Improcedente</option>
                  <option value="PARCIALMENTE PROCEDENTE">âš–ï¸ Parcialmente Procedente</option>
                  <option value="ACOLHIDO">âœ… Acolhido/Reconhecido</option>
                  <option value="REJEITADO">âŒ Rejeitado/Indeferido</option>
                  <option value="SEM RESULTADO">â¸ï¸ Sem Resultado</option>
                </select>
              )}

              {/* Indicador de resultado auto-detectado */}
              {topic.resultado && !topic.resultadoManual && topic.title.toUpperCase() !== 'RELATÃ“RIO' && topic.title.toUpperCase() !== 'DISPOSITIVO' && (
                <span className="text-xs text-purple-400 flex items-center gap-1" title="Resultado detectado automaticamente pela IA">
                  <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                  </svg>
                  Auto
                </span>
              )}

              {/* Indicador de status de decisÃ£o - nÃ£o mostrar para RELATÃ“RIO e DISPOSITIVO */}
              {topic.title.toUpperCase() !== 'RELATÃ“RIO' && topic.title.toUpperCase() !== 'DISPOSITIVO' && (
                isDecidido() ? (
                  <span className="flex items-center gap-1 text-xs theme-bg-green-accent theme-text-green px-2 py-1 rounded border border-green-500/30">
                    <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                    Decidido
                  </span>
                ) : (
                  <span className="flex items-center gap-1 text-xs theme-bg-amber-accent theme-text-amber px-2 py-1 rounded border border-amber-500/30">
                    <span className="w-2 h-2 bg-amber-500 rounded-full"></span>
                    Pendente
                  </span>
                )
              )}
            </div>
          </div>

          {/* BotÃµes de aÃ§Ã£o */}
          <div className="flex flex-wrap gap-2 mt-3">
            <button
              onClick={() => startEditing(topic)}
              className="px-4 py-2 rounded text-sm hover-blue-700 bg-blue-600 text-white transition-colors duration-300"
            >
              Editar
            </button>

            {/* BotÃµes adicionais apenas para tÃ³picos que nÃ£o sejam RELATÃ“RIO ou DISPOSITIVO */}
            {topic.title.toUpperCase() !== 'RELATÃ“RIO' && topic.title.toUpperCase() !== 'DISPOSITIVO' && (
              <>
                <button
                  onClick={() => {
                    setTopicToRename(topic);
                    setNewTopicName(topic.title);
                    openModal('rename');
                  }}
                  className="px-3 py-2 rounded text-sm flex items-center gap-1 hover-purple-700 bg-purple-600 text-white transition-colors duration-300"
                >
                  <Edit2 className="w-3 h-3" />
                  Renomear
                </button>
                <button
                  onClick={() => {
                    setTopicToSplit(topic);
                    openModal('split');
                  }}
                  className="px-3 py-2 rounded text-sm flex items-center gap-1 hover-orange-700 bg-orange-600 text-white transition-colors duration-300"
                >
                  <Split className="w-3 h-3" />
                  Separar
                </button>
                <button
                  onClick={() => {
                    if (topicsToMerge.find((t: Topic) => t.title === topic.title)) {
                      setTopicsToMerge(topicsToMerge.filter((t: Topic) => t.title !== topic.title));
                    } else {
                      setTopicsToMerge([...topicsToMerge, topic]);
                    }
                  }}
                  className="px-3 py-2 rounded text-sm flex items-center gap-1 text-white"
                  style={{
                    backgroundColor: topicsToMerge.find((t: Topic) => t.title === topic.title) ? '#059669' : '#475569',
                    transition: 'background-color 0.3s ease'
                  }}
                  onMouseEnter={(e) => {
                    const isSelected = topicsToMerge.find((t: Topic) => t.title === topic.title);
                    e.currentTarget.style.backgroundColor = isSelected ? '#047857' : '#334155';
                  }}
                  onMouseLeave={(e) => {
                    const isSelected = topicsToMerge.find((t: Topic) => t.title === topic.title);
                    e.currentTarget.style.backgroundColor = isSelected ? '#059669' : '#475569';
                  }}
                >
                  <Merge className="w-3 h-3" />
                  {topicsToMerge.find((t: Topic) => t.title === topic.title) ? 'Selecionado' : 'Unir'}
                </button>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
});

// Display name para React DevTools
TopicCard.displayName = 'TopicCard';

// v1.33.58: SortableTopicCard - wrapper para dnd-kit com suporte a wheel scroll
const SortableTopicCard = React.memo(({ topic, id, ...props }: SortableTopicCardProps) => {
  const isSpecial = isSpecialTopic(topic);

  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
    isOver
  } = useSortable({
    id,
    disabled: isSpecial
  });

  const style = {
    transform: DndCSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 1000 : 'auto'
  };

  return (
    <div ref={setNodeRef} style={style} {...attributes} {...listeners}>
      <TopicCard
        topic={topic}
        isDragging={isDragging}
        isOver={isOver}
        {...props}
      />
    </div>
  );
});
SortableTopicCard.displayName = 'SortableTopicCard';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¦ SEÃ‡ÃƒO 4: COMPONENTES DE UI
// VirtualList, JurisprudenciaModalContent, LegislacaoModalContent
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸ“¦ COMPONENTE: VirtualList (v1.7.1) - Virtual scrolling para performance
// v1.19.2: Adicionado suporte a expandedIds para items com altura dinÃ¢mica
// v1.35.79: Generic component with proper React.memo typing
function VirtualListBase<T>({ items, itemHeight, renderItem, className = '', overscan = 5, expandedIds = new Set() }: VirtualListProps<T>) {
  const [scrollTop, setScrollTop] = React.useState(0);
  const containerRef = React.useRef<HTMLDivElement | null>(null);

  // Calcular viewport height dinamicamente
  const viewportHeight = React.useMemo(() => {
    if (typeof window === 'undefined') return 600;
    return Math.min(window.innerHeight - 200, 800); // Max 800px
  }, []);

  // Calcular range de items visÃ­veis
  const { visibleStart, visibleEnd, offsetY } = React.useMemo(() => {
    const start = Math.floor(scrollTop / itemHeight);
    const end = Math.ceil((scrollTop + viewportHeight) / itemHeight);

    return {
      visibleStart: Math.max(0, start - overscan),
      visibleEnd: Math.min(items.length, end + overscan),
      offsetY: Math.max(0, start - overscan) * itemHeight
    };
  }, [scrollTop, itemHeight, viewportHeight, items.length, overscan]);

  // Items visÃ­veis + buffer
  const visibleItems = React.useMemo(() => {
    return items.slice(visibleStart, visibleEnd);
  }, [items, visibleStart, visibleEnd]);

  // Handler de scroll com RAF para performance
  const handleScroll = React.useCallback((e: React.UIEvent<HTMLDivElement>) => {
    const newScrollTop = (e.target as HTMLDivElement).scrollTop;
    // SÃ³ atualizar se mudou significativamente (> 10px)
    if (Math.abs(newScrollTop - scrollTop) > 10) {
      requestAnimationFrame(() => {
        setScrollTop(newScrollTop);
      });
    }
  }, [scrollTop]);

  // Total height para manter scrollbar correto
  const totalHeight = items.length * itemHeight;

  return (
    <div
      ref={containerRef}
      className={`virtual-list-container ${className}`}
      style={{
        height: viewportHeight,
        overflow: 'auto',
        position: 'relative'
      }}
      onScroll={handleScroll}
    >
      {/* Spacer para altura total */}
      <div style={{ height: totalHeight, position: 'relative' }}>
        {/* Container para items visÃ­veis */}
        <div style={{
          position: 'absolute',
          top: offsetY,
          left: 0,
          right: 0
        }}>
          {visibleItems.map((item, idx) => {
            const absoluteIndex = visibleStart + idx;
            const itemWithId = item as { id?: string | number };
            const isExpanded = itemWithId.id ? expandedIds.has(String(itemWithId.id)) : false;
            return (
              <div
                key={itemWithId.id ?? absoluteIndex}
                style={isExpanded ? {
                  position: 'relative',
                  zIndex: 10,
                  paddingBottom: '12px'
                } : {
                  height: itemHeight,
                  overflow: 'hidden'
                }}
              >
                {renderItem(item, absoluteIndex)}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

// Create memoized version with proper generic support
const VirtualList = React.memo(VirtualListBase) as <T>(props: VirtualListProps<T>) => React.ReactElement;

(VirtualList as React.FC).displayName = 'VirtualList';

// ğŸ“š COMPONENTE: ModelCard (v1.2.7) - Card dual-view cards/list
// v1.35.0: Suporte a modelos compartilhados com badge de proprietÃ¡rio
const ModelCard = React.memo(({
  model,
  viewMode,
  onEdit,
  onToggleFavorite,
  onDuplicate,
  onDelete,
  onInsert,
  sanitizeHTML,
  isShared = false,
  ownerEmail = null,
  sharedPermission = 'view'
}: ModelCardProps) => {
  // ValidaÃ§Ã£o de viewMode
  let validViewMode = viewMode;
  if (viewMode !== 'cards' && viewMode !== 'list') {
    validViewMode = 'cards';
  }

  // MODO CARDS - VisualizaÃ§Ã£o expandida com preview
  if (validViewMode === 'cards') {
    return (
      <div
        className="theme-bg-secondary-30 p-5 rounded-lg border-2 transition-all hover-theme-border-from-600 card-hover-lift"
      >
        <div className="flex items-start justify-between mb-3">
          <div className="flex-1">
            <div className="flex items-center gap-2 mb-2">
              <button
                onClick={() => onToggleFavorite(model.id)}
                className={`text-xl hover:scale-125 transition-all duration-200 ${model.favorite ? 'text-yellow-400' : 'text-slate-400 hover:text-yellow-300'}`}
                title={model.favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}
              >
                {model.favorite ? 'â˜…' : 'â˜†'}
              </button>
              <h4 className="font-semibold text-lg theme-text-primary">{model.title}</h4>
            </div>
            <div className="flex flex-wrap items-center gap-2 mb-3">
              {model.category && (
                <span className="text-xs px-2 py-1 rounded theme-bg-purple-accent theme-text-purple border border-purple-500/30 font-medium">
                  {model.category}
                </span>
              )}
              {/* v1.33.4: Badge de similaridade para busca semÃ¢ntica */}
              {model.similarity !== undefined && (
                <span className={`text-xs px-2 py-1 rounded font-medium animate-badge ${
                  model.similarity >= 0.7 ? 'bg-green-500/20 text-green-400 border border-green-500/30' :
                  model.similarity >= 0.5 ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' :
                  'bg-gray-500/20 text-gray-400 border border-gray-500/30'
                }`}>
                  {Math.round(model.similarity * 100)}% similar
                </span>
              )}
              {/* v1.35.0: Badge de modelo compartilhado */}
              {isShared && ownerEmail && (
                <span className="text-xs px-2 py-1 rounded font-medium bg-purple-500/20 text-purple-400 border border-purple-500/30 animate-badge flex items-center gap-1">
                  <Users className="w-3 h-3" />
                  De: {ownerEmail.split('@')[0]}
                </span>
              )}
              {model.createdAt && (
                <span className="text-xs theme-text-disabled">
                  {new Date(model.createdAt).toLocaleDateString('pt-BR')}
                </span>
              )}
            </div>
            {model.keywords && (() => {
              const kwArr = Array.isArray(model.keywords) ? model.keywords : model.keywords.split(',');
              return (
              <div className="flex flex-wrap gap-1 mb-3">
                {kwArr.slice(0, 3).map((kw: string, i: number) => (
                  <span key={i} className="text-xs px-2 py-0.5 rounded theme-bg-tertiary theme-text-tertiary">
                    {kw.trim()}
                  </span>
                ))}
                {kwArr.length > 3 && (
                  <span className="text-xs px-2 py-0.5 theme-text-muted">
                    +{kwArr.length - 3}
                  </span>
                )}
              </div>
            );})()}
          </div>
        </div>

        {/* Preview do conteÃºdo */}
        <div
          className="theme-text-tertiary text-sm mb-4 line-clamp-4 theme-bg-primary-50 p-3 rounded"
          dangerouslySetInnerHTML={{ __html: sanitizeHTML(model.content) }}
        />

        {/* BotÃµes de aÃ§Ã£o - v1.35.0: desabilitados para compartilhados view-only */}
        <div className="flex gap-2">
          <button
            onClick={() => onEdit(model)}
            disabled={isShared && sharedPermission === 'view'}
            className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded text-sm transition-all duration-300 border-none ${
              isShared && sharedPermission === 'view'
                ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                : 'hover-blue-500 bg-blue-600 text-white'
            }`}
            title={isShared && sharedPermission === 'view' ? 'Modelo compartilhado (somente leitura)' : 'Editar modelo'}
          >
            <Edit className="w-4 h-4" />
            {isShared && sharedPermission === 'view' ? 'Visualizar' : 'Editar'}
          </button>
          <button
            onClick={() => onDuplicate(model)}
            className="hover-merge-confirm-btn px-3 py-2 rounded text-sm"
            style={{
              color: '#ffffff',
              transform: 'scale(1)'
            }}
            title="Duplicar para sua biblioteca"
          >
            ğŸ“‹
          </button>
          {/* v1.35.1: Mostrar excluir para modelos prÃ³prios OU compartilhados com permissÃ£o edit */}
          {(!isShared || sharedPermission === 'edit') && (
            <button
              onClick={() => onDelete(model)}
              className="hover-merge-cancel-btn px-3 py-2 rounded text-sm"
              style={{
                color: '#ffffff',
                transform: 'scale(1)'
              }}
              title={isShared ? 'Excluir modelo compartilhado (afeta o proprietÃ¡rio)' : 'Excluir modelo'}
            >
              <Trash2 className="w-4 h-4" />
            </button>
          )}
        </div>
      </div>
    );
  }

  // MODO LIST - VisualizaÃ§Ã£o compacta inline (v1.33.55: sem card-hover-lift para nÃ£o cortar borda superior)
  return (
    <div
      className="theme-bg-secondary-30 p-4 rounded-lg border-2 transition-all hover-theme-border-from-600"
    >
      <div className="flex items-center justify-between gap-4">
        <div className="flex items-center gap-3 flex-1 min-w-0">
          <button
            onClick={() => onToggleFavorite(model.id)}
            className={`text-lg flex-shrink-0 hover:scale-125 transition-all duration-200 ${model.favorite ? 'text-yellow-400' : 'text-slate-400 hover:text-yellow-300'}`}
            title={model.favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}
          >
            {model.favorite ? 'â˜…' : 'â˜†'}
          </button>
          <div className="flex-1 min-w-0">
            <h4 className="font-semibold theme-text-primary truncate">{model.title}</h4>
            <div className="flex items-center gap-2 mt-1">
              {model.category && (
                <span className="text-xs px-2 py-0.5 rounded theme-bg-purple-accent theme-text-purple border border-purple-500/30">
                  {model.category}
                </span>
              )}
              {/* v1.33.4: Badge de similaridade para busca semÃ¢ntica */}
              {model.similarity !== undefined && (
                <span className={`text-xs px-2 py-0.5 rounded font-medium animate-badge ${
                  model.similarity >= 0.7 ? 'bg-green-500/20 text-green-400' :
                  model.similarity >= 0.5 ? 'bg-yellow-500/20 text-yellow-400' :
                  'bg-gray-500/20 text-gray-400'
                }`}>
                  {Math.round(model.similarity * 100)}%
                </span>
              )}
              {/* v1.35.0: Badge de modelo compartilhado */}
              {isShared && ownerEmail && (
                <span className="text-xs px-2 py-0.5 rounded font-medium bg-purple-500/20 text-purple-400 animate-badge flex items-center gap-1">
                  <Users className="w-3 h-3" />
                  De: {ownerEmail.split('@')[0]}
                </span>
              )}
              {model.keywords && (() => {
                const kwArr = Array.isArray(model.keywords) ? model.keywords : model.keywords.split(',');
                return (
                <span className="text-xs theme-text-muted truncate">
                  {kwArr[0].trim()}
                  {kwArr.length > 1 && ` +${kwArr.length - 1}`}
                </span>
              );})()}
            </div>
          </div>
        </div>
        {/* v1.35.0: BotÃµes adaptados para modelos compartilhados */}
        <div className="flex gap-2 flex-shrink-0">
          <button
            onClick={() => onEdit(model)}
            disabled={isShared && sharedPermission === 'view'}
            className={`p-2 rounded ${
              isShared && sharedPermission === 'view'
                ? 'cursor-not-allowed opacity-50'
                : 'hover-icon-blue-scale'
            }`}
            style={{
              color: isShared && sharedPermission === 'view' ? '#9ca3af' : '#60a5fa',
              transform: 'scale(1)'
            }}
            title={isShared && sharedPermission === 'view' ? 'Modelo compartilhado (somente leitura)' : 'Editar modelo'}
          >
            <Edit className="w-4 h-4" />
          </button>
          <button
            onClick={() => onDuplicate(model)}
            className="hover-icon-green-scale p-2 rounded"
            style={{
              color: '#4ade80',
              transform: 'scale(1)'
            }}
            title="Duplicar para sua biblioteca"
          >
            ğŸ“‹
          </button>
          {/* v1.35.1: Mostrar excluir para modelos prÃ³prios OU compartilhados com permissÃ£o edit */}
          {(!isShared || sharedPermission === 'edit') && (
            <button
              onClick={() => onDelete(model)}
              className="hover-icon-red-scale p-2 rounded"
              style={{
                color: '#f87171',
                transform: 'scale(1)'
              }}
              title={isShared ? 'Excluir modelo compartilhado (afeta o proprietÃ¡rio)' : 'Excluir modelo'}
            >
              <Trash2 className="w-4 h-4" />
            </button>
          )}
        </div>
      </div>
    </div>
  );
});

// Display name para React DevTools
ModelCard.displayName = 'ModelCard';

// ğŸ“ COMPONENTE: ProofCard (v1.8.2) - Card de prova PDF/Texto
// v1.16.1: Adicionado anonymizationEnabled para desabilitar opÃ§Ãµes incompatÃ­veis
const ProofCard = React.memo(({
  proof,
  isPdf,
  proofManager,
  openModal,
  setError,
  extractTextFromPDFWithMode,
  anonymizationEnabled = false,
  grokEnabled = false, // v1.36.36: Bloquear PDF Puro quando Grok
  anonConfig = null,
  nomesParaAnonimizar = [],
  editorTheme = 'dark', // v1.21.7: Para contraste correto do aviso de anonimizaÃ§Ã£o
  setTextPreview // v1.21.16: Para preview de texto extraÃ­do
}: ProofCardProps) => {
  // ğŸ†• v1.12.27: Estado local para progresso de extraÃ§Ã£o (em vez de setError global)
  const [extractionProgress, setExtractionProgress] = React.useState<{ current: number; total: number; mode: string } | null>(null);
  // null = nÃ£o extraindo | { current: N, total: N, mode: 'pdfjs'|'claude-vision' } = em progresso

  // Handler: Remover vÃ­nculo de tÃ³pico
  const handleUnlinkTopic = React.useCallback((topicTitle: string) => {
    proofManager.setProofTopicLinks((prev: Record<string, string[]>) => ({
      ...prev,
      [proof.id]: (prev[proof.id] || []).filter((t: string) => t !== topicTitle)
    }));
  }, [proof.id, proofManager]);

  // Handler: Atualizar conclusÃ£o
  const handleConclusionChange = React.useCallback((e: React.ChangeEvent<HTMLTextAreaElement>) => {
    proofManager.setProofConclusions((prev: Record<string, string>) => ({
      ...prev,
      [proof.id]: e.target.value
    }));
  }, [proof.id, proofManager]);

  // Handler: Definir modo PDF
  const handleSetPdfMode = React.useCallback(() => {
    if (!proof.isPlaceholder) {
      proofManager.setProofUsePdfMode((prev: Record<string, boolean>) => ({
        ...prev,
        [proof.id]: true
      }));
    }
  }, [proof.id, proof.isPlaceholder, proofManager]);

  // v1.21.5: FunÃ§Ã£o interna de extraÃ§Ã£o (chamada diretamente ou apÃ³s modal de nomes)
  const executeExtraction = React.useCallback(async (nomesToUse: string[] = []) => {
    // v1.32.14: Bloquear apenas modos binÃ¡rios, permitir tesseract
    const userMode = proofManager.proofProcessingModes[proof.id] || 'pdfjs';
    const blockedModes = ['claude-vision', 'pdf-puro'];
    const selectedMode = (anonymizationEnabled && blockedModes.includes(userMode))
      ? 'pdfjs'
      : userMode;

    // Se modo Ã© 'pdf-puro', usar PDF binÃ¡rio diretamente
    if (selectedMode === 'pdf-puro') {
      proofManager.setProofUsePdfMode((prev: Record<string, boolean>) => ({ ...prev, [proof.id]: true }));
      return;
    }

    proofManager.setProofUsePdfMode((prev: Record<string, boolean>) => ({ ...prev, [proof.id]: false }));

    try {
      setExtractionProgress({ current: 0, total: 0, mode: selectedMode });
      const extractedText = await extractTextFromPDFWithMode(proof.file!, selectedMode, (current: number, total: number) => {
        setExtractionProgress({ current, total, mode: selectedMode });
      });
      setExtractionProgress(null);

      if (extractedText && extractedText.trim().length > 0) {
        // v1.21.5: Usar nomes passados como parÃ¢metro (do modal ou existentes)
        const textToStore = (anonymizationEnabled && anonConfig)
          ? anonymizeText(extractedText, anonConfig, nomesToUse)
          : extractedText;
        proofManager.setExtractedProofTexts((prev: Record<string, string>) => ({ ...prev, [proof.id]: textToStore }));
        proofManager.setProofExtractionFailed((prev: Record<string, boolean>) => ({ ...prev, [proof.id]: false }));
      } else {
        proofManager.setProofExtractionFailed((prev: Record<string, boolean>) => ({ ...prev, [proof.id]: true }));
        // v1.36.37: SÃ³ fazer fallback para PDF se NÃƒO estiver bloqueado (anon/Grok)
        const pdfBinaryBlocked = anonymizationEnabled || grokEnabled;
        if (!pdfBinaryBlocked) {
          proofManager.setProofUsePdfMode((prev: Record<string, boolean>) => ({ ...prev, [proof.id]: true }));
        }
      }
    } catch (err) {
      setExtractionProgress(null);
      proofManager.setProofExtractionFailed((prev: Record<string, boolean>) => ({ ...prev, [proof.id]: true }));
      // v1.36.37: SÃ³ fazer fallback para PDF se NÃƒO estiver bloqueado (anon/Grok)
      const pdfBinaryBlocked = anonymizationEnabled || grokEnabled;
      if (!pdfBinaryBlocked) {
        proofManager.setProofUsePdfMode((prev: Record<string, boolean>) => ({ ...prev, [proof.id]: true }));
      }
    }
  }, [proof.id, proof.file, proofManager, extractTextFromPDFWithMode, anonymizationEnabled, anonConfig, grokEnabled]);

  // Handler: Extrair texto do PDF
  // ğŸ†• v1.12.20: Usa modo especÃ­fico da prova (proofProcessingModes)
  // ğŸ†• v1.12.27: Usa estado local para progresso (nÃ£o mais setError global)
  // ğŸ†• v1.21.5: Se anonimizaÃ§Ã£o ativa, abre modal de nomes antes de extrair
  const handleExtractText = React.useCallback(async () => {
    if (proof.isPlaceholder) return;

    // v1.21.5: Se anonimizaÃ§Ã£o ativa, abrir modal de nomes antes de extrair
    if (anonymizationEnabled && anonConfig) {
      proofManager.setPendingExtraction({ proofId: proof.id, proof, executeExtraction });
      openModal('proofExtractionAnonymization');
      return;
    }

    // Sem anonimizaÃ§Ã£o: extrair diretamente
    await executeExtraction(nomesParaAnonimizar);
  }, [proof.id, proof.isPlaceholder, proofManager, openModal, anonymizationEnabled, anonConfig, nomesParaAnonimizar, executeExtraction]);

  // Handler: Abrir modal de anÃ¡lise
  const handleAnalyze = React.useCallback(() => {
    proofManager.setProofToAnalyze(proof);
    openModal('proofAnalysis');
  }, [proof, proofManager, openModal]);

  // Handler: Abrir modal de vinculaÃ§Ã£o
  const handleLink = React.useCallback(() => {
    proofManager.setProofToLink(proof);
    openModal('linkProof');
  }, [proof, proofManager, openModal]);

  // Handler: Abrir modal de remoÃ§Ã£o
  const handleDelete = React.useCallback(() => {
    proofManager.setProofToDelete(proof);
    openModal('deleteProof');
  }, [proof, proofManager, openModal]);

  return (
    <div
      className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input hover-border-blue-500 transition-colors"
    >
      <div className="flex items-start justify-between gap-4">
        <div className="flex-1 min-w-0">
          {/* CabeÃ§alho - Nome + Badge de Tipo */}
          <div className="flex items-center gap-2 mb-2">
            <FileText className={`w-5 h-5 flex-shrink-0 ${isPdf ? 'text-red-400' : 'text-blue-400'}`} />
            <h5 className="font-medium theme-text-secondary truncate">{proof.name}</h5>
            <span className={`px-2 py-0.5 text-xs rounded ${
              isPdf
                ? 'theme-bg-red-accent theme-text-red'
                : 'theme-bg-blue-accent theme-text-blue'
            }`}>
              {isPdf ? 'PDF' : 'TEXTO'}
            </span>
            {isPdf && proof.isPlaceholder && (
              <span className="px-2 py-0.5 theme-bg-amber-accent theme-text-amber text-xs rounded" title="PDF original nÃ£o salvo, mas texto extraÃ­do disponÃ­vel">
                Somente Texto
              </span>
            )}
            {/* Badge de modo de processamento (BINÃRIO vs EXTRAÃDO) */}
            {/* v1.21.10: Mostrar "CONFLITO" quando anon ON + proofUsePdfMode true - requer clicar "Usar Texto" */}
            {/* v1.21.16: Cores ajustadas para tema claro */}
            {isPdf && !proof.isPlaceholder && (
              <span className={`px-2 py-0.5 text-xs rounded ${
                anonymizationEnabled && proofManager.proofUsePdfMode[proof.id]
                  ? editorTheme === 'light' ? 'bg-amber-100 text-amber-700 border border-amber-300' : 'bg-amber-600/20 text-amber-400 border border-amber-500/30'
                  : proofManager.proofUsePdfMode[proof.id]
                    ? editorTheme === 'light' ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'bg-blue-600/20 text-blue-400 border border-blue-500/30'
                    : editorTheme === 'light' ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-green-600/20 text-green-400 border border-green-500/30'
              }`} title={
                anonymizationEnabled && proofManager.proofUsePdfMode[proof.id]
                  ? 'Conflito: Modo PDF + anonimizaÃ§Ã£o. Clique em "Usar Texto" para resolver.'
                  : proofManager.proofUsePdfMode[proof.id]
                    ? 'PDF binÃ¡rio serÃ¡ enviado Ã  IA'
                    : 'Texto extraÃ­do serÃ¡ enviado Ã  IA'
              }>
                {anonymizationEnabled && proofManager.proofUsePdfMode[proof.id]
                  ? 'âš ï¸ CONFLITO'
                  : proofManager.proofUsePdfMode[proof.id] ? 'ğŸ“„ BINÃRIO' : 'ğŸ“ EXTRAÃDO'}
              </span>
            )}
          </div>

          {/* Metadata - Tamanho/Caracteres + Data */}
          <div className="flex items-center gap-4 text-xs theme-text-muted mb-2">
            <span>{isPdf ? `${((proof.size ?? 0) / 1024).toFixed(1)} KB` : `${(proof.text ?? '').length} caracteres`}</span>
            <span>{new Date(proof.uploadDate).toLocaleDateString('pt-BR')}</span>
          </div>

          {/* Alert para PDF Placeholder */}
          {isPdf && proof.isPlaceholder && (
            <div className="mb-3 text-xs text-amber-400 flex items-center gap-1">
              <AlertCircle className="w-3 h-3" />
              PDF original nÃ£o salvo (muito grande), mas texto extraÃ­do estÃ¡ disponÃ­vel
            </div>
          )}

          {/* v1.21.6: Aviso para PDF com anonimizaÃ§Ã£o ativa */}
          {/* v1.21.7: Contraste correto em ambos os temas */}
          {isPdf && anonymizationEnabled && !proofManager.extractedProofTexts[proof.id] && (
            <div className={`mb-3 p-2 rounded text-xs flex items-start gap-2 ${
              editorTheme === 'dark'
                ? 'bg-purple-600/20 border border-purple-500/30 text-purple-300'
                : 'bg-purple-100 border border-purple-300 text-purple-700'
            }`}>
              <AlertCircle className="w-4 h-4 flex-shrink-0" />
              <div>
                <span className="font-medium">ğŸ”’ AnonimizaÃ§Ã£o ativa:</span> Extraia o texto antes de usar no Assistente IA
              </div>
            </div>
          )}

          {/* v1.36.38: Aviso para PDF com Grok selecionado (sÃ³ mostra se anonimizaÃ§Ã£o nÃ£o ativa) */}
          {isPdf && grokEnabled && !anonymizationEnabled && !proofManager.extractedProofTexts[proof.id] && (
            <div className={`mb-3 p-2 rounded text-xs flex items-start gap-2 ${
              editorTheme === 'dark'
                ? 'bg-orange-600/20 border border-orange-500/30 text-orange-300'
                : 'bg-orange-100 border border-orange-300 text-orange-700'
            }`}>
              <AlertCircle className="w-4 h-4 flex-shrink-0" />
              <div>
                <span className="font-medium">âš¡ Grok selecionado:</span> Grok nÃ£o suporta PDF binÃ¡rio. Extraia o texto primeiro.
              </div>
            </div>
          )}

          {/* Preview de Texto (apenas para tipo TEXTO) */}
          {!isPdf && proof.text && (
            <p className="text-xs theme-text-muted line-clamp-2 mb-2">{proof.text.substring(0, 150)}...</p>
          )}

          {/* Toggle PDF/Texto - APENAS para PDFs */}
          {isPdf && (
            <div className="mt-3">
              <div className={CSS.flexGap2}>
                <button
                  onClick={handleSetPdfMode}
                  disabled={proof.isPlaceholder || !!extractionProgress || anonymizationEnabled || grokEnabled}
                  className={`flex-1 px-3 py-2 rounded-lg text-xs font-medium transition-all ${
                    proof.isPlaceholder || extractionProgress || anonymizationEnabled || grokEnabled
                      ? 'theme-bg-tertiary-30 theme-text-disabled cursor-not-allowed'
                      : proofManager.proofUsePdfMode[proof.id]
                      ? 'bg-blue-600 text-white shadow-lg hover-blue-700-from-600'
                      : 'theme-bg-tertiary-50 theme-text-muted hover-slate-600'
                  }`}
                  title={proof.isPlaceholder ? 'PDF original nÃ£o disponÃ­vel' : anonymizationEnabled ? 'ğŸ”’ AnonimizaÃ§Ã£o ativa: PDF binÃ¡rio bloqueado' : grokEnabled ? 'ğŸ”’ Grok nÃ£o suporta PDF binÃ¡rio' : ''}
                >
                  ğŸ“„ Usar PDF
                </button>
                <button
                  onClick={handleExtractText}
                  disabled={!!extractionProgress}
                  className={`flex-1 px-3 py-2 rounded-lg text-xs font-medium transition-all ${
                    extractionProgress
                      ? 'theme-bg-tertiary-30 theme-text-disabled cursor-not-allowed'
                      : proofManager.proofUsePdfMode[proof.id] && !proof.isPlaceholder
                      ? 'bg-green-600 text-white shadow-lg hover-green-700-from-600'
                      : 'theme-bg-tertiary-50 theme-text-muted hover-slate-600'
                  }`}
                >
                  {extractionProgress ? 'â³ Extraindo...' : 'ğŸ“ Extrair Texto'}
                </button>
              </div>

              {/* ğŸ†• v1.12.20: Seletor de modo de processamento */}
              <div className="mt-2 flex items-center justify-end gap-2">
                <span className="text-xs theme-text-muted">Modo:</span>
                <ProcessingModeSelector
                  value={proofManager.proofProcessingModes[proof.id] || 'pdfjs'}
                  onChange={(mode: ProcessingMode) => proofManager.setProofProcessingModes((prev: Record<string, ProcessingMode>) => ({
                    ...prev,
                    [proof.id]: mode
                  }))}
                  disabled={proofManager.isAnalyzingProof(String(proof.id)) || !!extractionProgress}
                  anonymizationEnabled={anonymizationEnabled}
                  grokEnabled={grokEnabled}
                />
              </div>

              {/* ğŸ†• v1.12.27: Indicador de progresso de extraÃ§Ã£o (inline) */}
              {extractionProgress && (
                <div className="mt-2 text-xs text-blue-400 flex items-center gap-2">
                  <Loader2 className="w-3 h-3 animate-spin" />
                  <span>
                    {extractionProgress.mode === 'claude-vision' ? 'ğŸ”' : 'ğŸ“'}
                    {extractionProgress.total > 0
                      ? ` Extraindo... ${extractionProgress.current}/${extractionProgress.total} pÃ¡ginas`
                      : ' Iniciando extraÃ§Ã£o...'}
                  </span>
                </div>
              )}

              {/* Indicador de texto extraÃ­do - v1.21.16: clicÃ¡vel para preview */}
              {!proofManager.proofUsePdfMode[proof.id] && proofManager.extractedProofTexts[proof.id] && (
                <div
                  className={`mt-2 text-xs flex items-center gap-1 cursor-pointer hover:underline ${editorTheme === 'light' ? 'text-green-600' : 'text-green-400'}`}
                  onClick={() => setTextPreview?.({ isOpen: true, title: proof.name, text: proofManager.extractedProofTexts[proof.id] })}
                >
                  <Check className="w-3 h-3" />
                  Texto extraÃ­do com sucesso ({proofManager.extractedProofTexts[proof.id].length.toLocaleString()} caracteres)
                </div>
              )}

              {/* Indicador de extraÃ§Ã£o falhada - v1.36.37: mensagem diferente quando PDF bloqueado */}
              {proofManager.proofExtractionFailed[proof.id] && (
                <div className={`mt-2 text-xs flex items-center gap-1 ${
                  (anonymizationEnabled || grokEnabled) ? 'text-red-400' : 'text-amber-400'
                }`}>
                  <AlertCircle className="w-3 h-3" />
                  {(anonymizationEnabled || grokEnabled)
                    ? 'PDF sem texto extraÃ­vel - extraÃ§Ã£o obrigatÃ³ria (tente Tesseract OCR)'
                    : 'PDF sem texto extraÃ­vel (imagem) - usando PDF completo'}
                </div>
              )}
            </div>
          )}

          {/* BotÃ£o: Analisar com IA */}
          {/* v1.21.10: Desabilitado tambÃ©m quando anon ON + proofUsePdfMode true */}
          <div className="mt-3">
            <button
              onClick={handleAnalyze}
              disabled={proofManager.isAnalyzingProof(String(proof.id)) || (anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]) || (anonymizationEnabled && isPdf && proofManager.proofUsePdfMode[proof.id])}
              className="w-full px-3 py-2 border border-blue-500/30 rounded-lg text-xs font-medium theme-text-blue flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed hover-blue-alpha-3-from-2 theme-bg-blue-accent transition-all duration-300"
            >
              {proofManager.isAnalyzingProof(String(proof.id)) ? (
                <>
                  <Loader2 className="w-3 h-3 animate-spin" />
                  Analisando...
                </>
              ) : (
                <>
                  <Sparkles className="w-3 h-3" />
                  Analisar com IA
                </>
              )}
            </button>
          </div>

          {/* BotÃ£o: Vincular a TÃ³picos */}
          {/* v1.21.10: Desabilitado tambÃ©m quando anon ON + proofUsePdfMode true */}
          <div className="mt-3">
            <button
              onClick={handleLink}
              disabled={(anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]) || (anonymizationEnabled && isPdf && proofManager.proofUsePdfMode[proof.id])}
              className={`w-full px-3 py-2 border rounded-lg text-xs font-medium flex items-center justify-center gap-2 transition-all duration-300 ${
                (anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]) || (anonymizationEnabled && isPdf && proofManager.proofUsePdfMode[proof.id])
                  ? 'border-gray-500/30 theme-text-disabled cursor-not-allowed opacity-50'
                  : 'border-purple-500/30 theme-text-purple hover-purple-alpha-3-from-2 theme-bg-purple-accent'
              }`}
            >
              <Scale className="w-3 h-3" />
              Vincular a TÃ³picos
            </button>
          </div>

          {/* ğŸ†• v1.19.2: Toggle para enviar conteÃºdo completo Ã  IA */}
          {/* v1.21.8: Desabilitado quando anon ON + PDF + sem texto extraÃ­do */}
          <div className="mt-3 flex items-center gap-2">
            <button
              onClick={() => {
                const isDisabled = anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id];
                if (!isDisabled) {
                  proofManager.setProofSendFullContent((prev: Record<string, boolean>) => ({
                    ...prev,
                    [proof.id]: !prev[proof.id]
                  }));
                }
              }}
              disabled={anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]}
              className={`relative inline-flex h-5 w-9 items-center rounded-full transition-colors ${
                anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]
                  ? 'bg-gray-700 opacity-50 cursor-not-allowed'
                  : proofManager.proofSendFullContent[proof.id]
                    ? 'bg-green-500'
                    : 'bg-gray-600'
              }`}
            >
              <span className={`inline-block h-3 w-3 transform rounded-full bg-white transition-transform ${
                proofManager.proofSendFullContent[proof.id] ? 'translate-x-5' : 'translate-x-1'
              }`} />
            </button>
            <span className={`text-xs ${
              anonymizationEnabled && isPdf && !proofManager.extractedProofTexts[proof.id]
                ? 'theme-text-disabled'
                : 'theme-text-muted'
            }`}>
              Enviar conteÃºdo completo Ã  IA
            </span>
          </div>

          {/* Resultado da AnÃ¡lise */}
          {proofManager.proofAnalysisResults[proof.id] && (
            <div className="mt-3 theme-info-box">
              <div className="flex items-center gap-2 mb-2">
                <Sparkles className="w-3 h-3 text-blue-400" />
                <span className="text-xs font-medium theme-text-blue">
                  AnÃ¡lise {proofManager.proofAnalysisResults[proof.id].type === 'livre' ? 'Livre' : 'Contextual'}
                </span>
              </div>
              <div className="overflow-y-auto" style={{ resize: 'vertical', height: '16rem', minHeight: '10rem', maxHeight: '40rem' }}>
                <p className="text-xs theme-text-tertiary whitespace-pre-wrap">
                  {proofManager.proofAnalysisResults[proof.id].result}
                </p>
              </div>
            </div>
          )}

          {/* ConclusÃµes Manuais */}
          <div className="mt-3">
            <label className="block text-xs font-medium theme-text-muted mb-2">
              âœï¸ Minhas ConclusÃµes:
            </label>
            <textarea
              value={proofManager.proofConclusions[proof.id] || ''}
              onChange={handleConclusionChange}
              placeholder="Adicione suas conclusÃµes sobre esta prova..."
              rows={3}
              className="w-full px-3 py-2 theme-bg-secondary-50 border theme-border-input rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent theme-text-secondary text-xs resize-none"
            />
          </div>

          {/* Badges de TÃ³picos Vinculados */}
          {proofManager.proofTopicLinks[proof.id] && proofManager.proofTopicLinks[proof.id].length > 0 && (
            <div className="mt-3">
              <p className="text-xs theme-text-muted mb-2">Vinculado a:</p>
              <div className="flex flex-wrap gap-1">
                {proofManager.proofTopicLinks[proof.id].map((topicTitle: string, idx: number) => (
                  <span
                    key={idx}
                    className="inline-flex items-center gap-1 px-2 py-1 theme-bg-purple-accent theme-text-purple text-xs rounded border border-purple-500/30"
                  >
                    {topicTitle}
                    <button
                      onClick={() => handleUnlinkTopic(topicTitle)}
                      className="hover-text-red-400 transition-colors"
                    >
                      Ã—
                    </button>
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* BotÃ£o Remover */}
        <button
          onClick={handleDelete}
          className="p-2 rounded-lg hover-delete-proof"
        >
          <Trash2 className="w-4 h-4 text-red-400" />
        </button>
      </div>
    </div>
  );
});

// Display name para React DevTools
ProofCard.displayName = 'ProofCard';

const JurisprudenciaCard = React.memo(({ precedente, onCopy, expanded, onToggleExpand, copiedId }: JurisprudenciaCardProps) => {
  // v1.36.52: Adiciona fallback para fullText/texto (embeddings semÃ¢nticos nÃ£o tÃªm tese/enunciado)
  const texto = precedente.tese || precedente.enunciado || precedente.fullText || precedente.texto || '';
  const isCopied = copiedId === precedente.id;  // v1.36.54: Feedback visual
  const tesePreview = texto.length > 200 ? texto.slice(0, 200) + '...' : texto;
  const renderIdentificador = () => {
    if (precedente.tema) {
      return <span className="text-xs theme-text-muted ml-2">Tema {precedente.tema}</span>;
    }
    if (precedente.tipoProcesso === 'SÃºmula' || precedente.tipoProcesso === 'OJ') {
      return <span className="text-xs theme-text-muted ml-2">nÂº {precedente.numero}</span>;
    }
    return null;
  };
  return (
    <div className="theme-bg-secondary p-4 rounded-lg border theme-border-secondary">
      <div className="flex justify-between items-start mb-2">
        <div className="flex items-center gap-2">
          <span className="text-xs px-2 py-0.5 rounded theme-bg-tertiary theme-text-tertiary">
            {precedente.tipoProcesso}
          </span>
          {renderIdentificador()}
        </div>
        <div className="flex items-center gap-1">
          {precedente.status && (
            <span className={`text-xs px-2 py-0.5 rounded ${
              isStatusValido(precedente.status)
                ? 'theme-badge-success'
                : 'theme-badge-error'
            }`}>
              {isStatusValido(precedente.status) ? 'âœ“' : 'âœ—'} {precedente.status.replace(/_/g, ' ')}
            </span>
          )}
          {precedente.orgao && (
            <span className="text-xs px-2 py-0.5 rounded theme-badge-purple">
              {precedente.orgao}
            </span>
          )}
          {precedente.tribunal && (
            <span className="text-xs px-2 py-0.5 rounded theme-badge-blue">
              {precedente.tribunal}
            </span>
          )}
          <button
            onClick={() => onCopy(precedente)}
            className={`p-1.5 rounded ${isCopied ? 'text-green-500' : 'hover-icon-blue-scale'}`}
            title={isCopied ? 'Copiado!' : 'Copiar tese'}
          >
            {isCopied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
          </button>
        </div>
      </div>
      {precedente.titulo && (
        <h4 className="font-semibold theme-text-primary text-sm mb-1 uppercase">{precedente.titulo}</h4>
      )}
      {precedente.numeroProcesso && (
        <h4 className="font-medium theme-text-primary text-sm mb-1">{precedente.numeroProcesso}</h4>
      )}
      {(precedente.relator || precedente.dataJulgamento || precedente.dataAprovacao) && (
        <p className="text-xs theme-text-muted mb-2">
          {precedente.relator && `Rel: ${precedente.relator}`}
          {precedente.relator && (precedente.dataJulgamento || precedente.dataAprovacao) && ' | '}
          {precedente.dataJulgamento || precedente.dataAprovacao}
        </p>
      )}
      <p className={`text-sm theme-text-secondary ${precedente.status && !isStatusValido(precedente.status) ? 'line-through opacity-70' : ''}`}>
        {expanded ? texto : tesePreview}
      </p>
      {texto.length > 200 && (
        <button
          onClick={() => onToggleExpand(precedente.id)}
          className="text-xs text-purple-500 mt-2 hover-text-purple-400"
        >
          {expanded ? 'Recolher' : 'Expandir'}
        </button>
      )}
    </div>
  );
});
JurisprudenciaCard.displayName = 'JurisprudenciaCard';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“œ COMPONENTE: ArtigoCard - Card de exibiÃ§Ã£o de artigo de lei
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ArtigoCard = React.memo(({ artigo, onCopy, expanded, onToggleExpand, copiedId }: ArtigoCardProps) => {
  const lei = getLeiFromId(artigo.id);
  const hasDetails = (artigo.paragrafos && artigo.paragrafos.length > 0) || (artigo.incisos && artigo.incisos.length > 0) || (artigo.alineas && artigo.alineas.length > 0);
  const isCopied = copiedId === artigo.id;

  return (
    <div className="theme-bg-secondary rounded-lg p-3 border theme-border-subtle">
      <div className="flex justify-between items-start gap-2">
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 flex-wrap mb-1">
            <span className="px-2 py-0.5 rounded text-xs font-medium bg-blue-500/20 text-blue-400">
              {lei.nome}
            </span>
            <span className="font-semibold text-sm theme-text-primary">
              Art. {artigo.numero}
            </span>
            {artigo.status === 'revogado' && (
              <span className="px-1.5 py-0.5 rounded text-xs bg-red-500/20 text-red-400">
                Revogado
              </span>
            )}
          </div>
          <p className="text-sm theme-text-secondary line-clamp-3">
            {artigo.caput}
          </p>
        </div>
        <div className="flex gap-1">
          {hasDetails && (
            <button
              onClick={() => onToggleExpand(artigo.id)}
              className="p-1.5 rounded hover-bg-blue-opacity text-blue-400"
              title={expanded ? 'Recolher' : 'Expandir'}
            >
              {expanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
            </button>
          )}
          <button
            onClick={() => onCopy(artigo)}
            className={`p-1.5 rounded transition-colors ${isCopied ? 'bg-green-500/20 text-green-400' : 'hover-bg-blue-opacity text-blue-400'}`}
            title={isCopied ? 'Copiado!' : 'Copiar artigo'}
          >
            {isCopied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
          </button>
        </div>
      </div>

      {expanded && hasDetails && (
        <div className="mt-3 pt-3 border-t theme-border-subtle text-sm space-y-2">
          {artigo.paragrafos && artigo.paragrafos.length > 0 && (
            <div>
              <span className="text-xs font-medium text-purple-400 block mb-1">ParÃ¡grafos:</span>
              {artigo.paragrafos.map((p: { numero: string; texto: string }, i: number) => (
                <p key={i} className="theme-text-secondary ml-2 mb-1">
                  <span className="text-purple-300">Â§ {p.numero}Âº</span> {p.texto}
                </p>
              ))}
            </div>
          )}
          {artigo.incisos && artigo.incisos.length > 0 && (
            <div>
              <span className="text-xs font-medium text-amber-400 block mb-1">Incisos:</span>
              {artigo.incisos.map((inc: { numero: string; texto: string }, i: number) => (
                <p key={i} className="theme-text-secondary ml-2 mb-1">
                  <span className="text-amber-300">{inc.numero}</span> - {inc.texto}
                </p>
              ))}
            </div>
          )}
          {artigo.alineas && artigo.alineas.length > 0 && (
            <div>
              <span className="text-xs font-medium text-teal-400 block mb-1">AlÃ­neas:</span>
              {artigo.alineas.map((al: { letra: string; texto: string }, i: number) => (
                <p key={i} className="theme-text-secondary ml-2 mb-1">
                  <span className="text-teal-300">{al.letra})</span> {al.texto}
                </p>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
});
ArtigoCard.displayName = 'ArtigoCard';

// v1.20.3: Adicionado isReadOnly para modo somente leitura em aba secundÃ¡ria
// v1.27.00: Adicionado busca semÃ¢ntica
const JurisprudenciaTab = React.memo(({
  openModal, closeModal, modals, isReadOnly = false,
  // v1.27.00: Props para busca semÃ¢ntica
  jurisSemanticEnabled = false,
  searchModelReady = false,
  jurisEmbeddingsCount = 0,
  jurisSemanticThreshold = 50
}: JurisprudenciaTabProps) => {
  const jurisprudencia = useJurisprudencia();
  const [expandedIds, setExpandedIds] = React.useState<Set<string>>(new Set());
  const [importStatus, setImportStatus] = React.useState<{ success: boolean; message?: string; count?: number; error?: string } | null>(null);
  const fileInputRef = React.useRef<HTMLInputElement | null>(null);

  // v1.27.00: Estados para busca semÃ¢ntica (usa scroll, nÃ£o paginaÃ§Ã£o)
  // v1.28.01: Usa toggle global como padrÃ£o se nÃ£o houver valor no localStorage
  const [useSemanticSearch, setUseSemanticSearch] = React.useState(() => {
    try {
      const stored = localStorage.getItem('jurisSemanticMode');
      if (stored !== null) return stored === 'true';
      return jurisSemanticEnabled; // Usa toggle global como fallback
    } catch { return false; }
  });
  const [semanticResults, setSemanticResults] = React.useState<JurisEmbeddingWithSimilarity[] | null>(null);
  const [searchingSemantics, setSearchingSemantics] = React.useState(false);

  // Busca semÃ¢ntica disponÃ­vel se: toggle global ativo + modelo pronto + embeddings gerados
  const semanticAvailable = jurisSemanticEnabled && searchModelReady && jurisEmbeddingsCount > 0;

  // v1.27.00: Handler para busca semÃ¢ntica de jurisprudÃªncia
  const performSemanticSearch = React.useCallback(async (query: string) => {
    if (!query || query.length < 3 || !semanticAvailable) {
      setSemanticResults(null);
      return;
    }

    setSearchingSemantics(true);
    try {
      // v1.32.20: toLowerCase para E5 case-sensitive
      const queryEmbedding = await AIModelService.getEmbedding(query.toLowerCase(), 'query');
      const threshold = jurisSemanticThreshold / 100;
      // v1.32.21: Passar filtros para aplicar ANTES do limit (retorna atÃ© 30 do tipo desejado)
      const results = await JurisEmbeddingsService.searchBySimilarity(queryEmbedding, threshold, 30, jurisprudencia.filtros);

      setSemanticResults(results);
    } catch (err) {
      console.error('[Juris Semantic] Erro na busca:', err);
      setSemanticResults(null);
    } finally {
      setSearchingSemantics(false);
    }
  }, [semanticAvailable, jurisSemanticThreshold, jurisprudencia.filtros]);

  // v1.27.00: Debounce para busca semÃ¢ntica
  const semanticSearchTimeoutRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);
  React.useEffect(() => {
    if (useSemanticSearch && semanticAvailable && jurisprudencia.searchTerm) {
      if (semanticSearchTimeoutRef.current) clearTimeout(semanticSearchTimeoutRef.current);
      semanticSearchTimeoutRef.current = setTimeout(() => {
        performSemanticSearch(jurisprudencia.searchTerm);
      }, 500);
    } else {
      setSemanticResults(null);
    }
    return () => { if (semanticSearchTimeoutRef.current) clearTimeout(semanticSearchTimeoutRef.current); };
  }, [jurisprudencia.searchTerm, useSemanticSearch, semanticAvailable, performSemanticSearch, jurisprudencia.filtros]);

  const handleToggleExpand = React.useCallback((id: string) => {
    setExpandedIds(prev => {
      const next = new Set(prev);
      next.has(id) ? next.delete(id) : next.add(id);
      return next;
    });
  }, []);

  const handleFileSelect = React.useCallback(async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;
    let totalCount = 0;
    let errors = [];
    for (const file of files) {
      const result = await jurisprudencia.handleImportJSON(file);
      if (result.success) {
        totalCount += result.count;
      } else {
        errors.push(file.name);
      }
    }
    const status = errors.length === 0
      ? { success: true, count: totalCount, message: `${files.length} arquivo(s), ${totalCount} itens` }
      : { success: false, error: `Erro em: ${errors.join(', ')}` };
    setImportStatus(status);
    setTimeout(() => setImportStatus(null), 4000);
    e.target.value = '';
  }, [jurisprudencia]);

  const tiposDisponiveis = ['IRR', 'IAC', 'IRDR', 'SÃºmula', 'OJ', 'RG', 'ADI/ADC/ADPF', 'Informativo'];
  const tribunaisDisponiveis = ['TST', 'STF', 'STJ', 'TRT8'];

  return (
    <div className="h-full flex flex-col">
      <div className="flex gap-3 mb-4">
        <div className="flex-1 relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 theme-text-muted" />
          <input
            type="text"
            placeholder={useSemanticSearch ? "Buscar por significado (ex: intervalo intrajornada)..." : "Buscar por tese, keywords ou nÃºmero..."}
            value={jurisprudencia.searchTerm}
            onChange={jurisprudencia.handleSearchChange}
            onKeyDown={(e) => e.key === 'Escape' && jurisprudencia.handleSearchChange({ target: { value: '' } } as React.ChangeEvent<HTMLInputElement>)}
            className="w-full pl-10 pr-12 py-2 border theme-input rounded-lg text-sm"
          />
          {jurisprudencia.searchTerm && !searchingSemantics && (
            <button onClick={() => jurisprudencia.handleSearchChange({ target: { value: '' } } as React.ChangeEvent<HTMLInputElement>)} className="absolute right-3 top-1/2 -translate-y-1/2 p-0.5 theme-text-muted hover-text-primary" title="Limpar (Esc)">
              <X className="w-3.5 h-3.5" />
            </button>
          )}
          {searchingSemantics && (
            <RefreshCw className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-purple-400 animate-spin" />
          )}
        </div>
        {/* v1.27.00: Toggle de busca semÃ¢ntica */}
        {/* v1.33.8: Adicionado hover:bg-purple-700 ao estado semÃ¢ntico */}
        {semanticAvailable && (
          <button
            onClick={() => setUseSemanticSearch((prev: boolean) => !prev)}
            className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5 ${
              useSemanticSearch
                ? 'bg-purple-600 text-white hover:bg-purple-700'
                : 'theme-bg-tertiary theme-text-secondary hover-slate-600'
            }`}
            title={useSemanticSearch ? 'Busca semÃ¢ntica (por significado)' : 'Busca textual (por palavras)'}
          >
            {useSemanticSearch ? 'ğŸ§ ' : 'ğŸ”¤'}
          </button>
        )}
        {/* v1.20.3: Badge de somente leitura */}
        {isReadOnly && (
          <span className="flex items-center gap-1 px-3 py-2 text-xs text-amber-400 bg-amber-500/10 rounded-lg border border-amber-500/30">
            <Eye className="w-3 h-3" />
            Somente leitura
          </span>
        )}
        <button
          onClick={() => fileInputRef.current?.click()}
          disabled={jurisprudencia.isLoading || isReadOnly}
          className={`px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium disabled:opacity-50 hover-purple-700 ${isReadOnly ? 'cursor-not-allowed' : ''}`}
          title={isReadOnly ? 'ImportaÃ§Ã£o desabilitada no modo somente leitura' : 'Importar precedentes de arquivo JSON'}
        >
          <Upload className="w-4 h-4 inline mr-2" />
          Importar JSON
        </button>
        {jurisprudencia.precedentes.length > 0 && !isReadOnly && (
          <button
            onClick={() => openModal('deleteAllPrecedentes')}
            className="p-2 rounded hover-delete-all"
            title="Excluir todos os precedentes"
          >
            <Trash2 className="w-5 h-5 text-red-400" />
          </button>
        )}
        <input ref={fileInputRef} type="file" accept=".json" multiple onChange={handleFileSelect} className="hidden" disabled={isReadOnly} />
      </div>

      {importStatus && (
        <div className={`mb-3 p-2 rounded text-xs ${importStatus.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
          {importStatus.success ? (importStatus.message || `${importStatus.count} precedentes importados`) : importStatus.error}
        </div>
      )}

      <div className="flex flex-wrap justify-between gap-y-2 mb-4">
        <div className="flex gap-2 flex-wrap">
          {tiposDisponiveis.map(tipo => (
            <button
              key={tipo}
              onClick={() => jurisprudencia.setFiltros(prev => ({
                ...prev,
                tipo: prev.tipo.includes(tipo)
                  ? prev.tipo.filter((t: string) => t !== tipo)
                  : [...prev.tipo, tipo]
              }))}
              className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
                jurisprudencia.filtros.tipo.includes(tipo)
                  ? 'bg-purple-600 text-white'
                  : 'theme-bg-tertiary theme-text-tertiary hover-slate-600'
              }`}
            >
              {tipo}
            </button>
          ))}
        </div>
        <div className="flex gap-2 flex-wrap">
          {tribunaisDisponiveis.map(trib => (
            <button
              key={trib}
              onClick={() => jurisprudencia.setFiltros(prev => ({
                ...prev,
                tribunal: prev.tribunal?.includes(trib)
                  ? prev.tribunal.filter((t: string) => t !== trib)
                  : [...(prev.tribunal || []), trib]
              }))}
              className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
                jurisprudencia.filtros.tribunal?.includes(trib)
                  ? 'bg-blue-600 text-white'
                  : 'theme-bg-tertiary theme-text-tertiary hover-slate-600'
              }`}
            >
              {trib}
            </button>
          ))}
        </div>
      </div>

      <div className="text-xs theme-text-muted mb-3">
        {useSemanticSearch && semanticResults ? (
          <span>{semanticResults.length} resultado(s) semÃ¢ntico(s) ğŸ§ </span>
        ) : (
          <span>{jurisprudencia.filteredCount} precedentes encontrados</span>
        )}
      </div>

      <div className="flex-1 overflow-y-auto space-y-3 pr-1">
        {/* v1.27.00: Resultados semÃ¢nticos */}
        {useSemanticSearch && semanticResults && semanticResults.length > 0 ? (
          semanticResults.map((result, idx) => (
            <div key={result.id || idx} className="theme-bg-secondary p-4 rounded-lg border theme-border-secondary">
              <div className="flex justify-between items-start mb-2">
                <div className="flex items-center gap-2 flex-wrap">
                  <span className="text-xs px-2 py-0.5 rounded theme-bg-tertiary theme-text-tertiary font-medium">
                    {result.tipoProcesso}
                  </span>
                  {result.numero && (
                    <span className="text-xs theme-text-muted">
                      {result.tipoProcesso === 'SÃºmula' || result.tipoProcesso === 'OJ' ? `nÂº ${result.numero}` : `Tema ${result.numero}`}
                    </span>
                  )}
                  <span className={`text-xs px-2 py-0.5 rounded font-medium ${
                    result.similarity >= 0.7 ? 'bg-green-500/20 text-green-400' :
                    result.similarity >= 0.5 ? 'bg-yellow-500/20 text-yellow-400' :
                    'bg-gray-500/20 text-gray-400'
                  }`}>
                    {Math.round(result.similarity * 100)}%
                  </span>
                  {(result.totalChunks ?? 0) > 1 && (
                    <span className="text-xs theme-text-muted">(chunk {(result.chunkIndex ?? 0) + 1}/{result.totalChunks})</span>
                  )}
                </div>
                <div className="flex items-center gap-1">
                  {result.tribunal && (
                    <span className="text-xs px-2 py-0.5 rounded bg-blue-500/20 text-blue-400">{result.tribunal}</span>
                  )}
                  <button
                    onClick={() => jurisprudencia.handleCopyTese({
                      id: result.id,
                      tipo: result.tipo || result.tipoProcesso || '',
                      numero: result.numero || '',
                      texto: result.text || result.fullText || '',
                      tipoProcesso: result.tipoProcesso,
                      titulo: result.titulo,
                      tese: result.fullText || result.text
                    })}
                    className={`p-1.5 rounded ${jurisprudencia.copiedId === result.id ? 'text-green-500' : 'hover-icon-blue-scale'}`}
                    title={jurisprudencia.copiedId === result.id ? 'Copiado!' : 'Copiar tese completa'}
                  >
                    {jurisprudencia.copiedId === result.id ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                  </button>
                </div>
              </div>
              {result.titulo && (
                <h4 className="font-semibold theme-text-primary text-sm mb-2 uppercase">{result.titulo}</h4>
              )}
              <p className="text-sm theme-text-secondary whitespace-pre-wrap">
                {result.fullText || result.text}
              </p>
            </div>
          ))
        ) : useSemanticSearch && semanticResults && semanticResults.length === 0 ? (
          <div className="text-center py-8 theme-text-muted">
            <Search className="w-12 h-12 mx-auto mb-3 opacity-40 animate-pulse" />
            <p className="text-sm">Nenhum resultado semÃ¢ntico encontrado</p>
            <p className="text-xs mt-1">Tente reduzir o threshold nas configuraÃ§Ãµes</p>
          </div>
        ) : jurisprudencia.paginatedPrecedentes.length === 0 ? (
          <div className="text-center py-8 theme-text-muted">
            <Scale className="w-12 h-12 mx-auto mb-3 opacity-40 animate-pulse" />
            <p className="text-sm">Nenhum precedente encontrado</p>
            <p className="text-xs mt-1">Importe um arquivo JSON para comeÃ§ar</p>
          </div>
        ) : (
          jurisprudencia.paginatedPrecedentes.map(p => (
            <JurisprudenciaCard
              key={p.id}
              precedente={p}
              expanded={expandedIds.has(p.id)}
              onToggleExpand={handleToggleExpand}
              onCopy={jurisprudencia.handleCopyTese}
              copiedId={jurisprudencia.copiedId}
            />
          ))
        )}
      </div>

      {/* PaginaÃ§Ã£o sÃ³ para busca textual (semÃ¢ntica usa scroll) */}
      {!useSemanticSearch && jurisprudencia.totalPages > 1 && (
        <div className="flex justify-center items-center gap-2 mt-4 pt-4 border-t theme-border-secondary">
          <button
            disabled={jurisprudencia.currentPage === 1}
            onClick={() => jurisprudencia.setCurrentPage(p => p - 1)}
            className="px-3 py-1 rounded theme-bg-tertiary text-sm disabled:opacity-50 hover-slate-600"
          >
            Anterior
          </button>
          <span className="px-3 py-1 theme-text-muted text-sm">
            {jurisprudencia.currentPage} / {jurisprudencia.totalPages}
          </span>
          <button
            disabled={jurisprudencia.currentPage === jurisprudencia.totalPages}
            onClick={() => jurisprudencia.setCurrentPage(p => p + 1)}
            className="px-3 py-1 rounded theme-bg-tertiary text-sm disabled:opacity-50 hover-slate-600"
          >
            PrÃ³xima
          </button>
        </div>
      )}

      <DeleteAllPrecedentesModal
        isOpen={modals.deleteAllPrecedentes}
        onClose={() => closeModal('deleteAllPrecedentes')}
        totalPrecedentes={jurisprudencia.precedentes.length}
        confirmText={jurisprudencia.deleteAllConfirmText}
        setConfirmText={jurisprudencia.setDeleteAllConfirmText}
        onConfirmDelete={async () => {
          if (jurisprudencia.deleteAllConfirmText === 'EXCLUIR') {
            await jurisprudencia.handleClearAll();
            closeModal('deleteAllPrecedentes');
            jurisprudencia.setDeleteAllConfirmText('');
          }
        }}
      />
    </div>
  );
});
JurisprudenciaTab.displayName = 'JurisprudenciaTab';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“œ COMPONENTE: LegislacaoTab - Aba de consulta de legislaÃ§Ã£o
// v1.20.3: Adicionado isReadOnly para modo somente leitura em aba secundÃ¡ria
// v1.26.00: Adicionado busca semÃ¢ntica
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LegislacaoTab = React.memo(({
  openModal, closeModal, modals, isReadOnly = false,
  // v1.26.00: Props para busca semÃ¢ntica
  semanticSearchEnabled = false,
  searchModelReady = false,
  embeddingsCount = 0,
  semanticThreshold = 50
}: LegislacaoTabProps) => {
  const legislacao = useLegislacao();
  const [expandedIds, setExpandedIds] = React.useState<Set<string>>(new Set());
  const [importStatus, setImportStatus] = React.useState<{ success: boolean; message?: string; count?: number; error?: string } | null>(null);
  const fileInputRef = React.useRef<HTMLInputElement | null>(null);
  // v1.26.00: Toggle local de busca semÃ¢ntica (modo de busca)
  // v1.28.01: Usa toggle global como padrÃ£o se nÃ£o houver valor no localStorage
  const [useSemanticSearch, setUseSemanticSearch] = React.useState(() => {
    try {
      const stored = localStorage.getItem('legislacaoSemanticMode');
      if (stored !== null) return stored === 'true';
      return semanticSearchEnabled; // Usa toggle global como fallback
    } catch { return false; }
  });
  const [semanticResults, setSemanticResults] = React.useState<(LegislacaoEmbeddingItem & { similarity: number })[] | null>(null);
  const [searchingSemantics, setSearchingSemantics] = React.useState(false);

  // Busca semÃ¢ntica disponÃ­vel se: toggle global ativo + modelo pronto + embeddings gerados
  const semanticAvailable = semanticSearchEnabled && searchModelReady && embeddingsCount > 0;

  // v1.26.00: Handler para busca semÃ¢ntica
  const performSemanticSearch = React.useCallback(async (query: string) => {
    if (!query || query.length < 3 || !semanticAvailable) {
      setSemanticResults(null);
      return;
    }

    setSearchingSemantics(true);
    try {
      // v1.32.20: toLowerCase para E5 case-sensitive
      const queryEmbedding = await AIModelService.getEmbedding(query.toLowerCase(), 'query');
      const threshold = semanticThreshold / 100; // Converter para 0-1
      const results = await EmbeddingsService.searchBySimilarity(queryEmbedding, threshold, 30);
      setSemanticResults(results);
    } catch (err) {
      console.error('[Semantic] Erro na busca:', err);
      setSemanticResults(null);
    } finally {
      setSearchingSemantics(false);
    }
  }, [semanticAvailable, semanticThreshold]);

  // v1.26.00: Debounce para busca semÃ¢ntica
  const semanticSearchTimeoutRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);
  React.useEffect(() => {
    if (useSemanticSearch && semanticAvailable && legislacao.searchTerm) {
      if (semanticSearchTimeoutRef.current) clearTimeout(semanticSearchTimeoutRef.current);
      semanticSearchTimeoutRef.current = setTimeout(() => {
        performSemanticSearch(legislacao.searchTerm);
      }, 500);
    } else {
      setSemanticResults(null);
    }
    return () => { if (semanticSearchTimeoutRef.current) clearTimeout(semanticSearchTimeoutRef.current); };
  }, [legislacao.searchTerm, useSemanticSearch, semanticAvailable, performSemanticSearch]);

  const handleToggleExpand = React.useCallback((id: string) => {
    setExpandedIds(prev => {
      const next = new Set(prev);
      next.has(id) ? next.delete(id) : next.add(id);
      return next;
    });
  }, []);

  const handleFileSelect = React.useCallback(async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;
    let totalCount = 0;
    let errors = [];
    for (const file of files) {
      const result = await legislacao.handleImportJSON(file);
      if (result.success) {
        totalCount += result.count;
      } else {
        errors.push(`${file.name}: ${result.error}`);
      }
    }
    const status = errors.length === 0
      ? { success: true, message: `${totalCount} artigos importados de ${files.length} arquivo(s)` }
      : { success: false, error: errors.join('; ') };
    setImportStatus(status);
    setTimeout(() => setImportStatus(null), 4000);
    e.target.value = '';
  }, [legislacao]);

  return (
    <div className="h-full flex flex-col">
      <div className="flex gap-3 mb-4">
        <div className="flex-1 relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 theme-text-muted" />
          <input
            type="text"
            placeholder={useSemanticSearch ? "Buscar por significado (ex: demissÃ£o sem justa causa)..." : "Buscar por nÃºmero (ex: 7) ou texto (ex: fÃ©rias)..."}
            value={legislacao.searchTerm}
            onChange={(e) => legislacao.setSearchTerm(e.target.value)}
            onKeyDown={(e) => e.key === 'Escape' && legislacao.setSearchTerm('')}
            className="w-full pl-10 pr-12 py-2 border theme-input rounded-lg text-sm"
          />
          {legislacao.searchTerm && !searchingSemantics && (
            <button onClick={() => legislacao.setSearchTerm('')} className="absolute right-3 top-1/2 -translate-y-1/2 p-0.5 theme-text-muted hover-text-primary" title="Limpar (Esc)">
              <X className="w-3.5 h-3.5" />
            </button>
          )}
          {searchingSemantics && (
            <RefreshCw className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-blue-400 animate-spin" />
          )}
        </div>
        {/* v1.26.00: Toggle de busca semÃ¢ntica */}
        {/* v1.33.8: Adicionado hover:bg-purple-700 ao estado semÃ¢ntico */}
        {semanticAvailable && (
          <button
            onClick={() => setUseSemanticSearch((prev: boolean) => !prev)}
            className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5 ${
              useSemanticSearch
                ? 'bg-purple-600 text-white hover:bg-purple-700'
                : 'theme-bg-tertiary theme-text-secondary hover-bg-purple-opacity'
            }`}
            title={useSemanticSearch ? 'Busca semÃ¢ntica (por significado)' : 'Busca textual (por palavras)'}
          >
            {useSemanticSearch ? 'ğŸ§ ' : 'ğŸ”¤'}
          </button>
        )}
        {/* v1.20.3: Badge de somente leitura */}
        {isReadOnly && (
          <span className="flex items-center gap-1 px-3 py-2 text-xs text-amber-400 bg-amber-500/10 rounded-lg border border-amber-500/30">
            <Eye className="w-3 h-3" />
            Somente leitura
          </span>
        )}
        <button
          onClick={() => fileInputRef.current?.click()}
          disabled={legislacao.isLoading || isReadOnly}
          className={`px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium disabled:opacity-50 hover-blue-700 ${isReadOnly ? 'cursor-not-allowed' : ''}`}
          title={isReadOnly ? 'ImportaÃ§Ã£o desabilitada no modo somente leitura' : 'Importar artigos de arquivo JSON'}
        >
          <Upload className="w-4 h-4 inline mr-2" />
          Importar JSON
        </button>
        {legislacao.artigos.length > 0 && !isReadOnly && (
          <button
            onClick={() => openModal('deleteAllLegislacao')}
            className="p-2 rounded hover-delete-all"
            title="Excluir toda legislaÃ§Ã£o"
          >
            <Trash2 className="w-5 h-5 text-red-400" />
          </button>
        )}
        <input ref={fileInputRef} type="file" accept=".json" multiple onChange={handleFileSelect} className="hidden" disabled={isReadOnly} />
      </div>

      {importStatus && (
        <div className={`mb-3 p-2 rounded text-xs ${importStatus.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
          {importStatus.success ? importStatus.message : importStatus.error}
        </div>
      )}

      {legislacao.leisDisponiveis.length > 0 && (
        <div className="flex flex-wrap gap-2 mb-4">
          <button
            onClick={() => legislacao.setLeiAtiva(null)}
            className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
              !legislacao.leiAtiva
                ? 'bg-blue-600 text-white'
                : 'theme-bg-tertiary theme-text-secondary hover-bg-blue-opacity'
            }`}
          >
            Todas ({legislacao.artigos.length})
          </button>
          {legislacao.leisDisponiveis.map(lei => {
            const meta = LEIS_METADATA[lei] || { nome: lei.toUpperCase() };
            const count = legislacao.artigos.filter(a => a.lei === lei || a.id?.startsWith(lei + '-')).length;
            return (
              <button
                key={lei}
                onClick={() => legislacao.setLeiAtiva(legislacao.leiAtiva === lei ? null : lei)}
                className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
                  legislacao.leiAtiva === lei
                    ? 'bg-blue-600 text-white'
                    : 'theme-bg-tertiary theme-text-secondary hover-bg-blue-opacity'
                }`}
                title={meta.nomeCompleto || lei}
              >
                {meta.nome} ({count})
              </button>
            );
          })}
        </div>
      )}

      {/* v1.26.00: Resultados - SemÃ¢nticos ou Textuais */}
      <div className="flex-1 overflow-hidden">
        {legislacao.isLoading ? (
          <div className="flex items-center justify-center py-12">
            <div className="animate-spin w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full" />
          </div>
        ) : useSemanticSearch && semanticResults && semanticResults.length > 0 ? (
          /* v1.26.01: Resultados semÃ¢nticos com artigo completo e destaque */
          <div className="space-y-3 overflow-y-auto h-full pr-1">
            {semanticResults
              .filter(item => !legislacao.leiAtiva || item.lei === legislacao.leiAtiva)
              .map((item, idx) => {
              const artigo = legislacao.artigos.find(a => a.id === item.artigoId);
              if (!artigo) return null;
              const hasDetails = (artigo.paragrafos && artigo.paragrafos.length > 0) || (artigo.incisos && artigo.incisos.length > 0) || (artigo.alineas && artigo.alineas.length > 0);
              const isMatchedType = (type: string) => item.type === type;
              const isMatchedParagrafo = (p: { texto?: string }) => item.type === 'paragrafo' && item.text.includes(p.texto?.slice(0, 50) || '');
              const isMatchedInciso = (inc: { numero: string; texto: string }) => item.type === 'inciso' && item.text.includes(inc.texto?.slice(0, 50));
              const isMatchedAlinea = (al: { letra: string; texto: string }) => item.type === 'alinea' && item.text.includes(al.texto?.slice(0, 50));
              return (
                <div key={`${item.id}-${idx}`} className="theme-bg-secondary-50 rounded-lg p-3 border theme-border-input">
                  <div className="flex items-start justify-between gap-2 mb-2">
                    <div className="flex items-center gap-2 flex-wrap">
                      <span className="px-2 py-0.5 bg-purple-600/20 text-purple-400 text-xs rounded font-medium">
                        {Math.round(item.similarity * 100)}% similar
                      </span>
                      <span className="text-xs theme-text-muted uppercase">{item.lei}</span>
                      <span className="text-xs font-medium theme-text-primary">Art. {artigo.numero}</span>
                      <span className="text-xs theme-text-muted capitalize">({item.type})</span>
                    </div>
                    <button
                      onClick={() => legislacao.handleCopyArtigo(artigo)}
                      className={`p-1 ${legislacao.copiedId === artigo.id ? 'text-green-500' : 'text-blue-400 hover-text-blue-300'}`}
                      title={legislacao.copiedId === artigo.id ? 'Copiado!' : 'Copiar artigo completo'}
                    >
                      {legislacao.copiedId === artigo.id ? <Check className="w-3 h-3" /> : <Copy className="w-3 h-3" />}
                    </button>
                  </div>
                  <p className={`text-sm theme-text-secondary ${isMatchedType('caput') ? 'font-semibold bg-yellow-500/10 px-1 rounded' : ''}`}>
                    {artigo.caput}
                  </p>
                  {hasDetails && (
                    <div className="mt-2 pt-2 border-t theme-border-subtle text-sm space-y-2">
                      {artigo.paragrafos && artigo.paragrafos.length > 0 && (
                        <div>
                          {artigo.paragrafos.map((p, i: number) => (
                            <p key={i} className={`theme-text-secondary ml-2 mb-1 ${isMatchedParagrafo(p) ? 'font-semibold bg-yellow-500/10 px-1 rounded' : ''}`}>
                              <span className="text-purple-400">Â§ {p.numero}Âº</span> {p.texto}
                            </p>
                          ))}
                        </div>
                      )}
                      {artigo.incisos && artigo.incisos.length > 0 && (
                        <div>
                          {artigo.incisos.map((inc, i: number) => (
                            <p key={i} className={`theme-text-secondary ml-2 mb-1 ${isMatchedInciso(inc) ? 'font-semibold bg-yellow-500/10 px-1 rounded' : ''}`}>
                              <span className="text-amber-400">{inc.numero}</span> - {inc.texto}
                            </p>
                          ))}
                        </div>
                      )}
                      {artigo.alineas && artigo.alineas.length > 0 && (
                        <div>
                          {artigo.alineas.map((al: { letra: string; texto: string }, i: number) => (
                            <p key={i} className={`theme-text-secondary ml-2 mb-1 ${isMatchedAlinea(al) ? 'font-semibold bg-yellow-500/10 px-1 rounded' : ''}`}>
                              <span className="text-teal-400">{al.letra})</span> {al.texto}
                            </p>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        ) : useSemanticSearch && legislacao.searchTerm && !searchingSemantics ? (
          <div className="text-center py-8 theme-text-muted">
            <Search className="w-8 h-8 mx-auto mb-2 opacity-50" />
            <p>Nenhum resultado semÃ¢ntico para "{legislacao.searchTerm}"</p>
            <p className="text-xs mt-1">Tente reduzir o threshold nas configuraÃ§Ãµes</p>
          </div>
        ) : legislacao.filteredArtigos.length > 0 ? (
          <VirtualList
            items={legislacao.filteredArtigos}
            itemHeight={120}
            overscan={3}
            className="h-full"
            expandedIds={expandedIds}
            renderItem={(item, _index) => {
              const artigo = item as Artigo;
              return (
                <ArtigoCard
                  key={artigo.id}
                  artigo={artigo}
                  onCopy={legislacao.handleCopyArtigo}
                  expanded={expandedIds.has(artigo.id)}
                  onToggleExpand={handleToggleExpand}
                  copiedId={legislacao.copiedId}
                />
              );
            }}
          />
        ) : legislacao.artigos.length === 0 ? (
          <div className="text-center py-12 theme-text-muted">
            <BookOpen className="w-12 h-12 mx-auto mb-3 opacity-50" />
            <p className="font-medium mb-2">Nenhuma legislaÃ§Ã£o importada</p>
            <p className="text-sm">
              Clique em "Importar JSON" para carregar artigos de leis.<br/>
              Arquivos disponÃ­veis na pasta LEGIS: clt.json, cf.json, cpc.json, etc.
            </p>
          </div>
        ) : (
          <div className="text-center py-8 theme-text-muted">
            <Search className="w-8 h-8 mx-auto mb-2 opacity-50" />
            <p>Nenhum artigo encontrado para "{legislacao.searchTerm}"</p>
          </div>
        )}
      </div>

      {/* v1.26.00: Footer com contagem (filtrada por lei) */}
      {(useSemanticSearch && semanticResults && semanticResults.length > 0) ? (() => {
        const filteredSemanticCount = semanticResults.filter(item => !legislacao.leiAtiva || item.lei === legislacao.leiAtiva).length;
        return filteredSemanticCount > 0 ? (
          <div className="flex items-center justify-center mt-3 pt-2 border-t theme-border-subtle">
            <span className="text-sm theme-text-muted flex items-center gap-2">
              <span className="text-purple-400">ğŸ§ </span>
              {filteredSemanticCount} resultado(s) semÃ¢ntico(s){legislacao.leiAtiva ? ` em ${legislacao.leiAtiva.toUpperCase()}` : ''}
            </span>
          </div>
        ) : null;
      })() : legislacao.filteredArtigos.length > 0 && (
        <div className="flex items-center justify-center mt-3 pt-2 border-t theme-border-subtle">
          <span className="text-sm theme-text-muted">
            {legislacao.filteredCount} artigo(s) â€¢ Scroll virtual ativo
          </span>
        </div>
      )}

      {/* v1.35.66: Migrado para BaseModal */}
      <BaseModal
        isOpen={modals?.deleteAllLegislacao}
        onClose={() => { closeModal('deleteAllLegislacao'); legislacao.setDeleteConfirmText(''); }}
        title="Excluir Toda LegislaÃ§Ã£o"
        icon={<AlertCircle />}
        iconColor="red"
        size="md"
      >
        <p className="theme-text-secondary mb-4">
          VocÃª estÃ¡ prestes a <strong className="text-red-400">excluir TODOS os {legislacao.artigos.length} artigo(s)</strong> da sua base de legislaÃ§Ã£o.
        </p>
        <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-3 mb-4">
          <p className="text-sm theme-text-red">âš ï¸ Esta aÃ§Ã£o nÃ£o pode ser desfeita!</p>
        </div>
        <div className="mb-4">
          <label className="block text-sm font-medium theme-text-secondary mb-2">
            Digite <strong className="text-red-400">EXCLUIR</strong> para confirmar:
          </label>
          <input
            type="text"
            value={legislacao.deleteConfirmText}
            onChange={(e) => legislacao.setDeleteConfirmText(e.target.value)}
            className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary"
            placeholder="Digite EXCLUIR"
            autoFocus
          />
        </div>
        <div className="flex gap-3">
          <button
            onClick={() => { closeModal('deleteAllLegislacao'); legislacao.setDeleteConfirmText(''); }}
            className="flex-1 px-4 py-2 rounded-lg theme-bg-tertiary theme-text-secondary"
          >
            Cancelar
          </button>
          <button
            onClick={async () => {
              if (legislacao.deleteConfirmText === 'EXCLUIR') {
                await legislacao.handleClearAll();
                closeModal('deleteAllLegislacao');
              }
            }}
            disabled={legislacao.deleteConfirmText !== 'EXCLUIR'}
            className="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white disabled:opacity-50 disabled:cursor-not-allowed"
          >
            ğŸ—‘ï¸ Excluir Tudo
          </button>
        </div>
      </BaseModal>
    </div>
  );
});
LegislacaoTab.displayName = 'LegislacaoTab';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“‹ SEÃ‡ÃƒO 5: MODAIS ESPECÃFICOS
// ~50 modais: RenameTopicModal, DeleteTopicModal, GlobalEditorModal, ConfigModal, etc.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸ”§ BaseModal: Componente base reutilizÃ¡vel para modais
// v1.33.48: ESC handler centralizado (18 modais beneficiados)
const BaseModal = React.memo(({
  isOpen,
  onClose,
  title,
  subtitle,
  icon,
  iconColor = 'blue',
  size = 'md',
  children,
  footer,
  preventClose = false // v1.33.62: Impedir fechamento (ESC, X, click fora)
}: BaseModalProps) => {
  // ESC handler - deve vir antes do early return para cleanup funcionar
  React.useEffect(() => {
    if (preventClose) return; // v1.33.62: NÃ£o registrar ESC se preventClose
    const handleEsc = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
    };
    if (isOpen) {
      window.addEventListener('keydown', handleEsc);
    }
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose, preventClose]);

  // v1.35.63: Bloquear scroll do body quando modal aberto
  React.useEffect(() => {
    if (isOpen) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => {
        document.body.style.overflow = originalOverflow;
      };
    }
  }, [isOpen]);

  if (!isOpen) return null;

  const sizes: Record<string, string> = {
    sm: 'max-w-md',
    md: 'max-w-lg',
    lg: 'max-w-2xl',
    xl: 'max-w-4xl',
    '2xl': 'max-w-5xl'
  };

  // Gradientes para o cÃ­rculo do Ã­cone
  const iconGradients: Record<string, string> = {
    blue: 'from-blue-500 to-cyan-500 shadow-blue-500/30',
    red: 'from-red-500 to-orange-500 shadow-red-500/30',
    green: 'from-green-500 to-emerald-500 shadow-green-500/30',
    yellow: 'from-yellow-500 to-orange-500 shadow-yellow-500/30',
    purple: 'from-purple-500 to-blue-500 shadow-purple-500/30',
    orange: 'from-orange-500 to-red-500 shadow-orange-500/30'
  };

  return (
    <div className={CSS.modalOverlay} onClick={preventClose ? undefined : onClose}>
      <div
        className={`${CSS.modalContainer} ${sizes[size] || sizes.md} w-full animate-modal`}
        onClick={e => e.stopPropagation()}
        style={{ animation: 'modalFadeIn 0.2s ease-out' }}
      >
        {/* Header com Ã­cone em cÃ­rculo e botÃ£o X - v1.36.22: flex-shrink-0 para nÃ£o encolher */}
        <div className={`${CSS.modalHeader} flex items-center justify-between flex-shrink-0`}>
          <div className="flex items-center gap-3">
            {icon && (
              <div className={`w-9 h-9 rounded-full bg-gradient-to-br ${iconGradients[iconColor] || iconGradients.blue} flex items-center justify-center shadow-lg`}>
                {React.cloneElement(icon as React.ReactElement<{ className?: string }>, { className: 'w-4 h-4 text-white' })}
              </div>
            )}
            <div>
              <h2 className="font-semibold theme-text-primary">{title}</h2>
              {subtitle && <p className="text-xs theme-text-secondary">{subtitle}</p>}
            </div>
          </div>
          {!preventClose && (
            <button
              onClick={onClose}
              className="w-8 h-8 rounded-full theme-bg-secondary theme-hover-bg flex items-center justify-center theme-text-secondary transition-all border theme-border-modal hover:border-current"
            >
              <X className="w-4 h-4" />
            </button>
          )}
        </div>
        {/* Content - v1.36.23: min-h-0 permite flex shrink para scroll funcionar */}
        <div className="p-5 overflow-y-auto flex-1 min-h-0">
          {children}
        </div>
        {/* Footer */}
        {footer && (
          <div className={CSS.modalFooter}>
            {footer}
          </div>
        )}
      </div>
    </div>
  );
});

// ğŸ”§ ModalFooter: Helpers para footers de modais
const ModalFooter = {
  // Footer com Cancelar + Confirmar (azul)
  Standard: ({ onClose, onConfirm, confirmText = 'Confirmar', disabled = false, loading = false }: { onClose: () => void; onConfirm: () => void; confirmText?: string; disabled?: boolean; loading?: boolean }) => (
    <>
      <button onClick={onClose} className={CSS.btnSecondary} disabled={loading}>Cancelar</button>
      <button onClick={onConfirm} disabled={disabled || loading} className={CSS.btnBlue}>
        {loading ? 'Processando...' : confirmText}
      </button>
    </>
  ),
  // Footer com apenas Fechar
  CloseOnly: ({ onClose, text = 'Fechar' }: { onClose: () => void; text?: string }) => (
    <button onClick={onClose} className={CSS.btnSecondary}>{text}</button>
  ),
  // Footer com Cancelar + AÃ§Ã£o Destrutiva (vermelho)
  Destructive: ({ onClose, onConfirm, confirmText = 'Deletar', disabled = false }: { onClose: () => void; onConfirm: () => void; confirmText?: string; disabled?: boolean }) => (
    <>
      <button onClick={onClose} className={CSS.btnSecondary}>Cancelar</button>
      <button onClick={onConfirm} disabled={disabled} className={CSS.btnRed}>{confirmText}</button>
    </>
  ),
  // Footer com Cancelar + Confirmar (verde)
  Success: ({ onClose, onConfirm, confirmText = 'Confirmar', disabled = false }: { onClose: () => void; onConfirm: () => void; confirmText?: string; disabled?: boolean }) => (
    <>
      <button onClick={onClose} className={CSS.btnSecondary}>Cancelar</button>
      <button onClick={onConfirm} disabled={disabled} className={CSS.btnGreen}>{confirmText}</button>
    </>
  )
};

// ğŸ”§ ModalWarningBox: Caixa de aviso vermelho para aÃ§Ãµes destrutivas (v1.18.3: suporta children complexos)
const ModalWarningBox = ({ children, className = '' }: { children: React.ReactNode; className?: string }) => (
  <div className={`bg-red-900/20 border border-red-500/30 rounded-lg p-3 ${className}`}>
    <div className="text-xs theme-text-red flex items-start gap-2">
      <AlertCircle className="w-4 h-4 flex-shrink-0 mt-0.5" />
      <div className="flex-1">{children}</div>
    </div>
  </div>
);

// ğŸ”§ ModalInfoBox: Caixa de informaÃ§Ã£o azul para dicas (v1.18.3: suporta children complexos)
const ModalInfoBox = ({ children, className = '' }: { children: React.ReactNode; className?: string }) => (
  <div className={`${CSS.infoBox} ${className}`}>
    <div className="text-xs theme-text-blue">{children}</div>
  </div>
);

// ğŸ”§ ModalAmberBox: Caixa de aviso amarelo
const ModalAmberBox = ({ children, className = '' }: { children: React.ReactNode; className?: string }) => (
  <div className={`theme-warning-box p-4 ${className}`}>
    {children}
  </div>
);

// ğŸ”§ ModalContentPreview: Preview de conteÃºdo em box
const ModalContentPreview = ({ title, subtitle, badge, children, className = '' }: { title?: string; subtitle?: string; badge?: string; children?: React.ReactNode; className?: string }) => (
  <div className={`theme-bg-app p-4 rounded-lg border theme-border-secondary ${className}`}>
    {title && <p className="font-semibold theme-text-primary text-lg">{title}</p>}
    {subtitle && <p className="text-sm theme-text-muted mt-1">{subtitle}</p>}
    {badge && <span className="text-xs px-2 py-1 rounded theme-bg-purple-accent theme-text-purple border border-purple-500/30 inline-block mt-2">{badge}</span>}
    {children}
  </div>
);

// Modal: Renomear TÃ³pico (migrado para BaseModal v1.18.3)
const RenameTopicModal = React.memo(({ isOpen, onClose, topicToRename, setTopicToRename, newTopicName, setNewTopicName, handleRenameTopic, isRegenerating, hasDocuments }: RenameTopicModalProps) => {
  const handleClose = () => { onClose(); setTopicToRename(null); setNewTopicName(''); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="Renomear TÃ³pico" icon={<Edit2 />} iconColor="purple" size="lg"
      footer={<>
        <button onClick={() => handleRenameTopic(true)} disabled={isRegenerating || !newTopicName.trim()} className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 bg-purple-600 text-white hover-purple-700-from-600">
          {isRegenerating ? <span className="flex items-center justify-center gap-2"><div className={CSS.spinner}></div>Regenerando...</span> : <span className="flex items-center justify-center gap-2"><Sparkles className="w-4 h-4" />Renomear e Regenerar</span>}
        </button>
        <button onClick={() => handleRenameTopic(false)} disabled={isRegenerating || !newTopicName.trim()} className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 bg-blue-600 text-white hover-blue-700-from-600">
          {isRegenerating ? <span className="flex items-center justify-center gap-2"><div className={CSS.spinner}></div>Renomeando...</span> : <span className="flex items-center justify-center gap-2"><Edit className="w-4 h-4" />Apenas Renomear</span>}
        </button>
        <button onClick={handleClose} disabled={isRegenerating} className="px-6 py-3 rounded-lg disabled:opacity-50 theme-bg-tertiary hover-slate-500">Cancelar</button>
      </>}>
      <div className="space-y-4">
        <div><label className={CSS.label}>TÃ­tulo Atual</label><p className="theme-text-muted theme-bg-app p-3 rounded">{topicToRename?.title}</p></div>
        <div><label className={CSS.label}>Novo TÃ­tulo</label><input type="text" value={newTopicName} onChange={(e) => setNewTopicName(e.target.value)} className="w-full theme-bg-app border theme-border-primary rounded-lg p-3 theme-text-secondary" placeholder="Digite o novo tÃ­tulo" /></div>
        <ModalInfoBox>
          ğŸ’¡ <strong>Escolha uma das opÃ§Ãµes:</strong>
          <ul className="mt-2 ml-4 space-y-1 theme-text-tertiary">
            <li>â€¢ <strong>Renomear e Regenerar:</strong> {hasDocuments ? 'RegerarÃ¡ com base nos documentos' : 'RegerarÃ¡ com IA'}</li>
            <li>â€¢ <strong>Apenas Renomear:</strong> MantÃ©m o mini-relatÃ³rio atual</li>
          </ul>
        </ModalInfoBox>
      </div>
    </BaseModal>
  );
});
RenameTopicModal.displayName = 'RenameTopicModal';

// Modal: Excluir TÃ³pico (migrado para BaseModal)
const DeleteTopicModal = React.memo(({ isOpen, onClose, topicToDelete, setTopicToDelete, onConfirmDelete }: DeleteTopicModalProps) => (
  <BaseModal
    isOpen={isOpen}
    onClose={() => { onClose(); setTopicToDelete(null); }}
    title="Confirmar ExclusÃ£o"
    icon={<Trash2 />}
    iconColor="red"
    size="md"
    footer={<ModalFooter.Destructive onClose={() => { onClose(); setTopicToDelete(null); }} onConfirm={onConfirmDelete} confirmText="Sim, Excluir" />}
  >
    <div className="space-y-4">
      <p className="theme-text-tertiary">Deseja realmente excluir o tÃ³pico abaixo?</p>
      <ModalContentPreview title={topicToDelete?.title}>
        {topicToDelete?.relatorio && <div className="text-sm theme-text-muted mt-2 max-h-48 overflow-y-auto">{topicToDelete.relatorio}</div>}
      </ModalContentPreview>
      <ModalWarningBox><strong>AtenÃ§Ã£o:</strong> Esta aÃ§Ã£o nÃ£o pode ser desfeita. O tÃ³pico serÃ¡ removido permanentemente.</ModalWarningBox>
    </div>
  </BaseModal>
));
DeleteTopicModal.displayName = 'DeleteTopicModal';

// Modal: Unir TÃ³picos (migrado para BaseModal v1.18.3)
const MergeTopicsModal = React.memo(({ isOpen, onClose, topicsToMerge, onConfirmMerge, isRegenerating, hasDocuments }: MergeTopicsModalProps) => {
  if (!topicsToMerge || topicsToMerge.length === 0) return null;
  return (
    <BaseModal isOpen={isOpen} onClose={onClose} title="Unir TÃ³picos" icon={<Merge />} iconColor="yellow" size="lg"
      footer={<>
        <button onClick={onConfirmMerge} disabled={isRegenerating} className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 bg-amber-600 text-white hover-amber-700-from-600">
          {isRegenerating ? <span className="flex items-center justify-center gap-2"><div className={CSS.spinner}></div>{hasDocuments ? 'Regenerando...' : 'Unindo...'}</span> : 'Confirmar UniÃ£o'}
        </button>
        <button onClick={onClose} className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500">Cancelar</button>
      </>}>
      <div className="space-y-4">
        <p className="theme-text-tertiary">VocÃª estÃ¡ prestes a unir os seguintes tÃ³picos:</p>
        <div className="space-y-2">{topicsToMerge.map((t: Topic, i: number) => <div key={i} className="theme-bg-app p-3 rounded border theme-border-input"><p className="font-medium theme-text-primary">{i+1}. {t.title}</p></div>)}</div>
        {hasDocuments ? <ModalInfoBox>âœ“ Um novo tÃ³pico unificado serÃ¡ criado e o mini-relatÃ³rio serÃ¡ regenerado com base nos documentos originais.</ModalInfoBox> : <p className="text-xs theme-text-disabled">O mini-relatÃ³rio serÃ¡ regenerado automaticamente.</p>}
      </div>
    </BaseModal>
  );
});
MergeTopicsModal.displayName = 'MergeTopicsModal';

// Modal: Separar TÃ³pico (migrado para BaseModal v1.18.3)
const SplitTopicModal = React.memo(({ isOpen, onClose, topicToSplit, setTopicToSplit, splitNames, setSplitNames, onConfirmSplit, isRegenerating, hasDocuments }: SplitTopicModalProps) => {
  if (!splitNames) return null;
  const handleClose = () => { onClose(); setTopicToSplit(null); setSplitNames(['', '']); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="Separar TÃ³pico" icon={<Split />} iconColor="orange" size="lg"
      footer={<>
        <button onClick={onConfirmSplit} disabled={isRegenerating || splitNames.filter((n: string) => n.trim()).length < 2} className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 bg-orange-600 text-white hover-orange-700-from-600">
          {isRegenerating ? <span className="flex items-center justify-center gap-2"><div className={CSS.spinner}></div>{hasDocuments ? 'Regenerando...' : 'Separando...'}</span> : 'Confirmar SeparaÃ§Ã£o'}
        </button>
        <button onClick={handleClose} className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500">Cancelar</button>
      </>}>
      <div className="space-y-4">
        <div><label className={CSS.label}>TÃ³pico Original</label><p className="theme-text-muted theme-bg-app p-3 rounded">{topicToSplit?.title}</p></div>
        <p className="theme-text-tertiary">Separe em quantos subtÃ³picos desejar:</p>
        {splitNames.map((name: string, i: number) => <div key={i}><label className={CSS.label}>SubtÃ³pico {i+1}</label><input type="text" value={name} onChange={(e) => { const n=[...splitNames]; n[i]=e.target.value; setSplitNames(n); }} className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary" placeholder={`TÃ­tulo do subtÃ³pico ${i+1}`} /></div>)}
        <button onClick={() => setSplitNames([...splitNames, ''])} className="text-sm hover-text-blue-400-from-300">+ Adicionar mais um subtÃ³pico</button>
        {hasDocuments ? <ModalInfoBox>âœ“ Cada subtÃ³pico terÃ¡ seu mini-relatÃ³rio regenerado com base nos documentos originais.</ModalInfoBox> : <p className="text-xs theme-text-disabled">O mini-relatÃ³rio serÃ¡ regenerado com as informaÃ§Ãµes relevantes.</p>}
      </div>
    </BaseModal>
  );
});
SplitTopicModal.displayName = 'SplitTopicModal';

// Modal: Criar Novo TÃ³pico (migrado para BaseModal v1.18.3)
const NewTopicModal = React.memo(({ isOpen, onClose, newTopicData, setNewTopicData, onConfirmCreate, isRegenerating, hasDocuments }: NewTopicModalProps) => {
  const data = newTopicData || { title: '', category: 'MÃ‰RITO', relatorio: '' };
  const handleClose = () => { onClose(); setNewTopicData({ title: '', category: 'MÃ‰RITO', relatorio: '' }); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="Criar Novo TÃ³pico" icon={<PlusCircle />} iconColor="green" size="lg"
      footer={<>
        <button onClick={onConfirmCreate} disabled={isRegenerating || !(data.title || '').trim()} className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 flex items-center justify-center gap-2 bg-green-600 text-white hover-green-700-from-600">
          {isRegenerating ? <><div className={CSS.spinner}></div>{hasDocuments ? 'Analisando...' : 'Criando...'}</> : 'Criar TÃ³pico'}
        </button>
        <button onClick={handleClose} className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500">Cancelar</button>
      </>}>
      <div className="space-y-4">
        <div><label className={CSS.label}>TÃ­tulo do TÃ³pico</label><input type="text" value={data.title} onChange={(e) => setNewTopicData({...data, title: e.target.value})} className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary" placeholder="Ex: Adicional de Periculosidade" /></div>
        <div><label className={CSS.label}>Categoria</label><select value={data.category} onChange={(e) => setNewTopicData({...data, category: e.target.value as TopicCategory})} className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary"><option value="PRELIMINAR">Preliminar</option><option value="PREJUDICIAL">Prejudicial</option><option value="MÃ‰RITO">MÃ©rito</option></select></div>
        <div><label className={CSS.label}>Mini-relatÃ³rio (opcional)</label><textarea value={data.relatorio} onChange={(e) => setNewTopicData({...data, relatorio: e.target.value})} className="w-full h-32 theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary resize-none" placeholder="Digite ou deixe em branco para gerar automaticamente" /></div>
        {hasDocuments ? <ModalInfoBox>âœ“ Se deixar em branco, o mini-relatÃ³rio serÃ¡ gerado com base nos documentos.</ModalInfoBox> : <p className="text-xs theme-text-disabled">Se deixar vazio, serÃ¡ gerado um texto padrÃ£o.</p>}
      </div>
    </BaseModal>
  );
});
NewTopicModal.displayName = 'NewTopicModal';

// Modal: Excluir Modelo (migrado para BaseModal)
const DeleteModelModal = React.memo(({ isOpen, onClose, modelToDelete, setModelToDelete, onConfirmDelete }: DeleteModelModalProps) => {
  if (!modelToDelete) return null;
  const handleClose = () => { onClose(); setModelToDelete(null); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="Excluir Modelo" icon={<Trash2 />} iconColor="red" size="sm"
      footer={<ModalFooter.Destructive onClose={handleClose} onConfirm={onConfirmDelete} confirmText="Excluir" />}>
      <div className="space-y-4">
        <p className="theme-text-tertiary">Tem certeza que deseja excluir o modelo:</p>
        <ModalContentPreview title={modelToDelete.title} badge={modelToDelete.category}>
          {modelToDelete.favorite && <span className="text-xl float-right">â­</span>}
        </ModalContentPreview>
        <ModalWarningBox><strong>AtenÃ§Ã£o:</strong> O modelo serÃ¡ permanentemente removido e nÃ£o poderÃ¡ ser recuperado.</ModalWarningBox>
      </div>
    </BaseModal>
  );
});
DeleteModelModal.displayName = 'DeleteModelModal';

// Modal: Excluir Todos os Modelos (migrado para BaseModal v1.18.3)
const DeleteAllModelsModal = React.memo(({ isOpen, onClose, totalModels, confirmText, setConfirmText, onConfirmDelete }: DeleteAllModelsModalProps) => {
  const handleClose = () => { onClose(); setConfirmText(''); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="ATENÃ‡ÃƒO: ExclusÃ£o em Massa" icon={<AlertCircle />} iconColor="red" size="md"
      footer={<>
        <button onClick={handleClose} className={CSS.btnSecondary}>Cancelar</button>
        <button onClick={onConfirmDelete} disabled={confirmText !== 'EXCLUIR'} className="flex-1 px-4 py-3 rounded-lg disabled:theme-bg-tertiary disabled:cursor-not-allowed font-medium bg-red-600 text-white hover-red-700-from-600">ğŸ—‘ï¸ Excluir Tudo</button>
      </>}>
      <div className="space-y-4">
        <p className="theme-text-tertiary">VocÃª estÃ¡ prestes a <strong className="text-red-400">excluir TODOS os {totalModels} modelo(s)</strong> da sua biblioteca.</p>
        <ModalWarningBox>
          âš ï¸ <strong>ATENÃ‡ÃƒO:</strong> Todos os modelos serÃ£o permanentemente removidos. Esta aÃ§Ã£o nÃ£o pode ser desfeita!
          <ul className="mt-2 ml-4 list-disc space-y-1 theme-text-secondary">
            <li>Todos os {totalModels} modelos serÃ£o excluÃ­dos</li>
            <li>As sugestÃµes automÃ¡ticas nÃ£o funcionarÃ£o mais</li>
            <li>VocÃª precisarÃ¡ recriar ou importar novos modelos</li>
          </ul>
        </ModalWarningBox>
        <div>
          <label className={CSS.label}>Para confirmar, digite <strong className="text-red-400">EXCLUIR</strong>:</label>
          <input type="text" value={confirmText} onChange={(e) => setConfirmText(e.target.value)} className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary" placeholder="Digite EXCLUIR" autoFocus />
          {confirmText && confirmText !== 'EXCLUIR' && <p className="text-xs text-red-400 mt-1">âŒ Digite exatamente "EXCLUIR"</p>}
        </div>
      </div>
    </BaseModal>
  );
});
DeleteAllModelsModal.displayName = 'DeleteAllModelsModal';

const DeleteAllPrecedentesModal = React.memo(({ isOpen, onClose, totalPrecedentes, confirmText, setConfirmText, onConfirmDelete }: DeleteAllPrecedentesModalProps) => {
  const handleClose = () => { onClose(); setConfirmText(''); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="ATENÃ‡ÃƒO: ExclusÃ£o em Massa" icon={<AlertCircle />} iconColor="red" size="md"
      footer={<>
        <button onClick={handleClose} className={CSS.btnSecondary}>Cancelar</button>
        <button onClick={onConfirmDelete} disabled={confirmText !== 'EXCLUIR'} className="flex-1 px-4 py-3 rounded-lg disabled:theme-bg-tertiary disabled:cursor-not-allowed font-medium bg-red-600 text-white hover-red-700-from-600">ğŸ—‘ï¸ Excluir Tudo</button>
      </>}>
      <div className="space-y-4">
        <p className="theme-text-tertiary">VocÃª estÃ¡ prestes a <strong className="text-red-400">excluir TODOS os {totalPrecedentes} precedente(s)</strong> da sua base.</p>
        <ModalWarningBox>
          âš ï¸ <strong>ATENÃ‡ÃƒO:</strong> Todos os precedentes serÃ£o permanentemente removidos. Esta aÃ§Ã£o nÃ£o pode ser desfeita!
        </ModalWarningBox>
        <div>
          <label className={CSS.label}>Para confirmar, digite <strong className="text-red-400">EXCLUIR</strong>:</label>
          <input type="text" value={confirmText} onChange={(e) => setConfirmText(e.target.value)} className="w-full theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary" placeholder="Digite EXCLUIR" autoFocus />
          {confirmText && confirmText !== 'EXCLUIR' && <p className="text-xs text-red-400 mt-1">âŒ Digite exatamente "EXCLUIR"</p>}
        </div>
      </div>
    </BaseModal>
  );
});
DeleteAllPrecedentesModal.displayName = 'DeleteAllPrecedentesModal';

// Modal: Confirmar ExtraÃ§Ã£o de Modelo
const ExtractModelConfirmModal = React.memo(({
  isOpen,
  onClose,
  editingTopic,
  editorRef,
  onConfirmExtract
}: ExtractModelConfirmModalProps) => {
  // ESC handler
  React.useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => { if (e.key === 'Escape') onClose(); };
    if (isOpen) window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div className={CSS.modalOverlay}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-lg w-full`}>
        <div className={CSS.modalHeader}>
          <div className="flex items-center justify-between w-full">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-purple-500/20">
                <Zap className="w-6 h-6 text-purple-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold theme-text-primary">Criar Modelo GenÃ©rico</h3>
                <p className="text-sm theme-text-muted">Confirme a criaÃ§Ã£o do modelo reutilizÃ¡vel</p>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>

        <div className="p-6">
          <div className="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4 mb-4">
            <p className="theme-text-tertiary text-sm mb-3">
              A IA irÃ¡ analisar seu texto e criar um <strong>modelo genÃ©rico reutilizÃ¡vel</strong> que:
            </p>
            <ul className="text-xs theme-text-muted space-y-2 ml-4 list-disc">
              <li>Remove nomes especÃ­ficos de pessoas e empresas</li>
              <li>Remove valores monetÃ¡rios e datas</li>
              <li>MantÃ©m a fundamentaÃ§Ã£o jurÃ­dica intacta</li>
              <li>Gera palavras-chave automaticamente</li>
              <li>Salva na biblioteca de modelos</li>
            </ul>
          </div>

          {/* v1.9.37: Cores corrigidas para tema claro */}
          <div className="bg-amber-500/10 border border-amber-500/40 rounded-lg p-3 mb-4">
            <div className="flex items-start gap-2">
              <span className="text-amber-500 text-lg">âš ï¸</span>
              <div>
                <p className="text-xs text-amber-700 dark:text-amber-200 font-semibold mb-1">AtenÃ§Ã£o:</p>
                <p className="text-xs text-amber-600 dark:text-amber-100">
                  O texto atual serÃ¡ enviado para a API da Anthropic para processamento.
                  Certifique-se de que nÃ£o hÃ¡ informaÃ§Ãµes sensÃ­veis que nÃ£o devem ser compartilhadas.
                </p>
              </div>
            </div>
          </div>

          <div className="theme-bg-secondary-50 rounded-lg p-3 mb-4">
            <p className="text-xs theme-text-muted mb-1">
              <strong className="theme-text-tertiary">TÃ³pico:</strong> {editingTopic?.title}
            </p>
            <p className={CSS.textMuted}>
              <strong className="theme-text-tertiary">Tamanho do texto:</strong> {editorRef?.current?.root?.innerText?.length || 0} caracteres
            </p>
          </div>
        </div>

        <div className={CSS.modalFooter}>
          <button
            onClick={onClose}
            className="flex-1 px-4 py-3 rounded-lg font-medium hover-slate-700-from-600"
          >
            âŒ Cancelar
          </button>
          <button
            onClick={onConfirmExtract}
            className="flex-1 px-4 py-3 rounded-lg font-medium shadow-lg hover-gradient-purple-pink bg-gradient-to-r from-purple-600 to-pink-500 text-white transition-all duration-300"
          >
            âœ¨ Criar Modelo
          </button>
        </div>
      </div>
    </div>
  );
});

ExtractModelConfirmModal.displayName = 'ExtractModelConfirmModal';

// Modal: Preview de Modelo ExtraÃ­do
const ExtractedModelPreviewModal = React.memo(({
  isOpen,
  onClose,
  extractedModel,
  setExtractedModel,
  onSave,
  onCancel,
  sanitizeHTML = (html: string) => html || ''
}: ExtractedModelPreviewModalProps) => {
  // ESC handler
  React.useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => { if (e.key === 'Escape') onClose(); };
    if (isOpen) window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  if (!isOpen || !extractedModel) return null;

  return (
    <div className={`${CSS.modalOverlay} overflow-y-auto`} style={{ alignItems: 'flex-start', paddingTop: '2rem' }}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-4xl w-full my-8`}>
        {/* Header */}
        <div className={CSS.modalHeader}>
          <div className="flex items-center justify-between w-full">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-purple-500/20">
                <Edit className="w-6 h-6 text-purple-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold theme-text-primary">Revisar e Editar Modelo Gerado</h3>
                <p className="text-sm theme-text-muted">Revise o modelo extraÃ­do antes de salvÃ¡-lo na biblioteca</p>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>

        {/* ConteÃºdo editÃ¡vel */}
        <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
          {/* TÃ­tulo */}
          <div>
            <label className="block text-sm font-semibold theme-text-tertiary mb-2">
              TÃ­tulo do Modelo
            </label>
            <input
              type="text"
              value={extractedModel.title}
              onChange={(e) => setExtractedModel({ ...extractedModel, title: e.target.value })}
              className="w-full px-4 py-3 theme-bg-secondary border theme-border-input rounded-lg theme-text theme-placeholder focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all"
              placeholder="Ex: Adicional de Periculosidade - Modelo"
            />
          </div>

          {/* Categoria */}
          <div>
            <label className="block text-sm font-semibold theme-text-tertiary mb-2">
              ğŸ“‚ Categoria
            </label>
            <select
              value={extractedModel.category || ''}
              onChange={(e) => setExtractedModel({ ...extractedModel, category: e.target.value })}
              className="w-full px-4 py-3 theme-bg-secondary border theme-border-input rounded-lg theme-text focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all"
            >
              <option value="Preliminar">Preliminar</option>
              <option value="MÃ©rito">MÃ©rito</option>
              <option value="Pedidos">Pedidos</option>
              <option value="Outros">Outros</option>
            </select>
          </div>

          {/* Palavras-chave */}
          <div>
            <label className="block text-sm font-semibold theme-text-tertiary mb-2">
              ğŸ·ï¸ Palavras-chave
            </label>
            <input
              type="text"
              value={extractedModel.keywords || ''}
              onChange={(e) => setExtractedModel({ ...extractedModel, keywords: e.target.value })}
              className="w-full px-4 py-3 theme-bg-secondary border theme-border-input rounded-lg theme-text theme-placeholder focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all"
              placeholder="palavras, separadas, por vÃ­rgulas"
            />
            <p className="text-xs theme-text-muted mt-1">Separe as palavras-chave com vÃ­rgulas</p>
          </div>

          {/* Preview do ConteÃºdo */}
          <div>
            <label className="block text-sm font-semibold theme-text-tertiary mb-2">
              Preview do ConteÃºdo
            </label>
            <div
              className="w-full px-4 py-3 theme-bg-secondary border theme-border-input rounded-lg min-h-[200px] max-h-[300px] overflow-y-auto theme-text"
              dangerouslySetInnerHTML={{ __html: sanitizeHTML(extractedModel.content || '') }}
            />
            <p className="text-xs theme-text-muted mt-1">
              ConteÃºdo editado no modal anterior
            </p>
          </div>
        </div>

        {/* Footer com aÃ§Ãµes */}
        <div className={CSS.modalFooter}>
          <button
            onClick={onCancel}
            className="flex-1 px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 hover-slate-700-from-600"
          >
            <span>âŒ</span>
            Cancelar
          </button>
          <button
            onClick={onSave}
            disabled={!(extractedModel.title ?? '').trim() || !(extractedModel.content ?? '').trim()}
            className="flex-1 px-6 py-3 disabled:from-gray-600 disabled:to-gray-600 disabled:cursor-not-allowed rounded-lg font-medium shadow-lg flex items-center justify-center gap-2 hover-gradient-purple-pink-darker transition-all duration-300"
          >
            <Save className="w-5 h-5" />
            Salvar Modelo
          </button>
        </div>
      </div>
    </div>
  );
});

ExtractedModelPreviewModal.displayName = 'ExtractedModelPreviewModal';

// Modal: Adicionar Prova (Texto) (migrado para BaseModal v1.18.3)
const AddProofTextModal = React.memo(({ isOpen, onClose, newProofData, setNewProofData, onAddProof }: AddProofTextModalProps) => {
  const data = newProofData || { name: '', text: '' };
  const handleClose = () => { onClose(); setNewProofData({ name: '', text: '' }); };
  return (
    <BaseModal isOpen={isOpen} onClose={handleClose} title="Adicionar Prova (Texto)" icon={<FileText />} iconColor="blue" size="lg"
      footer={<>
        <button onClick={handleClose} className={CSS.btnSecondary}>Cancelar</button>
        <button onClick={onAddProof} disabled={!data.text.trim()} className="px-6 py-2 rounded-lg disabled:opacity-50 bg-blue-600 text-white hover-blue-700-from-600">Adicionar Prova</button>
      </>}>
      <div className="space-y-4">
        <div><label className={CSS.label}>Nome da Prova</label><input type="text" value={data.name} onChange={(e) => setNewProofData((prev: { name: string; text: string }) => ({...prev, name: e.target.value}))} placeholder="Ex: Contracheques, Ata de AudiÃªncia" className="w-full px-4 py-2 theme-bg-secondary border theme-border-input rounded-lg theme-text-secondary" /></div>
        <div><label className={CSS.label}>Texto da Prova</label><textarea value={data.text} onChange={(e) => setNewProofData((prev: { name: string; text: string }) => ({...prev, text: e.target.value}))} placeholder="Cole aqui o texto da prova..." rows={12} className="w-full px-4 py-2 theme-bg-secondary border theme-border-input rounded-lg theme-text-secondary font-mono text-sm" /></div>
      </div>
    </BaseModal>
  );
});
AddProofTextModal.displayName = 'AddProofTextModal';

// v1.33.45: Migrado para BaseModal
const ProofAnalysisModal = React.memo(({
  isOpen,
  onClose,
  proofToAnalyze,
  customInstructions,
  setCustomInstructions,
  useOnlyMiniRelatorios,
  setUseOnlyMiniRelatorios,
  includeLinkedTopicsInFree,
  setIncludeLinkedTopicsInFree,
  proofTopicLinks,
  onAnalyzeContextual,
  onAnalyzeFree,
  editorTheme = 'dark'
}: ProofAnalysisModalProps) => {
  if (!isOpen || !proofToAnalyze) return null;

  const linkedTopicsCount = proofTopicLinks[proofToAnalyze.id]?.length || 0;

  return (
    <BaseModal
      isOpen={isOpen}
      onClose={onClose}
      title="Analisar Prova com IA"
      subtitle={proofToAnalyze.name}
      icon={<Sparkles />}
      iconColor="blue"
      size="lg"
      footer={<ModalFooter.CloseOnly onClose={onClose} text="Cancelar" />}
    >
      <div className="space-y-4">
        <p className="text-sm theme-text-tertiary">
          Selecione o tipo de anÃ¡lise que deseja realizar nesta prova:
        </p>

        {/* Campo de InstruÃ§Ãµes Personalizadas */}
        <div>
          <label className={CSS.label}>
            InstruÃ§Ãµes Personalizadas (Opcional)
          </label>
          <textarea
            value={customInstructions}
            onChange={(e) => setCustomInstructions(e.target.value)}
            placeholder="Adicione instruÃ§Ãµes especÃ­ficas para esta anÃ¡lise (ex: 'Focar em valores monetÃ¡rios', 'Verificar datas de vÃ­nculos empregatÃ­cios', 'Identificar assinaturas e testemunhas', etc.)..."
            rows={3}
            className="w-full px-3 py-2 theme-bg-secondary-50 border theme-border-input rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent theme-text-secondary text-sm resize-none"
          />
          <p className="text-xs theme-text-disabled mt-1">
            Estas instruÃ§Ãµes serÃ£o adicionadas ao prompt de anÃ¡lise da IA.
          </p>
        </div>

        {/* OpÃ§Ã£o 1: AnÃ¡lise Contextual (com checkbox de mini-relatÃ³rios dentro) */}
        <div className={`rounded-lg ${editorTheme === 'light' ? 'hover-button-contextual-light' : 'hover-button-contextual'}`}>
          <button
            onClick={onAnalyzeContextual}
            className="w-full p-4 text-left"
          >
            <div className="flex items-start gap-3">
              <div className="icon-wrapper p-2 bg-purple-600/20 rounded-lg transition-colors">
                <Scale className="w-5 h-5 text-purple-400" />
              </div>
              <div className="flex-1">
                <h4 className="font-semibold theme-text-secondary mb-1">AnÃ¡lise Contextual</h4>
                <p className="text-sm theme-text-muted">
                  Compara a prova com as alegaÃ§Ãµes da petiÃ§Ã£o e contestaÃ§Ã£o, avaliando se prova ou refuta os pontos discutidos no processo.
                </p>
              </div>
            </div>
          </button>
          {linkedTopicsCount > 0 && (
            <div className="px-4 pb-4 pt-0">
              <label
                className="flex items-center gap-2 cursor-pointer text-xs theme-text-muted hover-label-text-purple"
                onClick={(e) => e.stopPropagation()}
              >
                <input
                  type="checkbox"
                  checked={useOnlyMiniRelatorios}
                  onChange={(e) => setUseOnlyMiniRelatorios(e.target.checked)}
                  className="w-3.5 h-3.5 rounded border-purple-600 theme-bg-secondary text-purple-500 focus:ring-1 focus:ring-purple-500 cursor-pointer"
                />
                <span>Usar apenas mini-relatÃ³rios dos {linkedTopicsCount} tÃ³pico(s) vinculado(s)</span>
              </label>
            </div>
          )}
        </div>

        {/* OpÃ§Ã£o 2: AnÃ¡lise Livre (com checkbox de tÃ³picos vinculados) */}
        <div className={`rounded-lg ${editorTheme === 'light' ? 'hover-button-free-light' : 'hover-button-free'}`}>
          <button
            onClick={onAnalyzeFree}
            className="w-full p-4 text-left"
          >
            <div className="flex items-start gap-3">
              <div className="icon-wrapper p-2 bg-green-600/20 rounded-lg transition-colors">
                <Edit className="w-5 h-5 text-green-400" />
              </div>
              <div className="flex-1">
                <h4 className="font-semibold theme-text-secondary mb-1">AnÃ¡lise Livre</h4>
                <p className="text-sm theme-text-muted">
                  Envia apenas a prova e suas instruÃ§Ãµes personalizadas.
                </p>
              </div>
            </div>
          </button>
          {linkedTopicsCount > 0 && (
            <div className="px-4 pb-4 pt-0">
              <label
                className="flex items-center gap-2 cursor-pointer text-xs theme-text-muted hover-label-text-green"
                onClick={(e) => e.stopPropagation()}
              >
                <input
                  type="checkbox"
                  checked={includeLinkedTopicsInFree}
                  onChange={(e) => setIncludeLinkedTopicsInFree(e.target.checked)}
                  className="w-3.5 h-3.5 rounded border-green-600 theme-bg-secondary text-green-500 focus:ring-1 focus:ring-green-500 cursor-pointer"
                />
                <span>Incluir tÃ³picos vinculados ({linkedTopicsCount} tÃ³p.)</span>
              </label>
            </div>
          )}
        </div>
      </div>
    </BaseModal>
  );
});

ProofAnalysisModal.displayName = 'ProofAnalysisModal';

// v1.33.45: Migrado para BaseModal
const LinkProofModal = React.memo(({
  isOpen,
  onClose,
  proofToLink,
  extractedTopics,
  proofTopicLinks,
  setProofTopicLinks
}: LinkProofModalProps) => {
  if (!isOpen || !proofToLink) return null;

  return (
    <BaseModal
      isOpen={isOpen}
      onClose={onClose}
      title="Vincular Prova a TÃ³picos"
      subtitle={proofToLink.name}
      icon={<Scale />}
      iconColor="purple"
      size="lg"
      footer={
        <button
          onClick={onClose}
          className="px-6 py-2 rounded-lg font-medium bg-purple-600 text-white hover-purple-700-from-600"
        >
          Concluir
        </button>
      }
    >
      {/* Scroll com margens negativas para compensar padding do BaseModal */}
      <div className="max-h-[50vh] overflow-y-auto -mx-5 px-5">
        {extractedTopics.length === 0 ? (
          <div className="text-center py-8 theme-text-muted">
            <AlertCircle className="w-12 h-12 mx-auto mb-3 opacity-50" />
            <p>Nenhum tÃ³pico disponÃ­vel</p>
            <p className="text-sm mt-2">Primeiro analise os documentos na aba "Upload & AnÃ¡lise"</p>
          </div>
        ) : (
          <div className="space-y-2">
            <p className="text-sm theme-text-muted mb-4">
              Selecione os tÃ³picos aos quais esta prova se relaciona:
            </p>
            {extractedTopics.map((topic: Topic) => {
              const isLinked = proofTopicLinks[proofToLink.id]?.includes(topic.title) || false;
              return (
                <label
                  key={topic.title}
                  className={`flex items-start gap-3 p-3 rounded-lg cursor-pointer transition-all ${
                    isLinked
                      ? 'bg-purple-600/20 border border-purple-500/50'
                      : 'theme-bg-secondary-50 border theme-border-input hover-border-purple-alpha-30'
                  }`}
                >
                  <input
                    type="checkbox"
                    checked={isLinked}
                    onChange={(e) => {
                      if (e.target.checked) {
                        setProofTopicLinks((prev: Record<string, string[]>) => ({
                          ...prev,
                          [proofToLink.id]: [...(prev[proofToLink.id] || []), topic.title]
                        }));
                      } else {
                        setProofTopicLinks((prev: Record<string, string[]>) => ({
                          ...prev,
                          [proofToLink.id]: (prev[proofToLink.id] || []).filter((t: string) => t !== topic.title)
                        }));
                      }
                    }}
                    className="mt-1 w-4 h-4 rounded theme-border text-purple-600 focus:ring-2 focus:ring-purple-500 focus:ring-offset-0 theme-bg-secondary"
                  />
                  <div className="flex-1">
                    <div className={CSS.flexGap2}>
                      <span className="font-medium theme-text-secondary">{topic.title}</span>
                      <span className={`px-2 py-0.5 text-xs rounded ${
                        topic.category === 'PRELIMINAR'
                          ? 'bg-yellow-500/20 text-yellow-300'
                          : topic.category === 'PREJUDICIAL'
                          ? 'bg-orange-500/20 text-orange-300'
                          : 'theme-bg-blue-accent theme-text-blue'
                      }`}>
                        {topic.category}
                      </span>
                    </div>
                    {topic.relatorio && (
                      <p className="text-xs theme-text-muted mt-1 line-clamp-2">
                        {(topic.relatorio.replace(/<[^>]*>/g, '')).substring(0, 120)}...
                      </p>
                    )}
                  </div>
                </label>
              );
            })}
          </div>
        )}
      </div>
    </BaseModal>
  );
});

LinkProofModal.displayName = 'LinkProofModal';

// Modal: Excluir Prova (migrado para BaseModal)
// v1.36.30: Fix race condition - isOpen && proofToDelete para evitar modal vazio
const DeleteProofModal = React.memo(({ isOpen, onClose, proofToDelete, onConfirmDelete }: DeleteProofModalProps) => {
  return (
    <BaseModal isOpen={isOpen && !!proofToDelete} onClose={onClose} title="Confirmar ExclusÃ£o" icon={<Trash2 />} iconColor="red" size="md"
      footer={<ModalFooter.Destructive onClose={onClose} onConfirm={onConfirmDelete} confirmText="Excluir Prova" />}>
      {proofToDelete && (
        <div className="space-y-4">
          <p className="theme-text-tertiary">Deseja excluir a prova abaixo?</p>
          <ModalContentPreview title={proofToDelete.name}>
            <span className={`px-2 py-0.5 text-xs rounded ml-2 ${proofToDelete.isPdf ? 'theme-bg-red-accent theme-text-red' : 'theme-bg-blue-accent theme-text-blue'}`}>
              {proofToDelete.isPdf ? 'PDF' : 'TEXTO'}
            </span>
            {!proofToDelete.isPdf && proofToDelete.text && <p className="text-xs theme-text-muted mt-2">{proofToDelete.text.substring(0, 200)}...</p>}
          </ModalContentPreview>
          <ModalWarningBox><strong>AtenÃ§Ã£o:</strong> Esta aÃ§Ã£o nÃ£o pode ser desfeita.</ModalWarningBox>
        </div>
      )}
    </BaseModal>
  );
});
DeleteProofModal.displayName = 'DeleteProofModal';

// ğŸ’¬ v1.19.0: ChatBubble - Mensagem individual no chat
const ChatBubble = React.memo(({ msg, onUse, showUse, sanitizeHTML = (html: string) => html || '' }: ChatBubbleProps) => {
  const isUser = msg.role === 'user';
  const time = new Date(msg.ts ?? Date.now()).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
  // v1.19.4: Converter Markdown bÃ¡sico para HTML (fix espaÃ§amento)
  const markdownToHtml = (text: string) => {
    if (!text) return '';
    return text
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*([^*\n]+)\*/g, '<em>$1</em>')
      .replace(/\n+/g, '<br>');
  };

  return (
    <div className={`flex ${isUser ? 'justify-end' : 'justify-start'}`}>
      <div className="max-w-[85%]">
        <div className={`text-xs mb-1 theme-text-muted ${isUser ? 'text-right' : ''}`}>
          {isUser ? 'ğŸ‘¤ VocÃª' : 'ğŸ¤– Assistente'} <span className="ml-1">{time}</span>
        </div>
        <div className={`rounded-lg p-3 ${
          isUser
            ? 'bg-purple-600/20 border border-purple-500/30'
            : 'theme-bg-secondary border theme-border-input'
        }`}>
          {isUser ? (
            <p className="theme-text-primary text-sm whitespace-pre-wrap">{msg.content}</p>
          ) : (
            <div
              className="theme-text-secondary text-sm leading-relaxed"
              dangerouslySetInnerHTML={{ __html: sanitizeHTML(markdownToHtml(msg.content)) }}
            />
          )}
        </div>
        {msg.error && (
          <div className="text-xs text-red-400 mt-1">âš ï¸ Erro: {msg.error}</div>
        )}
        {!isUser && showUse && !msg.error && (
          <div className="flex justify-end mt-1">
            <button
              onClick={() => onUse(msg.content)}
              className="text-xs px-2 py-1 rounded theme-bg-tertiary theme-text-muted hover-green-700"
            >
              Usar â†‘
            </button>
          </div>
        )}
      </div>
    </div>
  );
});
ChatBubble.displayName = 'ChatBubble';

// ğŸ’¬ v1.19.0: ChatHistoryArea - Ãrea de histÃ³rico do chat
const ChatHistoryArea = React.memo(({ history, generating, onUseMessage, showUseButtons, sanitizeHTML }: ChatHistoryAreaProps) => {
  const ref = React.useRef<HTMLDivElement | null>(null);

  React.useEffect(() => {
    if (ref.current) ref.current.scrollTop = ref.current.scrollHeight;
  }, [history, generating]);

  return (
    <div ref={ref} className="h-80 overflow-y-auto p-4 space-y-4 theme-bg-app" role="log" aria-live="polite">
      {history.length === 0 ? (
        <div className="h-full flex items-center justify-center">
          <div className="text-center theme-text-muted">
            <Sparkles className="w-8 h-8 mx-auto mb-2 opacity-50" />
            <p className="text-sm">Inicie a conversa com sua instruÃ§Ã£o</p>
            <p className="text-xs mt-1">A IA pode fazer perguntas se precisar de mais informaÃ§Ãµes</p>
          </div>
        </div>
      ) : (
        history.map((msg: { role: string; content: string }, i: number) => (
          <ChatBubble
            key={i}
            msg={msg}
            onUse={onUseMessage}
            showUse={showUseButtons && msg.role === 'assistant'}
            sanitizeHTML={sanitizeHTML}
          />
        ))
      )}
      {generating && (
        <div className="flex justify-start">
          <div className="max-w-[85%]">
            <div className="text-xs mb-1 theme-text-muted">ğŸ¤– Assistente</div>
            <div className="rounded-lg p-3 theme-bg-secondary border theme-border-input flex items-center gap-2">
              <div className="w-4 h-4 border-2 border-purple-500 border-t-transparent rounded-full animate-spin" />
              <span className="text-sm theme-text-muted">Gerando...</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
});
ChatHistoryArea.displayName = 'ChatHistoryArea';

// ğŸ’¬ v1.19.0: ChatInput - Campo de entrada do chat
const ChatInput = React.memo(({ onSend, disabled, placeholder }: ChatInputProps) => {
  const [value, setValue] = React.useState('');

  const handleSend = () => {
    if (!value.trim() || disabled) return;
    onSend(value.trim());
    setValue('');
  };

  const handleKey = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  // v1.35.59: Handler para Voice-to-Text - adiciona texto ao valor
  const handleVoiceTranscript = React.useCallback((text: string) => {
    setValue(prev => (prev ? prev + ' ' : '') + text);
  }, []);

  return (
    <div className="flex gap-2">
      <textarea
        value={value}
        onChange={(e) => setValue(e.target.value)}
        onKeyDown={handleKey}
        disabled={disabled}
        className="flex-1 h-20 theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary resize-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 disabled:opacity-50"
        placeholder={placeholder}
      />
      {/* v1.35.59: VoiceButton para ditado */}
      <VoiceButton
        onTranscript={handleVoiceTranscript}
        size="sm"
        className="self-end mb-1"
      />
      <button
        onClick={handleSend}
        disabled={!value.trim() || disabled}
        className="px-4 rounded-lg font-medium disabled:opacity-50 text-white bg-gradient-to-r from-purple-600 to-blue-600 hover-purple-700"
      >
        {disabled ? (
          <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
        ) : (
          'Enviar'
        )}
      </button>
    </div>
  );
});
ChatInput.displayName = 'ChatInput';

// ğŸ’¬ v1.19.0: InsertDropdown - Dropdown para inserir resposta
const InsertDropdown = React.memo(({ onInsert, disabled }: InsertDropdownProps) => {
  const [open, setOpen] = React.useState(false);

  if (disabled) return null;

  return (
    <div className="relative">
      <button
        onClick={() => setOpen(!open)}
        className="px-4 py-2 rounded-lg font-medium bg-green-600 text-white hover-green-700-from-600 flex items-center gap-2"
      >
        Inserir Ãšltima Resposta
        <ChevronDown className={`w-4 h-4 transition-transform ${open ? 'rotate-180' : ''}`} />
      </button>
      {open && (
        <>
          <div className="fixed inset-0 z-10" onClick={() => setOpen(false)} />
          <div className="absolute bottom-full left-0 mb-1 z-20 theme-bg-primary border theme-border-input rounded-lg shadow-xl py-1 min-w-[180px]">
            <button onClick={() => { onInsert('replace'); setOpen(false); }} className="w-full px-4 py-2 text-left text-sm hover-amber-600 text-amber-400">
              Substituir Tudo
            </button>
            <button onClick={() => { onInsert('prepend'); setOpen(false); }} className="w-full px-4 py-2 text-left text-sm hover-blue-600 text-blue-400">
              Adicionar no InÃ­cio
            </button>
            <button onClick={() => { onInsert('append'); setOpen(false); }} className="w-full px-4 py-2 text-left text-sm hover-green-600 text-green-400">
              Adicionar no Final
            </button>
          </div>
        </>
      )}
    </div>
  );
});
InsertDropdown.displayName = 'InsertDropdown';

// ğŸ†• v1.21.1: Detecta se uma prova Ã© do tipo oral/testemunhal pelo nome
const isOralProof = (proofName: string | undefined) => {
  const keywords = ['audiÃªncia', 'audiencia', 'depoimento', 'testemunha', 'transcriÃ§Ã£o', 'transcricao', 'ata', 'oral', 'oitiva'];
  const nameLower = (proofName || '').toLowerCase();
  return keywords.some(kw => nameLower.includes(kw));
};

// ğŸ†• v1.21.1: Verifica se hÃ¡ provas orais vinculadas a um tÃ³pico
const hasOralProofsForTopic = (proofManager: { proofTopicLinks?: Record<string, string[]>; proofFiles: ProofFile[]; proofTexts: ProofText[] } | null, topicTitle: string | undefined) => {
  if (!proofManager || !topicTitle) return false;
  const proofTopicLinks = proofManager.proofTopicLinks || {};
  const linkedProofIds = Object.keys(proofTopicLinks).filter(proofId =>
    proofTopicLinks[proofId]?.includes(topicTitle)
  );
  const allLinkedProofs = [
    ...(proofManager.proofFiles || []).filter((p: ProofFile) => linkedProofIds.includes(String(p.id))),
    ...(proofManager.proofTexts || []).filter((p: ProofText) => linkedProofIds.includes(String(p.id)))
  ];
  return allLinkedProofs.some(p => isOralProof(p.name));
};

// ğŸ¤– v1.19.0: AIAssistantBaseLegacy - Base LEGACY para Assistentes IA (modo single-shot, usado por AIAssistantModelModal)
const AIAssistantBaseLegacy = React.memo(({
  isOpen,
  onClose,
  aiInstruction,
  setAiInstruction,
  generatingAi,
  aiGeneratedText,
  onGenerateText,
  onInsertText,
  // ConfiguraÃ§Ãµes opcionais
  title = 'Assistente de RedaÃ§Ã£o IA',
  subtitle = 'Instrua a IA sobre o que vocÃª deseja escrever',
  zIndex = 60,
  placeholder = 'Ex: Escreva um parÃ¡grafo explicando por que as horas extras sÃ£o devidas, considerando que havia controle de ponto irregular...',
  // Componente extra no topo do content (antes do campo de instruÃ§Ãµes)
  extraContent = null,
  // Exemplos personalizados (opcional)
  customExamples = null,
  // Controle de quais botÃµes mostrar
  showInsertButtons = true,
  showCopyButton = true,
  sanitizeHTML = (html: string) => html || '',
}: AIAssistantBaseLegacyProps) => {
  const [copied, setCopied] = React.useState(false);

  const handleCopyText = React.useCallback(() => {
    // v1.25.18: Usar helper ao invÃ©s de DOM (memory leak fix)
    let plainText = extractPlainText(aiGeneratedText || '');
    plainText = plainText.replace(/\n{2,}/g, '\n').trim();
    navigator.clipboard.writeText(plainText)
      .then(() => {
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      })
      .catch(() => {});
  }, [aiGeneratedText]);

  // v1.35.62: Handler para Voice-to-Text no campo de instruÃ§Ãµes
  const handleVoiceInstruction = React.useCallback((text: string) => {
    const current = aiInstruction || '';
    setAiInstruction(current + (current ? ' ' : '') + text);
  }, [aiInstruction, setAiInstruction]);

  // v1.35.64: ESC handler
  React.useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
    };
    if (isOpen) {
      window.addEventListener('keydown', handleEsc);
    }
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  // v1.35.64: Bloquear scroll do body quando modal aberto
  React.useEffect(() => {
    if (isOpen) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => {
        document.body.style.overflow = originalOverflow;
      };
    }
  }, [isOpen]);

  if (!isOpen) return null;

  // Exemplos padrÃ£o
  const defaultExamples = (
    <ul className="text-xs theme-text-disabled space-y-1">
      <li>â€¢ "Escreva a fundamentaÃ§Ã£o legal sobre horas extras"</li>
      <li>â€¢ "Argumente por que o vÃ­nculo empregatÃ­cio deve ser reconhecido"</li>
      <li>â€¢ "Explique os requisitos para concessÃ£o de adicional de insalubridade"</li>
      <li>â€¢ "Conclua o tÃ³pico julgando procedente o pedido"</li>
      <li>â€¢ "Refute os argumentos da defesa sobre a jornada de trabalho"</li>
    </ul>
  );

  return (
    <div className={`${CSS.modalOverlay} overflow-auto`} style={{ zIndex }}>
      <div className={`${CSS.modalContainer} max-w-4xl w-full my-auto`}>
        {/* Header */}
        <div className={`${CSS.modalHeader} flex items-center justify-between`}>
          <div className="flex items-center gap-3">
            <div className="p-2 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg">
              <Sparkles className="w-5 h-5 text-white" />
            </div>
            <div>
              <h3 className="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-400">
                {title}
              </h3>
              {subtitle && (
                <p className="text-xs theme-text-muted mt-1">{subtitle}</p>
              )}
            </div>
          </div>
          {/* v1.35.64: BotÃ£o X */}
          <button
            onClick={onClose}
            className="w-8 h-8 rounded-full theme-bg-secondary theme-hover-bg flex items-center justify-center theme-text-secondary transition-all border theme-border-modal hover:border-current"
          >
            <X className="w-4 h-4" />
          </button>
        </div>

        {/* Aviso CNJ */}
        <div className="mx-6 mt-4 p-3 bg-amber-500/10 border border-amber-500/40 rounded-lg">
          <div className="flex items-start gap-2">
            <span className="text-amber-500">âš ï¸</span>
            <div className="text-xs text-amber-700 dark:text-amber-200">
              <span className="font-semibold">Lembre-se:</span> A IA pode gerar conteÃºdo impreciso ou incompleto. Revise e valide todas as informaÃ§Ãµes geradas.
              <span className="block mt-1 text-amber-600 dark:text-amber-300/80">Sua revisÃ£o Ã© fundamental, na forma estabelecida pela <span className="font-semibold">ResoluÃ§Ã£o 615/2025 do CNJ</span>.</span>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="p-6 space-y-4 max-h-[65vh] overflow-y-auto">
          {/* ConteÃºdo extra (ex: seletor de escopo) */}
          {extraContent}

          {/* Campo de InstruÃ§Ãµes */}
          <div>
            {/* v1.35.62: Label + VoiceButton */}
            <div className="flex items-center justify-between mb-2">
              <label className={CSS.label}>Sua InstruÃ§Ã£o para a IA</label>
              <VoiceButton
                onTranscript={handleVoiceInstruction}
                size="sm"
                idleText="Ditar"
                onError={(err: unknown) => console.warn('[VoiceToText]', err)}
              />
            </div>
            <textarea
              value={aiInstruction}
              onChange={(e) => setAiInstruction(e.target.value)}
              className="w-full h-24 theme-bg-app border theme-border-input rounded-lg p-3 theme-text-primary resize-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500"
              placeholder={placeholder}
            />
          </div>

          {/* Exemplos */}
          <div className="theme-bg-app-50 p-4 rounded-lg border theme-border-input">
            <p className="text-xs theme-text-muted mb-2">ğŸ’¡ Exemplos de instruÃ§Ãµes:</p>
            {customExamples || defaultExamples}
          </div>

          {/* BotÃ£o Gerar */}
          <button
            onClick={onGenerateText}
            disabled={generatingAi || !(aiInstruction || '').trim()}
            className="w-full py-3 rounded-lg font-medium disabled:opacity-50 flex items-center justify-center gap-2 text-white bg-gradient-to-r from-purple-600 to-blue-600 hover-gradient-purple-blue-darker transition-all duration-300"
          >
            {generatingAi ? (
              <>
                <div className={CSS.spinner}></div>
                Gerando...
              </>
            ) : (
              <>
                <Sparkles className="w-4 h-4" />
                Gerar Texto
              </>
            )}
          </button>

          {/* Texto Gerado + BotÃµes de AÃ§Ã£o */}
          {aiGeneratedText && (
            <div className="space-y-3">
              <label className="block text-sm font-medium text-green-600 dark:text-green-400">
                âœ“ Texto Gerado pela IA:
              </label>
              <div
                className="theme-bg-app border border-green-600/30 rounded-lg p-4 max-h-64 overflow-auto theme-text-secondary leading-relaxed"
                dangerouslySetInnerHTML={{ __html: sanitizeHTML(aiGeneratedText) }}
              />
              <div className={`grid gap-2 ${showInsertButtons && showCopyButton ? 'grid-cols-4' : showInsertButtons ? 'grid-cols-3' : 'grid-cols-1'}`}>
                {showInsertButtons && (
                  <>
                    <button
                      onClick={() => onInsertText('replace')}
                      className="py-2 rounded-lg text-sm bg-amber-600 hover-amber-700-from-600"
                    >
                      Substituir Tudo
                    </button>
                    <button
                      onClick={() => onInsertText('prepend')}
                      className="py-2 rounded-lg text-sm bg-blue-600 text-white hover-blue-700"
                    >
                      Adicionar no InÃ­cio
                    </button>
                    <button
                      onClick={() => onInsertText('append')}
                      className="py-2 rounded-lg text-sm bg-green-600 text-white hover-green-700-from-600"
                    >
                      Adicionar no Final
                    </button>
                  </>
                )}
                {showCopyButton && (
                  <button
                    onClick={handleCopyText}
                    disabled={copied}
                    className={`py-2 rounded-lg text-sm ${copied ? 'bg-green-600' : 'theme-bg-tertiary hover-slate-500'}`}
                  >
                    {copied ? 'âœ“ Copiado' : 'ğŸ“‹ Copiar'}
                  </button>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className={CSS.modalFooter}>
          <button
            onClick={onClose}
            className="flex-1 py-3 rounded-lg font-medium theme-bg-tertiary hover-slate-500"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  );
});

AIAssistantBaseLegacy.displayName = 'AIAssistantBaseLegacy';

// ğŸ¤– v1.19.0: AIAssistantBase - Base para Assistentes IA com CHAT INTERATIVO
const AIAssistantBase = React.memo(({
  isOpen,
  onClose,
  chatHistory,
  onSendMessage,
  onInsertResponse,
  generating,
  onClear,
  lastResponse,
  // ConfiguraÃ§Ãµes opcionais
  title = 'Assistente de RedaÃ§Ã£o IA',
  subtitle = null,
  zIndex = 60,
  placeholder = 'Digite sua mensagem...',
  extraContent = null,
  showInsertButtons = true,
  sanitizeHTML = (html: string) => html || '',
  quickPrompts = [],  // v1.20.0: Prompts rÃ¡pidos
  topicTitle = '',    // v1.21.1: TÃ­tulo do tÃ³pico para substituiÃ§Ã£o em quick prompts
  onQuickPromptClick = null, // v1.21.1: Handler opcional para quick prompts (permite validaÃ§Ã£o)
  qpError = null,     // v1.21.2: Estado de erro para mostrar no botÃ£o do quick prompt
}: AIAssistantBaseProps) => {
  // Bloquear scroll do body quando modal estÃ¡ aberto
  React.useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
      return () => { document.body.style.overflow = ''; };
    }
  }, [isOpen]);

  // ESC handler
  React.useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => { if (e.key === 'Escape') onClose(); };
    if (isOpen) window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  const handleInsert = (mode: 'replace' | 'prepend' | 'append') => {
    if (lastResponse) onInsertResponse(mode);
  };

  return (
    <div className={`${CSS.modalOverlay} overflow-auto`} style={{ zIndex }}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-4xl w-full my-auto`}>
        {/* Header */}
        <div className={CSS.modalHeader}>
          <div className="flex items-center justify-between w-full">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-purple-500/20">
                <Sparkles className="w-6 h-6 text-purple-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold theme-text-primary">{title}</h3>
                {subtitle && <p className="text-sm theme-text-muted">{subtitle}</p>}
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>

        {/* Content - v1.36.48: Aviso CNJ e escopo agora dentro do scroll */}
        <div className="p-6 space-y-4 overflow-y-auto flex-1 min-h-0">
          {/* Aviso CNJ */}
          <div className="p-3 bg-amber-500/10 border border-amber-500/40 rounded-lg">
            <div className="flex items-start gap-2">
              <span className="text-amber-500">âš ï¸</span>
              <div className="text-xs text-amber-700 dark:text-amber-200">
                <span className="font-semibold">Lembre-se:</span> A IA pode gerar conteÃºdo impreciso. Revise todas as informaÃ§Ãµes.
                <span className="block mt-1 text-amber-600 dark:text-amber-300/80">
                  RevisÃ£o obrigatÃ³ria conforme <span className="font-semibold">ResoluÃ§Ã£o 615/2025 do CNJ</span>.
                </span>
              </div>
            </div>
          </div>

          {/* ConteÃºdo extra (ex: seletor de escopo) */}
          {extraContent && <div>{extraContent}</div>}
          {/* Ãrea de Chat */}
          <div className="border theme-border-input rounded-lg">
            <div className="flex items-center justify-between px-4 py-2 border-b theme-border-input theme-bg-secondary">
              <span className="text-sm font-medium theme-text-secondary">ğŸ’¬ Conversa</span>
              {chatHistory.length > 0 && (
                <button onClick={onClear} className="text-xs theme-text-muted hover-text-red-400">
                  Limpar
                </button>
              )}
            </div>
            <ChatHistoryArea
              history={chatHistory}
              generating={generating}
              onUseMessage={() => onInsertResponse('append')}
              showUseButtons={showInsertButtons}
              sanitizeHTML={sanitizeHTML}
            />
          </div>

          {/* v1.20.0: Prompts RÃ¡pidos */}
          {quickPrompts?.length > 0 && (
            <div className="flex flex-wrap gap-2">
              <span className="text-xs theme-text-muted w-full mb-1">âš¡ Prompts rÃ¡pidos:</span>
              {quickPrompts.map((qp: QuickPrompt) => {
                const resolvedPrompt = qp.prompt.replace(/\{TOPICO\}/g, topicTitle || 'tÃ³pico atual');
                const isError = qpError?.id === qp.id;
                return (
                  <button
                    key={qp.id}
                    onClick={() => {
                      // v1.21.1: Se onQuickPromptClick existe, usa para validaÃ§Ã£o; senÃ£o, envia direto
                      if (onQuickPromptClick) {
                        onQuickPromptClick(qp, resolvedPrompt);
                      } else {
                        onSendMessage(resolvedPrompt);
                      }
                    }}
                    disabled={generating || isError}
                    className={`px-3 py-1.5 text-xs rounded-full border transition-colors ${
                      isError
                        ? 'bg-red-500/20 border-red-500 text-red-400 cursor-not-allowed'
                        : 'hover-quick-prompt theme-bg-secondary text-blue-600 dark:text-blue-400 theme-border-input disabled:opacity-50 disabled:cursor-not-allowed'
                    }`}
                    title={isError ? qpError.message : resolvedPrompt}
                  >
                    {isError ? <>âš ï¸ {qpError.message}</> : <>{qp.icon} {qp.label}</>}
                  </button>
                );
              })}
            </div>
          )}

          {/* Input de Chat */}
          <ChatInput onSend={onSendMessage} disabled={generating} placeholder={placeholder} />

          {/* Exemplos (apenas se chat vazio) */}
          {chatHistory.length === 0 && (
            <div className="theme-bg-app-50 p-4 rounded-lg border theme-border-input">
              <p className="text-xs theme-text-muted mb-2">ğŸ’¡ Exemplos:</p>
              <ul className="text-xs theme-text-disabled space-y-1">
                <li>â€¢ "Escreva a fundamentaÃ§Ã£o sobre horas extras"</li>
                <li>â€¢ "Argumente pelo reconhecimento do vÃ­nculo"</li>
                <li>â€¢ "Refute a defesa sobre jornada de trabalho"</li>
              </ul>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className={`${CSS.modalFooter} justify-between`}>
          <InsertDropdown onInsert={handleInsert} disabled={!lastResponse} />
          <button onClick={onClose} className="px-6 py-2 rounded-lg font-medium theme-bg-tertiary hover-slate-500">
            Fechar
          </button>
        </div>
      </div>
    </div>
  );
});
AIAssistantBase.displayName = 'AIAssistantBase';

// ğŸ¤– v1.19.0: AIAssistantModal - Wrapper com seletor de escopo e CHAT INTERATIVO para Editor de TÃ³picos
const AIAssistantModal = React.memo(({
  isOpen,
  onClose,
  contextScope,
  setContextScope,
  topicTitle,
  // Props do chat
  chatHistory,
  onSendMessage,
  onInsertResponse,
  generating,
  onClear,
  lastResponse,
  sanitizeHTML = (html: string) => html || '',
  quickPrompts = [],  // v1.20.0
  proofManager = null  // v1.21.1: Para validaÃ§Ã£o de provas orais
}: AIAssistantModalProps) => {
  // v1.21.2: Estado para erro no botÃ£o do quick prompt
  const [qpError, setQpError] = React.useState<{ id: string; message: string } | null>(null);

  // v1.21.2: Handler para quick prompts com validaÃ§Ã£o - mostra erro no prÃ³prio botÃ£o
  const handleQuickPromptClick = React.useCallback((qp: QuickPrompt, resolvedPrompt: string) => {
    if (qp.proofFilter === 'oral') {
      const hasOral = hasOralProofsForTopic(proofManager, topicTitle);
      if (!hasOral) {
        // Mostrar erro no prÃ³prio botÃ£o por 3 segundos
        setQpError({ id: qp.id, message: 'Prova oral nÃ£o vinculada' });
        setTimeout(() => setQpError(null), 3000);
        return;
      }
      onSendMessage(resolvedPrompt, { proofFilter: 'oral' });
    } else {
      onSendMessage(resolvedPrompt);
    }
  }, [proofManager, topicTitle, onSendMessage]);

  const scopeSelector = (
    <div>
      <label className={CSS.label}>Escopo do Contexto</label>
      <div className="flex gap-4 mt-2">
        <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${
          contextScope === 'current'
            ? 'border-purple-500 bg-purple-500/10'
            : 'theme-border-input theme-bg-secondary-30 hover-theme-border'
        }`}>
          <input
            type="radio"
            name="topicContextScope"
            value="current"
            checked={contextScope === 'current'}
            onChange={() => setContextScope('current')}
            className="w-4 h-4 text-purple-600"
          />
          <div>
            <span className="text-sm font-medium theme-text-primary">Apenas este tÃ³pico</span>
            <p className="text-xs theme-text-muted">Mini-relatÃ³rio + decisÃ£o do tÃ³pico atual</p>
          </div>
        </label>
        <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${
          contextScope === 'all'
            ? 'border-purple-500 bg-purple-500/10'
            : 'theme-border-input theme-bg-secondary-30 hover-theme-border'
        }`}>
          <input
            type="radio"
            name="topicContextScope"
            value="all"
            checked={contextScope === 'all'}
            onChange={() => setContextScope('all')}
            className="w-4 h-4 text-purple-600"
          />
          <div>
            <span className="text-sm font-medium theme-text-primary">Toda a decisÃ£o</span>
            <p className="text-xs theme-text-muted">RELATÃ“RIO + todos os tÃ³picos</p>
          </div>
        </label>
      </div>
    </div>
  );

  return (
    <AIAssistantBase
      isOpen={isOpen}
      onClose={onClose}
      chatHistory={chatHistory}
      onSendMessage={onSendMessage}
      onInsertResponse={onInsertResponse}
      generating={generating}
      onClear={onClear}
      lastResponse={lastResponse}
      zIndex={60}
      subtitle={topicTitle ? <>TÃ³pico: <span className="font-semibold text-purple-400">{topicTitle}</span></> : null}
      extraContent={scopeSelector}
      sanitizeHTML={sanitizeHTML}
      quickPrompts={quickPrompts}
      topicTitle={topicTitle}
      onQuickPromptClick={handleQuickPromptClick}
      qpError={qpError}
    />
  );
});

AIAssistantModal.displayName = 'AIAssistantModal';

// ğŸ¤– v1.19.0: AIAssistantGlobalModal - Para Editor Global com CHAT INTERATIVO
const AIAssistantGlobalModal = React.memo(({
  isOpen,
  onClose,
  contextScope,
  setContextScope,
  topicTitle,
  // Props do chat
  chatHistory,
  onSendMessage,
  onInsertResponse,
  generating,
  onClear,
  lastResponse,
  sanitizeHTML = (html: string) => html || '',
  quickPrompts = [],  // v1.20.0
  proofManager = null  // v1.21.1: Para validaÃ§Ã£o de provas orais
}: AIAssistantGlobalModalProps) => {
  // v1.21.2: Estado para erro no botÃ£o do quick prompt
  const [qpError, setQpError] = React.useState<{ id: string; message: string } | null>(null);

  // v1.21.2: Handler para quick prompts com validaÃ§Ã£o - mostra erro no prÃ³prio botÃ£o
  const handleQuickPromptClick = React.useCallback((qp: QuickPrompt, resolvedPrompt: string) => {
    if (qp.proofFilter === 'oral') {
      const hasOral = hasOralProofsForTopic(proofManager, topicTitle);
      if (!hasOral) {
        // Mostrar erro no prÃ³prio botÃ£o por 3 segundos
        setQpError({ id: qp.id, message: 'Prova oral nÃ£o vinculada' });
        setTimeout(() => setQpError(null), 3000);
        return;
      }
      onSendMessage(resolvedPrompt, { proofFilter: 'oral' });
    } else {
      onSendMessage(resolvedPrompt);
    }
  }, [proofManager, topicTitle, onSendMessage]);

  // Componente de seleÃ§Ã£o de escopo para passar como extraContent
  const scopeSelector = (
    <div>
      <label className={CSS.label}>Escopo do Contexto</label>
      <div className="flex gap-4 mt-2">
        <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${
          contextScope === 'current'
            ? 'border-purple-500 bg-purple-500/10'
            : 'theme-border-input theme-bg-secondary-30 hover-theme-border'
        }`}>
          <input
            type="radio"
            name="contextScope"
            value="current"
            checked={contextScope === 'current'}
            onChange={() => setContextScope('current')}
            className="w-4 h-4 text-purple-600"
          />
          <div>
            <span className="text-sm font-medium theme-text-primary">Apenas este tÃ³pico</span>
            <p className="text-xs theme-text-muted">Mini-relatÃ³rio + decisÃ£o do tÃ³pico atual</p>
          </div>
        </label>
        <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${
          contextScope === 'all'
            ? 'border-purple-500 bg-purple-500/10'
            : 'theme-border-input theme-bg-secondary-30 hover-theme-border'
        }`}>
          <input
            type="radio"
            name="contextScope"
            value="all"
            checked={contextScope === 'all'}
            onChange={() => setContextScope('all')}
            className="w-4 h-4 text-purple-600"
          />
          <div>
            <span className="text-sm font-medium theme-text-primary">Toda a decisÃ£o</span>
            <p className="text-xs theme-text-muted">RELATÃ“RIO + todos os tÃ³picos</p>
          </div>
        </label>
      </div>
    </div>
  );

  return (
    <AIAssistantBase
      isOpen={isOpen}
      onClose={onClose}
      chatHistory={chatHistory}
      onSendMessage={onSendMessage}
      onInsertResponse={onInsertResponse}
      generating={generating}
      onClear={onClear}
      lastResponse={lastResponse}
      zIndex={70}
      subtitle={<>TÃ³pico: <span className="font-semibold text-purple-400">{topicTitle}</span></>}
      extraContent={scopeSelector}
      sanitizeHTML={sanitizeHTML}
      quickPrompts={quickPrompts}
      topicTitle={topicTitle}
      onQuickPromptClick={handleQuickPromptClick}
      qpError={qpError}
    />
  );
});

AIAssistantGlobalModal.displayName = 'AIAssistantGlobalModal';

// ğŸ¤– v1.19.0: AIAssistantModelModal - Wrapper para modelos (usa Legacy - single-shot, nÃ£o chat)
const AIAssistantModelModal = React.memo(({
  isOpen,
  onClose,
  aiInstructionModel,
  setAiInstructionModel,
  generatingAiModel,
  aiGeneratedTextModel,
  onGenerateText,
  onInsertText,
  sanitizeHTML = (html: string) => html || ''
}: AIAssistantModelModalProps) => {
  // Exemplos especÃ­ficos para criaÃ§Ã£o de modelos
  const modelExamples = (
    <ul className="text-xs theme-text-disabled space-y-1">
      <li>â€¢ "Escreva um modelo genÃ©rico de fundamentaÃ§Ã£o sobre reconhecimento de vÃ­nculo empregatÃ­cio"</li>
      <li>â€¢ "Crie um parÃ¡grafo padrÃ£o explicando os requisitos da CLT para horas extras"</li>
      <li>â€¢ "Desenvolva um modelo de conclusÃ£o julgando procedente pedido de adicional de insalubridade"</li>
      <li>â€¢ "Elabore um texto padrÃ£o sobre prescriÃ§Ã£o bienal"</li>
      <li>â€¢ "Redija um modelo de fundamentaÃ§Ã£o sobre rescisÃ£o indireta"</li>
    </ul>
  );

  // v1.19.0: Usa versÃ£o Legacy para manter comportamento single-shot (nÃ£o chat)
  return (
    <AIAssistantBaseLegacy
      isOpen={isOpen}
      onClose={onClose}
      aiInstruction={aiInstructionModel}
      setAiInstruction={setAiInstructionModel}
      generatingAi={generatingAiModel}
      aiGeneratedText={aiGeneratedTextModel}
      onGenerateText={onGenerateText}
      onInsertText={onInsertText}
      zIndex={60}
      title="Assistente de RedaÃ§Ã£o IA - Modelos"
      subtitle="Instrua a IA sobre o que vocÃª deseja escrever no modelo"
      placeholder="Ex: Escreva um modelo de fundamentaÃ§Ã£o sobre horas extras que possa ser adaptado para diferentes casos..."
      customExamples={modelExamples}
      sanitizeHTML={sanitizeHTML}
    />
  );
});

AIAssistantModelModal.displayName = 'AIAssistantModelModal';

const AnalysisModal: React.FC<AnalysisModalProps> = ({
  isOpen,
  analysisProgress,
  peticaoFiles,
  pastedPeticaoTexts,
  contestacaoFiles,
  pastedContestacaoTexts,
  complementaryFiles,
  pastedComplementaryTexts
}) => {
  if (!isOpen) return null;

  const totalPeticoes = (peticaoFiles?.length || 0) + (pastedPeticaoTexts?.length || 0);

  return (
    <div className={CSS.modalOverlay}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-lg w-full`}>
        <div className={CSS.modalHeader}>
          <div className="flex items-center gap-3">
            <div className="p-3 rounded-xl bg-blue-500/20">
              <Loader2 className="w-6 h-6 text-blue-400 animate-spin" />
            </div>
            <div>
              <h3 className="text-lg font-semibold theme-text-primary">AnÃ¡lise em Andamento</h3>
              <p className="text-sm theme-text-muted">Por favor, aguarde enquanto processamos os documentos</p>
            </div>
          </div>
        </div>

        <div className="p-8">
          <div className="flex flex-col items-center gap-6">
            {/* Spinner Neon + Ripple - v1.33.49 */}
            <div className="spinner-neon-ripple">
              <div className="ripple"></div>
              <div className="ripple"></div>
              <div className="ripple"></div>
              <div className="core">
                <div className="outer"></div>
                <div className="inner"></div>
              </div>
            </div>

            {/* Mensagem de progresso */}
            <div className="text-center space-y-2 w-full">
              <p className="text-lg font-medium theme-text-secondary">{analysisProgress}</p>

              {/* Barra de progresso animada */}
              <div className="w-full theme-bg-secondary rounded-full h-2 overflow-hidden">
                <div className="h-full bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500 animate-pulse"
                     style={{
                       width: '100%',
                       animation: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                     }}>
                </div>
              </div>
            </div>

            {/* InformaÃ§Ãµes adicionais */}
            <div className="theme-bg-app-50 rounded-lg p-4 w-full border theme-border-input">
              <div className="space-y-2 text-sm theme-text-muted">
                <div className={CSS.flexGap2}>
                  <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                  <span>
                    Docs do Autor: {totalPeticoes > 0 ? `${totalPeticoes} documento${totalPeticoes !== 1 ? 's' : ''}` : 'NÃ£o anexados'}
                  </span>
                </div>
                {((contestacaoFiles?.length ?? 0) > 0 || (pastedContestacaoTexts?.length ?? 0) > 0) && (
                  <div className={CSS.flexGap2}>
                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span>
                      ContestaÃ§Ãµes: {(contestacaoFiles?.length ?? 0) + (pastedContestacaoTexts?.length ?? 0)} documento{((contestacaoFiles?.length ?? 0) + (pastedContestacaoTexts?.length ?? 0)) !== 1 ? 's' : ''}
                      {(pastedContestacaoTexts?.length ?? 0) > 0 && ` (${pastedContestacaoTexts?.length ?? 0} texto${(pastedContestacaoTexts?.length ?? 0) !== 1 ? 's' : ''})`}
                    </span>
                  </div>
                )}
                {((complementaryFiles?.length ?? 0) > 0 || (pastedComplementaryTexts?.length ?? 0) > 0) && (
                  <div className={CSS.flexGap2}>
                    <div className="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
                    <span>
                      Complementares: {(complementaryFiles?.length ?? 0) + (pastedComplementaryTexts?.length ?? 0)} documento{((complementaryFiles?.length ?? 0) + (pastedComplementaryTexts?.length ?? 0)) !== 1 ? 's' : ''}
                    </span>
                  </div>
                )}
              </div>
            </div>

            {/* Dica */}
            <div className="text-xs text-center theme-text-disabled max-w-sm">
              ğŸ’¡ A anÃ¡lise pode levar de 30 segundos a 2 minutos dependendo do tamanho dos documentos e da complexidade do processo.
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// Modal: Exportar Minuta (migrado para BaseModal v1.18.3)
const ExportModal = React.memo(({ isOpen, onClose, exportedText, exportedHtml, copySuccess, setCopySuccess, setError }: ExportModalProps) => {
  const timeoutRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);
  React.useEffect(() => () => { if (timeoutRef.current) clearTimeout(timeoutRef.current); }, []);
  const handleCopy = async () => {
    try {
      const htmlBlob = new Blob([exportedHtml], { type: 'text/html' });
      const textBlob = new Blob([exportedText], { type: 'text/plain' });
      await navigator.clipboard.write([new ClipboardItem({ 'text/html': htmlBlob, 'text/plain': textBlob })]);
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
      setCopySuccess(true);
      timeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
    } catch (clipErr) {
      try { await navigator.clipboard.writeText(exportedText); if (timeoutRef.current) clearTimeout(timeoutRef.current); setCopySuccess(true); timeoutRef.current = setTimeout(() => setCopySuccess(false), 3000); } catch (err) { setError('Erro ao copiar texto'); }
    }
  };
  return (
    <BaseModal isOpen={isOpen} onClose={onClose} title="Minuta Exportada" icon={<Download />} iconColor="blue" size="xl"
      footer={<>
        <button onClick={handleCopy} className="flex-1 py-3 rounded-lg font-medium bg-blue-600 text-white hover-blue-700-from-600">ğŸ“‹ Copiar com FormataÃ§Ã£o</button>
        <button onClick={onClose} className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500">Fechar</button>
      </>}>
      <div className="space-y-4">
        {copySuccess && <p className="text-green-400 text-sm">âœ“ Copiado para Ã¡rea de transferÃªncia!</p>}
        <ModalInfoBox>
          <strong>FormataÃ§Ã£o Preservada</strong> - O conteÃºdo foi copiado com toda a formataÃ§Ã£o. Cole diretamente no Google Docs ou Word usando Ctrl+V.
        </ModalInfoBox>
        <textarea value={exportedText} readOnly className="w-full min-h-[400px] theme-bg-app border theme-border-input rounded-lg p-4 theme-text-primary font-mono text-sm resize-none" />
      </div>
    </BaseModal>
  );
});
ExportModal.displayName = 'ExportModal';

// Modal: Restaurar SessÃ£o (migrado para BaseModal)
// v1.33.62: preventClose - usuÃ¡rio deve escolher uma opÃ§Ã£o
const RestoreSessionModal = React.memo(({ isOpen, onClose, sessionLastSaved, onRestoreSession, onStartNew }: RestoreSessionModalProps) => (
  <BaseModal isOpen={isOpen} onClose={onClose} title="SessÃ£o Anterior Encontrada" icon={<Save />} iconColor="blue" size="sm" preventClose
    footer={<><button onClick={onRestoreSession} className={CSS.btnGreen}>âœ… Continuar SessÃ£o</button><button onClick={onStartNew} className={CSS.btnRed}>ğŸ—‘ï¸ ComeÃ§ar do Zero</button></>}>
    <div className="space-y-4">
      <p className="text-xs theme-text-muted">Ãšltima atualizaÃ§Ã£o: {sessionLastSaved ? new Date(sessionLastSaved).toLocaleString('pt-BR') : ''}</p>
      <p className="theme-text-tertiary">Encontramos uma sessÃ£o salva. Deseja continuar ou comeÃ§ar uma nova sentenÃ§a?</p>
      <ModalInfoBox>ğŸ’¡ <strong>Dica:</strong> Use "Salvar Projeto" para fazer backup seguro.</ModalInfoBox>
    </div>
  </BaseModal>
));
RestoreSessionModal.displayName = 'RestoreSessionModal';

// Modal: Limpar Projeto (migrado para BaseModal)
const ClearProjectModal = React.memo(({ isOpen, onClose, onConfirmClear }: ClearProjectModalProps) => (
  <BaseModal isOpen={isOpen} onClose={onClose} title="Limpar Projeto" icon={<Trash2 />} iconColor="red" size="sm"
    footer={<ModalFooter.Destructive onClose={onClose} onConfirm={onConfirmClear} confirmText="Sim, Limpar Tudo" />}>
    <div className="space-y-4">
      <p className="theme-text-tertiary">Tem certeza que deseja <strong>limpar todos os dados</strong> do projeto?</p>
      <ModalAmberBox>
        <p className="text-xs theme-text-primary mb-2"><strong>âš ï¸ AtenÃ§Ã£o! Isto irÃ¡ apagar:</strong></p>
        <ul className="text-xs theme-text-secondary space-y-1 ml-4 list-disc">
          <li>Todos os documentos (PDFs e textos)</li>
          <li>Todos os tÃ³picos e decisÃµes</li>
          <li>Todo o progresso da sentenÃ§a</li>
        </ul>
      </ModalAmberBox>
      <ModalInfoBox>ğŸ’¡ <strong>Dica:</strong> Se quiser manter seus dados, clique em "Salvar Projeto" antes.</ModalInfoBox>
    </div>
  </BaseModal>
));
ClearProjectModal.displayName = 'ClearProjectModal';

// v1.33.57: Modal de confirmaÃ§Ã£o de logout estilizado
const LogoutConfirmModal = React.memo(({ isOpen, onClose, onConfirm }: LogoutConfirmModalProps) => (
  <BaseModal isOpen={isOpen} onClose={onClose} title="Sair do Sistema" icon={<LogOut />} iconColor="red" size="sm"
    footer={<ModalFooter.Destructive onClose={onClose} onConfirm={onConfirm} confirmText="Sim, Sair" />}>
    <div className="space-y-4">
      <p className="theme-text-tertiary">Deseja realmente sair do sistema?</p>
      <ModalInfoBox>ğŸ’¾ Seus dados permanecerÃ£o salvos localmente.</ModalInfoBox>
    </div>
  </BaseModal>
));
LogoutConfirmModal.displayName = 'LogoutConfirmModal';

// v1.35.1: Modal para compartilhar biblioteca de modelos (convite por email)
// v1.35.23: Adicionado onRemoveSharedModels para limpar modelos ao remover acesso
const ShareLibraryModal = React.memo(({ isOpen, onClose, user, onRemoveSharedModels }: ShareLibraryModalProps) => {
  const [permission, setPermission] = React.useState('view');
  const [loading, setLoading] = React.useState(false);
  const [recipientEmail, setRecipientEmail] = React.useState('');
  const [successMessage, setSuccessMessage] = React.useState('');
  const [errorMessage, setErrorMessage] = React.useState('');
  const [shares, setShares] = React.useState<ShareInfo[]>([]);
  const [sharedWithMe, setSharedWithMe] = React.useState<ShareInfo[]>([]);
  const [activeTab, setActiveTab] = React.useState('share'); // 'share' | 'myShares' | 'sharedWithMe'

  // Buscar compartilhamentos ao abrir
  React.useEffect(() => {
    if (!isOpen) return;
    const fetchShares = async () => {
      try {
        const token = localStorage.getItem('sentencify-auth-token');
        const [mySharesRes, sharedWithMeRes] = await Promise.all([
          fetch(`${API_BASE}/api/share/library/my-shares`, {
            headers: { 'Authorization': `Bearer ${token}` }
          }),
          fetch(`${API_BASE}/api/share/library/shared-with-me`, {
            headers: { 'Authorization': `Bearer ${token}` }
          })
        ]);
        if (mySharesRes.ok) {
          const data = await mySharesRes.json();
          setShares(data.shares || []);
        }
        if (sharedWithMeRes.ok) {
          const data = await sharedWithMeRes.json();
          setSharedWithMe(data.libraries || []);
        }
      } catch (err) {
        console.error('[Share] Fetch error:', err);
      }
    };
    fetchShares();
    setRecipientEmail('');
    setSuccessMessage('');
    setErrorMessage('');
  }, [isOpen]);

  // v1.35.1: Enviar convite por email
  const handleSendInvite = async () => {
    if (!recipientEmail || !recipientEmail.includes('@')) {
      setErrorMessage('Por favor, informe um email vÃ¡lido.');
      return;
    }
    setLoading(true);
    setErrorMessage('');
    setSuccessMessage('');
    try {
      const token = localStorage.getItem('sentencify-auth-token');
      const res = await fetch(`${API_BASE}/api/share/library`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ permission, recipientEmail })
      });
      const data = await res.json();
      if (res.ok) {
        setSuccessMessage(`Convite enviado para ${recipientEmail}!`);
        setRecipientEmail('');
        // Adicionar Ã  lista de convites
        setShares(prev => [{
          id: data.shareId,
          email: recipientEmail.toLowerCase(),
          permission: permission as 'view' | 'edit',
          recipient_email: recipientEmail.toLowerCase(),
          createdAt: new Date().toISOString(),
          recipients: []
        }, ...prev]);
      } else {
        setErrorMessage(data.error || 'Erro ao enviar convite.');
      }
    } catch (err) {
      console.error('[Share] Send invite error:', err);
      setErrorMessage('Erro de conexÃ£o. Tente novamente.');
    } finally {
      setLoading(false);
    }
  };

  const handleRevoke = async (shareId: string) => {
    try {
      const token = localStorage.getItem('sentencify-auth-token');
      const res = await fetch(`${API_BASE}/api/share/library/${shareId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.ok) {
        setShares(prev => prev.filter(s => s.id !== shareId));
      }
    } catch (err) {
      console.error('[Share] Revoke error:', err);
    }
  };

  const handleRemoveAccess = async (accessId: string) => {
    try {
      // v1.35.23: Encontrar ownerId antes de remover
      const accessToRemove = sharedWithMe.find(s => s.accessId === accessId);
      const ownerIdToRemove = accessToRemove?.ownerId;

      const token = localStorage.getItem('sentencify-auth-token');
      const res = await fetch(`${API_BASE}/api/share/library/access/${accessId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.ok) {
        setSharedWithMe(prev => prev.filter(s => s.accessId !== accessId));

        // v1.35.23: Remover modelos compartilhados desse owner da biblioteca
        if (ownerIdToRemove && onRemoveSharedModels) {
          onRemoveSharedModels(ownerIdToRemove);
        }
      }
    } catch (err) {
      console.error('[Share] Remove access error:', err);
    }
  };

  return (
    <BaseModal isOpen={isOpen} onClose={onClose} title="Compartilhar Biblioteca" icon={<Share2 />} iconColor="purple" size="lg">
      <div className="space-y-4">
        {/* Tabs */}
        <div className="flex border-b theme-border-primary">
          <button
            onClick={() => setActiveTab('share')}
            className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
              activeTab === 'share' ? 'border-purple-500 text-purple-400' : 'border-transparent theme-text-tertiary hover:text-purple-400'
            }`}
          >
            Compartilhar
          </button>
          <button
            onClick={() => setActiveTab('myShares')}
            className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
              activeTab === 'myShares' ? 'border-purple-500 text-purple-400' : 'border-transparent theme-text-tertiary hover:text-purple-400'
            }`}
          >
            Meus Convites ({shares.length})
          </button>
          <button
            onClick={() => setActiveTab('sharedWithMe')}
            className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
              activeTab === 'sharedWithMe' ? 'border-purple-500 text-purple-400' : 'border-transparent theme-text-tertiary hover:text-purple-400'
            }`}
          >
            Recebidos ({sharedWithMe.length})
          </button>
        </div>

        {/* Tab: Compartilhar */}
        {activeTab === 'share' && (
          <div className="space-y-4">
            <ModalInfoBox>ğŸ“§ Digite o email do destinatÃ¡rio para enviar um convite de compartilhamento da sua biblioteca de modelos.</ModalInfoBox>

            {/* Campo de email */}
            <div>
              <label className={CSS.label}>Email do destinatÃ¡rio</label>
              <input
                type="email"
                value={recipientEmail}
                onChange={(e) => setRecipientEmail(e.target.value)}
                placeholder="email@exemplo.com"
                className={`${CSS.input} mt-2`}
                onKeyDown={(e) => e.key === 'Enter' && !loading && handleSendInvite()}
              />
            </div>

            {/* PermissÃ£o */}
            <div>
              <label className={CSS.label}>PermissÃ£o</label>
              <div className="flex gap-3 mt-2">
                <label className={`flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer border transition-colors ${
                  permission === 'view'
                    ? 'border-purple-500 bg-purple-100 text-purple-700 dark:bg-purple-500/20 dark:text-purple-300'
                    : 'theme-border-primary theme-bg-secondary theme-text-secondary'
                }`}>
                  <input type="radio" name="permission" value="view" checked={permission === 'view'} onChange={() => setPermission('view')} className="hidden" />
                  <Eye className="w-4 h-4" />
                  <span className="text-sm">Somente Leitura</span>
                </label>
                <label className={`flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer border transition-colors ${
                  permission === 'edit'
                    ? 'border-purple-500 bg-purple-100 text-purple-700 dark:bg-purple-500/20 dark:text-purple-300'
                    : 'theme-border-primary theme-bg-secondary theme-text-secondary'
                }`}>
                  <input type="radio" name="permission" value="edit" checked={permission === 'edit'} onChange={() => setPermission('edit')} className="hidden" />
                  <Edit3 className="w-4 h-4" />
                  <span className="text-sm">Leitura e Escrita</span>
                </label>
              </div>
            </div>

            {/* BotÃ£o enviar */}
            <button
              onClick={handleSendInvite}
              disabled={loading || !recipientEmail}
              className="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
            >
              {loading ? <RefreshCw className="w-4 h-4 animate-spin" /> : <Mail className="w-4 h-4" />}
              {loading ? 'Enviando...' : 'Enviar Convite'}
            </button>

            {/* Mensagem de sucesso */}
            {successMessage && (
              <div className="p-3 bg-green-500/20 border border-green-500/50 rounded-lg">
                <p className="text-green-400 text-sm flex items-center gap-2">
                  <Check className="w-4 h-4" />
                  {successMessage}
                </p>
              </div>
            )}

            {/* Mensagem de erro */}
            {errorMessage && (
              <div className="p-3 bg-red-500/20 border border-red-500/50 rounded-lg">
                <p className="text-red-400 text-sm flex items-center gap-2">
                  <AlertCircle className="w-4 h-4" />
                  {errorMessage}
                </p>
              </div>
            )}
          </div>
        )}

        {/* Tab: Meus Convites */}
        {activeTab === 'myShares' && (
          <div className="space-y-3">
            {shares.length === 0 ? (
              <p className="text-center theme-text-tertiary py-8">Nenhum convite enviado.</p>
            ) : (
              shares.map(share => (
                <div key={share.id} className="p-3 theme-bg-secondary rounded-lg border theme-border-primary">
                  <div className="flex items-center justify-between">
                    <div className="flex-1">
                      {/* Email do destinatÃ¡rio */}
                      <p className="theme-text-secondary font-medium text-sm">
                        {share.recipient_email || 'Link pÃºblico'}
                      </p>
                      <div className="flex items-center gap-2 mt-1">
                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                          share.permission === 'edit'
                            ? 'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-400'
                            : 'bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400'
                        }`}>
                          {share.permission === 'edit' ? 'Leitura/Escrita' : 'Somente Leitura'}
                        </span>
                        {/* Status: pendente ou aceito */}
                        {share.recipients && share.recipients.length > 0 ? (
                          <span className="px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700 dark:bg-green-500/20 dark:text-green-400">
                            Aceito
                          </span>
                        ) : (
                          <span className="px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-700 dark:bg-yellow-500/20 dark:text-yellow-400">
                            Pendente
                          </span>
                        )}
                        <span className="text-xs theme-text-tertiary">
                          {new Date(share.createdAt).toLocaleDateString('pt-BR')}
                        </span>
                      </div>
                    </div>
                    <button
                      onClick={() => handleRevoke(share.id)}
                      className="text-red-400 hover:text-red-300 text-xs ml-2"
                    >
                      Revogar
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        )}

        {/* Tab: Compartilhados Comigo */}
        {activeTab === 'sharedWithMe' && (
          <div className="space-y-3">
            {sharedWithMe.length === 0 ? (
              <p className="text-center theme-text-tertiary py-8">Nenhuma biblioteca compartilhada com vocÃª.</p>
            ) : (
              sharedWithMe.map(lib => (
                <div key={lib.accessId} className="p-3 theme-bg-secondary rounded-lg border theme-border-primary">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="theme-text-secondary font-medium">{lib.ownerEmail}</p>
                      <div className="flex items-center gap-2 mt-1">
                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                          lib.permission === 'edit'
                            ? 'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-400'
                            : 'bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400'
                        }`}>
                          {lib.permission === 'edit' ? 'Leitura/Escrita' : 'Somente Leitura'}
                        </span>
                        <span className="text-xs theme-text-tertiary">{lib.modelsCount} modelos</span>
                      </div>
                    </div>
                    <button
                      onClick={() => handleRemoveAccess(lib.accessId || '')}
                      className="text-red-400 hover:text-red-300 text-xs"
                    >
                      Remover
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        )}
      </div>
    </BaseModal>
  );
});
ShareLibraryModal.displayName = 'ShareLibraryModal';

// v1.35.0: PÃ¡gina para aceitar compartilhamento de biblioteca
const AcceptSharePage = React.memo(({ token, onAccepted, onLogin }: AcceptSharePageProps) => {
  const [loading, setLoading] = React.useState(true);
  const [shareInfo, setShareInfo] = React.useState<ShareInfo | null>(null);
  const [error, setError] = React.useState('');
  const [accepting, setAccepting] = React.useState(false);
  const [accepted, setAccepted] = React.useState(false);

  // Buscar informaÃ§Ãµes do compartilhamento
  React.useEffect(() => {
    const fetchShareInfo = async () => {
      try {
        const res = await fetch(`${API_BASE}/api/share/library/${token}`);
        if (res.ok) {
          const data = await res.json();
          setShareInfo(data);
        } else if (res.status === 404) {
          setError('Link de compartilhamento invÃ¡lido ou expirado.');
        } else {
          setError('Erro ao carregar informaÃ§Ãµes do compartilhamento.');
        }
      } catch (err) {
        console.error('[AcceptShare] Fetch error:', err);
        setError('Erro de conexÃ£o. Tente novamente.');
      } finally {
        setLoading(false);
      }
    };
    fetchShareInfo();
  }, [token]);

  const handleAccept = async () => {
    setAccepting(true);
    try {
      const authToken = localStorage.getItem('sentencify-auth-token');
      const res = await fetch(`${API_BASE}/api/share/library/${token}/accept`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        }
      });

      if (res.ok) {
        setAccepted(true);
        setTimeout(() => {
          onAccepted?.();
          window.location.href = '/'; // Redirecionar para home
        }, 2000);
      } else if (res.status === 401) {
        onLogin?.(); // Redirecionar para login
      } else {
        const data = await res.json();
        setError(data.error || 'Erro ao aceitar compartilhamento.');
      }
    } catch (err) {
      console.error('[AcceptShare] Accept error:', err);
      setError('Erro de conexÃ£o. Tente novamente.');
    } finally {
      setAccepting(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center gap-6">
        <div className="spinner-neon-ripple">
          <div className="ripple"></div>
          <div className="ripple"></div>
          <div className="ripple"></div>
          <div className="core">
            <div className="outer"></div>
            <div className="inner"></div>
          </div>
        </div>
        <span className="text-slate-400 animate-pulse">Carregando...</span>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        <div className="max-w-md w-full bg-slate-800 rounded-2xl p-8 shadow-2xl border border-slate-700 text-center">
          <div className="w-16 h-16 mx-auto bg-red-500/20 rounded-full flex items-center justify-center mb-4">
            <X className="w-8 h-8 text-red-400" />
          </div>
          <h2 className="text-xl font-bold text-white mb-2">Link InvÃ¡lido</h2>
          <p className="text-slate-400 mb-6">{error}</p>
          <button
            onClick={() => window.location.href = '/'}
            className="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors"
          >
            Voltar ao InÃ­cio
          </button>
        </div>
      </div>
    );
  }

  if (accepted) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        <div className="max-w-md w-full bg-slate-800 rounded-2xl p-8 shadow-2xl border border-slate-700 text-center">
          <div className="w-16 h-16 mx-auto bg-green-500/20 rounded-full flex items-center justify-center mb-4">
            <Check className="w-8 h-8 text-green-400" />
          </div>
          <h2 className="text-xl font-bold text-white mb-2">Compartilhamento Aceito!</h2>
          <p className="text-slate-400 mb-4">
            Os modelos de <span className="text-purple-400 font-medium">{typeof shareInfo?.owner === 'object' ? shareInfo?.owner?.email : shareInfo?.owner}</span> agora aparecem na sua biblioteca.
          </p>
          <p className="text-slate-500 text-sm">Redirecionando...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
      <div className="max-w-md w-full bg-slate-800 rounded-2xl p-8 shadow-2xl border border-slate-700">
        <div className="text-center mb-6">
          <div className="w-16 h-16 mx-auto bg-purple-500/20 rounded-full flex items-center justify-center mb-4">
            <Users className="w-8 h-8 text-purple-400" />
          </div>
          <h2 className="text-xl font-bold text-white mb-2">Convite de Compartilhamento</h2>
          <p className="text-slate-400">
            <span className="text-purple-400 font-medium">{typeof shareInfo?.owner === 'object' ? shareInfo?.owner?.email : shareInfo?.owner}</span> quer compartilhar sua biblioteca de modelos com vocÃª.
          </p>
        </div>

        <div className="bg-slate-700/50 rounded-xl p-4 mb-6 space-y-3">
          <div className="flex items-center justify-between">
            <span className="text-slate-400 text-sm">ProprietÃ¡rio</span>
            <span className="text-white font-medium">{typeof shareInfo?.owner === 'object' ? shareInfo?.owner?.email : shareInfo?.owner}</span>
          </div>
          <div className="flex items-center justify-between">
            <span className="text-slate-400 text-sm">Modelos</span>
            <span className="text-white font-medium">{shareInfo?.modelsCount} modelos</span>
          </div>
          <div className="flex items-center justify-between">
            <span className="text-slate-400 text-sm">PermissÃ£o</span>
            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
              shareInfo?.permission === 'edit' ? 'bg-amber-500/20 text-amber-400' : 'bg-blue-500/20 text-blue-400'
            }`}>
              {shareInfo?.permission === 'edit' ? 'Leitura e Escrita' : 'Somente Leitura'}
            </span>
          </div>
        </div>

        <button
          onClick={handleAccept}
          disabled={accepting}
          className="w-full px-6 py-3 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 text-white rounded-xl font-medium transition-colors flex items-center justify-center gap-2"
        >
          {accepting ? (
            <>
              <RefreshCw className="w-5 h-5 animate-spin" />
              Aceitando...
            </>
          ) : (
            <>
              <Check className="w-5 h-5" />
              Aceitar Compartilhamento
            </>
          )}
        </button>

        <p className="text-center text-slate-500 text-xs mt-4">
          Os modelos compartilhados aparecerÃ£o na sua aba Modelos com indicaÃ§Ã£o do proprietÃ¡rio.
        </p>
      </div>
    </div>
  );
});
AcceptSharePage.displayName = 'AcceptSharePage';

// Modal: AnonimizaÃ§Ã£o (migrado para BaseModal) - v1.25: + NER
// v1.29.03: Adicionar overlay IA Local durante detecÃ§Ã£o
const AnonymizationNamesModal = React.memo(({ isOpen, onClose, onConfirm, nomesTexto, setNomesTexto, nerEnabled, onDetectNames, detectingNames, onOpenAiSettings }: AnonymizationNamesModalProps) => {
  const handleConfirm = () => { onConfirm(nomesTexto.split(/[\n,]/).map((n: string) => n.trim()).filter((n: string) => n.length >= 2)); };
  return (
    <BaseModal isOpen={isOpen} onClose={onClose} title="AnonimizaÃ§Ã£o de Documentos" icon={<AlertCircle />} iconColor="purple" size="lg"
      footer={<ModalFooter.Standard onClose={onClose} onConfirm={handleConfirm} confirmText="Continuar AnÃ¡lise" />}>
      {/* v1.32.00: Overlay removido - NER roda em worker */}
      <div className="space-y-4">
        <ModalInfoBox>ğŸ”’ A anonimizaÃ§Ã£o estÃ¡ ativada. Insira os nomes para anonimizar.</ModalInfoBox>
        <div>
          <div className="flex items-center justify-between mb-2">
            <label className={CSS.label}>Nomes para anonimizar (um por linha)</label>
            {/* v1.25: BotÃ£o Detectar Nomes com IA */}
            <div className="flex items-center gap-2">
              <button
                onClick={onDetectNames}
                disabled={!nerEnabled || detectingNames}
                title={!nerEnabled ? 'Ative o NER em ConfiguraÃ§Ãµes IA' : 'Detectar nomes automaticamente'}
                className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${
                  nerEnabled && !detectingNames
                    ? 'bg-purple-600 text-white hover-purple-700'
                    : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                }`}
              >
                {detectingNames ? (
                  <>
                    <RefreshCw className="w-3.5 h-3.5 animate-spin" />
                    Detectando...
                  </>
                ) : (
                  <>
                    <Wand2 className="w-3.5 h-3.5" />
                    Detectar Nomes
                  </>
                )}
              </button>
              {!nerEnabled && (
                <button
                  onClick={onOpenAiSettings}
                  className="text-xs text-amber-400 underline"
                  title="Abrir configuraÃ§Ãµes de IA"
                >
                  Configurar IA
                </button>
              )}
            </div>
          </div>
          <textarea value={nomesTexto} onChange={(e) => setNomesTexto(e.target.value)}
            className="w-full h-48 theme-bg-app border theme-border-primary rounded-lg p-3 theme-text-secondary font-mono text-sm"
            placeholder="JOÃƒO DA SILVA&#10;MARIA SANTOS&#10;EMPRESA XYZ LTDA&#10;..." />
          <p className="text-xs theme-text-tertiary mt-2">ğŸ’¡ CPF, CNPJ, telefone, e-mail serÃ£o anonimizados automaticamente.</p>
        </div>
      </div>
    </BaseModal>
  );
});
AnonymizationNamesModal.displayName = 'AnonymizationNamesModal';

// v1.21.16: Modal de preview de texto extraÃ­do
const TextPreviewModal = React.memo(({ isOpen, onClose, title, text }: TextPreviewModalProps) => {
  // v1.35.67: ESC handler
  React.useEffect(() => {
    if (!isOpen) return;
    const handleEsc = (e: KeyboardEvent) => { if (e.key === 'Escape') onClose(); };
    window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  // v1.35.67: Scroll lock
  React.useEffect(() => {
    if (isOpen) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => { document.body.style.overflow = originalOverflow; };
    }
  }, [isOpen]);

  if (!isOpen) return null;

  return (
    <div className={`${CSS.modalOverlay} overflow-y-auto`} style={{ alignItems: 'flex-start' }} onClick={onClose}>
      <div
        className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal w-full max-w-4xl my-8`}
        onClick={(e) => e.stopPropagation()}
      >
        <div className={`${CSS.modalHeader} flex items-start justify-between`}>
          <div className="flex items-center gap-3">
            <div className="p-3 rounded-xl bg-blue-500/20">
              <Eye className="w-6 h-6 text-blue-400" />
            </div>
            <div>
              <h3 className="text-lg font-semibold theme-text-primary">Preview: {title}</h3>
              <p className="text-xs theme-text-muted">{text?.length?.toLocaleString() || 0} caracteres</p>
            </div>
          </div>
          <button onClick={onClose} className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors" title="Fechar">
            <X className="w-5 h-5 theme-text-tertiary" />
          </button>
        </div>
        <div className="p-4 max-h-[70vh] overflow-y-auto">
          <pre className="whitespace-pre-wrap text-sm theme-text-secondary font-mono bg-black/20 p-4 rounded-lg">
            {text || 'Sem conteÃºdo'}
          </pre>
        </div>
      </div>
    </div>
  );
});
TextPreviewModal.displayName = 'TextPreviewModal';

const DispositivoModal: React.FC<DispositivoModalProps> = ({
  isOpen,
  onClose,
  dispositivoText = '',
  setDispositivoText,
  copySuccess,
  setCopySuccess,
  setError,
  extractedTopics,
  setExtractedTopics,
  selectedTopics,
  setSelectedTopics,
  sanitizeHTML = (html: string) => html || ''
}) => {
  const timeoutRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);
  React.useEffect(() => () => { if (timeoutRef.current) clearTimeout(timeoutRef.current); }, []);

  // ESC handler
  React.useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => { if (e.key === 'Escape') onClose(); };
    if (isOpen) window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  const handleAddToTopics = React.useCallback(() => {
    const dispositivoTopic: Topic = {
      title: 'DISPOSITIVO',
      category: 'DISPOSITIVO' as TopicCategory,
      relatorio: 'Dispositivo final da sentenÃ§a com todos os pedidos julgados.',
      editedContent: dispositivoText.replace(/\n/g, '<br>')
    };

    // Verificar se jÃ¡ existe em extractedTopics
    const existsInExtracted = extractedTopics.some((t: Topic) =>
      t.title.toUpperCase() === 'DISPOSITIVO'
    );

    if (existsInExtracted) {
      // Substituir em extractedTopics
      setExtractedTopics(extractedTopics.map((t: Topic) =>
        t.title.toUpperCase() === 'DISPOSITIVO' ? dispositivoTopic : t
      ));
    } else {
      // Adicionar em extractedTopics
      setExtractedTopics([...extractedTopics, dispositivoTopic]);
    }

    // Verificar se jÃ¡ existe em selectedTopics
    const existsInSelected = selectedTopics.some((t: Topic) =>
      t.title.toUpperCase() === 'DISPOSITIVO'
    );

    if (existsInSelected) {
      // Substituir em selectedTopics
      setSelectedTopics(selectedTopics.map((t: Topic) =>
        t.title.toUpperCase() === 'DISPOSITIVO' ? dispositivoTopic : t
      ));
    } else {
      // Adicionar em selectedTopics
      setSelectedTopics([...selectedTopics, dispositivoTopic]);
    }

    onClose();
  }, [dispositivoText, extractedTopics, selectedTopics]); // ğŸš€ v1.8.3: Memoizado (GRUPO B)

  if (!isOpen) return null;

  // Copiar como texto puro (mantÃ©m compatibilidade)
  const handleCopyDispositivo = async () => {
    try {
      await navigator.clipboard.writeText(dispositivoText);
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
      setCopySuccess(true);
      timeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
    } catch (err) {
      setError('Erro ao copiar dispositivo');
    }
  };

  const handleCopyFormattedDispositivo = async () => {
    try {
      const tempDiv = document.createElement('div');
      tempDiv.style.position = 'absolute';
      tempDiv.style.left = '-9999px';
      tempDiv.innerHTML = dispositivoText;
      document.body.appendChild(tempDiv);
      const range = document.createRange();
      range.selectNodeContents(tempDiv);
      const selection = window.getSelection();
      if (selection) {
        selection.removeAllRanges();
        selection.addRange(range);
      }
      let success = false;
      try { success = document.execCommand('copy'); } catch (e) { /* execCommand deprecated */ }
      if (selection) selection.removeAllRanges();
      document.body.removeChild(tempDiv);
      if (success) {
        if (timeoutRef.current) clearTimeout(timeoutRef.current);
        setCopySuccess(true);
        timeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
      } else {
        await navigator.clipboard.writeText(dispositivoText);
        if (timeoutRef.current) clearTimeout(timeoutRef.current);
        setCopySuccess(true);
        timeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
      }
    } catch (err) {
      setError('Erro ao copiar dispositivo formatado');
    }
  };

  return (
    <div className={`${CSS.modalOverlay} overflow-auto`}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-6xl w-full max-h-[95vh] flex flex-col my-auto`}>
        {/* Header - fixo */}
        <div className={`${CSS.modalHeader} flex-shrink-0`}>
          <div className="flex items-center justify-between w-full">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-purple-500/20">
                <Sparkles className="w-6 h-6 text-purple-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold theme-text-primary">Dispositivo Gerado com IA</h3>
                <p className="text-sm theme-text-muted">Revise e edite conforme necessÃ¡rio antes de copiar</p>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>

        {/* ConteÃºdo com scroll */}
        <div className="flex-1 overflow-y-auto">
          {/* Aviso crÃ­tico sobre revisÃ£o */}
          {/* v1.9.37: Cores corrigidas para tema claro */}
          <div className="m-6 p-4 bg-amber-500/15 border-2 border-amber-500/50 rounded-lg flex-shrink-0">
            <div className="flex items-start gap-3">
              <span className="text-amber-500 text-2xl flex-shrink-0">âš ï¸</span>
              <div className="text-sm text-amber-700 dark:text-amber-100">
                <p className="font-bold text-amber-600 dark:text-amber-400 mb-2">ATENÃ‡ÃƒO: REVISÃƒO OBRIGATÃ“RIA</p>
                <p className="text-xs leading-relaxed">
                  Este dispositivo foi gerado por IA e pode conter erros, imprecisÃµes ou omissÃµes.
                  <span className="font-semibold text-amber-700 dark:text-amber-200"> Ã‰ OBRIGATÃ“RIO que vocÃª revise minuciosamente:</span>
                </p>
                <ul className="text-xs mt-2 space-y-1 ml-4">
                  <li>âœ“ Nomes corretos das partes</li>
                  <li>âœ“ Pedidos e valores mencionados</li>
                  <li>âœ“ FundamentaÃ§Ã£o legal adequada</li>
                  <li>âœ“ CoerÃªncia com a fundamentaÃ§Ã£o da sentenÃ§a</li>
                  <li>âœ“ Ortografia e gramÃ¡tica</li>
                </ul>
                <p className="text-xs mt-3 text-amber-600 dark:text-amber-300/80 font-semibold border-t border-amber-500/30 pt-2">
                  Sua revisÃ£o Ã© fundamental, na forma estabelecida pela ResoluÃ§Ã£o 615/2025 do CNJ.
                </p>
              </div>
            </div>
          </div>

          {/* Ãrea de preview HTML renderizado (read-only) */}
          <div className="px-6 pb-6">
            <style>{`
              .dispositivo-preview p {
                margin-bottom: 1rem;
              }
              .dispositivo-preview br {
                display: block;
                content: "";
                margin-top: 0.5rem;
              }
              .dispositivo-preview strong,
              .dispositivo-preview b {
                font-weight: 700;
                color: #fbbf24;
              }
              .dispositivo-preview em,
              .dispositivo-preview i {
                font-style: italic;
              }
              .dispositivo-preview u {
                text-decoration: underline;
              }
              .dispositivo-preview ul,
              .dispositivo-preview ol {
                margin-left: 1.5rem;
                margin-bottom: 1rem;
              }
              .dispositivo-preview li {
                margin-bottom: 0.5rem;
              }
            `}</style>
            <div
              className="dispositivo-preview w-full h-96 theme-bg-app border theme-border-input rounded-lg p-6 theme-text-primary text-base overflow-y-auto"
              style={{
                lineHeight: '1.8',
                whiteSpace: 'pre-wrap',
                wordWrap: 'break-word'
              }}
              dangerouslySetInnerHTML={{
                __html: sanitizeHTML(dispositivoText) || '<p style="color: #94a3b8; font-style: italic;">O dispositivo serÃ¡ gerado aqui...</p>'
              }}
            />
          </div>

          {/* Dicas - fixas, compactas */}
          <div className="px-6 pb-6 space-y-3">
            {/* v1.5.1: Dica sobre opÃ§Ãµes de cÃ³pia */}
            <div className="p-3 bg-purple-900/20 border border-purple-500/30 rounded-lg flex items-start gap-2">
              <span className="text-purple-400 text-lg">ğŸ“‹</span>
              <div className="flex-1 text-xs theme-text-tertiary">
                <p className="font-medium theme-text-purple mb-1">OpÃ§Ãµes de CÃ³pia:</p>
                <p className="text-xs">
                  <strong className="theme-text-secondary">Copiar Formatado:</strong> Preserva negrito, parÃ¡grafos e formataÃ§Ã£o HTML (ideal para Word/Google Docs)
                  <br />
                  <strong className="theme-text-tertiary">Copiar Texto Puro:</strong> Remove toda formataÃ§Ã£o (Ãºtil para editores de texto simples)
                </p>
              </div>
            </div>

            <div className="theme-info-box flex items-start gap-2">
              <span className="text-blue-400 text-lg">ğŸ’¡</span>
              <div className="flex-1 text-xs theme-text-tertiary">
                <p className="font-medium theme-text-blue mb-1">Dicas rÃ¡pidas:</p>
                <p className="text-xs">
                  Revise nomes das partes â€¢ Verifique pedidos â€¢ Confira valores â€¢ Adapte ao seu estilo â€¢ Edite diretamente
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* BotÃµes - fixos */}
        <div className={`${CSS.modalFooter} flex-shrink-0`}>
          {/* v1.5.1: BotÃ£o Copiar Texto Puro */}
          <button
            onClick={handleCopyDispositivo}
            className="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg font-medium theme-bg-tertiary hover-slate-500"
            title="Copiar como texto puro (sem formataÃ§Ã£o)"
          >
            <Download className="w-5 h-5" />
            {copySuccess ? 'âœ“ Copiado!' : 'Copiar Texto Puro'}
          </button>

          {/* v1.5.1: BotÃ£o Copiar Formatado (NOVO) */}
          <button
            onClick={handleCopyFormattedDispositivo}
            className="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg font-medium shadow-lg hover-gradient-purple-blue bg-gradient-to-r from-purple-600 to-blue-600 text-white transition-all duration-300"
            title="Copiar com formataÃ§Ã£o (negrito, parÃ¡grafos) para Word/Google Docs"
          >
            <Download className="w-5 h-5" />
            {copySuccess ? 'âœ“ Copiado!' : 'Copiar Formatado'}
          </button>

          <button
            onClick={handleAddToTopics}
            className="px-6 py-3 rounded-lg font-medium bg-green-600 text-white hover-green-700-from-600"
          >
            {selectedTopics.some((t: Topic) => t.title.toUpperCase() === 'DISPOSITIVO')
              ? 'Substituir Dispositivo'
              : 'Adicionar aos TÃ³picos'}
          </button>
          <button
            onClick={onClose}
            className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  );
};

// Modal: Descartar Modelos em Lote (migrado para BaseModal)
const BulkDiscardConfirmModal = React.memo(({ isOpen, onClose, totalModels, onConfirm }: BulkDiscardConfirmModalProps) => (
  <BaseModal isOpen={isOpen} onClose={onClose} title="Descartar Modelos?" icon={<AlertCircle />} iconColor="red" size="sm"
    footer={<ModalFooter.Destructive onClose={onClose} onConfirm={onConfirm} confirmText="Sim, Descartar" />}>
    <div className="space-y-4">
      <p className="theme-text-tertiary">Descartar <strong className="theme-text-primary">{totalModels} modelo(s)</strong>?</p>
      <p className="text-sm theme-text-muted">Todos serÃ£o perdidos e precisarÃ¡ processar novamente.</p>
    </div>
  </BaseModal>
));
BulkDiscardConfirmModal.displayName = 'BulkDiscardConfirmModal';

// Modal: Cancelar Processamento em Lote (migrado para BaseModal)
const ConfirmBulkCancelModal = React.memo(({ isOpen, onClose, filesInProgress, onConfirm }: ConfirmBulkCancelModalProps) => (
  <BaseModal isOpen={isOpen} onClose={onClose} title="Cancelar Processamento?" icon={<AlertCircle />} iconColor="yellow" size="sm"
    footer={<><button onClick={onClose} className={CSS.btnSecondary}>Continuar</button><button onClick={onConfirm} className="flex-1 px-4 py-3 rounded-lg font-medium bg-amber-600 text-white hover-amber-700-from-600">Sim, Cancelar</button></>}>
    <div className="space-y-4">
      <p className="theme-text-tertiary">Cancelar processamento de <strong className="theme-text-primary">{filesInProgress} arquivo(s)</strong>?</p>
      <ModalInfoBox>â„¹ï¸ Os modelos jÃ¡ gerados serÃ£o preservados.</ModalInfoBox>
    </div>
  </BaseModal>
));
ConfirmBulkCancelModal.displayName = 'ConfirmBulkCancelModal';

const LockedTabOverlay = React.memo(({ isPrimaryTab, activeTab, setActiveTab }: LockedTabOverlayProps) => {
  const [controlTaken, setControlTaken] = React.useState(false);

  const handleTakeControl = React.useCallback(() => {
    const LOCK_KEY = 'sentencify-primary-tab-lock';
    const TAKEOVER_KEY = 'sentencify-tab-takeover';

    // PHASE 1: Gerar futuro tabId (mesmo formato que o hook usa)
    const futureTabId = `tab-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    // PHASE 2: Salvar em sessionStorage (sobrevive ao reload)
    sessionStorage.setItem(TAKEOVER_KEY, futureTabId);

    // PHASE 3: Escrever lock com futureTabId
    // Isso previne que Tab 1 reclame o lock antes de Tab 2 recarregar
    localStorage.setItem(LOCK_KEY, JSON.stringify({
      tabId: futureTabId,
      timestamp: Date.now(),
      takeover: true
    }));

    setControlTaken(true);
  }, [setControlTaken]);

  const handleGoToModels = React.useCallback(() => {
    setActiveTab('models');
  }, [setActiveTab]);

  // v1.20.3: NÃ£o mostrar overlay se for aba primÃ¡ria OU se estiver em abas liberadas (read-only)
  // Modelos, JurisprudÃªncia e LegislaÃ§Ã£o sÃ£o acessÃ­veis em modo secundÃ¡rio
  const READONLY_ALLOWED_TABS = ['models', 'jurisprudencia', 'legislacao'];
  if (isPrimaryTab || READONLY_ALLOWED_TABS.includes(activeTab)) {
    return null;
  }

  return (
    <div
      role="dialog"
      aria-modal="true"
      aria-labelledby="locked-tab-title"
      style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0, 0, 0, 0.85)',
        backdropFilter: 'blur(8px)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 9999,
        padding: '20px'
      }}
    >
      <div
        style={{
          background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
          border: '2px solid #3b82f6',
          borderRadius: '16px',
          padding: '40px',
          maxWidth: '500px',
          width: '100%',
          boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.1)',
          textAlign: 'center'
        }}
      >
        {/* Ãcone de Cadeado */}
        <div
          style={{
            width: '80px',
            height: '80px',
            margin: '0 auto 24px',
            borderRadius: '50%',
            background: 'linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            boxShadow: '0 8px 16px rgba(59, 130, 246, 0.3)'
          }}
        >
          <svg
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="white"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>

        {/* TÃ­tulo */}
        <h2
          id="locked-tab-title"
          style={{
            fontSize: '24px',
            fontWeight: '700',
            color: '#f1f5f9',
            marginBottom: '16px',
            letterSpacing: '-0.025em'
          }}
        >
          Aba Bloqueada
        </h2>

        {/* Mensagem */}
        <p
          style={{
            fontSize: '15px',
            color: '#94a3b8',
            lineHeight: '1.6',
            marginBottom: '12px'
          }}
        >
          Outra aba estÃ¡ atualmente editando este projeto. Para evitar conflitos e perda de dados,
          apenas uma aba pode editar por vez.
          <br /><br />
          <span style={{ color: '#60a5fa' }}>
            A <strong>Biblioteca de Modelos</strong> continua funcionando normalmente em todas as abas.
          </span>
        </p>

        {/* v1.9.10: InstruÃ§Ã£o para assumir controle */}
        <p
          style={{
            fontSize: controlTaken ? '16px' : '14px',
            color: '#fbbf24',
            lineHeight: '1.5',
            marginBottom: '24px',
            padding: '12px 16px',
            background: 'rgba(251, 191, 36, 0.1)',
            borderRadius: '8px',
            border: '1px solid rgba(251, 191, 36, 0.3)',
            fontWeight: controlTaken ? '700' : '400',
            animation: controlTaken ? 'pulse 2s ease-in-out infinite' : 'none',
            transition: 'all 0.3s ease'
          }}
        >
          {controlTaken ? (
            <>
              <strong>âœ“ Controle assumido!</strong><br />
              Agora pressione <kbd style={{
                padding: '4px 8px',
                background: 'rgba(255, 255, 255, 0.2)',
                borderRadius: '4px',
                fontFamily: 'monospace',
                fontSize: '15px',
                fontWeight: '700',
                boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)'
              }}>F5</kbd> para recarregar a pÃ¡gina
            </>
          ) : (
            <>
              <strong>Para assumir o controle:</strong><br />
              1. Clique em "Assumir Controle" para reivindicar o lock<br />
              2. Depois, pressione <kbd style={{
                padding: '2px 6px',
                background: 'rgba(255, 255, 255, 0.1)',
                borderRadius: '4px',
                fontFamily: 'monospace',
                fontSize: '13px'
              }}>F5</kbd> para recarregar
            </>
          )}
        </p>

        {/* BotÃ£o de Assumir Controle */}
        <button
          onClick={handleTakeControl}
          disabled={controlTaken}
          style={{
            width: '100%',
            padding: '14px 24px',
            background: controlTaken
              ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
              : 'linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%)',
            color: 'white',
            fontSize: '15px',
            fontWeight: '600',
            border: 'none',
            borderRadius: '8px',
            cursor: controlTaken ? 'not-allowed' : 'pointer',
            boxShadow: controlTaken
              ? '0 4px 12px rgba(16, 185, 129, 0.3)'
              : '0 4px 12px rgba(59, 130, 246, 0.3)',
            transition: 'all 0.2s ease',
            letterSpacing: '0.025em',
            opacity: controlTaken ? 0.9 : 1
          }}
          onMouseEnter={(e) => {
            if (!controlTaken) {
              e.currentTarget.style.transform = 'translateY(-2px)';
              e.currentTarget.style.boxShadow = '0 8px 20px rgba(59, 130, 246, 0.4)';
            }
          }}
          onMouseLeave={(e) => {
            if (!controlTaken) {
              e.currentTarget.style.transform = 'translateY(0)';
              e.currentTarget.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
            }
          }}
        >
          {controlTaken ? 'âœ“ Controle Assumido' : 'ğŸ”’ Assumir Controle'}
        </button>

        {/* v1.9.6: BotÃ£o para acessar Modelos sem assumir controle */}
        <button
          onClick={handleGoToModels}
          disabled={controlTaken}
          style={{
            width: '100%',
            marginTop: '12px',
            padding: '12px 24px',
            background: 'transparent',
            color: controlTaken ? '#64748b' : '#60a5fa',
            fontSize: '14px',
            fontWeight: '500',
            border: `2px solid ${controlTaken ? '#475569' : '#3b82f6'}`,
            borderRadius: '8px',
            cursor: controlTaken ? 'not-allowed' : 'pointer',
            transition: 'all 0.2s ease',
            opacity: controlTaken ? 0.5 : 1
          }}
          onMouseEnter={(e) => {
            if (!controlTaken) {
              e.currentTarget.style.background = 'rgba(59, 130, 246, 0.1)';
              e.currentTarget.style.borderColor = '#60a5fa';
            }
          }}
          onMouseLeave={(e) => {
            if (!controlTaken) {
              e.currentTarget.style.background = 'transparent';
              e.currentTarget.style.borderColor = '#3b82f6';
            }
          }}
        >
          ğŸ“š Ir para Biblioteca de Modelos
        </button>

        {/* Nota de RodapÃ© */}
        <p
          style={{
            fontSize: '13px',
            color: '#64748b',
            marginTop: '20px',
            fontStyle: 'italic'
          }}
        >
          Ao assumir o controle, a outra aba serÃ¡ bloqueada automaticamente.
        </p>
      </div>
    </div>
  );
});

LockedTabOverlay.displayName = 'LockedTabOverlay';

// ğŸ” Modal de Aviso de Similaridade (v1.13.3 - ComparaÃ§Ã£o lado a lado)
// v1.33.3: Feedback visual "Salvando..." durante geraÃ§Ã£o de embedding
const SimilarityWarningModal = React.memo(({ warning, saving, onCancel, onSaveNew, onReplace, sanitizeHTML = (html: string) => html || '' }: SimilarityWarningModalProps) => {
  // ESC handler
  React.useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => { if (e.key === 'Escape' && !saving) onCancel(); };
    if (warning) window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [warning, saving, onCancel]);

  if (!warning) return null;
  const { newModel, similarModel, similarity } = warning;
  const pct = Math.round(similarity * 100);
  return (
    <div className={CSS.modalOverlay} style={{zIndex:60}}>
      <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-5xl w-full`}>
        <div className={CSS.modalHeader}>
          <div className="flex items-center justify-between w-full">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-amber-500/20">
                <AlertTriangle className="w-6 h-6 text-amber-400" />
              </div>
              <h3 className="text-lg font-semibold theme-text-primary">Modelo Similar Encontrado ({pct}%)</h3>
            </div>
            <button
              onClick={onCancel}
              disabled={saving}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors disabled:opacity-50"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>
        <div className="p-6">
          <div className="grid grid-cols-2 gap-4 mb-4">
            <div className="theme-card p-4 flex flex-col">
              <div className="flex-shrink-0 mb-2">
                <p className="text-xs theme-text-muted mb-1">NOVO MODELO</p>
                <p className="font-semibold theme-text-secondary text-sm" style={{wordBreak:'break-word'}}>{newModel.title}</p>
              </div>
              <div className="flex-1 overflow-y-auto text-sm theme-text-secondary border theme-border-input rounded p-3 theme-bg-tertiary" style={{maxHeight:'300px'}} dangerouslySetInnerHTML={{__html: sanitizeHTML(newModel.content || '')}} />
            </div>
            <div className="theme-card p-4 flex flex-col border-yellow-500/50">
              <div className="flex-shrink-0 mb-2">
                <p className="text-xs theme-text-muted mb-1">MODELO EXISTENTE</p>
                <p className="font-semibold theme-text-yellow text-sm" style={{wordBreak:'break-word'}}>{similarModel.title}</p>
              </div>
              <div className="flex-1 overflow-y-auto text-sm theme-text-secondary border theme-border-input rounded p-3 theme-bg-tertiary" style={{maxHeight:'300px'}} dangerouslySetInnerHTML={{__html: sanitizeHTML(similarModel.content || '')}} />
            </div>
          </div>
          <p className="text-sm theme-text-muted text-center">{saving ? 'Salvando modelo...' : 'O que deseja fazer?'}</p>
        </div>
        <div className="px-6 pb-6 flex gap-3 justify-center">
          <button onClick={onCancel} className={CSS.btnSecondary} disabled={saving}>Cancelar</button>
          <button onClick={onSaveNew} className={CSS.btnSuccess} disabled={saving}>{saving ? 'Salvando...' : 'Salvar Mesmo Assim'}</button>
          <button onClick={onReplace} className="px-4 py-2 rounded-lg font-medium bg-amber-600 text-white hover-amber-700-from-600 disabled:opacity-50" disabled={saving}>{saving ? 'Salvando...' : 'Substituir Existente'}</button>
        </div>
      </div>
    </div>
  );
});
SimilarityWarningModal.displayName = 'SimilarityWarningModal';

const BulkReviewModal: React.FC<BulkReviewModalProps> = ({
  isOpen,
  onClose,
  bulkReviewModels,
  bulkFiles,
  bulkGeneratedModels,
  bulkErrors,
  onRemoveModel,
  onDiscard,
  onSave,
  sanitizeHTML = (html: string) => html || ''
}) => {
  if (!isOpen) return null;

  return (
    <div className={CSS.modalOverlay}>
      <div className={`${CSS.modalContainer} max-w-6xl w-full flex flex-col`} style={{ maxHeight: '90vh', height: 'auto' }}>
        <div className={`${CSS.modalHeader} flex-shrink-0`}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <span className="text-3xl">âœ…</span>
              <div>
                <h3 className="text-2xl font-bold text-green-400">RevisÃ£o de Modelos Gerados</h3>
                <p className="text-sm theme-text-muted mt-1">
                  {bulkReviewModels.length} modelo{bulkReviewModels.length !== 1 ? 's' : ''} gerado{bulkReviewModels.length !== 1 ? 's' : ''} de {bulkFiles.length} arquivo{bulkFiles.length !== 1 ? 's' : ''}
                </p>
              </div>
            </div>
          </div>
        </div>

        <div className="overflow-y-auto flex-1 p-6">
          {/* Resumo */}
          <div className="theme-info-box p-4 mb-6">
            <div className="flex items-start gap-3">
              <span className="text-2xl">ğŸ“ˆ</span>
              <div className="flex-1">
                <p className="font-semibold theme-text-secondary mb-2">Resumo do Processamento:</p>
                <div className="grid grid-cols-3 gap-4 text-sm">
                  <div>
                    <p className="theme-text-muted">Total de arquivos:</p>
                    <p className="text-lg font-bold theme-text-blue">{bulkFiles.length}</p>
                  </div>
                  <div>
                    <p className="theme-text-muted">Modelos na revisÃ£o:</p>
                    <p className="text-lg font-bold theme-text-green">{bulkReviewModels.length}</p>
                  </div>
                  <div>
                    <p className="theme-text-muted">Erros:</p>
                    <p className="text-lg font-bold theme-text-red">{bulkErrors.length}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Erros (se houver) */}
          {bulkErrors.length > 0 && (
            <div className="bg-red-900/20 border border-red-500/30 rounded-lg p-4 mb-6">
              <p className="font-semibold theme-text-red mb-2">âš ï¸ Arquivos com erro:</p>
              <div className="space-y-1 text-sm">
                {bulkErrors.map((err: BulkError, idx: number) => (
                  <div key={idx} className="theme-text-secondary">
                    â€¢ <span className="font-medium">{err.file}</span>: {err.error || 'Erro desconhecido'}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Lista de Modelos */}
          <div className="space-y-4">
            {bulkReviewModels.map((model: BulkGeneratedModel, idx: number) => (
              <div
                key={idx}
                style={{ borderColor: '#475569', transition: 'border-color 0.3s ease' }}
                className="theme-bg-secondary-30 rounded-lg border p-4 hover-border-purple-alpha-50"
              >
                <div className="flex items-start justify-between mb-3">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="theme-text-muted text-sm">#{idx + 1}</span>
                      <h4 className="font-semibold theme-text-primary">{model.title}</h4>
                    </div>
                    <div className="flex items-center gap-2 flex-wrap">
                      <span className="text-xs px-2 py-0.5 rounded theme-bg-purple-accent theme-text-purple border border-purple-500/30">
                        {model.category}
                      </span>
                      <span className="text-xs px-2 py-0.5 rounded theme-bg-blue-accent theme-text-blue border border-blue-500/30">
                        ğŸ“ {model.sourceFile}
                      </span>
                      {model.keywords && (
                        <span className={CSS.textMuted}>
                          ğŸ·ï¸ {(Array.isArray(model.keywords) ? model.keywords : String(model.keywords).split(',')).slice(0, 3).join(', ')}
                        </span>
                      )}
                      {model.similarityInfo && (
                        <span className={`text-xs px-2 py-1 rounded font-medium ${
                          model.similarityInfo.similarity > 0.90
                            ? 'bg-red-500/20 text-red-300 border border-red-500/30'
                            : 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30'
                        }`}>
                          âš ï¸ {Math.round(model.similarityInfo.similarity * 100)}% similar a "{model.similarityInfo.similarModel.title}"
                        </span>
                      )}
                    </div>
                  </div>
                  <button
                    onClick={() => onRemoveModel(model.id || String(idx))}
                    className="hover-delete-topic p-2 rounded"
                    title="Remover este modelo"
                  >
                    <Trash2 className="w-5 h-5" />
                  </button>
                </div>

                {/* Preview do conteÃºdo */}
                <div className="theme-bg-primary-50 rounded p-3 text-sm theme-text-tertiary">
                  <div
                    dangerouslySetInnerHTML={{ __html: sanitizeHTML(model.content).substring(0, 300) + '...' }}
                    className="line-clamp-3"
                  />
                </div>
              </div>
            ))}
          </div>

          {bulkReviewModels.length === 0 && (
            <div className="text-center py-12 theme-text-muted">
              <p className="text-lg mb-2">Nenhum modelo para revisar</p>
              <p className="text-sm">Todos os modelos foram removidos ou nenhum foi gerado.</p>
            </div>
          )}
        </div>

        <div className={`${CSS.modalFooter} flex-shrink-0`}>
          <button
            onClick={onDiscard}
            className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500"
          >
            Descartar Tudo
          </button>
          <button
            onClick={onSave}
            disabled={bulkReviewModels.length === 0}
            className="flex-1 px-6 py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white hover-gradient-green transition-all duration-300"
          >
            <Save className="w-5 h-5" />
            Salvar {bulkReviewModels.length} Modelo{bulkReviewModels.length !== 1 ? 's' : ''}
          </button>
        </div>
      </div>
    </div>
  );
};

const BulkUploadModal: React.FC<BulkUploadModalProps> = ({
  isOpen,
  onClose,
  isProcessing,
  isReviewOpen,
  bulkFiles,
  bulkFileInputRef,
  onFileUpload,
  onRemoveFile,
  onProcess,
  currentFileIndex,
  processedFiles,
  bulkStaggerDelay,
  setBulkStaggerDelay,
  bulkCancelController,
  generatedModels,
  bulkCurrentBatch,
  bulkBatchSize = 3,
  openModal
}) => {
  if (!isOpen) return null;

  // View 1: Upload/Selection (quando NÃƒO estÃ¡ processando E NÃƒO estÃ¡ na revisÃ£o)
  if (!isProcessing && !isReviewOpen) {
    return (
      <div className="fixed inset-0 z-[90] p-4 theme-modal-overlay backdrop-blur-sm flex items-start justify-center pt-8 overflow-y-auto">
        <div className="theme-modal-container theme-border-modal theme-modal-glow animate-modal max-w-3xl w-full mb-8">
          <div className={CSS.modalHeader}>
            <div className="flex items-center justify-between w-full">
              <div className="flex items-center gap-3">
                <div className="p-3 rounded-xl bg-purple-500/20">
                  <Sparkles className="w-6 h-6 text-purple-400" />
                </div>
                <div>
                  <h3 className="text-lg font-semibold theme-text-primary">Criar Modelos de Arquivos com IA</h3>
                  <p className="text-sm theme-text-muted">
                    Envie atÃ© 20 arquivos e deixe a IA criar modelos completos automaticamente
                  </p>
                </div>
              </div>
              <button
                onClick={onClose}
                className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
                title="Fechar"
              >
                <X className="w-5 h-5 theme-text-tertiary" />
              </button>
            </div>
          </div>

          <div className="p-6 space-y-6">
            {/* Ãrea de Upload */}
            <div>
              <label className="block text-sm font-medium theme-text-tertiary mb-3">
                ğŸ“¤ Selecione os arquivos (PDF, DOCX, DOC ou TXT)
              </label>
              <div
                onClick={() => bulkFileInputRef.current?.click()}
                className="hover-bulk-upload-area border-2 border-dashed rounded-lg p-8 text-center cursor-pointer"
              >
                <Upload className="w-12 h-12 theme-text-disabled mx-auto mb-3" />
                <p className="theme-text-tertiary font-medium mb-1">
                  Clique para selecionar arquivos
                </p>
                <p className="text-sm theme-text-disabled">
                  PDF, DOCX, DOC, TXT - MÃ¡ximo: 20 arquivos
                </p>
                <p className="text-xs theme-text-disabled mt-2">
                  âš¡ ExtraÃ§Ã£o de texto 100% local e rÃ¡pida
                </p>
              </div>
              <input
                ref={bulkFileInputRef}
                type="file"
                multiple
                accept=".pdf,.docx,.doc,.txt"
                onChange={onFileUpload}
                className="hidden"
              />
            </div>

            {/* Lista de Arquivos Selecionados */}
            {bulkFiles.length > 0 && (
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  ğŸ“‹ Arquivos Selecionados ({bulkFiles.length}/20)
                </label>
                <div className="theme-bg-secondary-30 rounded-lg border theme-border-input max-h-64 overflow-y-auto">
                  {bulkFiles.map((bulkFile: BulkFile, idx: number) => (
                    <div
                      key={idx}
                      className="flex items-center justify-between p-3 border-b theme-border-input/50 last:border-b-0 hover-slate-alpha-30-from-transparent"
                    >
                      <div className="flex items-center gap-3 flex-1 min-w-0">
                        <FileText className="w-5 h-5 text-blue-400 flex-shrink-0" />
                        <span className="text-sm theme-text-secondary truncate">{bulkFile.name}</span>
                        <span className="text-xs theme-text-disabled">
                          ({(bulkFile.size / 1024).toFixed(1)} KB)
                        </span>
                      </div>
                      <button
                        onClick={() => onRemoveFile(idx)}
                        className="hover-delete-topic p-1 rounded"
                        title="Remover"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* InformaÃ§Ãµes */}
            <div className="theme-info-box p-4">
              <div className="flex items-start gap-3">
                <span className="text-blue-400 text-2xl">ğŸ’¡</span>
                <div className="text-sm theme-text-secondary">
                  <p className="font-semibold mb-2">Como funciona:</p>
                  <ul className="space-y-1 list-disc list-inside">
                    <li>Cada arquivo pode gerar 1 ou mais modelos</li>
                    <li>A IA identifica automaticamente os tÃ³picos jurÃ­dicos</li>
                    <li>VocÃª poderÃ¡ revisar e editar antes de salvar</li>
                    <li>Se houver erros, o processo continua com os prÃ³ximos</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          {/* v1.5.15: ConfiguraÃ§Ã£o de delay entre arquivos (staggered start) */}
          <div className="px-6 pb-4">
            <div className="theme-bg-secondary-50 rounded-lg border theme-border-input p-4">
              <label className={CSS.label}>
                âš™ï¸ Delay entre iniciar arquivos (Rate Limiting)
              </label>
              <select
                value={bulkStaggerDelay}
                onChange={(e) => setBulkStaggerDelay(Number(e.target.value))}
                className="w-full px-3 py-2 theme-bg-primary border theme-border-input rounded theme-text-secondary text-sm"
              >
                <option value={0}>Sem delay - MÃ¡xima velocidade ({bulkBatchSize} por lote)</option>
                <option value={300}>300ms - Balanceado (delay dentro do lote)</option>
                <option value={500}>500ms - Conservador (delay dentro do lote)</option>
                <option value={1000}>1s - Muito conservador (delay dentro do lote)</option>
              </select>
              <p className="text-xs theme-text-muted mt-2">
                ğŸ’¡ Sistema de lotes ativo ({bulkBatchSize} arquivos/lote + 1s entre lotes). Delay adicional entre iniciar os {bulkBatchSize} arquivos do lote.
              </p>
            </div>
          </div>

          <div className={CSS.modalFooter}>
            <button
              onClick={onClose}
              className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500"
            >
              Cancelar
            </button>
            <button
              onClick={onProcess}
              disabled={bulkFiles.length === 0}
              className="flex-1 px-6 py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 hover-gradient-blue-purple transition-all duration-300 text-white"
            >
              <Zap className="w-5 h-5" />
              Processar {bulkFiles.length} Arquivo{bulkFiles.length !== 1 ? 's' : ''}
            </button>
          </div>
        </div>
      </div>
    );
  }

  // View 2: Processing (quando estÃ¡ processando)
  if (isProcessing) {
    return (
      <div className={CSS.modalOverlay}>
        <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-2xl w-full flex flex-col`} style={{ maxHeight: '90vh' }}>
          <div className={CSS.modalHeader}>
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-xl bg-purple-500/20">
                <Loader2 className="w-6 h-6 text-purple-400 animate-spin" />
              </div>
              <div>
                <h3 className="text-lg font-semibold theme-text-primary">Processando Arquivos...</h3>
                <p className="text-sm theme-text-muted">
                  Aguarde enquanto a IA analisa os documentos
                </p>
              </div>
            </div>
          </div>

          {/* v1.5.15: Grid de cards por arquivo (processamento paralelo) */}
          <div className="p-6 space-y-4 flex-1 overflow-y-auto">
            {/* Grid de status por arquivo */}
            <div className="space-y-3">
              {bulkFiles.map((bulkFile: BulkFile, index: number) => {
                const result = processedFiles.find((f: { file: string; status: string }) => f.file === bulkFile.name);
                const isComplete = result?.status === 'success';
                const isError = result?.status === 'error';

                const fileBatch = Math.floor(index / bulkBatchSize) + 1;
                const isInCurrentBatch = fileBatch === bulkCurrentBatch;
                const isWaiting = fileBatch > bulkCurrentBatch && !result;
                const isProcessing = isInCurrentBatch && !result;

                return (
                  <div
                    key={index}
                    className={`p-4 rounded-lg border-2 flex items-center gap-3 transition-all ${
                      isComplete ? 'bg-green-900/20 border-green-500/30' :
                      isError ? 'bg-red-900/20 border-red-500/30' :
                      isProcessing ? 'bg-blue-900/30 border-blue-500/40' :
                      isWaiting ? 'theme-bg-secondary-30 theme-border-input/40' :
                      'theme-bg-secondary-50 theme-border-input'
                    }`}
                  >
                    {/* Ãcone de status */}
                    <div className="flex-shrink-0">
                      {isComplete && <Check className="w-6 h-6 text-green-400" />}
                      {isError && <X className="w-6 h-6 text-red-400" />}
                      {isProcessing && (
                        <div className="w-6 h-6 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                      )}
                      {isWaiting && <Clock className="w-6 h-6 theme-text-disabled" />}
                    </div>

                    {/* Info do arquivo */}
                    <div className="flex-grow min-w-0">
                      <p className="text-sm theme-text-secondary truncate font-medium">{bulkFile.name}</p>
                      <p className="text-xs theme-text-muted mt-1">
                        {isComplete && `âœ… ${result.modelsCount} modelo${result.modelsCount !== 1 ? 's' : ''} gerado${result.modelsCount !== 1 ? 's' : ''} em ${result.duration}s`}
                        {isError && `âŒ Erro: ${result.error}`}
                        {isProcessing && `ğŸ”„ Processando agora... (Batch ${bulkCurrentBatch}/${Math.ceil(bulkFiles.length / bulkBatchSize)})`}
                        {isWaiting && `â³ Aguardando na fila (Batch ${fileBatch}/${Math.ceil(bulkFiles.length / bulkBatchSize)})`}
                      </p>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Resumo geral */}
            <div className="theme-bg-secondary-30 border theme-border-input rounded-lg p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium theme-text-tertiary">
                    ğŸ“Š Progresso: {processedFiles.length} de {bulkFiles.length} arquivos
                  </p>
                  {generatedModels.length > 0 && (
                    <p className="text-xs theme-text-muted mt-1">
                      âœ¨ {generatedModels.length} modelo{generatedModels.length !== 1 ? 's' : ''} gerado{generatedModels.length !== 1 ? 's' : ''} no total
                    </p>
                  )}
                </div>
                <div className="text-right">
                  <p className="text-2xl font-bold text-purple-400">
                    {Math.round((processedFiles.length / bulkFiles.length) * 100)}%
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* v1.5.15: BotÃ£o Cancelar processamento */}
          <div className="p-6 border-t theme-border-secondary">
            <button
              onClick={() => openModal('confirmBulkCancel')}
              className="w-full px-4 py-3 text-white rounded-lg flex items-center justify-center gap-2 font-medium bg-red-500 hover-red-600"
            >
              <X className="w-5 h-5" />
              Cancelar Processamento
            </button>
            <p className="text-center text-xs theme-text-disabled mt-3">
              ğŸ’¡ Processamento em lotes: {bulkBatchSize} arquivos por vez (evita rate limits)
            </p>
          </div>
        </div>
      </div>
    );
  }

  return null;
};

// ğŸ“‹ FASE 3.1: ModelFormFields - Campos do formulÃ¡rio de modelos
interface ModelFormFieldsProps {
  formData: { title: string; category: string; keywords: string; content: string };
  onChange: (field: string, value: string) => void;
  categories: string[];
  onGenerateKeywords: () => void;
  generatingKeywords?: boolean;
  onGenerateTitle: () => void;
  generatingTitle?: boolean;
}
const ModelFormFields = React.memo(({
  formData,
  onChange,
  categories,
  onGenerateKeywords,
  generatingKeywords,
  onGenerateTitle,
  generatingTitle
}: ModelFormFieldsProps) => {

  const handleFieldChange = React.useCallback((field: string, value: string) => {
    onChange(field, value);
  }, [onChange]); // ğŸš€ v1.8.3: Memoizado (GRUPO C)

  return (
    <div className="space-y-4">
      {/* Campo TÃ­tulo com botÃ£o de geraÃ§Ã£o IA */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium theme-text-tertiary">TÃ­tulo</label>
          <button
            onClick={onGenerateTitle}
            disabled={generatingTitle || !formData.content}
            className="flex items-center gap-1 px-3 py-1 text-xs text-white bg-purple-600 disabled:theme-bg-tertiary disabled:cursor-not-allowed rounded hover-purple-700-from-600 transition-colors"
            title="Gerar tÃ­tulo com IA baseado no conteÃºdo"
          >
            {generatingTitle ? (
              <>
                <svg className="animate-spin w-3 h-3" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Gerando...
              </>
            ) : (
              <>
                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Gerar com IA
              </>
            )}
          </button>
        </div>
        <input
          type="text"
          value={formData.title}
          onChange={(e) => handleFieldChange('title', e.target.value)}
          className="w-full theme-bg-primary border theme-border-input rounded-lg p-3 theme-text-primary focus:border-blue-500 focus:outline-none transition-colors"
          placeholder="Ex: HORAS EXTRAS - SOBREJORNADA - PROCEDENTE"
        />
      </div>

      {/* Campo Categoria com autocomplete */}
      <div>
        <label className={CSS.label}>Categoria</label>
        <input
          type="text"
          value={formData.category}
          onChange={(e) => handleFieldChange('category', e.target.value)}
          className="w-full theme-bg-primary border theme-border-input rounded-lg p-3 theme-text-primary focus:border-blue-500 focus:outline-none transition-colors"
          placeholder="Ex: Verbas RescisÃ³rias, Jornada de Trabalho, Preliminares"
          list="categories-list"
        />
        <datalist id="categories-list">
          {categories.map((cat: string, idx: number) => (
            <option key={idx} value={cat} />
          ))}
        </datalist>
      </div>

      {/* Campo Keywords com botÃ£o de geraÃ§Ã£o IA */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium theme-text-tertiary">Palavras-chave</label>
          <button
            onClick={onGenerateKeywords}
            disabled={generatingKeywords || (!formData.title && !formData.content)}
            className="flex items-center gap-1 px-3 py-1 text-xs text-white bg-purple-600 disabled:theme-bg-tertiary disabled:cursor-not-allowed rounded hover-purple-700-from-600 transition-colors"
            title="Gerar palavras-chave com IA"
          >
            {generatingKeywords ? (
              <>
                <svg className="animate-spin w-3 h-3" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Gerando...
              </>
            ) : (
              <>
                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Gerar com IA
              </>
            )}
          </button>
        </div>
        <input
          type="text"
          value={formData.keywords}
          onChange={(e) => handleFieldChange('keywords', e.target.value)}
          className="w-full theme-bg-primary border theme-border-input rounded-lg p-3 theme-text-primary focus:border-blue-500 focus:outline-none transition-colors"
          placeholder="horas extras, sobrejornada, adicional"
        />
      </div>
    </div>
  );
});

ModelFormFields.displayName = 'ModelFormFields';

// ModelRichEditor removido em v1.9.11 - use QuillModelEditor

// ModelFormModal - Container para ediÃ§Ã£o de modelos
// v1.35.10: Estado local bufferizado para evitar re-render do LegalDecisionEditor a cada keystroke
// v1.35.92: Tipagem correta com ModelFormModalProps
const ModelFormModal = React.forwardRef<HTMLDivElement, ModelFormModalProps>(({
  isOpen,
  editingModel,
  newModel,
  setNewModel,
  models,
  onSave,
  onCancel,
  onGenerateKeywords,
  generatingKeywords,
  onGenerateTitle,
  generatingTitle,
  onSaveWithoutClosing,
  onOpenAIAssistant,
  sanitizeHTML,
  modelEditorRef,
  quillReady = false,
  quillError = null,
  editorTheme,
  toggleEditorTheme,
  modelSaved = false,
  savingModel = false
}, containerRef) => {

  // v1.35.10: Estado LOCAL para campos do formulÃ¡rio
  // DigitaÃ§Ã£o atualiza apenas este componente (leve), nÃ£o o LegalDecisionEditor (pesado)
  const [localModel, setLocalModel] = React.useState<LocalModelForm>({ title: '', content: '', keywords: '', category: '' });

  // v1.35.10: Sincronizar estado local quando modal abre ou editingModel muda
  React.useEffect(() => {
    if (isOpen) {
      setLocalModel({
        title: newModel.title || '',
        content: newModel.content || '',
        keywords: Array.isArray(newModel.keywords) ? newModel.keywords.join(', ') : (newModel.keywords || ''),
        category: newModel.category || ''
      });
    }
  }, [isOpen, editingModel]); // Sincroniza quando abre ou troca de modelo

  // v1.35.3: Memoizar categorias para evitar recÃ¡lculo a cada keystroke
  const categories = React.useMemo(() => {
    return [...new Set(models.map((m: Model) => m.category).filter((c: string | undefined | null): c is string => !!c && c.trim() !== ''))].sort();
  }, [models]);

  // v1.35.10: Handler para mudanÃ§as nos campos - atualiza estado LOCAL
  const handleFieldChange = React.useCallback((field: string, value: string) => {
    setLocalModel((prev: LocalModelForm) => ({ ...prev, [field]: value }));
  }, []);

  // v1.35.10: Handler para mudanÃ§as no editor rico - atualiza estado LOCAL
  const handleContentChange = React.useCallback((html: string) => {
    setLocalModel(prev => ({ ...prev, content: html }));
  }, []);

  // v1.36.1: Passa localModel diretamente para evitar race condition
  const handleSave = React.useCallback(() => {
    // Sincroniza estado local com o pai
    setNewModel(localModel);
    // Passa dados diretamente para onSave (nÃ£o depende de state propagado)
    onSave(localModel);
  }, [localModel, setNewModel, onSave]);

  // v1.36.1: Passa localModel diretamente para evitar race condition
  const handleSaveWithoutClosing = React.useCallback(() => {
    setNewModel(localModel);
    // Passa dados diretamente para onSaveWithoutClosing
    onSaveWithoutClosing(localModel);
  }, [localModel, setNewModel, onSaveWithoutClosing]);

  // v1.35.5: Return condicional APÃ“S todos os hooks
  if (!isOpen) return null;

  return (
    <div ref={containerRef} className="theme-bg-secondary-30 p-6 rounded-lg border theme-border-input space-y-4">
      {/* Header dinÃ¢mico */}
      <h4 className="text-lg font-bold theme-text-primary">
        {editingModel ? 'Editar Modelo' : 'Novo Modelo'}
      </h4>

      {/* Campos simples (tÃ­tulo, categoria, keywords) - usam estado LOCAL */}
      <ModelFormFields
        formData={localModel}
        onChange={handleFieldChange}
        categories={categories}
        onGenerateKeywords={onGenerateKeywords}
        generatingKeywords={generatingKeywords}
        onGenerateTitle={onGenerateTitle}
        generatingTitle={generatingTitle}
      />

      {/* Editor rico de conteÃºdo - usa estado LOCAL */}
      <QuillModelEditor
        ref={modelEditorRef}
        content={localModel.content || ''}
        onChange={handleContentChange}
        onSaveWithoutClosing={handleSaveWithoutClosing}
        onOpenAIAssistant={onOpenAIAssistant}
        quillReady={quillReady}
        quillError={quillError}
        editorTheme={editorTheme}
        toggleEditorTheme={toggleEditorTheme}
      />

      {/* BotÃµes de aÃ§Ã£o */}
      <div className="flex gap-3 pt-4">
        <button
          onClick={onCancel}
          className="px-6 py-3 rounded-lg theme-bg-tertiary hover-slate-500"
        >
          Cancelar
        </button>
        <button
          onClick={handleSave}
          disabled={modelSaved || savingModel}
          style={{
            backgroundImage: (modelSaved || savingModel) ? 'none' : 'linear-gradient(to right, #2563eb, #9333ea)',
            backgroundColor: modelSaved ? '#16a34a' : (savingModel ? '#6b7280' : 'transparent'),
            transition: 'all 0.3s ease'
          }}
          className={`flex-1 px-6 py-3 rounded-lg font-medium text-white ${(modelSaved || savingModel) ? '' : 'hover-gradient-blue-purple'}`}
        >
          {modelSaved ? 'âœ“ AlteraÃ§Ãµes Salvas' : (savingModel ? 'Salvando...' : (editingModel ? 'Salvar AlteraÃ§Ãµes' : 'Salvar Modelo'))}
        </button>
      </div>
    </div>
  );
});

ModelFormModal.displayName = 'ModelFormModal';

// ğŸ‘ï¸ COMPONENTE: ModelPreviewModal - Preview de modelo
// v1.35.92: Tipagem correta com ModelPreviewModalProps
const ModelPreviewModal: React.FC<ModelPreviewModalProps> = ({
  isOpen,
  model,
  onInsert,
  onClose,
  sanitizeHTML,
  showToast,
  // Props para modo de ediÃ§Ã£o (Quick Edit)
  isEditing = false,
  editedContent = '',
  onStartEditing,
  onCancelEditing,
  onSaveEdit,
  onContentChange,
  quillReady = false,
  quillError = null,
  // Props para configuraÃ§Ãµes globais de editor
  fontSize = 'normal',
  spacing = 'normal',
  editorTheme = 'dark',
  // Prop para exclusÃ£o de modelo
  onDelete,
  // Prop para favoritar modelo
  onToggleFavorite,
  // v1.15.3: Prop para "Salvar como Novo Modelo"
  onOpenSaveAsNew,
}) => {
  // Hooks DEVEM vir antes de qualquer early return
  // Ref para o editor Quill em modo ediÃ§Ã£o
  const quickEditRef = React.useRef<QuillInstance | null>(null); // v1.35.92: Tipar como QuillInstance

  // ConteÃºdo Sanitizado (Memoizado para Performance)
  const sanitizedContent = React.useMemo(
    () => model ? sanitizeHTML(model.content || '<p class="theme-text-muted">ConteÃºdo nÃ£o disponÃ­vel</p>') : '',
    [model?.content, sanitizeHTML]
  );

  // Handler de InserÃ§Ã£o (Insere + Fecha)
  const handleInsert = React.useCallback(() => {
    if (model) {
      onInsert(model.content);
      onClose();
    }
  }, [model?.content, onInsert, onClose]);

  // Handler de Copiar (Copia para Clipboard)
  const handleCopy = React.useCallback(() => {
    if (!model) return;
    // v1.25.18: Usar helper ao invÃ©s de DOM (memory leak fix)
    const plainText = extractPlainText(model.content);

    navigator.clipboard.writeText(plainText)
      .then(() => {
        showToast?.('âœ… Modelo copiado para Ã¡rea de transferÃªncia', 'success');
      })
      .catch(err => {
        showToast?.('âŒ Erro ao copiar modelo', 'error');
      });
  }, [model?.content, showToast]);

  // v1.35.61: Handler para Voice-to-Text no modo Quick Edit
  const handleVoiceTranscript = React.useCallback((text: string) => {
    const quill = quickEditRef.current;
    if (quill) {
      requestAnimationFrame(() => {
        const range = quill.getSelection() || { index: quill.getLength() - 1 };
        quill.insertText(range.index, text + ' ');
        quill.setSelection(range.index + text.length + 1);
      });
    }
  }, []);

  // v1.35.67: ESC handler
  React.useEffect(() => {
    if (!isOpen) return;
    const handleEsc = (e: KeyboardEvent) => { if (e.key === 'Escape') onClose(); };
    window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  // v1.35.67: Scroll lock
  React.useEffect(() => {
    if (isOpen) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => { document.body.style.overflow = originalOverflow; };
    }
  }, [isOpen]);

  // Early Return se Modal Fechado
  if (!isOpen) {
    return null;
  }

  // Error State se Modelo InvÃ¡lido
  if (!model) {
    return (
      <div className={CSS.modalOverlay} onClick={onClose}>
        <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal p-6`} onClick={e => e.stopPropagation()}>
          <p className="text-red-400 mb-4 flex items-center gap-2">
            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
            </svg>
            Erro: Modelo nÃ£o encontrado
          </p>
          <button
            onClick={onClose}
            className="w-full px-4 py-3 rounded-lg font-medium text-white theme-bg-tertiary hover-slate-500"
          >
            Fechar
          </button>
        </div>
      </div>
    );
  }

  return (
    <div
      className={CSS.modalOverlay}
      role="dialog"
      aria-modal="true"
      aria-labelledby="preview-modal-title"
      onClick={onClose}
    >

      {/* â”€â”€â”€ Modal Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */}
      <div
        className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal flex flex-col`}
        style={{
          width: '90%',
          maxWidth: '1000px',
          height: '85vh',
          maxHeight: '85vh',
          contain: 'content'
        }}
        onClick={e => e.stopPropagation()}
      >

        {/* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */}
        <div className="p-4 sm:p-6 border-b theme-border-input flex-shrink-0">
          <div className="flex items-start justify-between">
            <div className="flex-1 pr-4">
              <div className="flex items-center gap-2 mb-2">
                <h3 id="preview-modal-title" className="text-xl font-bold theme-text-primary">
                  {model.title}
                </h3>
                {onToggleFavorite && (
                  <button
                    onClick={() => onToggleFavorite(model.id)}
                    className="text-xl hover:scale-110 transition-transform"
                    title={model.favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}
                  >
                    {model.favorite ? 'â­' : 'â˜†'}
                  </button>
                )}
              </div>

              {/* Metadata: Categoria + Keywords */}
              <div className="flex items-center gap-3 flex-wrap">
                {model.category && (
                  <span className="px-2 py-1 theme-bg-purple-accent theme-text-purple rounded text-sm border border-purple-500/30">
                    {model.category}
                  </span>
                )}
                {model.keywords && (
                  <span className="theme-text-muted text-sm flex items-center gap-1">
                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clipRule="evenodd" />
                    </svg>
                    {model.keywords}
                  </span>
                )}
              </div>
            </div>

            {/* BotÃ£o Fechar (X) - v1.35.68: padronizado */}
            <button
              onClick={onClose}
              className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
              aria-label="Fechar modal"
              title="Fechar"
            >
              <X className="w-5 h-5 theme-text-tertiary" />
            </button>
          </div>
        </div>

        {/* â”€â”€â”€ Body: ConteÃºdo ScrollÃ¡vel ou Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */}
        <div
          className="flex-1 p-4 sm:p-6 overflow-y-auto"
          style={{
            minHeight: 0,
            overflowY: 'auto',
            transition: 'none'
          }}
        >
          {isEditing ? (
            // Modo EdiÃ§Ã£o: Quill Editor com altura mÃ¡xima para nÃ£o ativar scroll externo
            <div className="space-y-2">
              {/* v1.35.61: VoiceButton para Quick Edit */}
              <div className="flex justify-end">
                <VoiceButton
                  onTranscript={handleVoiceTranscript}
                  size="md"
                  idleText="Ditar"
                  onError={(err: unknown) => console.warn('[VoiceToText]', err)}
                />
              </div>
              <div
                className={`quick-edit-wrapper fontsize-${fontSize} spacing-${spacing} ${editorTheme === 'light' ? 'quill-light-theme bg-white' : 'theme-bg-primary'} border theme-border-input rounded-lg`}
                style={{
                  maxHeight: 'calc(55vh + 4px)',
                  overflow: 'hidden'
                }}
              >
                <QuillEditorBase
                  ref={quickEditRef}
                  content={editedContent}
                  onChange={(html: string) => onContentChange?.(html)}
                  toolbarConfig={getQuillToolbarConfig('simple')}
                  placeholder="Edite o conteÃºdo do modelo..."
                  className="flex-1"
                  quillReady={quillReady}
                  quillError={quillError}
                />
              </div>
            </div>
          ) : (
            // Modo VisualizaÃ§Ã£o: HTML renderizado
            <div
              className={`model-preview-content ${editorTheme === 'light' ? 'light-theme-content' : ''}`}
              dangerouslySetInnerHTML={{ __html: sanitizedContent }}
            />
          )}
        </div>

        {/* â”€â”€â”€ Footer: BotÃµes de AÃ§Ã£o (condicionais por modo) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */}
        <div className="p-4 sm:p-6 border-t theme-border-input flex gap-3 justify-end flex-shrink-0">
          {isEditing ? (
            // BotÃµes modo ediÃ§Ã£o
            <>
              <button
                onClick={onCancelEditing}
                className="px-4 py-3 rounded-lg font-medium text-white theme-bg-tertiary hover-slate-500"
              >
                Cancelar
              </button>
              <button
                onClick={() => onSaveEdit?.(quickEditRef)}
                className="hover-green-500 px-4 py-2 text-white rounded-lg font-semibold flex items-center gap-2 bg-green-600"
              >
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                </svg>
                Atualizar Modelo
              </button>
              {onOpenSaveAsNew && (
                <button
                  onClick={() => {
                    const content = quickEditRef.current?.root?.innerHTML || editedContent;
                    onOpenSaveAsNew(content, model);
                  }}
                  className="hover-purple-700 px-4 py-2 text-white rounded-lg font-semibold flex items-center gap-2 bg-purple-600"
                >
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" />
                  </svg>
                  Salvar como Novo
                </button>
              )}
            </>
          ) : (
            // BotÃµes modo visualizaÃ§Ã£o
            <>
              <button
                onClick={onClose}
                className="px-4 py-3 rounded-lg font-medium text-white theme-bg-tertiary hover-slate-500"
              >
                Fechar
              </button>
              <button
                onClick={handleCopy}
                className="hover-green-700 px-4 py-2 text-white rounded-lg font-semibold flex items-center gap-2 bg-green-600"
              >
                <Copy className="w-4 h-4" />
                Copiar
              </button>
              <button
                onClick={onStartEditing}
                className="hover-yellow-alpha px-4 py-2 rounded-lg font-semibold flex items-center gap-2 border border-yellow-500 text-yellow-400"
              >
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                </svg>
                Editar
              </button>
              <button
                onClick={handleInsert}
                className="hover-blue-700 px-4 py-2 text-white rounded-lg font-semibold flex items-center gap-2 bg-blue-600"
              >
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clipRule="evenodd" />
                </svg>
                Inserir no Editor
              </button>
              {onDelete && model && (
                <button
                  onClick={() => { onDelete(model); onClose(); }}
                  className="hover-red-700-from-600 px-4 py-2 text-white rounded-lg font-semibold flex items-center gap-2 bg-red-600"
                >
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" />
                  </svg>
                  Excluir
                </button>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
};

// ğŸ“ SLASH COMMAND MENU (v1.33.8) - Acesso rÃ¡pido a modelos com /
// v1.33.8: Viewport-aware positioning, tooltip preview, toggle busca semÃ¢ntica
const SlashCommandMenu: React.FC<SlashCommandMenuProps> = ({
  isOpen,
  position,
  models,
  searchTerm,
  selectedIndex,
  onSelect,
  onClose,
  onSearchChange,
  onNavigate,
  semanticAvailable,      // v1.33.8: indica se busca semÃ¢ntica estÃ¡ disponÃ­vel
  searchModelsBySimilarity // v1.33.8: funÃ§Ã£o para busca semÃ¢ntica
}) => {
  const inputRef = React.useRef<HTMLInputElement | null>(null);
  const listRef = React.useRef<HTMLDivElement | null>(null);
  const menuRef = React.useRef<HTMLDivElement | null>(null);

  // v1.33.8: Estado para toggle busca semÃ¢ntica
  const [useSemanticSearch, setUseSemanticSearch] = React.useState(false);
  const [semanticResults, setSemanticResults] = React.useState<Model[] | null>(null);
  const [isSearching, setIsSearching] = React.useState(false);

  // v1.33.8: Ajustar posiÃ§Ã£o para ficar dentro da viewport
  const adjustedPosition = React.useMemo(() => {
    const menuHeight = 360; // altura aproximada do menu
    const menuWidth = 320;
    const viewportHeight = typeof window !== 'undefined' ? window.innerHeight : 800;
    const viewportWidth = typeof window !== 'undefined' ? window.innerWidth : 1200;

    let top = position.top;
    let left = position.left;

    // Se vai sair pela parte inferior, posicionar acima
    if (top + menuHeight > viewportHeight - 20) {
      top = Math.max(20, viewportHeight - menuHeight - 20);
    }

    // Se vai sair pela direita, ajustar
    if (left + menuWidth > viewportWidth - 20) {
      left = Math.max(20, viewportWidth - menuWidth - 20);
    }

    return { top, left };
  }, [position]);

  // v1.33.8: Busca semÃ¢ntica com debounce
  React.useEffect(() => {
    if (!useSemanticSearch || !searchModelsBySimilarity || !searchTerm || searchTerm.trim().length < 2) {
      setSemanticResults(null);
      return;
    }

    const timeoutId = setTimeout(async () => {
      setIsSearching(true);
      try {
        const results = await searchModelsBySimilarity(models, searchTerm.toLowerCase(), { threshold: 0.3, limit: 10 });
        // Resultados jÃ¡ sÃ£o modelos com similarity, apenas converter para array de Model
        setSemanticResults(results as Model[]);
      } catch (error) {
        console.error('[SlashCommand] Erro na busca semÃ¢ntica:', error);
        setSemanticResults(null);
      }
      setIsSearching(false);
    }, 300);

    return () => clearTimeout(timeoutId);
  }, [searchTerm, useSemanticSearch, models, searchModelsBySimilarity]);

  // Filtrar modelos pelo termo de busca (textual)
  const filteredModels = React.useMemo(() => {
    // Se busca semÃ¢ntica estÃ¡ ativa e tem resultados, usar eles
    if (useSemanticSearch && semanticResults) {
      return semanticResults;
    }
    if (!models || models.length === 0) return [];
    const term = (searchTerm || '').toLowerCase().trim();
    if (!term) return models.slice(0, 10);
    return models.filter((m: Model) =>
      m.title.toLowerCase().includes(term) ||
      (m.keywords && (Array.isArray(m.keywords) ? m.keywords.join(' ') : m.keywords).toLowerCase().includes(term))
    ).slice(0, 10);
  }, [models, searchTerm, useSemanticSearch, semanticResults]);

  // Auto-focus no input quando abre
  React.useEffect(() => {
    if (isOpen && inputRef.current) {
      const timeoutId = setTimeout(() => inputRef.current?.focus(), 50);
      return () => clearTimeout(timeoutId);
    }
  }, [isOpen]);

  // Scroll para item selecionado
  React.useEffect(() => {
    if (listRef.current && filteredModels.length > 0) {
      const selectedEl = listRef.current.children[selectedIndex];
      if (selectedEl) {
        selectedEl.scrollIntoView({ block: 'nearest' });
      }
    }
  }, [selectedIndex, filteredModels.length]);

  // Handler de teclado
  const handleKeyDown = React.useCallback((e: React.KeyboardEvent) => {
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        onNavigate?.('down', filteredModels.length);
        break;
      case 'ArrowUp':
        e.preventDefault();
        onNavigate?.('up', filteredModels.length);
        break;
      case 'Enter':
        e.preventDefault();
        if (filteredModels[selectedIndex]) {
          onSelect?.(filteredModels[selectedIndex]);
        }
        break;
      case 'Escape':
        e.preventDefault();
        onClose?.();
        break;
      case 'Tab':
        e.preventDefault();
        onClose?.();
        break;
    }
  }, [filteredModels, selectedIndex, onSelect, onClose, onNavigate]);

  if (!isOpen) return null;

  // v1.33.8: Helper para extrair texto puro do HTML (para tooltip)
  // v1.33.10: Mostrar modelo completo no tooltip
  const getPreviewText = (content: string) => {
    if (!content) return 'Sem conteÃºdo';
    return content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
  };

  return (
    <div
      ref={menuRef}
      className="slash-command-menu fixed z-[100] theme-bg-secondary border theme-border-input rounded-lg shadow-xl w-80"
      style={{ top: adjustedPosition.top, left: adjustedPosition.left, maxHeight: '360px' }}
    >
      <div className="p-2 border-b theme-border-input flex items-center gap-2">
        <input
          ref={inputRef}
          type="text"
          value={searchTerm}
          onChange={(e) => onSearchChange?.(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder={useSemanticSearch ? "Busca semÃ¢ntica..." : "Buscar modelo..."}
          className="flex-1 px-2 py-1.5 theme-bg-primary theme-text-primary border theme-border-input rounded text-sm focus:outline-none focus:ring-1 focus:ring-purple-500"
        />
        {/* v1.33.8: Toggle busca semÃ¢ntica */}
        {semanticAvailable && (
          <button
            onClick={() => {
              setUseSemanticSearch((prev: boolean) => !prev);
              setSemanticResults(null);
            }}
            className={`p-1.5 rounded text-sm transition-colors ${
              useSemanticSearch
                ? 'bg-purple-600 text-white hover:bg-purple-700'
                : 'theme-bg-tertiary theme-text-secondary hover-slate-600'
            }`}
            title={useSemanticSearch ? 'Busca semÃ¢ntica (por significado)' : 'Busca textual (por palavras)'}
          >
            {useSemanticSearch ? 'ğŸ§ ' : 'ğŸ”¤'}
          </button>
        )}
        <button
          onClick={onClose}
          className="p-1 rounded hover-slate-600 theme-text-muted"
          title="Fechar (Esc)"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div ref={listRef} className="overflow-y-auto" style={{ maxHeight: '280px' }}>
        {isSearching ? (
          <div className="px-3 py-4 text-sm theme-text-muted text-center">
            <span className="animate-pulse">Buscando...</span>
          </div>
        ) : filteredModels.length === 0 ? (
          <div className="px-3 py-4 text-sm theme-text-muted text-center">
            Nenhum modelo encontrado
          </div>
        ) : (
          filteredModels.map((model: Model, idx: number) => (
            <div
              key={model.id}
              onClick={() => onSelect?.(model)}
              className={`px-3 py-2 cursor-pointer border-l-2 ${
                idx === selectedIndex
                  ? 'bg-purple-600/30 border-purple-500'
                  : 'border-transparent hover-slate-700'
              }`}
              title={getPreviewText(model.content)}
            >
              <div className="flex items-center gap-2">
                <div className="text-sm font-medium theme-text-primary truncate flex-1">{model.title}</div>
                {/* v1.33.8: Badge de similaridade (busca semÃ¢ntica) */}
                {/* v1.33.9: Fix contraste tema claro */}
                {model.similarity !== undefined && (
                  <span className={`text-[10px] px-1.5 py-0.5 rounded font-medium ${
                    model.similarity >= 0.7 ? 'bg-green-500/20 text-green-700 dark:text-green-400' :
                    model.similarity >= 0.5 ? 'bg-yellow-500/20 text-yellow-700 dark:text-yellow-400' :
                    'bg-gray-500/20 text-gray-700 dark:text-gray-400'
                  }`}>
                    {Math.round(model.similarity * 100)}%
                  </span>
                )}
              </div>
              <div className="text-xs theme-text-muted truncate">{model.category}</div>
            </div>
          ))
        )}
      </div>
      <div className="px-3 py-1.5 border-t theme-border-input text-xs theme-text-muted flex items-center gap-2">
        <span>â†‘â†“</span> navegar
        <span className="mx-1">Â·</span>
        <span>Enter</span> inserir
        <span className="mx-1">Â·</span>
        <span>Esc</span> fechar
        {useSemanticSearch && <span className="ml-auto text-purple-400">ğŸ§ </span>}
      </div>
    </div>
  );
};

// ğŸ“ FIELD EDITOR (v1.12.0) - Editor Quill sem toolbar
// v1.15.3: Adicionado suporte a slash command (/)
// v1.20.4: forwardRef para expor API de formataÃ§Ã£o
// v1.35.93: Tipagem correta com FieldEditorProps e FieldEditorRef
const FieldEditor = React.memo(React.forwardRef<FieldEditorRef, FieldEditorProps>(({
  label,
  content,
  onChange,
  onFocus,
  onBlur,
  onSlashCommand,
  fieldType = 'text', // 'relatorio' | 'fundamentacao' | 'dispositivo'
  quillReady,
  quillError,
  minHeight = '120px',
  editorTheme = 'dark',
  hideVoiceButton = false // v1.35.65: Esconder VoiceButton quando gerenciado externamente
}, ref) => {
  const editorRef = React.useRef<HTMLDivElement | null>(null);
  const quillInstanceRef = React.useRef<QuillInstance | null>(null);

  // v1.20.4: Expor mÃ©todos de formataÃ§Ã£o para componente pai (toolbar inline)
  React.useImperativeHandle(ref, () => ({
    format: (name: string, value: unknown) => quillInstanceRef.current?.format(name, value),
    getFormat: () => quillInstanceRef.current?.getFormat() || {},
    focus: () => quillInstanceRef.current?.focus()
  }), []);
  const isInitializedRef = React.useRef<boolean>(false);
  const lastContentRef = React.useRef<string>('');
  const onSlashCommandRef = React.useRef(onSlashCommand);
  const onChangeDebounceRef = React.useRef<ReturnType<typeof setTimeout> | null>(null); // v1.35.3: Debounce para onChange
  // v1.25.18: Refs para cleanup de blur listener (memory leak fix)
  const blurHandlerRef = React.useRef<(() => void) | null>(null);
  const blurTimeoutRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);

  // Manter ref atualizada
  React.useEffect(() => {
    onSlashCommandRef.current = onSlashCommand;
  }, [onSlashCommand]);

  // InicializaÃ§Ã£o do Quill (sem toolbar)
  React.useEffect(() => {
    if (!quillReady || !window.Quill || isInitializedRef.current || !editorRef.current) return;

    try {
      quillInstanceRef.current = new window.Quill(editorRef.current, {
        theme: 'snow',
        modules: {
          toolbar: false,  // SEM TOOLBAR - formataÃ§Ã£o via shortcuts
          keyboard: {
            bindings: {}  // Shortcuts padrÃ£o: Ctrl+B, Ctrl+I, Ctrl+U
          }
        },
        placeholder: `Digite o ${label.toLowerCase()} aqui...`
      });

      // Setar conteÃºdo inicial
      if (content) {
        quillInstanceRef.current.root.innerHTML = content;
        lastContentRef.current = content;
      }

      // Event listener - mudanÃ§as de texto
      // v1.35.3: Debounce para evitar lag durante digitaÃ§Ã£o rÃ¡pida
      quillInstanceRef.current.on('text-change', ((delta: unknown, _oldDelta: unknown, source: string) => {
        // v1.15.3: Detectar "\" digitado pelo usuÃ¡rio para slash command (SEM debounce)
        if (source === 'user' && onSlashCommandRef.current) {
          const ops = (delta as QuillDelta).ops || [];
          const lastOp = ops[ops.length - 1];
          if (typeof lastOp?.insert === 'string' && lastOp.insert.endsWith('\\')) {
            const quill = quillInstanceRef.current;
            if (!quill) return;
            const range = quill.getSelection();
            if (range) {
              const bounds = quill.getBounds(range.index);
              const editorRect = editorRef.current?.getBoundingClientRect();
              if (editorRect) {
                onSlashCommandRef.current({
                  position: {
                    top: editorRect.top + bounds.top + bounds.height + 5,
                    left: editorRect.left + bounds.left
                  },
                  quillInstance: quill,
                  triggerPosition: range.index - 1
                });
              }
            }
          }
        }

        // v1.35.3: Debounce onChange (150ms) - evita re-renders excessivos
        if (onChangeDebounceRef.current) {
          clearTimeout(onChangeDebounceRef.current);
        }
        onChangeDebounceRef.current = setTimeout(() => {
          const html = quillInstanceRef.current?.root?.innerHTML;
          if (!html) return;
          if (html !== lastContentRef.current) {
            lastContentRef.current = html;
            onChange?.(html);
          }
        }, 150);
      }) as (...args: unknown[]) => void);

      // Event listener - foco (para sugestÃµes contextuais)
      if (onFocus) {
        quillInstanceRef.current.root.addEventListener('focus', onFocus);
      }

      // v1.24: Event listener - blur (para versionamento)
      // v1.25.18: Usar handler nomeado para permitir cleanup (memory leak fix)
      if (onBlur) {
        blurHandlerRef.current = () => {
          if (blurTimeoutRef.current) clearTimeout(blurTimeoutRef.current);
          blurTimeoutRef.current = setTimeout(() => {
            const html = quillInstanceRef.current?.root?.innerHTML || '';
            if (html && html !== '<p><br></p>') onBlur(html);
          }, 0);
        };
        quillInstanceRef.current.root.addEventListener('blur', blurHandlerRef.current);
      }

      isInitializedRef.current = true;
    } catch (error) {
    }
  }, [quillReady]);

  React.useEffect(() => {
    if (!quillInstanceRef.current || !isInitializedRef.current) return;

    // SÃ³ atualizar se o conteÃºdo mudou externamente (nÃ£o pelo prÃ³prio Quill)
    if (content !== lastContentRef.current) {
      quillInstanceRef.current.root.innerHTML = content || '';
      lastContentRef.current = content || '';
    }
  }, [content]);

  // Cleanup
  React.useEffect(() => {
    return () => {
      // v1.25.18: Limpar timeout pendente (memory leak fix)
      if (blurTimeoutRef.current) {
        clearTimeout(blurTimeoutRef.current);
        blurTimeoutRef.current = null;
      }
      if (quillInstanceRef.current) {
        quillInstanceRef.current.off('text-change');
        if (onFocus) {
          quillInstanceRef.current.root?.removeEventListener('focus', onFocus);
        }
        // v1.25.18: Remover blur listener (memory leak fix)
        if (blurHandlerRef.current) {
          quillInstanceRef.current.root?.removeEventListener('blur', blurHandlerRef.current);
        }
        quillInstanceRef.current = null;
      }
      if (editorRef.current) {
        editorRef.current.innerHTML = '';
      }
      isInitializedRef.current = false;
    };
  }, []);

  // v1.35.62: Handler para Voice-to-Text - insere texto na posiÃ§Ã£o do cursor
  const handleVoiceTranscript = React.useCallback((text: string) => {
    const quill = quillInstanceRef.current;
    if (quill) {
      requestAnimationFrame(() => {
        const range = quill.getSelection() || { index: quill.getLength() - 1 };
        quill.insertText(range.index, text + ' ');
        quill.setSelection(range.index + text.length + 1);
      });
    }
  }, []);

  // RenderizaÃ§Ã£o
  if (!quillReady) {
    return (
      <div className="field-editor">
        <label className="block text-xs font-semibold theme-text-muted mb-1">{label}</label>
        <div className="theme-bg-primary border theme-border-input rounded p-3 text-sm theme-text-muted">
          â³ Carregando editor...
        </div>
      </div>
    );
  }

  if (quillError) {
    return (
      <div className="field-editor">
        <label className="block text-xs font-semibold theme-text-muted mb-1">{label}</label>
        <div className="bg-red-900/20 border border-red-600 rounded p-3 text-sm text-red-400">
          âŒ {quillError instanceof Error ? quillError.message : quillError}
        </div>
      </div>
    );
  }

  return (
    <div className="field-editor">
      {/* v1.35.62: Label + VoiceButton | v1.35.65: hideVoiceButton para gerenciamento externo */}
      <div className="flex items-center justify-between mb-1">
        <label className="block text-xs font-semibold theme-text-muted">{label}</label>
        {!hideVoiceButton && (
          <VoiceButton
            onTranscript={handleVoiceTranscript}
            size="sm"
            onError={(err: unknown) => console.warn('[VoiceToText]', err)}
          />
        )}
      </div>
      <div
        ref={editorRef}
        className={`${editorTheme === 'light' ? 'quill-light-theme bg-white' : 'theme-bg-primary'} border theme-border-input rounded field-editor-content`}
        style={{
          minHeight,
          overflow: 'hidden'
        }}
      />
    </div>
  );
}));

FieldEditor.displayName = 'FieldEditor';

// ğŸ“ LINKED PROOFS MODAL (v1.12.14)
const LinkedProofsModal: React.FC<LinkedProofsModalProps> = ({
  isOpen,
  onClose,
  topicTitle,
  linkedProofs,
  proofManager
}) => {
  if (!isOpen || !linkedProofs) return null;

  return (
    <div className="absolute inset-0 bg-black/80 flex items-start justify-center z-[80] py-8 px-4 overflow-y-auto">
      <div className="theme-bg-primary rounded-lg shadow-2xl border border-green-700 max-w-4xl w-full">
        {/* Header */}
        <div className="p-4 border-b border-green-500/30 flex items-center justify-between flex-shrink-0">
          <div className="flex items-center gap-3">
            <Scale className="w-6 h-6 text-green-400" />
            <div>
              <h3 className="text-lg font-bold text-green-400">Provas Vinculadas</h3>
              <p className="text-sm theme-text-muted">{topicTitle}</p>
            </div>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover-slate-700 rounded-lg transition-colors"
          >
            <X className="w-5 h-5 theme-text-secondary" />
          </button>
        </div>

        {/* Lista de Provas */}
        <div className="p-4 space-y-3 max-h-[75vh] overflow-y-auto">
          {linkedProofs.length === 0 ? (
            <div className="text-center py-8 theme-text-muted">
              <Scale className="w-12 h-12 mx-auto mb-3 opacity-50" />
              <p>Nenhuma prova vinculada a este tÃ³pico</p>
            </div>
          ) : (
            linkedProofs.map((proof: Proof) => (
              <div
                key={proof.id}
                className="theme-bg-secondary-50 rounded-lg p-3 border theme-border-input"
              >
                <div className="flex items-center gap-2 mb-2">
                  <FileText className="w-4 h-4 text-blue-400 flex-shrink-0" />
                  <h5 className="font-medium theme-text-secondary text-sm flex-1 truncate">{proof.name}</h5>
                  <span className={`px-2 py-0.5 text-xs rounded ${
                    proof.isPdf
                      ? 'theme-bg-red-accent theme-text-red'
                      : 'theme-bg-blue-accent theme-text-blue'
                  }`}>
                    {proof.isPdf ? 'PDF' : 'TEXTO'}
                  </span>
                </div>

                {/* AnÃ¡lise IA */}
                {proofManager?.proofAnalysisResults?.[proof.id] && (
                  <div className="mb-2 p-2 theme-bg-blue-accent border border-blue-500/30 rounded text-xs">
                    <div className="flex items-center gap-1 mb-1">
                      <Sparkles className="w-3 h-3 theme-text-blue" />
                      <span className="font-medium theme-text-blue">
                        {proofManager.proofAnalysisResults[proof.id].type === 'livre' ? 'AnÃ¡lise Livre' : 'AnÃ¡lise Contextual'}
                      </span>
                    </div>
                    <div className="overflow-y-auto" style={{ resize: 'vertical', height: '8rem', minHeight: '8rem' }}>
                      <p className="theme-text-tertiary whitespace-pre-wrap">
                        {proofManager.proofAnalysisResults[proof.id].result}
                      </p>
                    </div>
                  </div>
                )}

                {/* ConclusÃµes Manuais */}
                {proofManager?.proofConclusions?.[proof.id] && (
                  <div className="p-2 theme-bg-green-accent border border-green-500/30 rounded text-xs">
                    <div className="flex items-center gap-1 mb-1">
                      <Edit className="w-3 h-3 theme-text-green" />
                      <span className="font-medium theme-text-green">Minhas ConclusÃµes</span>
                    </div>
                    <div className="overflow-y-auto" style={{ resize: 'vertical', height: '6rem', minHeight: '6rem' }}>
                      <p className="theme-text-tertiary whitespace-pre-wrap">
                        {proofManager.proofConclusions[proof.id]}
                      </p>
                    </div>
                  </div>
                )}
              </div>
            ))
          )}
        </div>

        {/* Footer */}
        <div className="p-4 border-t theme-border-secondary flex-shrink-0">
          <button
            onClick={onClose}
            className="w-full py-2 theme-bg-tertiary hover-slate-600 rounded-lg text-sm font-medium theme-text-secondary"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  );
};

// âš–ï¸ v1.20.0: Modal de JurisprudÃªncia ReutilizÃ¡vel
const JURIS_TIPOS_DISPONIVEIS = ['IRR', 'IAC', 'IRDR', 'SÃºmula', 'OJ', 'RG', 'ADI/ADC/ADPF', 'Informativo'];
const JURIS_TRIBUNAIS_DISPONIVEIS = ['TST', 'STF', 'STJ', 'TRT8'];

// v1.32.18: Adicionado useLocalAI e jurisSemanticThreshold para busca semÃ¢ntica
// v1.33.16: Adicionado jurisSemanticEnabled para toggle interno + badge IA Local
const JurisprudenciaModal = React.memo(({ isOpen, onClose, topicTitle, topicRelatorio, callAI, useLocalAI = false, jurisSemanticThreshold = 50, jurisSemanticEnabled = false }: JurisprudenciaModalProps) => {
  const [suggestions, setSuggestions] = React.useState<JurisSuggestion[]>([]);
  const [loading, setLoading] = React.useState(false);
  const [copiedId, setCopiedId] = React.useState<string | null>(null);
  const [filtros, setFiltros] = React.useState<FiltrosLegislacao>({ tipo: [], tribunal: [] });
  const [searchTerm, setSearchTerm] = React.useState('');
  const [searchApplied, setSearchApplied] = React.useState('');
  const [searchSource, setSearchSource] = React.useState<string | null>(null); // 'local' ou 'text'
  const [useSemanticMode, setUseSemanticMode] = React.useState(useLocalAI); // v1.33.16: estado interno para toggle

  // v1.32.18: Busca semÃ¢ntica via IA Local
  const doSemanticSearch = React.useCallback(async (queryText: string) => {
    try {
      const threshold = jurisSemanticThreshold / 100;
      // v1.32.20: toLowerCase para E5 case-sensitive
      const queryEmbedding = await AIModelService.getEmbedding(queryText.toLowerCase(), 'query');
      // v1.32.21: Passar filtros para aplicar ANTES do limit (retorna atÃ© 30 do tipo desejado)
      const results = await JurisEmbeddingsService.searchBySimilarity(queryEmbedding, threshold, 30, filtros);

      return results;
    } catch (err) {
      console.warn('[JurisModal] Erro na busca semÃ¢ntica:', err);
      return [];
    }
  }, [jurisSemanticThreshold, filtros]);

  const doSearch = React.useCallback(async (term = '') => {
    setLoading(true);
    setSuggestions([]);
    setSearchApplied(term);
    try {
      // v1.33.16: Usar busca semÃ¢ntica se toggle ativo E IA Local habilitada
      if (useSemanticMode && jurisSemanticEnabled) {
        // v1.32.19: Usar apenas tÃ­tulo para query mais focada (relatÃ³rio longo dilui relevÃ¢ncia)
        const queryText = term || topicTitle || '';
        const results = await doSemanticSearch(queryText);
        setSuggestions(results);
        setSearchSource('local');
      } else if (callAI) {
        const results = await findJurisprudenciaHelper(topicTitle || '', topicRelatorio || '', callAI, { ...filtros, searchTerm: term });
        setSuggestions(results);
        setSearchSource('text');
      }
    } catch { setSuggestions([]); }
    setLoading(false);
  }, [topicTitle, topicRelatorio, callAI, filtros, useSemanticMode, jurisSemanticEnabled, doSemanticSearch]);

  // v1.33.16: Re-busca quando toggle muda
  React.useEffect(() => {
    if (isOpen && topicTitle) {
      doSearch(searchApplied);
    }
  }, [isOpen, topicTitle, filtros, useSemanticMode]);

  // v1.33.17: Sincronizar useSemanticMode com useLocalAI quando modal abre
  React.useEffect(() => {
    if (isOpen) {
      setUseSemanticMode(useLocalAI);
    }
  }, [isOpen, useLocalAI]);

  React.useEffect(() => {
    if (!isOpen) {
      setFiltros({ tipo: [], tribunal: [] });
      setSearchTerm('');
      setSearchApplied('');
    }
  }, [isOpen]);

  // v1.35.64: ESC handler
  React.useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
    };
    if (isOpen) {
      window.addEventListener('keydown', handleEsc);
    }
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  // v1.35.64: Bloquear scroll do body quando modal aberto
  React.useEffect(() => {
    if (isOpen) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => {
        document.body.style.overflow = originalOverflow;
      };
    }
  }, [isOpen]);

  if (!isOpen) return null;

  const handleCopy = async (p: JurisSuggestion) => {
    const tipo = isIRRType(p.tipoProcesso) ? 'IRR' : (p.tipoProcesso || '');
    const identificador = p.tema ? `Tema ${p.tema}` : (p.numero ? `nÂº ${p.numero}` : '');
    const partes: string[] = [];
    partes.push(`${tipo}${identificador ? ` ${identificador}` : ''}${p.tribunal ? ` - ${p.tribunal}` : ''}${p.orgao ? ` - ${p.orgao}` : ''}`);
    if (p.titulo) partes.push(`TÃ­tulo: ${p.titulo}`);
    // v1.36.53: Adiciona fallback para fullText/text (embeddings semÃ¢nticos)
    const conteudo = p.tese || p.enunciado || p.fullText || p.text || '';
    if (conteudo) partes.push('');
    partes.push(conteudo);
    await navigator.clipboard.writeText(partes.join('\n'));
    setCopiedId(p.id);
    setTimeout(() => setCopiedId(null), 2000);
  };

  return (
    <div className={`${CSS.modalOverlay} overflow-auto`} onClick={onClose}>
      <div className={`${CSS.modalContainer} flex flex-col my-auto`} style={{ width: '80vw', maxHeight: '90vh' }} onClick={(e) => e.stopPropagation()}>
        <div className="p-4 border-b theme-border flex justify-between items-center flex-shrink-0">
          <h3 className="font-semibold theme-text-primary flex items-center gap-2">
            <Scale className="w-4 h-4" />
            JurisprudÃªncia: {topicTitle}
            {searchSource === 'local' && (
              <span className="bg-purple-600 text-white px-1.5 py-0.5 rounded text-[10px]">ğŸ¤– IA Local</span>
            )}
          </h3>
          <button onClick={onClose} className="p-1 rounded hover-bg-tertiary">
            <X className="w-5 h-5 theme-text-secondary" />
          </button>
        </div>
        <div className="px-4 py-2 border-b theme-border flex flex-wrap gap-2 items-center flex-shrink-0">
          <span className="text-xs theme-text-muted mr-1">Filtros:</span>
          <div className="flex gap-1 flex-wrap">
            {JURIS_TIPOS_DISPONIVEIS.map(tipo => (
              <button
                key={tipo}
                onClick={() => setFiltros(prev => ({
                  ...prev,
                  tipo: prev.tipo.includes(tipo) ? prev.tipo.filter((t: string) => t !== tipo) : [...prev.tipo, tipo]
                }))}
                className={`px-2 py-0.5 rounded-full text-xs transition-colors ${filtros.tipo.includes(tipo) ? 'bg-purple-600 text-white' : 'theme-bg-tertiary theme-text-tertiary hover-slate-600'}`}
              >
                {tipo}
              </button>
            ))}
          </div>
          <div className="w-px h-4 theme-bg-tertiary mx-1" />
          <div className="flex gap-1 flex-wrap">
            {JURIS_TRIBUNAIS_DISPONIVEIS.map(trib => (
              <button
                key={trib}
                onClick={() => setFiltros(prev => ({
                  ...prev,
                  tribunal: prev.tribunal.includes(trib) ? prev.tribunal.filter((t: string) => t !== trib) : [...prev.tribunal, trib]
                }))}
                className={`px-2 py-0.5 rounded-full text-xs transition-colors ${filtros.tribunal.includes(trib) ? 'bg-blue-600 text-white' : 'theme-bg-tertiary theme-text-tertiary hover-slate-600'}`}
              >
                {trib}
              </button>
            ))}
          </div>
          <div className="w-px h-4 theme-bg-tertiary mx-1" />
          <div className="flex items-center gap-2 flex-1 min-w-[200px]">
            <div className="flex-1 relative">
              <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400" />
              <input
                type="text"
                placeholder="Buscar por termo, tese..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && doSearch(searchTerm.trim())}
                className="w-full pl-8 pr-2 py-1 border rounded text-xs theme-input"
              />
            </div>
            <button
              onClick={() => doSearch(searchTerm.trim())}
              disabled={loading}
              className="px-2.5 py-1 bg-blue-600 text-white rounded text-xs hover-blue-700-from-600 disabled:opacity-50 flex items-center gap-1"
            >
              <Search className="w-3 h-3" />
              Buscar
            </button>
            {searchApplied && (
              <button
                onClick={() => { setSearchTerm(''); doSearch(''); }}
                className="px-2 py-1 theme-bg-tertiary theme-text-secondary rounded text-xs hover-slate-600"
                title="Limpar busca"
              >
                <X className="w-3 h-3" />
              </button>
            )}
            {/* v1.33.16: Toggle semÃ¢ntico/textual */}
            {jurisSemanticEnabled && (
              <button
                onClick={() => setUseSemanticMode((prev: boolean) => !prev)}
                className={`px-2 py-1 rounded text-xs transition-colors ${
                  useSemanticMode
                    ? 'bg-purple-600 text-white hover:bg-purple-700'
                    : 'theme-bg-tertiary theme-text-secondary hover-slate-600'
                }`}
                title={useSemanticMode ? 'Busca semÃ¢ntica (por significado)' : 'Busca textual (por palavras)'}
              >
                {useSemanticMode ? 'ğŸ§ ' : 'ğŸ”¤'}
              </button>
            )}
          </div>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-3">
          {loading ? (
            <div className="text-center py-8">
              <Loader2 className="w-6 h-6 animate-spin mx-auto mb-2 text-purple-500" />
              <p className="text-sm theme-text-muted">Buscando precedentes relevantes...</p>
            </div>
          ) : suggestions.length === 0 ? (
            <div className="text-center py-8">
              <Scale className="w-8 h-8 mx-auto mb-2 theme-text-muted opacity-50" />
              <p className="theme-text-muted">Nenhum precedente encontrado{searchApplied ? ` para "${searchApplied}"` : ' para este tÃ³pico'}</p>
              <p className="text-xs theme-text-muted mt-1">{searchApplied ? 'Tente outros termos ou remova filtros' : 'Importe JSONs de jurisprudÃªncia na aba correspondente'}</p>
            </div>
          ) : (
            suggestions.map(p => (
              <div key={p.id} className="theme-bg-secondary p-3 rounded-lg border theme-border-secondary">
                <div className="flex flex-wrap justify-between items-start gap-2 mb-2">
                  <span className="text-xs px-2 py-0.5 rounded theme-bg-tertiary theme-text-tertiary">
                    {isIRRType(p.tipoProcesso) ? 'IRR' : p.tipoProcesso} {p.numero || p.tema}
                  </span>
                  <div className="flex gap-1 flex-wrap">
                    {p.status && (
                      <span className={`text-xs px-2 py-0.5 rounded ${isStatusValido(p.status) ? 'theme-badge-success' : 'theme-badge-error'}`}>
                        {isStatusValido(p.status) ? 'âœ“' : 'âœ—'} {p.status.replace(/_/g, ' ')}
                      </span>
                    )}
                    {p.orgao && <span className="text-xs px-2 py-0.5 rounded theme-badge-purple">{p.orgao}</span>}
                    {p.tribunal && <span className="text-xs px-2 py-0.5 rounded theme-badge-blue">{p.tribunal}</span>}
                    {/* v1.33.18: Badge de similaridade no modo semÃ¢ntico */}
                    {searchSource === 'local' && p.similarity && (
                      <span className="text-xs px-2 py-0.5 rounded bg-green-600 text-white">
                        {Math.round(p.similarity * 100)}%
                      </span>
                    )}
                  </div>
                </div>
                {p.titulo && <p className="text-xs font-medium theme-text-primary mb-1">{p.titulo}</p>}
                <p className="text-sm theme-text-secondary mb-3 line-clamp-4">{p.tese || p.enunciado || p.fullText || p.text}</p>
                <button
                  onClick={() => handleCopy(p)}
                  className={`text-xs px-3 py-1.5 text-white rounded flex items-center gap-1 ${copiedId === p.id ? 'bg-green-600' : 'bg-purple-600 hover-purple-700'}`}
                >
                  {copiedId === p.id ? <Check className="w-3 h-3" /> : <Copy className="w-3 h-3" />}
                  {copiedId === p.id ? 'Copiado!' : 'Copiar'}
                </button>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
});
JurisprudenciaModal.displayName = 'JurisprudenciaModal';

// ğŸ“ INLINE FORMATTING TOOLBAR (v1.20.4) - Toolbar de formataÃ§Ã£o para FieldEditor
interface InlineFormattingToolbarProps {
  editorRef: React.RefObject<FieldEditorRef | null>;
}
const InlineFormattingToolbar = React.memo(({ editorRef }: InlineFormattingToolbarProps) => {
  const [activeFormats, setActiveFormats] = React.useState<ActiveFormatsState>({});

  const updateFormats = React.useCallback(() => {
    if (editorRef?.current) {
      setActiveFormats(editorRef.current.getFormat() as ActiveFormatsState);
    }
  }, [editorRef]);

  const toggleFormat = React.useCallback((format: string, value: string | boolean = true) => {
    if (!editorRef?.current) return;
    const current = editorRef.current.getFormat();
    const currentValue = current[format];
    if (format === 'list' || format === 'align') {
      editorRef.current.format(format, currentValue === value ? false : value);
    } else {
      editorRef.current.format(format, currentValue ? false : value);
    }
    updateFormats();
    editorRef.current.focus();
  }, [editorRef, updateFormats]);

  const setHeader = React.useCallback((level: number | false) => {
    if (!editorRef?.current) return;
    editorRef.current.format('header', level || false);
    updateFormats();
    editorRef.current.focus();
  }, [editorRef, updateFormats]);

  // v1.33.21: Limpar formataÃ§Ã£o usando format(key, false) - wrapper nÃ£o tem getSelection/removeFormat
  const removeFormatting = React.useCallback(() => {
    if (!editorRef?.current) return;
    const quill = editorRef.current;
    const formats = quill.getFormat();
    // Remover cada formato ativo usando format(name, false)
    ['bold', 'italic', 'underline', 'strike', 'color', 'background', 'header', 'list', 'align', 'indent', 'link'].forEach(key => {
      if (formats[key]) quill.format(key, false);
    });
    updateFormats();
    quill.focus();
  }, [editorRef, updateFormats]);

  const btnClass = (isActive: boolean) =>
    `px-1.5 py-0.5 text-xs rounded transition-colors ${isActive
      ? 'bg-blue-600 text-white'
      : 'theme-bg-secondary theme-text-secondary'}`;

  return (
    <div className="flex items-center gap-1 flex-wrap" onClick={(e) => e.stopPropagation()}>
      <select
        className="text-xs px-1 py-0.5 theme-bg-secondary theme-border-input border rounded theme-text-primary"
        onChange={(e) => setHeader(e.target.value ? parseInt(e.target.value) : false)}
        value={typeof activeFormats.header === 'number' ? activeFormats.header : ''}
        onFocus={updateFormats}
      >
        <option value="">Â¶</option>
        <option value="1">H1</option>
        <option value="2">H2</option>
        <option value="3">H3</option>
      </select>
      <span className="text-gray-500 text-xs">|</span>
      <button onClick={() => toggleFormat('bold')} className={btnClass(!!activeFormats.bold)} title="Negrito (Ctrl+B)"><strong>N</strong></button>
      <button onClick={() => toggleFormat('italic')} className={btnClass(!!activeFormats.italic)} title="ItÃ¡lico (Ctrl+I)"><em>I</em></button>
      <button onClick={() => toggleFormat('underline')} className={btnClass(!!activeFormats.underline)} title="Sublinhado (Ctrl+U)"><u>S</u></button>
      <span className="text-gray-500 text-xs">|</span>
      <button onClick={() => toggleFormat('list', 'ordered')} className={btnClass(activeFormats.list === 'ordered')} title="Lista numerada">1.</button>
      <button onClick={() => toggleFormat('list', 'bullet')} className={btnClass(activeFormats.list === 'bullet')} title="Lista com marcadores">â€¢</button>
      <span className="text-gray-500 text-xs">|</span>
      <button onClick={() => toggleFormat('align', false)} className={btnClass(!activeFormats.align)} title="Alinhar Ã  esquerda">â«·</button>
      <button onClick={() => toggleFormat('align', 'center')} className={btnClass(activeFormats.align === 'center')} title="Centralizar">â‰¡</button>
      <button onClick={() => toggleFormat('align', 'right')} className={btnClass(activeFormats.align === 'right')} title="Alinhar Ã  direita">â«¸</button>
      <button onClick={() => toggleFormat('align', 'justify')} className={btnClass(activeFormats.align === 'justify')} title="Justificar">â˜°</button>
      <span className="text-gray-500 text-xs">|</span>
      <button onClick={() => removeFormatting()} className="px-1.5 py-0.5 text-xs rounded transition-colors theme-bg-secondary theme-text-secondary hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400" title="Limpar formataÃ§Ã£o">âœ–</button>
    </div>
  );
});
InlineFormattingToolbar.displayName = 'InlineFormattingToolbar';

// ğŸ“ GLOBAL EDITOR SECTION (v1.12.0)
// v1.35.94: Tipagem correta com GlobalEditorSectionProps
const GlobalEditorSection: React.FC<GlobalEditorSectionProps> = ({
  topic,
  topicIndex,
  onFieldChange,
  onFieldFocus,
  onSlashCommand,
  quillReady,
  quillError,
  editorTheme = 'dark',
  onOpenAIAssistant = null,
  onOpenProofsModal = null,
  onOpenJurisModal = null,
  onOpenFactsComparison = null,  // v1.36.12
  linkedProofsCount = 0,
  isCollapsed = false,
  onToggleCollapse = null,
  versioning = null
}) => {
  const titleUpper = topic.title.toUpperCase();
  const isRelatorio = titleUpper === 'RELATÃ“RIO';
  const isDispositivo = titleUpper === 'DISPOSITIVO';

  // v1.20.4: Ref para toolbar inline no campo DecisÃ£o
  const fundamentacaoEditorRef = React.useRef<FieldEditorRef | null>(null);

  return (
    <div className="global-editor-section mb-6 border theme-border-secondary rounded-lg overflow-hidden">
      {/* Header fixo do tÃ³pico - CLICÃVEL PARA COLAPSAR */}
      <div
        className="px-4 py-3 theme-bg-tertiary border-b theme-border-secondary flex items-center gap-3 cursor-pointer select-none"
        onClick={() => onToggleCollapse?.(topicIndex)}
      >
        <ChevronDown className={`w-4 h-4 theme-text-secondary transition-transform duration-200 ${isCollapsed ? '-rotate-90' : ''}`} />
        <span className="font-bold theme-text-primary text-lg">{topic.title}</span>
        {!isRelatorio && !isDispositivo && topic.category && (
          <span className="px-2 py-0.5 text-xs rounded theme-bg-purple-accent theme-text-purple border border-purple-500/30">
            {topic.category}
          </span>
        )}
        {/* v1.12.14: BotÃ£o Provas Vinculadas - apenas se houver provas */}
        {!isRelatorio && !isDispositivo && linkedProofsCount > 0 && onOpenProofsModal && (
          <button
            onClick={(e) => { e.stopPropagation(); onOpenProofsModal(topicIndex); }}
            className="ml-auto hover-green-700 px-2 py-1 text-white text-xs rounded flex items-center gap-1 bg-green-600"
            title="Ver Provas Vinculadas"
          >
            <Scale className="w-3 h-3" />
            Provas ({linkedProofsCount})
          </button>
        )}
      </div>

      {/* Editores dos campos - COLAPSÃVEL */}
      {!isCollapsed && (
        <div className="p-4 space-y-4 theme-bg-secondary">
          {isRelatorio ? (
            // RELATÃ“RIO: apenas editedRelatorio
            <FieldEditor
              label="RelatÃ³rio"
              fieldType="relatorio"
              content={topic.editedRelatorio || topic.relatorio || ''}
              onChange={(html: string) => onFieldChange(topicIndex, 'editedRelatorio', html)}
              onFocus={() => onFieldFocus?.(topicIndex, 'relatorio', null)}
              onSlashCommand={onSlashCommand}
              quillReady={quillReady}
              quillError={quillError}
              minHeight="200px"
              editorTheme={editorTheme}
            />
          ) : isDispositivo ? (
            // DISPOSITIVO: apenas editedContent
            <FieldEditor
              label="Dispositivo"
              fieldType="dispositivo"
              content={topic.editedContent || ''}
              onChange={(html: string) => onFieldChange(topicIndex, 'editedContent', html)}
              onFocus={() => onFieldFocus?.(topicIndex, 'dispositivo', null)}
              onSlashCommand={onSlashCommand}
              quillReady={quillReady}
              quillError={quillError}
              minHeight="200px"
              editorTheme={editorTheme}
            />
          ) : (
            // TÃ³pico normal: mini-relatÃ³rio + decisÃ£o
            <>
              <FieldEditor
                label="Mini-RelatÃ³rio"
                fieldType="relatorio"
                content={topic.editedRelatorio || topic.relatorio || ''}
                onChange={(html: string) => onFieldChange(topicIndex, 'editedRelatorio', html)}
                onFocus={() => onFieldFocus?.(topicIndex, 'relatorio', null)}
                onSlashCommand={onSlashCommand}
                quillReady={quillReady}
                quillError={quillError}
                minHeight="100px"
                editorTheme={editorTheme}
              />
              {/* v1.20.4: Wrapper com toolbar + botÃµes JurisprudÃªncia/AI na linha do label */}
              <div>
                <div className="flex items-center justify-between mb-1 gap-2">
                  <div className="flex items-center gap-0">
                    <span className="text-xs font-medium theme-text-secondary uppercase tracking-wide flex-shrink-0">DecisÃ£o</span>
                    {/* v1.20.4: Toolbar de formataÃ§Ã£o inline - prÃ³xima ao label */}
                    <div className="ml-8">
                      <InlineFormattingToolbar editorRef={fundamentacaoEditorRef} />
                    </div>
                  </div>
                  <div className="flex items-center gap-2 flex-wrap justify-end">
                    {versioning && (
                      <VersionSelect
                        topicTitle={topic.title}
                        versioning={versioning}
                        currentContent={topic.editedFundamentacao || topic.fundamentacao || ''}
                        onRestore={(content: string) => onFieldChange(topicIndex, 'editedFundamentacao', content)}
                      />
                    )}
                    {onOpenJurisModal && (
                      <button
                        onClick={() => onOpenJurisModal(topicIndex)}
                        className="hover-blue-700 px-2 py-1 text-white text-xs rounded flex items-center gap-1 bg-blue-600"
                        title="Buscar JurisprudÃªncia"
                      >
                        <Scale className="w-3 h-3" />
                        JurisprudÃªncia
                      </button>
                    )}
                    {onOpenAIAssistant && (
                      <button
                        onClick={() => onOpenAIAssistant(topicIndex)}
                        className="hover-purple-700 px-2 py-1 text-white text-xs rounded flex items-center gap-1 bg-purple-600"
                        title="Assistente de RedaÃ§Ã£o IA"
                      >
                        <Sparkles className="w-3 h-3" />
                        Assistente IA
                      </button>
                    )}
                    {/* v1.36.12: BotÃ£o Confronto de Fatos */}
                    {onOpenFactsComparison && (
                      <button
                        onClick={() => onOpenFactsComparison(topicIndex)}
                        className="hover:bg-amber-700 px-2 py-1 text-white text-xs rounded flex items-center gap-1 bg-amber-600"
                        title="Confronto de Fatos (Inicial vs ContestaÃ§Ã£o)"
                      >
                        <Scale className="w-3 h-3" />
                        Confronto
                      </button>
                    )}
                    {/* v1.35.65: VoiceButton ao lado do Assistente IA */}
                    <VoiceButton
                      onTranscript={(text: string) => {
                        // Inserir texto no editor de fundamentaÃ§Ã£o via ref
                        if (fundamentacaoEditorRef.current) {
                          const current = topic.editedFundamentacao || topic.fundamentacao || '';
                          onFieldChange(topicIndex, 'editedFundamentacao', current + (current ? ' ' : '') + text);
                        }
                      }}
                      size="sm"
                      onError={(err: unknown) => console.warn('[VoiceToText]', err)}
                    />
                  </div>
                </div>
                <FieldEditor
                  ref={fundamentacaoEditorRef}
                  label=""
                  fieldType="fundamentacao"
                  content={topic.editedFundamentacao || topic.fundamentacao || ''}
                  onChange={(html: string) => onFieldChange(topicIndex, 'editedFundamentacao', html)}
                  onFocus={() => onFieldFocus?.(topicIndex, 'fundamentacao', topic)}
                  onBlur={(html: string) => versioning?.saveVersion(topic.title, html)}
                  onSlashCommand={onSlashCommand}
                  quillReady={quillReady}
                  quillError={quillError}
                  minHeight="150px"
                  editorTheme={editorTheme}
                  hideVoiceButton={true}
                />
              </div>
            </>
          )}
        </div>
      )}
    </div>
  );
};

// ğŸ“ GLOBAL EDITOR MODAL (v1.12.0) - EdiÃ§Ã£o global da sentenÃ§a
// v1.15.3: Adicionado suporte a slash command (/)
// v1.35.95: Tipagem correta com GlobalEditorModalProps
const GlobalEditorModal: React.FC<GlobalEditorModalProps> = ({
  isOpen,
  onClose,
  selectedTopics,
  setSelectedTopics,
  setExtractedTopics,
  models,
  findSuggestions,
  sanitizeHTML,
  showToast,
  fontSize = 'normal',
  spacing = 'normal',
  setFontSize = null,
  setSpacing = null,
  editorTheme = 'dark',
  quillReady = false,
  quillError = null,
  modelPreview = null,
  analyzedDocuments = {},
  proofManager = null,
  aiIntegration = null,
  detectResultadoAutomatico = null,
  onSlashCommand = null,
  fileToBase64 = null,
  openModal = null, // v1.21.6: Para abrir modal de anonimizaÃ§Ã£o
  closeModal = null, // v1.21.6: Para fechar modal de anonimizaÃ§Ã£o
  useLocalAIForSuggestions = false, // v1.28.08: Para exibir overlay IA Local
  // v1.32.18: Props para busca semÃ¢ntica de jurisprudÃªncia
  useLocalAIForJuris = false,
  jurisSemanticThreshold = 50,
  searchModelReady = false,
  jurisEmbeddingsCount = 0,
  // v1.33.19: FunÃ§Ã£o para busca semÃ¢ntica de modelos
  searchModelsBySimilarity = null,
  // v1.33.20: Config de busca semÃ¢ntica de modelos (para inicializar toggle)
  modelSemanticEnabled = false
}) => {
  // Estado local para os tÃ³picos (cÃ³pia para ediÃ§Ã£o)
  const [localTopics, setLocalTopics] = React.useState<Topic[]>([]);
  const [isDirty, setIsDirty] = React.useState(false);
  const [originalTopics, setOriginalTopics] = React.useState<Topic[]>([]);

  // Estados para sugestÃµes de modelos - v1.12.2: inicia true para sugestÃµes funcionarem na primeira abertura
  const [isSplitMode, setIsSplitMode] = React.useState(true);
  const [splitPosition, setSplitPosition] = React.useState(80); // v1.13: 80/20 por padrÃ£o
  const [currentFocusedTopic, setCurrentFocusedTopic] = React.useState<{ title: string; category: TopicCategory; relatorio: string; index: number } | null>(null);
  const isSavingRef = React.useRef(false); // Indica quando salvando para evitar reset de sugestÃµes
  const wasOpenRef = React.useRef(false); // Track se modal jÃ¡ estava aberto (evita reset no Ctrl+S)
  const [suggestions, setSuggestions] = React.useState<Model[]>([]);
  const [suggestionsSource, setSuggestionsSource] = React.useState<string | null>(null); // v1.28.06
  const [loadingSuggestions, setLoadingSuggestions] = React.useState(false);

  // Estados para busca manual de modelos - v1.12.12
  const [globalManualSearchTerm, setGlobalManualSearchTerm] = React.useState('');
  const [globalManualSearchResults, setGlobalManualSearchResults] = React.useState<Model[]>([]);

  // v1.33.19: Estados para busca semÃ¢ntica na busca manual do editor global
  // v1.33.20: Inicializa com modelSemanticEnabled (respeitando config IA)
  const [useGlobalSemanticSearch, setUseGlobalSemanticSearch] = React.useState(modelSemanticEnabled);
  const [globalSemanticSearching, setGlobalSemanticSearching] = React.useState(false);

  // Estados para modais de confirmaÃ§Ã£o
  const [showCancelConfirm, setShowCancelConfirm] = React.useState(false);

  // Estado para seÃ§Ãµes colapsadas - iniciar todas colapsadas
  const [collapsedSections, setCollapsedSections] = React.useState<Record<string, boolean>>({});

  // Estados para detecÃ§Ã£o automÃ¡tica de resultado ao salvar - v1.13
  const [editedTopicTitles, setEditedTopicTitles] = React.useState(new Set());
  const [isAnalyzingResults, setIsAnalyzingResults] = React.useState(false);
  const [analyzingProgress, setAnalyzingProgress] = React.useState<ProgressState>({ current: 0, total: 0 });

  // Estados para modal de provas vinculadas - v1.12.14
  const [showProofsModal, setShowProofsModal] = React.useState(false);
  const [proofsModalTopicIndex, setProofsModalTopicIndex] = React.useState<number | null>(null);

  const [showAIAssistant, setShowAIAssistant] = React.useState(false);
  const [aiAssistantTopicIndex, setAiAssistantTopicIndex] = React.useState<number | null>(null);
  const [globalAiInstruction, setGlobalAiInstruction] = React.useState('');
  const [globalAiGeneratedText, setGlobalAiGeneratedText] = React.useState('');
  const [generatingGlobalAi, setGeneratingGlobalAi] = React.useState(false);
  const [globalContextScope, setGlobalContextScope] = React.useState('current'); // 'current' | 'all'

  // ğŸ¤– v1.19.0: Chat interativo do assistente IA (Global)
  const chatAssistantGlobal = useChatAssistant(aiIntegration);

  // ğŸ“œ v1.24: Versionamento de campos
  const fieldVersioning = useFieldVersioning();

  // âš–ï¸ v1.20.0: JurisprudÃªncia contextual (usa componente JurisprudenciaModal)
  const [showJurisModal, setShowJurisModal] = React.useState(false);
  const [jurisTopicIndex, setJurisTopicIndex] = React.useState<number | null>(null);

  // âš–ï¸ v1.36.12: Confronto de Fatos (Inicial vs ContestaÃ§Ã£o)
  const [showFactsComparison, setShowFactsComparison] = React.useState(false);
  const [factsComparisonTopicIndex, setFactsComparisonTopicIndex] = React.useState<number | null>(null);
  const [factsComparisonResult, setFactsComparisonResult] = React.useState<FactsComparisonResult | null>(null);
  const [generatingFactsComparison, setGeneratingFactsComparison] = React.useState(false);
  const [factsComparisonError, setFactsComparisonError] = React.useState<string | null>(null);
  const factsComparisonCache = useFactsComparisonCache();

  // Ref para o container (drag do divisor)
  const containerRef = React.useRef<HTMLDivElement | null>(null);
  const [isDragging, setIsDragging] = React.useState(false);

  const prevIsSplitModeRef = React.useRef<boolean>(isSplitMode);
  const isSplitModeRef = React.useRef<boolean>(isSplitMode);
  // v1.13.8: Ref para auto-save debounced no Editor Global
  const globalAutoSaveTimerRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);

  React.useEffect(() => {
    isSplitModeRef.current = isSplitMode;
  }, [isSplitMode]);

  // v1.19.2: Registrar listener para sincronizar sugestÃµes quando modelo Ã© editado
  React.useEffect(() => {
    if (modelPreview && isOpen) {
      modelPreview.onModelUpdatedRef.current = (updatedModel: Model) => {
        setSuggestions(prev => prev.map(s => s.id === updatedModel.id ? updatedModel : s));
        setGlobalManualSearchResults(prev => prev.map(s => s.id === updatedModel.id ? updatedModel : s));
      };
    }
    return () => {
      if (modelPreview) {
        modelPreview.onModelUpdatedRef.current = null;
      }
    };
  }, [modelPreview, isOpen]);

  // FunÃ§Ã£o de busca manual debounced - v1.12.13: Usa helper reutilizÃ¡vel
  const debouncedGlobalManualSearch = React.useMemo(() => {
    let timeoutId: ReturnType<typeof setTimeout> | null = null;
    return (term: string) => {
      if (timeoutId) clearTimeout(timeoutId);
      if (!term.trim()) {
        setGlobalManualSearchResults([]);
        return;
      }
      timeoutId = setTimeout(() => {
        const results = searchModelsInLibrary(models || [], term);
        setGlobalManualSearchResults(results);
      }, 300);
    };
  }, [models]);

  // v1.33.19: useEffect para busca semÃ¢ntica na busca manual do editor global
  React.useEffect(() => {
    if (!useGlobalSemanticSearch || !searchModelReady || !searchModelsBySimilarity || !globalManualSearchTerm || globalManualSearchTerm.trim().length < 2) {
      return;
    }

    const timeoutId = setTimeout(async () => {
      setGlobalSemanticSearching(true);
      try {
        const results = await searchModelsBySimilarity(models || [], globalManualSearchTerm.toLowerCase(), { threshold: 0.3, limit: 10 });
        // Resultados jÃ¡ sÃ£o modelos com similarity, apenas converter para array de Model
        setGlobalManualSearchResults(results as Model[]);
      } catch (error) {
        console.error('[GlobalEditor] Erro na busca semÃ¢ntica:', error);
      }
      setGlobalSemanticSearching(false);
    }, 300);

    return () => clearTimeout(timeoutId);
  }, [useGlobalSemanticSearch, globalManualSearchTerm, searchModelReady, searchModelsBySimilarity, models]);

  // Inicializar localTopics quando abrir
  React.useEffect(() => {
    // SÃ³ inicializar quando ABRIR (transiÃ§Ã£o false -> true)
    // Isso evita reset quando Ctrl+S atualiza selectedTopics
    const isOpening = isOpen && !wasOpenRef.current;

    if (isOpening && selectedTopics.length > 0) {
      const copy = structuredClone(selectedTopics);
      setLocalTopics(copy);
      setOriginalTopics(structuredClone(copy));
      setIsDirty(false);
      setCurrentFocusedTopic(null);
      setSuggestions([]);
      setIsSplitMode(true);
      // v1.13: Limpar rastreamento de ediÃ§Ãµes ao abrir
      setEditedTopicTitles(new Set());
      // Iniciar todas seÃ§Ãµes colapsadas
      const initialCollapsed: Record<number, boolean> = {};
      copy.forEach((_: Topic, idx: number) => { initialCollapsed[idx] = true; });
      setCollapsedSections(initialCollapsed);

      // v1.36.45: Resetar estados dos sub-modais ao abrir (evita bug de ESC)
      setShowAIAssistant(false);
      setAiAssistantTopicIndex(null);
      setShowJurisModal(false);
      setJurisTopicIndex(null);
      setShowFactsComparison(false);
      setFactsComparisonTopicIndex(null);
      setFactsComparisonResult(null);
      setFactsComparisonError(null);
    }

    wasOpenRef.current = isOpen;
  }, [isOpen, selectedTopics]);

  // Handler para mudanÃ§a de campo
  const handleFieldChange = React.useCallback((topicIndex: number, field: string, html: string) => {
    setLocalTopics(prev => {
      const updated = [...prev];
      const topicTitle = updated[topicIndex]?.title;
      updated[topicIndex] = {
        ...updated[topicIndex],
        [field]: html
      };
      // Se for editedRelatorio, tambÃ©m atualizar relatorio
      if (field === 'editedRelatorio') {
        updated[topicIndex].relatorio = html;
      }
      // v1.13: Rastrear ediÃ§Ãµes no campo decisao para detecÃ§Ã£o automÃ¡tica de resultado
      if (field === 'editedFundamentacao' && topicTitle) {
        setEditedTopicTitles(prevSet => new Set(prevSet).add(topicTitle));
      }
      return updated;
    });
    setIsDirty(true);
  }, []);

  // Handler para foco em campo (sugestÃµes contextuais) - v1.12.2: usa ref para evitar closure stale
  const handleFieldFocus = React.useCallback(async (topicIndex: number, fieldType: string, topic: Topic | null) => {
    if (fieldType === 'fundamentacao' && topic) {
      // Campo de fundamentaÃ§Ã£o/decisÃ£o focado â†’ buscar sugestÃµes automaticamente
      const topicInfo = {
        index: topicIndex,
        title: topic.title,
        category: topic.category,
        relatorio: topic.editedRelatorio || topic.relatorio || ''
      };
      setCurrentFocusedTopic(topicInfo);

      // Buscar sugestÃµes automaticamente (apenas se em split mode) - usa ref para valor atual
      if (isSplitModeRef.current && findSuggestions) {
        setLoadingSuggestions(true);
        try {
          await new Promise(r => setTimeout(r, 0)); // v1.28.06: Yield para UI
          const results = await findSuggestions({
            title: topicInfo.title,
            category: topicInfo.category,
            relatorio: topicInfo.relatorio
          });
          // v1.28.06: Suporta novo formato { suggestions, source }
          if (results && 'suggestions' in results) {
            setSuggestions(results.suggestions);
            setSuggestionsSource(results.source ?? null);
          } else {
            setSuggestions(results || []);
            setSuggestionsSource(null);
          }
        } catch (error) {
          setSuggestionsSource(null);
        } finally {
          setLoadingSuggestions(false);
        }
      }
    } else {
      // Outro campo focado â†’ limpar contexto de sugestÃµes
      setCurrentFocusedTopic(null);
      setSuggestions([]);
    }
  }, [findSuggestions]); // Removido isSplitMode das deps - agora usa ref

  React.useEffect(() => {
    // Detectar transiÃ§Ã£o de false â†’ true
    const wasOff = !prevIsSplitModeRef.current;
    const isNowOn = isSplitMode;
    prevIsSplitModeRef.current = isSplitMode;

    // SÃ³ buscar quando split mode ACABOU de ser ativado (nÃ£o em cada render)
    if (wasOff && isNowOn && currentFocusedTopic && findSuggestions) {
      const fetchSuggestions = async () => {
        setLoadingSuggestions(true);
        try {
          await new Promise(r => setTimeout(r, 0)); // v1.28.06: Yield para UI
          const results = await findSuggestions({
            title: currentFocusedTopic.title,
            category: currentFocusedTopic.category,
            relatorio: currentFocusedTopic.relatorio
          });
          // v1.28.06: Suporta novo formato { suggestions, source }
          if (results && 'suggestions' in results) {
            setSuggestions(results.suggestions);
            setSuggestionsSource(results.source ?? null);
          } else {
            setSuggestions(results || []);
            setSuggestionsSource(null);
          }
        } catch (error) {
          setSuggestionsSource(null);
        } finally {
          setLoadingSuggestions(false);
        }
      };

      fetchSuggestions();
    }
  }, [isSplitMode, currentFocusedTopic, findSuggestions]); // Agora com todas as dependÃªncias

  // Inserir modelo no campo de fundamentaÃ§Ã£o do tÃ³pico focado
  const handleInsertModel = React.useCallback((modelContent: string) => {
    if (currentFocusedTopic?.index === undefined) return;

    const topicIndex = currentFocusedTopic.index;
    setLocalTopics(prev => {
      const updated = [...prev];
      const currentContent = updated[topicIndex].editedFundamentacao ||
                            updated[topicIndex].fundamentacao || '';

      // Adicionar ao final do conteÃºdo existente
      updated[topicIndex].editedFundamentacao = currentContent +
        (currentContent ? '<p><br></p>' : '') + modelContent;

      return updated;
    });

    setIsDirty(true);
    showToast?.('Modelo inserido', 'success');
  }, [currentFocusedTopic, showToast]);

  // v1.33.23: Ref para handleInsertModel (evita loop infinito no useEffect abaixo)
  const handleInsertModelRef = React.useRef(handleInsertModel);
  React.useEffect(() => {
    handleInsertModelRef.current = handleInsertModel;
  }, [handleInsertModel]);

  const handlePreviewModel = React.useCallback((model: Model) => {
    if (modelPreview?.openPreview) {
      modelPreview.openPreview(model);
    }
  }, [modelPreview]);

  // v1.15.2: Registrar funÃ§Ã£o de inserÃ§Ã£o contextual quando modal abre
  // v1.33.23: Usa ref para evitar loop (handleInsertModel muda frequentemente)
  React.useEffect(() => {
    if (isOpen && modelPreview?.setContextualInsertFn) {
      // Wrapper com identidade estÃ¡vel que chama a ref
      modelPreview.setContextualInsertFn((content: string) => handleInsertModelRef.current(content));
    }
    return () => {
      if (modelPreview?.setContextualInsertFn) {
        modelPreview.setContextualInsertFn(null);
      }
    };
  }, [isOpen, modelPreview]); // Removido handleInsertModel das dependÃªncias

  // Salvar alteraÃ§Ãµes (sem fechar) - usa isSavingRef para preservar sugestÃµes
  const handleSaveOnly = React.useCallback(() => {
    // Marcar que estamos salvando (para useEffect ignorar reset)
    isSavingRef.current = true;

    // Sincronizar estados externos
    setSelectedTopics(localTopics);
    setExtractedTopics((prev: Topic[]) =>
      prev.map((et: Topic) => {
        const updated = localTopics.find((lt: Topic) => lt.title === et.title);
        return updated ? { ...et, ...updated } : et;
      })
    );

    setIsDirty(false);
    showToast?.('AlteraÃ§Ãµes salvas!', 'success');
  }, [localTopics, setSelectedTopics, setExtractedTopics, showToast]);

  // v1.13.8: Auto-save com debounce no Editor Global
  React.useEffect(() => {
    // SÃ³ rodar se modal estÃ¡ aberto e hÃ¡ mudanÃ§as
    if (!isOpen || !isDirty) return;

    // Limpar timer anterior
    if (globalAutoSaveTimerRef.current) {
      clearTimeout(globalAutoSaveTimerRef.current);
    }

    // Debounce: aguardar 3s antes de salvar automaticamente
    globalAutoSaveTimerRef.current = setTimeout(() => {
      // Marcar que estamos salvando (para useEffect ignorar reset)
      isSavingRef.current = true;

      // Sincronizar estados externos
      setSelectedTopics(localTopics);
      setExtractedTopics((prev: Topic[]) =>
        prev.map((et: Topic) => {
          const updated = localTopics.find((lt: Topic) => lt.title === et.title);
          return updated ? { ...et, ...updated } : et;
        })
      );

      setIsDirty(false);
      // NÃ£o mostrar toast no auto-save (apenas o indicador verde jÃ¡ Ã© suficiente)
    }, AUTO_SAVE_DEBOUNCE_MS);

    return () => {
      if (globalAutoSaveTimerRef.current) {
        clearTimeout(globalAutoSaveTimerRef.current);
      }
    };
  }, [isOpen, isDirty, localTopics, setSelectedTopics, setExtractedTopics]);

  // Salvar e fechar - sincroniza estados externos e fecha
  // v1.13: Agora tambÃ©m detecta automaticamente o resultado para tÃ³picos editados
  const handleSaveAndClose = React.useCallback(async () => {
    // v1.13: Identificar tÃ³picos que precisam de anÃ¡lise de resultado:
    // - Foram editados (campo decisao)
    // - NÃ£o tÃªm resultadoManual (usuÃ¡rio nÃ£o escolheu manualmente)
    // - NÃ£o sÃ£o RELATÃ“RIO ou DISPOSITIVO
    const topicsToAnalyze = detectResultadoAutomatico ? localTopics.filter(t =>
      editedTopicTitles.has(t.title) &&
      !t.resultadoManual &&
      t.category !== 'RELATÃ“RIO' &&
      t.category !== 'DISPOSITIVO' &&
      t.title.toUpperCase() !== 'RELATÃ“RIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO'
    ) : [];

    let updatedTopics = [...localTopics];

    if (topicsToAnalyze.length > 0) {
      // Mostrar modal de progresso
      setIsAnalyzingResults(true);
      setAnalyzingProgress({ current: 0, total: topicsToAnalyze.length });

      // v1.33.11: Usar valor configurÃ¡vel de requisiÃ§Ãµes paralelas
      const BATCH_SIZE = aiIntegration?.aiSettings?.parallelRequests || 5;

      for (let i = 0; i < topicsToAnalyze.length; i += BATCH_SIZE) {
        const batch = topicsToAnalyze.slice(i, i + BATCH_SIZE);

        const promises = batch.map(async (topic: Topic) => {
          const resultado = detectResultadoAutomatico ? await detectResultadoAutomatico(
            topic.title,
            topic.editedFundamentacao || topic.fundamentacao || '',
            topic.category
          ) : null;
          return { title: topic.title, resultado };
        });

        const results = await Promise.allSettled(promises);

        // Atualizar tÃ³picos com resultados detectados
        let rejectedCount = 0;
        results.forEach(r => {
          if (r.status === 'fulfilled' && r.value.resultado) {
            const idx = updatedTopics.findIndex((t: Topic) => t.title === r.value.title);
            if (idx !== -1) {
              updatedTopics[idx] = { ...updatedTopics[idx], resultado: r.value.resultado as TopicResultado };
            }
          } else if (r.status === 'rejected') {
            rejectedCount++;
          }
        });
        if (rejectedCount > 0) {
          console.warn(`[SentencifyAI] ${rejectedCount} tÃ³pico(s) falharam na detecÃ§Ã£o automÃ¡tica de resultado`);
        }

        setAnalyzingProgress({ current: Math.min(i + BATCH_SIZE, topicsToAnalyze.length), total: topicsToAnalyze.length });

        // Delay entre batches para evitar rate limit (exceto Ãºltimo)
        if (i + BATCH_SIZE < topicsToAnalyze.length) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }

      setIsAnalyzingResults(false);
    }

    // Aplicar alteraÃ§Ãµes aos tÃ³picos selecionados
    setSelectedTopics(updatedTopics);

    // Sincronizar com extractedTopics
    setExtractedTopics((prev: Topic[]) =>
      prev.map((et: Topic) => {
        const updated = updatedTopics.find((lt: Topic) => lt.title === et.title);
        return updated ? { ...et, ...updated } : et;
      })
    );

    showToast?.('AlteraÃ§Ãµes salvas com sucesso!', 'success');
    setEditedTopicTitles(new Set()); // Limpar rastreamento
    onClose();
  }, [localTopics, editedTopicTitles, setSelectedTopics, setExtractedTopics, showToast, onClose, detectResultadoAutomatico]);

  // Cancelar
  const handleCancel = React.useCallback(() => {
    if (isDirty) {
      setShowCancelConfirm(true);
      return;
    }
    onClose();
  }, [isDirty, onClose]);

  // Confirmar cancelamento
  const confirmCancel = React.useCallback(() => {
    setShowCancelConfirm(false);
    onClose();
  }, [onClose]);

  const handleOpenAIAssistant = React.useCallback((topicIndex: number) => {
    setAiAssistantTopicIndex(topicIndex);
    setShowAIAssistant(true);
  }, []);

  // v1.12.14: Handler para abrir modal de provas vinculadas
  const handleOpenProofsModal = React.useCallback((topicIndex: number) => {
    setProofsModalTopicIndex(topicIndex);
    setShowProofsModal(true);
  }, []);

  // v1.36.12: Handler para abrir modal de confronto de fatos
  const handleOpenFactsComparison = React.useCallback(async (topicIndex: number) => {
    setFactsComparisonTopicIndex(topicIndex);
    setFactsComparisonError(null);

    // Verificar cache
    const topic = localTopics[topicIndex];
    if (topic) {
      const cached = await factsComparisonCache.getComparison(topic.title, 'mini-relatorio');
      if (cached) {
        setFactsComparisonResult(cached);
      } else {
        // Tentar cache de documentos
        const cachedDocs = await factsComparisonCache.getComparison(topic.title, 'documentos-completos');
        setFactsComparisonResult(cachedDocs);
      }
    }

    setShowFactsComparison(true);
  }, [localTopics, factsComparisonCache]);

  // v1.36.12: Handler para gerar confronto de fatos
  const handleGenerateFactsComparison = React.useCallback(async (source: FactsComparisonSource) => {
    if (!aiIntegration || factsComparisonTopicIndex === null) return;

    const topic = localTopics[factsComparisonTopicIndex];
    if (!topic) return;

    setGeneratingFactsComparison(true);
    setFactsComparisonError(null);

    try {
      let prompt: string;

      if (source === 'mini-relatorio') {
        const relatorio = topic.editedRelatorio || topic.relatorio || '';
        if (!relatorio.trim()) {
          throw new Error('Mini-relatÃ³rio nÃ£o disponÃ­vel para este tÃ³pico.');
        }
        prompt = buildMiniRelatorioComparisonPrompt(topic.title, relatorio);
      } else {
        // Documentos completos - priorizar texto, fallback para PDF binÃ¡rio
        const peticaoText = (analyzedDocuments?.peticoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
        const contestacaoText = (analyzedDocuments?.contestacoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
        const impugnacaoText = (analyzedDocuments?.complementaresText || []).map((t: PastedText) => t.text || '').join('\n\n');

        const hasText = peticaoText.trim() || contestacaoText.trim();
        // v1.36.22: PDFs base64 estÃ£o em analyzedDocuments?.peticoes (nÃ£o em peticaoFiles)
        const hasPdfs = (analyzedDocuments?.peticoes?.length || 0) > 0 || (analyzedDocuments?.contestacoes?.length || 0) > 0;

        if (!hasText && !hasPdfs) {
          throw new Error('Nenhum documento disponÃ­vel (petiÃ§Ã£o ou contestaÃ§Ã£o).');
        }

        if (hasText) {
          // Caminho padrÃ£o: usar texto extraÃ­do
          prompt = buildDocumentosComparisonPrompt(topic.title, peticaoText, contestacaoText, impugnacaoText);
        } else {
          // v1.36.22: Fallback para PDF binÃ¡rio (quando nÃ£o hÃ¡ texto extraÃ­do)
          prompt = buildPdfComparisonPrompt(topic.title);
        }
      }

      // Construir mensagem - pode ser texto simples ou incluir PDFs binÃ¡rios
      let messageContent: AIMessageContent[];

      const peticaoTextFallback = (analyzedDocuments?.peticoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
      const contestacaoTextFallback = (analyzedDocuments?.contestacoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
      const hasTextForMessage = peticaoTextFallback.trim() || contestacaoTextFallback.trim();

      if (hasTextForMessage || source === 'mini-relatorio') {
        // Texto simples
        messageContent = [{ type: 'text', text: prompt }];
      } else {
        // v1.36.22: Incluir PDFs binÃ¡rios como fallback (de analyzedDocuments.peticoes/contestacoes/complementares)
        messageContent = [{ type: 'text', text: prompt }];

        // Adicionar petiÃ§Ãµes como PDF
        for (const base64 of (analyzedDocuments?.peticoes || [])) {
          if (base64) {
            messageContent.push({ type: 'text', text: '\n\nğŸ“„ PETIÃ‡ÃƒO INICIAL (documento PDF a seguir):' });
            messageContent.push({
              type: 'document',
              source: {
                type: 'base64',
                media_type: 'application/pdf',
                data: base64
              }
            } as AIDocumentContent);
          }
        }

        // Adicionar contestaÃ§Ãµes como PDF
        for (const base64 of (analyzedDocuments?.contestacoes || [])) {
          if (base64) {
            messageContent.push({ type: 'text', text: '\n\nğŸ“„ CONTESTAÃ‡ÃƒO (documento PDF a seguir):' });
            messageContent.push({
              type: 'document',
              source: {
                type: 'base64',
                media_type: 'application/pdf',
                data: base64
              }
            } as AIDocumentContent);
          }
        }

        // Adicionar complementares como PDF
        for (const base64 of (analyzedDocuments?.complementares || [])) {
          if (base64) {
            messageContent.push({ type: 'text', text: '\n\nğŸ“„ DOCUMENTO COMPLEMENTAR (documento PDF a seguir):' });
            messageContent.push({
              type: 'document',
              source: {
                type: 'base64',
                media_type: 'application/pdf',
                data: base64
              }
            } as AIDocumentContent);
          }
        }
      }

      const response = await aiIntegration.callAI([{
        role: 'user',
        content: messageContent
      }], {
        maxTokens: 8000,
        useInstructions: false,
        temperature: 0.3,
        topP: 0.9,
        topK: 40
      });

      // Extrair JSON da resposta (pode vir com markdown)
      let jsonStr = response;
      const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
      if (jsonMatch) {
        jsonStr = jsonMatch[1];
      } else {
        // Tentar encontrar JSON direto
        const firstBrace = response.indexOf('{');
        const lastBrace = response.lastIndexOf('}');
        if (firstBrace !== -1 && lastBrace !== -1) {
          jsonStr = response.substring(firstBrace, lastBrace + 1);
        }
      }

      const parsed = JSON.parse(jsonStr);

      // v1.36.58: Double Check do Confronto de Fatos
      let verifiedParsed = parsed;
      if (aiIntegration.aiSettings.doubleCheck?.enabled &&
          aiIntegration.aiSettings.doubleCheck?.operations.factsComparison &&
          aiIntegration.performDoubleCheck) {
        try {
          // Contexto depende do source usado
          let contextText: string;
          if (source === 'mini-relatorio') {
            const relatorio = topic.editedRelatorio || topic.relatorio || '';
            contextText = `MINI-RELATÃ“RIO DO TÃ“PICO "${topic.title}":\n${relatorio}`;
          } else {
            // documentos-completos
            const peticaoText = (analyzedDocuments?.peticoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
            const contestacaoText = (analyzedDocuments?.contestacoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
            const impugnacaoText = (analyzedDocuments?.complementaresText || []).map((t: PastedText) => t.text || '').join('\n\n');

            contextText = [
              peticaoText && `PETIÃ‡ÃƒO INICIAL:\n${peticaoText}`,
              contestacaoText && `CONTESTAÃ‡ÃƒO:\n${contestacaoText}`,
              impugnacaoText && `IMPUGNAÃ‡ÃƒO/RÃ‰PLICA:\n${impugnacaoText}`
            ].filter(Boolean).join('\n\n---\n\n');
          }

          const { verified, corrections, summary } = await aiIntegration.performDoubleCheck(
            'factsComparison',
            JSON.stringify(parsed, null, 2),
            contextText
          );

          if (corrections.length > 0) {
            const verifiedObj = JSON.parse(verified);
            // Extrair o resultado verificado (pode estar em verifiedResult ou ser o objeto inteiro)
            verifiedParsed = verifiedObj.verifiedResult || verifiedObj;
            showToast?.(`ğŸ”„ Double Check: ${corrections.length} correÃ§Ã£o(Ãµes) - ${summary}`, 'info');
            console.log('[DoubleCheck FactsComparison] CorreÃ§Ãµes:', corrections);
          }
        } catch (dcError) {
          console.error('[DoubleCheck FactsComparison] Erro:', dcError);
          // Continuar com parsed original em caso de erro
        }
      }

      const result: FactsComparisonResult = {
        topicTitle: topic.title,
        source,
        generatedAt: new Date().toISOString(),
        tabela: verifiedParsed.tabela || [],
        fatosIncontroversos: verifiedParsed.fatosIncontroversos || [],
        fatosControversos: verifiedParsed.fatosControversos || [],
        pontosChave: verifiedParsed.pontosChave || [],
        resumo: verifiedParsed.resumo || ''
      };

      // Salvar no cache
      await factsComparisonCache.saveComparison(topic.title, source, result);

      setFactsComparisonResult(result);
    } catch (err) {
      console.error('[FactsComparison] Erro:', err);
      setFactsComparisonError(err instanceof Error ? err.message : 'Erro ao gerar anÃ¡lise. Tente novamente.');
    } finally {
      setGeneratingFactsComparison(false);
    }
  }, [aiIntegration, factsComparisonTopicIndex, localTopics, analyzedDocuments, factsComparisonCache]);

  // v1.12.14: Helper para calcular provas vinculadas a um tÃ³pico
  const getLinkedProofsForTopic = React.useCallback((topicTitle: string) => {
    if (!proofManager) return [];
    const proofTopicLinks = proofManager.proofTopicLinks || {};
    const linkedProofIds = Object.keys(proofTopicLinks).filter(proofId =>
      proofTopicLinks[proofId]?.includes(topicTitle)
    );
    return [
      ...(proofManager.proofFiles || []).filter((p: ProofFile) => linkedProofIds.includes(String(p.id))).map((p: ProofFile) => ({ ...p, isPdf: true as const })),
      ...(proofManager.proofTexts || []).filter((p: ProofText) => linkedProofIds.includes(String(p.id))).map((p: ProofText) => ({ ...p, isPdf: false as const }))
    ] as Proof[];
  }, [proofManager]);

  const generateGlobalAiText = React.useCallback(async () => {
    if (!globalAiInstruction.trim() || !aiIntegration || aiAssistantTopicIndex === null) return;

    setGeneratingGlobalAi(true);
    setGlobalAiGeneratedText('');

    try {
      const topic = localTopics[aiAssistantTopicIndex];
      if (!topic) throw new Error('TÃ³pico nÃ£o encontrado');

      // Preparar documentos usando helper
      const { contentArray, flags } = prepareDocumentsContext(analyzedDocuments);
      const { hasPeticao, hasContestacoes, hasComplementares } = flags;

      // ğŸ†• v1.19.5: Usar funÃ§Ã£o centralizada para provas
      // v1.19.2: Passar flag de anonimizaÃ§Ã£o
      // v1.21.5: Passar anonConfig para anonimizar texto
      const { proofDocuments, proofsContext, hasProofs } = fileToBase64 ? await prepareProofsContext(
        proofManager, topic.title, fileToBase64, aiIntegration?.aiSettings?.anonymization?.enabled, aiIntegration?.aiSettings?.anonymization
      ) : { proofDocuments: [], proofsContext: '', hasProofs: false };
      contentArray.push(...proofDocuments);

      // Preparar contexto baseado no escopo selecionado
      let decisionContext = '';

      if (globalContextScope === 'current') {
        // Apenas o tÃ³pico atual
        decisionContext = `
ğŸ“‹ CONTEXTO DO TÃ“PICO:
TÃ­tulo: ${topic.title}
Categoria: ${topic.category || 'NÃ£o especificada'}

ğŸ“ MINI-RELATÃ“RIO DO TÃ“PICO:
${topic.editedRelatorio || topic.relatorio || 'NÃ£o disponÃ­vel'}

âœï¸ DECISÃƒO JÃ ESCRITA:
${topic.editedFundamentacao || topic.fundamentacao || 'Ainda nÃ£o foi escrito nada'}
`;
      } else {
        // Toda a decisÃ£o (todos os tÃ³picos)
        decisionContext = 'ğŸ“‹ CONTEXTO COMPLETO DA DECISÃƒO:\n\n';

        localTopics.forEach((t, index) => {
          const titleUpper = t.title.toUpperCase();
          if (titleUpper === 'RELATÃ“RIO') {
            decisionContext += `ğŸ“„ RELATÃ“RIO GERAL:\n${t.editedRelatorio || t.relatorio || 'NÃ£o disponÃ­vel'}\n\n---\n\n`;
          } else if (titleUpper === 'DISPOSITIVO') {
            decisionContext += `âš–ï¸ DISPOSITIVO:\n${t.editedContent || ''}\n\n---\n\n`;
          } else {
            decisionContext += `ğŸ“‹ TÃ“PICO ${index}: ${t.title} (${t.category || 'Sem categoria'})
Mini-relatÃ³rio: ${t.editedRelatorio || t.relatorio || 'NÃ£o disponÃ­vel'}
DecisÃ£o: ${t.editedFundamentacao || t.fundamentacao || 'NÃ£o escrita'}

---

`;
          }
        });

        decisionContext += `\nğŸ¯ TÃ“PICO SENDO EDITADO: ${topic.title}`;
      }

      // 8. Adicionar instruÃ§Ã£o final (mesmo prompt do assistente individual)
      contentArray.push({
        type: 'text',
        text: `VocÃª estÃ¡ auxiliando na redaÃ§Ã£o de uma DECISÃƒO JUDICIAL TRABALHISTA.

${decisionContext}

${hasPeticao || hasContestacoes || hasComplementares || hasProofs ? `
ğŸ“š DOCUMENTOS DISPONÃVEIS PARA CONSULTA:
${hasPeticao ? 'âœ“ PetiÃ§Ã£o inicial' : ''}
${hasContestacoes ? 'âœ“ ContestaÃ§Ã£o(Ãµes)' : ''}
${hasComplementares ? 'âœ“ Documento(s) complementar(es)' : ''}
${hasProofs ? 'âœ“ Prova(s) vinculada(s) a este tÃ³pico' : ''}

Os documentos foram anexados acima. VocÃª pode e DEVE consultÃ¡-los para fundamentar sua decisÃ£o, especialmente:
- Para identificar alegaÃ§Ãµes e argumentos das partes
- Para verificar provas mencionadas
- Para fundamentar sua decisÃ£o com base no que foi apresentado nos autos
${hasProofs ? '- Para analisar as provas vinculadas e suas respectivas anÃ¡lises/conclusÃµes' : ''}
` : ''}
${proofsContext}
ğŸ¯ INSTRUÃ‡ÃƒO DO USUÃRIO:
${globalAiInstruction}

âš ï¸ IMPORTANTE - NÃƒO INCLUIR MINI-RELATÃ“RIO:
- O mini-relatÃ³rio jÃ¡ foi fornecido acima apenas como CONTEXTO
- NÃƒO repita ou resuma os fatos no texto gerado
- NÃƒO inicie com "Trata-se de...", "Cuida-se de...", "O reclamante postula..."
- VÃ¡ DIRETO para a anÃ¡lise jurÃ­dica, fundamentaÃ§Ã£o e conclusÃ£o

${AI_PROMPTS.estiloRedacao}

Com base em TODOS os elementos acima (contexto do tÃ³pico, documentos processuais e instruÃ§Ã£o do usuÃ¡rio), gere o texto solicitado.

O texto deve:
- Ser adequado para uma decisÃ£o judicial trabalhista
- Usar SEMPRE a primeira pessoa
- Manter linguagem formal, mas acessÃ­vel
- Evitar latinismos desnecessÃ¡rios
- Ser claro e objetivo
- Considerar o contexto do tÃ³pico e o que jÃ¡ foi escrito
- FUNDAMENTAR-SE nos documentos processuais (petiÃ§Ã£o, contestaÃ§Ãµes, provas)
- Citar fatos especÃ­ficos dos autos quando relevante
- Aplicar bases legais quando apropriado

${AI_PROMPTS.formatacaoHTML("A <strong>CLT</strong> estabelece que...")}

${AI_PROMPTS.formatacaoParagrafos("<p>Passo a analisar...</p><p>A CLT estabelece...</p>")}

${AI_PROMPTS.numeracaoReclamadas}

Responda APENAS com o texto gerado em HTML, sem prefÃ¡cio, sem explicaÃ§Ãµes. Gere texto pronto para ser inserido na decisÃ£o.`
      });

      // Chamar API
      // v1.21.26: Parametros para assistente interativo (criativo moderado)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray as AIMessageContent[]
      }], {
        maxTokens: 4000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.5,
        topP: 0.9,
        topK: 80
      });

      setGlobalAiGeneratedText(textContent.trim());
    } catch (err) {
      showToast?.('Erro ao gerar texto: ' + (err as Error).message, 'error');
    } finally {
      setGeneratingGlobalAi(false);
    }
  }, [globalAiInstruction, aiIntegration, aiAssistantTopicIndex, localTopics, analyzedDocuments, proofManager, globalContextScope, showToast]);

  const insertGlobalAiText = React.useCallback((mode: InsertMode) => {
    if (!globalAiGeneratedText || aiAssistantTopicIndex === null) return;

    setLocalTopics(prev => {
      const updated = [...prev];
      const currentContent = updated[aiAssistantTopicIndex].editedFundamentacao ||
                            updated[aiAssistantTopicIndex].fundamentacao || '';
      const normalizedAiText = normalizeHTMLSpacing(globalAiGeneratedText);

      let newContent;
      switch (mode) {
        case 'replace':
          newContent = sanitizeHTML(normalizedAiText);
          break;
        case 'append':
          newContent = sanitizeHTML(currentContent + '<p><br></p>' + normalizedAiText);
          break;
        case 'prepend':
          newContent = sanitizeHTML(normalizedAiText + '<p><br></p>' + currentContent);
          break;
        default:
          newContent = currentContent;
      }

      updated[aiAssistantTopicIndex].editedFundamentacao = newContent;
      return updated;
    });

    setIsDirty(true);
    setShowAIAssistant(false);
    setAiAssistantTopicIndex(null);
    setGlobalAiInstruction('');
    setGlobalAiGeneratedText('');
    showToast?.('Texto inserido com sucesso!', 'success');
  }, [globalAiGeneratedText, aiAssistantTopicIndex, sanitizeHTML, showToast]);

  // ğŸ¤– v1.19.0: ConstrÃ³i contexto completo para chat do assistente IA (Global)
  // ğŸ†• v1.19.5: Agora assÃ­ncrono para suportar PDFs binÃ¡rios
  // v1.21.1: Aceita options para filtrar provas
  const buildContextForChatGlobal = React.useCallback(async (userMessage: string, options: { proofFilter?: string } = {}) => {
    if (aiAssistantTopicIndex === null) return [];
    const topic = localTopics[aiAssistantTopicIndex];
    if (!topic) return [];
    const { proofFilter } = options;

    // Preparar documentos usando helper
    const { contentArray, flags } = prepareDocumentsContext(analyzedDocuments);
    const { hasPeticao, hasContestacoes, hasComplementares } = flags;

    // ğŸ†• v1.21.1: Usar funÃ§Ã£o de provas orais se filtro ativo
    // v1.19.2: Passar flag de anonimizaÃ§Ã£o
    // v1.21.5: Passar anonConfig para anonimizar texto
    const prepareFunction = proofFilter === 'oral' ? prepareOralProofsContext : prepareProofsContext;
    const { proofDocuments, proofsContext, hasProofs } = fileToBase64 ? await prepareFunction(
      proofManager, topic.title, fileToBase64, aiIntegration?.aiSettings?.anonymization?.enabled, aiIntegration?.aiSettings?.anonymization
    ) : { proofDocuments: [] as AIMessageContent[], proofsContext: '', hasProofs: false };
    contentArray.push(...proofDocuments);

    // Contexto baseado no escopo selecionado
    let decisionContext = '';
    if (globalContextScope === 'current') {
      decisionContext = `
ğŸ“‹ CONTEXTO DO TÃ“PICO:
TÃ­tulo: ${topic.title}
Categoria: ${topic.category || 'NÃ£o especificada'}

ğŸ“ MINI-RELATÃ“RIO DO TÃ“PICO:
${topic.editedRelatorio || topic.relatorio || 'NÃ£o disponÃ­vel'}

âœï¸ DECISÃƒO JÃ ESCRITA:
${topic.editedFundamentacao || topic.fundamentacao || 'Ainda nÃ£o foi escrito nada'}
`;
    } else {
      decisionContext = 'ğŸ“‹ CONTEXTO COMPLETO DA DECISÃƒO:\n\n';
      localTopics.forEach((t, index) => {
        const titleUpper = t.title.toUpperCase();
        if (titleUpper === 'RELATÃ“RIO') {
          decisionContext += `ğŸ“„ RELATÃ“RIO GERAL:\n${t.editedRelatorio || t.relatorio || 'NÃ£o disponÃ­vel'}\n\n---\n\n`;
        } else if (titleUpper === 'DISPOSITIVO') {
          decisionContext += `âš–ï¸ DISPOSITIVO:\n${t.editedContent || ''}\n\n---\n\n`;
        } else {
          decisionContext += `ğŸ“‹ TÃ“PICO ${index}: ${t.title} (${t.category || 'Sem categoria'})
Mini-relatÃ³rio: ${t.editedRelatorio || t.relatorio || 'NÃ£o disponÃ­vel'}
DecisÃ£o: ${t.editedFundamentacao || t.fundamentacao || 'NÃ£o escrita'}

---

`;
        }
      });
      decisionContext += `\nğŸ¯ TÃ“PICO SENDO EDITADO: ${topic.title}`;
    }

    // Verificar se anonimizaÃ§Ã£o estÃ¡ ativada
    const anonymizationEnabled = aiIntegration?.aiSettings?.anonymization?.enabled;

    // Montar prompt completo
    contentArray.push({
      type: 'text',
      text: `VocÃª estÃ¡ auxiliando na redaÃ§Ã£o de uma DECISÃƒO JUDICIAL TRABALHISTA.

${decisionContext}

${hasPeticao || hasContestacoes || hasComplementares || hasProofs ? `
ğŸ“š DOCUMENTOS DISPONÃVEIS PARA CONSULTA:
${hasPeticao ? 'âœ“ PetiÃ§Ã£o inicial' : ''}
${hasContestacoes ? 'âœ“ ContestaÃ§Ã£o(Ãµes)' : ''}
${hasComplementares ? 'âœ“ Documento(s) complementar(es)' : ''}
${hasProofs ? 'âœ“ Prova(s) vinculada(s) a este tÃ³pico' : ''}

Os documentos foram anexados acima. VocÃª pode e DEVE consultÃ¡-los para fundamentar sua decisÃ£o.
${hasProofs ? '- Analise as provas vinculadas e suas respectivas anÃ¡lises/conclusÃµes' : ''}
` : ''}
${proofsContext}

${INSTRUCAO_NAO_PRESUMIR}

${AI_PROMPTS.estiloRedacao}
${AI_PROMPTS.numeracaoReclamadas}
${anonymizationEnabled ? AI_PROMPTS.preservarAnonimizacao : ''}

âš ï¸ NÃƒO INCLUIR MINI-RELATÃ“RIO no texto gerado.

ğŸ¯ INSTRUÃ‡ÃƒO DO USUÃRIO:
${userMessage}

Quando faltar informaÃ§Ã£o expressa necessÃ¡ria Ã  redaÃ§Ã£o, PERGUNTE ao usuÃ¡rio antes de redigir. Prefira perguntar a presumir.

âš ï¸ ANTES DE REDIGIR QUALQUER TEXTO DE DECISÃƒO:
Liste as informaÃ§Ãµes/conclusÃµes que vocÃª precisa confirmar com o usuÃ¡rio.
SÃ³ prossiga com a redaÃ§Ã£o APÃ“S receber as respostas.
Se nÃ£o houver nada a confirmar, indique "Nenhuma informaÃ§Ã£o pendente" e prossiga.

Quando gerar texto para a decisÃ£o, responda em HTML.
${AI_PROMPTS.formatacaoHTML("A <strong>CLT</strong> estabelece...")}
${AI_PROMPTS.formatacaoParagrafos("<p>Primeiro parÃ¡grafo.</p><p>Segundo parÃ¡grafo.</p>")}`
    });

    return contentArray;
  }, [localTopics, aiAssistantTopicIndex, analyzedDocuments, proofManager, globalContextScope, aiIntegration?.aiSettings?.anonymization?.enabled]);

  // ğŸ¤– v1.19.0: Handler para inserir resposta do chat no editor global
  const handleInsertGlobalChatResponse = React.useCallback((mode: InsertMode) => {
    const response = chatAssistantGlobal.lastResponse;
    if (!response || aiAssistantTopicIndex === null) return;

    setLocalTopics(prev => {
      const updated = [...prev];
      const currentContent = updated[aiAssistantTopicIndex].editedFundamentacao ||
                            updated[aiAssistantTopicIndex].fundamentacao || '';
      const normalizedAiText = normalizeHTMLSpacing(response);

      let newContent;
      switch (mode) {
        case 'replace':
          newContent = sanitizeHTML(normalizedAiText);
          break;
        case 'append':
          newContent = sanitizeHTML(currentContent + '<p><br></p>' + normalizedAiText);
          break;
        case 'prepend':
          newContent = sanitizeHTML(normalizedAiText + '<p><br></p>' + currentContent);
          break;
        default:
          newContent = sanitizeHTML(normalizedAiText);
      }

      updated[aiAssistantTopicIndex].editedFundamentacao = newContent;
      return updated;
    });

    setIsDirty(true);
  }, [chatAssistantGlobal.lastResponse, aiAssistantTopicIndex, sanitizeHTML]);

  // ğŸ¤– v1.19.0: Handler para enviar mensagem no chat global
  // v1.21.1: Aceita options (ex: { proofFilter: 'oral' }) para filtrar provas
  // v1.21.6: Verifica provas vinculadas + anonimizaÃ§Ã£o â†’ abre modal de nomes
  const handleSendGlobalChatMessage = React.useCallback(async (message: string, options: { proofFilter?: string } = {}) => {
    // v1.21.13: Removido modal de anonimizaÃ§Ã£o - provas CONFLITO sÃ£o filtradas em prepareProofsContext
    const contextBuilderWithOptions = (msg: string) => buildContextForChatGlobal(msg, options);
    await chatAssistantGlobal.send(message, contextBuilderWithOptions);
  }, [chatAssistantGlobal, buildContextForChatGlobal]);

  // Toggle split mode
  const toggleSplitMode = React.useCallback(() => {
    setIsSplitMode(prev => !prev);
  }, []);

  // Handlers para drag do divisor
  const handleMouseDown = React.useCallback(() => {
    setIsDragging(true);
  }, []);

  const handleMouseMove = React.useCallback((e: MouseEvent) => {
    if (!isDragging || !containerRef.current) return;

    const rect = containerRef.current.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const percentage = (x / rect.width) * 100;
    const clampedPercentage = Math.max(30, Math.min(80, percentage));
    setSplitPosition(clampedPercentage);
  }, [isDragging]);

  const handleMouseUp = React.useCallback(() => {
    setIsDragging(false);
  }, []);

  // Mouse up global para drag
  React.useEffect(() => {
    if (isDragging) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('mouseup', handleMouseUp);
      return () => {
        window.removeEventListener('mousemove', handleMouseMove);
        window.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [isDragging, handleMouseMove, handleMouseUp]);

  // Atalhos de teclado
  React.useEffect(() => {
    if (!isOpen) return;

    const handleKeyDown = (e: KeyboardEvent) => {
      // Ctrl+S: Salvar (sem fechar)
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        if (isDirty) handleSaveOnly();
      }

      // Ctrl+M: Toggle split mode
      if (e.ctrlKey && e.key === 'm') {
        e.preventDefault();
        toggleSplitMode();
      }

      // ESC: Fechar sub-modais primeiro, depois o modal pai
      // v1.36.45: Respeita hierarquia de modais
      if (e.key === 'Escape') {
        if (showCancelConfirm) return;

        // Fechar sub-modais primeiro (hierarquia)
        if (showJurisModal) {
          setShowJurisModal(false);
          setJurisTopicIndex(null);
          return;
        }
        if (showAIAssistant) {
          setShowAIAssistant(false);
          setAiAssistantTopicIndex(null);
          chatAssistantGlobal.clear();
          return;
        }
        if (showFactsComparison) {
          setShowFactsComparison(false);
          setFactsComparisonTopicIndex(null);
          setFactsComparisonResult(null);
          setFactsComparisonError(null);
          return;
        }

        handleCancel();
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, isDirty, handleSaveOnly, toggleSplitMode, handleCancel, showCancelConfirm, showJurisModal, showAIAssistant, showFactsComparison, chatAssistantGlobal]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[70] flex flex-col theme-bg-app overflow-visible">
      {/* v1.13: Modal de progresso da anÃ¡lise de resultados */}
      {isAnalyzingResults && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50">
          <div className="theme-bg-primary rounded-xl p-6 shadow-xl border theme-border max-w-sm">
            <div className="flex items-center gap-3">
              <Loader2 className="w-6 h-6 animate-spin text-blue-500" />
              <div>
                <p className="font-medium theme-text">Analisando resultados...</p>
                <p className="text-sm theme-text-muted">
                  TÃ³pico {analyzingProgress.current} de {analyzingProgress.total}
                </p>
              </div>
            </div>
          </div>
        </div>
      )}
      {/* v1.32.00: Overlay removido - IA roda em worker */}
      {/* Header */}
      <div className="flex items-center justify-between px-6 py-3 border-b theme-border-secondary theme-bg-secondary flex-shrink-0">
        <div className="flex items-center gap-4">
          <h2 className="text-lg font-bold theme-text-primary flex items-center gap-2">
            <Edit className="w-5 h-5 text-cyan-400" />
            EdiÃ§Ã£o Global
          </h2>
          <span className="text-xs theme-text-muted">
            {localTopics.length} tÃ³pico{localTopics.length !== 1 ? 's' : ''}
          </span>
          {currentFocusedTopic && (
            <span className="px-3 py-1 text-xs rounded-full theme-bg-purple-accent theme-text-purple border border-purple-500/30">
              Editando: {currentFocusedTopic.title}
              {currentFocusedTopic.category && ` (${currentFocusedTopic.category})`}
            </span>
          )}
          {isDirty && (
            <span className="px-2 py-1 text-xs rounded bg-amber-500/20 text-amber-400 border border-amber-500/30">
              NÃ£o salvo
            </span>
          )}
        </div>

        <div className="flex items-center gap-2">
          {/* v1.12.2: BotÃ£o Modelos padronizado igual ao fullscreen */}
          <button
            onClick={toggleSplitMode}
            className={`px-3 py-1.5 text-white text-xs rounded flex items-center gap-1.5 transition-all ${
              isSplitMode
                ? 'bg-amber-700 ring-2 ring-amber-400'
                : 'bg-amber-600 hover-amber-700'
            }`}
            title={isSplitMode ? 'Fechar Modelos (Ctrl+M)' : 'ğŸ“š Abrir Biblioteca de Modelos (Ctrl+M)'}
          >
            <BookOpen className="w-3.5 h-3.5" />
            {isSplitMode ? 'Fechar Modelos' : 'ğŸ“š Modelos'}
          </button>

          {/* v1.12.2: Seletores de espaÃ§amento e tamanho de fonte (configuraÃ§Ã£o global) */}
          {setSpacing && <SpacingDropdown value={spacing} onChange={setSpacing} />}
          {setFontSize && <FontSizeDropdown value={fontSize} onChange={setFontSize} />}

          <button
            onClick={handleCancel}
            className="px-3 py-1.5 text-xs rounded flex items-center gap-1.5 theme-bg-tertiary theme-text-secondary hover-slate-600"
            title="ESC"
          >
            <X className="w-4 h-4" />
            Cancelar
          </button>

          <button
            onClick={handleSaveOnly}
            className="px-4 py-1.5 text-xs rounded flex items-center gap-1.5 bg-blue-600 text-white hover-blue-500"
            title="Ctrl+S"
          >
            <Save className="w-4 h-4" />
            Salvar
          </button>

          <button
            onClick={handleSaveAndClose}
            className="px-4 py-1.5 text-xs rounded flex items-center gap-1.5 bg-green-600 text-white hover-green-700-from-600"
          >
            <Save className="w-4 h-4" />
            Salvar e Sair
          </button>
        </div>
      </div>

      {/* Main Content Area */}
      <div
        ref={containerRef}
        className="flex flex-1 min-h-0 overflow-hidden"
      >
        {/* Editor Pane - Lista de tÃ³picos com editores separados */}
        <div
          className="flex flex-col min-h-0 overflow-hidden"
          style={{ width: isSplitMode ? `${splitPosition}%` : '100%' }}
        >
          <div className={`flex-1 overflow-y-auto p-6 fontsize-${fontSize} spacing-${spacing}`}>
            {localTopics.length > 0 ? (
              localTopics.map((topic, index) => (
                <GlobalEditorSection
                  key={`${topic.title}-${index}`}
                  topic={topic}
                  topicIndex={index}
                  onFieldChange={handleFieldChange}
                  onFieldFocus={handleFieldFocus}
                  onSlashCommand={onSlashCommand}
                  quillReady={quillReady}
                  quillError={quillError}
                  editorTheme={editorTheme}
                  onOpenAIAssistant={handleOpenAIAssistant}
                  onOpenProofsModal={handleOpenProofsModal}
                  onOpenJurisModal={(idx: number) => {
                    setJurisTopicIndex(idx);
                    setShowJurisModal(true);
                  }}
                  onOpenFactsComparison={handleOpenFactsComparison}
                  linkedProofsCount={getLinkedProofsForTopic(topic.title).length}
                  isCollapsed={collapsedSections[index] ?? false}
                  onToggleCollapse={(idx: number) => setCollapsedSections(prev => ({ ...prev, [idx]: !prev[idx] }))}
                  versioning={fieldVersioning}
                />
              ))
            ) : (
              <div className="flex items-center justify-center h-full theme-text-muted">
                <div className="text-center">
                  <div className="w-8 h-8 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                  <span>Carregando tÃ³picos...</span>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Split Divider */}
        {isSplitMode && (
          <div
            className="w-1 cursor-col-resize flex-shrink-0 theme-bg-tertiary hover:bg-purple-500 transition-colors"
            onMouseDown={handleMouseDown}
          />
        )}

        {/* Model Suggestions Pane */}
        {isSplitMode && (
          <div
            className="flex flex-col min-h-0 overflow-hidden theme-bg-secondary"
            style={{ width: `${100 - splitPosition}%` }}
          >
            {/* Panel Header - v1.12.1: SugestÃµes automÃ¡ticas */}
            <div className="p-4 border-b theme-border-secondary flex-shrink-0">
              <h3 className="text-sm font-semibold theme-text-primary mb-2 flex items-center gap-2">SugestÃµes de Modelos{suggestionsSource === 'local' && <span className="bg-purple-600 text-white px-1.5 py-0.5 rounded text-[10px]">ğŸ¤– IA Local</span>}</h3>

              {currentFocusedTopic ? (
                <p className="text-xs theme-text-muted flex items-center gap-1.5">
                  {loadingSuggestions && (
                    <span className="w-3 h-3 border border-purple-500 border-t-transparent rounded-full animate-spin inline-block"></span>
                  )}
                  <span>
                    {loadingSuggestions ? 'Buscando para:' : 'SugestÃµes para:'}{' '}
                    <strong>{currentFocusedTopic.title}</strong>
                    {currentFocusedTopic.category && ` (${currentFocusedTopic.category})`}
                  </span>
                </p>
              ) : (
                <p className="text-xs theme-text-muted italic">
                  Clique em um campo de "DecisÃ£o" para ver sugestÃµes de modelos
                </p>
              )}
            </div>

            {/* Campo de Busca Manual - v1.12.12 */}
            <div className="px-4 pt-3 pb-2 border-b theme-border-secondary flex-shrink-0">
              <div className="flex gap-2">
                <div className="relative flex-1">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 theme-text-muted" />
                  <input
                    type="text"
                    value={globalManualSearchTerm}
                    onChange={(e) => {
                      setGlobalManualSearchTerm(e.target.value);
                      // v1.33.19: SÃ³ faz busca textual se nÃ£o estiver em modo semÃ¢ntico
                      if (!useGlobalSemanticSearch) {
                        debouncedGlobalManualSearch(e.target.value);
                      }
                    }}
                    placeholder={useGlobalSemanticSearch ? "Busca por significado..." : "Buscar modelos..."}
                    className="w-full pl-9 pr-3 py-2 text-sm rounded theme-bg-primary border theme-border-input theme-text-primary"
                  />
                </div>
                {globalManualSearchTerm && (
                  <button
                    onClick={() => {
                      setGlobalManualSearchTerm('');
                      setGlobalManualSearchResults([]);
                    }}
                    className="px-3 py-2 theme-bg-tertiary rounded hover-slate-600 text-sm theme-text-secondary"
                    title="Limpar busca"
                  >
                    âœ•
                  </button>
                )}
                {/* v1.33.19: Toggle busca semÃ¢ntica/textual */}
                {searchModelReady && (
                  <button
                    onClick={() => {
                      setUseGlobalSemanticSearch((prev: boolean) => !prev);
                      // Limpar resultados ao alternar modo
                      setGlobalManualSearchResults([]);
                    }}
                    className={`px-2 py-1 rounded text-sm transition-colors ${
                      useGlobalSemanticSearch
                        ? 'bg-purple-600 text-white hover:bg-purple-700'
                        : 'theme-bg-tertiary theme-text-secondary hover:bg-slate-600'
                    }`}
                    title={useGlobalSemanticSearch ? 'Busca semÃ¢ntica (por significado)' : 'Busca textual (por palavras)'}
                  >
                    {useGlobalSemanticSearch ? 'ğŸ§ ' : 'ğŸ”¤'}
                  </button>
                )}
              </div>
              {globalSemanticSearching && (
                <p className="text-xs text-purple-400 mt-2 flex items-center gap-1">
                  <span className="animate-spin inline-block w-3 h-3 border border-purple-400 border-t-transparent rounded-full"></span>
                  Buscando por significado...
                </p>
              )}
              {!globalSemanticSearching && globalManualSearchTerm && globalManualSearchResults.length > 0 && (
                <p className="text-xs theme-text-muted mt-2">
                  {globalManualSearchResults.length} modelo(s) encontrado(s)
                  {useGlobalSemanticSearch && <span className="ml-1 text-purple-400">(semÃ¢ntica)</span>}
                </p>
              )}
              {!globalSemanticSearching && globalManualSearchTerm && globalManualSearchResults.length === 0 && (
                <p className="text-xs text-amber-400 mt-2">
                  Nenhum modelo encontrado para "{globalManualSearchTerm}"
                </p>
              )}
            </div>

            {/* Suggestions List - v1.12.2: Usando SuggestionCard com botÃµes Visualizar/Inserir */}
            <div className="flex-1 overflow-y-auto p-4 space-y-3">
              {/* v1.12.12: Mostrar resultados da busca manual primeiro, depois sugestÃµes automÃ¡ticas */}
              {globalManualSearchResults.length > 0 ? (
                <>
                  <p className="text-xs theme-text-muted mb-2 font-medium">Resultados da busca:</p>
                  {globalManualSearchResults.map((model, idx) => (
                    <SuggestionCard
                      key={model.id || `search-${idx}`}
                      model={model}
                      similarity={model.similarity}
                      index={idx}
                      totalSuggestions={globalManualSearchResults.length}
                      onPreview={handlePreviewModel}
                      onInsert={(content: string) => handleInsertModel(content)}
                      sanitizeHTML={sanitizeHTML}
                      showRanking={false}
                    />
                  ))}
                </>
              ) : suggestions.length > 0 ? (
                suggestions.map((model, idx) => (
                  <SuggestionCard
                    key={model.id || idx}
                    model={model}
                    similarity={model.similarity}
                    index={idx}
                    totalSuggestions={suggestions.length}
                    onPreview={handlePreviewModel}
                    onInsert={(content: string) => handleInsertModel(content)}
                    sanitizeHTML={sanitizeHTML}
                    showRanking={true}
                  />
                ))
              ) : (
                <div className="text-center py-8 theme-text-muted text-sm">
                  {loadingSuggestions ? (
                    <div className="flex flex-col items-center gap-2">
                      <div className="w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                      <span>Buscando sugestÃµes...</span>
                    </div>
                  ) : currentFocusedTopic ? (
                    <span>Nenhum modelo encontrado para este tÃ³pico</span>
                  ) : globalManualSearchTerm ? (
                    <span>Use a busca acima para encontrar modelos</span>
                  ) : (
                    <span>Clique em um campo de "DecisÃ£o" para ver sugestÃµes</span>
                  )}
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {/* Modal de ConfirmaÃ§Ã£o - Cancelar */}
      {showCancelConfirm && (
        <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
          <div
            className="absolute inset-0 bg-black/70"
            onClick={() => setShowCancelConfirm(false)}
          />
          <div className="relative theme-bg-primary rounded-lg shadow-xl border theme-border-input max-w-md w-full p-6">
            <h3 className="text-lg font-bold text-amber-400 mb-4 flex items-center gap-2">
              <AlertCircle className="w-5 h-5" />
              Descartar alteraÃ§Ãµes?
            </h3>
            <p className="theme-text-secondary mb-6">
              VocÃª tem alteraÃ§Ãµes nÃ£o salvas. Deseja descartÃ¡-las?
            </p>
            <div className="flex gap-3 justify-end">
              <button
                onClick={() => setShowCancelConfirm(false)}
                className="px-4 py-2 text-sm rounded theme-bg-tertiary theme-text-secondary hover-slate-600"
              >
                Continuar Editando
              </button>
              <button
                onClick={confirmCancel}
                className="px-4 py-2 text-sm rounded bg-red-600 text-white hover-red-700-from-600"
              >
                Descartar
              </button>
            </div>
          </div>
        </div>
      )}

      {/* v1.19.0: Modal Assistente IA Global - Chat Interativo */}
      {showAIAssistant && aiAssistantTopicIndex !== null && (
        <AIAssistantGlobalModal
          isOpen={showAIAssistant}
          onClose={() => {
            setShowAIAssistant(false);
            setAiAssistantTopicIndex(null);
            chatAssistantGlobal.clear();
          }}
          topicTitle={localTopics[aiAssistantTopicIndex]?.title}
          chatHistory={chatAssistantGlobal.history}
          onSendMessage={handleSendGlobalChatMessage}
          onInsertResponse={handleInsertGlobalChatResponse}
          generating={chatAssistantGlobal.generating}
          onClear={chatAssistantGlobal.clear}
          lastResponse={chatAssistantGlobal.lastResponse}
          contextScope={globalContextScope}
          setContextScope={setGlobalContextScope}
          sanitizeHTML={sanitizeHTML}
          quickPrompts={aiIntegration?.aiSettings?.quickPrompts}
          proofManager={proofManager}
        />
      )}

      {/* v1.12.14: Modal de Provas Vinculadas */}
      {showProofsModal && proofsModalTopicIndex !== null && (
        <LinkedProofsModal
          isOpen={showProofsModal}
          onClose={() => {
            setShowProofsModal(false);
            setProofsModalTopicIndex(null);
          }}
          topicTitle={localTopics[proofsModalTopicIndex]?.title || ''}
          linkedProofs={getLinkedProofsForTopic(localTopics[proofsModalTopicIndex]?.title || '')}
          proofManager={proofManager ? {
            proofTopicLinks: proofManager.proofTopicLinks || {},
            setProofTopicLinks: proofManager.setProofTopicLinks,
            proofAnalysisResults: proofManager.proofAnalysisResults || {},
            proofConclusions: proofManager.proofConclusions || {}
          } : {
            proofTopicLinks: {},
            setProofTopicLinks: () => {},
            proofAnalysisResults: {},
            proofConclusions: {}
          }}
        />
      )}

      {/* v1.20.0: Modal de JurisprudÃªncia (componente reutilizÃ¡vel) */}
      {/* v1.32.18: Props para busca semÃ¢ntica */}
      {/* v1.33.16: jurisSemanticEnabled para toggle interno */}
      <JurisprudenciaModal
        isOpen={showJurisModal && jurisTopicIndex !== null}
        onClose={() => { setShowJurisModal(false); setJurisTopicIndex(null); }}
        topicTitle={jurisTopicIndex !== null ? localTopics[jurisTopicIndex]?.title : undefined}
        topicRelatorio={jurisTopicIndex !== null ? (localTopics[jurisTopicIndex]?.editedRelatorio || localTopics[jurisTopicIndex]?.relatorio) : undefined}
        callAI={aiIntegration?.callAI}
        useLocalAI={useLocalAIForJuris && searchModelReady && jurisEmbeddingsCount > 0}
        jurisSemanticThreshold={jurisSemanticThreshold}
        jurisSemanticEnabled={searchModelReady && jurisEmbeddingsCount > 0}
      />

      {/* v1.36.21: Modal de Confronto de Fatos (usando BaseModal) */}
      <BaseModal
        isOpen={showFactsComparison && factsComparisonTopicIndex !== null}
        onClose={() => {
          setShowFactsComparison(false);
          setFactsComparisonTopicIndex(null);
          setFactsComparisonResult(null);
          setFactsComparisonError(null);
        }}
        title="Confronto de Fatos"
        subtitle={factsComparisonTopicIndex !== null ? localTopics[factsComparisonTopicIndex]?.title || '' : ''}
        icon={<Scale />}
        iconColor="yellow"
        size="xl"
        preventClose={generatingFactsComparison}
      >
        <FactsComparisonModalContent
          topicTitle={factsComparisonTopicIndex !== null ? localTopics[factsComparisonTopicIndex]?.title || '' : ''}
          topicRelatorio={factsComparisonTopicIndex !== null ? (localTopics[factsComparisonTopicIndex]?.editedRelatorio || localTopics[factsComparisonTopicIndex]?.relatorio) : undefined}
          hasPeticao={(analyzedDocuments?.peticoesText?.length || 0) > 0 || !!analyzedDocuments?.peticao}
          hasContestacao={(analyzedDocuments?.contestacoesText?.length || 0) > 0 || (analyzedDocuments?.contestacoes?.length || 0) > 0}
          onGenerate={handleGenerateFactsComparison}
          cachedResult={factsComparisonResult}
          isGenerating={generatingFactsComparison}
          error={factsComparisonError}
        />
      </BaseModal>
    </div>
  );
};

// Prepara array de documentos para envio Ã  API de IA
// v1.25: Adicionado cache_control para otimizaÃ§Ã£o de tokens
const prepareDocumentsContext = (docs: { peticao?: string; peticaoType?: string; contestacoes?: string[]; contestacoesText?: { text: string }[]; complementares?: string[]; complementaresText?: { text: string }[] }) => {
  const contentArray: AIMessageContent[] = [];

  if (docs.peticao) {
    contentArray.push(docs.peticaoType === 'pdf'
      ? { type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: docs.peticao }, cache_control: docs.peticao.length > 100000 ? { type: "ephemeral" } : undefined }
      : { type: 'text', text: `PETIÃ‡ÃƒO INICIAL:\n\n${docs.peticao}`, cache_control: docs.peticao.length > 2000 ? { type: "ephemeral" } : undefined });
  }

  docs.contestacoes?.forEach((base64: string) => {
    contentArray.push({ type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: base64 }, cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined });
  });

  docs.contestacoesText?.forEach((contestacao: { text: string }, index: number) => {
    contentArray.push({ type: 'text', text: `CONTESTAÃ‡ÃƒO ${index + 1 + (docs.contestacoes?.length || 0)}:\n\n${contestacao.text}`, cache_control: contestacao.text.length > 2000 ? { type: "ephemeral" } : undefined });
  });

  docs.complementares?.forEach((base64: string) => {
    contentArray.push({ type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: base64 }, cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined });
  });

  docs.complementaresText?.forEach((doc: { text: string }, index: number) => {
    contentArray.push({ type: 'text', text: `DOCUMENTO COMPLEMENTAR ${index + 1 + (docs.complementares?.length || 0)}:\n\n${doc.text}`, cache_control: doc.text.length > 2000 ? { type: "ephemeral" } : undefined });
  });

  return {
    contentArray,
    flags: {
      hasPeticao: !!docs.peticao,
      hasContestacoes: (docs.contestacoes?.length || 0) + (docs.contestacoesText?.length || 0) > 0,
      hasComplementares: (docs.complementares?.length || 0) + (docs.complementaresText?.length || 0) > 0
    }
  };
};

// ğŸ†• v1.19.5: Prepara contexto de provas vinculadas para envio Ã  API de IA
// v1.19.2: Adicionado anonymizationEnabled para bloquear PDF binÃ¡rio
// v1.21.5: Adicionado anonConfig para anonimizar texto extraÃ­do ao enviar
const prepareProofsContext = async (proofManager: { proofTopicLinks?: Record<string, string[]>; proofFiles?: ProofFile[]; proofTexts?: ProofText[]; proofUsePdfMode?: Record<string, boolean>; extractedProofTexts?: Record<string, string>; proofAnalysisResults?: Record<string, { type: string; result: string }>; proofConclusions?: Record<string, string>; proofSendFullContent?: Record<string, boolean> } | null, topicTitle: string, fileToBase64Fn: (file: File) => Promise<string>, anonymizationEnabled = false, anonConfig: AnonymizationSettings | null = null) => {
  if (!proofManager) return { proofDocuments: [] as AIMessageContent[], proofsContext: '', hasProofs: false };

  const proofTopicLinks = proofManager.proofTopicLinks || {};
  const linkedProofIds = Object.keys(proofTopicLinks).filter(proofId =>
    proofTopicLinks[proofId]?.includes(topicTitle)
  );

  const linkedProofs = [
    ...(proofManager.proofFiles || []).filter((p: ProofFile) => linkedProofIds.includes(String(p.id))),
    ...(proofManager.proofTexts || []).filter((p: ProofText) => linkedProofIds.includes(String(p.id)))
  ];

  // v1.21.13: Filtrar provas CONFLITO quando anonimizaÃ§Ã£o ativa
  // - CONFLITO: proofUsePdfMode=true + anon ativa (usuÃ¡rio quer PDF mas anon exige texto)
  // - Sem texto extraÃ­do + anon ativa (impossÃ­vel anonimizar)
  const filteredProofs = linkedProofs.filter(proof => {
    const isPdf = proofManager.proofFiles?.some((p: ProofFile) => p.id === proof.id);
    if (anonymizationEnabled && isPdf) {
      // CONFLITO: usuÃ¡rio escolheu "Usar PDF" mas anonimizaÃ§Ã£o estÃ¡ ativa
      if (proofManager.proofUsePdfMode?.[proof.id]) {
        return false;
      }
      // Sem texto extraÃ­do: impossÃ­vel anonimizar
      if (!proofManager.extractedProofTexts?.[proof.id]) {
        return false;
      }
    }
    return true;
  });

  if (filteredProofs.length === 0) {
    return { proofDocuments: [] as AIMessageContent[], proofsContext: '', hasProofs: false };
  }

  const proofDocuments: AIMessageContent[] = [];
  let proofsContext = '\n\nğŸ” PROVAS VINCULADAS A ESTE TÃ“PICO:\n\n';

  for (let index = 0; index < filteredProofs.length; index++) {
    const proof = filteredProofs[index];
    const proofId = proof.id;
    const isPdf = proofManager.proofFiles?.some((p: ProofFile) => p.id === proof.id);

    proofsContext += `PROVA ${index + 1}: ${proof.name}\n`;

    // AnÃ¡lise IA
    if (proofManager.proofAnalysisResults?.[proofId]) {
      const typeLabel = proofManager.proofAnalysisResults[proofId].type === 'livre' ? 'Livre' : 'Contextual';
      proofsContext += `\nAnÃ¡lise ${typeLabel}:\n${proofManager.proofAnalysisResults[proofId].result}\n`;
    }

    // ConclusÃµes do juiz
    if (proofManager.proofConclusions?.[proofId]) {
      proofsContext += `\nConclusÃµes do Juiz:\n${proofManager.proofConclusions[proofId]}\n`;
    }

    // ConteÃºdo completo (se flag ativada) - v1.21.15: Respeita proofUsePdfMode (escolha visual do usuÃ¡rio)
    if (proofManager.proofSendFullContent?.[proofId]) {
      if (isPdf) {
        const usePdfMode = proofManager.proofUsePdfMode?.[proofId];
        const fullText = proofManager.extractedProofTexts?.[proofId];

        if (usePdfMode || !fullText) {
          // UsuÃ¡rio escolheu "Usar PDF" OU nÃ£o hÃ¡ texto extraÃ­do â†’ enviar PDF binÃ¡rio
          if (anonymizationEnabled) {
            // Anon ativa: fallback para texto extraÃ­do (se existir)
            if (fullText) {
              const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
              const textToSend = anonymizeText(fullText, anonConfig, nomesParaAnonimizar);
              proofsContext += `\nConteÃºdo Completo da Prova:\n${textToSend}\n`;
            } else {
              proofsContext += `\n[PDF "${proof.name}" nÃ£o anexado - anonimizaÃ§Ã£o ativa e texto nÃ£o extraÃ­do]\n`;
            }
          } else if (proof.file && fileToBase64Fn) {
            // Anon desligada: enviar PDF binÃ¡rio
            // v1.25: Adicionado cache_control para otimizaÃ§Ã£o de tokens
            const base64 = await fileToBase64Fn(proof.file);
            proofDocuments.push({
              type: 'document',
              source: { type: 'base64', media_type: 'application/pdf', data: base64 },
              cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
            });
            proofsContext += `\n[PDF "${proof.name}" anexado como documento]\n`;
          }
        } else {
          // UsuÃ¡rio escolheu "Usar Texto" â†’ enviar texto extraÃ­do
          const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
          const textToSend = (anonymizationEnabled && anonConfig)
            ? anonymizeText(fullText, anonConfig, nomesParaAnonimizar)
            : fullText;
          proofsContext += `\nConteÃºdo Completo da Prova:\n${textToSend}\n`;
        }
      } else if (proof.text) {
        // v1.21.5: Anonimizar texto colado ao enviar
        const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
        const textToSend = (anonymizationEnabled && anonConfig)
          ? anonymizeText(proof.text, anonConfig, nomesParaAnonimizar)
          : proof.text;
        proofsContext += `\nConteÃºdo Completo da Prova:\n${textToSend}\n`;
      }
    }

    proofsContext += '\n---\n\n';
  }

  return { proofDocuments, proofsContext, hasProofs: true };
};

// ğŸ†• v1.21.1: Prepara contexto APENAS de provas orais vinculadas (isOralProof definido antes dos componentes)
// v1.21.5: Adicionado anonConfig para anonimizar texto extraÃ­do ao enviar
const prepareOralProofsContext = async (proofManager: { proofTopicLinks?: Record<string, string[]>; proofFiles?: ProofFile[]; proofTexts?: ProofText[]; proofUsePdfMode?: Record<string, boolean>; extractedProofTexts?: Record<string, string>; proofAnalysisResults?: Record<string, { type: string; result: string }>; proofConclusions?: Record<string, string>; proofSendFullContent?: Record<string, boolean> } | null, topicTitle: string, fileToBase64Fn: (file: File) => Promise<string>, anonymizationEnabled = false, anonConfig: AnonymizationSettings | null = null) => {
  if (!proofManager) return { proofDocuments: [] as AIMessageContent[], proofsContext: '', hasProofs: false, noOralProofFound: true };

  const proofTopicLinks = proofManager.proofTopicLinks || {};
  const linkedProofIds = Object.keys(proofTopicLinks).filter(proofId =>
    proofTopicLinks[proofId]?.includes(topicTitle)
  );

  const allLinkedProofs = [
    ...(proofManager.proofFiles || []).filter((p: ProofFile) => linkedProofIds.includes(String(p.id))),
    ...(proofManager.proofTexts || []).filter((p: ProofText) => linkedProofIds.includes(String(p.id)))
  ];

  // Filtrar apenas provas orais
  const linkedOralProofs = allLinkedProofs.filter(p => isOralProof(p.name));

  // v1.21.13: Filtrar provas CONFLITO quando anonimizaÃ§Ã£o ativa
  const filteredProofs = linkedOralProofs.filter(proof => {
    const isPdf = proofManager.proofFiles?.some((p: ProofFile) => p.id === proof.id);
    if (anonymizationEnabled && isPdf) {
      if (proofManager.proofUsePdfMode?.[proof.id]) {
        return false; // CONFLITO: usuÃ¡rio quer PDF mas anon exige texto
      }
      if (!proofManager.extractedProofTexts?.[proof.id]) {
        return false; // Sem texto extraÃ­do: impossÃ­vel anonimizar
      }
    }
    return true;
  });

  if (filteredProofs.length === 0) {
    return { proofDocuments: [] as AIMessageContent[], proofsContext: '', hasProofs: false, noOralProofFound: true };
  }

  const proofDocuments: AIMessageContent[] = [];
  let proofsContext = '\n\nğŸ¤ PROVAS ORAIS VINCULADAS A ESTE TÃ“PICO:\n\n';

  for (let index = 0; index < filteredProofs.length; index++) {
    const proof = filteredProofs[index];
    const proofId = proof.id;
    const isPdf = proofManager.proofFiles?.some(p => p.id === proof.id);

    proofsContext += `PROVA ORAL ${index + 1}: ${proof.name}\n`;

    if (proofManager.proofAnalysisResults?.[proofId]) {
      const typeLabel = proofManager.proofAnalysisResults[proofId].type === 'livre' ? 'Livre' : 'Contextual';
      proofsContext += `\nAnÃ¡lise ${typeLabel}:\n${proofManager.proofAnalysisResults[proofId].result}\n`;
    }

    if (proofManager.proofConclusions?.[proofId]) {
      proofsContext += `\nConclusÃµes do Juiz:\n${proofManager.proofConclusions[proofId]}\n`;
    }

    // v1.21.15: Respeita proofUsePdfMode (escolha visual do usuÃ¡rio)
    if (proofManager.proofSendFullContent?.[proofId]) {
      if (isPdf) {
        const usePdfMode = proofManager.proofUsePdfMode?.[proofId];
        const fullText = proofManager.extractedProofTexts?.[proofId];

        if (usePdfMode || !fullText) {
          // UsuÃ¡rio escolheu "Usar PDF" OU nÃ£o hÃ¡ texto extraÃ­do â†’ enviar PDF binÃ¡rio
          if (anonymizationEnabled) {
            // Anon ativa: fallback para texto extraÃ­do (se existir)
            if (fullText) {
              const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
              const textToSend = anonymizeText(fullText, anonConfig, nomesParaAnonimizar);
              proofsContext += `\nConteÃºdo Completo da Prova:\n${textToSend}\n`;
            } else {
              proofsContext += `\n[PDF "${proof.name}" nÃ£o anexado - anonimizaÃ§Ã£o ativa e texto nÃ£o extraÃ­do]\n`;
            }
          } else if (proof.file && fileToBase64Fn) {
            // Anon desligada: enviar PDF binÃ¡rio
            // v1.25: Adicionado cache_control para otimizaÃ§Ã£o de tokens
            const base64 = await fileToBase64Fn(proof.file);
            proofDocuments.push({
              type: 'document',
              source: { type: 'base64', media_type: 'application/pdf', data: base64 },
              cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
            });
            proofsContext += `\n[PDF "${proof.name}" anexado como documento]\n`;
          }
        } else {
          // UsuÃ¡rio escolheu "Usar Texto" â†’ enviar texto extraÃ­do
          const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
          const textToSend = (anonymizationEnabled && anonConfig)
            ? anonymizeText(fullText, anonConfig, nomesParaAnonimizar)
            : fullText;
          proofsContext += `\nConteÃºdo Completo da Prova:\n${textToSend}\n`;
        }
      } else if (proof.text) {
        // Anonimizar texto colado ao enviar
        const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
        const textToSend = (anonymizationEnabled && anonConfig)
          ? anonymizeText(proof.text, anonConfig, nomesParaAnonimizar)
          : proof.text;
        proofsContext += `\nConteÃºdo Completo da Prova:\n${textToSend}\n`;
      }
    }

    proofsContext += '\n---\n\n';
  }

  return { proofDocuments, proofsContext, hasProofs: true, noOralProofFound: false };
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âœï¸ SEÃ‡ÃƒO 6: QUILL EDITOR
// QuillEditorBase, QuillModelEditor, QuillDecisionEditor, QuillMiniRelatorioEditor
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸ”§ QUILL.JS UTILITY FUNCTIONS (v1.4.0 - FASE 4)
// FunÃ§Ãµes utilitÃ¡rias puras para Quill.js - definidas em escopo global

// Retorna configuraÃ§Ã£o de toolbar do Quill.js
const getQuillToolbarConfig = (type = 'full') => {
  const configs: Record<string, unknown> = {
    // Toolbar completa para editor de decisÃ£o (28 opÃ§Ãµes)
    full: [
      [{ 'header': [1, 2, 3, 4, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      [{ 'align': [] }],
      [{ 'list': 'ordered'}, { 'list': 'bullet' }],
      [{ 'indent': '-1'}, { 'indent': '+1' }],
      ['blockquote'],
      ['clean']
    ],
    // Toolbar simplificada para editor de modelos (15 opÃ§Ãµes)
    simple: [
      [{ 'header': [1, 2, 3, false] }],
      ['bold', 'italic', 'underline'],
      [{ 'align': [] }],
      [{ 'list': 'ordered'}, { 'list': 'bullet' }],
      ['clean']
    ],
    // Toolbar mÃ­nima ou desabilitada para mini-relatÃ³rio
    minimal: false
  };

  return configs[type] || configs.full;
};

// Sanitiza HTML gerado pelo Quill.js
const sanitizeQuillHTML = (html: string) => {
  // Verificar se DOMPurify estÃ¡ disponÃ­vel (nÃ£o depende de estado React)
  if (!window.DOMPurify) {
    return html || '';
  }

  // Se vazio, retornar string vazia
  if (!html || html.trim() === '') {
    return '';
  }

  const cleanHTML = window.DOMPurify.sanitize(html, {
    ALLOWED_TAGS: [
      'p', 'br', 'div', 'span',                // Estrutura
      'strong', 'b', 'em', 'i', 'u', 's',      // FormataÃ§Ã£o
      'ul', 'ol', 'li',                         // Listas
      'h1', 'h2', 'h3', 'h4', 'h5', 'h6',      // CabeÃ§alhos
      'a', 'blockquote',                        // Extras Quill
      'pre', 'code'                             // Code blocks (futuro)
    ],
    ALLOWED_ATTR: [
      'href', 'target', 'rel',                  // Links
      'class',                                  // Classes do Quill (ql-*)
      'style',                                  // Estilos inline
      'data-list'                               // v1.36.6: Tipo de lista (bullet/ordered)
    ],
    ALLOWED_STYLES: {
      '*': {
        'text-align': [/^(left|center|right|justify)$/],  // Alinhamento
        'font-weight': [/^bold$/],
        'font-style': [/^italic$/],
        'text-decoration': [/^(underline|line-through)$/]
      }
    },
    KEEP_CONTENT: true,
    RETURN_TRUSTED_TYPE: false
  });

  return cleanHTML;
};

// ğŸ”§ HOOK COMPARTILHADO: useQuillEditor (v1.9.12)
// Centraliza lÃ³gica comum dos editores Quill (keyboard bindings, refs, topic detection)
interface UseQuillEditorOptions {
  ref?: React.ForwardedRef<QuillInstance> | React.MutableRefObject<QuillInstance | null>;
  onSaveWithoutClosing?: () => void;
  enableCtrlS?: boolean;
  topicTitle?: string;
  content?: string;
  enableTopicChangeDetection?: boolean;
}
const useQuillEditor = (options: UseQuillEditorOptions = {}) => {
  const {
    ref,
    onSaveWithoutClosing,
    enableCtrlS = false,
    topicTitle,
    content,
    enableTopicChangeDetection = false
  } = options;

  const quillInstanceRef = React.useRef<QuillInstance | null>(null);
  const lastTopicTitle = React.useRef<string | null>(null);

  // Keyboard bindings: Ctrl+S para salvar
  const customModules = React.useMemo(() => {
    if (!enableCtrlS) return {};

    return {
      keyboard: {
        bindings: {
          save: {
            key: 'S',
            ctrlKey: true,
            handler: () => {
              if (onSaveWithoutClosing) {
                onSaveWithoutClosing();
              }
              return false; // Prevenir default
            }
          }
        }
      }
    };
  }, [enableCtrlS, onSaveWithoutClosing]);

  // Ref handling: Expor instÃ¢ncia Quill via ref
  const handleQuillReady = React.useCallback((quillInstance: QuillInstance) => {
    quillInstanceRef.current = quillInstance;

    // Expor instÃ¢ncia via ref
    if (ref) {
      if (typeof ref === 'function') {
        ref(quillInstance);
      } else {
        ref.current = quillInstance;
      }
    }
  }, [ref]);

  // Topic change detection: Atualizar conteÃºdo quando trocar de tÃ³pico
  React.useEffect(() => {
    if (!enableTopicChangeDetection || !quillInstanceRef.current) return;

    // Se mudou de tÃ³pico
    if (topicTitle !== lastTopicTitle.current) {
      try {
        const sanitized = sanitizeQuillHTML(content || '');
        quillInstanceRef.current.root.innerHTML = sanitized;
        lastTopicTitle.current = topicTitle ?? null;
      } catch (error) {
      }
    }
  }, [enableTopicChangeDetection, topicTitle, content]);

  const refreshQuill = React.useCallback(() => {
    if (quillInstanceRef.current) {
      quillInstanceRef.current.update('silent');
    }
  }, []);

  return {
    quillInstanceRef,
    customModules,
    handleQuillReady,
    refreshQuill
  };
};

// v1.35.94: Tipagem correta com QuillEditorBaseProps
const QuillEditorBase = React.forwardRef<QuillInstance, QuillEditorBaseProps>(({
  content = '',
  onChange,
  onReady,
  onSelectionChange,
  onSlashCommand,
  toolbarConfig = null,
  placeholder = 'Digite aqui...',
  readOnly = false,
  className = '',
  theme = 'snow',
  modules = {},
  quillReady = false,
  quillError = null
}, quillRef) => {
  const containerRef = React.useRef<HTMLDivElement | null>(null);
  const quillInstanceRef = React.useRef<QuillInstance | null>(null);
  const isInitializedRef = React.useRef<boolean>(false);
  const lastContentRef = React.useRef<string>('');
  const copyHandlerRef = React.useRef<((e: ClipboardEvent) => void) | null>(null);
  const copyListenerAddedRef = React.useRef<boolean>(false); // v1.20.2: Guard contra listeners duplicados
  const onSlashCommandRef = React.useRef(onSlashCommand);
  const onChangeDebounceRef = React.useRef<ReturnType<typeof setTimeout> | null>(null); // v1.35.3: Debounce para onChange

  // v1.15.4: Manter ref atualizada para slash command
  React.useEffect(() => {
    onSlashCommandRef.current = onSlashCommand;
  }, [onSlashCommand]);

  // InicializaÃ§Ã£o do Quill (apenas uma vez)
  React.useEffect(() => {
    // Aguardar Quill estar disponÃ­vel
    if (!quillReady || !window.Quill) {
      return;
    }

    // Prevenir re-inicializaÃ§Ã£o
    if (isInitializedRef.current || !containerRef.current) {
      return;
    }

    // v1.30 FIX: Destruir qualquer instÃ¢ncia Quill existente no container
    // NecessÃ¡rio porque React.StrictMode (React 18+) causa mount â†’ unmount â†’ remount
    // O cleanup pode nÃ£o limpar corretamente se containerRef mudou entre unmount e remount
    const existingQuill = window.Quill?.find?.(containerRef.current);
    if (existingQuill) {
      try {
        existingQuill.off('text-change');
        existingQuill.off('selection-change');
      } catch (e) {}
    }
    // Limpar container COMPLETAMENTE (remove toolbar Ã³rfÃ£)
    containerRef.current.innerHTML = '';

    try {
      // ConfiguraÃ§Ã£o de mÃ³dulos Quill
      const quillModules = {
        toolbar: toolbarConfig !== null ? toolbarConfig : false,
        clipboard: {
          matchVisual: false // Melhor paste handling
        },
        ...modules
      };

      // Inicializar Quill
      quillInstanceRef.current = new window.Quill(containerRef.current, {
        theme: theme,
        placeholder: placeholder,
        readOnly: readOnly,
        modules: quillModules
      });

      // Setar conteÃºdo inicial
      if (content) {
        const finalContent = sanitizeQuillHTML(content);
        quillInstanceRef.current.root.innerHTML = finalContent;
        lastContentRef.current = finalContent;
      }

      // Event listener - mudanÃ§as de texto
      // v1.35.3: Debounce para evitar lag durante digitaÃ§Ã£o rÃ¡pida
      quillInstanceRef.current.on('text-change', ((delta: unknown, _oldDelta: unknown, source: string) => {
        // v1.15.4: Detectar "\" para slash command (SEM debounce - precisa ser imediato)
        if (source === 'user' && onSlashCommandRef.current) {
          const ops = (delta as QuillDelta).ops || [];
          const lastOp = ops[ops.length - 1];
          if (typeof lastOp?.insert === 'string' && lastOp.insert.endsWith('\\')) {
            const quill = quillInstanceRef.current;
            if (!quill) return;
            const range = quill.getSelection();
            if (range) {
              const bounds = quill.getBounds(range.index);
              const rect = containerRef.current?.getBoundingClientRect();
              if (rect) {
                onSlashCommandRef.current({
                  position: {
                    top: rect.top + bounds.top + bounds.height + 5,
                    left: rect.left + bounds.left
                  },
                  quillInstance: quill,
                  triggerPosition: range.index - 1
                });
              }
            }
          }
        }

        // v1.35.3: Debounce onChange e sanitizaÃ§Ã£o (150ms)
        // Isso evita re-renders excessivos e DOMPurify a cada keystroke
        if (onChangeDebounceRef.current) {
          clearTimeout(onChangeDebounceRef.current);
        }
        onChangeDebounceRef.current = setTimeout(() => {
          const html = quillInstanceRef.current?.root?.innerHTML;
          if (!html) return;
          const finalHTML = sanitizeQuillHTML(html);

          // Evitar loops de onChange
          if (finalHTML !== lastContentRef.current) {
            lastContentRef.current = finalHTML;
            if (onChange) {
              onChange(finalHTML);
            }
          }
        }, 150);
      }) as (...args: unknown[]) => void);

      // Event listener - mudanÃ§a de seleÃ§Ã£o (v1.11.3: para detectar seÃ§Ã£o atual)
      if (onSelectionChange) {
        quillInstanceRef.current.on('selection-change', ((range: { index: number; length: number } | null, oldRange: { index: number; length: number } | null, source: string) => {
          onSelectionChange(range, oldRange, source);
        }) as (...args: unknown[]) => void);
      }

      // Handler de clipboard - converter classes de indentaÃ§Ã£o em estilos inline ao copiar
      copyHandlerRef.current = (e) => {
        const selection = window.getSelection();
        if (!selection || !selection.rangeCount) return;

        // Obter HTML selecionado
        const range = selection.getRangeAt(0);
        const container = document.createElement('div');
        container.appendChild(range.cloneContents());

        // Converter classes de indentaÃ§Ã£o em estilos inline
        const indentElements = container.querySelectorAll('[class*="ql-indent-"]');
        indentElements.forEach(el => {
          const classList = Array.from(el.classList);
          const indentClass = classList.find(cls => cls.startsWith('ql-indent-'));
          if (indentClass && el instanceof HTMLElement) {
            const level = parseInt(indentClass.replace('ql-indent-', ''));
            const marginLeft = `${level * 3}em`;
            el.style.marginLeft = marginLeft;
            el.classList.remove(indentClass); // Remover classe
          }
        });

        // Copiar HTML com estilos inline
        if (e.clipboardData) {
          e.clipboardData.setData('text/html', container.innerHTML);
          e.clipboardData.setData('text/plain', selection.toString());
        }
        e.preventDefault();
      };
      // v1.20.2: Guard para evitar listeners duplicados
      if (!copyListenerAddedRef.current) {
        quillInstanceRef.current.root.addEventListener('copy', copyHandlerRef.current);
        copyListenerAddedRef.current = true;
      }

      // Expor instÃ¢ncia via ref
      if (quillRef) {
        if (typeof quillRef === 'function') {
          quillRef(quillInstanceRef.current);
        } else {
          quillRef.current = quillInstanceRef.current;
        }
      }

      // Callback onReady
      if (onReady) {
        onReady(quillInstanceRef.current);
      }

      isInitializedRef.current = true;

    } catch (error) {
    }

  }, [quillReady]); // Depende apenas de quillReady

  // Atualizar conteÃºdo quando props.content mudar externamente
  // (ex: trocar de tÃ³pico, carregar novo modelo)
  React.useEffect(() => {
    if (!quillInstanceRef.current) return;

    const currentHTML = quillInstanceRef.current.root.innerHTML;
    const newContent = sanitizeQuillHTML(content || '');

    // Atualizar apenas se o conteÃºdo realmente mudou (evitar loops)
    if (newContent !== currentHTML && newContent !== lastContentRef.current) {
      try {
        // Atualizar conteÃºdo
        quillInstanceRef.current.root.innerHTML = newContent;
        lastContentRef.current = newContent;

        // A seleÃ§Ã£o serÃ¡ recriada naturalmente quando o usuÃ¡rio interagir
      } catch (error) {
      }
    }
  }, [content]);

  // Atualizar readOnly mode
  React.useEffect(() => {
    if (quillInstanceRef.current) {
      quillInstanceRef.current.enable(!readOnly);
    }
  }, [readOnly]);

  // Cleanup - v1.9.27: Destruir Quill ao desmontar componente
  React.useEffect(() => {
    return () => {
      if (quillInstanceRef.current) {
        // Remover event listeners
        quillInstanceRef.current.off('text-change');
        quillInstanceRef.current.off('selection-change');
        if (copyHandlerRef.current) {
          quillInstanceRef.current.root?.removeEventListener('copy', copyHandlerRef.current);
        }
        // v1.20.2: Reset guard para permitir re-adicionar listener em nova instÃ¢ncia
        copyListenerAddedRef.current = false;
        // Limpar referÃªncia
        quillInstanceRef.current = null;
      }
      // Limpar o container (remove toolbar duplicada)
      if (containerRef.current) {
        containerRef.current.innerHTML = '';
      }
      isInitializedRef.current = false;
    };
  }, []);

  // RenderizaÃ§Ã£o
  if (!quillReady) {
    return (
      <div className={`theme-bg-primary border theme-border-input rounded-lg p-4 ${className}`}>
        <p className="theme-text-muted text-center">
          â³ Carregando editor Quill.js...
        </p>
      </div>
    );
  }

  if (quillError) {
    return (
      <div className={`bg-red-900/20 border border-red-600 rounded-lg p-4 ${className}`}>
        <p className="text-red-400 text-sm">
          âŒ {quillError instanceof Error ? quillError.message : quillError}
        </p>
        <p className="theme-text-muted text-xs mt-2">
          Usando editor alternativo. Verifique sua conexÃ£o com a internet.
        </p>
      </div>
    );
  }

  return (
    <div
      ref={containerRef}
      className={className}
      style={{ minHeight: '150px', height: '100%' }}
    />
  );
});

QuillEditorBase.displayName = 'QuillEditorBase';

// QuillModelEditor - Editor para modelos/templates
// v1.35.94: Tipagem correta com QuillModelEditorProps
const QuillModelEditor = React.forwardRef<QuillInstance, QuillModelEditorProps>(({
  content,
  onChange,
  onSaveWithoutClosing,
  onOpenAIAssistant,
  toolbarRef,
  quillReady = false,
  quillError = null,
  editorTheme,
  toggleEditorTheme
}, ref) => {
  const { quillInstanceRef, customModules, handleQuillReady } = useQuillEditor({
    ref,
    onSaveWithoutClosing,
    enableCtrlS: true
  });

  const { spacing, setSpacing } = useSpacingControl();

  const { fontSize, setFontSize } = useFontSizeControl();

  const { isFullscreen, toggleFullscreen, containerRef } = useFullscreen();

  // Estilos injetados globalmente no componente principal (apÃ³s Quill carregar)

  // Configurar toolbar completa para modelos (full = 28 opÃ§Ãµes)
  const toolbarConfig = React.useMemo(() => getQuillToolbarConfig('full'), []);

  // v1.35.61: Handler para Voice-to-Text - insere texto na posiÃ§Ã£o do cursor
  const handleVoiceTranscript = React.useCallback((text: string) => {
    const quill = quillInstanceRef.current;
    if (quill) {
      requestAnimationFrame(() => {
        const range = quill.getSelection() || { index: quill.getLength() - 1 };
        quill.insertText(range.index, text + ' ');
        quill.setSelection(range.index + text.length + 1);
      });
    }
  }, []);

  return (
    <div ref={containerRef} className={isFullscreen ? 'editor-fullscreen' : ''}>
      {/* v1.9.36: Wrapper interno como QuillDecisionEditor */}
      <div className={isFullscreen ? 'flex flex-col flex-1 min-h-0' : ''}>
        {!isFullscreen && (
          <label className={CSS.label}>
            ConteÃºdo
          </label>
        )}

        {/* BotÃµes Customizados (acima do editor) */}
        {/* v1.9.36: Adicionado flex-wrap e flex-shrink-0 */}
        <div className="flex flex-wrap gap-2 mb-2 flex-shrink-0">
        {/* BotÃ£o Salvar */}
        <button
          onClick={onSaveWithoutClosing}
          className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-green-600 hover-green-700-from-600"
          title="Salvar (Ctrl+S)"
        >
          <Save className="w-3.5 h-3.5" />
          Salvar
        </button>

        {/* v1.35.61: BotÃ£o Voice-to-Text */}
        <VoiceButton
          onTranscript={handleVoiceTranscript}
          size="md"
          onError={(err: unknown) => console.warn('[VoiceToText]', err)}
        />

        {/* BotÃ£o Assistente IA */}
        {onOpenAIAssistant && (
          <button
            onClick={onOpenAIAssistant}
            className="hover-purple-700 px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-purple-600"
            title="Assistente de IA"
          >
            <Sparkles className="w-3.5 h-3.5" />
            Assistente IA
          </button>
        )}

        {/* v1.9.20: BotÃ£o Fullscreen */}
        <button
          onClick={toggleFullscreen}
          className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 theme-bg-tertiary hover-slate-500"
          title={isFullscreen ? 'Sair do Fullscreen (ESC ou Ctrl+F)' : 'Tela Cheia (Ctrl+F)'}
        >
          {isFullscreen ? (
            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          ) : (
            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg>
          )}
        </button>

        {/* v1.9.11: Dropdown de EspaÃ§amento + v1.10.8: Tamanho de Fonte */}
        <div className="ml-auto flex items-center gap-4">
          <div className="flex items-center gap-2">
            <span className={CSS.textMuted}>Fonte:</span>
            <FontSizeDropdown
              value={fontSize}
              onChange={setFontSize}
              ariaLabel="Tamanho da fonte do editor de modelos"
            />
          </div>
          <div className="flex items-center gap-2">
            <span className={CSS.textMuted}>EspaÃ§amento:</span>
            <SpacingDropdown
              value={spacing}
              onChange={setSpacing}
              ariaLabel="EspaÃ§amento do editor de modelos"
            />
          </div>
        </div>
      </div>

      {/* Editor Quill (com toolbar sticky e scroll interno) */}
      {/* v1.9.35: Alinhado com QuillDecisionEditor - key forÃ§a recriaÃ§Ã£o DOM */}
      <div
        key={isFullscreen ? 'model-fullscreen-wrapper' : 'model-normal-wrapper'}
        className={`fontsize-${fontSize} spacing-${spacing} ${editorTheme === 'light' ? 'quill-light-theme bg-white' : 'theme-bg-primary'} border theme-border-input rounded-lg ${isFullscreen ? 'fullscreen-editor-wrapper' : ''}`}
      >
        <QuillEditorBase
          content={content}
          onChange={onChange}
          onReady={handleQuillReady}
          toolbarConfig={toolbarConfig}
          modules={customModules}
          placeholder="Digite o conteÃºdo do modelo..."
          className={isFullscreen ? 'fullscreen-quill-fill' : 'min-h-[300px] max-h-[80vh]'}
          quillReady={quillReady}
          quillError={quillError}
        />
      </div>
      </div>
      {/* v1.9.36: Fecha wrapper interno */}
    </div>
  );
});

QuillModelEditor.displayName = 'QuillModelEditor';

// QuillDecisionEditor - Editor para decisÃµes judiciais
// v1.15.4: Adicionado onSlashCommand
// v1.35.94: Tipagem correta com QuillDecisionEditorProps
const QuillDecisionEditor = React.forwardRef<QuillInstance, QuillDecisionEditorProps>(({
  content = '',
  onChange,
  onSaveWithoutClosing,
  onOpenAIAssistant,
  onOpenJurisModal,
  onExtractModel,
  onSaveAsModel,
  extractingModel = false,
  showExtractButton = false,
  label = 'âœï¸ Sua DecisÃ£o:',
  placeholder = 'Digite aqui sua decisÃ£o...',
  topicTitle = '',
  topicCategory = '',
  quillReady = false,
  quillError = null,
  onRegenerate,
  customInstruction = '',
  onInstructionChange,
  regenerating = false,
  showRegenerateSection = false,
  editorTheme,
  toggleEditorTheme,
  models = [],
  onInsertModel,
  onPreviewModel,
  sanitizeHTML,
  topicRelatorio = '',
  onFindSuggestions,
  onSlashCommand,
  isDirty = false,
  versioning = null,
  onBlur = null,
  onOpenFactsComparison = null // v1.36.21: Confronto de Fatos
}, ref) => {
  const { quillInstanceRef, customModules, handleQuillReady } = useQuillEditor({
    ref,
    onSaveWithoutClosing,
    enableCtrlS: true,
    topicTitle,
    content,
    enableTopicChangeDetection: true
  });

  const { spacing, setSpacing } = useSpacingControl();

  const { fontSize, setFontSize } = useFontSizeControl();

  const { isFullscreen, toggleFullscreen, isSplitMode, toggleSplitMode, splitPosition, handleSplitDrag, containerRef } = useFullscreen();

  const [isDragging, setIsDragging] = React.useState(false);

  const startDrag = React.useCallback((e: React.MouseEvent) => {
    setIsDragging(true);
    e.preventDefault();
  }, []);

  React.useEffect(() => {
    if (!isDragging) return;

    const handleMouseMove = (e: MouseEvent) => {
      handleSplitDrag(e);
    };

    const handleMouseUp = () => {
      setIsDragging(false);
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);

    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [isDragging, handleSplitDrag]);

  // v1.24: Listener de blur para versionamento
  React.useEffect(() => {
    const quillRoot = quillInstanceRef.current?.root;
    if (!quillRoot || !onBlur) return;
    const handleBlur = () => {
      setTimeout(() => {
        const html = quillInstanceRef.current?.root?.innerHTML || '';
        if (html && html !== '<p><br></p>') onBlur(html);
      }, 0);
    };
    quillRoot.addEventListener('blur', handleBlur);
    return () => quillRoot.removeEventListener('blur', handleBlur);
  }, [onBlur]);

  // Configurar toolbar completa (28 opÃ§Ãµes - igual DecisionEditorToolbar)
  const toolbarConfig = React.useMemo(() => getQuillToolbarConfig('full'), []);

  const handleInsertModel = React.useCallback((content: string) => {
    onInsertModel?.(content);
  }, [onInsertModel]);

  const handlePreviewModel = React.useCallback((model: Model) => {
    onPreviewModel?.(model);
  }, [onPreviewModel]);

  // v1.35.59: Handler para Voice-to-Text - insere texto na posiÃ§Ã£o do cursor
  const handleVoiceTranscript = React.useCallback((text: string) => {
    const quill = quillInstanceRef.current;
    if (quill) {
      // Usar requestAnimationFrame para nÃ£o bloquear UI
      requestAnimationFrame(() => {
        const range = quill.getSelection() || { index: quill.getLength() - 1 };
        quill.insertText(range.index, text + ' ');
        quill.setSelection(range.index + text.length + 1);
      });
    }
  }, []);

  const editorPaneStyle = React.useMemo(() =>
    isSplitMode ? { width: `${splitPosition}%` } : undefined
  , [isSplitMode, splitPosition]);

  const modelPaneStyle = React.useMemo(() =>
    isSplitMode ? { width: `${100 - splitPosition}%` } : undefined
  , [isSplitMode, splitPosition]);

  return (
    <div ref={containerRef} className={`${isFullscreen ? 'editor-fullscreen' : ''} ${isSplitMode ? 'editor-fullscreen-split' : ''}`}>
      {/* Painel do Editor (esquerda em split mode) */}
      {/* v1.9.30: Adicionado flex flex-col flex-1 min-h-0 para altura correta */}
      <div
        className={`flex flex-col flex-1 min-h-0 ${isSplitMode ? 'split-editor-pane' : ''}`}
        style={editorPaneStyle}
      >
        {/* v1.9.30: Mostrar nome do tÃ³pico em fullscreen */}
        {isFullscreen ? (
          <div className="flex items-center gap-2 mb-2 flex-shrink-0">
            <span className="theme-text-primary font-semibold text-lg">
              ğŸ“ {topicTitle}
            </span>
            {topicCategory && (
              <span className="px-2 py-1 text-xs rounded theme-bg-purple-accent theme-text-purple">
                {topicCategory}
              </span>
            )}
          </div>
        ) : (
          <label className={CSS.label}>
            {label}
          </label>
        )}

        {/* BotÃµes Customizados (acima do editor) */}
        {/* v1.9.30: Adicionado flex-shrink-0 para nÃ£o comprimir botÃµes */}
        <div className="flex flex-wrap gap-2 mb-2 flex-shrink-0">
          {/* BotÃ£o Salvar */}
          <button
            onClick={onSaveWithoutClosing}
            className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-green-600 hover-green-700-from-600"
            title="Salvar (Ctrl+S)"
          >
            <Save className="w-3.5 h-3.5" />
            Salvar
          </button>

          {/* v1.35.59: BotÃ£o Voice-to-Text */}
          <VoiceButton
            onTranscript={handleVoiceTranscript}
            size="md"
            onError={(err: unknown) => console.warn('[VoiceToText]', err)}
          />

          {/* BotÃ£o Assistente IA */}
          {onOpenAIAssistant && (
            <button
              onClick={onOpenAIAssistant}
              className="hover-purple-700 px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-purple-600"
              title="Assistente de IA"
            >
              <Sparkles className="w-3.5 h-3.5" />
              Assistente IA
            </button>
          )}

          {/* v1.20.0: BotÃ£o JurisprudÃªncia */}
          {onOpenJurisModal && (
            <button
              onClick={onOpenJurisModal}
              className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-blue-600 hover-blue-700-from-600"
              title="Buscar jurisprudÃªncia relevante"
            >
              <Scale className="w-3.5 h-3.5" />
              JurisprudÃªncia
            </button>
          )}

          {/* v1.36.21: BotÃ£o Confronto de Fatos */}
          {onOpenFactsComparison && (
            <button
              onClick={onOpenFactsComparison}
              className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-amber-600 hover-amber-700"
              title="Confronto de Fatos (Inicial vs ContestaÃ§Ã£o)"
            >
              <Scale className="w-3.5 h-3.5" />
              Confronto
            </button>
          )}

          {/* BotÃ£o Extrair Modelo (condicional) */}
          {showExtractButton && onExtractModel && (
            <button
              onClick={onExtractModel}
              disabled={extractingModel}
              className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-pink-600 hover-pink-700 disabled:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-300"
              title="Extrair como modelo reutilizÃ¡vel (usa IA)"
            >
              {extractingModel ? (
                <>
                  <div className="w-3.5 h-3.5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  Extraindo...
                </>
              ) : (
                <>
                  <BookOpen className="w-3.5 h-3.5" />
                  Extrair Modelo
                </>
              )}
            </button>
          )}

          {/* v1.13.2: BotÃ£o Salvar como Modelo (preserva texto 100%) */}
          {showExtractButton && onSaveAsModel && (
            <button
              onClick={onSaveAsModel}
              className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 bg-blue-600 hover-blue-700-from-600"
              title="Salvar texto atual como modelo (preserva 100%)"
            >
              <Save className="w-3.5 h-3.5" />
              Salvar como Modelo
            </button>
          )}

          {/* v1.9.31: BotÃ£o Modelos (ANTES do Fullscreen toggle) - Cor amber para destaque */}
          {isFullscreen && (
            <button
              onClick={toggleSplitMode}
              className={`px-3 py-1.5 text-white text-xs rounded flex items-center gap-1.5 transition-all ${
                isSplitMode
                  ? 'bg-amber-700 ring-2 ring-amber-400'
                  : 'bg-amber-600 hover-amber-700'
              }`}
              title={isSplitMode ? 'Fechar Modelos (ESC ou Ctrl+M)' : 'ğŸ“š Abrir Biblioteca de Modelos (Ctrl+M)'}
            >
              <BookOpen className="w-3.5 h-3.5" />
              {isSplitMode ? 'Fechar Modelos' : 'ğŸ“š Modelos'}
            </button>
          )}

          {/* v1.9.20: BotÃ£o Fullscreen */}
          <button
            onClick={toggleFullscreen}
            className="px-3 py-1.5 text-white text-xs rounded flex items-center gap-1 theme-bg-tertiary hover-slate-500"
            title={isFullscreen ? 'Sair do Fullscreen (ESC ou Ctrl+F)' : 'Tela Cheia (Ctrl+F)'}
          >
            {isFullscreen ? (
              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            ) : (
              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
              </svg>
            )}
          </button>

          {/* v1.24: Dropdown de versÃµes (ao lado do fullscreen) */}
          {versioning && topicTitle && (
            <VersionSelect
              topicTitle={topicTitle}
              versioning={versioning}
              currentContent={content}
              onRestore={(restoredContent) => onChange?.(restoredContent)}
            />
          )}

          {/* v1.13.9: Indicador de mudanÃ§as nÃ£o salvas */}
          {isDirty && (
            <span className="px-2 py-1 text-xs rounded bg-amber-500/20 text-amber-400 border border-amber-500/30">
              NÃ£o salvo
            </span>
          )}

          {/* v1.9.11: Dropdown de EspaÃ§amento + v1.10.8: Tamanho de Fonte */}
          <div className="ml-auto flex items-center gap-4">
            <div className="flex items-center gap-2">
              <span className={CSS.textMuted}>Fonte:</span>
              <FontSizeDropdown
                value={fontSize}
                onChange={setFontSize}
                ariaLabel="Tamanho da fonte do editor de tÃ³picos"
              />
            </div>
            <div className="flex items-center gap-2">
              <span className={CSS.textMuted}>EspaÃ§amento:</span>
              <SpacingDropdown
                value={spacing}
                onChange={setSpacing}
                ariaLabel="EspaÃ§amento do editor de tÃ³picos"
              />
            </div>
          </div>
        </div>

        {/* Editor Quill (com toolbar sticky e scroll interno) */}
        {/* v1.9.27: Key no div pai forÃ§a React a destruir/recriar toda a Ã¡rvore DOM */}
        <div
          key={isFullscreen ? 'fullscreen-wrapper' : 'normal-wrapper'}
          className={`fontsize-${fontSize} spacing-${spacing} ${editorTheme === 'light' ? 'quill-light-theme bg-white' : 'theme-bg-primary'} border theme-border-input rounded-lg ${isFullscreen ? 'fullscreen-editor-wrapper' : ''}`}
        >
          <QuillEditorBase
            content={content}
            onChange={onChange}
            onReady={handleQuillReady}
            onSlashCommand={onSlashCommand}
            toolbarConfig={toolbarConfig}
            modules={customModules}
            placeholder={placeholder}
            className={isFullscreen ? 'fullscreen-quill-fill' : 'min-h-[400px] max-h-[80vh]'}
            quillReady={quillReady}
            quillError={quillError}
          />
        </div>

        {/* v1.9.12: SeÃ§Ã£o de regeneraÃ§Ã£o IA (DISPOSITIVO) - Usando componente compartilhado */}
        {showRegenerateSection && onRegenerate && !isFullscreen && (
          <AIRegenerationSection
            customInstruction={customInstruction}
            onInstructionChange={onInstructionChange}
            regenerating={regenerating}
            onRegenerate={onRegenerate}
            contextLabel="dispositivo"
          />
        )}
      </div>

      {/* v1.9.21: Divisor arrastÃ¡vel (sÃ³ em split mode) */}
      {isSplitMode && (
        <SplitDivider onDragStart={startDrag} />
      )}

      {/* v1.9.29: Painel de SugestÃµes de Modelos (direita, sÃ³ em split mode) */}
      {isSplitMode && (
        <div
          className="split-editor-pane"
          style={modelPaneStyle}
        >
          <FullscreenModelPanel
            models={models}
            topicTitle={topicTitle}
            topicCategory={topicCategory}
            topicRelatorio={topicRelatorio}
            onInsert={handleInsertModel}
            onPreview={handlePreviewModel}
            sanitizeHTML={sanitizeHTML}
            onFindSuggestions={onFindSuggestions}
          />
        </div>
      )}
    </div>
  );
});

QuillDecisionEditor.displayName = 'QuillDecisionEditor';

// ğŸ”§ COMPONENTE COMPARTILHADO: AIRegenerationSection (v1.9.12)
// SeÃ§Ã£o de regeneraÃ§Ã£o com IA (textarea de instruÃ§Ãµes + botÃ£o gerar)
// v1.35.10: Estado local bufferizado para evitar re-render do LegalDecisionEditor a cada keystroke
interface AIRegenerationSectionProps {
  customInstruction?: string;
  onInstructionChange?: (instruction: string) => void;
  regenerating?: boolean;
  onRegenerate: () => void;
  contextLabel?: string;
}
const AIRegenerationSection = React.memo(({
  customInstruction = '',
  onInstructionChange,
  regenerating = false,
  onRegenerate,
  contextLabel = 'texto' // "dispositivo" ou "mini-relatÃ³rio"
}: AIRegenerationSectionProps) => {
  // v1.35.10: Estado LOCAL para o textarea
  // DigitaÃ§Ã£o atualiza apenas este componente (leve), nÃ£o o LegalDecisionEditor (pesado)
  const [localInstruction, setLocalInstruction] = React.useState(customInstruction);

  // v1.35.10: Sincronizar estado local quando customInstruction muda externamente
  React.useEffect(() => {
    setLocalInstruction(customInstruction);
  }, [customInstruction]);

  // v1.35.10: Handler para digitaÃ§Ã£o - atualiza estado LOCAL
  const handleInstructionChange = React.useCallback((e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setLocalInstruction(e.target.value);
  }, []);

  // v1.35.10: Propagar para pai apenas no blur
  const handleBlur = React.useCallback(() => {
    if (onInstructionChange && localInstruction !== customInstruction) {
      onInstructionChange(localInstruction);
    }
  }, [onInstructionChange, localInstruction, customInstruction]);

  const handleMouseEnterButton = React.useCallback((e: React.MouseEvent<HTMLButtonElement>) => {
    if (!regenerating) {
      e.currentTarget.style.backgroundColor = '#7e22ce';
    }
  }, [regenerating]);

  const handleMouseLeaveButton = React.useCallback((e: React.MouseEvent<HTMLButtonElement>) => {
    e.currentTarget.style.backgroundColor = regenerating ? '#6b7280' : '#9333ea';
  }, [regenerating]);

  // v1.35.10: Sincronizar antes de regenerar (caso usuÃ¡rio nÃ£o tenha saÃ­do do campo)
  const handleRegenerate = React.useCallback(() => {
    if (onInstructionChange && localInstruction !== customInstruction) {
      onInstructionChange(localInstruction);
    }
    // Pequeno delay para garantir que o estado foi propagado
    setTimeout(() => onRegenerate(), 0);
  }, [onInstructionChange, localInstruction, customInstruction, onRegenerate]);

  // v1.35.59: Handler para Voice-to-Text - adiciona texto ao final da instruÃ§Ã£o
  const handleVoiceTranscript = React.useCallback((text: string) => {
    setLocalInstruction((prev: string) => (prev ? prev + ' ' : '') + text);
  }, []);

  return (
    <div className="mt-4 pt-4 border-t theme-border-input">
      <p className="text-xs theme-text-muted mb-2">
        âœ¨ <strong>Regenerar com IA:</strong> Adicione uma instruÃ§Ã£o opcional abaixo e clique em "Gerar" para que a IA recrie este {contextLabel}
      </p>

      {/* v1.35.59: Container flex para textarea + VoiceButton */}
      <div className="flex gap-2">
        <textarea
          value={localInstruction}
          onChange={handleInstructionChange}
          onBlur={handleBlur}
          placeholder="InstruÃ§Ã£o opcional (ex: 'Seja mais objetivo', 'Adicione detalhes sobre...')"
          className="flex-1 px-3 py-2 theme-bg-primary border theme-border-input rounded theme-text-tertiary text-sm theme-placeholder focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all"
          rows={2}
        />
        <VoiceButton
          onTranscript={handleVoiceTranscript}
          size="sm"
          className="self-start mt-1"
        />
      </div>

      <button
        onClick={handleRegenerate}
        disabled={regenerating}
        onMouseEnter={handleMouseEnterButton}
        onMouseLeave={handleMouseLeaveButton}
        style={{
          backgroundColor: regenerating ? '#6b7280' : '#9333ea',
          transition: 'background-color 0.3s ease',
          cursor: regenerating ? 'not-allowed' : 'pointer'
        }}
        className="mt-2 px-3 py-1.5 text-white text-xs rounded flex items-center gap-1"
      >
        {regenerating ? (
          <>
            <div className="w-3.5 h-3.5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            Gerando...
          </>
        ) : (
          <>
            <Sparkles className="w-3.5 h-3.5" />
            Gerar com IA
          </>
        )}
      </button>
    </div>
  );
});

AIRegenerationSection.displayName = 'AIRegenerationSection';

// QuillMiniRelatorioEditor - Mini-relatÃ³rio sem toolbar
// v1.15.6: Adicionado onSlashCommand
// v1.35.94: Tipagem correta com QuillMiniRelatorioEditorProps
const QuillMiniRelatorioEditor = React.memo(React.forwardRef<QuillInstance, QuillMiniRelatorioEditorProps>(({
  content = '',
  onChange,
  onRegenerate,
  onSaveWithoutClosing,
  customInstruction = '',
  onInstructionChange,
  regenerating = false,
  topicTitle = '',
  label = 'Mini-relatÃ³rio (editÃ¡vel):',
  showRegenerateSection = true,
  quillReady = false,
  quillError = null,
  editorTheme,
  toggleEditorTheme,
  onSlashCommand
}, ref) => {
  const { quillInstanceRef, customModules, handleQuillReady } = useQuillEditor({
    ref,
    onSaveWithoutClosing,
    enableCtrlS: true,
    topicTitle,
    content,
    enableTopicChangeDetection: true
  });

  const { spacing } = useSpacingControl();

  const { fontSize } = useFontSizeControl();

  // ConfiguraÃ§Ã£o: SEM toolbar (minimal = false)
  const toolbarConfig = React.useMemo(() => false, []);

  return (
    <div className="theme-bg-secondary-30 p-4 rounded-lg border theme-border-input">
      <p className="text-blue-400 font-medium mb-2">{label}</p>

      {/* Editor Quill SEM toolbar + Ctrl+S */}
      <div className={`fontsize-${fontSize} spacing-${spacing} ${editorTheme === 'light' ? 'quill-light-theme bg-white' : 'theme-bg-primary-50'} border theme-border-input rounded`}>
        <QuillEditorBase
          content={content}
          onChange={onChange}
          onReady={handleQuillReady}
          onSlashCommand={onSlashCommand}
          toolbarConfig={toolbarConfig} // false = sem toolbar
          modules={customModules} // CORREÃ‡ÃƒO #3: Adiciona Ctrl+S keyboard shortcut
          placeholder="O reclamante narra que... Sustenta que... Postula... A primeira reclamada, em defesa, alega que..."
          className="min-h-32"
          quillReady={quillReady}
          quillError={quillError}
        />
      </div>

      <p className="text-xs theme-text-disabled mt-2">
        ğŸ’¡ Formato sugerido: "O reclamante narra que... Sustenta que... Postula... A primeira reclamada, em defesa, alega que..."
        <br />
        âŒ¨ï¸ <strong>Ctrl+S</strong> = Salvar sem fechar
      </p>

      {/* v1.9.12: SeÃ§Ã£o de regeneraÃ§Ã£o IA (MINI-RELATÃ“RIO) - Usando componente compartilhado */}
      {showRegenerateSection && onRegenerate && (
        <AIRegenerationSection
          customInstruction={customInstruction}
          onInstructionChange={onInstructionChange}
          regenerating={regenerating}
          onRegenerate={onRegenerate}
          contextLabel="mini-relatÃ³rio"
        />
      )}
    </div>
  );
}));

QuillMiniRelatorioEditor.displayName = 'QuillMiniRelatorioEditor';

// ğŸ› ï¸ COMPONENTE: DecisionEditorContainer - Container do editor de decisÃ£o
// v1.15.4: Adicionado onSlashCommand, v1.20.0: Adicionado onOpenJurisModal
// v1.35.94: Tipagem correta com DecisionEditorContainerProps
const DecisionEditorContainer = React.memo(React.forwardRef<HTMLDivElement, DecisionEditorContainerProps>(({
  editorRef,
  relatorioRef,
  toolbarRef,
  topic,
  onSave,
  onCancel,
  onSaveWithoutClosing,
  onCategoryChange,
  onFundamentacaoChange,
  onRelatorioChange,
  onOpenAIAssistant,
  onOpenJurisModal,
  onExtractModel,
  onSaveAsModel,
  onRegenerateRelatorio,
  savingTopic,
  extractingModel,
  showExtractButton,
  regeneratingRelatorio,
  relatorioInstruction,
  onInstructionChange,
  sanitizeHTML,
  onTextSelection,
  // Para atualizaÃ§Ã£o de categoria
  selectedTopics,
  setSelectedTopics,
  extractedTopics,
  setExtractedTopics,
  getTopicEditorConfig,
  quillReady,
  quillError,
  onRegenerateDispositivo,
  dispositivoInstruction,
  onDispositivoInstructionChange,
  regeneratingDispositivo,
  editorTheme,
  toggleEditorTheme,
  models,
  onInsertModel,
  onPreviewModel,
  findSuggestions,
  onSlashCommand,
  isDirty = false,
  versioning = null,
  onOpenFactsComparison = null // v1.36.21: Confronto de Fatos
}, containerRef) => {

  const editorConfig = getTopicEditorConfig(topic.title);

  // ğŸš€ v1.8.3: Handler para mudanÃ§a de categoria (MEMOIZADO)
  const handleCategoryChange = React.useCallback((e: React.ChangeEvent<HTMLSelectElement>) => {
    const newCategory = e.target.value as TopicCategory;

    // Chamar callback do pai
    onCategoryChange(newCategory);

    // Atualizar em selectedTopics
    const selectedIndex = selectedTopics.findIndex((t: Topic) => t.title === topic.title);
    if (selectedIndex !== -1) {
      const newSelected = [...selectedTopics];
      newSelected[selectedIndex] = { ...newSelected[selectedIndex], category: newCategory };
      setSelectedTopics(newSelected);
    }

    // Atualizar em extractedTopics
    const extractedIndex = extractedTopics.findIndex((t: Topic) => t.title === topic.title);
    if (extractedIndex !== -1) {
      const newExtracted = [...extractedTopics];
      newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], category: newCategory };
      setExtractedTopics(newExtracted);
    }
  }, [onCategoryChange, topic.title, selectedTopics, extractedTopics]); // ğŸš€ v1.8.3: Memoizado (GRUPO C)

  return (
    <div ref={containerRef} className="space-y-4">
      {/* Header com tÃ­tulo e categoria */}
      <div className="flex items-center gap-3 flex-wrap">
        <h3 className="text-xl font-bold text-blue-400">{topic.title.toUpperCase()}</h3>

        {/* v1.4.7: Seletor de categoria - condicional baseado em config */}
        {editorConfig.showCategory && (
          <select
            value={topic.category || 'MÃ‰RITO'}
            onChange={handleCategoryChange}
            className="text-xs px-3 py-2 rounded cursor-pointer font-medium focus:outline-none focus:ring-2 focus:ring-blue-400 border-2 theme-border theme-text-secondary theme-bg-tertiary hover-slate-500"
            title="Clique para alterar a categoria"
          >
            <option value="PRELIMINAR">ğŸ“‹ Preliminar</option>
            <option value="PREJUDICIAL">âš ï¸ Prejudicial</option>
            <option value="MÃ‰RITO">âš–ï¸ MÃ©rito</option>
            <option value="PROCESSUAL">ğŸ“ Processual</option>
          </select>
        )}
      </div>

      {/* v1.5.1: Mini-RelatÃ³rio - migrado para Quill.js (ETAPA 4) */}
      {editorConfig.showMiniRelatorio && (
      <QuillMiniRelatorioEditor
        ref={relatorioRef}
        content={topic.editedRelatorio || topic.relatorio || ''}
        topicTitle={topic.title}
        onChange={onRelatorioChange}
        onRegenerate={onRegenerateRelatorio}
        onSaveWithoutClosing={onSaveWithoutClosing} // CORREÃ‡ÃƒO #3: Adiciona handler Ctrl+S
        customInstruction={relatorioInstruction}
        onInstructionChange={onInstructionChange}
        regenerating={regeneratingRelatorio}
        quillReady={quillReady}
        quillError={quillError}
        editorTheme={editorTheme}
        toggleEditorTheme={toggleEditorTheme}
        onSlashCommand={onSlashCommand}
        {...editorConfig.relatorioConfig}
      />
      )}

      {/* v1.5.0: Editor de DecisÃ£o migrado para Quill.js (ETAPA 3) */}
      {editorConfig.showDecisionEditor && (
      <QuillDecisionEditor
        ref={editorRef}
        content={
          topic.title.toUpperCase() === 'DISPOSITIVO'
            ? (topic.editedContent || '')
            : (topic.fundamentacao || topic.editedFundamentacao || '')
        }
        topicTitle={topic.title}
        topicCategory={topic.category}
        onChange={onFundamentacaoChange}
        onSaveWithoutClosing={onSaveWithoutClosing}
        onOpenAIAssistant={onOpenAIAssistant}
        onOpenJurisModal={onOpenJurisModal}
        onExtractModel={onExtractModel}
        onSaveAsModel={onSaveAsModel}
        extractingModel={extractingModel}
        showExtractButton={showExtractButton}
        quillReady={window.Quill !== undefined}
        quillError={null}
        onRegenerate={topic.title.toUpperCase() === 'DISPOSITIVO' ? onRegenerateDispositivo : undefined}
        customInstruction={topic.title.toUpperCase() === 'DISPOSITIVO' ? dispositivoInstruction : ''}
        onInstructionChange={topic.title.toUpperCase() === 'DISPOSITIVO' ? onDispositivoInstructionChange : undefined}
        regenerating={topic.title.toUpperCase() === 'DISPOSITIVO' ? regeneratingDispositivo : false}
        showRegenerateSection={topic.title.toUpperCase() === 'DISPOSITIVO'}
        editorTheme={editorTheme}
        toggleEditorTheme={toggleEditorTheme}
        models={models}
        onInsertModel={onInsertModel}
        onPreviewModel={onPreviewModel}
        sanitizeHTML={sanitizeHTML}
        topicRelatorio={topic.relatorio || topic.editedRelatorio || ''}
        onFindSuggestions={findSuggestions}
        onSlashCommand={onSlashCommand}
        isDirty={isDirty}
        versioning={versioning}
        onBlur={(html: string) => versioning?.saveVersion(topic.title, html)}
        onOpenFactsComparison={topic.title.toUpperCase() !== 'DISPOSITIVO' ? onOpenFactsComparison : null}
        {...editorConfig.editorConfig}
      />
      )}

      {/* Footer com botÃµes */}
      <div className="flex gap-3">
        <button
          onClick={onCancel}
          disabled={savingTopic}
          className="flex-1 py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed theme-bg-secondary hover-slate-600-from-700 transition-all duration-300"
        >
          Cancelar
        </button>
        <button
          onClick={onSave}
          disabled={savingTopic}
          className="flex-1 py-3 rounded-lg font-medium text-white disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 hover-gradient-blue-purple transition-all duration-300"
        >
          {savingTopic ? (
            <>
              <div className={CSS.spinner}></div>
              <span>Salvando...</span>
            </>
          ) : (
            'Salvar e Fechar'
          )}
        </button>
      </div>
    </div>
  );
}));

DecisionEditorContainer.displayName = 'DecisionEditorContainer';

// ğŸ”§ HELPER: Fast Hash (v1.9.1)
const fastHashUtil = (str: string) => {
  if (!str) return 'empty';
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash |= 0; // Convert to 32bit integer
  }
  return hash.toString(36);
};

// ğŸ”§ HOOK: useDocumentServices (v1.9.12)
// Centraliza toda a lÃ³gica de processamento de documentos (PDF, DOCX, OCR)
const useDocumentServices = (aiIntegration: ReturnType<typeof useAIIntegration> | null) => {
  // ğŸ“š CARREGAR BIBLIOTECAS VIA CDN

  const loadPDFJS = React.useCallback((): Promise<PdfjsLib> => {
    return new Promise((resolve, reject) => {

      if (window.pdfjsLib) {
        resolve(window.pdfjsLib);
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';

      script.onload = () => {
        if (window.pdfjsLib) {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
          resolve(window.pdfjsLib);
        } else {
          reject(new Error('pdfjsLib nÃ£o encontrado apÃ³s carregar script'));
        }
      };

      script.onerror = (err: unknown) => {
        reject(new Error('Falha ao carregar PDF.js da CDN'));
      };

      setTimeout(() => {
        if (!window.pdfjsLib) {
          reject(new Error('Timeout ao carregar PDF.js'));
        }
      }, 10000);

      document.head.appendChild(script);
    });
  }, []);

  const loadMammoth = React.useCallback((): Promise<MammothLib> => {
    return new Promise((resolve, reject) => {

      if (window.mammoth) {
        resolve(window.mammoth);
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js';

      script.onload = () => {
        if (window.mammoth) {
          resolve(window.mammoth);
        } else {
          reject(new Error('mammoth nÃ£o encontrado apÃ³s carregar script'));
        }
      };

      script.onerror = (err: unknown) => {
        reject(new Error('Falha ao carregar Mammoth.js da CDN'));
      };

      setTimeout(() => {
        if (!window.mammoth) {
          reject(new Error('Timeout ao carregar Mammoth.js'));
        }
      }, 10000);

      document.head.appendChild(script);
    });
  }, []);

  // ğŸ†• v1.31: Loader Tesseract.js para OCR offline
  const loadTesseract = React.useCallback((): Promise<TesseractLib> => {
    return new Promise((resolve, reject) => {
      if (window.Tesseract) {
        resolve(window.Tesseract);
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';

      script.onload = () => {
        if (window.Tesseract) {
          resolve(window.Tesseract);
        } else {
          reject(new Error('Tesseract nÃ£o encontrado apÃ³s carregar script'));
        }
      };

      script.onerror = () => {
        reject(new Error('Falha ao carregar Tesseract.js da CDN'));
      };

      // Timeout maior (30s) pois modelo portuguÃªs (~4MB) pode demorar
      setTimeout(() => {
        if (!window.Tesseract) {
          reject(new Error('Timeout ao carregar Tesseract.js'));
        }
      }, 30000);

      document.head.appendChild(script);
    });
  }, []);

  // ğŸ“ EXTRAÃ‡ÃƒO DE TEXTO DE PDF

  // v1.20.2: Adicionado pdf.destroy() em finally (FIX memory leak ~50-100MB por PDF)
  const extractTextFromPDFPure = React.useCallback(async (file: File, progressCallback: ((page: number, total: number) => void) | null = null) => {
    let pdf = null;
    try {
      const pdfjsLib = await loadPDFJS();
      const arrayBuffer = await file.arrayBuffer();
      pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      let fullText = '';
      const totalPages = pdf.numPages;

      for (let i = 1; i <= totalPages; i++) {
        if (progressCallback) {
          progressCallback(i, totalPages);
        }
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        // v1.14.1: Validar textContent.items antes de map (fix: null em alguns PDFs)
        const items = textContent?.items || [];
        const pageText = items.map((item: { str?: string }) => item?.str || '').join(' ');
        fullText += pageText + '\n\n';
      }

      // v1.16.7: AnonimizaÃ§Ã£o movida para analyzeDocuments (evita duplicaÃ§Ã£o)
      return fullText.trim();
    } catch (err) {
      return null;
    } finally {
      if (pdf) {
        try { pdf.destroy(); } catch (e) { /* ignore */ }
      }
    }
  }, [loadPDFJS]);

  const extractTextFromDOCX = React.useCallback(async (file: File) => {
    try {
      const mammoth = await loadMammoth();

      const arrayBuffer = await file.arrayBuffer();

      const result = await mammoth.extractRawText({ arrayBuffer });
      const text = result.value;

      if (result.messages && result.messages.length > 0) {
      }

      return text;
    } catch (err) {
      throw new Error(`Falha ao extrair texto do DOCX: ${(err as Error).message}`);
    }
  }, [loadMammoth]);

  // ğŸ†• v1.12.23: Processamento em BATCH - envia atÃ© 50 pÃ¡ginas por requisiÃ§Ã£o (25x mais rÃ¡pido)
  // v1.20.2: Adicionado pdf.destroy() em finally (FIX memory leak)
  const extractTextFromPDFWithClaudeVision = React.useCallback(async (file: File, progressCallback: ((page: number, total: number, status?: string) => void) | null = null) => {
    // Constantes de configuraÃ§Ã£o do batch
    const BATCH_SIZE = 50;        // MÃ¡ximo de pÃ¡ginas por requisiÃ§Ã£o (API suporta atÃ© 100)
    const SCALE = 1.5;            // Escala reduzida para garantir < 2000px por imagem
    const JPEG_QUALITY = 0.85;    // Qualidade JPEG (menor = mais rÃ¡pido upload)
    const MAX_TOKENS = 16384;     // Tokens para acomodar mÃºltiplas pÃ¡ginas

    let pdf = null;
    try {
      if (progressCallback) {
        progressCallback(0, 0, 'iniciando');
      }

      const pdfjsLib = await loadPDFJS();
      const arrayBuffer = await file.arrayBuffer();

      // v1.12.15: Desabilita carregamento de fontes externas (evita erro CORS no Claude.ai)
      pdf = await pdfjsLib.getDocument({
        data: arrayBuffer,
        useSystemFonts: true,
        disableFontFace: true
      } as unknown as { data: ArrayBuffer }).promise;

      const totalPages = pdf.numPages;

      // FASE 1: Renderizar TODAS as pÃ¡ginas para imagens base64
      const pageImages = [];
      for (let i = 1; i <= totalPages; i++) {
        if (progressCallback) {
          progressCallback(i, totalPages, 'renderizando');
        }

        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: SCALE });

        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        try {
          const context = canvas.getContext('2d');
          if (!context) throw new Error('Canvas 2D context not available');
          await page.render({
            canvasContext: context,
            viewport: viewport
          }).promise;

          const base64Image = canvas.toDataURL('image/jpeg', JPEG_QUALITY).split(',')[1];
          pageImages.push({ pageNum: i, base64: base64Image });
        } finally {
          // Liberar memÃ³ria do canvas sempre, mesmo em caso de erro
          canvas.width = 0;
          canvas.height = 0;
        }
      }

      // FASE 2: Processar em batches de atÃ© 50 pÃ¡ginas
      let fullText = '';
      const totalBatches = Math.ceil(totalPages / BATCH_SIZE);

      for (let batchIdx = 0; batchIdx < totalBatches; batchIdx++) {
        const startIdx = batchIdx * BATCH_SIZE;
        const endIdx = Math.min(startIdx + BATCH_SIZE, totalPages);
        const batchImages = pageImages.slice(startIdx, endIdx);
        const batchPageNumbers = batchImages.map(img => img.pageNum);

        if (progressCallback) {
          progressCallback(endIdx, totalPages, `processando batch ${batchIdx + 1}/${totalBatches}`);
        }

        // Construir array de content com todas as imagens do batch
        const content = [];

        // Adicionar cada imagem do batch
        batchImages.forEach((img) => {
          content.push({
            type: 'image',
            source: {
              type: 'base64',
              media_type: 'image/jpeg',
              data: img.base64
            }
          });
        });

        // Prompt final pedindo extraÃ§Ã£o de TODAS as pÃ¡ginas do batch
        const idioma = aiIntegration?.aiSettings?.ocrLanguage === 'por' ? 'PortuguÃªs' : 'English';
        // v1.14.1: Validar batchPageNumbers antes de acessar Ã­ndices (fix: array vazio)
        const firstPage = batchPageNumbers[0] || 1;
        const lastPage = batchPageNumbers[batchPageNumbers.length - 1] || firstPage;
        content.push({
          type: 'text',
          text: `Extraia TODO o texto de TODAS as ${batchImages.length} imagens acima. SÃ£o as pÃ¡ginas ${firstPage} a ${lastPage} de um documento legal.

INSTRUÃ‡Ã•ES IMPORTANTES:
- Processe CADA pÃ¡gina na ordem exata apresentada
- Para CADA pÃ¡gina, inicie com uma linha "--- PÃGINA ${firstPage <= 1 ? 'X' : firstPage + ' a ' + lastPage} ---" (substitua X pelo nÃºmero)
- Retorne APENAS o texto extraÃ­do, sem comentÃ¡rios ou explicaÃ§Ãµes
- Preserve a formataÃ§Ã£o de parÃ¡grafos e estrutura do documento
- Idioma do documento: ${idioma}`
        });

        // Fazer a requisiÃ§Ã£o para o batch inteiro
        if (!aiIntegration) throw new Error('AI integration not available');
        const requestBody = {
          model: aiIntegration.aiSettings?.model || 'claude-sonnet-4-20250514',
          max_tokens: MAX_TOKENS,
          messages: [{ role: 'user', content }]
        };

        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: aiIntegration.getApiHeaders(),
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorText = await response.text();

          // Se falhar no primeiro batch, fazer fallback para PDF.js puro
          if (batchIdx === 0) {
            console.warn('âš ï¸ Fallback para PDF.js puro');
            return await extractTextFromPDFPure(file, progressCallback);
          }

          // Se falhar em batches subsequentes, marcar erro e continuar
          fullText += `\n\n[ERRO: PÃ¡ginas ${startIdx + 1} a ${endIdx} nÃ£o puderam ser processadas via OCR]\n\n`;
          continue;
        }

        const data = await response.json();
        // v1.20.5: Contabilizar tokens de OCR Claude Vision
        if (data.usage) {
          aiIntegration.logCacheMetrics(data);
        }
        const batchText = data.content?.[0]?.text || '';
        fullText += batchText + '\n\n';
      }

      const finalText = fullText.trim();
      return finalText;

    } catch (err) {
      return await extractTextFromPDFPure(file, progressCallback);
    } finally {
      if (pdf) {
        try { pdf.destroy(); } catch (e) { /* ignore */ }
      }
    }
  }, [loadPDFJS, aiIntegration, extractTextFromPDFPure]);

  // ğŸ†• v1.31: OCR offline com Tesseract.js
  // v1.31.02: Paralelo com Scheduler (pool de workers)
  // v1.31.03: Batching + Workers dinÃ¢micos (75% cores, max 8)
  // v1.32.15: Alta qualidade (SCALE 4.0 + PSM 6)
  const extractTextFromPDFWithTesseract = React.useCallback(async (file: File, progressCallback: ((page: number, total: number, status?: string) => void) | null = null) => {
    const SCALE = 4.0;  // v1.32.15: MÃ¡xima qualidade OCR
    // 75% dos cores lÃ³gicos, mÃ­nimo 2, mÃ¡ximo 8
    const NUM_WORKERS = Math.min(Math.max(Math.ceil((navigator.hardwareConcurrency || 4) * 0.75), 2), 8);
    const BATCH_SIZE = NUM_WORKERS;

    let pdf: PdfDocument | null = null;
    let scheduler: TesseractScheduler | null = null;

    try {
      // v1.36.33: DiagnÃ³stico de performance Tesseract
      console.time('[Tesseract] Library load');
      const [pdfjsLib, Tesseract] = await Promise.all([
        loadPDFJS(),
        loadTesseract()
      ]);
      console.timeEnd('[Tesseract] Library load');

      console.time('[Tesseract] PDF parse');
      const arrayBuffer = await file.arrayBuffer();
      pdf = await pdfjsLib.getDocument({
        data: arrayBuffer,
        useSystemFonts: true,
        disableFontFace: true
      } as unknown as { data: ArrayBuffer }).promise;
      console.timeEnd('[Tesseract] PDF parse');

      const totalPages = pdf.numPages;

      // 1. Criar scheduler com pool de workers
      if (progressCallback) progressCallback(0, totalPages, `Iniciando ${NUM_WORKERS} workers...`);

      scheduler = Tesseract.createScheduler();
      const tesseractScheduler = scheduler; // Capture reference for closure

      // v1.36.33: Criar primeiro worker sozinho (cacheia modelo ~4MB)
      // Depois os demais em paralelo (usam cache)
      console.time('[Tesseract] First worker (downloads model)');
      const firstWorker = await Tesseract.createWorker('por');
      await firstWorker.setParameters({
        tessedit_pageseg_mode: '6',
        preserve_interword_spaces: '1'
      });
      tesseractScheduler.addWorker(firstWorker);
      console.timeEnd('[Tesseract] First worker (downloads model)');

      // Workers restantes em paralelo (modelo jÃ¡ cacheado)
      if (NUM_WORKERS > 1) {
        console.time(`[Tesseract] Remaining ${NUM_WORKERS - 1} workers (parallel)`);
        await Promise.all(
          Array.from({ length: NUM_WORKERS - 1 }, async () => {
            const worker = await Tesseract.createWorker('por');
            await worker.setParameters({
              tessedit_pageseg_mode: '6',
              preserve_interword_spaces: '1'
            });
            tesseractScheduler.addWorker(worker);
          })
        );
        console.timeEnd(`[Tesseract] Remaining ${NUM_WORKERS - 1} workers (parallel)`);
      }

      // v1.36.34: Mais diagnÃ³stico - onde trava?
      console.log('[Tesseract] Workers ready, starting batch processing...');

      // 2. Processar em batches (limita memÃ³ria)
      const allResults = [];
      let completed = 0;

      for (let batchStart = 0; batchStart < totalPages; batchStart += BATCH_SIZE) {
        const batchEnd = Math.min(batchStart + BATCH_SIZE, totalPages);
        const batchPages = Array.from(
          { length: batchEnd - batchStart },
          (_, i: number) => batchStart + i + 1
        );

        console.log(`[Tesseract] Processing batch: pages ${batchStart + 1}-${batchEnd}`);

        // 2a. Renderizar batch de pÃ¡ginas
        console.time('[Tesseract] Canvas render');
        const canvases = await Promise.all(
          batchPages.map(async (pageNum) => {
            if (!pdf) throw new Error('PDF not loaded');
            const page = await pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: SCALE });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const ctx = canvas.getContext('2d');
            if (!ctx) throw new Error('Canvas 2D context not available');
            await page.render({ canvasContext: ctx, viewport }).promise;
            console.log(`[Tesseract] Page ${pageNum} rendered`);
            return { canvas, pageNum };
          })
        );
        console.timeEnd('[Tesseract] Canvas render');

        // 2b. OCR batch em paralelo
        if (!scheduler) throw new Error('Tesseract scheduler not available');
        const activeScheduler = scheduler; // Capture non-null for closure
        console.time('[Tesseract] OCR batch');
        const batchResults = await Promise.all(
          canvases.map(async ({ canvas, pageNum }) => {
            console.log(`[Tesseract] Starting OCR page ${pageNum}...`);
            const { data: { text } } = await activeScheduler.addJob('recognize', canvas);
            console.log(`[Tesseract] Page ${pageNum} OCR complete`);
            completed++;
            if (progressCallback) progressCallback(completed, totalPages, 'OCR...');
            // Cleanup imediato
            canvas.width = 0;
            canvas.height = 0;
            return { pageNum, text };
          })
        );
        console.timeEnd('[Tesseract] OCR batch');

        allResults.push(...batchResults);
      }

      // 3. Ordenar e juntar
      allResults.sort((a, b) => a.pageNum - b.pageNum);
      return allResults.map(r => r.text).join('\n\n').trim();

    } catch (err) {
      console.error('[Tesseract OCR] Erro:', err);
      return null;
    } finally {
      if (scheduler) {
        try { await scheduler.terminate(); } catch (e) { /* ignore */ }
      }
      if (pdf) {
        try { pdf.destroy(); } catch (e) { /* ignore */ }
      }
    }
  }, [loadPDFJS, loadTesseract]);

  const extractTextFromPDF = React.useCallback(async (file: File, progressCallback: ((page: number, total: number, status?: string) => void) | null = null) => {
    const engine = aiIntegration?.aiSettings?.ocrEngine || 'pdfjs';

    switch (engine) {
      case 'claude-vision':
        return await extractTextFromPDFWithClaudeVision(file, progressCallback);
      case 'pdf-puro':
        return null;
      default:
        return await extractTextFromPDFPure(file, progressCallback);
    }
  }, [aiIntegration, extractTextFromPDFWithClaudeVision, extractTextFromPDFPure]);

  // ğŸ†• v1.12.20: ExtraÃ§Ã£o de texto com modo especÃ­fico (para provas individuais)
  const extractTextFromPDFWithMode = React.useCallback(async (file: File, mode: string, progressCallback: ((page: number, total: number) => void) | null = null) => {
    // Modos: 'pdfjs' | 'tesseract' | 'claude-vision' | 'pdf-puro'
    switch (mode) {
      case 'pdf-puro':
        return null;
      case 'tesseract':
        return await extractTextFromPDFWithTesseract(file, progressCallback);
      case 'claude-vision':
        return await extractTextFromPDFWithClaudeVision(file, progressCallback);
      case 'pdfjs':
      default:
        return await extractTextFromPDFPure(file, progressCallback);
    }
  }, [extractTextFromPDFWithClaudeVision, extractTextFromPDFPure, extractTextFromPDFWithTesseract]);

  // ğŸ”¢ DETECÃ‡ÃƒO DE NÃšMERO DO PROCESSO

  const extractProcessoFromFileName = React.useCallback((fileName: string) => {
    if (!fileName) return null;

    const match = fileName.match(/(AT|ATOrd|RO|RR|AP|AI|MS)?\s*(\d{7}-\d{2}\.\d{4}\.\d\.\d{2}\.\d{4})/);

    if (match) {
      return match[0].trim();
    }

    return null;
  }, []);

  // v1.20.2: Adicionado pdf.destroy() em finally (FIX memory leak)
  const extractProcessoFromFirstPage = React.useCallback(async (file: File) => {
    if (!file || file.type !== 'application/pdf') return null;

    let pdf = null;
    try {
      const pdfjsLib = await loadPDFJS();
      const arrayBuffer = await file.arrayBuffer();
      // v1.12.15: Desabilita carregamento de fontes externas (evita erro CORS no Claude.ai)
      pdf = await pdfjsLib.getDocument({
        data: arrayBuffer,
        useSystemFonts: true,
        disableFontFace: true
      } as unknown as { data: ArrayBuffer }).promise;

      const page = await pdf.getPage(1);
      const textContent = await page.getTextContent();
      // v1.14.1: Validar textContent.items
      const items = textContent?.items || [];
      const pageText = items.map((item: { str?: string }) => item?.str || '').join(' ');

      const match = pageText.match(/(AT|ATOrd|RO|RR|AP|AI|MS)?\s*(\d{7}-\d{2}\.\d{4}\.\d\.\d{2}\.\d{4})/);

      if (match) {
        return match[0].trim();
      }

      return null;
    } catch (err) {
      return null;
    } finally {
      if (pdf) {
        try { pdf.destroy(); } catch (e) { /* ignore */ }
      }
    }
  }, [loadPDFJS]);

  const autoDetectProcessoNumero = React.useCallback(async (files: { peticao?: File | null; contestacoes?: File[]; complementares?: File[] }) => {
    try {
      if (files.peticao) {
        const numeroFromPeticao = extractProcessoFromFileName(files.peticao.name);
        if (numeroFromPeticao) {
          return numeroFromPeticao;
        }
      }

      if (files.contestacoes && files.contestacoes.length > 0) {
        const numeroFromContestacao = extractProcessoFromFileName(files.contestacoes[0].name);
        if (numeroFromContestacao) {
          return numeroFromContestacao;
        }
      }

      if (files.complementares && files.complementares.length > 0) {
        for (const comp of files.complementares) {
          const numeroFromComp = extractProcessoFromFileName(comp.name);
          if (numeroFromComp) {
            return numeroFromComp;
          }
        }
      }

      if (files.contestacoes && files.contestacoes.length > 0) {
        const numeroFromPage = await extractProcessoFromFirstPage(files.contestacoes[0]);
        if (numeroFromPage) {
          return numeroFromPage;
        }
      }

      if (files.peticao) {
        const numeroFromPage = await extractProcessoFromFirstPage(files.peticao);
        if (numeroFromPage) {
          return numeroFromPage;
        }
      }

      return null;
    } catch (err) {
      return null;
    }
  }, [extractProcessoFromFileName, extractProcessoFromFirstPage]);

  // ğŸ“¦ PROCESSAMENTO EM LOTE

  const extractTextFromBulkFile = React.useCallback(async (file: File): Promise<string> => {
    const fileType = file.type;
    const fileName = file.name.toLowerCase();

    if (fileType === 'text/plain' || fileName.endsWith('.txt')) {
      return new Promise<string>((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e: ProgressEvent<FileReader>) => {
          const text = e.target?.result as string;
          resolve(text);
        };
        reader.onerror = () => reject(new Error('Erro ao ler arquivo TXT'));
        reader.readAsText(file);
      });
    }

    if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
      try {
        const text = await extractTextFromPDF(file);

        if (!text || text.trim().length < 50) {
          throw new Error('PDF vazio ou texto muito curto');
        }

        return text;
      } catch (err) {
        throw new Error(`Falha ao extrair texto do PDF: ${(err as Error).message}`);
      }
    }

    if (fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
        fileType === 'application/msword' ||
        fileName.endsWith('.docx') ||
        fileName.endsWith('.doc')) {
      try {
        const text = await extractTextFromDOCX(file);

        if (!text || text.trim().length < 50) {
          throw new Error('DOCX vazio ou texto muito curto');
        }

        return text;
      } catch (err) {
        throw new Error(`Falha ao extrair texto do DOCX: ${(err as Error).message}`);
      }
    }

    throw new Error(`Tipo de arquivo nÃ£o suportado: ${fileType}`);
  }, [extractTextFromPDF, extractTextFromDOCX]);

  const tryExtractTextFromPDFs = React.useCallback(async (files: { peticao?: File | null; contestacoes?: File[]; complementares?: File[] }, callbacks: { setExtractingText: (v: boolean) => void; setAnalysisProgress: (v: string) => void; setExtractedTexts: (v: { peticao: string | null; contestacoes: ({ text: string; name: string } | null)[]; complementares: ({ text: string; name: string } | null)[] }) => void; setError: (v: string | null) => void } | null | undefined) => {
    if (!callbacks) return { peticao: null, contestacoes: [], complementares: [] };
    const { setExtractingText, setAnalysisProgress, setExtractedTexts, setError } = callbacks;

    setExtractingText(true);
    setAnalysisProgress('ğŸ“„ Extraindo texto dos PDFs...');

    const extracted: {
      peticao: string | null;
      contestacoes: ({ text: string; name: string } | null)[];
      complementares: ({ text: string; name: string } | null)[];
    } = {
      peticao: null,
      contestacoes: [],
      complementares: []
    };

    try {
      if (files.peticao) {
        const engine = aiIntegration?.aiSettings?.ocrEngine || 'pdfjs';
        const engineLabel = engine === 'claude-vision' ? ' (Claude Vision)' : engine === 'tesseract' ? ' (Tesseract)' : engine === 'pdfjs' ? ' (PDF.js)' : '';
        setAnalysisProgress(`ğŸ“„ Extraindo texto da petiÃ§Ã£o inicial${engineLabel}...`);

        try {
          const text = await extractTextFromPDF(files.peticao, (page: number, total: number) => {
            setAnalysisProgress(`ğŸ” PetiÃ§Ã£o inicial: pÃ¡gina ${page}/${total}${engineLabel}...`);
          });

          if (text && text.length > 100) {
            extracted.peticao = text;
          } else {
          }
        } catch (err) {
        }
      }

      if (files.contestacoes && files.contestacoes.length > 0) {
        const engine = aiIntegration?.aiSettings?.ocrEngine || 'pdfjs';
        const engineLabel = engine === 'claude-vision' ? ' (Claude Vision)' : engine === 'tesseract' ? ' (Tesseract)' : engine === 'pdfjs' ? ' (PDF.js)' : '';
        for (let i = 0; i < files.contestacoes.length; i++) {
          try {
            setAnalysisProgress(`ğŸ“‘ Extraindo texto da contestaÃ§Ã£o ${i + 1}/${files.contestacoes.length}${engineLabel}...`);
            const text = await extractTextFromPDF(files.contestacoes[i], (page: number, total: number) => {
              setAnalysisProgress(`ğŸ” ContestaÃ§Ã£o ${i + 1}: pÃ¡gina ${page}/${total}${engineLabel}...`);
            });

            if (text && text.length > 100) {
              extracted.contestacoes.push({ text, name: `ContestaÃ§Ã£o ${i + 1}` });
            } else {
              extracted.contestacoes.push(null);
            }
          } catch (err) {
            extracted.contestacoes.push(null);
          }
        }
      }

      if (files.complementares && files.complementares.length > 0) {
        const engine = aiIntegration?.aiSettings?.ocrEngine || 'pdfjs';
        const engineLabel = engine === 'claude-vision' ? ' (Claude Vision)' : engine === 'tesseract' ? ' (Tesseract)' : engine === 'pdfjs' ? ' (PDF.js)' : '';
        for (let i = 0; i < files.complementares.length; i++) {
          try {
            setAnalysisProgress(`ğŸ“ Extraindo texto do documento complementar ${i + 1}/${files.complementares.length}${engineLabel}...`);
            const text = await extractTextFromPDF(files.complementares[i], (page: number, total: number) => {
              setAnalysisProgress(`ğŸ” Documento ${i + 1}: pÃ¡gina ${page}/${total}${engineLabel}...`);
            });

            if (text && text.length > 100) {
              const fileName = files.complementares[i].name || `Documento Complementar ${i + 1}`;
              extracted.complementares.push({ text, name: fileName });
            } else {
              extracted.complementares.push(null);
            }
          } catch (err) {
            extracted.complementares.push(null);
          }
        }
      }

      setExtractedTexts(extracted);
      return extracted;
    } catch (err) {
      setError('Erro durante extraÃ§Ã£o de texto. Usando PDFs originais.');
      return extracted;
    } finally {
      setExtractingText(false);
    }
  }, [aiIntegration, extractTextFromPDF]);

  return {
    loadPDFJS,
    loadMammoth,
    extractTextFromPDFPure,
    extractTextFromDOCX,
    extractTextFromPDFWithClaudeVision,
    extractTextFromPDFWithTesseract,  // ğŸ†• v1.31
    extractTextFromPDF,
    extractTextFromPDFWithMode,  // ğŸ†• v1.12.20
    extractProcessoFromFileName,
    extractProcessoFromFirstPage,
    autoDetectProcessoNumero,
    extractTextFromBulkFile,
    tryExtractTextFromPDFs
  };
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¤– SEÃ‡ÃƒO 7: AI_PROMPTS
// v1.35.26: AI_PROMPTS movido para src/prompts/ai-prompts.js (~820 linhas extraÃ­das)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš–ï¸ SEÃ‡ÃƒO 8: LEGALDECISIONEDITOR
// Componente principal da aplicaÃ§Ã£o (~13.000 linhas)
// ContÃ©m: reorderTopicsViaLLM, handleAnalyzeDocuments, analyzeProof, generateDispositivo
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸ“¦ COMPONENTE PRINCIPAL: LegalDecisionEditor
// v1.34.1: Adicionado props receivedModels e clearReceivedModels para merge de sync
const LegalDecisionEditor = ({ onLogout, cloudSync, receivedModels, activeSharedLibraries, clearReceivedModels }: {
  onLogout: () => void;
  cloudSync: UseCloudSyncReturn;
  receivedModels: Model[] | null;
  activeSharedLibraries: Array<{ ownerId: string; ownerEmail: string }> | null;
  clearReceivedModels: () => void;
}) => {

  // ğŸ£ CUSTOM HOOKS
  const { modals, openModal, closeModal, closeAllModals, isAnyModalOpen, textPreview, setTextPreview } = useModalManager();
  const aiIntegration = useAIIntegration();
  const featureFlags = useFeatureFlags();
  const indexedDB = useIndexedDB();   const apiCache = useAPICache(50, 5 * 60 * 1000); // ğŸš€ v1.8.2: Cache de API (50 entradas, TTL 5min)
  const storage = useLocalStorage();
  const modelLibrary = useModelLibrary();

  // v1.35.1: Merge modelos recebidos do servidor (APÃ“S IndexedDB carregar)
  // IMPORTANTE: Modelos compartilhados sÃ£o SUBSTITUÃDOS (nÃ£o mesclados) para refletir exclusÃµes do proprietÃ¡rio
  // v1.35.1: Extrair apenas as propriedades necessÃ¡rias para evitar re-renders desnecessÃ¡rios
  const { models: libraryModels, setModels: setLibraryModels, isLoadingModels } = modelLibrary;
  const { isAvailable: indexedDBAvailable, saveModels: saveToIndexedDB } = indexedDB;

  // v1.35.4: Usar ref para libraryModels evitando dependÃªncia circular no useEffect abaixo
  // Antes: libraryModels estava nas deps do effect, mas o effect chamava setLibraryModels(),
  // causando loop infinito de re-renders que congelava a UI durante digitaÃ§Ã£o
  const libraryModelsRef = React.useRef(libraryModels);
  libraryModelsRef.current = libraryModels;

  React.useEffect(() => {
    // Esperar IndexedDB terminar de carregar antes de fazer merge
    if (isLoadingModels || !indexedDBAvailable) {
      return;
    }

    // v1.35.4: Usar ref para evitar dependÃªncia circular
    const currentLibraryModels = libraryModelsRef.current;

    // v1.35.1: Executar merge se recebeu modelos OU se tem modelos compartilhados locais que podem ter sido deletados
    const hasLocalSharedModels = currentLibraryModels.some(m => m.isShared);
    if (receivedModels && (receivedModels.length > 0 || hasLocalSharedModels)) {
      console.log(`[Sync] Merge: ${receivedModels.length} do servidor + ${currentLibraryModels.length} locais (${hasLocalSharedModels ? 'tem' : 'sem'} compartilhados locais)`);

      // v1.35.1: Separar modelos prÃ³prios dos compartilhados
      // v1.35.21: TambÃ©m separar compartilhados locais para preservar quando servidor nÃ£o retorna
      const localOwnModels = currentLibraryModels.filter(m => !m.isShared);
      const localSharedModels = currentLibraryModels.filter(m => m.isShared);
      const serverOwnModels = receivedModels.filter((m: Model) => !m.isShared);
      const serverSharedModels = receivedModels.filter((m: Model) => m.isShared);

      // Merge apenas para modelos PRÃ“PRIOS
      const merged = new Map(localOwnModels.map(m => [m.id, m]));
      for (const serverModel of serverOwnModels) {
        if (serverModel.deletedAt) {
          merged.delete(serverModel.id);
        } else {
          const local = merged.get(serverModel.id);
          if (!local || new Date(serverModel.updatedAt || 0) > new Date(local.updatedAt || 0)) {
            merged.set(serverModel.id, serverModel);
          }
        }
      }

      // v1.35.24: Filtrar compartilhados locais por owners que ainda tÃªm acesso ativo
      // Isso resolve B8b: quando share Ã© removido, modelos desse owner sÃ£o excluÃ­dos no prÃ³ximo sync
      const activeOwnerIds = new Set((activeSharedLibraries || []).map((lib: { ownerId: string }) => lib.ownerId));
      const validLocalSharedModels = localSharedModels.filter(m => m.ownerId && activeOwnerIds.has(m.ownerId));

      if (localSharedModels.length !== validLocalSharedModels.length) {
        console.log(`[Sync] Removidos ${localSharedModels.length - validLocalSharedModels.length} modelos de owners sem acesso`);
      }

      // v1.35.21: Preservar compartilhados locais (validados) se servidor nÃ£o retornou nenhum
      // Isso evita perder modelos quando sync incremental nÃ£o retorna compartilhados
      // (porque nenhum foi atualizado desde lastSyncAt)
      // Quando servidor retorna compartilhados, substituir completamente (para refletir exclusÃµes)
      const finalSharedModels = serverSharedModels.length > 0
        ? serverSharedModels  // Servidor retornou compartilhados â†’ substituir
        : validLocalSharedModels;  // Servidor nÃ£o retornou â†’ preservar apenas de owners vÃ¡lidos

      // Combinar: modelos prÃ³prios mesclados + compartilhados (servidor ou locais preservados)
      const mergedModels = [...Array.from(merged.values()), ...finalSharedModels];
      console.log(`[Sync] Merge resultado: ${merged.size} prÃ³prios + ${finalSharedModels.length} compartilhados (${serverSharedModels.length > 0 ? 'servidor' : 'local'}) = ${mergedModels.length} total`);

      // Atualizar state
      setLibraryModels(mergedModels);

      // v1.34.7: Salvar IMEDIATAMENTE no IndexedDB (nÃ£o esperar debounce)
      saveToIndexedDB(mergedModels).then(() => {
        localStorage.setItem('sentencify-models-count', String(mergedModels.length));
        console.log(`[Sync] Salvo ${mergedModels.length} modelos no IndexedDB`);
      }).catch(err => {
        console.error('[Sync] Erro ao salvar no IndexedDB:', err);
      });

      clearReceivedModels();
    }
  }, [receivedModels, activeSharedLibraries, clearReceivedModels, setLibraryModels, isLoadingModels, indexedDBAvailable, saveToIndexedDB]);
  // â†‘ v1.35.4: Removido libraryModels das deps - usamos libraryModelsRef para evitar loop
  // â†‘ v1.35.24: Adicionado activeSharedLibraries para filtrar owners revogados

  // ğŸ¤– v1.19.0: Chat interativo do assistente IA (Editor Individual)
  const chatAssistant = useChatAssistant(aiIntegration);

  // ğŸ“œ v1.24: Versionamento de campos (Editor Individual)
  const fieldVersioning = useFieldVersioning();

  // â˜ï¸ v1.35.40: Google Drive - Salvar/Carregar projetos
  const googleDrive = useGoogleDrive();
  const [driveFilesModalOpen, setDriveFilesModalOpen] = React.useState(false);
  const [driveFiles, setDriveFiles] = React.useState<DriveFile[]>([]);

  // ğŸª„ v1.35.69: Gerador de Modelo a partir de Exemplos (v1.35.77: +estiloRedacao)
  const [modelGeneratorModal, setModelGeneratorModal] = React.useState<ModelGeneratorModalState>({
    isOpen: false,
    targetField: null // 'modeloRelatorio' | 'modeloDispositivo' | 'modeloTopicoRelatorio' | 'estiloRedacao'
  });

  const openModelGenerator = React.useCallback((targetField: TargetField) => {
    setModelGeneratorModal({ isOpen: true, targetField });
  }, []);

  const closeModelGenerator = React.useCallback(() => {
    setModelGeneratorModal({ isOpen: false, targetField: null });
  }, []);

  const handleModelGenerated = React.useCallback((generatedPrompt: string) => {
    const { targetField } = modelGeneratorModal;
    if (targetField) {
      // v1.35.77: estiloRedacao salva em customPrompt (nÃ£o em estiloRedacao)
      const settingKey = targetField === 'estiloRedacao' ? 'customPrompt' : targetField;
      aiIntegration.setAiSettings(prev => ({
        ...prev,
        [settingKey]: generatedPrompt
      }));
    }
    setModelGeneratorModal({ isOpen: false, targetField: null });
  }, [modelGeneratorModal.targetField, aiIntegration.setAiSettings]);

  const getHardcodedPrompt = React.useCallback((targetField: string) => {
    const prompts: Record<string, string> = {
      modeloRelatorio: AI_PROMPTS.instrucoesRelatorioPadrao || '',
      modeloDispositivo: AI_PROMPTS.instrucoesDispositivoPadrao || '',
      modeloTopicoRelatorio: AI_PROMPTS.instrucoesRelatorioPadrao || '',
      estiloRedacao: AI_INSTRUCTIONS_STYLE // v1.35.77: Estilo de redaÃ§Ã£o usa AI_INSTRUCTIONS_STYLE como referÃªncia
    };
    return prompts[targetField] || '';
  }, []);

  // ğŸ“„ v1.9.12: ServiÃ§os de Processamento de Documentos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const documentServices = useDocumentServices(aiIntegration);

  const proofManager = useProofManager(documentServices);   const documentManager = useDocumentManager(storage.clearPdfCache);   const topicManager = useTopicManager();   const modelPreview = useModelPreview(); // Preview de modelos sugeridos

  // v1.13.9: Ref para auto-save debounced no Editor Individual
  const individualAutoSaveTimerRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);

  // v1.13.9: Auto-save com debounce no Editor Individual
  React.useEffect(() => {
    const editingTopic = topicManager.editingTopic;
    if (!editingTopic) return;

    // Limpar timer anterior
    if (individualAutoSaveTimerRef.current) {
      clearTimeout(individualAutoSaveTimerRef.current);
    }

    // Debounce: aguardar 3s antes de sincronizar
    individualAutoSaveTimerRef.current = setTimeout(() => {
      // Sincronizar editingTopic â†’ selectedTopics
      topicManager.setSelectedTopics(prev =>
        prev.map(t => t.title === editingTopic.title ? { ...t, ...editingTopic } : t)
      );
      topicManager.setExtractedTopics(prev =>
        prev.map(t => t.title === editingTopic.title ? { ...t, ...editingTopic } : t)
      );
    }, AUTO_SAVE_DEBOUNCE_MS);

    return () => {
      if (individualAutoSaveTimerRef.current) {
        clearTimeout(individualAutoSaveTimerRef.current);
      }
    };
  }, [topicManager.editingTopic]);

  // v1.13.9: Detectar se hÃ¡ mudanÃ§as nÃ£o salvas no Editor Individual
  // v1.35.3: Extrair valores primitivos para evitar recÃ¡lculo desnecessÃ¡rio a cada keystroke
  // Nota: nÃ£o declarar editingTopic aqui pois jÃ¡ Ã© destructured de topicManager mais abaixo (linha ~19820)
  const editingTopicTitle = topicManager.editingTopic?.title;
  const editingTopicFundamentacao = topicManager.editingTopic?.editedFundamentacao;
  const editingTopicRelatorio = topicManager.editingTopic?.editedRelatorio;
  const editingTopicContent = topicManager.editingTopic?.editedContent;
  const editingTopicCategory = topicManager.editingTopic?.category;

  // v1.36.21: Estados para Confronto de Fatos (editor individual)
  const [factsComparisonResultIndividual, setFactsComparisonResultIndividual] = React.useState<FactsComparisonResult | null>(null);
  const [generatingFactsComparisonIndividual, setGeneratingFactsComparisonIndividual] = React.useState(false);
  const [factsComparisonErrorIndividual, setFactsComparisonErrorIndividual] = React.useState<string | null>(null);
  const factsComparisonCacheIndividual = useFactsComparisonCache();

  const isIndividualDirty = React.useMemo(() => {
    if (!editingTopicTitle) return false;

    const original = topicManager.selectedTopics.find(t => t.title === editingTopicTitle);
    if (!original) return false;

    // Comparar campos editÃ¡veis
    return (
      editingTopicFundamentacao !== original.editedFundamentacao ||
      editingTopicRelatorio !== original.editedRelatorio ||
      editingTopicContent !== original.editedContent ||
      editingTopicCategory !== original.category
    );
  }, [editingTopicTitle, editingTopicFundamentacao, editingTopicRelatorio, editingTopicContent, editingTopicCategory, topicManager.selectedTopics]);

  // ğŸ“ v1.10.13: Hooks de configuraÃ§Ã£o global de editor (para Quick Edit)
  const { spacing, setSpacing } = useSpacingControl();
  const { fontSize, setFontSize } = useFontSizeControl();

  // ğŸ”’ v1.9.5: Sistema de Lock de Aba PrimÃ¡ria â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const primaryTabLock = usePrimaryTabLock();

  // ğŸ’“ v1.33.31: Heartbeat keepalive (evita Render free tier dormir)
  const HEARTBEAT_INTERVAL = 10 * 60 * 1000; // 10 minutos
  React.useEffect(() => {
    // SÃ³ ativa em produÃ§Ã£o
    if (!import.meta.env.PROD) return;

    const keepAlive = async () => {
      try {
        await fetch(`${API_BASE}/api/health`, { method: 'GET' });
      } catch (err) {
        // Silencioso - servidor pode estar acordando
      }
    };

    // Primeiro heartbeat imediato (acorda servidor se dormindo)
    keepAlive();

    // Heartbeats periÃ³dicos
    const interval = setInterval(keepAlive, HEARTBEAT_INTERVAL);

    return () => clearInterval(interval);
  }, []);

  // ğŸ¨ v1.9.13: Sistema de Tema Claro/Escuro GLOBAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [appTheme, setAppTheme] = React.useState(() =>
    localStorage.getItem('sentencify-app-theme') || 'dark'
  );

  // Aplicar tema no documento e salvar no localStorage
  React.useEffect(() => {
    // Aplicar data-theme no HTML root para CSS Variables
    document.documentElement.setAttribute('data-theme', appTheme);
    // Persistir no localStorage
    localStorage.setItem('sentencify-app-theme', appTheme);
  }, [appTheme]);

  // Toggle tema global
  const toggleAppTheme = React.useCallback(() => {
    setAppTheme(prev => prev === 'dark' ? 'light' : 'dark');
  }, []);

  // v1.32.24: Modal de changelog
  const [showChangelogModal, setShowChangelogModal] = React.useState(false);

  // Alias para compatibilidade com editores Quill existentes
  const editorTheme = appTheme;
  const toggleEditorTheme = toggleAppTheme;

  // ğŸ’¾ PERSISTÃŠNCIA AUTOMÃTICA: Load/Save modelos (v1.7)

  // Ref para garantir que load sÃ³ execute UMA VEZ
  const hasLoadedModelsRef = React.useRef(false);

  // Ref para rastrear Ãºltimo array de models salvo (otimizaÃ§Ã£o de performance)
  const lastSavedModelsRef = React.useRef<string | null>(null);

  // ğŸš€ OTIMIZAÃ‡ÃƒO v1.7: Fast hash ao invÃ©s de JSON.stringify (FASE 1.2) â”€â”€â”€â”€â”€â”€
  // Hash rÃ¡pido baseado apenas em IDs e timestamps (~1ms vs 50-200ms stringify)
  const modelsHashRef = React.useRef<string | null>(null);

  const fastHash = React.useCallback((str: string) => {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash |= 0; // Convert to 32bit integer
    }
    return hash.toString(36);
  }, []);

  // Calcular hash dos modelos (apenas IDs + timestamps, nÃ£o conteÃºdo completo)
  const currentModelsHash = React.useMemo(() => {
    if (modelLibrary.models.length === 0) return 'empty';

    // Signature baseada em metadados (rÃ¡pido)
    const signature = modelLibrary.models
      .map(m => `${m.id}-${m.updatedAt || m.createdAt || ''}`)
      .join('|');

    return fastHash(signature);
  }, [modelLibrary.models, fastHash]); // ğŸ› BUGFIX: models completo (detecta ediÃ§Ãµes), nÃ£o sÃ³ length

  // ğŸš€ OTIMIZAÃ‡ÃƒO v1.7: Auto-save com dirty tracking (FASE 1.1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [autoSaveDirty, setAutoSaveDirty] = React.useState(false);
  const lastAutoSaveSnapshotRef = React.useRef<string | null>(null);
  const autoSaveTimerRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);

  // v1.12.28: Ref para snapshot atualizado (evita stale closure no auto-save)
  const currentSessionSnapshotRef = React.useRef<SessionState | null>(null);

  // Helper: marcar sessÃ£o como dirty (needs save)
  const markSessionDirty = React.useCallback(() => {
    setAutoSaveDirty(true);
  }, []);

  // ğŸš€ OTIMIZAÃ‡ÃƒO v1.7 (FASE 1.3): Batch DOM updates para evitar mÃºltiplos reflows
  // Antes: 3 innerHTML = 3 reflows (~300ms total)
  // Depois: 1 RAF batch = 1 reflow (~100ms)
  // v1.35.92: Tipo union para suportar refs diretos e Quill refs
  const batchDOMUpdates = React.useCallback((updates: Array<{ ref: React.RefObject<HTMLElement | QuillInstance | null>; content: string; property?: string }>) => {
    requestAnimationFrame(() => {
      updates.forEach(({ ref, content, property = 'innerHTML' }) => {
        if (!ref || !ref.current) return;

        try {
          // Suporta refs diretos ou Quill refs (com .root)
          const element = ('root' in ref.current && ref.current.root) ? ref.current.root : ref.current as HTMLElement;

          if (property === 'innerHTML') {
            element.innerHTML = content;
          } else if (property === 'innerText') {
            element.innerText = content;
          } else if (property === 'textContent') {
            element.textContent = content;
          }
        } catch (err) {
        }
      });
    });
  }, []);

  // ğŸ”„ MULTI-TAB SYNC: Registrar callback (v1.7 BUGFIX) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Refs para evitar closure stale (sempre acessar versÃ£o mais recente)
  const indexedDBRef = React.useRef(indexedDB);
  const modelLibraryRef = React.useRef(modelLibrary);
  const featureFlagsRef = React.useRef(featureFlags);

  // Atualizar refs quando os objetos mudarem
  React.useEffect(() => {
    indexedDBRef.current = indexedDB;
    modelLibraryRef.current = modelLibrary;
    featureFlagsRef.current = featureFlags;
  }, [indexedDB, modelLibrary, featureFlags]);

  React.useEffect(() => {
    // Registrar callback para receber notificaÃ§Ãµes de sync de outras tabs
    const handleSync = async ({ action, timestamp }: { action: string; timestamp: number }) => {

      // Usar refs para acessar versÃ£o sempre atualizada (evitar closure stale)
      const currentIndexedDB = indexedDBRef.current;
      const currentModelLibrary = modelLibraryRef.current;
      const currentFeatureFlags = featureFlagsRef.current;

      // Skip if IndexedDB feature flag is disabled
      if (!currentFeatureFlags.isEnabled('useIndexedDB')) {
        return;
      }

      // Skip if IndexedDB nÃ£o estÃ¡ disponÃ­vel
      if (!currentIndexedDB.isAvailable) {
        return;
      }

      try {
        // Recarregar modelos do IndexedDB (cache jÃ¡ foi invalidado pelo hook)
        const reloadedModels = await currentIndexedDB.loadModels();


        // Atualizar state React com modelos sincronizados
        currentModelLibrary.setModels(reloadedModels);

        // Atualizar ref para evitar save loop
        lastSavedModelsRef.current = JSON.stringify(reloadedModels);

      } catch (err) {
        currentModelLibrary.setPersistenceError(`Erro ao sincronizar com outra tab: ${(err as Error).message}`);
      }
    };

    // Registrar callback no hook useIndexedDB
    indexedDB.setSyncCallback(handleSync);


    // Cleanup: remover callback
    return () => {
      indexedDB.setSyncCallback(null);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); // âš ï¸ Array vazio OK: handleSync usa refs (sempre atualizadas) ao invÃ©s de closure

  // Load Models no mount
  React.useEffect(() => {
    // Skip if already loaded
    if (hasLoadedModelsRef.current) {
      return;
    }

    // Skip if IndexedDB feature flag is disabled
    if (!featureFlags.isEnabled('useIndexedDB')) {
      return;
    }

    // Wait for IndexedDB to be initialized (isAvailable becomes true AFTER dbInstance is ready)
    if (!indexedDB.isAvailable) {
      return;
    }

    let isMounted = true;

    const loadModelsFromStorage = async () => {
      modelLibrary.setIsLoadingModels(true);
      modelLibrary.setPersistenceError(null);

      try {
        const loadedModels = await indexedDB.loadModels();

        if (isMounted && loadedModels && loadedModels.length > 0) {
          modelLibrary.setModels(loadedModels);
          hasLoadedModelsRef.current = true; // Marcar como carregado
        } else if (isMounted) {
          hasLoadedModelsRef.current = true; // Marcar como carregado mesmo se vazio
        }
      } catch (err) {
        if (isMounted) {
          modelLibrary.setPersistenceError((err as Error).message);
        }
      } finally {
        if (isMounted) {
          modelLibrary.setIsLoadingModels(false);
        }
      }
    };

    loadModelsFromStorage();

    return () => {
      isMounted = false;
    };
  }, [indexedDB.isAvailable]); // Only re-run when IndexedDB becomes available

  // Save Models quando mudarem (v1.7 FASE 1.2: hash ao invÃ©s de stringify)
  React.useEffect(() => {
    // Skip if IndexedDB feature flag is disabled
    if (!featureFlags.isEnabled('useIndexedDB')) {
      return;
    }

    // Skip if IndexedDB is not available
    if (!indexedDB.isAvailable) {
      return;
    }

    // Skip if currently loading (to avoid save loop)
    if (modelLibrary.isLoadingModels) {
      return;
    }

    // Skip first load when models is empty array (not yet loaded)
    if (modelLibrary.models.length === 0 && !hasLoadedModelsRef.current) {
      return;
    }

    // ğŸš€ OTIMIZAÃ‡ÃƒO v1.7 (FASE 1.2): Hash comparison ao invÃ©s de JSON.stringify
    // Antes: JSON.stringify(100 models) = 50-200ms de bloqueio
    // Depois: Hash apenas IDs+timestamps = ~1ms
    const lastHash = modelsHashRef.current;

    if (currentModelsHash === lastHash) {
      // Nenhuma mudanÃ§a real detectada, skip save
      return;
    }

    // Debounce save to avoid excessive writes
    const timeoutId = setTimeout(async () => {
      try {
        await indexedDB.saveModels(modelLibrary.models);

        // v1.34.6: Salvar contagem para sync comparar com servidor
        localStorage.setItem('sentencify-models-count', String(modelLibrary.models.length));

        // Atualizar ref com hash atual
        modelsHashRef.current = currentModelsHash;

        modelLibrary.setPersistenceError(null);
      } catch (err) {
        modelLibrary.setPersistenceError((err as Error).message);
      }
    }, 1500); // ğŸš€ v1.8.1: 1500ms debounce (-20% saves em ediÃ§Ãµes rÃ¡pidas)

    return () => clearTimeout(timeoutId);
  }, [currentModelsHash, modelLibrary.isLoadingModels]); // Hash ao invÃ©s de models array

  // ğŸ¨ ESTADOS: NavegaÃ§Ã£o e UI
  const [activeTab, setActiveTab] = useState('upload');
  const [toast, setToast] = useState<ToastState>({ show: false, message: '', type: 'success' }); // 'success', 'error', 'info'
  const [error, setError] = useState<string | { type: string; message: string }>('');
  const [copySuccess, setCopySuccess] = useState(false);
  const copyTimeoutRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);
  const [modelSaved, setModelSaved] = useState(false);
  const [savingModel, setSavingModel] = useState(false); // v1.27.02: Feedback visual durante geraÃ§Ã£o de embedding
  const [savingFromSimilarity, setSavingFromSimilarity] = useState(false); // v1.33.3: Feedback no modal de similaridade

  // v1.17.0: Estados para modal de anonimizaÃ§Ã£o (nomes inseridos pelo usuÃ¡rio)
  const [showAnonymizationModal, setShowAnonymizationModal] = useState(false);
  const [anonymizationNamesText, setAnonymizationNamesText] = useState('');

  // v1.35.30: Estados para modal de curadoria de tÃ³picos (prÃ©-geraÃ§Ã£o de mini-relatÃ³rios)
  const [showTopicCurationModal, setShowTopicCurationModal] = useState(false);
  const [pendingCurationData, setPendingCurationData] = useState<{
    topics: Topic[];
    partes: { reclamante: string; reclamadas: string[] };
    relatorioContentArray: AIMessageContent[];
    documents: {
      peticoesText: PastedText[];
      contestacoesText: PastedText[];
      complementaresText: PastedText[];
      peticoesBase64: string[];
      contestacoesBase64: string[];
      complementaryBase64: string[];
      contestacoesExtraidasDePDF: PastedText[];
      contestacoesJaColadas: PastedText[];
      complementaresExtraidasDePDF: PastedText[];
      complementaresJaColadas: PastedText[];
      peticoesExtraidasDePDF: PastedText[];
      peticoesJaColadas: PastedText[];
    };
  } | null>(null);

  // v1.21.14: Sincronizar nomes do modal com aiSettings persistido
  useEffect(() => {
    const nomesUsuario = aiIntegration?.aiSettings?.anonymization?.nomesUsuario;
    if (Array.isArray(nomesUsuario) && nomesUsuario.length > 0) {
      setAnonymizationNamesText(nomesUsuario.join('\n'));
    }
  }, [aiIntegration?.aiSettings?.anonymization?.nomesUsuario]);

  // v1.15.3: Estado para Slash Menu (acesso rÃ¡pido a modelos com /)
  const [slashMenu, setSlashMenu] = React.useState<SlashMenuStateExtended>({
    isOpen: false,
    position: { top: 0, left: 0 },
    searchTerm: '',
    selectedIndex: 0,
    quillInstance: null,
    triggerPosition: 0
  });

  // v1.21.21: Estados para revisÃ£o crÃ­tica de sentenÃ§a
  const [reviewScope, setReviewScope] = useState<'decisionOnly' | 'decisionWithDocs'>('decisionOnly');
  const [reviewResult, setReviewResult] = useState('');
  const [generatingReview, setGeneratingReview] = useState(false);
  const [reviewFromCache, setReviewFromCache] = useState(false); // v1.36.57: Indicar se veio do cache
  const sentenceReviewCache = useSentenceReviewCache(); // v1.36.57: Cache de revisÃ£o de sentenÃ§a

  // Scroll automÃ¡tico para o topo quando aparecer erro
  useEffect(() => {
    if (error) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }, [error]);

  // Cleanup de timeout do copySuccess para evitar memory leak
  useEffect(() => {
    return () => {
      if (copyTimeoutRef.current) clearTimeout(copyTimeoutRef.current);
    };
  }, []);

  // ğŸ“‚ DESTRUCTURING: useDocumentManager & useTopicManager (v1.2.7)
  const {
    // Documentos - Estados
    peticaoFiles, contestacaoFiles, complementaryFiles,
    pastedPeticaoTexts, pastedContestacaoTexts, pastedComplementaryTexts,
    analyzedDocuments,
    analyzing, analysisProgress, extractingText, showPasteArea, extractedTexts, showTextPreview,
    // v1.12.18: Modos de processamento por documento
    documentProcessingModes,
    // Documentos - Setters
    setPeticaoFiles, setContestacaoFiles, setComplementaryFiles,
    setPastedPeticaoTexts, setPastedContestacaoTexts, setPastedComplementaryTexts,
    setAnalyzedDocuments,
    setAnalyzing, setAnalysisProgress, setExtractingText, setShowPasteArea, setExtractedTexts, setShowTextPreview,
    // v1.12.18: Setters de modos de processamento
    setDocumentProcessingModes, setPeticaoMode, setContestacaoMode, setComplementarMode,
    // Documentos - Handlers
    handlePastedText, removePastedText, removePeticaoFile,
    handleUploadPeticao, handleUploadContestacao, handleUploadComplementary,
    // Documentos - PersistÃªncia (com alias para evitar conflito)
    serializeForPersistence: serializeDocuments,
    restoreFromPersistence: restoreDocuments,
    clearAll: clearDocuments
  } = documentManager;

  const {
    // TÃ³picos - Estados
    extractedTopics, selectedTopics,
    editingTopic, lastEditedTopicTitle, topicContextScope,
    savingTopic,
    topicToDelete, topicToRename, newTopicName, topicsToMerge, topicToSplit, splitNames, newTopicData,
    // TÃ³picos - Setters
    setExtractedTopics, setSelectedTopics,
    setEditingTopic, setLastEditedTopicTitle, setTopicContextScope,
    setSavingTopic,
    setTopicToDelete, setTopicToRename, setNewTopicName, setTopicsToMerge, setTopicToSplit, setSplitNames, setNewTopicData
    // âš ï¸ NOTA: Handlers de tÃ³picos (prepareDeleteTopic, confirmDeleteTopic, etc.)
    // permanecem no componente principal pois dependem de modals e lÃ³gica complexa
    // NÃ£o fazemos destructuring deles para evitar conflitos
  } = topicManager;

  // ğŸ†• v1.12.18: Helper para determinar modo padrÃ£o baseado nas configuraÃ§Ãµes globais
  // v1.12.22: Simplificado - agora usa diretamente ocrEngine (pdfjs | pdf-puro | claude-vision)
  // v1.12.25: Removido autoExtractPDFText - usa apenas ocrEngine
  const getDefaultProcessingMode = React.useCallback(() => {
    return aiIntegration.aiSettings?.ocrEngine || 'pdfjs';
  }, [aiIntegration.aiSettings.ocrEngine]);

  // ğŸ”„ v1.9.1: HASHES para detectar ediÃ§Ãµes (nÃ£o apenas add/remove)

  // Hash de extractedTopics (detecta ediÃ§Ãµes de campos)
  // v1.13.8: Usar fastHashUtil no texto completo (nÃ£o apenas preview)
  const extractedTopicsHash = React.useMemo(() => {
    if (!extractedTopics || extractedTopics.length === 0) return 'empty';

    try {
      const signature = extractedTopics
        .map((t, idx) => {
          const id = t?.id || '';
          const title = t?.title || '';
          const category = t?.category || '';
          const resultado = t?.resultado || '';
          // v1.13.8: Hash do conteÃºdo completo para detectar qualquer mudanÃ§a
          const contentHash = fastHashUtil(t?.content || '');
          const fundamentacaoHash = fastHashUtil(t?.fundamentacao || '');
          const editedFundHash = fastHashUtil(t?.editedFundamentacao || '');
          const editedRelHash = fastHashUtil(t?.editedRelatorio || '');
          const editedContentHash = fastHashUtil(t?.editedContent || '');
          return `${idx}:${id}-${title}-${category}-${contentHash}-${fundamentacaoHash}-${editedFundHash}-${editedRelHash}-${editedContentHash}-${resultado}`;
        })
        .join('||');

      return fastHashUtil(signature);
    } catch (err) {
      return 'error';
    }
  }, [extractedTopics]);

  // Hash de selectedTopics
  // v1.13.8: Usar fastHashUtil no texto completo (nÃ£o apenas preview)
  const selectedTopicsHash = React.useMemo(() => {
    if (!selectedTopics || selectedTopics.length === 0) return 'empty';

    try {
      const signature = selectedTopics
        .map((t, idx) => {
          const id = t?.id || '';
          const title = t?.title || '';
          const category = t?.category || '';
          const resultado = t?.resultado || '';
          // v1.13.8: Hash do conteÃºdo completo para detectar qualquer mudanÃ§a
          const contentHash = fastHashUtil(t?.content || '');
          const fundamentacaoHash = fastHashUtil(t?.fundamentacao || '');
          const editedFundHash = fastHashUtil(t?.editedFundamentacao || '');
          const editedRelHash = fastHashUtil(t?.editedRelatorio || '');
          const editedContentHash = fastHashUtil(t?.editedContent || '');
          return `${idx}:${id}-${title}-${category}-${contentHash}-${fundamentacaoHash}-${editedFundHash}-${editedRelHash}-${editedContentHash}-${resultado}`;
        })
        .join('||');

      return fastHashUtil(signature);
    } catch (err) {
      return 'error';
    }
  }, [selectedTopics]);

  // Hash de provas (detecta ediÃ§Ãµes)
  const proofsHash = React.useMemo(() => {
    try {
      const proofFilesSig = (proofManager.proofFiles || [])
        .map(p => `${p?.id || ''}-${p?.name || ''}-${p?.size || 0}`)
        .join('|');

      const proofTextsSig = (proofManager.proofTexts || [])
        .map(p => {
          const id = p?.id || '';
          const name = p?.name || '';
          const text = p?.text || '';
          const textPreview = typeof text === 'string' ? text.substring(0, 50) : '';
          return `${id}-${name}-${textPreview}`;
        })
        .join('|');

      const extractedTexts = proofManager.extractedProofTexts || {};
      const extractedSig = Object.keys(extractedTexts)
        .map(id => {
          const text = extractedTexts[id] || '';
          const textPreview = typeof text === 'string' ? text.substring(0, 50) : '';
          return `${id}-${textPreview}`;
        })
        .join('|');

      // v1.13.5: Incluir conclusÃµes no hash para detectar ediÃ§Ãµes
      const conclusions = proofManager.proofConclusions || {};
      const conclusionsSig = Object.keys(conclusions)
        .map(id => {
          const text = conclusions[id] || '';
          const textPreview = typeof text === 'string' ? text.substring(0, 50) : '';
          return `${id}-${textPreview}`;
        })
        .join('|');

      // v1.13.5: Incluir vÃ­nculos prova-tÃ³pico no hash para detectar alteraÃ§Ãµes
      const topicLinks = proofManager.proofTopicLinks || {};
      const topicLinksSig = Object.keys(topicLinks)
        .map(id => {
          const links = topicLinks[id] || [];
          return `${id}:[${links.join(',')}]`;
        })
        .join('|');

      // v1.13.5: Incluir resultados de anÃ¡lise IA no hash
      const analysisResults = proofManager.proofAnalysisResults || {};
      const analysisResultsSig = Object.keys(analysisResults)
        .map(id => {
          const analysis = analysisResults[id] || {};
          const type = analysis.type || '';
          const result = analysis.result || '';
          const resultPreview = typeof result === 'string' ? result.substring(0, 50) : '';
          return `${id}:${type}:${resultPreview}`;
        })
        .join('|');

      // v1.19.2: Incluir flags de modo PDF e enviar conteÃºdo completo
      const pdfModeSig = JSON.stringify(proofManager.proofUsePdfMode || {});
      const sendFullContentSig = JSON.stringify(proofManager.proofSendFullContent || {});
      const signature = `${proofFilesSig}||${proofTextsSig}||${extractedSig}||${conclusionsSig}||${topicLinksSig}||${analysisResultsSig}||${pdfModeSig}||${sendFullContentSig}`;
      return fastHashUtil(signature);
    } catch (err) {
      return 'error';
    }
  }, [
    proofManager.proofFiles,
    proofManager.proofTexts,
    proofManager.extractedProofTexts,
    proofManager.proofConclusions,   // v1.13.5: Detectar ediÃ§Ãµes nas conclusÃµes
    proofManager.proofTopicLinks,    // v1.13.5: Detectar alteraÃ§Ãµes nos vÃ­nculos
    proofManager.proofAnalysisResults, // v1.13.5: Detectar resultados de anÃ¡lise IA
    proofManager.proofUsePdfMode,      // v1.19.2: Detectar mudanÃ§as no modo PDF
    proofManager.proofSendFullContent  // v1.19.2: Detectar mudanÃ§as na flag enviar conteÃºdo completo
  ]);

  // v1.13.6: Hash para detectar mudanÃ§as em Upload (arquivos, extractedTexts, documentProcessingModes)
  const uploadHash = React.useMemo(() => {
    try {
      // v1.13.7: Incluir arquivos PDF selecionados no hash (compatÃ­vel com formato {file, id})
      const peticaoFilesSig = peticaoFiles.map((f, i: number) => `${i}:${f?.file?.name || f?.name || ''}:${f?.file?.size || f?.size || 0}`).join('|');
      const contestacaoFilesSig = contestacaoFiles.map((f, i: number) => `${i}:${f?.file?.name || f?.name || ''}:${f?.file?.size || f?.size || 0}`).join('|');
      const complementaryFilesSig = complementaryFiles.map((f, i: number) => `${i}:${f?.file?.name || f?.name || ''}:${f?.file?.size || f?.size || 0}`).join('|');

      // extractedTexts: { peticoes: [{text, name}], contestacoes: [{text, name}], complementares: [{text, name}] }
      const peticoesText = (extractedTexts?.peticoes || [])
        .map((c, i: number) => `${i}:${(c?.text || '').substring(0, 50)}`)
        .join('|');

      const contestacoesText = (extractedTexts?.contestacoes || [])
        .map((c, i: number) => {
          const text = c?.text || '';
          return `${i}:${text.substring(0, 50)}`;
        })
        .join('|');

      const complementaresText = (extractedTexts?.complementares || [])
        .map((c, i: number) => {
          const text = c?.text || '';
          return `${i}:${text.substring(0, 50)}`;
        })
        .join('|');

      // documentProcessingModes: { peticoes: string[], contestacoes: string[], complementares: string[] }
      const peticoesModes = (documentProcessingModes?.peticoes || []).join(',');
      const contestacoesModes = (documentProcessingModes?.contestacoes || []).join(',');
      const complementaresModes = (documentProcessingModes?.complementares || []).join(',');

      // v1.13.7: Signature inclui arquivos + textos extraÃ­dos + modos
      const signature = `${peticaoFilesSig}||${contestacaoFilesSig}||${complementaryFilesSig}||${peticoesText}||${contestacoesText}||${complementaresText}||${peticoesModes}||${contestacoesModes}||${complementaresModes}`;
      return fastHashUtil(signature);
    } catch (err) {
      return 'error';
    }
  }, [peticaoFiles, contestacaoFiles, complementaryFiles, extractedTexts, documentProcessingModes]);

  // ğŸ–±ï¸ ESTADOS: Drag & Drop
  const [draggedIndex, setDraggedIndex] = useState<number | null>(null);
  const [dragOverIndex, setDragOverIndex] = useState<number | null>(null);
  const [draggedComplementaryIndex, setDraggedComplementaryIndex] = useState<number | null>(null);
  const [dragOverComplementaryIndex, setDragOverComplementaryIndex] = useState<number | null>(null);

  // ğŸ’¾ ESTADOS: SessÃ£o e PersistÃªncia
  const [partesProcesso, setPartesProcesso] = useState<PartesProcesso>({ reclamante: '', reclamadas: [] });

  // ğŸ“ ESTADOS: Editor de Texto Rico
  const [exportedText, setExportedText] = useState('');
  const [exportedHtml, setExportedHtml] = useState('');
    
  // ğŸ“‹ ESTADO: InformaÃ§Ãµes do Processo (v1.3.5.1)
  const [processoNumero, setProcessoNumero] = useState('');
  // NÃºmero do processo trabalhista (ex: ATOrd 0000313-98.2025.5.08.0110)

  // ğŸ”§ ESTADOS: UtilitÃ¡rios
  const [domPurifyReady, setDomPurifyReady] = useState(false);
  const [quillReady, setQuillReady] = useState(false);
  const [quillError, setQuillError] = useState<Error | null>(null);
  const [quillRetryCount, setQuillRetryCount] = useState(0);

  // ğŸ§  v1.32.00: ESTADOS: IA Offline (NER)
  const [nerFilesStored, setNerFilesStored] = useState<string[]>([]); // Legado - nÃ£o mais usado
  const [nerModelReady, setNerModelReady] = useState(false);
  const [nerInitializing, setNerInitializing] = useState(false);
  const [nerDownloadProgress, setNerDownloadProgress] = useState(0);
  const [detectingNames, setDetectingNames] = useState(false);
  // v1.32.00: Toggle master para NER
  const [nerEnabled, setNerEnabled] = useState(() => {
    try { return JSON.parse(localStorage.getItem('nerEnabled') || 'false'); } catch { return false; }
  });
  // v1.29: Estado para incluir ORG (empresas) na detecÃ§Ã£o
  const [nerIncludeOrg, setNerIncludeOrg] = useState(() => {
    try { return JSON.parse(localStorage.getItem('nerIncludeOrg') || 'false'); } catch { return false; }
  });

  // ğŸ” v1.26.00: ESTADOS: Busca SemÃ¢ntica (E5-base)
  const [searchFilesStored, setSearchFilesStored] = useState<string[]>([]);
  const [searchModelReady, setSearchModelReady] = useState(false);
  const [searchInitializing, setSearchInitializing] = useState(false);
  const [searchDownloadProgress, setSearchDownloadProgress] = useState(0);
  const [embeddingsCount, setEmbeddingsCount] = useState(0);
  const [embeddingsProgress, setEmbeddingsProgress] = useState<ProgressState>({ current: 0, total: 0 });
  // v1.28.00: Toggle MASTER que controla carregamento do modelo E5
  const [searchEnabled, setSearchEnabled] = useState(() => {
    try {
      // MigraÃ§Ã£o: se searchEnabled nÃ£o existe, usa semanticSearchEnabled como fallback
      const stored = localStorage.getItem('searchEnabled');
      if (stored !== null) return JSON.parse(stored);
      return JSON.parse(localStorage.getItem('semanticSearchEnabled') || 'false');
    } catch { return false; }
  });
  // v1.35.74: semanticSearchEnabled, semanticThreshold, jurisSemanticEnabled, jurisSemanticThreshold
  // movidos para aiSettings (agora em aiIntegration.aiSettings.X)
  const [jurisEmbeddingsCount, setJurisEmbeddingsCount] = useState(0);
  const [jurisEmbeddingsProgress, setJurisEmbeddingsProgress] = useState<ProgressState>({ current: 0, total: 0 });
  const jurisEmbeddingsFileInputRef = useRef<HTMLInputElement | null>(null);

  // ğŸŒ v1.33.0: Estados para download automÃ¡tico de embeddings via CDN
  const [showEmbeddingsDownloadModal, setShowEmbeddingsDownloadModal] = useState(false);
  const [embeddingsDownloadStatus, setEmbeddingsDownloadStatus] = useState<EmbeddingsDownloadStatusExtended>({
    legislacao: { needed: null, downloading: false, progress: 0, error: null },
    jurisprudencia: { needed: null, downloading: false, progress: 0, error: null }
  });
  const [dismissedEmbeddingsPrompt, setDismissedEmbeddingsPrompt] = useState(() => {
    try { return JSON.parse(localStorage.getItem('dismissedEmbeddingsPrompt') || 'false'); } catch { return false; }
  });

  // ğŸ“¥ v1.33.61: Estados para download automÃ¡tico de DADOS (legislaÃ§Ã£o e jurisprudÃªncia)
  const [showDataDownloadModal, setShowDataDownloadModal] = useState(false);
  const [dataDownloadStatus, setDataDownloadStatus] = useState<DataDownloadStatusExtended>({
    legislacao: { needed: null, downloading: false, progress: 0, error: null, completed: false },
    jurisprudencia: { needed: null, downloading: false, progress: 0, error: null, completed: false }
  });
  const [dismissedDataPrompt, setDismissedDataPrompt] = useState(() => {
    try { return JSON.parse(localStorage.getItem('dismissedDataPrompt') || 'false'); } catch { return false; }
  });

  // ğŸ“¦ v1.27.01: Estados para busca semÃ¢ntica de MODELOS (embeddings inline)
  // v1.35.74: modelSemanticEnabled, modelSemanticThreshold, useLocalAIForSuggestions
  // movidos para aiSettings (agora em aiIntegration.aiSettings.X)
  const [generatingModelEmbeddings, setGeneratingModelEmbeddings] = useState(false);
  const [modelEmbeddingsProgress, setModelEmbeddingsProgress] = useState<ProgressState>({ current: 0, total: 0 });
  // v1.32.18: JurisprudÃªncia via IA Local nos editores
  // v1.35.74: useLocalAIForJuris movido para aiSettings

  // v1.33.19: Toggle para busca semÃ¢ntica na busca manual de modelos (editores individual e global)
  // v1.33.20: Inicializa com modelSemanticEnabled (respeitando config IA)
  // v1.35.74: Agora usa aiIntegration.aiSettings.modelSemanticEnabled
  const [useSemanticManualSearch, setUseSemanticManualSearch] = useState(() => aiIntegration.aiSettings.modelSemanticEnabled);

  // v1.35.75: Feedback inline nos botÃµes de teste de API Key
  const [claudeTestStatus, setClaudeTestStatus] = useState<'testing' | 'ok' | 'error' | null>(null); // null | 'testing' | 'ok' | 'error'
  const [geminiTestStatus, setGeminiTestStatus] = useState<'testing' | 'ok' | 'error' | null>(null);
  // v1.35.97: OpenAI e Grok test status
  const [openaiTestStatus, setOpenaiTestStatus] = useState<'testing' | 'ok' | 'error' | null>(null);
  const [grokTestStatus, setGrokTestStatus] = useState<'testing' | 'ok' | 'error' | null>(null);
  const [semanticManualSearchResults, setSemanticManualSearchResults] = useState<Model[] | null>(null);
  const [semanticManualSearching, setSemanticManualSearching] = useState(false);

  // ğŸ“œ v1.26.02: Hook de legislaÃ§Ã£o para geraÃ§Ã£o de embeddings
  const legislacao = useLegislacao();

  // ğŸ¯ REFS
  const bulkFileInputRef = useRef<HTMLInputElement | null>(null);
  const bulkEditorRef = useRef<QuillInstance | null>(null); // v1.35.92: Tipar como QuillInstance
  const editorRef = useRef<QuillInstance | null>(null); // v1.35.92: Tipar como QuillInstance
  const modelEditorRef = useRef<QuillInstance | null>(null); // v1.35.92: Tipar como QuillInstance
  const modelFormRef = useRef<HTMLDivElement | null>(null);
  const relatorioRef = useRef<QuillInstance | null>(null); // v1.35.92: Tipar como QuillInstance
  const fileInputRef = useRef<HTMLInputElement | null>(null);
  const topicRefs = useRef<Record<string, HTMLDivElement | null>>({});
  const editorContainerRef = useRef<HTMLDivElement | null>(null);

  // v1.20.2: Cleanup de refs de tÃ³picos removidos para evitar memory leak
  const cleanupTopicRefs = React.useCallback((currentTitles: string[]) => {
    const titles = new Set(currentTitles);
    Object.keys(topicRefs.current).forEach(title => {
      if (!titles.has(title)) delete topicRefs.current[title];
    });
  }, []);

  // âš¡ EFFECTS

  // ğŸ”„ v1.9 FASE 2: Implementar reloadSessionFromStorage com todos os setters
  React.useEffect(() => {
    // Redefinir reloadSessionFromStorage com acesso aos setters
    const reloadImpl = async () => {
      try {

        await storage.restoreSession({
          setPastedPeticaoTexts,
          setPastedContestacaoTexts,
          setPastedComplementaryTexts,
          setExtractedTopics,
          setSelectedTopics,
          setPartesProcesso,
          setAnalyzedDocuments,
          // v1.13.7: Adicionar setters de arquivos de Upload para restaurar PDFs do IndexedDB
          setPeticaoFiles,
          setContestacaoFiles,
          setComplementaryFiles,
          setExtractedTexts,
          setDocumentProcessingModes,
          setProofFiles: proofManager.setProofFiles,
          setProofTexts: proofManager.setProofTexts,
          setProofUsePdfMode: proofManager.setProofUsePdfMode,
          setExtractedProofTexts: proofManager.setExtractedProofTexts,
          setProofExtractionFailed: proofManager.setProofExtractionFailed,
          setProofTopicLinks: proofManager.setProofTopicLinks,
          setProofAnalysisResults: proofManager.setProofAnalysisResults,
          setProofConclusions: proofManager.setProofConclusions,
          setProofSendFullContent: proofManager.setProofSendFullContent,
          setActiveTab,
          closeModal,
          setError,
          setProcessoNumero,
          setTokenMetrics: aiIntegration.setTokenMetrics // v1.20.3: Contador de tokens
        });


        // Atualizar ref para refletir novo estado
        // Note: localStateRef was removed - timestamp tracking handled elsewhere
      } catch (err) {
        setError('Erro ao sincronizar com outra aba: ' + (err as Error).message);
      }
    };

    // Substituir o placeholder vazio
    if (typeof window !== 'undefined') {
      window.__reloadSessionFromStorage = reloadImpl;
    }
  }, [
    storage,
    setPastedPeticaoTexts, setPastedContestacaoTexts, setPastedComplementaryTexts,
    setExtractedTopics, setSelectedTopics, setPartesProcesso, setAnalyzedDocuments,
    proofManager, setActiveTab, closeModal, setError, setProcessoNumero
  ]);

  useEffect(() => {
    // Verificar se jÃ¡ estÃ¡ carregado
    if (window.DOMPurify) {
      setDomPurifyReady(true);
      return;
    }

    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js';
    script.async = true;
    script.onload = () => {
      setDomPurifyReady(true);
    };
    script.onerror = () => {
    };

    document.head.appendChild(script);

    return () => {
      if (script.parentNode) {
        script.parentNode.removeChild(script);
      }
    };
  }, []);

  // v1.33.19: Effect para busca semÃ¢ntica manual de modelos
  useEffect(() => {
    if (!useSemanticManualSearch || !searchModelReady || !modelLibrary.manualSearchTerm || modelLibrary.manualSearchTerm.trim().length < 2) {
      setSemanticManualSearchResults(null);
      return;
    }

    const timeoutId = setTimeout(async () => {
      setSemanticManualSearching(true);
      try {
        const results = await searchModelsBySimilarity(modelLibrary.models, modelLibrary.manualSearchTerm.toLowerCase(), { threshold: 0.3, limit: 10 });
        setSemanticManualSearchResults(results);
        // TambÃ©m atualizar os resultados no modelLibrary para exibiÃ§Ã£o
        modelLibrary.setManualSearchResults(results);
      } catch (error) {
        console.error('[ModelSearch] Erro na busca semÃ¢ntica:', error);
        setSemanticManualSearchResults(null);
      }
      setSemanticManualSearching(false);
    }, 300);

    return () => clearTimeout(timeoutId);
  }, [useSemanticManualSearch, modelLibrary.manualSearchTerm, searchModelReady, modelLibrary.models]);

  // ğŸ¨ FunÃ§Ã£o para injetar estilos do Quill (dark theme)
  const injectQuillStyles = () => {
    const styleId = 'quill-dark-theme-styles';

    // SEMPRE remover estilos antigos (se existirem) para garantir atualizaÃ§Ã£o
    const existingStyle = document.getElementById(styleId);
    if (existingStyle) {
      existingStyle.remove();
    }
    const style = document.createElement('style');
    style.id = styleId;
    style.textContent = `
      /* Quill Dark Theme - SentencifyAI (Injetado Globalmente) */
      .ql-toolbar.ql-snow {
        border: none !important;
        border-bottom: 1px solid rgb(71, 85, 105) !important;
        background: rgba(51, 65, 85, 0.95) !important;
        padding: 8px !important;
        position: sticky !important;
        top: 0 !important;
        z-index: 10 !important;
        /* v1.9.31: backdrop-filter removido - causa lag */
      }

      /* Ãcones da toolbar - Tamanho e cores */
      .ql-toolbar.ql-snow button {
        width: 28px !important;
        height: 24px !important;
        padding: 3px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      .ql-toolbar.ql-snow button svg {
        width: 18px !important;
        height: 18px !important;
      }

      .ql-toolbar.ql-snow .ql-stroke {
        stroke: rgb(203, 213, 225) !important;
        stroke-width: 2 !important;
      }

      .ql-toolbar.ql-snow .ql-fill {
        fill: rgb(203, 213, 225) !important;
      }

      .ql-toolbar.ql-snow .ql-picker {
        color: rgb(203, 213, 225) !important;
      }

      .ql-toolbar.ql-snow .ql-picker-label {
        color: rgb(203, 213, 225) !important;
        border-color: rgb(100, 116, 139) !important;
      }

      .ql-toolbar.ql-snow button:hover,
      .ql-toolbar.ql-snow button.ql-active {
        background: rgb(71, 85, 105) !important;
      }

      .ql-toolbar.ql-snow .ql-picker-options {
        background: rgb(51, 65, 85) !important;
        border-color: rgb(100, 116, 139) !important;
      }

      .ql-toolbar.ql-snow .ql-picker-item:hover {
        background: rgb(71, 85, 105) !important;
        color: rgb(241, 245, 249) !important;
      }

      .ql-container.ql-snow {
        border: none !important;
        background: rgb(30, 41, 59) !important;
      }

      .ql-editor {
        background-color: rgb(30, 41, 59) !important;
        color: rgb(241, 245, 249) !important;
        min-height: 300px !important;
        max-height: 60vh !important;
        overflow: auto !important;
        padding: 16px !important;
        font-size: 14px !important;
        line-height: 1.35 !important;  /* v1.5.11: Reduzido de 1.6 para fix espaÃ§amento duplo entre parÃ¡grafos */
        resize: vertical !important;
        display: block !important;
      }

      .ql-editor p {
        margin-bottom: 0.25em !important;  /* v1.5.11: EspaÃ§amento sutil para aparÃªncia de quebra Ãºnica */
      }

      /* Negrito destacado em laranja no dark mode */
      .ql-editor strong,
      .ql-editor b {
        color: #fb923c !important;
        font-weight: 700 !important;
      }

      .ql-editor.ql-blank::before {
        color: rgb(148, 163, 184) !important;
        font-style: italic !important;
      }

      /* v1.36.8: Quill usa ::before para todos os marcadores de lista
         NÃƒO usar list-style-type - causa duplicaÃ§Ã£o */
      .ql-editor ul,
      .ql-editor ol {
        list-style-type: none !important;
        padding-left: 2rem !important;
        margin: 1rem 0 !important;
      }

      /* v1.36.9: Override ::before para bullets em <ol>
         Quill CDN nÃ£o tem regra para data-list="bullet" em <ol> */
      .ql-editor ol li[data-list="bullet"]::before {
        content: '\u2022' !important;
        margin-right: 0.3em;
      }

      /* IndentaÃ§Ã£o de parÃ¡grafos - usando margin-left para melhor compatibilidade */
      .ql-editor .ql-indent-1 {
        margin-left: 3em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-2 {
        margin-left: 6em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-3 {
        margin-left: 9em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-4 {
        margin-left: 12em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-5 {
        margin-left: 15em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-6 {
        margin-left: 18em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-7 {
        margin-left: 21em !important;
        padding-left: 0 !important;
      }

      .ql-editor .ql-indent-8 {
        margin-left: 24em !important;
        padding-left: 0 !important;
      }

      /* EspaÃ§amento de ParÃ¡grafos - Compacto */
      .spacing-compact .ql-editor,
      .spacing-compact[contenteditable] {
        line-height: 1.2 !important;
      }
      .spacing-compact .ql-editor p,
      .spacing-compact[contenteditable] p {
        margin-bottom: 0.15em !important;
      }

      /* Normal: line-height 1.35, margin 0.25em (padrÃ£o atual) */
      .spacing-normal .ql-editor,
      .spacing-normal[contenteditable] {
        line-height: 1.35 !important;
      }
      .spacing-normal .ql-editor p,
      .spacing-normal[contenteditable] p {
        margin-bottom: 0.25em !important;
      }

      /* ConfortÃ¡vel: line-height 1.6, margin 0.5em */
      .spacing-comfortable .ql-editor,
      .spacing-comfortable[contenteditable] {
        line-height: 1.6 !important;
      }
      .spacing-comfortable .ql-editor p,
      .spacing-comfortable[contenteditable] p {
        margin-bottom: 0.5em !important;
      }

      /* Amplo: line-height 2.0, margin 1.0em */
      .spacing-wide .ql-editor,
      .spacing-wide[contenteditable] {
        line-height: 2.0 !important;
      }
      .spacing-wide .ql-editor p,
      .spacing-wide[contenteditable] p {
        margin-bottom: 1.0em !important;
      }

      /* Tamanho de Fonte - Normal */
      .fontsize-normal .ql-editor,
      .fontsize-normal[contenteditable] {
        font-size: 14px !important;
      }

      /* Maior: 16px */
      .fontsize-larger .ql-editor,
      .fontsize-larger[contenteditable] {
        font-size: 16px !important;
      }

      /* Grande: 18px */
      .fontsize-largest .ql-editor,
      .fontsize-largest[contenteditable] {
        font-size: 18px !important;
      }

      /* Hover effect para SpacingDropdown (CSS hover, nÃ£o Tailwind) */
      .hover-border-blue-500:hover:not(:disabled) {
        border-color: #3b82f6 !important;
      }

      .ql-editor h1 {
        font-size: 2rem !important;
        font-weight: bold !important;
        margin: 1rem 0 !important;
        color: rgb(241, 245, 249) !important;
      }

      .ql-editor h2 {
        font-size: 1.5rem !important;
        font-weight: bold !important;
        margin: 0.75rem 0 !important;
        color: rgb(241, 245, 249) !important;
      }

      .ql-editor h3 {
        font-size: 1.25rem !important;
        font-weight: bold !important;
        margin: 0.5rem 0 !important;
        color: rgb(241, 245, 249) !important;
      }

      .ql-editor a {
        color: rgb(96, 165, 250) !important;
        text-decoration: underline !important;
      }

      .ql-editor blockquote {
        border-left: 4px solid rgb(100, 116, 139) !important;
        padding-left: 1rem !important;
        margin: 1rem 0 !important;
        color: rgb(203, 213, 225) !important;
        font-style: italic !important;
      }
    `;

    document.head.appendChild(style);
  };

  // ğŸŒ Quill Light Theme Styles
  const injectQuillLightStyles = () => {
    // Remover estilo antigo para garantir atualizaÃ§Ã£o
    const existingStyle = document.getElementById('quill-light-theme-styles');
    if (existingStyle) existingStyle.remove();

    const style = document.createElement('style');
    style.id = 'quill-light-theme-styles';
    style.innerHTML = `
      /* Quill Light Theme - SentencifyAI (CSS Granular) */

      /* Container: fundo bege */
      .quill-light-theme .ql-container.ql-snow {
        background-color: #fefcf3 !important;
        border: none !important;
      }

      /* Ãrea de ediÃ§Ã£o: fundo bege, texto escuro */
      .quill-light-theme .ql-editor {
        background-color: #fefcf3 !important;
        color: #292524 !important; /* Stone 800 */
      }

      /* Sobrescreve parÃ¡grafos e textos especÃ­ficos */
      .quill-light-theme .ql-editor p,
      .quill-light-theme .ql-editor span,
      .quill-light-theme .ql-editor li,
      .quill-light-theme .ql-editor div {
        color: #292524 !important; /* Stone 800 */
      }

      /* Sobrescreve tÃ­tulos */
      .quill-light-theme .ql-editor h1,
      .quill-light-theme .ql-editor h2,
      .quill-light-theme .ql-editor h3,
      .quill-light-theme .ql-editor h4,
      .quill-light-theme .ql-editor h5,
      .quill-light-theme .ql-editor h6 {
        color: #1c1917 !important; /* Stone 900 */
      }

      /* Sobrescreve elementos de formataÃ§Ã£o */
      .quill-light-theme .ql-editor strong,
      .quill-light-theme .ql-editor b {
        color: #000000 !important;
        font-weight: 700 !important;
      }

      .quill-light-theme .ql-editor u {
        text-decoration-color: #000000 !important;
      }

      /* Sobrescreve links */
      .quill-light-theme .ql-editor a {
        color: #2563eb !important; /* Blue 600 */
      }

      /* Sobrescreve blockquotes */
      .quill-light-theme .ql-editor blockquote {
        border-left: 4px solid #d6d3d1 !important; /* Stone 300 */
        color: #57534e !important; /* Stone 600 */
      }

      /* Placeholder */
      .quill-light-theme .ql-editor.ql-blank::before {
        color: #a8a29e !important; /* Stone 400 */
        font-style: italic !important;
      }

      /* v1.9.17: Toolbar - Tema Claro (Stone) */
      .quill-light-theme .ql-toolbar.ql-snow {
        background: #f5f5f4 !important;
        border-bottom: 1px solid #d6d3d1 !important;
      }

      /* Ãcones da toolbar - cor escura */
      .quill-light-theme .ql-toolbar.ql-snow .ql-stroke {
        stroke: #57534e !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow .ql-fill {
        fill: #57534e !important;
      }

      /* Picker (dropdowns) */
      .quill-light-theme .ql-toolbar.ql-snow .ql-picker {
        color: #44403c !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow .ql-picker-label {
        color: #44403c !important;
        border-color: #a8a29e !important;
      }

      /* Dropdown aberto - fundo azul claro, texto preto */
      .quill-light-theme .ql-toolbar.ql-snow .ql-picker-options {
        background: #dbeafe !important;
        border-color: #93c5fd !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow .ql-picker-item {
        color: #000000 !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow .ql-picker-item:hover {
        background: #bfdbfe !important;
        color: #000000 !important;
      }

      /* Hover nos botÃµes */
      .quill-light-theme .ql-toolbar.ql-snow button:hover,
      .quill-light-theme .ql-toolbar.ql-snow button.ql-active {
        background: #e7e5e3 !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow button:hover .ql-stroke,
      .quill-light-theme .ql-toolbar.ql-snow button.ql-active .ql-stroke {
        stroke: #1c1917 !important;
      }

      .quill-light-theme .ql-toolbar.ql-snow button:hover .ql-fill,
      .quill-light-theme .ql-toolbar.ql-snow button.ql-active .ql-fill {
        fill: #1c1917 !important;
      }
    `;

    document.head.appendChild(style);
  };

  // ğŸ“ Quill.js Loader (FASE 4 - Rich Text Editor)
  useEffect(() => {
    const MAX_RETRIES = 3;
    const RETRY_DELAY = 2000; // 2 segundos
    let styleDelayTimeout: ReturnType<typeof setTimeout> | null = null;
    let retryTimeout: ReturnType<typeof setTimeout> | null = null;
    let isMounted = true;

    // Verificar se jÃ¡ existe script carregando/carregado
    const existingScript = document.getElementById('quill-library-js');
    const existingCSS = document.getElementById('quill-theme-css');

    // Se Quill jÃ¡ estÃ¡ disponÃ­vel e scripts existem, apenas inicializar estilos
    if (window.Quill && existingScript && existingCSS) {
      styleDelayTimeout = setTimeout(() => {
        if (isMounted) {
          injectQuillStyles();
          injectQuillLightStyles();
          setQuillReady(true);
          setQuillError(null);
        }
      }, 100);
      return () => { isMounted = false; if (styleDelayTimeout) clearTimeout(styleDelayTimeout); };
    }

    // Remover scripts antigos apenas se nÃ£o houver Quill ativo
    if (!window.Quill) {
      if (existingScript) existingScript.remove();
      if (existingCSS) existingCSS.remove();
    }

    // Carregar CSS primeiro
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css';
    link.id = 'quill-theme-css';

    link.onerror = () => {
      if (isMounted) setQuillError(new Error('Falha ao carregar tema do editor'));
    };

    document.head.appendChild(link);

    // Carregar JavaScript
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js';
    script.async = true;
    script.id = 'quill-library-js';

    script.onload = () => {
      if (!isMounted) return;
      if (window.Quill) {
        styleDelayTimeout = setTimeout(() => {
          if (isMounted) {
            injectQuillStyles();
            injectQuillLightStyles();
            setQuillReady(true);
            setQuillError(null);
          }
        }, 100);
      } else {
        setQuillError(new Error('Biblioteca carregada mas nÃ£o disponÃ­vel'));
      }
    };

    script.onerror = () => {
      if (!isMounted) return;
      if (quillRetryCount < MAX_RETRIES) {
        retryTimeout = setTimeout(() => {
          if (isMounted) setQuillRetryCount(prev => prev + 1);
        }, RETRY_DELAY);
      } else {
        setQuillError(new Error(`Falha ao carregar editor apÃ³s ${MAX_RETRIES} tentativas. Verifique sua conexÃ£o.`));
      }
    };

    document.head.appendChild(script);

    // Cleanup
    return () => {
      isMounted = false;
      if (styleDelayTimeout) clearTimeout(styleDelayTimeout);
      if (retryTimeout) clearTimeout(retryTimeout);
    };
  }, [quillRetryCount]);

  useEffect(() => {
        // loadAiSettings() agora estÃ¡ dentro do hook useAIIntegration

        if (primaryTabLock.isPrimaryTab) {
      storage.checkSavedSession(openModal);
    }
  }, [primaryTabLock.isPrimaryTab]);

  
  // Resetar pÃ¡gina de modelos quando filtros/busca mudarem
  useEffect(() => {
    modelLibrary.setCurrentModelPage(1);
  }, [modelLibrary.searchTerm, modelLibrary.selectedCategory, modelLibrary.showFavoritesOnly]);

  // ğŸš€ OTIMIZAÃ‡ÃƒO v1.4.1: Agrupar useEffects relacionados (keyboard + scroll management)
  useEffect(() => {
    // Atalho Ctrl+S para salvar
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (editingTopic) {
          saveTopicEditWithoutClosing();
        } else if (modals.modelForm) {
          saveModelWithoutClosing();
        }
      }
    };

    document.addEventListener('keydown', handleKeyDown);

    return () => {
      document.removeEventListener('keydown', handleKeyDown);
    };
  }, [editingTopic, modals.modelForm]);

  // ESC para fechar modal de configuraÃ§Ãµes
  // v1.36.46: NÃ£o fechar se ModelGeneratorModal estÃ¡ aberto (respeitar hierarquia)
  React.useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && modals.settings && !modelGeneratorModal.isOpen) {
        closeModal('settings');
      }
    };

    if (modals.settings) {
      window.addEventListener('keydown', handleEscape);
    }

    return () => window.removeEventListener('keydown', handleEscape);
  }, [modals.settings, closeModal, modelGeneratorModal.isOpen]);

  // v1.35.64: Bloquear scroll do body quando modal de configuraÃ§Ãµes aberto
  React.useEffect(() => {
    if (modals.settings) {
      const originalOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      return () => {
        document.body.style.overflow = originalOverflow;
      };
    }
  }, [modals.settings]);

  // ğŸš€ OTIMIZAÃ‡ÃƒO v1.7: Observer para marcar dirty (FASE 1.1) - DEPS REDUZIDAS
  // ğŸ”„ v1.9.1: Agora usa HASHES para detectar ediÃ§Ãµes de campos (nÃ£o apenas add/remove)
  // Observa apenas valores primitivos (strings, numbers) ao invÃ©s de objetos/arrays completos
  // Isso reduz drasticamente re-renders (primitive comparison vs deep comparison)
  useEffect(() => {
    // Marca como dirty quando qualquer estado crÃ­tico mudar
    // Este effect Ã© LEVE (apenas seta flag booleana, nÃ£o faz save)
    // v1.13.7: Incluir arquivos de Upload na condiÃ§Ã£o
    if (extractedTopics.length > 0 || selectedTopics.length > 0 ||
        proofManager.proofFiles.length > 0 || proofManager.proofTexts.length > 0 ||
        peticaoFiles.length > 0 || contestacaoFiles.length > 0 || complementaryFiles.length > 0 ||
        (aiIntegration.tokenMetrics.requestCount || 0) > 0) {
      markSessionDirty();
      // ğŸš« v1.9.5: DESABILITADO - Timestamp de ediÃ§Ã£o nÃ£o mais usado (sync removido)
      // localStateRef.current.lastLocalEditTimestamp = Date.now();
    }
  }, [
    processoNumero,
    pastedPeticaoTexts?.length || 0,
    extractedTopicsHash,  // âœ… Detecta mudanÃ§as em tÃ­tulo, conteÃºdo, categoria
    selectedTopicsHash,   // âœ… Detecta mudanÃ§as em tÃ­tulo, conteÃºdo, categoria
    proofsHash,           // âœ… Detecta mudanÃ§as em provas (files, texts, extracted)
    uploadHash,           // v1.13.6: Detecta mudanÃ§as em Upload (extractedTexts, documentProcessingModes)
    // Outros lengths (nÃ£o precisam de hash pois sÃ£o simples)
    pastedContestacaoTexts?.length || 0,
    pastedComplementaryTexts?.length || 0,
    (analyzedDocuments?.peticoes?.length || 0) + (analyzedDocuments?.contestacoes?.length || 0) + (analyzedDocuments?.complementares?.length || 0),
    partesProcesso?.reclamante || '',
    partesProcesso?.reclamadas || '',
    aiIntegration.tokenMetrics.requestCount,  // v1.22.01: Persistir tokens ao contabilizar
    markSessionDirty
  ]);

  // v1.12.28: Manter snapshot atualizado para evitar stale closures no auto-save
  // Este useEffect roda a cada render e atualiza o ref com os valores atuais
  // Assim, o setTimeout dentro do auto-save sempre acessa dados frescos via ref
  React.useEffect(() => {
    currentSessionSnapshotRef.current = {
      processoNumero,
      pastedPeticaoTexts,
      pastedContestacaoTexts,
      pastedComplementaryTexts,
      extractedTopics,
      selectedTopics,
      partesProcesso,
      activeTab,
      analyzedDocuments,
      // v1.13.5: Incluir extractedTexts para nÃ£o perder textos de Upload
      extractedTexts,
      // v1.13.6: Incluir modos de processamento de Upload
      documentProcessingModes,
      // v1.13.7: Indicador de arquivos de Upload (para decidir se deve salvar sessÃ£o)
      hasUploadFiles: !!(peticaoFiles.length > 0 || contestacaoFiles.length > 0 || complementaryFiles.length > 0),
      // v1.20.3: Arquivos de Upload (para autoSaveSession)
      peticaoFiles,
      contestacaoFiles,
      complementaryFiles,
      proofFiles: proofManager.proofFiles,
      proofTexts: proofManager.proofTexts,
      proofUsePdfMode: proofManager.proofUsePdfMode,
      proofSendFullContent: proofManager.proofSendFullContent, // v1.19.2: Persistir flag enviar conteÃºdo completo
      extractedProofTexts: proofManager.extractedProofTexts,
      proofExtractionFailed: proofManager.proofExtractionFailed,
      proofTopicLinks: proofManager.proofTopicLinks,
      proofAnalysisResults: proofManager.proofAnalysisResults,
      proofConclusions: proofManager.proofConclusions,
      // v1.20.3: Contador de tokens persistente
      tokenMetrics: aiIntegration.tokenMetrics
    };
  });

  // ğŸš€ OTIMIZAÃ‡ÃƒO v1.7: Auto-save quando dirty (FASE 1.1) - Pesado, mas sÃ³ roda quando flag muda
  // SeparaÃ§Ã£o: Observer (leve) marca dirty â†’ Este effect (pesado) faz o save
  // BenefÃ­cio: Save com debounce nÃ£o recria a cada mudanÃ§a de estado
  useEffect(() => {
    // ğŸ”’ v1.9.5: PROTEÃ‡ÃƒO - Apenas aba primÃ¡ria pode salvar sessÃ£o
    if (!primaryTabLock.isPrimaryTab) {
      setAutoSaveDirty(false);
      return;
    }

    // Skip se nÃ£o estÃ¡ dirty
    if (!autoSaveDirty) return;

    // v1.12.28: Usar ref para verificaÃ§Ã£o (evita stale closure)
    const currentSnapshot = currentSessionSnapshotRef.current;

    // Skip se nÃ£o hÃ¡ dados para salvar
    // v1.13.7: Incluir verificaÃ§Ã£o de arquivos de Upload
    if (!currentSnapshot ||
        ((currentSnapshot.extractedTopics?.length || 0) === 0 &&
         (currentSnapshot.selectedTopics?.length || 0) === 0 &&
         (currentSnapshot.proofFiles?.length || 0) === 0 &&
         (currentSnapshot.proofTexts?.length || 0) === 0 &&
         !currentSnapshot.hasUploadFiles)) {
      setAutoSaveDirty(false);
      return;
    }

    // Limpar timer anterior
    if (autoSaveTimerRef.current) {
      clearTimeout(autoSaveTimerRef.current);
    }

    // Debounce: aguardar 3s antes de salvar
    // v1.12.28: Usar ref para snapshot (evita stale closure - bug das provas sumindo)
    autoSaveTimerRef.current = setTimeout(() => {
      const snapshot = currentSessionSnapshotRef.current;
      if (!snapshot) return;

      // Comparar com Ãºltimo snapshot (evitar saves duplicados)
      const currentJson = JSON.stringify(snapshot);
      if (currentJson !== lastAutoSaveSnapshotRef.current) {
        storage.autoSaveSession(snapshot, (err) => err && setError(err));
        lastAutoSaveSnapshotRef.current = currentJson;
      }

      // Limpar dirty flag
      setAutoSaveDirty(false);
    }, AUTO_SAVE_DEBOUNCE_MS);

    return () => {
      if (autoSaveTimerRef.current) {
        clearTimeout(autoSaveTimerRef.current);
      }
    };
  }, [autoSaveDirty, primaryTabLock.isPrimaryTab]); // ğŸ”’ v1.9.5: + lock para proteger save


  // ğŸ› ï¸ FUNÃ‡Ã•ES UTILITÃRIAS

  React.useEffect(() => {
    const handleBeforeUnload = (e: BeforeUnloadEvent) => {
      const skipBeforeunload = sessionStorage.getItem('sentencify-skip-beforeunload');
      if (skipBeforeunload) {
        sessionStorage.removeItem('sentencify-skip-beforeunload');
        return; // Sair sem salvar
      }

      // ğŸ”¥ SAVE FORÃ‡ADO: Salvar modelos imediatamente no IndexedDB antes de sair
      if (modelLibrary.models.length > 0 && indexedDB.isSupported) {
        try {
          // ğŸš€ OTIMIZAÃ‡ÃƒO v1.7 (FASE 1.2): Hash comparison ao invÃ©s de JSON.stringify
          // Evita bloquear main thread por 50-200ms no beforeunload
          const lastHash = modelsHashRef.current;

          if (currentModelsHash !== lastHash) {
            // âš ï¸ NOTA: IndexedDB Ã© assÃ­ncrono, mas tentamos salvar aqui
            // O navegador pode ou nÃ£o aguardar a operaÃ§Ã£o completar
            // Por isso mantemos tambÃ©m o auto-save com debounce
            indexedDB.saveModels(modelLibrary.models).catch(err => {
            });

            // Atualizar ref imediatamente (otimista)
            modelsHashRef.current = currentModelsHash;

          } else {
          }
        } catch (err) {
        }
      }

      // â„¹ï¸ AVISO OPCIONAL: Pode ser removido jÃ¡ que temos persistÃªncia automÃ¡tica
      // Mantido apenas como lembrete de que exportaÃ§Ã£o Ã© recomendada
      // (NÃ£o bloqueia a saÃ­da da pÃ¡gina)
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [currentModelsHash, indexedDB.isSupported]); // Hash ao invÃ©s de models array

  // PersistÃªncia e SessÃ£o
  const checkSavedSession = () => {
    try {
      const saved = localStorage.getItem('sentencifySession');
      if (saved) {
        const session = JSON.parse(saved);
        storage.setSessionLastSaved(session.savedAt);
        openModal('restoreSession');
      }
    } catch (err) {
    }
  };


  // ğŸ”’ SanitizaÃ§Ã£o com DOMPurify (memoizada)
  const sanitizeHTML = React.useCallback((dirty: string | null | undefined) => {
    // Se DOMPurify nÃ£o estiver carregado ainda, retorna string vazia para seguranÃ§a
    if (!domPurifyReady || !window.DOMPurify) {
      return ''; // Mais seguro retornar vazio do que conteÃºdo nÃ£o sanitizado
    }

    // ConfiguraÃ§Ã£o de sanitizaÃ§Ã£o para permitir apenas tags seguras de formataÃ§Ã£o
    const cleanHTML = window.DOMPurify.sanitize(dirty || '', {
      ALLOWED_TAGS: [
        'p', 'br', 'div', 'span',           // Estrutura
        'strong', 'b', 'em', 'i', 'u',      // FormataÃ§Ã£o bÃ¡sica
        'ul', 'ol', 'li',                    // Listas
        'h1', 'h2', 'h3', 'h4', 'h5', 'h6', // CabeÃ§alhos
        'blockquote'                         // v1.36.6: CitaÃ§Ãµes
      ],
      ALLOWED_ATTR: [
        'class', 'id', 'style',              // Atributos permitidos (limitados)
        'data-list'                          // v1.36.6: Tipo de lista (bullet/ordered)
      ],
      ALLOWED_STYLES: {
        '*': {
          'font-weight': [/^bold$/],
          'font-style': [/^italic$/],
          'text-decoration': [/^underline$/],
          'text-align': [/^(left|center|right|justify)$/],  // v1.36.6: Alinhamento
          'margin-left': [/^\d+(\.\d+)?(em|px|rem)$/],      // v1.36.6: Indent
          'padding-left': [/^\d+(\.\d+)?(em|px|rem)$/],     // v1.36.6: Blockquote
          'border-left': [/.*/]                              // v1.36.6: Blockquote
        }
      },
      KEEP_CONTENT: true,                     // Preserva conteÃºdo de tags removidas
      RETURN_TRUSTED_TYPE: false
    });

    return cleanHTML;
  }, [domPurifyReady]); // âœ… EstÃ¡vel - sÃ³ muda quando DOMPurify carrega

  // ğŸ“ Utility functions para Quill.js (movidas para escopo global)

  // FunÃ§Ã£o de teste de sanitizaÃ§Ã£o (disponÃ­vel no console via window.testSanitization)
  const testSanitization = (testHTML: string) => {
    const sanitized = sanitizeHTML(testHTML);
    return sanitized;
  };

  // Expor funÃ§Ã£o de teste no console (desenvolvimento)
  if (typeof window !== 'undefined') {
    window.testSanitization = testSanitization;
    window.checkDOMPurify = () => ({
      version: window.DOMPurify?.version || 'Desconhecida',
      isSupported: domPurifyReady && !!window.DOMPurify
    });
  }

  // ğŸ§  v1.25: NER HANDLERS - IA Offline para detecÃ§Ã£o de nomes

  // Ref para garantir inicializaÃ§Ã£o Ãºnica (proteÃ§Ã£o contra StrictMode/re-renders)
  const nerInitStartedRef = useRef(false);

  // Verificar arquivos do modelo NER + auto-inicializar se anonimizaÃ§Ã£o ativa
  const anonymizationEnabled = aiIntegration?.aiSettings?.anonymization?.enabled;
  React.useEffect(() => {
    if (anonymizationEnabled) {
      // Auto-inicializar se anonimizaÃ§Ã£o ativa e arquivos presentes
      // v1.32.00: Verificar status do modelo NER via novo AIModelService
      setNerModelReady(AIModelService.isReady('ner'));
    } else {
      // v1.32.00: Descarregar modelo quando anonimizaÃ§Ã£o desabilitada
      if (AIModelService.isReady('ner')) {
        console.log('[NER] Descarregando modelo...');
        AIModelService.unload('ner').then(() => {
          setNerModelReady(false);
        });
      }
    }
  }, [anonymizationEnabled]);

  // v1.32.00: Handlers simplificados (modelos sÃ£o baixados automaticamente)
  const initNerModel = async () => {
    if (nerInitializing || nerModelReady) return;
    setNerInitializing(true);
    setNerDownloadProgress(0);

    // Listener para progresso do download
    const unsubscribe = AIModelService.subscribe((status, progress) => {
      if (progress.ner > 0) {
        setNerDownloadProgress(Math.round(progress.ner));
      }
    });

    try {
      await AIModelService.init('ner');
      setNerModelReady(true);
      showToast('Modelo NER pronto!', 'success');
    } catch (err) {
      showToast('Erro ao inicializar NER: ' + (err as Error).message, 'error');
    } finally {
      setNerInitializing(false);
      setNerDownloadProgress(0);
      unsubscribe();
    }
  };

  // ğŸ” v1.32.00: HANDLERS: Busca SemÃ¢ntica (E5-base) - Simplificado
  const searchInitStartedRef = useRef(false);

  // v1.32.00: Verificar status e contar embeddings ao montar
  React.useEffect(() => {
    const checkSearchModel = async () => {
      try {
        setSearchModelReady(AIModelService.isReady('search'));
        const count = await EmbeddingsService.getCount();
        setEmbeddingsCount(count);
      } catch (err) {
        console.warn('[Search] Erro ao verificar:', err);
      }
    };
    checkSearchModel();
  }, []);

  // v1.32.00: Inicializar modelo de busca com progresso
  const initSearchModel = async () => {
    if (searchInitializing || searchModelReady) return;
    setSearchInitializing(true);
    setSearchDownloadProgress(0);

    // Listener para progresso do download
    const unsubscribe = AIModelService.subscribe((status, progress) => {
      if (progress.search > 0) {
        setSearchDownloadProgress(Math.round(progress.search));
      }
    });

    try {
      await AIModelService.init('search');
      setSearchModelReady(true);
      showToast('Modelo de busca pronto!', 'success');
    } catch (err) {
      showToast('Erro ao inicializar: ' + (err as Error).message, 'error');
    } finally {
      setSearchInitializing(false);
      setSearchDownloadProgress(0);
      unsubscribe();
    }
  };

  // v1.32.00: Handler MASTER - controla carregamento/descarregamento do modelo E5
  const handleSearchToggle = async (newEnabled: boolean) => {
    setSearchEnabled(newEnabled);
    localStorage.setItem('searchEnabled', JSON.stringify(newEnabled));

    if (!newEnabled) {
      // Desligando: descarregar modelo E5 da memÃ³ria
      if (AIModelService.isReady('search')) {
        await AIModelService.unload('search');
        setSearchModelReady(false);
        console.log('[SEARCH] Modelo E5 descarregado');
      }
    }
  };

  // v1.32.17: NER agora Ã© carregado sob demanda (ao clicar "Detectar Nomes")
  // Removido auto-init para economizar ~2GB de RAM
  // O modelo serÃ¡ carregado automaticamente em extractEntities() quando necessÃ¡rio

  // v1.32.06: Auto-inicializar Search ao carregar pÃ¡gina se estava ativado
  React.useEffect(() => {
    if (searchEnabled && !searchModelReady && !searchInitializing) {
      if (import.meta.env.DEV) console.log('[SEARCH] Auto-inicializando modelo (estava ativado)...');
      // Delay para nÃ£o bloquear render inicial
      const timer = setTimeout(() => {
        initSearchModel();
      }, 1000); // Delay maior para nÃ£o competir com NER
      return () => clearTimeout(timer);
    }
  }, []); // eslint-disable-line react-hooks/exhaustive-deps

  // v1.28.00: Toggle individual de legislaÃ§Ã£o (nÃ£o afeta modelo E5)
  // v1.28.01: Ao habilitar, tambÃ©m seta modo semÃ¢ntico como padrÃ£o na aba
  // v1.35.74: Agora usa aiIntegration.setAiSettings (persiste automaticamente)
  const handleLegislacaoToggle = (newEnabled: boolean) => {
    aiIntegration.setAiSettings(prev => ({ ...prev, semanticSearchEnabled: newEnabled }));
    if (newEnabled) localStorage.setItem('legislacaoSemanticMode', 'true');
  };

  // v1.28.01: Handler para toggle de JurisprudÃªncia
  // v1.35.74: Agora usa aiIntegration.setAiSettings
  const handleJurisToggle = (newEnabled: boolean) => {
    aiIntegration.setAiSettings(prev => ({ ...prev, jurisSemanticEnabled: newEnabled }));
    if (newEnabled) localStorage.setItem('jurisSemanticMode', 'true');
  };

  // v1.28.01: Handler para toggle de Modelos
  // v1.35.74: Agora usa aiIntegration.setAiSettings
  const handleModelToggle = (newEnabled: boolean) => {
    aiIntegration.setAiSettings(prev => ({ ...prev, modelSemanticEnabled: newEnabled }));
    if (newEnabled) localStorage.setItem('modelSemanticMode', 'true');
  };

  // Limpar todos os embeddings
  const clearEmbeddings = async () => {
    try {
      await EmbeddingsService.clearAll();
      setEmbeddingsCount(0);
      showToast('Embeddings removidos', 'info');
    } catch (err) {
      showToast('Erro ao limpar embeddings: ' + (err as Error).message, 'error');
    }
  };

  // v1.26.04: Importar embeddings de arquivo JSON (gerado pelo script Python)
  const embeddingsFileInputRef = useRef<HTMLInputElement | null>(null);
  const [importingEmbeddings, setImportingEmbeddings] = useState(false);

  const handleImportEmbeddings = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    setImportingEmbeddings(true);
    try {
      const text = await file.text();
      const items = JSON.parse(text);

      if (!Array.isArray(items) || items.length === 0) {
        throw new Error('Arquivo invÃ¡lido: deve ser um array de embeddings');
      }

      // Verificar estrutura
      const first = items[0];
      if (!first.id || !first.embedding || !Array.isArray(first.embedding)) {
        throw new Error('Formato invÃ¡lido: cada item deve ter id e embedding');
      }

      // Salvar em batches
      const BATCH_SIZE = 100;
      for (let i = 0; i < items.length; i += BATCH_SIZE) {
        const batch = items.slice(i, i + BATCH_SIZE);
        await EmbeddingsService.saveEmbeddingsBatch(batch);
        setEmbeddingsProgress({ current: Math.min(i + BATCH_SIZE, items.length), total: items.length });
      }

      const count = await EmbeddingsService.getCount();
      setEmbeddingsCount(count);
      showToast(`${items.length} embeddings importados com sucesso!`, 'success');
    } catch (err) {
      showToast('Erro ao importar: ' + (err as Error).message, 'error');
      console.error('Import error:', err);
    } finally {
      setImportingEmbeddings(false);
      setEmbeddingsProgress({ current: 0, total: 0 });
      event.target.value = '';
    }
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“š v1.27.00: FUNÃ‡Ã•ES DE EMBEDDINGS PARA JURISPRUDÃŠNCIA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Hook de jurisprudÃªncia para acessar precedentes
  const jurisprudencia = useJurisprudencia();

  // Limpar embeddings de jurisprudÃªncia
  const clearJurisEmbeddings = async () => {
    try {
      await JurisEmbeddingsService.clearAll();
      setJurisEmbeddingsCount(0);
      showToast('Embeddings de jurisprudÃªncia removidos', 'info');
    } catch (err) {
      showToast('Erro ao limpar embeddings: ' + (err as Error).message, 'error');
    }
  };

  // ğŸ“¦ v1.27.01: Gerar embeddings para modelos (inline)
  const generateModelEmbeddings = async () => {
    if (!searchModelReady) {
      showToast('Modelo de busca nÃ£o estÃ¡ pronto', 'error');
      return;
    }
    if (generatingModelEmbeddings) return;

    const modelsWithoutEmbedding = modelLibrary.models.filter(m => !m.embedding || m.embedding.length !== 768);
    if (!modelsWithoutEmbedding.length) {
      showToast('Todos os modelos jÃ¡ tÃªm embeddings', 'info');
      return;
    }

    setGeneratingModelEmbeddings(true);
    setModelEmbeddingsProgress({ current: 0, total: modelsWithoutEmbedding.length });

    // v1.27.03: Yield para React renderizar estado de loading
    await new Promise(resolve => setTimeout(resolve, 50));

    try {
      const stripHTML = (html: string) => {
        const div = document.createElement('div');
        div.innerHTML = html || '';
        return div.textContent || div.innerText || '';
      };

      for (let i = 0; i < modelsWithoutEmbedding.length; i++) {
        const model = modelsWithoutEmbedding[i];
        const text = [model.title, model.keywords, stripHTML(model.content).slice(0, 2000)].filter(Boolean).join(' ');
        const embedding = await AIModelService.getEmbedding(text, 'passage');
        model.embedding = embedding;
        setModelEmbeddingsProgress({ current: i + 1, total: modelsWithoutEmbedding.length });
        // Yield to event loop para permitir que React renderize o progresso
        await new Promise(resolve => setTimeout(resolve, 0));
      }

      // Salvar modelos atualizados
      await indexedDB.saveModels(modelLibrary.models);
      // v1.27.03: Trigger re-render para atualizar contador
      modelLibrary.setModels([...modelLibrary.models]);
      showToast(`${modelsWithoutEmbedding.length} embeddings de modelos gerados`, 'success');
    } catch (err) {
      showToast('Erro ao gerar embeddings: ' + (err as Error).message, 'error');
      console.error('[MODEL-SEARCH] Erro:', err);
    } finally {
      setGeneratingModelEmbeddings(false);
      setModelEmbeddingsProgress({ current: 0, total: 0 });
    }
  };

  // Limpar embeddings dos modelos
  const clearModelEmbeddings = async () => {
    try {
      const updatedModels = modelLibrary.models.map(m => {
        const { embedding, ...rest } = m;
        return rest;
      });
      await indexedDB.saveModels(updatedModels);
      showToast('Embeddings dos modelos removidos', 'info');
    } catch (err) {
      showToast('Erro ao limpar embeddings: ' + (err as Error).message, 'error');
    }
  };

  // Importar embeddings de jurisprudÃªncia de arquivo JSON
  const [importingJurisEmbeddings, setImportingJurisEmbeddings] = useState(false);

  const handleImportJurisEmbeddings = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    setImportingJurisEmbeddings(true);
    try {
      const text = await file.text();
      const items = JSON.parse(text);

      if (!Array.isArray(items) || items.length === 0) {
        throw new Error('Arquivo invÃ¡lido: deve ser um array de embeddings');
      }

      const first = items[0];
      if (!first.id || !first.embedding || !Array.isArray(first.embedding)) {
        throw new Error('Formato invÃ¡lido: cada item deve ter id e embedding');
      }

      const BATCH_SIZE = 100;
      for (let i = 0; i < items.length; i += BATCH_SIZE) {
        const batch = items.slice(i, i + BATCH_SIZE);
        await JurisEmbeddingsService.saveEmbeddingsBatch(batch);
        setJurisEmbeddingsProgress({ current: Math.min(i + BATCH_SIZE, items.length), total: items.length });
      }

      const count = await JurisEmbeddingsService.getCount();
      setJurisEmbeddingsCount(count);
      showToast(`${items.length} embeddings de jurisprudÃªncia importados!`, 'success');
    } catch (err) {
      showToast('Erro ao importar: ' + (err as Error).message, 'error');
      console.error('[JURIS-SEARCH] Import error:', err);
    } finally {
      setImportingJurisEmbeddings(false);
      setJurisEmbeddingsProgress({ current: 0, total: 0 });
      event.target.value = '';
    }
  };

  // Inicializar contagem de embeddings de jurisprudÃªncia
  React.useEffect(() => {
    JurisEmbeddingsService.getCount().then(setJurisEmbeddingsCount).catch(() => {});
  }, []);

  // ğŸŒ v1.33.0: Verificar se embeddings precisam ser baixados do CDN
  React.useEffect(() => {
    const checkEmbeddingsNeeded = async () => {
      try {
        const legCount = await EmbeddingsService.getCount();
        const jurisCount = await JurisEmbeddingsService.getCount();

        const legNeeded = legCount === 0;
        const jurisNeeded = jurisCount === 0;

        setEmbeddingsDownloadStatus(prev => ({
          legislacao: { ...prev.legislacao, needed: legNeeded },
          jurisprudencia: { ...prev.jurisprudencia, needed: jurisNeeded }
        }));

        // Mostrar modal se algum embedding estiver faltando e usuÃ¡rio nÃ£o dismissou
        if ((legNeeded || jurisNeeded) && !dismissedEmbeddingsPrompt) {
          // Delay para nÃ£o bloquear renderizaÃ§Ã£o inicial
          setTimeout(() => setShowEmbeddingsDownloadModal(true), 2000);
        }
      } catch (err) {
        console.warn('[CDN] Erro ao verificar embeddings:', err);
      }
    };

    checkEmbeddingsNeeded();
  }, [dismissedEmbeddingsPrompt]);

  // ğŸ“¥ v1.33.61: Verificar se dados (legislaÃ§Ã£o/jurisprudÃªncia) precisam ser baixados do CDN
  React.useEffect(() => {
    const checkDataNeeded = async () => {
      try {
        const legNeeded = await EmbeddingsCDNService.needsDataDownload('legislacao');
        const jurisNeeded = await EmbeddingsCDNService.needsDataDownload('jurisprudencia');

        setDataDownloadStatus(prev => ({
          legislacao: { ...prev.legislacao, needed: legNeeded },
          jurisprudencia: { ...prev.jurisprudencia, needed: jurisNeeded }
        }));

        // Mostrar modal se algum dado estiver faltando e usuÃ¡rio nÃ£o dismissou
        if ((legNeeded || jurisNeeded) && !dismissedDataPrompt) {
          // Delay para nÃ£o bloquear renderizaÃ§Ã£o inicial
          setTimeout(() => setShowDataDownloadModal(true), 1500);
        }
      } catch (err) {
        console.warn('[CDN] Erro ao verificar dados:', err);
      }
    };

    checkDataNeeded();
  }, [dismissedDataPrompt]);

  // ğŸ“¥ v1.33.61: Handler para iniciar download de dados do CDN
  const handleStartDataDownload = async () => {
    if (!navigator.onLine) {
      showToast('Sem conexÃ£o com a internet', 'error');
      return;
    }

    const { legislacao: legStatus, jurisprudencia: jurisStatus } = dataDownloadStatus;

    // Download legislaÃ§Ã£o se necessÃ¡rio
    if (legStatus.needed && !legStatus.downloading && !legStatus.completed) {
      setDataDownloadStatus(prev => ({
        ...prev,
        legislacao: { ...prev.legislacao, downloading: true, error: null }
      }));

      try {
        const count = await EmbeddingsCDNService.downloadLegislacaoData(
          (progress) => {
            setDataDownloadStatus(prev => ({
              ...prev,
              legislacao: { ...prev.legislacao, progress }
            }));
          }
        );

        // Atualizar artigos no hook de legislaÃ§Ã£o
        await legislacao.reloadArtigos();

        setDataDownloadStatus(prev => ({
          ...prev,
          legislacao: { needed: false, downloading: false, progress: 1, error: null, completed: true }
        }));
        showToast(`${count} artigos de legislaÃ§Ã£o baixados!`, 'success');
      } catch (err) {
        setDataDownloadStatus(prev => ({
          ...prev,
          legislacao: { ...prev.legislacao, downloading: false, error: (err as Error).message }
        }));
        showToast('Erro ao baixar legislaÃ§Ã£o: ' + (err as Error).message, 'error');
      }
    }

    // Download jurisprudÃªncia se necessÃ¡rio
    if (jurisStatus.needed && !jurisStatus.downloading && !jurisStatus.completed) {
      setDataDownloadStatus(prev => ({
        ...prev,
        jurisprudencia: { ...prev.jurisprudencia, downloading: true, error: null }
      }));

      try {
        const count = await EmbeddingsCDNService.downloadJurisprudenciaData(
          (progress) => {
            setDataDownloadStatus(prev => ({
              ...prev,
              jurisprudencia: { ...prev.jurisprudencia, progress }
            }));
          }
        );

        // Atualizar precedentes no state via hook
        await jurisprudencia.reloadPrecedentes();

        setDataDownloadStatus(prev => ({
          ...prev,
          jurisprudencia: { needed: false, downloading: false, progress: 1, error: null, completed: true }
        }));
        showToast(`${count} precedentes baixados!`, 'success');
      } catch (err) {
        setDataDownloadStatus(prev => ({
          ...prev,
          jurisprudencia: { ...prev.jurisprudencia, downloading: false, error: (err as Error).message }
        }));
        showToast('Erro ao baixar jurisprudÃªncia: ' + (err as Error).message, 'error');
      }
    }
  };

  // ğŸ“¥ v1.33.61: Dismiss data download modal
  const handleDismissDataPrompt = () => {
    setShowDataDownloadModal(false);
    setDismissedDataPrompt(true);
    localStorage.setItem('dismissedDataPrompt', 'true');
  };

  // ğŸŒ v1.33.0: Handler para iniciar download de embeddings do CDN
  const handleStartEmbeddingsDownload = async () => {
    if (!navigator.onLine) {
      showToast('Sem conexÃ£o com a internet', 'error');
      return;
    }

    const { legislacao, jurisprudencia } = embeddingsDownloadStatus;

    // Download legislaÃ§Ã£o se necessÃ¡rio
    if (legislacao.needed && !legislacao.downloading) {
      setEmbeddingsDownloadStatus(prev => ({
        ...prev,
        legislacao: { ...prev.legislacao, downloading: true, error: null }
      }));

      try {
        await EmbeddingsCDNService.downloadLegislacao(
          (progress) => {
            setEmbeddingsDownloadStatus(prev => ({
              ...prev,
              legislacao: { ...prev.legislacao, progress }
            }));
          }
        );

        const count = await EmbeddingsService.getCount();
        setEmbeddingsCount(count);
        setEmbeddingsDownloadStatus(prev => ({
          ...prev,
          legislacao: { needed: false, downloading: false, progress: 1, error: null }
        }));
        showToast('LegislaÃ§Ã£o baixada com sucesso!', 'success');
      } catch (err) {
        setEmbeddingsDownloadStatus(prev => ({
          ...prev,
          legislacao: { ...prev.legislacao, downloading: false, error: (err as Error).message }
        }));
        showToast('Erro ao baixar legislaÃ§Ã£o: ' + (err as Error).message, 'error');
      }
    }

    // Download jurisprudÃªncia se necessÃ¡rio
    if (jurisprudencia.needed && !jurisprudencia.downloading) {
      setEmbeddingsDownloadStatus(prev => ({
        ...prev,
        jurisprudencia: { ...prev.jurisprudencia, downloading: true, error: null }
      }));

      try {
        await EmbeddingsCDNService.downloadJurisprudencia(
          (progress) => {
            setEmbeddingsDownloadStatus(prev => ({
              ...prev,
              jurisprudencia: { ...prev.jurisprudencia, progress }
            }));
          }
        );

        const count = await JurisEmbeddingsService.getCount();
        setJurisEmbeddingsCount(count);
        setEmbeddingsDownloadStatus(prev => ({
          ...prev,
          jurisprudencia: { needed: false, downloading: false, progress: 1, error: null }
        }));
        showToast('JurisprudÃªncia baixada com sucesso!', 'success');
      } catch (err) {
        setEmbeddingsDownloadStatus(prev => ({
          ...prev,
          jurisprudencia: { ...prev.jurisprudencia, downloading: false, error: (err as Error).message }
        }));
        showToast('Erro ao baixar jurisprudÃªncia: ' + (err as Error).message, 'error');
      }
    }

    // Fechar modal apÃ³s ambos terminarem (ou se nenhum precisava)
    const finalStatus = embeddingsDownloadStatus;
    if (!finalStatus.legislacao.downloading && !finalStatus.jurisprudencia.downloading) {
      setShowEmbeddingsDownloadModal(false);
    }
  };

  // ğŸŒ v1.33.0: Handler para dismissar o prompt de download
  const handleDismissEmbeddingsPrompt = () => {
    setShowEmbeddingsDownloadModal(false);
    setDismissedEmbeddingsPrompt(true);
    localStorage.setItem('dismissedEmbeddingsPrompt', 'true');
  };

  // v1.32.00: Removido SEARCH_FILES_REQUIRED (modelos sÃ£o baixados automaticamente)

  // v1.25: Detectar nomes automaticamente usando NER
  // v1.25.26: Adicionar overrideText para modais de prova
  // v1.28.09: Adicionar skipSetDetecting para feedback visual imediato
  const detectarNomesAutomaticamente = async (overrideText: string | null = null, skipSetDetecting = false) => {
    // v1.32.17: Verificar se NER estÃ¡ habilitado (modelo serÃ¡ carregado sob demanda)
    if (!nerEnabled) {
      showToast('Ative o NER em ConfiguraÃ§Ãµes IA para detectar nomes automaticamente.', 'error');
      return;
    }

    if (!skipSetDetecting) setDetectingNames(true);

    try {
      let textoCompleto;

      // v1.25.26: Se overrideText fornecido, usar diretamente (modal de prova)
      if (overrideText && typeof overrideText === 'string' && overrideText.trim().length > 50) {
        textoCompleto = overrideText.slice(0, 3000); // Limitar a 3000 chars
      } else {
        // Coletar APENAS qualificaÃ§Ã£o das partes (~1000 chars por doc)
        // Nomes aparecem nos primeiros ~500-800 chars (cabeÃ§alho)
        const CHARS_PER_PAGE = 1000;
        const textos: string[] = [];
        const textosHash = new Set<string>(); // Para deduplicaÃ§Ã£o

      // Helper: adicionar texto se nÃ£o for duplicata
      const addTexto = (txt: string | null) => {
        if (!txt || txt.length < 50) return;
        const hash = txt.slice(0, 200); // Usar primeiros 200 chars como hash
        if (!textosHash.has(hash)) {
          textosHash.add(hash);
          textos.push(txt);
        }
      };

      // Helper: extrair texto de string ou objeto (sÃ³ primeira pÃ¡gina)
      const getFirstPage = (t: { text?: string | null } | string | null | undefined) => {
        if (!t) return null;
        const fullText = typeof t === 'string' ? t : (t.text || null);
        if (!fullText) return null;
        return fullText.slice(0, CHARS_PER_PAGE);
      };

      // Helper: extrair primeira pÃ¡gina de um PDF
      const extractFirstPageFromPDF = async (fileObj: { file?: File } | File) => {
        try {
          const file = (fileObj as { file?: File }).file ?? (fileObj as File);
          if (!file || !(file instanceof Blob)) return null;
          const text = await documentServices.extractTextFromPDFPure(file);
          return text ? text.slice(0, CHARS_PER_PAGE) : null;
        } catch (e) {
          console.warn('[NER] Falha ao extrair PDF:', (e as Error).message);
          return null;
        }
      };

      // 1. Textos COLADOS (jÃ¡ disponÃ­veis, limitados a 3000 chars)
      pastedPeticaoTexts?.forEach(t => addTexto(getFirstPage(t)));
      pastedContestacaoTexts?.forEach(t => addTexto(getFirstPage(t)));

      // 2. PDFs - extrair primeira pÃ¡gina de cada (PRIORIDADE: funciona antes da anÃ¡lise!)
      for (const fileObj of (peticaoFiles || [])) {
        const txt = await extractFirstPageFromPDF(fileObj);
        addTexto(txt);
      }
      for (const fileObj of (contestacaoFiles || [])) {
        const txt = await extractFirstPageFromPDF(fileObj);
        addTexto(txt);
      }

      // 3. Se extractedTexts JÃ tiver dados, usar tambÃ©m (fallback)
      extractedTexts?.peticoes?.forEach(p => addTexto(getFirstPage(p)));
      extractedTexts?.contestacoes?.forEach(c => addTexto(getFirstPage(c)));

      textoCompleto = textos.join('\n\n');

      if (!textoCompleto.trim()) {
        showToast('Nenhum documento carregado para anÃ¡lise.', 'error');
        setDetectingNames(false);
        return;
      }
    } // Fim do else (coleta de texto de petiÃ§Ã£o/contestaÃ§Ã£o)

    // Executar NER
    const entidades = await AIModelService.extractEntities(textoCompleto);

    // v1.25.23: Separar STOP_WORDS em dois grupos para evitar filtrar "ALMEIDA" (contÃ©m "ME")
    // v1.29.02: Removido LTDA/EIRELI - sÃ£o sufixos vÃ¡lidos de empresas que agora detectamos
    const STOP_WORDS_CONTAINS = [
      'V . EXA', 'V. EXA', 'VOSSA EXCELÃŠNCIA', 'V.EXA',
      'RECLAMANTE', 'RECLAMADA', 'RECLAMADO',
      'TRIBUNAL'
    ];

    // Palavras curtas que devem ser palavras inteiras (word boundary)
    const STOP_WORDS_EXACT = [
      'EXA', 'MM', 'DR', 'DRA', 'SR', 'SRA', 'EXMO', 'EXMA',
      'CPF', 'CNPJ', 'CEP', 'RG', 'CTPS', 'PIS',
      'S/A', 'S.A', 'ME', 'EPP', 'AUTOR', 'RÃ‰U',
      'JUIZ', 'JUÃZO', 'VARA', 'TST', 'TRT'
    ];

    // FunÃ§Ã£o para verificar se Ã© palavra inteira (word boundary)
    const containsExactWord = (text: string, word: string) => {
      const regex = new RegExp(`\\b${word}\\b`, 'i');
      return regex.test(text);
    };

    // v1.25.22: Lista de gentÃ­licos/estados civis que nÃ£o sÃ£o nomes de pessoas
    const GENTILIC_WORDS = [
      'PARAENSE', 'PAULISTA', 'CARIOCA', 'MINEIRO', 'MINEIRA',
      'GAÃšCHO', 'GAÃšCHA', 'BAIANO', 'BAIANA', 'CATARINENSE',
      'GOIANO', 'GOIANA', 'CAPIXABA', 'AMAPAENSE', 'AMAZONENSE',
      'ACREANO', 'ACREANA', 'RONDONIENSE', 'RORAIMENSE', 'TOCANTINENSE',
      'MARANHENSE', 'PIAUIENSE', 'CEARENSE', 'POTIGUAR', 'PARAIBANO', 'PARAIBANA',
      'PERNAMBUCANO', 'PERNAMBUCANA', 'ALAGOANO', 'ALAGOANA', 'SERGIPANO', 'SERGIPANA',
      'PARANAENSE', 'MATOGROSSENSE', 'SULMATOGROSSENSE', 'BRASILIENSE',
      'BRASILEIRO', 'BRASILEIRA', 'SOLTEIRO', 'SOLTEIRA', 'CASADO', 'CASADA',
      'DIVORCIADO', 'DIVORCIADA', 'VIÃšVO', 'VIÃšVA', 'SEPARADO', 'SEPARADA'
    ];

    // v1.29.01: STOP_WORDS para ORG (tribunais, Ã³rgÃ£os pÃºblicos, termos jurÃ­dicos)
    // NÃƒO inclui LTDA, EIRELI, S/A, ME, EPP - sÃ£o sufixos legÃ­timos de nomes de empresas
    const ORG_STOP_WORDS = [
      'JUSTIÃ‡A DO TRABALHO', 'TRIBUNAL REGIONAL', 'TRIBUNAL SUPERIOR',
      'TRT', 'TST', 'STF', 'STJ', 'TRF', 'TRE',
      'MINISTÃ‰RIO PÃšBLICO', 'MPT', 'MPF', 'MPE',
      'VARA DO TRABALHO', 'VARA CÃVEL', 'JUÃZO',
      'RECLAMANTE', 'RECLAMADA', 'RECLAMADO', 'AUTOR', 'RÃ‰U', 'RÃ‰US',
      'CNPJ', 'CEI', 'CPF',
      'UNIÃƒO FEDERAL', 'MUNICÃPIO DE', 'PREFEITURA DE', 'GOVERNO DO',
      'INSS', 'CEF', 'CAIXA ECONÃ”MICA FEDERAL', 'BANCO DO BRASIL', 'FGTS',
      'EXCELENTÃSSIMO', 'V. EXA', 'SECRETARIA'
    ];
    const ORG_MIN_SCORE = 0.85; // v1.29.01: Reduzido para capturar mais empresas

    // v1.29: Filtrar pessoas (PER/PESSOA) e opcionalmente ORG
    const isPessoa = (e: { type: string }) => e.type.includes('PER') || e.type.includes('PESSOA');
    const isOrg = (e: { type: string }) => e.type.includes('ORG');

    const entidadesFiltradas = entidades.filter(e => {
      if (isPessoa(e)) return true;
      if (nerIncludeOrg && isOrg(e)) {
        if (e.score < ORG_MIN_SCORE) return false;
        const upper = e.text.toUpperCase();
        if (ORG_STOP_WORDS.some(sw => upper.includes(sw))) return false;
        return true;
      }
      return false;
    });

    // v1.33.14: Fallback regex para ORG nÃ£o detectadas pelo modelo
    // Captura padrÃµes conhecidos: "NOME LTDA", "NOME EIRELI", "NOME S/A", etc.
    // Limitado a 4 palavras antes do sufixo para evitar capturar contexto demais
    if (nerIncludeOrg) {
      const ORG_REGEX = /\b([A-Z0-9]+(?:\s+[A-Z0-9]+){0,3})\s+(LTDA|EIRELI|S\.?A\.?|ME|EPP)\b/gi;
      const ORG_PREFIX_STOP = ['O', 'A', 'OS', 'AS', 'DE', 'DO', 'DA', 'EM', 'FACE', 'CONTRA', 'RECLAMADA', 'RECLAMANTE'];
      const textoUpper = textoCompleto.toUpperCase();
      let match;
      while ((match = ORG_REGEX.exec(textoUpper)) !== null) {
        let fullOrg = match[0].trim().replace(/\s+/g, ' '); // Normalizar espaÃ§os mÃºltiplos
        // Remover palavras comuns do inÃ­cio
        let words = fullOrg.split(' ');
        while (words.length > 2 && ORG_PREFIX_STOP.includes(words[0])) {
          words.shift();
        }
        fullOrg = words.join(' ');
        // Verificar se jÃ¡ nÃ£o foi detectado pelo modelo
        const alreadyDetected = entidadesFiltradas.some(e =>
          e.text.toUpperCase().includes(fullOrg) || fullOrg.includes(e.text.toUpperCase())
        );
        if (!alreadyDetected && !ORG_STOP_WORDS.some(sw => fullOrg.includes(sw))) {
          console.log(`[NER] Fallback ORG: "${fullOrg}"`);
          entidadesFiltradas.push({ text: fullOrg, type: 'ORG', score: 0.9, start: 0, end: fullOrg.length });
        }
      }
    }

    // v1.29.02: Manter tipo junto com texto para fuzzy dedup separado
    const nomesComTipo = entidadesFiltradas.map(e => ({
      text: e.text.toUpperCase(),
      isOrg: isOrg(e)
    }));

    // v1.25.23: Filtro com STOP_WORDS separados (contains vs exact)
    // Deduplica por texto primeiro, mantendo o tipo
    const seen = new Map();
    nomesComTipo.forEach(item => {
      if (!seen.has(item.text)) seen.set(item.text, item);
    });
    const nomesFiltrados = [...seen.values()].filter(item =>
      item.text.length >= 4 &&
      !STOP_WORDS_CONTAINS.some(sw => item.text.includes(sw)) &&
      !STOP_WORDS_EXACT.some(sw => containsExactWord(item.text, sw)) &&
      !GENTILIC_WORDS.includes(item.text.trim())
    );

    // Fuzzy Deduplication: mesclar variaÃ§Ãµes do mesmo nome
    const similarity = (a: string, b: string) => {
      const longer = a.length > b.length ? a : b;
      const shorter = a.length > b.length ? b : a;
      if (longer.length === 0) return 1.0;
      if (longer.includes(shorter)) return shorter.length / longer.length;
      const wordsA = a.split(/\s+/);
      const wordsB = b.split(/\s+/);
      const common = wordsA.filter((w: string) => wordsB.some((wb: string) => wb.includes(w) || w.includes(wb)));
      return common.length / Math.max(wordsA.length, wordsB.length);
    };

    // v1.29.02: Fuzzy dedup separado por tipo (PER vs ORG)
    const nomesUnicos: { text: string; isOrg: boolean }[] = [];
    for (const item of nomesFiltrados) {
      const similarIdx: number = nomesUnicos.findIndex(n => {
        // SÃ³ comparar entidades do mesmo tipo
        if (n.isOrg !== item.isOrg) return false;
        // Threshold mais alto para ORG (0.85) vs PER (0.7)
        const threshold = item.isOrg ? 0.85 : 0.7;
        return similarity(n.text, item.text) > threshold;
      });
      if (similarIdx >= 0) {
        if (item.text.length > nomesUnicos[similarIdx].text.length) {
          console.log(`[NER] Fuzzy merge: "${nomesUnicos[similarIdx].text}" â†’ "${item.text}"`);
          nomesUnicos[similarIdx] = item;
        }
      } else {
        nomesUnicos.push(item);
      }
    }
    console.log('[NER] Nomes apÃ³s fuzzy dedup:', nomesUnicos.map(n => n.text));

    // v1.25.24: Limpar gentÃ­licos do final dos nomes
    // v1.29.02: nomesUnicos agora Ã© array de {text, isOrg}
    const nomesLimpos = nomesUnicos.map(item => {
      let limpo = item.text;
      for (const gentilic of GENTILIC_WORDS) {
        if (limpo.endsWith(' ' + gentilic)) {
          limpo = limpo.slice(0, -(gentilic.length + 1)).trim();
        }
      }
      return limpo;
    });

    if (nomesLimpos.length === 0) {
      showToast('Nenhum nome detectado nos documentos.', 'info');
      return;
    }

    // Merge com nomes existentes
    const nomesAtuais = anonymizationNamesText.split(/[\n,]/).map(n => n.trim().toUpperCase()).filter(n => n);
    const todoNomes = [...new Set([...nomesAtuais, ...nomesLimpos])];

    // Atualizar textarea
    setAnonymizationNamesText(todoNomes.join('\n'));

    showToast(`Detectados ${nomesLimpos.length} nome(s). Total: ${todoNomes.length}`, 'success');

  } catch (err) {
    console.error('Erro na detecÃ§Ã£o de nomes:', err);
    showToast('Erro ao detectar nomes: ' + (err as Error).message, 'error');
  } finally {
    setDetectingNames(false);
  }
};


  const exportAiSettings = async () => {
    const dataStr = JSON.stringify(aiIntegration.aiSettings, null, 2);
    
    try {
      await navigator.clipboard.writeText(dataStr);
      
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sentencify-configuracoes-' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('ConfiguraÃ§Ãµes exportadas com sucesso! Arquivo baixado e copiado para Ã¡rea de transferÃªncia.', 'success');
    } catch (err) {
      showToast('Erro ao exportar configuraÃ§Ãµes: ' + (err as Error).message, 'error');
    }
  };

  const importAiSettings = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    try {
      const text = await file.text();
      const importedSettings = JSON.parse(text);
      
      if (typeof importedSettings !== 'object') {
        showToast('Arquivo invÃ¡lido.', 'error');
        return;
      }

      const mergedSettings = {
        model: importedSettings.model || 'claude-sonnet-4-20250514',
        useExtendedThinking: importedSettings.useExtendedThinking || false,
        customPrompt: importedSettings.customPrompt || '',
        modeloRelatorio: importedSettings.modeloRelatorio || '',
        modeloDispositivo: importedSettings.modeloDispositivo || '',
        modeloTopicoRelatorio: importedSettings.modeloTopicoRelatorio || '',
        // v1.12.25: autoExtractPDFText removido - usa apenas ocrEngine
        topicosComplementares: importedSettings.topicosComplementares || [
          { id: 1, title: 'HONORÃRIOS ADVOCATÃCIOS', category: 'MÃ‰RITO', enabled: true, ordem: 1 },
          { id: 2, title: 'HONORÃRIOS PERICIAIS', category: 'MÃ‰RITO', enabled: true, ordem: 2 },
          { id: 3, title: 'JUROS E CORREÃ‡ÃƒO MONETÃRIA', category: 'MÃ‰RITO', enabled: true, ordem: 3 },
          { id: 4, title: 'DEDUÃ‡Ã•ES DE NATUREZA PREVIDENCIÃRIA E FISCAL', category: 'MÃ‰RITO', enabled: true, ordem: 4 },
          { id: 5, title: 'COMPENSAÃ‡ÃƒO/DEDUÃ‡ÃƒO/ABATIMENTO', category: 'MÃ‰RITO', enabled: true, ordem: 5 }
        ]
      };

      aiIntegration.setAiSettings(prev => ({
        ...prev,
        ...mergedSettings
      }));
      showToast('ConfiguraÃ§Ãµes importadas com sucesso!', 'success');
      event.target.value = '';
    } catch (err) {
      showToast('Erro ao importar: ' + (err as Error).message, 'error');
      event.target.value = '';
    }
  };

  const showToast = (message: string, type: 'error' | 'success' | 'info' | 'warning' = 'success') => {
    setToast({ show: true, message, type });
    setTimeout(() => {
      setToast({ show: false, message: '', type: 'success' });
    }, 4000); // Auto-hide after 4 seconds
  };

  // v1.15.3: FunÃ§Ãµes para Slash Menu (acesso rÃ¡pido a modelos com \)
  const findSlashPosition = (text: string, triggerPos: number) => {
    if (text[triggerPos] === '\\') return triggerPos;
    if (text[triggerPos + 1] === '\\') return triggerPos + 1;
    if (triggerPos > 0 && text[triggerPos - 1] === '\\') return triggerPos - 1;
    return -1;
  };

  const openSlashMenu = React.useCallback((data: { position: { top: number; left: number }; quillInstance: QuillInstance | null; triggerPosition: number }) => {
    setSlashMenu({
      isOpen: true,
      position: data.position,
      searchTerm: '',
      selectedIndex: 0,
      quillInstance: data.quillInstance,
      triggerPosition: data.triggerPosition
    });
  }, []);

  const closeSlashMenu = React.useCallback((removeSlash = false) => {
    setSlashMenu(prev => {
      if (removeSlash && prev.quillInstance && typeof prev.triggerPosition === 'number') {
        try {
          const quill = prev.quillInstance;
          const text = quill.getText();
          const slashPos = findSlashPosition(text, prev.triggerPosition);
          if (slashPos >= 0) {
            quill.deleteText(slashPos, 1);
            setTimeout(() => {
              quill.focus();
              quill.setSelection(slashPos, 0);
            }, 0);
          }
        } catch (e) { /* Quill pode estar indisponÃ­vel */ }
      }
      return { ...prev, isOpen: false };
    });
  }, []);

  const navigateSlashMenu = React.useCallback((direction: 'up' | 'down', maxItems: number = 10) => {
    setSlashMenu(prev => {
      if (direction === 'down') {
        return { ...prev, selectedIndex: Math.min(prev.selectedIndex + 1, maxItems - 1) };
      } else {
        return { ...prev, selectedIndex: Math.max(prev.selectedIndex - 1, 0) };
      }
    });
  }, []);

  const selectModelFromSlash = React.useCallback((model: Model) => {
    const { quillInstance, triggerPosition } = slashMenu;
    if (!quillInstance || !model) {
      closeSlashMenu();
      return;
    }

    try {
      const text = quillInstance.getText();
      const slashPos = findSlashPosition(text, triggerPosition);
      if (slashPos < 0) { closeSlashMenu(); return; }

      const currentPos = quillInstance.getSelection()?.index || slashPos + 1;
      const deleteLength = currentPos - slashPos;
      if (deleteLength > 0) quillInstance.deleteText(slashPos, deleteLength);

      const sanitizedContent = sanitizeHTML(model.content);
      quillInstance.clipboard.dangerouslyPasteHTML(slashPos, sanitizedContent);

      closeSlashMenu();
      showToast(`Modelo "${model.title}" inserido`, 'success');
    } catch (err) {
      closeSlashMenu();
    }
  }, [slashMenu, closeSlashMenu, showToast]);

  const updateSlashSearchTerm = React.useCallback((term: string) => {
    setSlashMenu(prev => ({ ...prev, searchTerm: term, selectedIndex: 0 }));
  }, []);

  // v1.15.4: ESC global para fechar slash menu
  React.useEffect(() => {
    if (!slashMenu.isOpen) return;

    const handleGlobalKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        e.stopPropagation();
        closeSlashMenu(true);
      }
    };

    document.addEventListener('keydown', handleGlobalKeyDown, true);
    return () => document.removeEventListener('keydown', handleGlobalKeyDown, true);
  }, [slashMenu.isOpen, closeSlashMenu]);

  // v1.15.4: Click fora do menu fecha
  React.useEffect(() => {
    if (!slashMenu.isOpen) return;

    const handleClickOutside = (e: MouseEvent) => {
      const menuEl = document.querySelector('.slash-command-menu');
      if (menuEl && !menuEl.contains(e.target as Node)) {
        closeSlashMenu(true);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [slashMenu.isOpen, closeSlashMenu]);

  useEffect(() => {
    if (editingTopic) {
      aiIntegration.setRelatorioInstruction(''); // Limpar instruÃ§Ã£o ao mudar de tÃ³pico
    }
  }, [editingTopic?.title]); // SÃ³ roda quando o TÃTULO mudar (trocar de tÃ³pico)

  useEffect(() => {
    if (lastEditedTopicTitle && activeTab === 'topics') {
      let nestedTimeoutId: ReturnType<typeof setTimeout> | null = null;
      // Timeout maior para garantir que o DOM foi atualizado apÃ³s troca de aba
      const timeoutId = setTimeout(() => {
        const element = topicRefs.current[lastEditedTopicTitle];
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          nestedTimeoutId = setTimeout(() => setLastEditedTopicTitle(null), 2000);
        } else {
          setLastEditedTopicTitle(null); // Limpa para nÃ£o ficar travado
        }
      }, 300); // Aumentado de 100ms para 300ms

      return () => {
        clearTimeout(timeoutId);
        if (nestedTimeoutId) clearTimeout(nestedTimeoutId);
      };
    }
  }, [lastEditedTopicTitle, activeTab]);

  // v1.20.2: Cleanup de refs Ã³rfÃ£s quando tÃ³picos mudam
  React.useEffect(() => {
    if (selectedTopics?.length) {
      cleanupTopicRefs(selectedTopics.map(t => t.title));
    }
  }, [selectedTopics, cleanupTopicRefs]);

  // ğŸ”§ HELPER FUNCTIONS - v1.3.5.1

  // Verifica se um tÃ³pico estÃ¡ decidido
  const isTopicDecidido = React.useCallback((topic: Topic) => {
    if (!topic) return false;

    // DISPOSITIVO usa editedContent
    if (isDispositivo(topic)) {
      return topic.editedContent && topic.editedContent.trim() !== '';
    }

    if (isRelatorio(topic)) {
      return (topic.editedRelatorio && topic.editedRelatorio.trim() !== '') ||
             (topic.relatorio && topic.relatorio.trim() !== '');
    }

    // TÃ³picos normais precisam de conteÃºdo E resultado selecionado
    const temConteudo = topic.editedFundamentacao && topic.editedFundamentacao.trim() !== '';
    const temResultado = topic.resultado && topic.resultado.trim() !== '';

    return temConteudo && temResultado;
  }, []);

  // ğŸš€ OTIMIZAÃ‡Ã•ES DE PERFORMANCE - v1.2.7

  // ğŸ“Š Contadores memoizados para evitar recÃ¡lculos a cada render
  const topicsDecididos = React.useMemo(() => {
    return selectedTopics.filter(t =>
      isTopicDecidido(t) &&
      t.title.toUpperCase() !== 'RELATÃ“RIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO'
    ).length;
  }, [selectedTopics, isTopicDecidido]);

  const topicsPendentes = React.useMemo(() => {
    return selectedTopics.filter(t =>
      !isTopicDecidido(t) &&
      t.title.toUpperCase() !== 'RELATÃ“RIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO'
    ).length;
  }, [selectedTopics, isTopicDecidido]);

  const topicsSemDecisao = React.useMemo(() => {
    return selectedTopics.filter(t => !isTopicDecidido(t));
  }, [selectedTopics, isTopicDecidido]);

  const topicsSemResultado = React.useMemo(() => {
    return selectedTopics.filter(t =>
      t.title.toUpperCase() !== 'RELATÃ“RIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO' &&
      !t.resultado
    );
  }, [selectedTopics]);

  const canGenerateDispositivo = React.useMemo(() => {
    // Precisa ter pelo menos 1 tÃ³pico selecionado
    if (selectedTopics.length === 0) {
      return { enabled: false, reason: 'Nenhum tÃ³pico selecionado' };
    }

    // Filtrar tÃ³picos relevantes (exceto RELATÃ“RIO e DISPOSITIVO)
    const topicsRelevantes = selectedTopics.filter(t =>
      t.title.toUpperCase() !== 'RELATÃ“RIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO'
    );

    if (topicsRelevantes.length === 0) {
      return { enabled: false, reason: 'Nenhum tÃ³pico de mÃ©rito/preliminar selecionado' };
    }

    // Verificar tÃ³picos sem conteÃºdo (fundamentaÃ§Ã£o nÃ£o escrita)
    const semConteudo = topicsRelevantes.filter(t =>
      !t.editedFundamentacao || t.editedFundamentacao.trim() === ''
    );

    // Verificar tÃ³picos com conteÃºdo mas sem resultado selecionado
    const semResultado = topicsRelevantes.filter(t =>
      t.editedFundamentacao && t.editedFundamentacao.trim() !== '' &&
      (!t.resultado || t.resultado.trim() === '')
    );

    const totalPendentes = semConteudo.length + semResultado.length;

    if (totalPendentes > 0) {
      // Construir mensagem detalhada
      let detalhes = [];

      if (semConteudo.length > 0) {
        const primeiros = semConteudo.slice(0, 3).map(t => t.title);
        const resto = semConteudo.length > 3 ? ` e mais ${semConteudo.length - 3}` : '';
        detalhes.push(`${semConteudo.length} sem conteÃºdo: ${primeiros.join(', ')}${resto}`);
      }

      if (semResultado.length > 0) {
        const primeiros = semResultado.slice(0, 3).map(t => t.title);
        const resto = semResultado.length > 3 ? ` e mais ${semResultado.length - 3}` : '';
        detalhes.push(`${semResultado.length} sem resultado: ${primeiros.join(', ')}${resto}`);
      }

      return {
        enabled: false,
        reason: `${totalPendentes} tÃ³pico${totalPendentes > 1 ? 's' : ''} pendente${totalPendentes > 1 ? 's' : ''} (${detalhes.join(' | ')})`
      };
    }

    return { enabled: true, reason: '' };
  }, [selectedTopics]);

  // v1.14.5: Excluir DISPOSITIVO para evitar ruÃ­do do conteÃºdo antigo
  const topicsParaDispositivo = React.useMemo(() => {
    return selectedTopics.filter(topic =>
      topic.title.toUpperCase() !== 'RELATÃ“RIO' &&
      topic.title.toUpperCase() !== 'DISPOSITIVO' &&
      topic.resultado !== 'SEM RESULTADO'
    );
  }, [selectedTopics]);

  const selectedTopicTitles = React.useMemo(() =>
    selectedTopics.map(t => t.title).join('|'),
    [selectedTopics.map(t => t.title).join('|')]
  );

  // v1.19.2: Normalizar comparaÃ§Ã£o case-insensitive para evitar duplicatas
  const unselectedTopics = React.useMemo(() => {
    return extractedTopics.filter(topic =>
      !selectedTopics.find(st =>
        (st.title || '').toUpperCase().trim() === (topic.title || '').toUpperCase().trim()
      )
    );
  }, [extractedTopics, selectedTopicTitles]);

  // ğŸ¯ HANDLERS COM useCallback (memoizados para evitar recriaÃ§Ã£o)

  // v1.33.58: dnd-kit sensors e handler para drag and drop com wheel scroll
  const dndSensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // MÃ­nimo de 8px de movimento antes de iniciar drag (evita cliques acidentais)
      },
    })
  );

  // v1.33.60: Set prÃ©-computado para lookup O(1) no collision detection
  const specialTopicIds = React.useMemo(() => {
    return new Set(
      selectedTopics
        .filter(t => isSpecialTopic(t))
        .map(t => t.id || t.title)
    );
  }, [selectedTopics]);

  // v1.33.60: Collision detection otimizado - O(n) ao invÃ©s de O(nÂ²)
  // Ignora RELATÃ“RIO e DISPOSITIVO para evitar feedback visual enganoso
  const customCollisionDetection = React.useCallback((args: Parameters<typeof closestCenter>[0]) => {
    const { droppableContainers, ...rest } = args;

    // Filtrar usando Set (O(1) por lookup)
    const filteredContainers = droppableContainers.filter(
      container => !specialTopicIds.has(container.id)
    );

    return closestCenter({ ...rest, droppableContainers: filteredContainers });
  }, [specialTopicIds]);

  const handleDndDragEnd = React.useCallback((event: { active: { id: string | number }; over: { id: string | number } | null }) => {
    const { active, over } = event;
    if (!over || active.id === over.id) return;

    const oldIndex = selectedTopics.findIndex((t: Topic) => (t.id || t.title) === active.id);
    const newIndex = selectedTopics.findIndex((t: Topic) => (t.id || t.title) === over.id);

    // Proteger tÃ³picos especiais (RELATÃ“RIO e DISPOSITIVO)
    if (isSpecialTopic(selectedTopics[oldIndex]) || isSpecialTopic(selectedTopics[newIndex])) {
      return;
    }

    const reordered = arrayMove(selectedTopics, oldIndex, newIndex);
    setSelectedTopics(reordered);
  }, [selectedTopics, setSelectedTopics]);

  // v1.33.58: Handlers HTML5 antigos mantidos temporariamente para complementares
  const handleDragStart = React.useCallback((e: React.DragEvent<HTMLElement>, index: number) => {
    // Bloquear drag de RELATÃ“RIO e DISPOSITIVO
    const topic = selectedTopics[index];
    if (isSpecialTopic(topic)) {
      e.preventDefault();
      return;
    }

    setDraggedIndex(index);
    e.dataTransfer.effectAllowed = 'move';
    // Adiciona um pequeno delay para permitir o visual do drag
    (e.currentTarget as HTMLElement).style.opacity = '0.5';
  }, [selectedTopics]);

  const handleDragEnd = React.useCallback((e: React.DragEvent<HTMLElement>) => {
    (e.currentTarget as HTMLElement).style.opacity = '1';
    setDraggedIndex(null);
    setDragOverIndex(null);
  }, []);

  const handleDragOver = React.useCallback((e: React.DragEvent<HTMLElement>, index: number) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';

    if (draggedIndex !== null && draggedIndex !== index) {
      setDragOverIndex(index);
    }

    // ğŸ†• Auto-scroll quando arrastar perto das bordas
    const scrollThreshold = 150; // Ãrea maior para detectar (150px da borda)
    const scrollSpeed = 25; // Scroll mais rÃ¡pido
    const viewportHeight = window.innerHeight;
    const mouseY = e.clientY;

    // Scroll para baixo quando mouse estÃ¡ perto da borda inferior
    if (mouseY > viewportHeight - scrollThreshold) {
      window.scrollBy({
        top: scrollSpeed,
        behavior: 'auto'
      });
    }
    // Scroll para cima quando mouse estÃ¡ perto da borda superior
    else if (mouseY < scrollThreshold) {
      window.scrollBy({
        top: -scrollSpeed,
        behavior: 'auto'
      });
    }
  }, [draggedIndex]);

  const handleDragLeave = React.useCallback((e: React.DragEvent<HTMLElement>) => {
    // SÃ³ limpa se realmente sair do elemento
    if (!e.currentTarget.contains(e.relatedTarget as Node)) {
      setDragOverIndex(null);
    }
  }, []);

  const handleDrop = React.useCallback((e: React.DragEvent<HTMLElement>, dropIndex: number) => {
    e.preventDefault();

    if (draggedIndex === null || draggedIndex === dropIndex) {
      setDraggedIndex(null);
      setDragOverIndex(null);
      return;
    }

    // Bloquear drop em posiÃ§Ãµes de RELATÃ“RIO (0) e DISPOSITIVO (Ãºltima posiÃ§Ã£o)
    const draggedTopic = selectedTopics[draggedIndex];
    const dropTopic = selectedTopics[dropIndex];

    // NÃ£o permitir mover RELATÃ“RIO ou DISPOSITIVO
    if (isSpecialTopic(draggedTopic)) {
      setDraggedIndex(null);
      setDragOverIndex(null);
      return;
    }

    // NÃ£o permitir drop na posiÃ§Ã£o de RELATÃ“RIO ou DISPOSITIVO
    if (isSpecialTopic(dropTopic)) {
      setDraggedIndex(null);
      setDragOverIndex(null);
      return;
    }

    const newTopics = [...selectedTopics];
    const [draggedTopicItem] = newTopics.splice(draggedIndex, 1);
    newTopics.splice(dropIndex, 0, draggedTopicItem);

    setSelectedTopics(newTopics);
    setDraggedIndex(null);
    setDragOverIndex(null);
  }, [draggedIndex, selectedTopics]);

  // ğŸš€ OTIMIZAÃ‡ÃƒO v1.4.1: FunÃ§Ãµes de drag and drop para tÃ³picos complementares com useCallback
  const handleComplementaryDragStart = React.useCallback((e: React.DragEvent<HTMLElement>, index: number) => {
    setDraggedComplementaryIndex(index);
    e.dataTransfer.effectAllowed = 'move';
    (e.currentTarget as HTMLElement).style.opacity = '0.5';
  }, []);

  const handleComplementaryDragEnd = React.useCallback((e: React.DragEvent<HTMLElement>) => {
    (e.currentTarget as HTMLElement).style.opacity = '1';
    setDraggedComplementaryIndex(null);
    setDragOverComplementaryIndex(null);
  }, []);

  const handleComplementaryDragOver = React.useCallback((e: React.DragEvent<HTMLElement>, index: number) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';

    if (draggedComplementaryIndex !== null && index !== draggedComplementaryIndex) {
      setDragOverComplementaryIndex(index);
    }
  }, [draggedComplementaryIndex]);

  const handleComplementaryDragLeave = React.useCallback((e: React.DragEvent<HTMLElement>) => {
    if (e.currentTarget === e.target) {
      setDragOverComplementaryIndex(null);
    }
  }, []);

  const handleComplementaryDrop = React.useCallback((e: React.DragEvent<HTMLElement>, dropIndex: number) => {
    e.preventDefault();

    if (draggedComplementaryIndex === null || draggedComplementaryIndex === dropIndex) {
      setDraggedComplementaryIndex(null);
      setDragOverComplementaryIndex(null);
      return;
    }

    const updatedTopics = [...(aiIntegration.aiSettings.topicosComplementares || [])];
    const [draggedTopic] = updatedTopics.splice(draggedComplementaryIndex, 1);
    updatedTopics.splice(dropIndex, 0, draggedTopic);

    // Recalcular ordem
    const reorderedTopics = updatedTopics.map((topic, idx) => ({
      ...topic,
      ordem: idx + 1
    }));

    aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, topicosComplementares: reorderedTopics });
    setDraggedComplementaryIndex(null);
    setDragOverComplementaryIndex(null);
  }, [draggedComplementaryIndex, aiIntegration.aiSettings.topicosComplementares, aiIntegration.setAiSettings]);

  // ğŸ¯ v1.4.6.3: OPT-06 - Handlers Memoizados para Editor de DecisÃµes
  // Estes handlers sÃ£o passados como props para DecisionEditorContainer.
  // MemoizÃ¡-los evita quebrar React.memo e recalcular useMemo internos.

  const handleFundamentacaoChange = React.useCallback((html: string) => {
    setEditingTopic(prev => {
      if (!prev) return prev;
      return { ...prev, editedFundamentacao: html };
    });
  }, []);

  const handleRelatorioChange = React.useCallback((html: string) => {
    setEditingTopic(prev => {
      if (!prev) return prev;
      return { ...prev, editedRelatorio: html };
    });
  }, []);

  const handleCategoryChange = React.useCallback((newCategory: string) => {
    setEditingTopic(prev => {
      if (!prev) return prev;
      return { ...prev, category: newCategory as TopicCategory };
    });

    // Atualiza selectedTopics
    setSelectedTopics(prevSelected => {
      const selectedIndex = prevSelected.findIndex((t: Topic) => t.title === editingTopic?.title);
      if (selectedIndex === -1) return prevSelected;

      const newSelected = [...prevSelected];
      newSelected[selectedIndex] = { ...newSelected[selectedIndex], category: newCategory as TopicCategory };
      return newSelected;
    });

    // Atualiza extractedTopics
    setExtractedTopics(prevExtracted => {
      const extractedIndex = prevExtracted.findIndex((t: Topic) => t.title === editingTopic?.title);
      if (extractedIndex === -1) return prevExtracted;

      const newExtracted = [...prevExtracted];
      newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], category: newCategory as TopicCategory };
      return newExtracted;
    });
  }, [editingTopic?.title]);

  // ğŸ¨ v1.4.7: Helper Centralizado para ConfiguraÃ§Ã£o de Editores por Tipo
  // Este helper retorna configuraÃ§Ã£o especÃ­fica para cada tipo de tÃ³pico,
  // permitindo especializaÃ§Ã£o de editores sem acoplar componentes filhos.

  const getTopicEditorConfig = React.useCallback((topicTitle: string) => {
    switch(topicTitle?.toUpperCase()) {
      case 'RELATÃ“RIO':
        return {
          showCategory: false,
          showMiniRelatorio: true,
          showDecisionEditor: false,
          relatorioConfig: {
            label: 'ğŸ“„ RelatÃ³rio:',
            minHeight: 'min-h-48',
            showRegenerateSection: true
          },
          editorConfig: {}
        };

      case 'DISPOSITIVO':
        return {
          showCategory: false,
          showMiniRelatorio: false,
          showDecisionEditor: true,
          relatorioConfig: {},
          editorConfig: {
            label: 'ğŸ“‹ Dispositivo:',
            placeholder: 'Descreva o resultado da decisÃ£o (PROCEDENTE, IMPROCEDENTE, etc)...',
            showRegenerateSection: true
          }
        };

      default:
        // TÃ³picos normais (PRELIMINAR, MÃ‰RITO, etc)
        return {
          showCategory: true,
          showMiniRelatorio: true,
          showDecisionEditor: true,
          relatorioConfig: {},
          editorConfig: {}
        };
    }
  }, []);

  // ğŸ“š FUNÃ‡Ã•ES: Gerenciamento de Modelos

    // Hook useModelLibrary jÃ¡ gerencia persistÃªncia via 'sentencify-models'

  // ğŸš€ v1.8.2: Gerar keywords automaticamente com IA (COM CACHE)
  const generateKeywordsWithAI = async () => {
    // VerificaÃ§Ã£o defensiva
    if (!aiIntegration?.callAI) {
      console.error('[generateKeywordsWithAI] aiIntegration.callAI undefined');
      setError('Erro interno: sistema de IA nÃ£o inicializado. Recarregue a pÃ¡gina.');
      return;
    }
    if (!modelLibrary.newModel.title && !modelLibrary.newModel.content) {
      setError('Preencha ao menos o tÃ­tulo ou conteÃºdo para gerar palavras-chave');
      return;
    }

    // ğŸš€ v1.8.2: Gerar cache key baseado em tÃ­tulo + categoria + conteÃºdo
    const cacheKey = `keywords_${modelLibrary.newModel.title}_${modelLibrary.newModel.category}_${modelLibrary.newModel.content}`;

    // ğŸš€ v1.8.2: Verificar cache antes de chamar API
    const cachedKeywords = apiCache.get(cacheKey);
    if (cachedKeywords && typeof cachedKeywords === 'string') {
      modelLibrary.setNewModel({ ...modelLibrary.newModel, keywords: cachedKeywords });
      return; // Retornar imediatamente com resultado cacheado
    }

    aiIntegration.setGeneratingKeywords(true);
    setError('');

    try {
      const prompt = `${AI_PROMPTS.roles.analiseDoc}

MODELO DE DECISÃƒO:
TÃ­tulo: ${modelLibrary.newModel.title || 'NÃ£o fornecido'}
Categoria: ${modelLibrary.newModel.category || 'NÃ£o especificada'}
ConteÃºdo: ${modelLibrary.newModel.content || 'NÃ£o fornecido'}

TAREFA:
Analise o modelo acima e gere palavras-chave (keywords) relevantes que ajudem a identificar e encontrar este modelo.

CRITÃ‰RIOS:
1. Identifique os principais conceitos jurÃ­dicos mencionados
2. Extraia termos tÃ©cnicos relevantes
3. Identifique pedidos ou temas tratados (ex: "horas extras", "adicional noturno", "danos morais")
4. Inclua sinÃ´nimos e variaÃ§Ãµes (ex: "sobrejornada" para "horas extras")
5. Limite a 5-8 palavras-chave mais relevantes
6. Use termos que um usuÃ¡rio provavelmente buscaria

Responda APENAS com as palavras-chave separadas por vÃ­rgula, sem explicaÃ§Ãµes.
Exemplo de resposta vÃ¡lida: horas extras, sobrejornada, adicional, jornada de trabalho, hora extra

NÃ£o adicione explicaÃ§Ãµes, apenas as keywords separadas por vÃ­rgula.`;

      // v1.21.26: Parametros semi-deterministicos para keywords
      const keywords = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], {
        maxTokens: 500,
        useInstructions: false,
        temperature: 0.2,
        topP: 0.9,
        topK: 50
      });

      if (keywords) {
        // ğŸš€ v1.8.2: Armazenar resultado no cache
        apiCache.set(cacheKey, keywords);

        modelLibrary.setNewModel({ ...modelLibrary.newModel, keywords: keywords });
      } else {
        setError('NÃ£o foi possÃ­vel gerar palavras-chave. Tente novamente.');
      }

    } catch (err) {
      setError('Erro ao gerar palavras-chave: ' + (err as Error).message);
    } finally {
      aiIntegration.setGeneratingKeywords(false);
    }
  };

  const generateTitleWithAI = async () => {
    // VerificaÃ§Ã£o defensiva
    if (!aiIntegration?.callAI) {
      console.error('[generateTitleWithAI] aiIntegration.callAI undefined');
      setError('Erro interno: sistema de IA nÃ£o inicializado. Recarregue a pÃ¡gina.');
      return;
    }
    if (!modelLibrary.newModel.content) {
      setError('Preencha o conteÃºdo do modelo para gerar o tÃ­tulo');
      return;
    }

    // Cache key baseado nos primeiros 500 caracteres do conteÃºdo
    const cacheKey = `title_${modelLibrary.newModel.content.substring(0, 500)}`;
    const cachedTitle = apiCache.get(cacheKey);
    if (cachedTitle && typeof cachedTitle === 'string') {
      modelLibrary.setNewModel({ ...modelLibrary.newModel, title: cachedTitle });
      return;
    }

    aiIntegration.setGeneratingTitle(true);
    setError('');

    try {
      const prompt = `${AI_PROMPTS.roles.classificacao}

CONTEÃšDO DO MODELO:
${modelLibrary.newModel.content}

TAREFA:
Analise o conteÃºdo acima e gere um TÃTULO padronizado para este modelo de decisÃ£o.

FORMATO OBRIGATÃ“RIO:
TEMA - SUBTEMA - RESULTADO (PROCEDENTE/IMPROCEDENTE)

EXEMPLOS VÃLIDOS:
- HORAS EXTRAS - SOBREJORNADA HABITUAL - PROCEDENTE
- RESCISÃƒO INDIRETA - ATRASO SALARIAL - PROCEDENTE
- DANOS MORAIS - ASSÃ‰DIO MORAL - IMPROCEDENTE
- ADICIONAL DE INSALUBRIDADE - GRAU MÃ‰DIO - PARCIALMENTE PROCEDENTE
- VÃNCULO EMPREGATÃCIO - PEJOTIZAÃ‡ÃƒO - PROCEDENTE
- EQUIPARAÃ‡ÃƒO SALARIAL - IDENTIDADE DE FUNÃ‡Ã•ES - IMPROCEDENTE

REGRAS:
1. TEMA: Assunto principal (ex: HORAS EXTRAS, DANOS MORAIS, VÃNCULO)
2. SUBTEMA: EspecificaÃ§Ã£o do tema (ex: SOBREJORNADA, ASSÃ‰DIO, PEJOTIZAÃ‡ÃƒO)
3. RESULTADO: PROCEDENTE, IMPROCEDENTE ou PARCIALMENTE PROCEDENTE
4. Sempre em MAIÃšSCULAS
5. Separar com " - " (hÃ­fen com espaÃ§os)

Responda APENAS com o tÃ­tulo no formato especificado, sem explicaÃ§Ãµes.`;

      // v1.21.26: Parametros semi-deterministicos para titulo padronizado
      const title = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], {
        maxTokens: 100,
        useInstructions: false,
        temperature: 0.1,
        topP: 0.9,
        topK: 40
      });

      if (title) {
        apiCache.set(cacheKey, title.trim());
        modelLibrary.setNewModel({ ...modelLibrary.newModel, title: title.trim() });
      } else {
        setError('NÃ£o foi possÃ­vel gerar o tÃ­tulo. Tente novamente.');
      }
    } catch (err) {
      setError('Erro ao gerar tÃ­tulo: ' + (err as Error).message);
    } finally {
      aiIntegration.setGeneratingTitle(false);
    }
  };

  // ğŸ” v1.13.1: Executa salvamento do modelo (chamado apÃ³s verificaÃ§Ã£o de similaridade)
  // v1.27.02: Gera embedding automaticamente se IA local estiver ativa
  const executeSaveModel = async (modelData: Partial<Model> & { id: string; title: string; content: string; embedding?: number[] }, isReplace = false, replaceId: string | null = null) => {
    // Gerar embedding se modelo de busca estiver pronto E opÃ§Ã£o ativada
    if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady && !modelData.embedding) {
      await new Promise(resolve => setTimeout(resolve, 50));
      try {
        const stripHTML = (html: string) => {
          const div = document.createElement('div');
          div.innerHTML = html || '';
          return div.textContent || div.innerText || '';
        };
        const text = [modelData.title, modelData.keywords, stripHTML(modelData.content).slice(0, 2000)].filter(Boolean).join(' ');
        modelData.embedding = await AIModelService.getEmbedding(text, 'passage');
      } catch (err) {
        console.warn('[MODEL-EMBED] Erro ao gerar embedding:', err);
      }
    } else if (!aiIntegration.aiSettings.modelSemanticEnabled && modelData.embedding) {
      delete modelData.embedding;
    }

    if (isReplace && replaceId) {
      const updatedModel = { ...modelData, id: replaceId, updatedAt: new Date().toISOString() };
      const updated = modelLibrary.models.map(m => m.id === replaceId ? updatedModel : m);
      modelLibrary.setModels(updated);
      // v1.34.0: Rastrear update para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('update', updatedModel);
      TFIDFSimilarity.invalidate();
      apiCache.invalidate('suggestions_');
    } else {
      modelLibrary.setModels(prev => [...prev, modelData]);
      // v1.34.0: Rastrear create para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('create', modelData);
      TFIDFSimilarity.invalidate();
      apiCache.invalidate('suggestions_');
    }
    modelLibrary.setHasUnsavedChanges(true);
    setModelSaved(true);
    setTimeout(() => {
      modelLibrary.setNewModel({ title: '', content: '', keywords: '', category: '' });
      if (modelEditorRef.current?.root) modelEditorRef.current.root.innerHTML = '';
      closeModal('modelForm');
      setError('');
      setModelSaved(false);
    }, 1200);
  };

  const saveModel = async (formData?: NewModelData) => {
    // v1.36.1: Aceita dados do formulÃ¡rio diretamente para evitar race condition
    const effectiveModel = formData || modelLibrary.newModel;
    const currentContent = modelEditorRef.current?.root
      ? sanitizeHTML(modelEditorRef.current.root.innerHTML)
      : effectiveModel.content;

    if (!effectiveModel.title || !currentContent) {
      setError('TÃ­tulo e conteÃºdo sÃ£o obrigatÃ³rios');
      return;
    }

    setSavingModel(true);
    // Yield para React renderizar "Salvando..." antes da operaÃ§Ã£o pesada
    await new Promise(resolve => setTimeout(resolve, 50));
    try {
      const editingModel = modelLibrary.editingModel;
      if (editingModel) {
        // EdiÃ§Ã£o de modelo existente - sem verificaÃ§Ã£o de similaridade
        const modelData: Model = {
          ...editingModel,
          title: effectiveModel.title,
          content: currentContent,
          keywords: effectiveModel.keywords,
          category: effectiveModel.category,
          updatedAt: new Date().toISOString()
        };

        // v1.27.02: Regenerar embedding se IA local estiver ativa
        if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady) {
          try {
            const stripHTML = (html: string) => {
              const div = document.createElement('div');
              div.innerHTML = html || '';
              return div.textContent || div.innerText || '';
            };
            const text = [modelData.title, modelData.keywords, stripHTML(modelData.content).slice(0, 2000)].filter(Boolean).join(' ');
            modelData.embedding = await AIModelService.getEmbedding(text, 'passage');
          } catch (err) {
            console.warn('[MODEL-EMBED] Erro ao regenerar embedding:', err);
          }
        } else if (modelData.embedding) {
          // Limpar embedding desatualizado para regenerar depois
          delete modelData.embedding;
        }

        const updated = modelLibrary.models.map(m => m.id === editingModel.id ? modelData : m);
        modelLibrary.setModels(updated);
        // v1.34.0: Rastrear update para sync
        if (cloudSync?.trackChange) cloudSync.trackChange('update', modelData);
        modelLibrary.setHasUnsavedChanges(true);
        TFIDFSimilarity.invalidate();
        apiCache.invalidate('suggestions_');
        modelLibrary.setEditingModel(null);
        setModelSaved(true);
        setTimeout(() => {
          modelLibrary.setNewModel({ title: '', content: '', keywords: '', category: '' });
          if (modelEditorRef.current?.root) modelEditorRef.current.root.innerHTML = '';
          closeModal('modelForm');
          setError('');
          setModelSaved(false);
        }, 1200);
      } else {
        // Novo modelo - verificar similaridade
        const modelId = generateModelId();
        const modelData: Model = {
          id: modelId,
          title: effectiveModel.title,
          content: currentContent,
          keywords: effectiveModel.keywords,
          category: effectiveModel.category,
          createdAt: new Date().toISOString()
        };

        // ğŸ” v1.13.1: Verificar similaridade com TF-IDF
        const simResult = TFIDFSimilarity.findSimilar(modelData, modelLibrary.models, 0.80);
        if (simResult.hasSimilar) {
          modelLibrary.setSimilarityWarning({
            newModel: modelData,
            similarModel: simResult.similarModel,
            similarity: simResult.similarity,
            context: 'saveModel'
          } as SimilarityWarningState);
          return;
        }

        await executeSaveModel(modelData);
      }
    } catch (err) {
      setError('Erro ao salvar modelo: ' + (err as Error).message);
    } finally {
      setSavingModel(false);
    }
  };

  const saveModelWithoutClosing = async (formData?: NewModelData) => {
    // v1.36.1: Aceita dados do formulÃ¡rio diretamente para evitar race condition
    const effectiveModel = formData || modelLibrary.newModel;
    // ğŸ”§ BUGFIX: Capturar conteÃºdo diretamente do editor Quill (igual saveTopicEditWithoutClosing)
    // Previne problema onde state pode estar desatualizado ao apertar Ctrl+S
    const currentContent = modelEditorRef.current?.root
      ? sanitizeHTML(modelEditorRef.current.root.innerHTML)
      : effectiveModel.content;

    if (!effectiveModel.title || !currentContent) {
      setError('TÃ­tulo e conteÃºdo sÃ£o obrigatÃ³rios');
      return;
    }

    try {
      const editingModel = modelLibrary.editingModel;
      if (editingModel) {
        const modelData: Model = {
          ...editingModel,
          title: effectiveModel.title,
          content: currentContent,  // ğŸ”§ BUGFIX: Usar conteÃºdo atual do editor
          keywords: effectiveModel.keywords,
          category: effectiveModel.category,
          updatedAt: new Date().toISOString()
        };

        const updated = modelLibrary.models.map(m => m.id === editingModel.id ? modelData : m);
        modelLibrary.setModels(updated);
        // v1.34.0: Rastrear update para sync
        if (cloudSync?.trackChange) cloudSync.trackChange('update', modelData);
        modelLibrary.setHasUnsavedChanges(true);
        modelLibrary.setEditingModel(modelData);

        // ğŸ”§ BUGFIX: Atualizar tambÃ©m o newModel.content para manter state sincronizado
        modelLibrary.setNewModel({ ...effectiveModel, content: currentContent });
      } else {
        const modelId = generateModelId();
        const modelData: Model = {
          id: modelId,
          title: effectiveModel.title,
          content: currentContent,  // ğŸ”§ BUGFIX: Usar conteÃºdo atual do editor
          keywords: effectiveModel.keywords,
          category: effectiveModel.category,
          createdAt: new Date().toISOString()
        };

        modelLibrary.setModels(prev => [...prev, modelData]);
        // v1.34.0: Rastrear create para sync
        if (cloudSync?.trackChange) cloudSync.trackChange('create', modelData);
        modelLibrary.setHasUnsavedChanges(true);
        modelLibrary.setEditingModel(modelData);

        // ğŸ”§ BUGFIX: Atualizar tambÃ©m o newModel.content para manter state sincronizado
        modelLibrary.setNewModel({ ...effectiveModel, content: currentContent });
      }

      setError('');

      // Feedback visual temporÃ¡rio
      const successMsg = document.createElement('div');
      successMsg.className = 'fixed top-4 left-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-pulse';
      successMsg.innerHTML = '<span>âœ“</span> Modelo salvo!';
      document.body.appendChild(successMsg);
      setTimeout(() => successMsg.remove(), 2000);
    } catch (err) {
      setError('Erro ao salvar modelo: ' + (err as Error).message);
    }
  };

  // Salva ediÃ§Ãµes rÃ¡pidas de um modelo
  // v1.27.02: Regenerar embedding se IA local estiver ativa
  const saveQuickEdit = async (editorRef: React.RefObject<{ root?: HTMLElement } | null>) => {
    if (!modelPreview.previewingModel) {
      showToast('Erro: nenhum modelo selecionado', 'error');
      return;
    }

    // Capturar conteÃºdo do editor Quill
    const newContent = editorRef.current?.root
      ? sanitizeHTML(editorRef.current.root.innerHTML)
      : modelPreview.editedContent;

    if (!newContent || !newContent.trim()) {
      showToast('ConteÃºdo nÃ£o pode estar vazio', 'error');
      return;
    }

    try {
      const modelId = modelPreview.previewingModel.id;
      if (!modelLibrary.models.some(m => m.id === modelId)) {
        showToast('Modelo nÃ£o encontrado na biblioteca', 'error');
        return;
      }

      const updatedModel = {
        ...modelPreview.previewingModel,
        content: newContent,
        updatedAt: new Date().toISOString()
      };

      // v1.27.02: Regenerar embedding se IA local estiver ativa
      if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady) {
        await new Promise(resolve => setTimeout(resolve, 50));
        try {
          const stripHTML = (html: string) => {
            const div = document.createElement('div');
            div.innerHTML = html || '';
            return div.textContent || div.innerText || '';
          };
          const text = [updatedModel.title, updatedModel.keywords, stripHTML(updatedModel.content).slice(0, 2000)].filter(Boolean).join(' ');
          updatedModel.embedding = await AIModelService.getEmbedding(text, 'passage');
        } catch (err) {
          console.warn('[MODEL-EMBED] Erro ao regenerar embedding:', err);
        }
      } else if (updatedModel.embedding) {
        delete updatedModel.embedding;
      }

      modelLibrary.setModels(modelLibrary.models.map(m => m.id === modelId ? updatedModel : m));
      // v1.34.0: Rastrear update para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('update', updatedModel);
      modelLibrary.setHasUnsavedChanges(true);
      TFIDFSimilarity.invalidate();
      apiCache.invalidate('suggestions_');

      // Sincronizar sugestÃµes se existirem (evita mostrar conteÃºdo antigo ao clicar "Visualizar" novamente)
      if (modelLibrary.suggestions?.length > 0) {
        modelLibrary.setSuggestions(
          modelLibrary.suggestions.map(s => s.id === modelId ? updatedModel : s)
        );
      }

      // v1.19.2: Notificar listeners (ex: GlobalEditorModal) sobre atualizaÃ§Ã£o do modelo
      if (modelPreview.onModelUpdatedRef?.current) {
        modelPreview.onModelUpdatedRef.current(updatedModel);
      }

      // Atualizar o modelo no preview para refletir mudanÃ§as
      modelPreview.openPreview(updatedModel);
      modelPreview.cancelEditing();

      showToast('Modelo salvo com sucesso!', 'success');
    } catch (err) {
      showToast('Erro ao salvar modelo: ' + (err as Error).message, 'error');
    }
  };

  // v1.15.3: Salva como novo modelo (a partir do preview editado)
  // v1.27.02: Gera embedding automaticamente se IA local estiver ativa
  const confirmSaveAsNew = async () => {
    const data = modelPreview.saveAsNewData;
    if (!data) {
      showToast('Erro: nenhum modelo para salvar', 'error');
      return;
    }

    const { title, keywords, category, content } = data;

    if (!title?.trim()) {
      showToast('TÃ­tulo Ã© obrigatÃ³rio', 'error');
      return;
    }

    if (!content?.trim()) {
      showToast('ConteÃºdo nÃ£o pode estar vazio', 'error');
      return;
    }

    const modelId = generateModelId();
    const modelData: Model = {
      id: modelId,
      title: title.trim(),
      content: sanitizeHTML(content),
      keywords: keywords?.trim() || '',
      category: category || 'MÃ©rito',
      createdAt: new Date().toISOString()
    };

    // Verificar similaridade com TF-IDF
    const simResult = TFIDFSimilarity.findSimilar(modelData, modelLibrary.models, 0.80);
    if (simResult.hasSimilar) {
      modelLibrary.setSimilarityWarning({
        newModel: modelData,
        similarModel: simResult.similarModel,
        similarity: simResult.similarity,
        context: 'saveAsNew'
      } as SimilarityWarningState);
      return;
    }

    // v1.27.02: Gerar embedding se IA local estiver ativa
    if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady) {
      await new Promise(resolve => setTimeout(resolve, 50));
      try {
        const stripHTML = (html: string) => {
          const div = document.createElement('div');
          div.innerHTML = html || '';
          return div.textContent || div.innerText || '';
        };
        const text = [modelData.title, modelData.keywords, stripHTML(modelData.content).slice(0, 2000)].filter(Boolean).join(' ');
        modelData.embedding = await AIModelService.getEmbedding(text, 'passage');
      } catch (err) {
        console.warn('[MODEL-EMBED] Erro ao gerar embedding:', err);
      }
    }

    // Salvar novo modelo
    modelLibrary.setModels(prev => [...prev, modelData]);
    // v1.34.0: Rastrear create para sync
    if (cloudSync?.trackChange) cloudSync.trackChange('create', modelData);
    modelLibrary.setHasUnsavedChanges(true);
    TFIDFSimilarity.invalidate();
    apiCache.invalidate('suggestions_');

    showToast('Novo modelo criado com sucesso!', 'success');
    modelPreview.closeSaveAsNew();
    modelPreview.closePreview();
  };

  // v1.15.3: Executa salvamento de "Salvar como Novo" (chamado apÃ³s confirmaÃ§Ã£o de similaridade)
  // v1.27.02: Gera embedding automaticamente se IA local estiver ativa
  const executeSaveAsNew = async (modelData: Partial<Model> & { id: string; title: string; content: string; embedding?: number[] }, isReplace = false, replaceId: string | null = null) => {
    // Gerar embedding se modelo de busca estiver pronto E opÃ§Ã£o ativada
    if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady && !modelData.embedding) {
      await new Promise(resolve => setTimeout(resolve, 50));
      try {
        const stripHTML = (html: string) => {
          const div = document.createElement('div');
          div.innerHTML = html || '';
          return div.textContent || div.innerText || '';
        };
        const text = [modelData.title, modelData.keywords, stripHTML(modelData.content).slice(0, 2000)].filter(Boolean).join(' ');
        modelData.embedding = await AIModelService.getEmbedding(text, 'passage');
      } catch (err) {
        console.warn('[MODEL-EMBED] Erro ao gerar embedding:', err);
      }
    } else if (!aiIntegration.aiSettings.modelSemanticEnabled && modelData.embedding) {
      delete modelData.embedding;
    }

    if (isReplace && replaceId) {
      const updatedModel = { ...modelData, id: replaceId, updatedAt: new Date().toISOString() };
      const updated = modelLibrary.models.map(m =>
        m.id === replaceId ? updatedModel : m
      );
      modelLibrary.setModels(updated);
      // v1.34.0: Rastrear update para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('update', updatedModel);
    } else {
      modelLibrary.setModels(prev => [...prev, modelData]);
      // v1.34.0: Rastrear create para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('create', modelData);
    }
    modelLibrary.setHasUnsavedChanges(true);
    TFIDFSimilarity.invalidate();
    apiCache.invalidate('suggestions_');
    showToast('Novo modelo criado com sucesso!', 'success');
    modelPreview.closeSaveAsNew();
    modelPreview.closePreview();
  };

  const startEditingModel = (model: Model) => {
    modelLibrary.setEditingModel(model);
    modelLibrary.setNewModel({
      title: model.title,
      content: model.content,
      keywords: typeof model.keywords === 'string' ? model.keywords : (model.keywords || []).join(', '),
      category: model.category || ''
    });
    openModal('modelForm');
    
    // Scroll suave para o formulÃ¡rio de ediÃ§Ã£o
    setTimeout(() => {
      if (modelFormRef.current) {
        modelFormRef.current.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    }, 100);

    setTimeout(() => {
      if (modelEditorRef.current?.root) {
        modelEditorRef.current.root.innerHTML = sanitizeHTML(model.content);
      }
    }, 200);
  };

  const exportModels = async () => {
    try {
      const modelsToExport = modelLibrary.selectedCategory === 'all'
        ? modelLibrary.models
        : modelLibrary.models.filter(m => m.category === modelLibrary.selectedCategory);

      const dataStr = JSON.stringify(modelsToExport, null, 2);

      // Copiar para clipboard
      await navigator.clipboard.writeText(dataStr);

      // Download do arquivo
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const categoryName = modelLibrary.selectedCategory === 'all' ? 'todos' : modelLibrary.selectedCategory.toLowerCase().replace(/\s+/g, '-');
      a.download = `sentencify-modelos-${categoryName}-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      modelLibrary.setHasUnsavedChanges(false);
      showToast(`âœ… Modelos exportados com sucesso!\n\n${modelsToExport.length} modelo(s) exportado(s).\nArquivo baixado e copiado para Ã¡rea de transferÃªncia.`, 'success');
    } catch (err) {
      showToast('Erro ao exportar modelos: ' + (err as Error).message, 'error');
    }
  };

  // Detecta modelos duplicados no arquivo de importaÃ§Ã£o
  const checkDuplicate = (newModel: { title: string; content: string; category?: string }, existingModels: Model[]) => {
    // Level 1: Exact title + category match
    const exactMatch = existingModels.find(
      (existing: Model) => existing.title === newModel.title &&
                  existing.category === (newModel.category || '')
    );

    if (exactMatch) {
      return {
        isDuplicate: true,
        reason: 'Mesmo tÃ­tulo e categoria',
        existingId: exactMatch.id
      };
    }

    // Level 2: Exact content match (normalized)
    const normalizeContent = (text: string) => {
      return text.toLowerCase().trim().replace(/\s+/g, ' ');
    };

    const contentA = normalizeContent(newModel.content);
    const contentMatch = existingModels.find(
      (existing: Model) => normalizeContent(existing.content) === contentA
    );

    if (contentMatch) {
      return {
        isDuplicate: true,
        reason: 'ConteÃºdo idÃªntico (tÃ­tulo diferente)',
        existingId: contentMatch.id
      };
    }

    return { isDuplicate: false };
  };

  // v1.27.02: Gera embeddings para modelos importados sem embedding
  const importModels = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    try {
      const text = await file.text();
      const importedModels = JSON.parse(text);

      if (!Array.isArray(importedModels)) {
        setError('Arquivo invÃ¡lido. Deve conter um array de modelos.');
        return;
      }

      let importCount = 0;
      let duplicateCount = 0;
      const newModels: Model[] = [];
      const duplicates: Array<{ title: string; reason: string; existingId: string }> = [];

      for (const model of importedModels) {
        if (model.title && model.content) {
          const dupCheck = checkDuplicate(model, modelLibrary.models);

          if (dupCheck.isDuplicate) {
            duplicateCount++;
            duplicates.push({
              title: model.title,
              reason: dupCheck.reason || 'duplicado',
              existingId: dupCheck.existingId || ''
            });
            continue; // SKIP this model
          }

          const modelId = `${generateModelId()}_import${importCount}`;
          const modelData: Model = {
            id: modelId,
            title: model.title as string,
            content: model.content as string,
            keywords: model.keywords || '',
            category: model.category || '',
            createdAt: new Date().toISOString(),
            embedding: model.embedding
          };
          newModels.push(modelData);
          importCount++;
        }
      }

      // v1.27.02: Gerar embeddings para modelos sem embedding se IA local estiver ativa E opÃ§Ã£o ativada
      if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady && newModels.length > 0) {
        const modelsWithoutEmbedding = newModels.filter(m => !m.embedding || m.embedding.length !== 768);
        if (modelsWithoutEmbedding.length > 0) {
          const stripHTML = (html: string) => {
            const div = document.createElement('div');
            div.innerHTML = html || '';
            return div.textContent || div.innerText || '';
          };
          for (const model of modelsWithoutEmbedding) {
            try {
              const text = [model.title, model.keywords, stripHTML(model.content).slice(0, 2000)].filter(Boolean).join(' ');
              model.embedding = await AIModelService.getEmbedding(text, 'passage');
              // Yield para nÃ£o travar UI
              await new Promise(resolve => setTimeout(resolve, 0));
            } catch (err) {
              console.warn('[MODEL-EMBED] Erro ao gerar embedding para modelo importado:', err);
            }
          }
        }
      }

      if (newModels.length > 0) {
        modelLibrary.setModels(prev => [...prev, ...newModels]);
        // v1.35.23: Usar trackChangeBatch para importaÃ§Ã£o eficiente (nÃ£o 100 chamadas individuais)
        if (cloudSync?.trackChangeBatch) {
          cloudSync.trackChangeBatch(newModels.map(model => ({ operation: 'create', model })));
        }
        modelLibrary.setHasUnsavedChanges(true);
      }

      setError('');

      // Enhanced notification
      if (duplicateCount > 0) {
        showToast(
          `${importCount} modelo(s) importado(s) com sucesso!\nâš ï¸ ${duplicateCount} duplicata(s) ignorada(s)`,
          importCount > 0 ? 'success' : 'warning'
        );
      } else {
        showToast(`${importCount} modelo(s) importado(s) com sucesso!`, 'success');
      }

    } catch (err) {
      setError('Erro ao importar modelos: ' + (err as Error).message);
    }
  };

  // ============================================================================
  // HELPERS PARA GERAÃ‡ÃƒO DE MINI-RELATÃ“RIOS (v1.15)
  // ============================================================================

  // Helper: ConstrÃ³i array de documentos para envio Ã  API (elimina duplicaÃ§Ã£o)
  interface BuildDocumentOptions {
    includePeticao?: boolean;
    includeContestacoes?: boolean;
    includeComplementares?: boolean;
    documentsOverride?: AnalyzedDocuments | null;
  }
  const buildDocumentContentArray = (options: BuildDocumentOptions = {}) => {
    const {
      includePeticao = true,
      includeContestacoes = true,
      includeComplementares = false,
      documentsOverride = null // Permite passar documentos diretamente (bypass do estado React)
    } = options;

    // Usar documentsOverride se fornecido, senÃ£o usar analyzedDocuments (estado React)
    const docs = documentsOverride || analyzedDocuments;
    const contentArray: (AITextContent | AIDocumentContent)[] = [];

    // v1.16.6: AnonimizaÃ§Ã£o jÃ¡ aplicada em analyzeDocuments (nÃ£o duplicar aqui)

    // 1. PetiÃ§Ãµes (mÃºltiplas) - v1.21: Suporte a petiÃ§Ã£o inicial + emendas
    if (includePeticao) {
      // Primeiro: textos extraÃ­dos (PDF.JS ou Claude Vision)
      if (docs.peticoesText?.length > 0) {
        docs.peticoesText.forEach((doc: { name?: string; text: string }, idx: number) => {
          contentArray.push({
            type: 'text',
            text: `${doc.name?.toUpperCase() || `PETIÃ‡ÃƒO ${idx + 1}`}:\n\n${doc.text}`,
            cache_control: doc.text.length > 2000 ? { type: "ephemeral" } : undefined
          });
        });
      }
      // Depois: PDFs binÃ¡rios (modo pdf-puro ou fallback)
      // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
      if (docs.peticoes?.length > 0) {
        const textCount = docs.peticoesText?.length || 0;
        docs.peticoes.forEach((base64: string, index: number) => {
          const label = index === 0 && textCount === 0 ? 'PETIÃ‡ÃƒO INICIAL' : `PETIÃ‡ÃƒO ${textCount + index + 1}`;
          contentArray.push({ type: 'text', text: `${label} (documento PDF a seguir):` });
          contentArray.push({
            type: 'document',
            source: { type: 'base64', media_type: 'application/pdf', data: base64 },
            cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
          });
        });
      }
    }

    // 2. ContestaÃ§Ãµes - v1.14.1: Suporte a modos mistos (envia textos E PDFs)
    // v1.25: Adicionado cache_control para otimizaÃ§Ã£o de tokens
    if (includeContestacoes) {
      // Primeiro: textos extraÃ­dos (PDF.JS ou Claude Vision)
      if (docs.contestacoesText?.length > 0) {
        docs.contestacoesText.forEach((contestacao: { text: string }, index: number) => {
          contentArray.push({
            type: 'text',
            text: `CONTESTAÃ‡ÃƒO ${index + 1}:\n\n${contestacao.text}`,
            cache_control: contestacao.text.length > 2000 ? { type: "ephemeral" } : undefined
          });
        });
      }
      // Depois: PDFs nÃ£o extraÃ­dos (modo PDF Puro ou fallback)
      // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
      if (docs.contestacoes?.length > 0) {
        const textCount = docs.contestacoesText?.length || 0;
        docs.contestacoes.forEach((base64: string, index: number) => {
          contentArray.push({ type: 'text', text: `CONTESTAÃ‡ÃƒO ${textCount + index + 1} (documento PDF a seguir):` });
          contentArray.push({
            type: 'document',
            source: { type: 'base64', media_type: 'application/pdf', data: base64 },
            cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
          });
        });
      }
    }

    // 3. Documentos Complementares - v1.14.1: Suporte a modos mistos (envia textos E PDFs)
    // v1.25: Adicionado cache_control para otimizaÃ§Ã£o de tokens
    if (includeComplementares) {
      // Primeiro: textos extraÃ­dos (PDF.JS ou Claude Vision)
      if (docs.complementaresText?.length > 0) {
        docs.complementaresText.forEach((doc: { text: string }, index: number) => {
          contentArray.push({
            type: 'text',
            text: `DOCUMENTO COMPLEMENTAR ${index + 1}:\n\n${doc.text}`,
            cache_control: doc.text.length > 2000 ? { type: "ephemeral" } : undefined
          });
        });
      }
      // Depois: PDFs nÃ£o extraÃ­dos (modo PDF Puro ou fallback)
      // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
      if (docs.complementares?.length > 0) {
        const textCount = docs.complementaresText?.length || 0;
        docs.complementares.forEach((base64: string, index: number) => {
          contentArray.push({ type: 'text', text: `DOCUMENTO COMPLEMENTAR ${textCount + index + 1} (documento PDF a seguir):` });
          contentArray.push({
            type: 'document',
            source: { type: 'base64', media_type: 'application/pdf', data: base64 },
            cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
          });
        });
      }
    }

    return contentArray;
  };

  // v1.14.3: Reordena tÃ³picos via LLM (preliminares â†’ prejudiciais â†’ mÃ©rito â†’ processuais)
  // v1.31.01: Fix RECITATION - retornar Ã­ndices ao invÃ©s de tÃ­tulos
  const reorderTopicsViaLLM = async (topics: Topic[]) => {
    if (!topics || topics.length <= 1) return topics;

    const topicsList = topics.map((t: Topic, i: number) => `${i + 1}. "${t.title}" (${t.category})`).join('\n');

    const prompt = `Reordene os seguintes tÃ³picos de uma aÃ§Ã£o trabalhista na ordem processual correta:

ORDEM PROCESSUAL:
1. RELATÃ“RIO
2. TRAMITAÃ‡ÃƒO (JuÃ­zo Digital, Segredo JustiÃ§a, Prioridade)
3. IMPUGNAÃ‡ÃƒO AOS DOCUMENTOS
4. PRELIMINARES - Art. 337 CPC na ordem: citaÃ§Ã£o â†’ incompetÃªncia â†’ valor â†’ inÃ©pcia â†’ perempÃ§Ã£o â†’ litispendÃªncia â†’ coisa julgada â†’ conexÃ£o â†’ representaÃ§Ã£o â†’ arbitragem â†’ legitimidade â†’ cauÃ§Ã£o â†’ gratuidade
5. PREJUDICIAIS (prescriÃ§Ã£o bienal/quinquenal, decadÃªncia)
6. MÃ‰RITO - ordenar assim:
   6a. DeclaratÃ³rios/Constitutivos (vÃ­nculo, reversÃ£o justa causa, rescisÃ£o indireta)
   6b. ObrigaÃ§Ãµes de fazer (CTPS, guias)
   6c. CondenatÃ³rios (verbas, horas extras, adicionais, danos)
   6d. Responsabilidade - APÃ“S definir o que Ã© devido (grupo econÃ´mico, solidÃ¡ria, subsidiÃ¡ria)
   6e. JustiÃ§a Gratuita - ANTES de honorÃ¡rios
   6f. HonorÃ¡rios - ÃšLTIMO do mÃ©rito
7. QUESTÃ•ES FINAIS (litigÃ¢ncia mÃ¡-fÃ©, ofÃ­cios, juros, limitaÃ§Ã£o)

TÃ“PICOS A ORDENAR:
${topicsList}

Responda APENAS com JSON: {"order": [1, 3, 2, ...]}
Use os nÃºmeros originais da lista.`;

    try {
      const isGemini = aiIntegration.aiSettings?.provider === 'gemini';
      const result = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], {
        maxTokens: 4000, // v1.32.25: Aumentado para evitar truncamento (thinking tokens do Gemini 3)
        useInstructions: false,
        temperature: isGemini ? 0.5 : 0.0,
        topP: 0.9,
        topK: 40
      });

      // v1.32.34: Regex mais robusto para extrair JSON (suporta newlines, markdown, etc.)
      let jsonMatch = result.match(/\{\s*"order"\s*:\s*\[[\d,\s\n\r]+\]\s*\}/);

      // Fallback: tentar extrair de bloco markdown ```json ... ```
      if (!jsonMatch) {
        const markdownMatch = result.match(/```(?:json)?\s*(\{[\s\S]*?"order"[\s\S]*?\})\s*```/);
        if (markdownMatch) {
          jsonMatch = [markdownMatch[1]];
        }
      }

      // Fallback: busca genÃ©rica por {"order": [...]}
      if (!jsonMatch) {
        const genericMatch = result.match(/\{[^{}]*"order"\s*:\s*\[[^\]]+\][^{}]*\}/);
        if (genericMatch) jsonMatch = genericMatch;
      }

      if (!jsonMatch) {
        console.warn('[reorderTopicsViaLLM] JSON nÃ£o encontrado na resposta, mantendo ordem original');
        console.log('[reorderTopicsViaLLM] Resposta recebida:', result.substring(0, 500));
        return topics;
      }

      const cleanResult = jsonMatch[0];
      const parsed = JSON.parse(cleanResult);

      // Novo formato: Ã­ndices (evita RECITATION)
      if (parsed.order && Array.isArray(parsed.order)) {
        const orderedTopics = [];
        for (const idx of parsed.order) {
          const topic = topics[idx - 1];
          if (topic) orderedTopics.push(topic);
        }
        for (const topic of topics) {
          if (!orderedTopics.includes(topic)) {
            orderedTopics.push(topic);
          }
        }
        return orderedTopics;
      }

      // Fallback: formato antigo com tÃ­tulos (retrocompatibilidade)
      if (parsed.orderedTitles && Array.isArray(parsed.orderedTitles)) {
        const orderedTopics: Topic[] = [];
        for (const title of parsed.orderedTitles) {
          const topic = topics.find((t: Topic) => t.title.toUpperCase() === title.toUpperCase());
          if (topic) orderedTopics.push(topic);
        }
        for (const topic of topics) {
          if (!orderedTopics.find((t: Topic) => t.title === topic.title)) {
            orderedTopics.push(topic);
          }
        }
        return orderedTopics;
      }

      console.warn('[reorderTopicsViaLLM] Formato desconhecido, mantendo ordem original');
      return topics;

    } catch (err) {
      console.error('[reorderTopicsViaLLM] Erro:', err);
      return topics;
    }
  };

  // v1.21.27: FunÃ§Ã£o base que retorna componentes reutilizÃ¡veis para prompts de mini-relatÃ³rio
  const buildMiniReportPromptCore = (options: { isInitialGeneration?: boolean } = {}) => {
    const { isInitialGeneration = false } = options;

    const totalContestacoes = (analyzedDocuments.contestacoes?.length || 0) +
                              (analyzedDocuments.contestacoesText?.length || 0);

    const modeloPersonalizado = aiIntegration.aiSettings?.modeloRelatorio?.trim();

    const modeloBase = modeloPersonalizado || `PRIMEIRO PARÃGRAFO (alegaÃ§Ãµes do autor):
"O reclamante narra [resumo]. Sustenta [argumentos]. Indica que [situaÃ§Ã£o]. Em decorrÃªncia, postula [pedido]."

SEGUNDO PARÃGRAFO (primeira defesa):
${totalContestacoes > 0 ? '"A primeira reclamada, em defesa, alega [argumentos]. Sustenta que [posiÃ§Ã£o]."' : '"NÃ£o houve apresentaÃ§Ã£o de contestaÃ§Ã£o."'}

${totalContestacoes > 1 ? `TERCEIRO PARÃGRAFO (segunda defesa):
"A segunda rÃ©, por sua vez, nega [posiÃ§Ã£o]. Aduz [argumentos]."` : ''}

${totalContestacoes > 2 ? `QUARTO PARÃGRAFO (terceira defesa):
"A terceira reclamada tambÃ©m contesta [argumentos]. Sustenta [posiÃ§Ã£o]."` : ''}`;

    const numeracaoPrompt = isInitialGeneration
      ? AI_PROMPTS.numeracaoReclamadasInicial
      : AI_PROMPTS.numeracaoReclamadas;

    let partesInfo = '';
    if (partesProcesso?.reclamadas?.length > 0) {
      partesInfo = `\nPARTES DO PROCESSO:
- Reclamante: ${partesProcesso.reclamante || 'NÃ£o identificado'}
${partesProcesso.reclamadas.map((r, i: number) => `- ${i + 1}Âª Reclamada: ${r}`).join('\n')}
`;
    }

    return {
      totalContestacoes,
      modeloBase,
      modeloPersonalizado,
      numeracaoPrompt,
      partesInfo,
      formatacaoHTML: AI_PROMPTS.formatacaoHTML("O <strong>reclamante</strong> narra que..."),
      formatacaoParagrafos: AI_PROMPTS.formatacaoParagrafos("<p>O reclamante narra...</p><p>A primeira reclamada, em defesa...</p>"),
      nivelDetalhe: aiIntegration.aiSettings?.detailedMiniReports ? `âš ï¸ NÃVEL DE DETALHE - FATOS:
Gere com alto nÃ­vel de detalhe em relaÃ§Ã£o aos FATOS alegados pelas partes.
A descriÃ§Ã£o fÃ¡tica (postulatÃ³ria e defensiva) deve ter alto nÃ­vel de detalhe.
` : '',
      estiloRedacao: AI_PROMPTS.estiloRedacao,
      preservarAnonimizacao: AI_PROMPTS.preservarAnonimizacao,
      proibicaoMetaComentarios: AI_PROMPTS.proibicaoMetaComentarios // v1.35.29
    };
  };

  // v1.21.27: Helper para prompt de mini-relatÃ³rio INDIVIDUAL (usa Core)
  const buildMiniReportPrompt = (options: {
    title?: string;
    context?: string;
    instruction?: string;
    currentRelatorio?: string;
    isInitialGeneration?: boolean;
  } = {}) => {
    const {
      title,
      context = '',
      instruction = '',
      currentRelatorio = '',
      isInitialGeneration = false
    } = options;

    const core = buildMiniReportPromptCore({ isInitialGeneration });

    return `Com base nos documentos processuais fornecidos acima${core.totalContestacoes > 0 ? ` (petiÃ§Ã£o inicial e ${core.totalContestacoes} contestaÃ§Ã£o${core.totalContestacoes > 1 ? 'Ãµes' : ''})` : ' (petiÃ§Ã£o inicial)'}, gere um mini-relatÃ³rio narrativo para o tÃ³pico "${title}".

${instruction ? `INSTRUÃ‡ÃƒO DO USUÃRIO:\n${instruction}\n` : ''}

${context ? `CONTEXTO:\n${context}\n` : ''}

${currentRelatorio ? `MINI-RELATÃ“RIO ATUAL:\n${currentRelatorio}\n` : ''}

${core.modeloPersonalizado ? `MODELO PERSONALIZADO:\n${core.modeloBase}` : `FORMATO PADRÃƒO:\n${core.modeloBase}`}
${core.partesInfo}
${core.numeracaoPrompt}

${core.formatacaoHTML}

${core.formatacaoParagrafos}

${core.nivelDetalhe}

${core.estiloRedacao}

${core.preservarAnonimizacao}

${core.proibicaoMetaComentarios}

Responda APENAS com o texto do mini-relatÃ³rio formatado em HTML, sem JSON, sem markdown, sem prefixo.`;
  };

  // v1.21.27: Helper para prompt de mini-relatÃ³rios BATCH (usa Core)
  const buildBatchMiniReportPrompt = (topics: Topic[], options: { isInitialGeneration?: boolean } = {}) => {
    const { isInitialGeneration = false } = options;

    const core = buildMiniReportPromptCore({ isInitialGeneration });
    const topicsList = topics.map((t: Topic, i: number) => `${i + 1}. "${t.title}"`).join('\n');

    return `Com base nos documentos processuais fornecidos acima${core.totalContestacoes > 0 ? ` (petiÃ§Ã£o inicial e ${core.totalContestacoes} contestaÃ§Ã£o${core.totalContestacoes > 1 ? 'Ãµes' : ''})` : ' (petiÃ§Ã£o inicial)'}, gere mini-relatÃ³rios narrativos para os seguintes ${topics.length} tÃ³picos:

${topicsList}

FORMATO DE CADA MINI-RELATÃ“RIO:
${core.modeloBase}
${core.partesInfo}
${core.numeracaoPrompt}

${core.formatacaoHTML}

${core.formatacaoParagrafos}

${core.nivelDetalhe}

${core.estiloRedacao}

${core.preservarAnonimizacao}

${core.proibicaoMetaComentarios}

IMPORTANTE: Responda APENAS com um JSON vÃ¡lido no formato:
{
  "reports": [
    { "title": "TÃTULO DO TÃ“PICO 1", "relatorio": "<p>Mini-relatÃ³rio HTML...</p>" },
    { "title": "TÃTULO DO TÃ“PICO 2", "relatorio": "<p>Mini-relatÃ³rio HTML...</p>" }
  ]
}

Gere EXATAMENTE ${topics.length} mini-relatÃ³rios, um para cada tÃ³pico listado, na mesma ordem.`;
  };

  // FunÃ§Ã£o unificada: Gera um mini-relatÃ³rio individual
  const generateMiniReport = async (options: {
    title?: string;
    context?: string;
    instruction?: string;
    currentRelatorio?: string;
    includeComplementares?: boolean;
    isInitialGeneration?: boolean;
    maxTokens?: number;
    documentsOverride?: AnalyzedDocuments | null;
  } = {}) => {
    const {
      title,
      context = '',
      instruction = '',
      currentRelatorio = '',
      includeComplementares = false,
      isInitialGeneration = false,
      maxTokens = 4000,
      documentsOverride = null // Permite passar documentos diretamente (bypass do estado React)
    } = options;

    // 1. Construir array de documentos
    const contentArray = buildDocumentContentArray({
      includePeticao: true,
      includeContestacoes: true,
      includeComplementares,
      documentsOverride
    });

    // 2. Construir e adicionar prompt
    const prompt = buildMiniReportPrompt({
      title,
      context,
      instruction,
      currentRelatorio,
      isInitialGeneration
    });

    contentArray.push({ type: 'text', text: prompt });

    // 3. Chamar API
    // v1.21.26: Parametros para texto juridico (balanceado)
    const result = await aiIntegration.callAI([{
      role: 'user',
      content: contentArray
    }], {
      maxTokens,
      useInstructions: true,
      temperature: 0.4,
      topP: 0.9,
      topK: 60
    });

    // 4. Normalizar e retornar (v1.35.29: remove meta-comentÃ¡rios de revisÃ£o)
    return removeMetaComments(normalizeHTMLSpacing(result));
  };

  // v1.14.1: FunÃ§Ã£o para gerar mÃºltiplos mini-relatÃ³rios em UMA requisiÃ§Ã£o
  // v1.21.27: Refatorado para usar buildBatchMiniReportPrompt centralizado
  const generateMultipleMiniReports = async (topics: Topic[], options: { includeComplementares?: boolean; isInitialGeneration?: boolean; documentsOverride?: AnalyzedDocuments | null } = {}) => {
    const {
      includeComplementares = false,
      isInitialGeneration = false,
      documentsOverride = null
    } = options;

    // 1. Construir array de documentos (apenas 1x para todos os tÃ³picos)
    const contentArray = buildDocumentContentArray({
      includePeticao: true,
      includeContestacoes: true,
      includeComplementares,
      documentsOverride
    });

    // 2. Usar builder centralizado (v1.21.27)
    const prompt = buildBatchMiniReportPrompt(topics, { isInitialGeneration });
    contentArray.push({ type: 'text', text: prompt });

    // 3. Chamar API com maxTokens escalado (v1.14.2: aumentado cap para 24K/48K)
    // v1.21.26: Parametros para texto juridico (balanceado)
    const isAllInOne = aiIntegration.aiSettings?.topicsPerRequest === 'all';
    const tokenCap = isAllInOne ? 48000 : 24000;
    const maxTokens = Math.min(4000 * topics.length, tokenCap);
    const result = await aiIntegration.callAI([{
      role: 'user',
      content: contentArray
    }], {
      maxTokens,
      useInstructions: true,
      extractText: false,
      temperature: 0.4,
      topP: 0.9,
      topK: 60
    });

    // 6. Parsear resposta JSON (provider-aware)
    const provider = aiIntegration.aiSettings.provider || 'claude';
    const textContent = aiIntegration.extractResponseText(result, provider);
    let cleanText = textContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

    try {
      const parsed = JSON.parse(cleanText);
      if (parsed.reports && Array.isArray(parsed.reports)) {
        // v1.35.29: remove meta-comentÃ¡rios de revisÃ£o
        return parsed.reports.map((r: { title: string; relatorio?: string }) => ({
          title: r.title,
          relatorio: removeMetaComments(normalizeHTMLSpacing(r.relatorio || ''))
        }));
      }
      throw new Error('Formato de resposta invÃ¡lido');
    } catch (parseError) {
      // Tentar extrair JSON de dentro do texto
      const jsonMatch = cleanText.match(/\{[\s\S]*"reports"[\s\S]*\}/);
      if (jsonMatch) {
        try {
          const parsed = JSON.parse(jsonMatch[0]);
          if (parsed.reports && Array.isArray(parsed.reports)) {
            // v1.35.29: remove meta-comentÃ¡rios de revisÃ£o
            return parsed.reports.map((r: { title: string; relatorio?: string }) => ({
              title: r.title,
              relatorio: removeMetaComments(normalizeHTMLSpacing(r.relatorio || ''))
            }));
          }
        } catch (innerParseError) {
          // JSON extraÃ­do tambÃ©m Ã© invÃ¡lido, continuar para o throw abaixo
        }
      }
      throw new Error(`Erro ao parsear resposta de mÃºltiplos tÃ³picos: ${(parseError as Error).message}`);
    }
  };

  // FunÃ§Ã£o batch: Gera mÃºltiplos mini-relatÃ³rios em paralelo (batches de 3)
  // v1.14.1: Suporta mÃºltiplos tÃ³picos por requisiÃ§Ã£o via topicsPerRequest
  const generateMiniReportsBatch = async (topics: Topic[], options: { batchSize?: number; delayBetweenBatches?: number; onProgress?: ((current: number, total: number, batchNum: number, totalBatches: number) => void) | null } = {}) => {
    const {
      batchSize = 3,
      delayBetweenBatches = 1000,
      onProgress = null // callback(current, total, batchNum)
    } = options;

    // v1.14.1: Obter configuraÃ§Ã£o de tÃ³picos por requisiÃ§Ã£o
    const topicsPerRequestSetting = aiIntegration.aiSettings?.topicsPerRequest || 1;

    const results: Array<{ title: string; relatorio?: string; status?: string }> = [];
    const errors: Array<{ title: string; error?: string; status?: string }> = [];
    const totalTopics = topics.length;

    // v1.14.2: Agrupar tÃ³picos conforme topicsPerRequest (suporta 'all')
    const topicGroups: Topic[][] = [];
    if (topicsPerRequestSetting === 'all') {
      topicGroups.push(topics);
    } else {
      const perReq = topicsPerRequestSetting;
      for (let i = 0; i < totalTopics; i += perReq) {
        topicGroups.push(topics.slice(i, i + perReq));
      }
    }

    const totalGroups = topicGroups.length;
    const totalBatches = Math.ceil(totalGroups / batchSize);
    let processedTopics = 0;

    // v1.14.3: Timeout maior para "Todos" (10 min vs 3 min)
    const timeoutMs = topicsPerRequestSetting === 'all' ? 600000 : 360000;

    for (let i = 0; i < totalGroups; i += batchSize) {
      const batch = topicGroups.slice(i, i + batchSize);
      const batchNum = Math.floor(i / batchSize) + 1;

      // Notificar progresso
      if (onProgress) {
        onProgress(processedTopics, totalTopics, batchNum, totalBatches);
      }

      // Processar batch de grupos em paralelo, atualizando progresso a cada resposta
      const promises = batch.map(async (group) => {
        try {
          let groupResults;
          if (group.length === 1) {
            // Grupo com 1 tÃ³pico: usar funÃ§Ã£o individual (comportamento original)
            const topic = group[0];
            const result = await callWithRetry(
              () => generateMiniReport({
                title: topic.title,
                context: topic.context || '',
                instruction: topic.instruction || '',
                includeComplementares: topic.includeComplementares || false,
                isInitialGeneration: topic.isInitialGeneration || false,
                documentsOverride: (topic.documentsOverride && Object.keys(topic.documentsOverride).length > 0) ? topic.documentsOverride as AnalyzedDocuments : null
              }),
              3,
              topic.title,
              null,
              timeoutMs
            );
            groupResults = [{ title: topic.title, relatorio: result, status: 'success' }];
          } else {
            // Grupo com mÃºltiplos tÃ³picos: usar nova funÃ§Ã£o
            const multiResults = await callWithRetry(
              () => generateMultipleMiniReports(group, {
                includeComplementares: group[0]?.includeComplementares || false,
                isInitialGeneration: group[0]?.isInitialGeneration || false,
                documentsOverride: (group[0]?.documentsOverride && Object.keys(group[0].documentsOverride).length > 0) ? group[0].documentsOverride as AnalyzedDocuments : null
              }),
              2,
              group.map((t: Topic) => t.title).join(', '),
              null,
              timeoutMs
            );
            groupResults = multiResults.map((r: { title: string; relatorio?: string }) => ({ ...r, status: 'success' }));
          }
          // Atualizar progresso imediatamente ao receber resposta
          groupResults.forEach((r: { title: string; relatorio?: string; status?: string }) => {
            processedTopics++;
            if (r.status === 'success') {
              results.push(r);
            } else {
              errors.push(r);
            }
            if (onProgress) {
              onProgress(processedTopics, totalTopics, batchNum, totalBatches);
            }
          });
          return groupResults;
        } catch (err) {
          // Se falhar, retornar erro para cada tÃ³pico do grupo
          const errorResults = group.map((t: Topic) => ({ title: t.title, error: (err as Error).message, status: 'error' }));
          errorResults.forEach((r: { title: string; error?: string; status: string }) => {
            processedTopics++;
            errors.push(r);
            if (onProgress) {
              onProgress(processedTopics, totalTopics, batchNum, totalBatches);
            }
          });
          return errorResults;
        }
      });

      await Promise.all(promises);

      // Delay entre batches (evitar rate limit)
      if (i + batchSize < totalGroups) {
        await new Promise(resolve => setTimeout(resolve, delayBetweenBatches));
      }
    }

    // Notificar conclusÃ£o
    if (onProgress) {
      onProgress(totalTopics, totalTopics, totalBatches, totalBatches);
    }

    return { results, errors };
  };

  // ============================================================================
  // FIM DOS HELPERS
  // ============================================================================

  const regenerateRelatorio = async (topicTitle: string, topicContext: string) => {
    aiIntegration.setRegenerating(true);
    setAnalysisProgress(`ğŸ”„ Regenerando relatÃ³rio para "${topicTitle}"...`);
    try {
      const result = await generateMiniReport({ title: topicTitle, context: topicContext });
      return result;
    } catch (err) {
      setError('Erro ao regerar mini-relatÃ³rio: ' + (err as Error).message);
      return null;
    } finally {
      aiIntegration.setRegenerating(false);
    }
  };

  const regenerateRelatorioWithInstruction = async () => {
    if (!aiIntegration.relatorioInstruction?.trim()) {
      setError('Digite uma instruÃ§Ã£o para regeraÃ§Ã£o do mini-relatÃ³rio');
      return;
    }
    if (!editingTopic) {
      setError('Nenhum tÃ³pico selecionado para ediÃ§Ã£o');
      return;
    }
    const cacheKey = `relatorioCustom_${editingTopic.title}_${aiIntegration.relatorioInstruction}_${JSON.stringify(analyzedDocuments)}`;
    const cachedRelatorio = apiCache.get(cacheKey);
    if (cachedRelatorio) {
      setEditingTopic(prev => {
        if (!prev) return prev;
        return { ...prev, editedRelatorio: cachedRelatorio as string };
      });
      closeModal('regenerateRelatorioCustom');
      return;
    }
    aiIntegration.setRegeneratingRelatorio(true);
    setError('');
    try {
      const isRelatorioTopic = editingTopic.title.toUpperCase().includes('RELATÃ“RIO');
      const instructionMentionsComplementares = /\b(documento complementar|ata|audiÃªncia|prova|juntad[oa]|anexad[oa]|complementar)\b/i.test(aiIntegration.relatorioInstruction);
      const htmlContent = await generateMiniReport({
        title: editingTopic.title,
        instruction: aiIntegration.relatorioInstruction,
        currentRelatorio: editingTopic.editedRelatorio || editingTopic.relatorio,
        includeComplementares: isRelatorioTopic || instructionMentionsComplementares
      });
      apiCache.set(cacheKey, htmlContent);
      const updatedTopic = { ...editingTopic, editedRelatorio: htmlContent, relatorio: htmlContent };
      setEditingTopic(updatedTopic);
      if (relatorioRef.current) {
        relatorioRef.current.root.innerHTML = normalizeHTMLSpacing(sanitizeHTML(htmlContent));
      }
      setSelectedTopics(selectedTopics.map(t => t.title === editingTopic.title ? updatedTopic : t));
      setExtractedTopics(extractedTopics.map(t => t.title === editingTopic.title ? updatedTopic : t));
      aiIntegration.setRelatorioInstruction('');
    } catch (err) {
      setError('Erro ao regerar mini-relatÃ³rio: ' + (err as Error).message);
    } finally {
      aiIntegration.setRegeneratingRelatorio(false);
    }
  };

  const regenerateRelatorioProcessual = async () => {
    if (!editingTopic || editingTopic.title.toUpperCase() !== 'RELATÃ“RIO') {
      setError('Esta funÃ§Ã£o sÃ³ pode ser usada para o tÃ³pico RELATÃ“RIO');
      return;
    }
    aiIntegration.setRegeneratingRelatorio(true);
    setAnalysisProgress('ğŸ”„ Regenerando RELATÃ“RIO processual...');
    try {
      const contentArray = buildDocumentContentArray({ includeComplementares: true });
      const instrucao = (aiIntegration.relatorioInstruction || '').trim();
      if (instrucao) {
        contentArray.push({ type: 'text', text: `âš ï¸ INSTRUÃ‡ÃƒO ADICIONAL DO USUÃRIO:\n${instrucao}` });
      }
      const relatorioGerado = await generateRelatorioProcessual(contentArray);
      if (!relatorioGerado?.trim()) throw new Error('RelatÃ³rio gerado estÃ¡ vazio');
      const htmlContent = normalizeHTMLSpacing(relatorioGerado.trim());
      const updatedTopic = { ...editingTopic, editedRelatorio: htmlContent };
      setEditingTopic(updatedTopic);
      if (relatorioRef.current) {
        relatorioRef.current.root.innerHTML = normalizeHTMLSpacing(sanitizeHTML(htmlContent));
      }
      setSelectedTopics(selectedTopics.map(t => t.title === editingTopic.title ? updatedTopic : t));
      setExtractedTopics(extractedTopics.map(t => t.title === editingTopic.title ? updatedTopic : t));
      setAnalysisProgress('');
      aiIntegration.setRelatorioInstruction('');
      showToast('âœ… RELATÃ“RIO processual regenerado!', 'success');
    } catch (err) {
      setError('Erro ao regerar RELATÃ“RIO: ' + (err as Error).message);
      setAnalysisProgress('');
    } finally {
      aiIntegration.setRegeneratingRelatorio(false);
    }
  };

  // v1.36.26: Limpar resultado do Confronto quando tÃ³pico muda (evita mostrar cache do tÃ³pico anterior)
  React.useEffect(() => {
    setFactsComparisonResultIndividual(null);
    setFactsComparisonErrorIndividual(null);
  }, [editingTopic?.title]);

  // v1.36.24: Handler para ABRIR modal de Confronto de Fatos (editor individual) com recuperaÃ§Ã£o de cache
  const handleOpenFactsComparisonIndividual = React.useCallback(async () => {
    if (!editingTopic) return;

    setFactsComparisonErrorIndividual(null);

    // Verificar cache (usa factsComparisonCacheIndividual no editor individual)
    const cached = await factsComparisonCacheIndividual.getComparison(editingTopic.title, 'mini-relatorio');
    if (cached) {
      setFactsComparisonResultIndividual(cached);
    } else {
      const cachedDocs = await factsComparisonCacheIndividual.getComparison(editingTopic.title, 'documentos-completos');
      setFactsComparisonResultIndividual(cachedDocs);
    }

    openModal('factsComparisonIndividual');
  }, [editingTopic, factsComparisonCacheIndividual, openModal]);

  // v1.36.21: Handler para GERAR Confronto de Fatos (editor individual)
  // v1.36.22: Adicionado fallback para PDF binÃ¡rio
  const handleGenerateFactsComparisonIndividual = async (source: FactsComparisonSource) => {
    if (!aiIntegration || !editingTopic) return;

    setGeneratingFactsComparisonIndividual(true);
    setFactsComparisonErrorIndividual(null);

    try {
      let prompt: string;

      if (source === 'mini-relatorio') {
        const relatorio = editingTopic.editedRelatorio || editingTopic.relatorio || '';
        if (!relatorio.trim()) {
          throw new Error('Mini-relatÃ³rio nÃ£o disponÃ­vel para este tÃ³pico.');
        }
        prompt = buildMiniRelatorioComparisonPrompt(editingTopic.title, relatorio);
      } else {
        // Documentos completos - priorizar texto, fallback para PDF binÃ¡rio
        const peticaoText = (analyzedDocuments?.peticoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
        const contestacaoText = (analyzedDocuments?.contestacoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
        const impugnacaoText = (analyzedDocuments?.complementaresText || []).map((t: PastedText) => t.text || '').join('\n\n');

        const hasText = peticaoText.trim() || contestacaoText.trim();
        const hasPdfs = (analyzedDocuments?.peticoes?.length || 0) > 0 || (analyzedDocuments?.contestacoes?.length || 0) > 0;

        if (!hasText && !hasPdfs) {
          throw new Error('Nenhum documento disponÃ­vel (petiÃ§Ã£o ou contestaÃ§Ã£o).');
        }

        if (hasText) {
          // Caminho padrÃ£o: usar texto extraÃ­do
          prompt = buildDocumentosComparisonPrompt(editingTopic.title, peticaoText, contestacaoText, impugnacaoText);
        } else {
          // v1.36.22: Fallback para PDF binÃ¡rio (quando nÃ£o hÃ¡ texto extraÃ­do)
          prompt = buildPdfComparisonPrompt(editingTopic.title);
        }
      }

      // Construir mensagem - pode ser texto simples ou incluir PDFs binÃ¡rios
      let messageContent: AIMessageContent[];

      const peticaoTextFallback = (analyzedDocuments?.peticoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
      const contestacaoTextFallback = (analyzedDocuments?.contestacoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
      const hasTextForMessage = peticaoTextFallback.trim() || contestacaoTextFallback.trim();

      if (hasTextForMessage || source === 'mini-relatorio') {
        // Texto simples
        messageContent = [{ type: 'text', text: prompt }];
      } else {
        // v1.36.22: Incluir PDFs binÃ¡rios como fallback
        messageContent = [{ type: 'text', text: prompt }];

        // Adicionar petiÃ§Ãµes como PDF (analyzedDocuments.peticoes contÃ©m base64 strings)
        for (const base64 of (analyzedDocuments?.peticoes || [])) {
          messageContent.push({ type: 'text', text: '\n\nğŸ“„ PETIÃ‡ÃƒO INICIAL (documento PDF a seguir):' });
          messageContent.push({
            type: 'document',
            source: {
              type: 'base64',
              media_type: 'application/pdf',
              data: base64
            }
          } as AIDocumentContent);
        }

        // Adicionar contestaÃ§Ãµes como PDF
        for (const base64 of (analyzedDocuments?.contestacoes || [])) {
          messageContent.push({ type: 'text', text: '\n\nğŸ“„ CONTESTAÃ‡ÃƒO (documento PDF a seguir):' });
          messageContent.push({
            type: 'document',
            source: {
              type: 'base64',
              media_type: 'application/pdf',
              data: base64
            }
          } as AIDocumentContent);
        }

        // Adicionar complementares como PDF
        for (const base64 of (analyzedDocuments?.complementares || [])) {
          messageContent.push({ type: 'text', text: '\n\nğŸ“„ DOCUMENTO COMPLEMENTAR (documento PDF a seguir):' });
          messageContent.push({
            type: 'document',
            source: {
              type: 'base64',
              media_type: 'application/pdf',
              data: base64
            }
          } as AIDocumentContent);
        }
      }

      const response = await aiIntegration.callAI([{
        role: 'user',
        content: messageContent
      }], {
        maxTokens: 8000,
        useInstructions: false,
        temperature: 0.3,
        topP: 0.9,
        topK: 40
      });

      // Extrair JSON da resposta (pode vir com markdown)
      let jsonStr = response;
      const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
      if (jsonMatch) {
        jsonStr = jsonMatch[1];
      } else {
        // Tentar encontrar JSON direto
        const firstBrace = response.indexOf('{');
        const lastBrace = response.lastIndexOf('}');
        if (firstBrace !== -1 && lastBrace !== -1) {
          jsonStr = response.substring(firstBrace, lastBrace + 1);
        }
      }

      const parsed = JSON.parse(jsonStr);

      // v1.36.58: Double Check do Confronto de Fatos (Individual)
      let verifiedParsed = parsed;
      if (aiIntegration.aiSettings.doubleCheck?.enabled &&
          aiIntegration.aiSettings.doubleCheck?.operations.factsComparison) {
        try {
          // Contexto depende do source usado
          let contextText: string;
          if (source === 'mini-relatorio') {
            const relatorio = editingTopic.editedRelatorio || editingTopic.relatorio || '';
            contextText = `MINI-RELATÃ“RIO DO TÃ“PICO "${editingTopic.title}":\n${relatorio}`;
          } else {
            // documentos-completos
            const peticaoText = (analyzedDocuments?.peticoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
            const contestacaoText = (analyzedDocuments?.contestacoesText || []).map((t: PastedText) => t.text || '').join('\n\n');
            const impugnacaoText = (analyzedDocuments?.complementaresText || []).map((t: PastedText) => t.text || '').join('\n\n');

            contextText = [
              peticaoText && `PETIÃ‡ÃƒO INICIAL:\n${peticaoText}`,
              contestacaoText && `CONTESTAÃ‡ÃƒO:\n${contestacaoText}`,
              impugnacaoText && `IMPUGNAÃ‡ÃƒO/RÃ‰PLICA:\n${impugnacaoText}`
            ].filter(Boolean).join('\n\n---\n\n');
          }

          const { verified, corrections, summary } = await aiIntegration.performDoubleCheck(
            'factsComparison',
            JSON.stringify(parsed, null, 2),
            contextText
          );

          if (corrections.length > 0) {
            const verifiedObj = JSON.parse(verified);
            // Extrair o resultado verificado (pode estar em verifiedResult ou ser o objeto inteiro)
            verifiedParsed = verifiedObj.verifiedResult || verifiedObj;
            showToast(`ğŸ”„ Double Check: ${corrections.length} correÃ§Ã£o(Ãµes) - ${summary}`, 'info');
            console.log('[DoubleCheck FactsComparison Individual] CorreÃ§Ãµes:', corrections);
          }
        } catch (dcError) {
          console.error('[DoubleCheck FactsComparison Individual] Erro:', dcError);
          // Continuar com parsed original em caso de erro
        }
      }

      const result: FactsComparisonResult = {
        topicTitle: editingTopic.title,
        source,
        generatedAt: new Date().toISOString(),
        tabela: verifiedParsed.tabela || [],
        fatosIncontroversos: verifiedParsed.fatosIncontroversos || [],
        fatosControversos: verifiedParsed.fatosControversos || [],
        pontosChave: verifiedParsed.pontosChave || [],
        resumo: verifiedParsed.resumo || ''
      };

      // Salvar no cache
      await factsComparisonCacheIndividual.saveComparison(editingTopic.title, source, result);

      setFactsComparisonResultIndividual(result);
    } catch (err) {
      console.error('[FactsComparison Individual] Erro:', err);
      setFactsComparisonErrorIndividual(err instanceof Error ? err.message : 'Erro ao gerar anÃ¡lise. Tente novamente.');
    } finally {
      setGeneratingFactsComparisonIndividual(false);
    }
  };


  // ğŸ“‹ FUNÃ‡Ã•ES: Gerenciamento de TÃ³picos

  const handleRenameTopic = async (shouldRegenerate = true) => {
    if (!newTopicName.trim() || !topicToRename) return;
    const upperCaseTitle = newTopicName.trim().toUpperCase();
    aiIntegration.setRegenerating(true);
    setError('');
    try {
      let newRelatorio = topicToRename.relatorio;
      if (shouldRegenerate) {
        setAnalysisProgress(`ğŸ”„ Regenerando mini-relatÃ³rio para "${upperCaseTitle}"...`);
        const renameContext = `**CONTEXTO DE RENOMEAÃ‡ÃƒO:**
TÃ³pico ANTERIOR: "${topicToRename.title}"
TÃ³pico NOVO: "${upperCaseTitle}"
**INSTRUÃ‡ÃƒO:** Busque informaÃ§Ãµes ESPECÃFICAS sobre "${upperCaseTitle}" nos documentos.
NÃƒO replique o conteÃºdo do tÃ³pico anterior "${topicToRename.title}".
Se o novo tÃ­tulo representa um aspecto DIFERENTE do anterior, extraia informaÃ§Ãµes DIFERENTES.
Se nÃ£o houver informaÃ§Ãµes especÃ­ficas, indique: "NÃ£o foram localizadas informaÃ§Ãµes especÃ­ficas sobre ${upperCaseTitle} nas peÃ§as processuais."`;
        newRelatorio = await generateMiniReport({ title: upperCaseTitle, context: renameContext });
      }
      if (newRelatorio) {
        setSelectedTopics(selectedTopics.map(t => t.title === topicToRename.title ? { ...t, title: upperCaseTitle, relatorio: newRelatorio } : t));
        setExtractedTopics(extractedTopics.map(t => t.title === topicToRename.title ? { ...t, title: upperCaseTitle, relatorio: newRelatorio } : t));
      } else {
        setError('NÃ£o foi possÃ­vel gerar o mini-relatÃ³rio para o tÃ³pico renomeado.');
      }
    } catch (err) {
      setError('Erro ao renomear tÃ³pico: ' + (err as Error).message);
    } finally {
      aiIntegration.setRegenerating(false);
    }
    closeModal('rename');
    setTopicToRename(null);
    setNewTopicName('');
  };

  const handleMergeTopics = async () => {
    if (topicsToMerge.length < 2) {
      setError('Selecione pelo menos 2 tÃ³picos para unir');
      return;
    }
    aiIntegration.setRegenerating(true);
    setError('');
    try {
      const mergedTitle = topicsToMerge.map(t => t.title).join(' e ');
      setAnalysisProgress(`ğŸ”„ Gerando mini-relatÃ³rio unificado para "${mergedTitle}"...`);
      const topicsInfo = topicsToMerge.map((t, i: number) => `${i + 1}. ${t.title}`).join('\n');
      const mergeContext = `**CONTEXTO DE UNIÃƒO DE TÃ“PICOS:**
Os seguintes tÃ³picos estÃ£o sendo unidos em um Ãºnico tÃ³pico:
${topicsInfo}
**INSTRUÃ‡ÃƒO:** Crie um mini-relatÃ³rio unificado que contemple TODOS os aspectos dos tÃ³picos originais.
Extraia informaÃ§Ãµes relevantes para TODOS os tÃ³picos sendo unidos.
Unifique as informaÃ§Ãµes de forma coerente e abrangente.`;
      const newRelatorio = await generateMiniReport({ title: mergedTitle, context: mergeContext });
      if (newRelatorio) {
        const mergedTopic = { title: mergedTitle, category: topicsToMerge[0]?.category || 'MÃ‰RITO', relatorio: newRelatorio, editedContent: '' };
        const mergeSet = new Set(topicsToMerge.map(mt => mt.title));
        // Calcular posiÃ§Ã£o correta: contar quantos itens NÃƒO mesclados vÃªm ANTES do primeiro mesclado
        const firstTopicIndex = selectedTopics.findIndex((t: Topic) => mergeSet.has(t.title));
        const insertPosition = firstTopicIndex >= 0 ? selectedTopics.slice(0, firstTopicIndex).filter(t => !mergeSet.has(t.title)).length : 0;
        const remainingTopics = selectedTopics.filter(t => !mergeSet.has(t.title));
        remainingTopics.splice(insertPosition, 0, mergedTopic);
        setSelectedTopics(remainingTopics);
        const firstExtractedIndex = extractedTopics.findIndex((t: Topic) => mergeSet.has(t.title));
        const extractInsertPosition = firstExtractedIndex >= 0 ? extractedTopics.slice(0, firstExtractedIndex).filter(t => !mergeSet.has(t.title)).length : 0;
        const remainingExtracted = extractedTopics.filter(t => !mergeSet.has(t.title));
        remainingExtracted.splice(extractInsertPosition, 0, mergedTopic);
        setExtractedTopics(remainingExtracted);
        closeModal('merge');
        setTopicsToMerge([]);
      } else {
        setError('NÃ£o foi possÃ­vel gerar o mini-relatÃ³rio unificado. Tente novamente.');
      }
    } catch (err) {
      setError('Erro ao unir tÃ³picos: ' + (err as Error).message);
    } finally {
      aiIntegration.setRegenerating(false);
    }
  };

  const handleSplitTopic = async () => {
    if (!topicToSplit || splitNames.filter(n => n.trim()).length < 2) return;
    const validNames = splitNames.filter(n => n.trim()).map(n => n.trim().toUpperCase());
    aiIntegration.setRegenerating(true);
    setError('');
    try {
      const splitContext = `**CONTEXTO DE DIVISÃƒO:**
TÃ³pico original: "${topicToSplit.title}"
**INSTRUÃ‡ÃƒO:** Este Ã© um subtÃ³pico derivado de "${topicToSplit.title}".
Extraia APENAS informaÃ§Ãµes relevantes para o subtÃ³pico especÃ­fico.
Se nÃ£o houver informaÃ§Ãµes especÃ­ficas nos documentos, indique de forma clara.`;
      const topicsToGenerate = validNames.map(name => ({
        title: name,
        category: topicToSplit.category,
        context: splitContext,
        includeComplementares: true
      }));
      const { results, errors } = await generateMiniReportsBatch(topicsToGenerate, {
        batchSize: aiIntegration.aiSettings.parallelRequests || 5,
        delayBetweenBatches: 1000,
        onProgress: (current: number, total: number, batchNum: number, totalBatches: number) => {
          setAnalysisProgress(`ğŸš€ Gerando subtÃ³picos... ${current}/${total} (Lote ${batchNum}/${totalBatches})`);
        }
      });
      if (errors.length > 0) {
        setError(`${errors.length} subtÃ³pico(s) falharam: ${errors.map(e => e.error).join('; ')}`);
      }
      const newTopics = results.map(r => ({ title: r.title, category: topicToSplit.category, relatorio: r.relatorio, editedContent: '' }));
      if (newTopics.length === 0) {
        throw new Error('Nenhum subtÃ³pico foi gerado com sucesso.');
      }
      const originalIndex = selectedTopics.findIndex((t: Topic) => t.title === topicToSplit.title);
      const remainingTopics = selectedTopics.filter(t => t.title !== topicToSplit.title);
      remainingTopics.splice(originalIndex, 0, ...newTopics);
      setSelectedTopics(remainingTopics);
      const originalExtractedIndex = extractedTopics.findIndex((t: Topic) => t.title === topicToSplit.title);
      const remainingExtracted = extractedTopics.filter(t => t.title !== topicToSplit.title);
      remainingExtracted.splice(originalExtractedIndex, 0, ...newTopics);
      setExtractedTopics(remainingExtracted);
    } catch (err) {
      setError('Erro ao separar tÃ³pico: ' + (err as Error).message);
    } finally {
      aiIntegration.setRegenerating(false);
    }
    closeModal('split');
    setTopicToSplit(null);
    setSplitNames(['', '']);
  };

  const handleCreateNewTopic = async () => {
    if (!newTopicData?.title?.trim()) {
      setError('Digite um tÃ­tulo para o tÃ³pico');
      return;
    }
    const upperCaseTitle = newTopicData.title.trim().toUpperCase();
    const category = newTopicData.category || 'MÃ‰RITO';
    aiIntegration.setRegenerating(true);
    setError('');
    try {
      let newRelatorio = (newTopicData.relatorio || '').trim();
      if (!newRelatorio && (analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0)) {
        try {
          newRelatorio = await generateMiniReport({
            title: upperCaseTitle,
            context: `TÃ³pico criado manualmente na categoria "${category}". Se nÃ£o houver informaÃ§Ãµes especÃ­ficas, indique que o tÃ³pico foi criado manualmente.`,
            includeComplementares: true
          });
        } catch (apiErr) {
          setError('NÃ£o foi possÃ­vel gerar automaticamente: ' + (apiErr as Error).message);
          newRelatorio = plainTextToHtml(`TÃ³pico "${upperCaseTitle}" criado manualmente.\n\nErro ao analisar documentos.`);
        }
      } else if (!newRelatorio) {
        newRelatorio = plainTextToHtml(`TÃ³pico "${upperCaseTitle}" criado manualmente.\n\nNÃ£o hÃ¡ documentos para anÃ¡lise.`);
      }
      const newTopic: Topic = { title: upperCaseTitle, category, relatorio: newRelatorio, editedContent: '' };
      setExtractedTopics([...extractedTopics, newTopic]);
      closeModal('newTopic');
      setNewTopicData({ title: '', category: 'MÃ‰RITO', relatorio: '' });
      setError('');
    } catch (err) {
      setError('Erro ao criar tÃ³pico: ' + (err as Error).message);
    } finally {
      aiIntegration.setRegenerating(false);
    }
  };


  // ğŸ¤– FUNÃ‡Ã•ES: GeraÃ§Ã£o de Texto com IA

  const generateAiText = async () => {
    if (!aiIntegration.aiInstruction?.trim()) {
      setError('Digite uma instruÃ§Ã£o para a IA');
      return;
    }

    aiIntegration.setGeneratingAi(true);
    aiIntegration.setAiGeneratedText('');

    try {
      const currentContent = editorRef.current?.root?.innerText || '';

      // Preparar documentos usando helper
      const { contentArray, flags } = prepareDocumentsContext(analyzedDocuments);
      const { hasPeticao, hasContestacoes, hasComplementares } = flags;

      // ğŸ†• v1.19.5: Usar funÃ§Ã£o centralizada para provas
      // v1.19.2: Passar flag de anonimizaÃ§Ã£o
      // v1.21.5: Passar anonConfig para anonimizar texto
      const { proofDocuments, proofsContext, hasProofs } = await prepareProofsContext(
        proofManager, editingTopic?.title || '', storage.fileToBase64, aiIntegration?.aiSettings?.anonymization?.enabled, aiIntegration?.aiSettings?.anonymization
      );
      contentArray.push(...proofDocuments);

      // Preparar contexto baseado no escopo selecionado
      let decisionContext = '';

      if (topicContextScope === 'current') {
        // Apenas o tÃ³pico atual
        decisionContext = `ğŸ“‹ CONTEXTO DO TÃ“PICO:
TÃ­tulo: ${editingTopic?.title || 'NÃ£o especificado'}
Categoria: ${editingTopic?.category || 'NÃ£o especificada'}

ğŸ“ MINI-RELATÃ“RIO DO TÃ“PICO:
${editingTopic?.relatorio || 'NÃ£o disponÃ­vel'}

âœï¸ CONTEÃšDO JÃ ESCRITO DA DECISÃƒO:
${currentContent || 'Ainda nÃ£o foi escrito nada'}`;
      } else {
        // Toda a decisÃ£o (todos os tÃ³picos)
        decisionContext = 'ğŸ“‹ CONTEXTO COMPLETO DA DECISÃƒO:\n\n';

        selectedTopics.forEach((t, index) => {
          const titleUpper = t.title.toUpperCase();
          if (titleUpper === 'RELATÃ“RIO') {
            decisionContext += `ğŸ“„ RELATÃ“RIO GERAL:\n${t.editedRelatorio || t.relatorio || 'NÃ£o disponÃ­vel'}\n\n---\n\n`;
          } else if (titleUpper === 'DISPOSITIVO') {
            decisionContext += `âš–ï¸ DISPOSITIVO:\n${t.editedContent || ''}\n\n---\n\n`;
          } else {
            decisionContext += `ğŸ“‹ TÃ“PICO ${index}: ${t.title} (${t.category || 'Sem categoria'})
Mini-relatÃ³rio: ${t.editedRelatorio || t.relatorio || 'NÃ£o disponÃ­vel'}
DecisÃ£o: ${t.editedFundamentacao || t.fundamentacao || 'NÃ£o escrita'}

---

`;
          }
        });

        decisionContext += `\nğŸ¯ TÃ“PICO SENDO EDITADO: ${editingTopic?.title}
âœï¸ CONTEÃšDO JÃ ESCRITO NESTE TÃ“PICO:
${currentContent || 'Ainda nÃ£o foi escrito nada'}`;
      }

      // 8. Adicionar instruÃ§Ã£o de texto
      contentArray.push({
        type: 'text',
        text: `VocÃª estÃ¡ auxiliando na redaÃ§Ã£o de uma DECISÃƒO JUDICIAL TRABALHISTA.

${decisionContext}

${hasPeticao || hasContestacoes || hasComplementares || hasProofs ? `
ğŸ“š DOCUMENTOS DISPONÃVEIS PARA CONSULTA:
${hasPeticao ? 'âœ“ PetiÃ§Ã£o inicial' : ''}
${hasContestacoes ? 'âœ“ ContestaÃ§Ã£o(Ãµes)' : ''}
${hasComplementares ? 'âœ“ Documento(s) complementar(es)' : ''}
${hasProofs ? 'âœ“ Prova(s) vinculada(s) a este tÃ³pico' : ''}

Os documentos foram anexados acima. VocÃª pode e DEVE consultÃ¡-los para fundamentar sua decisÃ£o, especialmente:
- Para identificar alegaÃ§Ãµes e argumentos das partes
- Para verificar provas mencionadas
- Para fundamentar sua decisÃ£o com base no que foi apresentado nos autos
${hasProofs ? '- Para analisar as provas vinculadas e suas respectivas anÃ¡lises/conclusÃµes' : ''}
` : ''}
${proofsContext}
ğŸ¯ INSTRUÃ‡ÃƒO DO USUÃRIO:
${aiIntegration.aiInstruction}

âš ï¸ IMPORTANTE - NÃƒO INCLUIR MINI-RELATÃ“RIO:
- O mini-relatÃ³rio jÃ¡ foi fornecido acima apenas como CONTEXTO
- NÃƒO repita ou resuma os fatos no texto gerado
- NÃƒO inicie com "Trata-se de...", "Cuida-se de...", "O reclamante postula..."
- VÃ¡ DIRETO para a anÃ¡lise jurÃ­dica, fundamentaÃ§Ã£o e conclusÃ£o

${AI_PROMPTS.estiloRedacao}

Com base em TODOS os elementos acima (contexto do tÃ³pico, documentos processuais e instruÃ§Ã£o do usuÃ¡rio), gere o texto solicitado.

O texto deve:
- Ser adequado para uma decisÃ£o judicial trabalhista
- Usar SEMPRE a primeira pessoa
- Manter linguagem formal, mas acessÃ­vel
- Evitar latinismos desnecessÃ¡rios
- Ser claro e objetivo
- Considerar o contexto do tÃ³pico e o que jÃ¡ foi escrito
- FUNDAMENTAR-SE nos documentos processuais (petiÃ§Ã£o, contestaÃ§Ãµes, provas)
- Citar fatos especÃ­ficos dos autos quando relevante
- Aplicar bases legais quando apropriado

${AI_PROMPTS.formatacaoHTML("A <strong>CLT</strong> estabelece que...")}

${AI_PROMPTS.formatacaoParagrafos("<p>Passo a analisar...</p><p>A CLT estabelece...</p>")}

${AI_PROMPTS.numeracaoReclamadas}

Responda APENAS com o texto gerado em HTML, sem prefÃ¡cio, sem explicaÃ§Ãµes. Gere texto pronto para ser inserido na decisÃ£o.`
      });

      // v1.21.26: Parametros para assistente interativo (criativo moderado)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 4000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.5,
        topP: 0.9,
        topK: 80
      });

      aiIntegration.setAiGeneratedText(textContent.trim());
      setError('');
    } catch (err) {
      setError('Erro ao gerar texto com IA: ' + (err as Error).message);
    } finally {
      aiIntegration.setGeneratingAi(false);
    }
  };

  const insertAiText = (mode: InsertMode) => {
    if (!aiIntegration.aiGeneratedText || !editorRef.current || !editingTopic) return;

    const currentHtml = editorRef.current.root.innerHTML;
    const normalizedAiText = normalizeHTMLSpacing(aiIntegration.aiGeneratedText);
    let newHtml: string;

    switch (mode) {
      case 'replace':
        newHtml = sanitizeHTML(normalizedAiText) || '';
        break;
      case 'append':
        newHtml = sanitizeHTML(currentHtml + '<br>' + normalizedAiText) || '';
        break;
      case 'prepend':
        newHtml = sanitizeHTML(normalizedAiText + '<br>' + currentHtml) || '';
        break;
    }

    editorRef.current.root.innerHTML = newHtml;

    setEditingTopic({
      ...editingTopic,
      editedFundamentacao: newHtml
    });

    closeModal('aiAssistant');
    aiIntegration.setAiInstruction('');
    aiIntegration.setAiGeneratedText('');
  };

  // ğŸ¤– v1.19.0: ConstrÃ³i contexto completo para chat do assistente IA (Editor Individual)
  // ğŸ†• v1.19.5: Agora assÃ­ncrono para suportar PDFs binÃ¡rios
  const buildContextForChat = React.useCallback(async (userMessage: string, options: { proofFilter?: string } = {}) => {
    const currentContent = editorRef.current?.root?.innerText || '';
    const { proofFilter } = options;

    // Preparar documentos usando helper
    const { contentArray, flags } = prepareDocumentsContext(analyzedDocuments);
    const { hasPeticao, hasContestacoes, hasComplementares } = flags;

    // ğŸ†• v1.21.1: Usar funÃ§Ã£o de provas orais se filtro ativo
    // v1.19.2: Passar flag de anonimizaÃ§Ã£o
    // v1.21.5: Passar anonConfig para anonimizar texto
    const prepareFunction = proofFilter === 'oral' ? prepareOralProofsContext : prepareProofsContext;
    const { proofDocuments, proofsContext, hasProofs } = await prepareFunction(
      proofManager, editingTopic?.title || '', storage.fileToBase64, aiIntegration?.aiSettings?.anonymization?.enabled, aiIntegration?.aiSettings?.anonymization
    );
    contentArray.push(...proofDocuments);

    // Contexto baseado no escopo selecionado
    let decisionContext = '';
    if (topicContextScope === 'current') {
      decisionContext = `ğŸ“‹ CONTEXTO DO TÃ“PICO:
TÃ­tulo: ${editingTopic?.title || 'NÃ£o especificado'}
Categoria: ${editingTopic?.category || 'NÃ£o especificada'}

ğŸ“ MINI-RELATÃ“RIO DO TÃ“PICO:
${editingTopic?.relatorio || 'NÃ£o disponÃ­vel'}

âœï¸ CONTEÃšDO JÃ ESCRITO DA DECISÃƒO:
${currentContent || 'Ainda nÃ£o foi escrito nada'}`;
    } else {
      decisionContext = 'ğŸ“‹ CONTEXTO COMPLETO DA DECISÃƒO:\n\n';
      selectedTopics.forEach((t, index) => {
        const titleUpper = t.title.toUpperCase();
        if (titleUpper === 'RELATÃ“RIO') {
          decisionContext += `ğŸ“„ RELATÃ“RIO GERAL:\n${t.editedRelatorio || t.relatorio || 'NÃ£o disponÃ­vel'}\n\n---\n\n`;
        } else if (titleUpper === 'DISPOSITIVO') {
          decisionContext += `âš–ï¸ DISPOSITIVO:\n${t.editedContent || ''}\n\n---\n\n`;
        } else {
          decisionContext += `ğŸ“‹ TÃ“PICO ${index}: ${t.title} (${t.category || 'Sem categoria'})
Mini-relatÃ³rio: ${t.editedRelatorio || t.relatorio || 'NÃ£o disponÃ­vel'}
DecisÃ£o: ${t.editedFundamentacao || t.fundamentacao || 'NÃ£o escrita'}

---

`;
        }
      });
      decisionContext += `\nğŸ¯ TÃ“PICO SENDO EDITADO: ${editingTopic?.title}
âœï¸ CONTEÃšDO JÃ ESCRITO NESTE TÃ“PICO:
${currentContent || 'Ainda nÃ£o foi escrito nada'}`;
    }

    // Verificar se anonimizaÃ§Ã£o estÃ¡ ativada
    const anonymizationEnabled = aiIntegration?.aiSettings?.anonymization?.enabled;

    // Montar prompt completo
    contentArray.push({
      type: 'text',
      text: `VocÃª estÃ¡ auxiliando na redaÃ§Ã£o de uma DECISÃƒO JUDICIAL TRABALHISTA.

${decisionContext}

${hasPeticao || hasContestacoes || hasComplementares || hasProofs ? `
ğŸ“š DOCUMENTOS DISPONÃVEIS PARA CONSULTA:
${hasPeticao ? 'âœ“ PetiÃ§Ã£o inicial' : ''}
${hasContestacoes ? 'âœ“ ContestaÃ§Ã£o(Ãµes)' : ''}
${hasComplementares ? 'âœ“ Documento(s) complementar(es)' : ''}
${hasProofs ? 'âœ“ Prova(s) vinculada(s) a este tÃ³pico' : ''}

Os documentos foram anexados acima. VocÃª pode e DEVE consultÃ¡-los para fundamentar sua decisÃ£o.
${hasProofs ? '- Analise as provas vinculadas e suas respectivas anÃ¡lises/conclusÃµes' : ''}
` : ''}
${proofsContext}

${INSTRUCAO_NAO_PRESUMIR}

${AI_PROMPTS.estiloRedacao}
${AI_PROMPTS.numeracaoReclamadas}
${anonymizationEnabled ? AI_PROMPTS.preservarAnonimizacao : ''}

âš ï¸ NÃƒO INCLUIR MINI-RELATÃ“RIO no texto gerado.

ğŸ¯ INSTRUÃ‡ÃƒO DO USUÃRIO:
${userMessage}

Quando faltar informaÃ§Ã£o expressa necessÃ¡ria Ã  redaÃ§Ã£o, PERGUNTE ao usuÃ¡rio antes de redigir. Prefira perguntar a presumir.

âš ï¸ ANTES DE REDIGIR QUALQUER TEXTO DE DECISÃƒO:
Liste as informaÃ§Ãµes/conclusÃµes que vocÃª precisa confirmar com o usuÃ¡rio.
SÃ³ prossiga com a redaÃ§Ã£o APÃ“S receber as respostas.
Se nÃ£o houver nada a confirmar, indique "Nenhuma informaÃ§Ã£o pendente" e prossiga.

Quando gerar texto para a decisÃ£o, responda em HTML.
${AI_PROMPTS.formatacaoHTML("A <strong>CLT</strong> estabelece...")}
${AI_PROMPTS.formatacaoParagrafos("<p>Primeiro parÃ¡grafo.</p><p>Segundo parÃ¡grafo.</p>")}`
    });

    return contentArray;
  }, [analyzedDocuments, proofManager, editingTopic, topicContextScope, selectedTopics, aiIntegration?.aiSettings?.anonymization?.enabled]);

  // ğŸ¤– v1.19.0: Handler para inserir resposta do chat no editor
  const handleInsertChatResponse = React.useCallback((mode: InsertMode) => {
    const response = chatAssistant.lastResponse;
    if (!response || !editorRef.current || !editingTopic) return;

    const currentHtml = editorRef.current.root.innerHTML;
    const normalizedAiText = normalizeHTMLSpacing(response);
    let newHtml: string;

    switch (mode) {
      case 'replace':
        newHtml = sanitizeHTML(normalizedAiText) || '';
        break;
      case 'append':
        newHtml = sanitizeHTML(currentHtml + '<br>' + normalizedAiText) || '';
        break;
      case 'prepend':
        newHtml = sanitizeHTML(normalizedAiText + '<br>' + currentHtml) || '';
        break;
      default:
        newHtml = sanitizeHTML(normalizedAiText) || '';
    }

    editorRef.current.root.innerHTML = newHtml;
    setEditingTopic({
      ...editingTopic,
      editedFundamentacao: newHtml
    });
  }, [chatAssistant.lastResponse, editingTopic, setEditingTopic]);

  // ğŸ¤– v1.19.0: Handler para enviar mensagem no chat
  // v1.21.1: Aceita options (ex: { proofFilter: 'oral' }) para filtrar provas
  // v1.21.13: Removido modal de anonimizaÃ§Ã£o - provas CONFLITO sÃ£o filtradas em prepareProofsContext
  const handleSendChatMessage = React.useCallback(async (message: string, options: { proofFilter?: string } = {}) => {
    const contextBuilderWithOptions = (msg: string) => buildContextForChat(msg, options);
    await chatAssistant.send(message, contextBuilderWithOptions);
  }, [chatAssistant, buildContextForChat]);

  const generateAiTextForModel = async () => {
    // VerificaÃ§Ã£o defensiva
    if (!aiIntegration?.callAI) {
      console.error('[generateAiTextForModel] aiIntegration.callAI undefined');
      setError('Erro interno: sistema de IA nÃ£o inicializado. Recarregue a pÃ¡gina.');
      return;
    }
    if (!aiIntegration.aiInstructionModel?.trim()) {
      setError('Digite uma instruÃ§Ã£o para a IA');
      return;
    }

    aiIntegration.setGeneratingAiModel(true);
    aiIntegration.setAiGeneratedTextModel('');

    try {
      // FASE 4: Obter conteÃºdo atual do editor (Quill ou contentEditable)
      let currentContent = '';
      if (modelEditorRef.current) {
        // Editor Quill - obter texto via root.innerText
        currentContent = modelEditorRef.current.root ? modelEditorRef.current.root.innerText : '';
      }

      const prompt = `VocÃª estÃ¡ auxiliando na criaÃ§Ã£o de um modelo de texto para decisÃµes judiciais trabalhistas.

CONTEXTO DO MODELO:
TÃ­tulo: ${modelLibrary.newModel.title || 'NÃ£o especificado'}
Categoria: ${modelLibrary.newModel.category || 'NÃ£o especificada'}

CONTEÃšDO JÃ ESCRITO:
${currentContent || 'Ainda nÃ£o foi escrito nada'}

INSTRUÃ‡ÃƒO DO USUÃRIO:
${aiIntegration.aiInstructionModel}

âš ï¸ IMPORTANTE - NÃƒO INCLUIR MINI-RELATÃ“RIO:
- Este Ã© um MODELO genÃ©rico de decisÃ£o, nÃ£o um caso especÃ­fico
- NÃƒO inicie com resumo de fatos ou mini-relatÃ³rio
- NÃƒO use "Trata-se de...", "Cuida-se de...", "O reclamante postula..."
- VÃ¡ DIRETO para a anÃ¡lise jurÃ­dica, fundamentaÃ§Ã£o e conclusÃ£o
- Use termos genÃ©ricos ("o reclamante", "a reclamada", "os documentos dos autos")

${AI_PROMPTS.estiloRedacao}

Baseado no contexto acima e na instruÃ§Ã£o do usuÃ¡rio, gere o texto solicitado. O texto deve:
- Ser adequado para um modelo reutilizÃ¡vel de decisÃ£o judicial trabalhista
- Usar SEMPRE a primeira pessoa
- Manter linguagem formal, mas acessÃ­vel
- Evitar latinismos desnecessÃ¡rios
- Ser claro e objetivo
- Ser genÃ©rico o suficiente para ser adaptÃ¡vel a diferentes casos similares
- Fundamentar em bases legais quando apropriado

Responda APENAS com o texto gerado, sem prefÃ¡cio, sem explicaÃ§Ãµes, sem markdown. Gere texto pronto para ser inserido no modelo.`;

      // v1.21.26: Parametros para assistente de modelos (mais criativo)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], {
        maxTokens: 4000,
        useInstructions: true,
        temperature: 0.6,
        topP: 0.9,
        topK: 100
      });

      aiIntegration.setAiGeneratedTextModel(textContent);
      setError('');
    } catch (err) {
      setError('Erro ao gerar texto com IA: ' + (err as Error).message);
    } finally {
      aiIntegration.setGeneratingAiModel(false);
    }
  };

  const insertAiTextModel = (mode: InsertMode) => {
    if (!aiIntegration.aiGeneratedTextModel || !modelEditorRef.current) return;

    // Editor Quill - usar API do Quill

    const quillInstance = modelEditorRef.current;
    const generatedText = normalizeHTMLSpacing(aiIntegration.aiGeneratedTextModel);

    switch (mode) {
      case 'replace':
        // Substituir todo o conteÃºdo
        quillInstance.root.innerHTML = sanitizeQuillHTML(generatedText);
        break;

      case 'append': {
        // Adicionar ao final
        const currentLength = quillInstance.getLength();
        quillInstance.insertText(currentLength - 1, '\n');
        quillInstance.clipboard.dangerouslyPasteHTML(
          quillInstance.getLength(),
          sanitizeQuillHTML(generatedText)
        );
        break;
      }

      case 'prepend':
        // Adicionar no inÃ­cio
        quillInstance.clipboard.dangerouslyPasteHTML(0, sanitizeQuillHTML(generatedText + '\n'));
        break;
    }

    // Atualizar estado com o HTML do Quill
    const newContent = sanitizeQuillHTML(quillInstance.root.innerHTML);
    modelLibrary.setNewModel({
      ...modelLibrary.newModel,
      content: newContent
    });


    closeModal('aiAssistantModel');
    aiIntegration.setAiInstructionModel('');
    aiIntegration.setAiGeneratedTextModel('');
  };


  // âœï¸ FUNÃ‡Ã•ES: Editor de Texto

  const applyFormat = (command: string, value: string | null = null) => {
    document.execCommand(command, false, value ?? undefined);
    if (editorRef.current) {
      editorRef.current.focus();
    }
  };

  const applyModelFormat = (command: string, value: string | null = null) => {
    document.execCommand(command, false, value ?? undefined);
    if (modelEditorRef.current) {
      modelEditorRef.current.focus();
    }
  };

  
  const htmlToPlainText = (html: string) => {
    const temp = document.createElement('div');
    temp.innerHTML = sanitizeHTML(html); // Sanitizar antes de processar
    return temp.textContent || temp.innerText || '';
  };

  const htmlToFormattedText = (html: string) => {
    if (!html) return '';
    
    let text = html;
    
    // Detectar se Ã© texto puro (sem tags HTML significativas) ou HTML
    const hasSignificantHtml = /<(p|br|div|ul|ol|li|h[1-6]|strong|b|em|i|u)[^>]*>/i.test(text);
    
    if (!hasSignificantHtml) {
      // Ã‰ texto puro - converter quebras de linha simples em duplas para Google Docs
      text = text.replace(/\n/g, '\n\n');
      // Limpar mÃºltiplas quebras excessivas
      text = text.replace(/\n{3,}/g, '\n\n');
      return text.trim();
    }
    
        // Remover tags de formataÃ§Ã£o mantendo apenas o conteÃºdo
    text = text.replace(/<\/?b>/gi, '');
    text = text.replace(/<\/?strong>/gi, '');
    text = text.replace(/<\/?i>/gi, '');
    text = text.replace(/<\/?em>/gi, '');
    text = text.replace(/<\/?u>/gi, '');

    // Converter <br> em quebra de linha simples
    text = text.replace(/<br\s*\/?>/gi, '\n');
    
    // Converter fechamento de parÃ¡grafo em duas quebras de linha
    text = text.replace(/<\/p>/gi, '\n\n');
    text = text.replace(/<p>/gi, '');
    
    // Converter divs em quebras de linha
    text = text.replace(/<\/div>/gi, '\n');
    text = text.replace(/<div>/gi, '');
    
    // Processar listas
    text = text.replace(/<li>/gi, 'â€¢ ');
    text = text.replace(/<\/li>/gi, '\n');
    text = text.replace(/<ul>|<\/ul>|<ol>|<\/ol>/gi, '\n');
    
    // Processar cabeÃ§alhos
    text = text.replace(/<\/h[1-6]>/gi, '\n\n');
    text = text.replace(/<h[1-6][^>]*>/gi, '');
    
    // Remover outras tags HTML
    text = text.replace(/<[^>]+>/g, '');
    text = text.replace(/&nbsp;/g, ' ');
    text = text.replace(/&amp;/g, '&');
    text = text.replace(/&lt;/g, '<');
    text = text.replace(/&gt;/g, '>');
    text = text.replace(/&quot;/g, '"');
    
    // Limpar mÃºltiplas quebras de linha excessivas (mais de 2 seguidas)
    text = text.replace(/\n{3,}/g, '\n\n');
    
    return text.trim();
  };

  const plainTextToHtml = (text: string) => {
    if (!text) return '';
    
    // Converter texto puro em HTML, preservando quebras de linha
    let html = text;
    
    // Escapar caracteres HTML especiais
    html = html.replace(/&/g, '&amp;');
    html = html.replace(/</g, '&lt;');
    html = html.replace(/>/g, '&gt;');
    
    // Converter quebras de linha em <br>
    html = html.replace(/\n/g, '<br>');
    
    return html;
  };

  const cleanHtmlForExport = (html: string) => {
    if (!html) return '';

    // Preservar a formataÃ§Ã£o original
    let cleaned = html;

    // v1.20.7: Limpar artefatos do Google Docs ANTES de remover spans
    // Usar regex que NÃƒO atravessa outras tags span (evita greedy matching)
    let prevHtml;

    // 1. Remover wrapper docs-internal-guid (mÃºltiplas passadas para spans aninhados)
    do {
      prevHtml = cleaned;
      cleaned = cleaned.replace(/<span\s+id="docs-internal-guid-[^"]*"[^>]*>([^<]*(?:<(?!span)[^<]*)*)<\/span>/gi, '$1');
    } while (cleaned !== prevHtml);

    // 2. Remover tags <font> (mÃºltiplas passadas para aninhados)
    do {
      prevHtml = cleaned;
      cleaned = cleaned.replace(/<font[^>]*>([^<]*(?:<(?!font)[^<]*)*)<\/font>/gi, '$1');
    } while (cleaned !== prevHtml);

    // 3. Converter font-weight: 700/bold para <strong> (sÃ³ spans sem spans internos)
    do {
      prevHtml = cleaned;
      cleaned = cleaned.replace(/<span\s+style="[^"]*font-weight:\s*(?:700|bold)[^"]*"[^>]*>([^<]*(?:<(?!span)[^<]*)*)<\/span>/gi, '<strong>$1</strong>');
    } while (cleaned !== prevHtml);

    // 4. Converter font-style: italic para <em>
    do {
      prevHtml = cleaned;
      cleaned = cleaned.replace(/<span\s+style="[^"]*font-style:\s*italic[^"]*"[^>]*>([^<]*(?:<(?!span)[^<]*)*)<\/span>/gi, '<em>$1</em>');
    } while (cleaned !== prevHtml);

    // 5. Remover spans com estilos desnecessÃ¡rios do Google Docs
    do {
      prevHtml = cleaned;
      cleaned = cleaned.replace(/<span\s+style="[^"]*(?:font-family|font-size|background-color|font-variant|vertical-align)[^"]*"[^>]*>([^<]*(?:<(?!span)[^<]*)*)<\/span>/gi, '$1');
    } while (cleaned !== prevHtml);

    // 6. Limpar <strong>/<em> vazios e mesclar adjacentes
    cleaned = cleaned.replace(/<strong>\s*<\/strong>/gi, '');
    cleaned = cleaned.replace(/<em>\s*<\/em>/gi, '');
    cleaned = cleaned.replace(/<\/strong>\s*<strong>/gi, '');
    cleaned = cleaned.replace(/<\/em>\s*<em>/gi, '');

    // Normalizar quebras de linha
    cleaned = cleaned.replace(/<br\s*\/?>/gi, '<br>');

    // v1.20.7: Remover atributos style/class de tags de formataÃ§Ã£o (Quill adiciona estilos inline)
    cleaned = cleaned.replace(/<(strong|em|b|i|u)(\s+[^>]*)>/gi, '<$1>');

    // Normalizar tags de formataÃ§Ã£o
    cleaned = cleaned.replace(/<strong>/gi, '<b>');
    cleaned = cleaned.replace(/<\/strong>/gi, '</b>');
    cleaned = cleaned.replace(/<em>/gi, '<i>');
    cleaned = cleaned.replace(/<\/em>/gi, '</i>');

    // Remover divs vazias e spans desnecessÃ¡rios
    cleaned = cleaned.replace(/<div><\/div>/gi, '');
    cleaned = cleaned.replace(/<span[^>]*>(.*?)<\/span>/gi, '$1');
    
    // Converter quebras de linha duplas em parÃ¡grafos
    cleaned = cleaned.replace(/(<br>\s*<br>)/gi, '</p><p>');
    
    // Se nÃ£o comeÃ§a com <p>, envolver em <p>
    if (!cleaned.trim().startsWith('<p') && !cleaned.trim().startsWith('<ul') && !cleaned.trim().startsWith('<ol') && !cleaned.trim().startsWith('<h')) {
      cleaned = '<p>' + cleaned + '</p>';
    }
    
    // Limpar parÃ¡grafos vazios
    cleaned = cleaned.replace(/<p><\/p>/gi, '');
    cleaned = cleaned.replace(/<p>\s*<\/p>/gi, '');

    // v1.36.5: Converter classes de alinhamento do Quill para inline styles
    // Quill gera: <p class="ql-align-center">
    // Google Docs precisa: <p style="text-align: center;">
    cleaned = cleaned.replace(
      /<(p|div|h[1-6])\s+class="ql-align-(center|right|justify)"([^>]*)>/gi,
      (match: string, tag: string, align: string, rest: string) => {
        // Se jÃ¡ tem style, adicionar text-align a ele
        if (rest.includes('style="')) {
          return `<${tag}${rest.replace('style="', `style="text-align: ${align}; `)}>`;
        }
        return `<${tag} style="text-align: ${align};"${rest}>`;
      }
    );

    // v1.36.7: Converter listas bullet do Quill para <ul>
    // Quill usa <ol> para ambos os tipos, diferenciando via data-list="bullet"|"ordered"
    // Google Docs nÃ£o entende data-list, entÃ£o converter para <ul>/<ol> corretos
    cleaned = cleaned.replace(
      /<ol>([\s\S]*?)<\/ol>/gi,
      (match: string, content: string) => {
        if (content.includes('data-list="bullet"')) {
          // Converter para <ul> e remover data-list
          const newContent = content.replace(/\s*data-list="bullet"/gi, '');
          return `<ul>${newContent}</ul>`;
        }
        // Manter como <ol> e remover data-list="ordered"
        const newContent = content.replace(/\s*data-list="ordered"/gi, '');
        return `<ol>${newContent}</ol>`;
      }
    );

    // v1.36.6: Converter classes de indentaÃ§Ã£o do Quill para inline styles
    // Quill gera: <p class="ql-indent-1"> ou <li class="ql-indent-2">
    // Google Docs precisa: <p style="margin-left: 3em;">
    cleaned = cleaned.replace(
      /<(p|li)([^>]*)\s+class="([^"]*ql-indent-(\d+)[^"]*)"([^>]*)>/gi,
      (match: string, tag: string, before: string, classes: string, level: string, after: string) => {
        const marginLeft = `${parseInt(level) * 3}em`;
        const newClasses = classes.replace(/ql-indent-\d+/g, '').trim();
        const classAttr = newClasses ? ` class="${newClasses}"` : '';
        // Verificar se jÃ¡ tem style
        const fullTag = before + after;
        if (fullTag.includes('style="')) {
          return `<${tag}${before}${classAttr}${after.replace('style="', `style="margin-left: ${marginLeft}; `)}>`;
        }
        return `<${tag}${before}${classAttr} style="margin-left: ${marginLeft};"${after}>`;
      }
    );

    // v1.36.7: Converter blockquote para estilo inline
    // Google Docs nÃ£o suporta border-left, usar margin-left + italic
    cleaned = cleaned.replace(
      /<blockquote(?![^>]*style=)>/gi,
      '<blockquote style="margin-left: 2em; font-style: italic; color: #666;">'
    );

    // Adicionar estilos inline em parÃ¡grafos, preservando alinhamento do usuÃ¡rio
    cleaned = cleaned.replace(
      /<p(?![^>]*style=)>/gi,
      `<p style="${EXPORT_STYLES.p}">`
    );
    cleaned = cleaned.replace(
      /<p\s+style="([^"]*)">/gi,
      (match: string, existingStyles: string) => {
        if (!existingStyles.includes('text-align')) {
          return `<p style="${existingStyles}; text-align: justify;">`;
        }
        return match; // Preserva o text-align definido pelo usuÃ¡rio (center, right, etc.)
      }
    );

    return cleaned.trim();
  };

  const confirmDeleteModel = (model: Model) => {
    modelLibrary.setModelToDelete(model);
    openModal('deleteModel');
  };

  const executeDeleteModel = async () => {
    if (!modelLibrary.modelToDelete) return;

    try {
      const modelId = modelLibrary.modelToDelete.id;
      const modelToDelete = modelLibrary.modelToDelete;
      modelLibrary.setModels(modelLibrary.models.filter(m => m.id !== modelId));
      // v1.34.0: Rastrear delete para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('delete', { ...modelToDelete, updatedAt: new Date().toISOString() });
      modelLibrary.setHasUnsavedChanges(true);
      // Remover das sugestÃµes tambÃ©m
      if (modelLibrary.suggestions?.length > 0) {
        modelLibrary.setSuggestions(modelLibrary.suggestions.filter(m => m.id !== modelId));
      }
      closeModal('deleteModel');
      modelLibrary.setModelToDelete(null);
    } catch (err) {
      setError('Erro ao excluir modelo: ' + (err as Error).message);
    }
  };

  const deleteAllModels = async () => {
    if (modelLibrary.deleteAllConfirmText !== 'EXCLUIR') {
      setError('Digite "EXCLUIR" para confirmar');
      return;
    }

    try {
      // v1.35.2: Rastrear cada modelo como delete para sync com servidor
      const modelsToDelete = [...modelLibrary.models];
      const now = new Date().toISOString();

      for (const model of modelsToDelete) {
        if (cloudSync?.trackChange) {
          cloudSync.trackChange('delete', { ...model, updatedAt: now });
        }
      }

      modelLibrary.setModels([]);
      modelLibrary.setHasUnsavedChanges(true);
      closeModal('deleteAllModels');
      modelLibrary.setDeleteAllConfirmText('');
    } catch (err) {
      setError('Erro ao excluir todos os modelos: ' + (err as Error).message);
    }
  };

  // v1.27.02: Gera embedding automaticamente se IA local estiver ativa
  // v1.33.7: Feedback visual ao duplicar modelo
  const duplicateModel = async (model: Model) => {
    try {
      showToast('â³ Duplicando modelo...', 'info');
      await new Promise(resolve => setTimeout(resolve, 50)); // yield para UI

      const modelId = generateModelId();
      const duplicatedModel: Model = {
        ...model,
        id: modelId,
        title: `${model.title} (CÃ³pia)`,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        embedding: undefined, // Limpar para regenerar com novo tÃ­tulo
        // v1.35.22: CÃ³pia Ã© modelo prÃ³prio, nÃ£o compartilhado
        isShared: false,
        ownerId: undefined,
        ownerEmail: undefined,
        sharedPermission: undefined,
      };

      // v1.27.02: Gerar novo embedding se IA local estiver ativa
      if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady) {
        await new Promise(resolve => setTimeout(resolve, 50));
        try {
          const stripHTML = (html: string) => {
            const div = document.createElement('div');
            div.innerHTML = html || '';
            return div.textContent || div.innerText || '';
          };
          const text = [duplicatedModel.title, duplicatedModel.keywords, stripHTML(duplicatedModel.content).slice(0, 2000)].filter(Boolean).join(' ');
          duplicatedModel.embedding = await AIModelService.getEmbedding(text, 'passage');
        } catch (err) {
          console.warn('[MODEL-EMBED] Erro ao gerar embedding:', err);
        }
      }

      modelLibrary.setModels(prev => [...prev, duplicatedModel]);
      // v1.34.0: Rastrear create para sync (duplicaÃ§Ã£o cria novo modelo)
      if (cloudSync?.trackChange) cloudSync.trackChange('create', duplicatedModel);
      modelLibrary.setHasUnsavedChanges(true);

      showToast('âœ… Modelo duplicado com sucesso!', 'success');
    } catch (err) {
      setError('Erro ao duplicar modelo: ' + (err as Error).message);
    }
  };

  // FunÃ§Ã£o para extrair modelo do texto de decisÃ£o
  const confirmExtractModel = () => {
    if (!editingTopic || !editorRef.current) {
      setError('Nenhum tÃ³pico em ediÃ§Ã£o');
      return;
    }

        const decisionText = editorRef.current.root ? editorRef.current.root.innerText : '';

    if (!decisionText || decisionText.trim().length < 100) {
      setError('Texto da decisÃ£o muito curto (mÃ­nimo 100 caracteres)');
      return;
    }

    // Mostrar modal de confirmaÃ§Ã£o
    openModal('extractModelConfirm');
  };

  // v1.13.2: Salvar como modelo (preserva texto 100%, sem usar IA)
  const saveAsModel = () => {
    if (!editingTopic || !editorRef.current) {
      setError('Nenhum tÃ³pico em ediÃ§Ã£o');
      return;
    }
    const htmlContent = editorRef.current.root ? sanitizeHTML(editorRef.current.root.innerHTML) : '';
    if (!htmlContent || htmlContent.replace(/<[^>]+>/g, '').trim().length < 50) {
      setError('Texto da decisÃ£o muito curto');
      return;
    }
    modelLibrary.setEditingModel(null);
    modelLibrary.setNewModel({
      title: editingTopic.title || '',
      content: htmlContent,
      keywords: '',
      category: editingTopic.category || ''
    });
    setActiveTab('models');
    openModal('modelForm');
    setTimeout(() => {
      if (modelEditorRef.current?.root) {
        modelEditorRef.current.root.innerHTML = htmlContent;
      }
    }, 100);
  };

  const extractModelFromDecisionText = async () => {
    closeModal('extractModelConfirm');
    if (!editorRef.current?.root || !editingTopic) {
      setError('Editor ou tÃ³pico nÃ£o disponÃ­vel');
      return;
    }
    modelLibrary.setExtractingModelFromDecision(true);
    setError('');

    const decisionText = editorRef.current.root.innerText || '';

    // ğŸš€ v1.8.2: Cache key baseado em texto + tÃ­tulo + categoria do tÃ³pico
    const cacheKey = `extractModel_${editingTopic.title}_${editingTopic.category}_${decisionText}`;

    // ğŸš€ v1.8.2: Verificar cache antes de chamar API
    const cachedModel = apiCache.get(cacheKey);
    if (cachedModel && typeof cachedModel === 'string') {
      try {
        const parsedResponse = JSON.parse(cachedModel);
        if (parsedResponse.modelos && Array.isArray(parsedResponse.modelos) && parsedResponse.modelos.length > 0) {
          const modelo = parsedResponse.modelos[0];
          modelLibrary.setNewModel({
            title: modelo.titulo,
            category: modelo.categoria,
            keywords: modelo.palavrasChave,
            content: modelo.conteudo
          });
          setError('');
        }
      } catch (err) {
        // Se falhar, continua com chamada API normal abaixo
      }
      modelLibrary.setExtractingModelFromDecision(false);
      return; // Retornar se cache funcionou
    }

    try {

      const analysisPrompt = `VocÃª Ã© um assistente jurÃ­dico especializado em criar modelos de decisÃ£o trabalhista GENÃ‰RICOS e REUTILIZÃVEIS.

TAREFA: Analise o texto de decisÃ£o judicial fornecido e transforme-o em UM MODELO GENÃ‰RICO e REUTILIZÃVEL.

âš ï¸ ATENÃ‡ÃƒO - REGRAS DE GENERALIZAÃ‡ÃƒO (MUITO IMPORTANTE):

1. **REMOVA informaÃ§Ãµes especÃ­ficas do caso concreto:**
   - âŒ NÃƒO use nomes de partes (ex: "JoÃ£o da Silva", "Empresa XYZ Ltda")
   - âŒ NÃƒO use valores monetÃ¡rios especÃ­ficos (ex: "R$ 5.000,00")
   - âŒ NÃƒO use datas especÃ­ficas (ex: "10/05/2023")
   - âŒ NÃƒO use nÃºmeros de processo
   - âŒ NÃƒO use endereÃ§os ou locais especÃ­ficos

2. **USE termos genÃ©ricos:**
   - âœ… "o reclamante", "a reclamada", "a empresa"
   - âœ… "o valor devido", "o montante apurado"
   - âœ… "o perÃ­odo trabalhado", "a data da rescisÃ£o"
   - âœ… "os documentos apresentados", "as provas dos autos"

3. **FOQUE na fundamentaÃ§Ã£o jurÃ­dica:**
   - ArgumentaÃ§Ã£o legal aplicÃ¡vel a casos similares
   - AnÃ¡lise de requisitos jurÃ­dicos genÃ©ricos
   - RaciocÃ­nio jurÃ­dico reproduzÃ­vel
   - ConclusÃµes adaptÃ¡veis a diferentes situaÃ§Ãµes

4. **MANTENHA a estrutura, o estilo e a qualidade textual:**
   - Preserve o tom e a formataÃ§Ã£o do texto original
   - Mantenha os parÃ¡grafos bem desenvolvidos e conectivos entre eles
   - Conserve a linha argumentativa fluida
   - Mantenha a coesÃ£o e progressÃ£o textual
   - NÃƒO fragmente em enumeraÃ§Ãµes excessivas
   - Mantenha redaÃ§Ã£o em prosa corrida quando o original estiver assim

ğŸš¨ PRESERVAÃ‡ÃƒO LITERAL DO TEXTO (CRÃTICO - EXTREMAMENTE IMPORTANTE):

Esta Ã© a regra MAIS IMPORTANTE de todas. Se vocÃª nÃ£o seguir isso, o modelo serÃ¡ INÃšTIL.

**O QUE VOCÃŠ DEVE FAZER:**
- Fazer APENAS substituiÃ§Ãµes literais de informaÃ§Ãµes especÃ­ficas por termos genÃ©ricos
- Funcionar como "CTRL+F â†’ SUBSTITUIR": encontrar nomes/valores/datas e trocar por genÃ©ricos
- PRESERVAR TODO O RESTO DO TEXTO EXATAMENTE COMO ESTÃ
- Manter a redaÃ§Ã£o, estrutura de frases, argumentaÃ§Ã£o, conectivos, tudo IDÃŠNTICO

**O QUE VOCÃŠ NÃƒO DEVE FAZER:**
- âŒ NÃƒO resuma o texto
- âŒ NÃƒO reescreva com suas prÃ³prias palavras
- âŒ NÃƒO simplifique a argumentaÃ§Ã£o
- âŒ NÃƒO altere a estrutura das frases
- âŒ NÃƒO mude conectivos ou expressÃµes jurÃ­dicas
- âŒ NÃƒO "melhore" ou "otimize" o texto original

**EXEMPLO DO QUE FAZER:**

âŒ ERRADO (resumindo/reescrevendo):
Texto original: "A pretensÃ£o autoral merece acolhimento. Com efeito, restou comprovado nos autos que o reclamante JoÃ£o da Silva laborou para a empresa Acme Ltda no perÃ­odo de 01/01/2020 a 31/12/2023, recebendo salÃ¡rio mensal de R$ 3.500,00. A jornada habitual era das 8h Ã s 18h, com uma hora de intervalo, conforme cartÃµes de ponto de fls. 45/89."

Modelo ERRADO: "A pretensÃ£o Ã© procedente. Ficou demonstrado que houve relaÃ§Ã£o de trabalho com jornada superior Ã  legal."

âœ… CORRETO (apenas substituindo dados especÃ­ficos):
Modelo CORRETO: "A pretensÃ£o autoral merece acolhimento. Com efeito, restou comprovado nos autos que o reclamante laborou para a reclamada no perÃ­odo trabalhado, recebendo o salÃ¡rio mensal contratado. A jornada habitual era das [horÃ¡rio de inÃ­cio] Ã s [horÃ¡rio de tÃ©rmino], com uma hora de intervalo, conforme cartÃµes de ponto dos autos."

**REGRA DE OURO:**
Se vocÃª nÃ£o tem certeza se deve alterar algo, NÃƒO ALTERE. Preserve o texto original.
Seu trabalho Ã© fazer "buscar e substituir" de dados especÃ­ficos, NÃƒO reescrever.

**CHECKLIST FINAL - VERIFIQUE ANTES DE RESPONDER:**
âœ“ Mantive a estrutura exata das frases do original?
âœ“ Mantive os mesmos conectivos (ademais, com efeito, nesse sentido, etc.)?
âœ“ Mantive a mesma argumentaÃ§Ã£o jurÃ­dica?
âœ“ Mantive a mesma ordem dos argumentos?
âœ“ Fiz APENAS substituiÃ§Ãµes de nomes, valores, datas por termos genÃ©ricos?
âœ“ O texto tem o mesmo tamanho/extensÃ£o do original (nÃ£o resumi)?

EXCLUSAO OBRIGATORIA DE MINI-RELATORIO (CRITICO):

Esta e uma das regras MAIS IMPORTANTES. Se voce incluir mini-relatorio, o modelo sera INUTIL.

PROIBIDO ABSOLUTAMENTE (exemplos do que NAO fazer):
- "O reclamante pleiteia..."
- "O reclamante postula..."
- "O reclamante alega..."
- "As reclamadas impugnaram..."
- "A reclamada sustenta..."
- "Trata-se de..."
- "Cuida-se de..."
- "O reclamante ajuizou..."
- Qualquer resumo das alegacoes das partes
- Qualquer descricao do que foi pedido ou contestado

CORRETO - Como DEVE comecar o modelo:
- "A configuracao de grupo economico..."
- "O reconhecimento do vinculo empregaticio..."
- "A concessao de horas extras..."
- "Para caracterizacao da jornada..."
- "A caracterizacao do dano moral..."
- Diretamente com ANALISE JURIDICA, FUNDAMENTOS LEGAIS, DOUTRINA, PRECEDENTES

âš ï¸ IMPORTANTE - PRESERVAÃ‡ÃƒO DE CITAÃ‡Ã•ES DOUTRINÃRIAS E JURISPRUDENCIAIS:

Esta regra e CRITICA para manter a qualidade e fundamentacao do modelo extraido.

O QUE PRESERVAR (MANTER INTEGRALMENTE):
âœ… Citacoes de autores (ex: "Segundo Mauricio Godinho Delgado...")
âœ… Citacoes de jurisprudencia (ex: "Conforme TST-AIRR-1234-56.2023...")
âœ… Sumulas (ex: "A Sumula 437 do TST estabelece...")
âœ… Orientacoes Jurisprudenciais (ex: "A OJ 415 da SDI-1 dispoe...")
âœ… Precedentes vinculantes (ex: "Nos termos do Tema 1046 do TST...")
âœ… Referencias doutrinarias completas (autor, obra, citacao)
âœ… Referencias jurisprudenciais completas (tribunal, numero, ementa)
âœ… Fundamentos teoricos e academicos

O QUE GENERALIZAR (SUBSTITUIR POR TERMOS GENERICOS):
ğŸ”„ Nomes de partes especificas â†’ "o reclamante", "a reclamada"
ğŸ”„ Valores monetarios especificos â†’ "[valor]", "quantia devida"
ğŸ”„ Datas especificas â†’ "periodo trabalhado", "data da rescisao"
ğŸ”„ Locais especificos â†’ "local de trabalho", "estabelecimento"
ğŸ”„ Documentos especificos do caso â†’ "prova documental", "laudo pericial"
ğŸ”„ Testemunhas especificas â†’ "prova testemunhal"

O QUE NUNCA FAZER:
âŒ NÃƒO remova citacoes de autores renomados
âŒ NÃƒO remova referencias a precedentes e jurisprudencia
âŒ NÃƒO remova fundamentacao teorica/doutrinaria
âŒ NÃƒO substitua nomes de doutrinadores por termos genericos
âŒ NÃƒO remova numeros de processos citados como precedentes

EXEMPLO CORRETO DE PRESERVAÃ‡ÃƒO:

ORIGINAL:
"A pretensao autoral merece acolhimento. Segundo Mauricio Godinho Delgado,
a configuracao de grupo economico exige demonstracao de direcao, controle
ou administracao comum (TST-AIRR-1234-56.2023.5.01.0000). No caso concreto,
a Empresa XYZ demonstrou..."

MODELO EXTRAÃDO (CORRETO):
"A pretensao autoral merece acolhimento. Segundo Mauricio Godinho Delgado,
a configuracao de grupo economico exige demonstracao de direcao, controle
ou administracao comum (TST-AIRR-1234-56.2023.5.01.0000). No caso concreto,
a reclamada demonstrou..."

âœ… Citacao de Godinho Delgado â†’ PRESERVADA
âœ… Precedente TST-AIRR â†’ PRESERVADO
ğŸ”„ "Empresa XYZ" â†’ "a reclamada" (generalizado)

REGRA DE OURO:
Se o primeiro paragrafo fala sobre "o que o reclamante pede" ou "o que as partes alegam", ESTA ERRADO.
O primeiro paragrafo DEVE comecar com analise juridica do instituto/direito discutido.

EXEMPLO COMPARATIVO:

ERRADO (tem mini-relatorio):
"O reclamante pleiteia a condenacao solidaria das reclamadas, sob a alegacao de que integram o mesmo grupo economico. As reclamadas impugnaram o pedido."

CORRETO (sem mini-relatorio):
"A configuracao de grupo economico trabalhista demanda a presenca dos requisitos previstos no artigo 2 paragrafo 2 da CLT..."

ACAO REQUERIDA:
Se o texto original da decisao tiver mini-relatorio no inicio, voce DEVE REMOVE-LO completamente antes de generalizar.
Identifique onde termina o mini-relatorio e onde comeca a fundamentacao. Mantenha APENAS a fundamentacao.

Voce entendeu? INICIE DIRETAMENTE NA ANALISE JURIDICA. ZERO mini-relatorio.

${AI_PROMPTS.estiloRedacao}

CONTEXTO DO TÃ“PICO ORIGINAL:
TÃ­tulo: ${editingTopic.title}
Categoria: ${editingTopic.category || 'NÃ£o especificada'}

Crie UM ÃšNICO modelo baseado neste texto, extraindo:
1. **TÃ­tulo**: Baseado no tÃ³pico atual, mas ajustado se necessÃ¡rio. IMPORTANTE: O titulo DEVE estar em LETRAS MAIUSCULAS. Exemplo: "GRUPO ECONOMICO - PROCEDENCIA"
2. **Categoria**: ${editingTopic.category || 'MÃ©rito'}
3. **Palavras-chave** (5 a 10 termos estratÃ©gicos):

   INCLUA:
   - âœ… Termos tÃ©cnicos jurÃ­dicos principais
   - âœ… SinÃ´nimos e variaÃ§Ãµes do tema
   - âœ… Palavras que um juiz digitaria na busca
   - âœ… Conceitos-chave relacionados
   - âœ… Artigos de lei relevantes (ex: "CLT art 59", "Lei 13467")

   EVITE:
   - âŒ Palavras muito genÃ©ricas ("direito", "trabalho", "lei", "justiÃ§a")
   - âŒ Verbos conjugados ("trabalhar", "receber", "pagar")
   - âŒ Artigos e preposiÃ§Ãµes (o, a, de, da, para)
   - âŒ Nomes prÃ³prios ou especÃ­ficos

4. **ConteÃºdo**: VersÃ£o GENÃ‰RICA do texto fornecido em HTML, com redaÃ§Ã£o fluida e coesa

FORMATO DE RESPOSTA - JSON vÃ¡lido:
{
  "modelos": [
    {
      "titulo": "${editingTopic.title}",
      "categoria": "${editingTopic.category || 'MÃ©rito'}",
      "palavrasChave": "palavra1, palavra2, palavra3",
      "conteudo": "<p>Modelo completo em HTML GENÃ‰RICO, com redaÃ§Ã£o fluida e coesa, sem mini-relatÃ³rio...</p>"
    }
  ]
}

TEXTO DA DECISÃƒO A GENERALIZAR:
${decisionText}`;

      // v1.21.26: Parametros para extracao/transformacao (moderado)
      const textResponse = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: analysisPrompt }]
      }], {
        maxTokens: 16000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.4,
        topP: 0.9,
        topK: 60
      });


      // Parse JSON
      const jsonMatch = textResponse.match(/\{[\s\S]*"modelos"[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error('Formato de resposta invÃ¡lido');
      }

      const parsed = JSON.parse(jsonMatch[0]);

      // ğŸš€ v1.8.2: Cachear resposta JSON parseada
      apiCache.set(cacheKey, jsonMatch[0]);

      if (!parsed.modelos || parsed.modelos.length === 0) {
        throw new Error('Nenhum modelo foi gerado');
      }

      // Preparar modelo para preview/ediÃ§Ã£o
      const extractedModel = parsed.modelos[0];
      const modelId = generateModelId();
      // Converter HTML para texto plano preservando quebras de linha
      const rawContent = extractedModel.conteudo || '';
      const plainContent = rawContent
        .replace(/<\/p>\s*<p>/gi, '\n')    // </p><p> â†’ quebra simples
        .replace(/<br\s*\/?>/gi, '\n')     // <br> â†’ quebra simples
        .replace(/<\/?(p|div)[^>]*>/gi, '') // remove tags de bloco
        .replace(/<[^>]*>/g, '')           // remove outras tags
        .replace(/&nbsp;/g, ' ')           // &nbsp; â†’ espaÃ§o
        .replace(/\n{2,}/g, '\n')          // mÃ¡x 1 quebra seguida
        .trim();
      const previewModel = {
        id: modelId,
        title: extractedModel.titulo || editingTopic.title,
        category: extractedModel.categoria || editingTopic.category || 'MÃ©rito',
        content: plainContent,
        keywords: extractedModel.palavrasChave || '',
        isFavorite: false,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      // Mostrar modal de preview/ediÃ§Ã£o ao invÃ©s de salvar diretamente
      modelLibrary.setExtractedModelPreview(previewModel);
      openModal('extractedModelPreview');


    } catch (err) {
      setError(`Erro ao extrair modelo: ${(err as Error).message}`);
    } finally {
      modelLibrary.setExtractingModelFromDecision(false);
    }
  };

  // ğŸ” v1.13.1: Executa salvamento de modelo extraÃ­do (chamado apÃ³s verificaÃ§Ã£o de similaridade)
  // v1.27.02: Gera embedding automaticamente se IA local estiver ativa
  const executeExtractedModelSave = async (modelData: Partial<Model> & { title: string; content: string; embedding?: number[] }, isReplace = false, replaceId: string | null = null) => {
    // Gerar embedding se modelo de busca estiver pronto E opÃ§Ã£o ativada
    if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady && !modelData.embedding) {
      await new Promise(resolve => setTimeout(resolve, 50));
      try {
        const stripHTML = (html: string) => {
          const div = document.createElement('div');
          div.innerHTML = html || '';
          return div.textContent || div.innerText || '';
        };
        const text = [modelData.title, modelData.keywords, stripHTML(modelData.content).slice(0, 2000)].filter(Boolean).join(' ');
        modelData.embedding = await AIModelService.getEmbedding(text, 'passage');
      } catch (err) {
        console.warn('[MODEL-EMBED] Erro ao gerar embedding:', err);
      }
    } else if (!aiIntegration.aiSettings.modelSemanticEnabled && modelData.embedding) {
      delete modelData.embedding;
    }

    if (isReplace && replaceId) {
      const updatedModel = { ...modelData, id: replaceId, updatedAt: new Date().toISOString() };
      const updated = modelLibrary.models.map(m => m.id === replaceId ? updatedModel : m);
      modelLibrary.setModels(updated);
      // v1.34.0: Rastrear update para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('update', updatedModel);
    } else {
      const newModel: Model = { ...modelData, id: crypto.randomUUID(), updatedAt: new Date().toISOString() } as Model;
      modelLibrary.setModels(prev => [...prev, newModel]);
      // v1.34.0: Rastrear create para sync
      if (cloudSync?.trackChange) cloudSync.trackChange('create', newModel);
    }
    modelLibrary.setHasUnsavedChanges(true);
    TFIDFSimilarity.invalidate();
    apiCache.invalidate('suggestions_');
    showToast(`âœ… Modelo "${modelData.title}" ${isReplace ? 'substituÃ­do' : 'salvo'} com sucesso!`, 'success');
    closeModal('extractedModelPreview');
    modelLibrary.setExtractedModelPreview(null);
  };

  // Salva o modelo extraÃ­do apÃ³s revisÃ£o/ediÃ§Ã£o pelo usuÃ¡rio
  const saveExtractedModel = () => {
    if (!modelLibrary.extractedModelPreview) {
      showToast('Nenhum modelo para salvar.', 'error');
      return;
    }

    // ğŸ” v1.13.1: Verificar similaridade com TF-IDF
    const previewAsModel: Model = {
      ...modelLibrary.extractedModelPreview,
      id: crypto.randomUUID(),
      updatedAt: new Date().toISOString()
    } as Model;
    const simResult = TFIDFSimilarity.findSimilar(previewAsModel, modelLibrary.models, 0.80);
    if (simResult.hasSimilar) {
      modelLibrary.setSimilarityWarning({
        newModel: previewAsModel,
        similarModel: simResult.similarModel,
        similarity: simResult.similarity,
        context: 'saveExtractedModel'
      });
      return;
    }

    executeExtractedModelSave(modelLibrary.extractedModelPreview);
  };

  // Cancela a criaÃ§Ã£o do modelo extraÃ­do
  const cancelExtractedModel = () => {
    closeModal('extractedModelPreview');
    modelLibrary.setExtractedModelPreview(null);
    showToast('CriaÃ§Ã£o de modelo cancelada.', 'info');
  };

  // Calcula arquivos pendentes no processamento em lote
  const getBulkPendingFilesCount = React.useCallback(() => {
    return modelLibrary.bulkFiles.length - modelLibrary.bulkProcessedFiles.length;
  }, [modelLibrary.bulkFiles.length, modelLibrary.bulkProcessedFiles.length]);

  // Handler para confirmar cancelamento em lote
  const handleConfirmBulkCancel = React.useCallback(() => {
    closeModal('confirmBulkCancel');

    if (modelLibrary.bulkCancelController) {
      modelLibrary.bulkCancelController.abort();

      // Fechar modal de processamento apÃ³s cancelar
      setTimeout(() => {
        closeModal('bulkModal');
        // Reset estados relacionados
        modelLibrary.setBulkProcessing(false);
        modelLibrary.setBulkCurrentBatch(0);
        // Limpar controller abortado para permitir novo processamento
        modelLibrary.setBulkCancelController(null);
      }, 100); // Pequeno delay para garantir que abort() seja processado
    }
  }, [closeModal, modelLibrary.bulkCancelController, modelLibrary.setBulkProcessing, modelLibrary.setBulkCurrentBatch, modelLibrary.setBulkCancelController]);

  // ğŸ” v1.14.1: FunÃ§Ã£o Ãºnica para processar fila de salvamento bulk
  // v1.20.2: Otimizado para evitar memory leak - usa mutaÃ§Ã£o direta nos arrays
  // v1.27.02: Gera embeddings automaticamente se IA local estiver ativa
  const processBulkSaveNext = async (queue: Array<{ title: string; content: string; keywords?: string | string[]; category?: string; embedding?: number[] }>, saved: Model[], skipped: number, replacements: Array<{ oldId: string; newModel: Model }>) => {
    if (queue.length === 0) {
      if (saved.length > 0 || replacements.length > 0) {
        // v1.27.02: Gerar embeddings para todos os modelos novos se IA local ativa E opÃ§Ã£o ativada
        if (aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady) {
          const stripHTML = (html: string) => {
            const div = document.createElement('div');
            div.innerHTML = html || '';
            return div.textContent || div.innerText || '';
          };
          for (const model of saved) {
            if (!model.embedding) {
              try {
                const text = [model.title, model.keywords, stripHTML(model.content).slice(0, 2000)].filter(Boolean).join(' ');
                model.embedding = await AIModelService.getEmbedding(text, 'passage');
              } catch (err) { /* ignore */ }
            }
          }
          for (const { newModel } of replacements) {
            if (!newModel.embedding) {
              try {
                const text = [newModel.title, newModel.keywords, stripHTML(newModel.content).slice(0, 2000)].filter(Boolean).join(' ');
                newModel.embedding = await AIModelService.getEmbedding(text, 'passage');
              } catch (err) { /* ignore */ }
            }
          }
        }

        let updatedModels = [...modelLibrary.models];
        const batchChanges: Array<{ operation: 'create' | 'update' | 'delete'; model: Partial<Model> & { id: string } }> = [];
        for (const { oldId, newModel } of replacements) {
          const replacedModel = { ...newModel, id: oldId, updatedAt: new Date().toISOString() };
          updatedModels = updatedModels.map(m => m.id === oldId ? replacedModel : m);
          // v1.35.23: Acumular para batch
          batchChanges.push({ operation: 'update', model: replacedModel });
        }
        modelLibrary.setModels([...updatedModels, ...saved]);
        // v1.35.23: Usar trackChangeBatch para bulk upload eficiente
        saved.forEach((model: Model) => batchChanges.push({ operation: 'create', model }));
        if (cloudSync?.trackChangeBatch && batchChanges.length > 0) {
          cloudSync.trackChangeBatch(batchChanges);
        }
        modelLibrary.setHasUnsavedChanges(true);
        TFIDFSimilarity.invalidate();
        apiCache.invalidate('suggestions_');
      }
      closeModal('bulkReview');
      closeModal('bulkModal');
      modelLibrary.resetBulkState();
      const total = saved.length + replacements.length;
      const msg = skipped > 0 ? `âœ… ${total} modelo(s) adicionado(s). ${skipped} ignorado(s).` : `âœ… ${total} modelo(s) adicionado(s) com sucesso!`;
      showToast(msg, 'success');
      return;
    }
    const [current, ...rest] = queue;
    // Criar Model com id para verificaÃ§Ã£o de similaridade e salvamento
    const currentModel: Model = { ...current, id: crypto.randomUUID(), updatedAt: new Date().toISOString() } as Model;
    const simResult = TFIDFSimilarity.findSimilar(currentModel, [...modelLibrary.models, ...saved], 0.80);
    if (simResult.hasSimilar) {
      modelLibrary.setSimilarityWarning({ context: 'saveBulkModel', newModel: currentModel, similarModel: simResult.similarModel, similarity: simResult.similarity, bulkQueue: rest, bulkSaved: saved, bulkSkipped: skipped, bulkReplacements: replacements });
    } else {
      // v1.20.2: MutaÃ§Ã£o direta para evitar cÃ³pias desnecessÃ¡rias em recursÃ£o
      saved.push(currentModel);
      await processBulkSaveNext(rest, saved, skipped, replacements);
    }
  };

  // ğŸ” v1.13.1: Handlers para SimilarityWarningModal
  const handleSimilarityCancel = () => {
    const w = modelLibrary.similarityWarning;
    if (w?.context === 'saveBulkModel') {
      modelLibrary.setSimilarityWarning(null);
      setTimeout(() => processBulkSaveNext(w.bulkQueue || [], w.bulkSaved || [], (w.bulkSkipped || 0) + 1, w.bulkReplacements || []), 0);
    } else {
      modelLibrary.setSimilarityWarning(null);
    }
  };
  // v1.33.3: Feedback visual "Salvando..." no modal de similaridade
  const handleSimilaritySaveNew = async () => {
    const w = modelLibrary.similarityWarning;
    if (!w) return;

    setSavingFromSimilarity(true);
    await new Promise(resolve => setTimeout(resolve, 50)); // yield para UI

    if (w.context === 'saveModel') await executeSaveModel(w.newModel);
    else if (w.context === 'saveExtractedModel') await executeExtractedModelSave(w.newModel);
    else if (w.context === 'saveAsNew') await executeSaveAsNew(w.newModel);
    else if (w.context === 'saveBulkModel') {
      setSavingFromSimilarity(false);
      modelLibrary.setSimilarityWarning(null);
      // v1.20.2: MutaÃ§Ã£o direta para evitar cÃ³pias
      const bulkSaved = w.bulkSaved || [];
      bulkSaved.push(w.newModel);
      setTimeout(() => processBulkSaveNext(w.bulkQueue || [], bulkSaved, w.bulkSkipped || 0, w.bulkReplacements || []), 0);
      return;
    }
    setSavingFromSimilarity(false);
    modelLibrary.setSimilarityWarning(null);
  };
  const handleSimilarityReplace = async () => {
    const w = modelLibrary.similarityWarning;
    if (!w) return;

    setSavingFromSimilarity(true);
    await new Promise(resolve => setTimeout(resolve, 50)); // yield para UI

    if (w.context === 'saveModel') await executeSaveModel(w.newModel, true, w.similarModel.id);
    else if (w.context === 'saveExtractedModel') await executeExtractedModelSave(w.newModel, true, w.similarModel.id);
    else if (w.context === 'saveAsNew') await executeSaveAsNew(w.newModel, true, w.similarModel.id);
    else if (w.context === 'saveBulkModel') {
      setSavingFromSimilarity(false);
      modelLibrary.setSimilarityWarning(null);
      // v1.20.2: MutaÃ§Ã£o direta para evitar cÃ³pias
      const bulkReplacements = w.bulkReplacements || [];
      bulkReplacements.push({ oldId: w.similarModel.id, newModel: w.newModel });
      setTimeout(() => processBulkSaveNext(w.bulkQueue || [], w.bulkSaved || [], w.bulkSkipped || 0, bulkReplacements), 0);
      return;
    }
    setSavingFromSimilarity(false);
    modelLibrary.setSimilarityWarning(null);
  };

  // ğŸš€ v1.8.2: Gera mÃºltiplos modelos a partir do conteÃºdo de um arquivo usando IA (COM CACHE)
  const generateModelsFromFileContent = async (textContent: string, fileName: string, abortSignal: AbortSignal | null = null) => {
    try {
      // Verificar cancelamento antes de comeÃ§ar
      if (abortSignal?.aborted) {
        throw new Error('Processamento cancelado pelo usuÃ¡rio');
      }

      // Validar texto
      if (!textContent || typeof textContent !== 'string' || textContent.trim().length < 50) {
        throw new Error('Texto muito curto ou invÃ¡lido para anÃ¡lise');
      }

      // ğŸš€ v1.8.2: Cache key baseado em fileName + textContent
      const cacheKey = `bulkModels_${fileName}_${textContent}`;

      // ğŸš€ v1.8.2: Verificar cache antes de chamar API
      const cachedModels = apiCache.get(cacheKey);
      if (cachedModels && typeof cachedModels === 'string') {
        return JSON.parse(cachedModels); // Retornar array de modelos cacheados
      }


      const textToAnalyze = textContent.trim();

      // Agora analisa o texto e gera modelos
      const analysisPrompt = `VocÃª Ã© um assistente jurÃ­dico especializado em criar modelos de decisÃ£o trabalhista GENÃ‰RICOS e REUTILIZÃVEIS.

TAREFA: Analise o documento jurÃ­dico fornecido e identifique TODOS os tÃ³picos/assuntos jurÃ­dicos distintos que podem se tornar modelos de decisÃ£o completos.

âš ï¸ ATENÃ‡ÃƒO - REGRAS DE GENERALIZAÃ‡ÃƒO (MUITO IMPORTANTE):

1. **REMOVA informaÃ§Ãµes especÃ­ficas do caso concreto:**
   - âŒ NÃƒO use nomes de partes (ex: "JoÃ£o da Silva", "Empresa XYZ Ltda")
   - âŒ NÃƒO use valores monetÃ¡rios especÃ­ficos (ex: "R$ 5.000,00")
   - âŒ NÃƒO use datas especÃ­ficas (ex: "10/05/2023")
   - âŒ NÃƒO use nÃºmeros de processo
   - âŒ NÃƒO use endereÃ§os ou locais especÃ­ficos

2. **USE termos genÃ©ricos:**
   - âœ… "o reclamante", "a reclamada", "a empresa"
   - âœ… "o valor devido", "o montante apurado"
   - âœ… "o perÃ­odo trabalhado", "a data da rescisÃ£o"
   - âœ… "os documentos apresentados", "as provas dos autos"

3. **FOQUE na fundamentaÃ§Ã£o jurÃ­dica:**
   - ArgumentaÃ§Ã£o legal aplicÃ¡vel a casos similares
   - AnÃ¡lise de requisitos jurÃ­dicos genÃ©ricos
   - RaciocÃ­nio jurÃ­dico reproduzÃ­vel
   - ConclusÃµes adaptÃ¡veis a diferentes situaÃ§Ãµes

4. **TRANSFORME em TEMPLATE:**
   - O modelo deve servir para QUALQUER caso do mesmo tipo
   - Um juiz deve poder copiar e adaptar facilmente
   - Evite referÃªncias muito especÃ­ficas ao caso original

ğŸš¨ PRESERVAÃ‡ÃƒO LITERAL DO TEXTO (CRÃTICO - EXTREMAMENTE IMPORTANTE):

Esta Ã© a regra MAIS IMPORTANTE de todas. Se vocÃª nÃ£o seguir isso, o modelo serÃ¡ INÃšTIL.

**O QUE VOCÃŠ DEVE FAZER:**
- Fazer APENAS substituiÃ§Ãµes literais de informaÃ§Ãµes especÃ­ficas por termos genÃ©ricos
- Funcionar como "CTRL+F â†’ SUBSTITUIR": encontrar nomes/valores/datas e trocar por genÃ©ricos
- PRESERVAR TODO O RESTO DO TEXTO EXATAMENTE COMO ESTÃ
- Manter a redaÃ§Ã£o, estrutura de frases, argumentaÃ§Ã£o, conectivos, tudo IDÃŠNTICO

**O QUE VOCÃŠ NÃƒO DEVE FAZER:**
- âŒ NÃƒO resuma o texto
- âŒ NÃƒO reescreva com suas prÃ³prias palavras
- âŒ NÃƒO simplifique a argumentaÃ§Ã£o
- âŒ NÃƒO altere a estrutura das frases
- âŒ NÃƒO mude conectivos ou expressÃµes jurÃ­dicas
- âŒ NÃƒO "melhore" ou "otimize" o texto original

**EXEMPLO DO QUE FAZER:**

âŒ ERRADO (resumindo/reescrevendo):
Texto original: "A pretensÃ£o autoral merece acolhimento. Com efeito, restou comprovado nos autos que o reclamante JoÃ£o da Silva laborou para a empresa Acme Ltda no perÃ­odo de 01/01/2020 a 31/12/2023, recebendo salÃ¡rio mensal de R$ 3.500,00. A jornada habitual era das 8h Ã s 18h, com uma hora de intervalo, conforme cartÃµes de ponto de fls. 45/89."

Modelo ERRADO: "A pretensÃ£o Ã© procedente. Ficou demonstrado que houve relaÃ§Ã£o de trabalho com jornada superior Ã  legal."

âœ… CORRETO (apenas substituindo dados especÃ­ficos):
Modelo CORRETO: "A pretensÃ£o autoral merece acolhimento. Com efeito, restou comprovado nos autos que o reclamante laborou para a reclamada no perÃ­odo trabalhado, recebendo o salÃ¡rio mensal contratado. A jornada habitual era das [horÃ¡rio de inÃ­cio] Ã s [horÃ¡rio de tÃ©rmino], com uma hora de intervalo, conforme cartÃµes de ponto dos autos."

**REGRA DE OURO:**
Se vocÃª nÃ£o tem certeza se deve alterar algo, NÃƒO ALTERE. Preserve o texto original.
Seu trabalho Ã© fazer "buscar e substituir" de dados especÃ­ficos, NÃƒO reescrever.

**CHECKLIST FINAL - VERIFIQUE ANTES DE RESPONDER:**
âœ“ Mantive a estrutura exata das frases do original?
âœ“ Mantive os mesmos conectivos (ademais, com efeito, nesse sentido, etc.)?
âœ“ Mantive a mesma argumentaÃ§Ã£o jurÃ­dica?
âœ“ Mantive a mesma ordem dos argumentos?
âœ“ Fiz APENAS substituiÃ§Ãµes de nomes, valores, datas por termos genÃ©ricos?
âœ“ O texto tem o mesmo tamanho/extensÃ£o do original (nÃ£o resumi)?

EXCLUSAO OBRIGATORIA DE MINI-RELATORIO (CRITICO):

Esta e uma das regras MAIS IMPORTANTES. Se voce incluir mini-relatorio, o modelo sera INUTIL.

PROIBIDO ABSOLUTAMENTE (exemplos do que NAO fazer):
- "O reclamante pleiteia..."
- "O reclamante postula..."
- "O reclamante alega..."
- "As reclamadas impugnaram..."
- "A reclamada sustenta..."
- "Trata-se de..."
- "Cuida-se de..."
- "O reclamante ajuizou..."
- Qualquer resumo das alegacoes das partes
- Qualquer descricao do que foi pedido ou contestado

CORRETO - Como DEVE comecar o modelo:
- "A configuracao de grupo economico..."
- "O reconhecimento do vinculo empregaticio..."
- "A concessao de horas extras..."
- "Para caracterizacao da jornada..."
- "A caracterizacao do dano moral..."
- Diretamente com ANALISE JURIDICA, FUNDAMENTOS LEGAIS, DOUTRINA, PRECEDENTES

âš ï¸ IMPORTANTE - PRESERVAÃ‡ÃƒO DE CITAÃ‡Ã•ES DOUTRINÃRIAS E JURISPRUDENCIAIS:

Esta regra e CRITICA para manter a qualidade e fundamentacao do modelo extraido.

O QUE PRESERVAR (MANTER INTEGRALMENTE):
âœ… Citacoes de autores (ex: "Segundo Mauricio Godinho Delgado...")
âœ… Citacoes de jurisprudencia (ex: "Conforme TST-AIRR-1234-56.2023...")
âœ… Sumulas (ex: "A Sumula 437 do TST estabelece...")
âœ… Orientacoes Jurisprudenciais (ex: "A OJ 415 da SDI-1 dispoe...")
âœ… Precedentes vinculantes (ex: "Nos termos do Tema 1046 do TST...")
âœ… Referencias doutrinarias completas (autor, obra, citacao)
âœ… Referencias jurisprudenciais completas (tribunal, numero, ementa)
âœ… Fundamentos teoricos e academicos

O QUE GENERALIZAR (SUBSTITUIR POR TERMOS GENERICOS):
ğŸ”„ Nomes de partes especificas â†’ "o reclamante", "a reclamada"
ğŸ”„ Valores monetarios especificos â†’ "[valor]", "quantia devida"
ğŸ”„ Datas especificas â†’ "periodo trabalhado", "data da rescisao"
ğŸ”„ Locais especificos â†’ "local de trabalho", "estabelecimento"
ğŸ”„ Documentos especificos do caso â†’ "prova documental", "laudo pericial"
ğŸ”„ Testemunhas especificas â†’ "prova testemunhal"

O QUE NUNCA FAZER:
âŒ NÃƒO remova citacoes de autores renomados
âŒ NÃƒO remova referencias a precedentes e jurisprudencia
âŒ NÃƒO remova fundamentacao teorica/doutrinaria
âŒ NÃƒO substitua nomes de doutrinadores por termos genericos
âŒ NÃƒO remova numeros de processos citados como precedentes

EXEMPLO CORRETO DE PRESERVAÃ‡ÃƒO:

ORIGINAL:
"A pretensao autoral merece acolhimento. Segundo Mauricio Godinho Delgado,
a configuracao de grupo economico exige demonstracao de direcao, controle
ou administracao comum (TST-AIRR-1234-56.2023.5.01.0000). No caso concreto,
a Empresa XYZ demonstrou..."

MODELO EXTRAÃDO (CORRETO):
"A pretensao autoral merece acolhimento. Segundo Mauricio Godinho Delgado,
a configuracao de grupo economico exige demonstracao de direcao, controle
ou administracao comum (TST-AIRR-1234-56.2023.5.01.0000). No caso concreto,
a reclamada demonstrou..."

âœ… Citacao de Godinho Delgado â†’ PRESERVADA
âœ… Precedente TST-AIRR â†’ PRESERVADO
ğŸ”„ "Empresa XYZ" â†’ "a reclamada" (generalizado)

REGRA DE OURO:
Se o primeiro paragrafo fala sobre "o que o reclamante pede" ou "o que as partes alegam", ESTA ERRADO.
O primeiro paragrafo DEVE comecar com analise juridica do instituto/direito discutido.

EXEMPLO COMPARATIVO:

ERRADO (tem mini-relatorio):
"O reclamante pleiteia a condenacao solidaria das reclamadas, sob a alegacao de que integram o mesmo grupo economico. As reclamadas impugnaram o pedido."

CORRETO (sem mini-relatorio):
"A configuracao de grupo economico trabalhista demanda a presenca dos requisitos previstos no artigo 2 paragrafo 2 da CLT..."

ACAO REQUERIDA:
Se o texto original da decisao tiver mini-relatorio no inicio, voce DEVE REMOVE-LO completamente antes de generalizar.
Identifique onde termina o mini-relatorio e onde comeca a fundamentacao. Mantenha APENAS a fundamentacao.

Voce entendeu? INICIE DIRETAMENTE NA ANALISE JURIDICA. ZERO mini-relatorio.

${AI_PROMPTS.estiloRedacao}

A redaÃ§Ã£o do modelo deve ser de EXCELENTE QUALIDADE, seguindo rigorosamente estes critÃ©rios.

IMPORTANTE:
- Um documento pode conter 1, 2, 3 ou mais tÃ³picos diferentes
- Cada tÃ³pico deve ser tratado independentemente
- Crie modelos ROBUSTOS, COMPLETOS e PRONTOS PARA REUTILIZAÃ‡ÃƒO
- Os modelos devem seguir o estilo de um juiz do trabalho experiente e didÃ¡tico
- Use linguagem formal, mas acessÃ­vel e agradÃ¡vel de ler
- Fundamente em bases legais, doutrina e jurisprudÃªncia
- GENERALIZE apenas dados do caso concreto (nomes, valores, datas)
- PRESERVE citaÃ§Ãµes doutrinÃ¡rias, precedentes e jurisprudÃªncia integralmente

Para CADA tÃ³pico identificado, crie:
1. **TÃ­tulo**: Claro e objetivo. IMPORTANTE: O titulo DEVE estar em LETRAS MAIUSCULAS. Exemplos: "HORAS EXTRAS - PROCEDENCIA", "GRUPO ECONOMICO - IMPROCEDENCIA"
2. **Categoria**: ClassificaÃ§Ã£o jurÃ­dica precisa (ex: "Verbas RescisÃ³rias", "Jornada de Trabalho", "Preliminares", "Estabilidade")

3. **Palavras-chave** (5 a 10 termos estratÃ©gicos):

   INCLUA:
   - âœ… Termos tÃ©cnicos jurÃ­dicos principais
   - âœ… SinÃ´nimos e variaÃ§Ãµes do tema
   - âœ… Palavras que um juiz digitaria na busca
   - âœ… Conceitos-chave relacionados
   - âœ… Artigos de lei relevantes (ex: "CLT art 59", "Lei 13467")

   EVITE:
   - âŒ Palavras muito genÃ©ricas ("direito", "trabalho", "lei", "justiÃ§a")
   - âŒ Verbos conjugados ("trabalhar", "receber", "pagar")
   - âŒ Artigos e preposiÃ§Ãµes (o, a, de, da, para)
   - âŒ Nomes prÃ³prios ou especÃ­ficos

   EXEMPLOS:
   âŒ Ruins: "direito, trabalho, empregado, salÃ¡rio, lei"
   âœ… Bons: "horas extras, sobrejornada, adicional hora extra, banco de horas, controle jornada, CLT art 59, 7Âº inciso XVI, prova horÃ¡rio"

4. **ConteÃºdo**: Modelo de decisÃ£o GENÃ‰RICO em formato HTML com REDAÃ‡ÃƒO FLUIDA, COESA E CONTÃNUA:
   - INICIE DIRETAMENTE na anÃ¡lise jurÃ­dica (SEM mini-relatÃ³rio)
   - AnÃ¡lise fundamentada em prosa corrida (SEM enumeraÃ§Ãµes ou tÃ­tulos)
   - Use conectores textuais entre parÃ¡grafos
   - Base legal pertinente integrada ao texto
   - ConclusÃ£o clara e adaptÃ¡vel
   - FormataÃ§Ã£o com <p>, <strong>, <em>, etc.
   - Texto agradÃ¡vel, didÃ¡tico e bem articulado

EXEMPLO DE GENERALIZAÃ‡ÃƒO:

âŒ ERRADO (especÃ­fico demais):
"JoÃ£o da Silva trabalhou para a Empresa ABC Ltda de 01/01/2020 a 31/12/2022, fazendo jus a R$ 15.000,00 de horas extras conforme planilha de fls. 45."

âœ… CORRETO (genÃ©rico e reutilizÃ¡vel):
"O reclamante comprovou o labor em sobrejornada durante o perÃ­odo contratual, fazendo jus ao pagamento das horas extras apuradas em liquidaÃ§Ã£o de sentenÃ§a, conforme documentaÃ§Ã£o apresentada nos autos."

FORMATO DE RESPOSTA - JSON valido:

IMPORTANTE: Retorne APENAS JSON puro. Nada de texto antes ou depois.

Sua resposta deve comecar com { e terminar com }

Use aspas duplas para strings.
Escape caracteres especiais corretamente.
Sem virgulas sobrando no ultimo elemento.

{
  "modelos": [
    {
      "titulo": "TITULO EM MAIUSCULAS - RESULTADO",
      "categoria": "Categoria Juridica",
      "palavrasChave": "palavra1, palavra2, palavra3",
      "conteudo": "<p>Modelo em HTML.</p><p>Tudo em uma string.</p>"
    }
  ]
}

LEMBRE-SE: O titulo DEVE estar em MAIUSCULAS!

DOCUMENTO A ANALISAR:
${textToAnalyze}`;


      // v1.21.26: Parametros para extracao bulk (moderado)
      const aiResponseText = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: analysisPrompt }]
      }], {
        maxTokens: 8000,
        useInstructions: true,
        timeout: 180000,  // 3 minutos (anÃ¡lise pode ser mais demorada)
        abortSignal: abortSignal || undefined,  // Signal externo para cancelamento do usuÃ¡rio
        logMetrics: true,
        temperature: 0.3,
        topP: 0.9,
        topK: 50
      });

      // Parse do JSON retornado
      const cleanText = aiResponseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      const parsed = JSON.parse(cleanText);

      if (!parsed.modelos || !Array.isArray(parsed.modelos) || parsed.modelos.length === 0) {
        throw new Error('Nenhum modelo identificado no documento');
      }

      // Formata os modelos
      const modelos = parsed.modelos.map((m: { titulo?: string; categoria?: string; palavrasChave?: string; conteudo?: string }, idx: number) => ({
        id: `bulk-${Date.now()}-${idx}`,
        title: m.titulo || `Modelo ${idx + 1}`,
        category: m.categoria || 'Sem categoria',
        keywords: m.palavrasChave || '',
        content: m.conteudo || '<p>ConteÃºdo nÃ£o gerado</p>',
        sourceFile: fileName,
        createdAt: new Date().toISOString(),
        isFavorite: false
      }));

      // ğŸš€ v1.8.2: Cachear modelos gerados
      apiCache.set(cacheKey, JSON.stringify(modelos));

      return modelos;

    } catch (err) {
      throw err;
    }
  };

  const callWithRetry = async <T,>(fn: () => Promise<T>, maxRetries = 3, fileName = '', abortSignal: AbortSignal | null = null, timeoutMs = 180000): Promise<T> => {
    const TIMEOUT_MS = timeoutMs; // Default: 3 min, pode ser aumentado para "Todos"

    for (let attempt = 0; attempt < maxRetries; attempt++) {
      // Verificar se foi cancelado ANTES de tentar
      if (abortSignal?.aborted) {
        throw new Error('Processamento cancelado pelo usuÃ¡rio');
      }

      try {
        // Adicionar timeout para evitar requisiÃ§Ãµes que travam
        const timeoutPromise = new Promise<never>((_, reject) =>
          setTimeout(() => reject(new Error(`Timeout: API nÃ£o respondeu em ${Math.round(TIMEOUT_MS/1000)}s`)), TIMEOUT_MS)
        );
        return await Promise.race([fn(), timeoutPromise]);
      } catch (err) {
        const errWithStatus = err as Error & { status?: number };
        const isRetryable = errWithStatus.message?.includes('Timeout') || errWithStatus.status === 429 || errWithStatus.status === 529 || errWithStatus.status === 520 || errWithStatus.status === 502 || errWithStatus.message?.includes('rate limit') || errWithStatus.message?.includes('429') || errWithStatus.message?.includes('529') || errWithStatus.message?.includes('520') || errWithStatus.message?.includes('502') || errWithStatus.message?.includes('Overloaded') || errWithStatus.message?.includes('Failed to fetch') || errWithStatus.message?.includes('parsear resposta');
        const isLastAttempt = attempt === maxRetries - 1;
        const attemptNum = attempt + 1;

        // Log de erro para debug
        console.warn(`[callWithRetry] âŒ Erro na tentativa ${attemptNum}/${maxRetries}${fileName ? ` (${fileName})` : ''}:`, (err as Error).message || err);

        if (isRetryable) {
          if (!isLastAttempt) {
            // Delay maior para 429: 4s, 8s, 16s (mais agressivo que erros normais)
            const delay = Math.pow(2, attempt + 2) * 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            // Verificar se foi cancelado DEPOIS do delay
            if (abortSignal?.aborted) {
              throw new Error('Processamento cancelado pelo usuÃ¡rio');
            }
            continue;
          } else {
            console.error(`[callWithRetry] ğŸ’€ FALHA FINAL: Todas as ${maxRetries} tentativas esgotadas${fileName ? ` (${fileName})` : ''}`);
            // Mensagem especÃ­fica para rate limit esgotado
            throw new Error(`Rate limit excedido apÃ³s ${maxRetries} tentativas. O sistema de lotes estÃ¡ ativo, mas a API ainda atingiu o limite. Aguarde alguns minutos antes de tentar novamente.`);
          }
        }

        // NÃ£o Ã© rate limit - propagar erro original
        console.error(`[callWithRetry] âš ï¸ Erro nÃ£o-retryable${fileName ? ` (${fileName})` : ''}:`, (err as Error).message || err);
        throw err;
      }
    }
    // TypeScript: se o loop terminar sem retorno, lanÃ§ar erro
    throw new Error(`Todas as ${maxRetries} tentativas falharam`);
  };

  const processFileWithProgress = async (file: File, index: number, abortSignal: AbortSignal | null) => {
    const startTime = Date.now();

    try {
      // Verificar cancelamento antes de iniciar
      if (abortSignal?.aborted) {
        throw new Error('Processamento cancelado pelo usuÃ¡rio');
      }

      // PASSO 1: Extrair texto (local, rÃ¡pido)
      const textContent = await documentServices.extractTextFromBulkFile(file);

      // Verificar cancelamento apÃ³s extraÃ§Ã£o
      if (abortSignal?.aborted) {
        throw new Error('Processamento cancelado pelo usuÃ¡rio');
      }

      // PASSO 2: Gerar modelos com IA (API call com retry)
      const models = await callWithRetry(
        () => generateModelsFromFileContent(textContent, file.name, abortSignal),
        3, // maxRetries
        file.name,
        abortSignal // Passar signal para retry logic
      );

      const duration = ((Date.now() - startTime) / 1000).toFixed(1);

      return {
        file: file.name,
        status: 'success',
        modelsCount: models.length,
        models,
        duration
      };

    } catch (err) {
      const duration = ((Date.now() - startTime) / 1000).toFixed(1);

      return {
        file: file.name,
        status: 'error',
        error: (err as Error).message,
        duration
      };
    }
  };

  // v1.33.11: Usar valor configurÃ¡vel de requisiÃ§Ãµes paralelas
  const BULK_BATCH_SIZE = aiIntegration.aiSettings.parallelRequests || 5;
  const INTER_BATCH_DELAY = 3000; // 3s entre batches

  const processBulkFiles = async () => {
    if (modelLibrary.bulkFiles.length === 0) return;

    try {
      modelLibrary.setBulkProcessing(true);
      modelLibrary.setBulkProcessedFiles([]);
      modelLibrary.setBulkGeneratedModels([]);
      modelLibrary.setBulkErrors([]);

      if (modelLibrary.bulkCancelController) {
        modelLibrary.setBulkCancelController(null);
      }

      // Criar AbortController NOVO para este processamento
      const cancelController = new AbortController();
      modelLibrary.setBulkCancelController(cancelController);

      // Processar em batches para evitar rate limit 429
      const allResults: PromiseSettledResult<{ file: string; status: string; modelsCount?: number; models?: Model[]; error?: string; duration: string }>[] = [];
      const processedFiles: Array<{ file: string; status: string; modelsCount?: number; models?: Model[]; error?: string; duration: string }> = [];
      const generatedModels: Model[] = [];
      const errors: Array<{ file: string; status: string; error?: string; duration: string }> = [];

      for (let i = 0; i < modelLibrary.bulkFiles.length; i += BULK_BATCH_SIZE) {
        const batch = modelLibrary.bulkFiles.slice(i, i + BULK_BATCH_SIZE);
        const batchNumber = Math.floor(i / BULK_BATCH_SIZE) + 1;
        const totalBatches = Math.ceil(modelLibrary.bulkFiles.length / BULK_BATCH_SIZE);

        modelLibrary.setBulkCurrentBatch(batchNumber);

        // Criar promises para este batch
        const promises = batch.map((bulkFile, batchIndex) => {
          const globalIndex = i + batchIndex;
          const startDelay = batchIndex * modelLibrary.bulkStaggerDelay;

          return new Promise(resolve => setTimeout(resolve, startDelay))
            .then(() => processFileWithProgress(bulkFile.file, globalIndex, cancelController.signal));
        });

        // Aguardar batch atual
        const batchResults = await Promise.allSettled(promises);
        allResults.push(...batchResults);

        // Processar resultados deste batch em tempo real
        batchResults.forEach(result => {
          if (result.status === 'fulfilled' && result.value.status === 'success') {
            processedFiles.push(result.value);
            generatedModels.push(...result.value.models);
          } else {
            const errorData = result.status === 'rejected' ? result.reason : result.value;
            processedFiles.push(errorData);
            errors.push(errorData);
          }
        });

        // Atualizar UI em tempo real apÃ³s cada batch
        modelLibrary.setBulkProcessedFiles([...processedFiles]);
        modelLibrary.setBulkGeneratedModels([...generatedModels]);
        modelLibrary.setBulkErrors([...errors]);

        // Delay entre batches (exceto no Ãºltimo)
        if (i + BULK_BATCH_SIZE < modelLibrary.bulkFiles.length) {
          await new Promise(resolve => setTimeout(resolve, INTER_BATCH_DELAY));

          // Verificar se foi cancelado durante o delay
          if (cancelController.signal.aborted) {
            break; // Interrompe o loop de batches
          }
        }
      }

      // Atualizar estados finais
      modelLibrary.setBulkProcessedFiles(processedFiles);
      modelLibrary.setBulkGeneratedModels(generatedModels);
      modelLibrary.setBulkErrors(errors);

      // ğŸ” v1.14.1: PrÃ©-calcular similaridade para cada modelo gerado
      const modelsWithSimilarity = generatedModels.map(model => {
        const simResult = TFIDFSimilarity.findSimilar(model, modelLibrary.models, 0.80);
        if (simResult.hasSimilar) {
          return { ...model, similarityInfo: { similarity: simResult.similarity, similarModel: simResult.similarModel } };
        }
        return model;
      });
      modelLibrary.setBulkReviewModels(modelsWithSimilarity);

      // Limpar controller e resetar batch
      modelLibrary.setBulkCancelController(null);
      modelLibrary.setBulkCurrentBatch(0);

      // Abrir modal de revisÃ£o
      openModal('bulkReview');

    } catch (err) {
      setError((err as Error).message);
    } finally {
      modelLibrary.setBulkProcessing(false);
    }
  };

  // ğŸš€ v1.8.3: Handler para upload de arquivos (MEMOIZADO)
  const handleBulkFileUpload = React.useCallback((event: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(event.target.files || []);

    if (files.length === 0) return;

    if (files.length > 20) {
      showToast('âš ï¸ Limite mÃ¡ximo de 20 arquivos por lote. Por favor, selecione menos arquivos.', 'error');
      return;
    }

    // Validar tipos de arquivo - PDF, TXT, DOCX, DOC
    const validExtensions = ['.pdf', '.txt', '.docx', '.doc'];
    const validTypes = [
      'application/pdf',
      'text/plain',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/msword'
    ];

    const invalidFiles = files.filter(f => {
      const ext = '.' + (f.name.split('.').pop() || '').toLowerCase();
      return !validExtensions.includes(ext) && !validTypes.includes(f.type);
    });

    if (invalidFiles.length > 0) {
      showToast(`âš ï¸ Arquivos invÃ¡lidos detectados:\n${invalidFiles.map(f => f.name).join('\n')}\n\nâœ… Tipos suportados: PDF, DOCX, DOC, TXT`, 'error');
      return;
    }

    const bulkFilesData = files.map(file => ({ file, name: file.name, size: file.size }));
    modelLibrary.setBulkFiles(bulkFilesData);
  }, [showToast, modelLibrary.setBulkFiles]); // ğŸš€ v1.8.3: Memoizado (GRUPO C)

  // ğŸ” v1.14.1: Salva modelos revisados com verificaÃ§Ã£o de similaridade interativa
  const saveBulkModels = () => {
    if (modelLibrary.bulkReviewModels.length === 0) {
      showToast('Nenhum modelo para salvar.', 'error');
      return;
    }
    processBulkSaveNext([...modelLibrary.bulkReviewModels], [], 0, []);
  };

  // Remove modelo da revisÃ£o
  const removeBulkReviewModel = (modelId: string) => {
    const updated = modelLibrary.bulkReviewModels.filter(m => m.id !== modelId);
    modelLibrary.setBulkReviewModels(updated);
  };

  const toggleFavorite = async (modelId: string) => {
    try {
      let updatedModel: Model | null = null;
      const updated = modelLibrary.models.map((m: Model) => {
        if (m.id === modelId) {
          updatedModel = { ...m, favorite: !m.favorite, updatedAt: new Date().toISOString() };
          return updatedModel;
        }
        return m;
      });
      modelLibrary.setModels(updated);
      // v1.34.0: Rastrear update para sync
      if (cloudSync?.trackChange && updatedModel) cloudSync.trackChange('update', updatedModel);
      modelLibrary.setHasUnsavedChanges(true);
      // Atualizar sugestÃµes se modelo estiver nelas
      if (updatedModel && modelLibrary.suggestions?.length > 0) {
        const finalUpdatedModel = updatedModel; // TypeScript narrowing helper
        modelLibrary.setSuggestions(modelLibrary.suggestions.map(m => m.id === modelId ? finalUpdatedModel : m));
      }
      // Atualizar preview se modelo estiver aberto
      if (updatedModel && modelPreview.previewingModel?.id === modelId) {
        modelPreview.openPreview(updatedModel);
      }
    } catch (err) {
      setError('Erro ao favoritar modelo: ' + (err as Error).message);
    }
  };



  // ğŸ“„ FUNÃ‡Ã•ES: AnÃ¡lise de Documentos

  // v1.17.0: Wrapper que mostra modal de nomes antes de analisar
  const handleAnalyzeDocuments = () => {
    if (peticaoFiles.length === 0 && pastedPeticaoTexts.length === 0) {
      setError('Por favor, faÃ§a upload da petiÃ§Ã£o inicial ou cole o texto');
      return;
    }

    const anonConfig = aiIntegration.aiSettings?.anonymization;
    if (anonConfig?.enabled) {
      // Mostrar modal para inserir nomes
      setShowAnonymizationModal(true);
    } else {
      // Analisar diretamente sem anonimizaÃ§Ã£o de nomes
      analyzeDocuments([]);
    }
  };

  // Callback quando usuÃ¡rio confirma nomes no modal
  // v1.21.3: Persistir nomes para reutilizaÃ§Ã£o em provas e prÃ³ximas anÃ¡lises
  const handleAnonymizationConfirm = (nomes: string[]) => {
    aiIntegration.setAiSettings(prev => ({
      ...prev,
      anonymization: {
        ...prev.anonymization,
        nomesUsuario: nomes
      }
    }));
    setShowAnonymizationModal(false);
    analyzeDocuments(nomes);
  };

  const analyzeDocuments = async (nomesParaAnonimizar: string[] = []) => {

    if (peticaoFiles.length === 0 && pastedPeticaoTexts.length === 0) {
      setError('Por favor, faÃ§a upload da petiÃ§Ã£o inicial ou cole o texto');
      return;
    }

    setAnalyzing(true);
    openModal('analysis');
    setError('');
    await new Promise(resolve => setTimeout(resolve, 100)); // Aguardar modal abrir

    try {
      // ğŸ†• v1.12.18: Processamento por modo individual (nÃ£o mais global)
      // Cada documento Ã© processado conforme seu modo em documentProcessingModes

      type ExtractedTextItem = { id: string; text: string; name: string };
      type ContentArrayItem = { type: 'text' | 'document'; text?: string; source?: { type: 'base64'; media_type: 'application/pdf'; data: string }; cache_control?: { type: 'ephemeral' } };
      let contentArray: ContentArrayItem[] = [];
      let extractedTextsData: { peticoes: ExtractedTextItem[]; contestacoes: ExtractedTextItem[]; complementares: ExtractedTextItem[] } = { peticoes: [], contestacoes: [], complementares: [] };
      let peticoesBase64: string[] = [];
      let peticoesTextFinal: ExtractedTextItem[] = [];

      // Obter configuraÃ§Ã£o global de OCR (disponÃ­vel para todos os documentos)
      const globalOcrEngine = aiIntegration.aiSettings?.ocrEngine;
      // v1.32.13: Se anonimizaÃ§Ã£o ativa, bloquear apenas modos binÃ¡rios (pdf-puro, claude-vision)
      // PDF.js e Tesseract extraem texto â†’ podem ser anonimizados
      const anonConfig = aiIntegration.aiSettings?.anonymization;
      const anonymizationEnabled = anonConfig?.enabled;
      const blockedModes = ['claude-vision', 'pdf-puro'];
      const getEffectiveMode = (docMode: string | undefined) => {
        if (anonymizationEnabled && docMode && blockedModes.includes(docMode)) return 'pdfjs';
        return docMode || globalOcrEngine || 'pdfjs';
      };
      const maybeAnonymize = (text: string) => anonymizationEnabled ? anonymizeText(text, anonConfig, nomesParaAnonimizar) : text;

      // === PROCESSAR PETIÃ‡Ã•ES (MÃšLTIPLAS) ===
      const totalPeticoes = peticaoFiles.length + pastedPeticaoTexts.length;

      if (peticaoFiles.length > 0) {
        for (let i = 0; i < peticaoFiles.length; i++) {
          const peticaoMode = getEffectiveMode(documentProcessingModes.peticoes?.[i]);
          const label = i === 0 ? 'PetiÃ§Ã£o Inicial' : `Documento do Autor ${i + 1}`;
          setAnalysisProgress(`ğŸ“„ Processando ${label} (${i + 1}/${peticaoFiles.length}) - ${peticaoMode}...`);
          await new Promise(resolve => setTimeout(resolve, 100));

          const fileObj = peticaoFiles[i].file || peticaoFiles[i]; // Compatibilidade com formato antigo
          if (peticaoMode === 'pdf-puro') {
            const base64 = await storage.fileToBase64(fileObj);
            peticoesBase64.push(base64);
            // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
            contentArray.push({ type: 'text', text: `${label.toUpperCase()} (documento PDF a seguir):` });
            contentArray.push({
              type: 'document',
              source: { type: 'base64', media_type: 'application/pdf', data: base64 },
              cache_control: base64.length > 100000 ? { type: "ephemeral" } : undefined
            });
          } else {
            try {
              let extractedText = null;

              if (peticaoMode === 'pdfjs') {
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current: number, total: number) => {
                  setAnalysisProgress(`ğŸ“„ ${label} (PDF.js) - pÃ¡gina ${current}/${total}...`);
                });
              } else if (peticaoMode === 'claude-vision') {
                extractedText = await documentServices.extractTextFromPDFWithClaudeVision(fileObj, (current: number, total: number) => {
                  setAnalysisProgress(`ğŸ“„ ${label} (Claude Vision) - pÃ¡gina ${current}/${total}...`);
                });
              } else if (peticaoMode === 'tesseract') {
                extractedText = await documentServices.extractTextFromPDFWithTesseract(fileObj, (current: number, total: number, status?: string) => {
                  setAnalysisProgress(`ğŸ“„ ${label} (Tesseract) - pÃ¡gina ${current}/${total} ${status || ''}`);
                });
              } else {
                // Modo desconhecido (legado como 'gemini-vision'), usar pdfjs como fallback
                console.warn(`[analyzeDocuments] Modo desconhecido '${peticaoMode}', usando PDF.js`);
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current: number, total: number) => {
                  setAnalysisProgress(`ğŸ“„ ${label} (PDF.js) - pÃ¡gina ${current}/${total}...`);
                });
              }

              if (extractedText && extractedText.length > 100) {
                const anonText = maybeAnonymize(extractedText);
                const extractedItem = { id: crypto.randomUUID(), text: anonText, name: label };
                extractedTextsData.peticoes[i] = extractedItem;
                peticoesTextFinal.push(extractedItem);
                contentArray.push({
                  type: 'text',
                  text: `${label.toUpperCase()}:\n\n${anonText}`,
                  cache_control: anonText.length > 2000 ? { type: "ephemeral" } : undefined
                });
              } else {
                if (anonymizationEnabled) {
                  console.warn(`[analyzeDocuments] ExtraÃ§Ã£o falhou em ${label}, PDF bloqueado (anonimizaÃ§Ã£o ativa)`);
                  showToast(`âŒ NÃ£o foi possÃ­vel extrair texto de ${label}. Com anonimizaÃ§Ã£o ativa, PDF binÃ¡rio nÃ£o pode ser usado.`, 'error');
                } else {
                  console.warn(`[analyzeDocuments] ExtraÃ§Ã£o falhou em ${label}, usando PDF puro`);
                  const base64 = await storage.fileToBase64(fileObj);
                  peticoesBase64.push(base64);
                  // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
                  contentArray.push({ type: 'text', text: `${label.toUpperCase()} (documento PDF a seguir):` });
                  contentArray.push({
                    type: 'document',
                    source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                  });
                }
              }
            } catch (extractErr) {
              if (anonymizationEnabled) {
                console.warn(`[analyzeDocuments] Erro na extraÃ§Ã£o de ${label}, PDF bloqueado (anonimizaÃ§Ã£o ativa)`);
              } else {
                const base64 = await storage.fileToBase64(fileObj);
                peticoesBase64.push(base64);
                // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
                contentArray.push({ type: 'text', text: `${label.toUpperCase()} (documento PDF a seguir):` });
                contentArray.push({
                  type: 'document',
                  source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                });
              }
            }
          }
        }
      }

      // Textos colados de petiÃ§Ã£o
      pastedPeticaoTexts.forEach((pastedItem, idx) => {
        const anonPasted = maybeAnonymize(pastedItem.text);
        peticoesTextFinal.push({ id: pastedItem.id || crypto.randomUUID(), text: anonPasted, name: pastedItem.name });
        contentArray.push({
          type: 'text',
          text: `${pastedItem.name.toUpperCase()}:\n\n${anonPasted}`,
          cache_control: anonPasted.length > 2000 ? { type: "ephemeral" } : undefined
        });
      });

      // === PROCESSAR CONTESTAÃ‡Ã•ES ===
      const totalContestacoes = contestacaoFiles.length + pastedContestacaoTexts.length;
      let contestacoesBase64: string[] = [];
      let contestacoesTextFinal: ExtractedTextItem[] = [];

      if (contestacaoFiles.length > 0) {
        for (let i = 0; i < contestacaoFiles.length; i++) {
          // v1.14.1: Usar modo individual (global Ã© apenas padrÃ£o aplicado ao adicionar arquivo)
          // v1.16.2: Se anonimizaÃ§Ã£o ativa, forÃ§ar pdfjs
          const mode = getEffectiveMode(documentProcessingModes.contestacoes?.[i]);
          setAnalysisProgress(`ğŸ“‘ Processando contestaÃ§Ã£o ${i + 1}/${contestacaoFiles.length} (${mode})...`);
          await new Promise(resolve => setTimeout(resolve, 100));

          const fileObj = contestacaoFiles[i].file || contestacaoFiles[i]; // Compatibilidade
          if (mode === 'pdf-puro') {
            const base64 = await storage.fileToBase64(fileObj);
            contestacoesBase64.push(base64);
            // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
            contentArray.push({ type: 'text', text: `CONTESTAÃ‡ÃƒO ${i + 1} (documento PDF a seguir):` });
            contentArray.push({
              type: 'document',
              source: { type: 'base64', media_type: 'application/pdf', data: base64 }
            });
          } else {
            try {
              let extractedText = null;

              if (mode === 'pdfjs') {
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current: number, total: number) => {
                  setAnalysisProgress(`ğŸ“‘ ContestaÃ§Ã£o ${i + 1} (PDF.js) - pÃ¡gina ${current}/${total}...`);
                });
              } else if (mode === 'claude-vision') {
                extractedText = await documentServices.extractTextFromPDFWithClaudeVision(fileObj, (current: number, total: number) => {
                  setAnalysisProgress(`ğŸ“‘ ContestaÃ§Ã£o ${i + 1} (Claude Vision) - pÃ¡gina ${current}/${total}...`);
                });
              } else if (mode === 'tesseract') {
                extractedText = await documentServices.extractTextFromPDFWithTesseract(fileObj, (current: number, total: number, status?: string) => {
                  setAnalysisProgress(`ğŸ“‘ ContestaÃ§Ã£o ${i + 1} (Tesseract) - pÃ¡gina ${current}/${total} ${status || ''}`);
                });
              } else {
                // Modo desconhecido (legado), usar pdfjs como fallback
                console.warn(`[analyzeDocuments] ContestaÃ§Ã£o - modo desconhecido '${mode}', usando PDF.js`);
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current: number, total: number) => {
                  setAnalysisProgress(`ğŸ“‘ ContestaÃ§Ã£o ${i + 1} (PDF.js) - pÃ¡gina ${current}/${total}...`);
                });
              }

              if (extractedText && extractedText.length > 100) {
                const anonText = maybeAnonymize(extractedText);
                const extractedItem = { id: crypto.randomUUID(), text: anonText, name: `ContestaÃ§Ã£o ${i + 1}` };
                extractedTextsData.contestacoes[i] = extractedItem;
                contestacoesTextFinal.push(extractedItem);
                contentArray.push({
                  type: 'text',
                  text: `CONTESTAÃ‡ÃƒO ${i + 1}:\n\n${anonText}`
                });
              } else {
                if (anonymizationEnabled) {
                  showToast(`âŒ NÃ£o foi possÃ­vel extrair texto da contestaÃ§Ã£o ${i + 1}. PDF bloqueado (anonimizaÃ§Ã£o ativa).`, 'error');
                } else {
                  showToast(`âš ï¸ Texto insuficiente na contestaÃ§Ã£o ${i + 1}. Usando documento original.`, 'warning');
                  const base64 = await storage.fileToBase64(fileObj);
                  contestacoesBase64.push(base64);
                  // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
                  contentArray.push({ type: 'text', text: `CONTESTAÃ‡ÃƒO ${i + 1} (documento PDF a seguir):` });
                  contentArray.push({
                    type: 'document',
                    source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                  });
                }
              }
            } catch (extractErr) {
              if (anonymizationEnabled) {
                showToast(`âŒ Erro ao extrair texto da contestaÃ§Ã£o ${i + 1}. PDF bloqueado (anonimizaÃ§Ã£o ativa).`, 'error');
              } else {
                const base64 = await storage.fileToBase64(fileObj);
                contestacoesBase64.push(base64);
                // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
                contentArray.push({ type: 'text', text: `CONTESTAÃ‡ÃƒO ${i + 1} (documento PDF a seguir):` });
                contentArray.push({
                  type: 'document',
                  source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                });
              }
            }
          }
        }
      }

      // Adicionar contestaÃ§Ãµes coladas como texto - v1.16.4: Anonimizar
      pastedContestacaoTexts.forEach((contestacao, index) => {
        const anonText = maybeAnonymize(contestacao.text);
        contestacoesTextFinal.push({ ...contestacao, text: anonText });
        contentArray.push({
          type: 'text',
          text: `CONTESTAÃ‡ÃƒO ${index + 1 + contestacaoFiles.length}:\n\n${anonText}`
        });
      });

      // === PROCESSAR DOCUMENTOS COMPLEMENTARES ===
      const totalComplementares = complementaryFiles.length + pastedComplementaryTexts.length;
      let complementaryBase64: string[] = [];
      let complementaresTextFinal: ExtractedTextItem[] = [];

      if (complementaryFiles.length > 0) {
        for (let i = 0; i < complementaryFiles.length; i++) {
          // v1.14.1: Usar modo individual (global Ã© apenas padrÃ£o aplicado ao adicionar arquivo)
          // v1.16.2: Se anonimizaÃ§Ã£o ativa, forÃ§ar pdfjs
          const mode = getEffectiveMode(documentProcessingModes.complementares?.[i]);
          setAnalysisProgress(`ğŸ“ Processando complementar ${i + 1}/${complementaryFiles.length} (${mode})...`);
          await new Promise(resolve => setTimeout(resolve, 100));

          const fileObj = complementaryFiles[i].file || complementaryFiles[i]; // Compatibilidade
          if (mode === 'pdf-puro') {
            const base64 = await storage.fileToBase64(fileObj);
            complementaryBase64.push(base64);
            // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
            contentArray.push({ type: 'text', text: `DOCUMENTO COMPLEMENTAR ${i + 1} (documento PDF a seguir):` });
            contentArray.push({
              type: 'document',
              source: { type: 'base64', media_type: 'application/pdf', data: base64 }
            });
          } else {
            try {
              let extractedText = null;

              if (mode === 'pdfjs') {
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current: number, total: number) => {
                  setAnalysisProgress(`ğŸ“ Complementar ${i + 1} (PDF.js) - pÃ¡gina ${current}/${total}...`);
                });
              } else if (mode === 'claude-vision') {
                extractedText = await documentServices.extractTextFromPDFWithClaudeVision(fileObj, (current: number, total: number) => {
                  setAnalysisProgress(`ğŸ“ Complementar ${i + 1} (Claude Vision) - pÃ¡gina ${current}/${total}...`);
                });
              } else if (mode === 'tesseract') {
                extractedText = await documentServices.extractTextFromPDFWithTesseract(fileObj, (current: number, total: number, status?: string) => {
                  setAnalysisProgress(`ğŸ“ Complementar ${i + 1} (Tesseract) - pÃ¡gina ${current}/${total} ${status || ''}`);
                });
              } else {
                // Modo desconhecido (legado), usar pdfjs como fallback
                console.warn(`[analyzeDocuments] Complementar - modo desconhecido '${mode}', usando PDF.js`);
                extractedText = await documentServices.extractTextFromPDFPure(fileObj, (current: number, total: number) => {
                  setAnalysisProgress(`ğŸ“ Complementar ${i + 1} (PDF.js) - pÃ¡gina ${current}/${total}...`);
                });
              }

              if (extractedText && extractedText.length > 100) {
                const anonText = maybeAnonymize(extractedText);
                const extractedItem = { id: crypto.randomUUID(), text: anonText, name: `Complementar ${i + 1}` };
                extractedTextsData.complementares[i] = extractedItem;
                complementaresTextFinal.push(extractedItem);
                contentArray.push({
                  type: 'text',
                  text: `DOCUMENTO COMPLEMENTAR ${i + 1}:\n\n${anonText}`
                });
              } else {
                if (anonymizationEnabled) {
                  showToast(`âŒ NÃ£o foi possÃ­vel extrair texto do complementar ${i + 1}. PDF bloqueado (anonimizaÃ§Ã£o ativa).`, 'error');
                } else {
                  showToast(`âš ï¸ Texto insuficiente no documento complementar ${i + 1}. Usando original.`, 'warning');
                  const base64 = await storage.fileToBase64(fileObj);
                  complementaryBase64.push(base64);
                  // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
                  contentArray.push({ type: 'text', text: `DOCUMENTO COMPLEMENTAR ${i + 1} (documento PDF a seguir):` });
                  contentArray.push({
                    type: 'document',
                    source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                  });
                }
              }
            } catch (extractErr) {
              if (anonymizationEnabled) {
                showToast(`âŒ Erro ao extrair texto do complementar ${i + 1}. PDF bloqueado (anonimizaÃ§Ã£o ativa).`, 'error');
              } else {
                const base64 = await storage.fileToBase64(fileObj);
                complementaryBase64.push(base64);
                // v1.35.14: Adicionar label antes de cada PDF para identificaÃ§Ã£o explÃ­cita
                contentArray.push({ type: 'text', text: `DOCUMENTO COMPLEMENTAR ${i + 1} (documento PDF a seguir):` });
                contentArray.push({
                  type: 'document',
                  source: { type: 'base64', media_type: 'application/pdf', data: base64 }
                });
              }
            }
          }
        }
      }

      // Salvar textos extraÃ­dos no estado para persistÃªncia
      setExtractedTexts(extractedTextsData);

      // Adicionar documentos complementares colados como texto - v1.16.4: Anonimizar
      pastedComplementaryTexts.forEach((doc, index) => {
        const anonText = maybeAnonymize(doc.text);
        complementaresTextFinal.push({ ...doc, text: anonText });
        contentArray.push({
          type: 'text',
          text: `DOCUMENTO COMPLEMENTAR ${index + 1 + complementaryFiles.length}:\n\n${anonText}`
        });
      });

      const contestacoesText = totalContestacoes > 0 
        ? `${totalContestacoes} contestaÃ§Ã£o${totalContestacoes > 1 ? 'Ãµes' : ''}`
        : 'nenhuma contestaÃ§Ã£o';

      setAnalysisProgress('ğŸ¤– Enviando documentos para anÃ¡lise com IA...');
      await new Promise(resolve => setTimeout(resolve, 500));

      contentArray.push({
        type: 'text',
        text: `Analise a petiÃ§Ã£o inicial ${totalContestacoes > 0 ? `e as ${totalContestacoes} contestaÃ§Ã£o${totalContestacoes > 1 ? 'Ãµes' : ''} fornecida${totalContestacoes > 1 ? 's' : ''}` : '(nÃ£o hÃ¡ contestaÃ§Ã£o fornecida)'}. 

TÃ“PICO OBRIGATÃ“RIO "RELATÃ“RIO":
VocÃª DEVE criar um tÃ³pico especial chamado "RELATÃ“RIO" (categoria PRELIMINAR) que descreva o histÃ³rico processual.
${totalComplementares > 0 ? `HÃ¡ ${totalComplementares} documento${totalComplementares > 1 ? 's' : ''} complementar${totalComplementares > 1 ? 'es' : ''} disponÃ­vel${totalComplementares > 1 ? 'eis' : ''} (atas, provas, documentos adicionais) que devem ser usados APENAS neste tÃ³pico RELATÃ“RIO.` : 'Como nÃ£o hÃ¡ documentos complementares, base o relatÃ³rio apenas nas informaÃ§Ãµes da petiÃ§Ã£o inicial e contestaÃ§Ãµes sobre o andamento do processo.'}

Extraia e classifique todos os tÃ³picos/pedidos em:

              1. QUESTÃ•ES PROCESSUAIS (impugnaÃ§Ã£o aos cÃ¡lculos, regularidade de representaÃ§Ã£o processual, impugnaÃ§Ã£o aos documentos, gratuidade de justiÃ§a, etc.)
              2. PRELIMINARES (prescriÃ§Ã£o, inÃ©pcia, ilegitimidade, incompetÃªncia, litispendÃªncia, coisa julgada, etc.)
              3. PREJUDICIAIS (questÃµes que impedem anÃ¡lise do mÃ©rito - prescriÃ§Ã£o bienal, prescriÃ§Ã£o quinquenal, etc.)
              4. MÃ‰RITO (pedidos principais - verbas rescisÃ³rias, horas extras, danos morais, vÃ­nculo empregatÃ­cio, grupo econÃ´mico, etc.)
              
              Para cada tÃ³pico, crie um mini-relatÃ³rio em formato NARRATIVO, seguindo EXATAMENTE este modelo com PARÃGRAFOS SEPARADOS:
              
              ${aiIntegration.aiSettings.modeloRelatorio ? `
              MODELO PERSONALIZADO DO USUÃRIO:
              ${aiIntegration.aiSettings.modeloRelatorio}
              
              Use este modelo como referÃªncia, mas mantenha a estrutura de parÃ¡grafos separados.
              ` : `
              MODELO PADRÃƒO:
              PRIMEIRO PARÃGRAFO (alegaÃ§Ãµes do autor):
              "O reclamante narra [resumo dos fatos]. Sustenta [argumentos]. Indica que [situaÃ§Ã£o]. Em decorrÃªncia, postula [pedido especÃ­fico]."
              
              SEGUNDO PARÃGRAFO (primeira defesa):
              ${totalContestacoes > 0 ? '"A primeira reclamada, em defesa, alega [argumentos]. Sustenta que [posiÃ§Ã£o]."' : '"NÃ£o houve apresentaÃ§Ã£o de contestaÃ§Ã£o."'}
              
              ${totalContestacoes > 1 ? 'TERCEIRO PARÃGRAFO (segunda defesa):\n"A segunda rÃ©, por sua vez, nega [posiÃ§Ã£o]. Aduz [argumentos]."' : ''}
              
              ${totalContestacoes > 2 ? 'QUARTO PARÃGRAFO (terceira defesa):\n"A terceira reclamada tambÃ©m contesta [argumentos]. Sustenta [posiÃ§Ã£o]."' : ''}
              `}
              
              TÃ“PICO ESPECIAL "RELATÃ“RIO" (OBRIGATÃ“RIO):
              O tÃ³pico "RELATÃ“RIO" deve resumir o histÃ³rico processual:
              ${totalComplementares > 0 ? 
              `"A presente reclamaÃ§Ã£o foi distribuÃ­da em [data se constar]. Realizou-se audiÃªncia em [data], na qual [ocorrÃªncias]. Foram juntados aos autos [documentos]. As partes apresentaram [manifestaÃ§Ãµes]. O processo encontra-se [situaÃ§Ã£o atual]."` 
              : 
              `"A presente reclamaÃ§Ã£o foi ajuizada em [data se constar]. ${totalContestacoes > 0 ? 'Foram apresentadas contestaÃ§Ãµes.' : 'NÃ£o houve apresentaÃ§Ã£o de contestaÃ§Ã£o.'} ${totalContestacoes > 0 ? 'As partes manifestaram-se nos autos.' : ''} O processo encontra-se em fase de sentenÃ§a."`
              }
              
              ${AI_PROMPTS.formatacaoParagrafos("<p>O reclamante narra...</p><p>A primeira reclamada, em defesa...</p>")}

              ${aiIntegration.aiSettings.detailedMiniReports ? `âš ï¸ NÃVEL DE DETALHE - FATOS:
              Gere com alto nÃ­vel de detalhe em relaÃ§Ã£o aos FATOS alegados pelas partes.
              A descriÃ§Ã£o fÃ¡tica (postulatÃ³ria e defensiva) deve ter alto nÃ­vel de detalhe.
              ` : ''}

              ESTRUTURA DOS PARÃGRAFOS:
              - PRIMEIRO PARÃGRAFO (<p>): apenas alegaÃ§Ãµes do reclamante
              - PARÃGRAFOS SEGUINTES (<p>): uma defesa por parÃ¡grafo
              - Use "O reclamante narra...", "Sustenta...", "Postula..."
              - Para defesas use: "A primeira reclamada, em defesa...", "A segunda rÃ©, por sua vez...", "A terceira reclamada..."
              - O tÃ³pico "RELATÃ“RIO" Ã© OBRIGATÃ“RIO e deve sempre ser o primeiro da lista
              ${totalComplementares > 0 ? '- Documentos complementares devem ser usados APENAS no tÃ³pico "RELATÃ“RIO"' : '- Como nÃ£o hÃ¡ documentos complementares, o RELATÃ“RIO deve ser baseado apenas em petiÃ§Ã£o e contestaÃ§Ãµes'}

              ${AI_PROMPTS.numeracaoReclamadasInicial}

              IDENTIFICAÃ‡ÃƒO DAS PARTES:
              Extraia tambÃ©m os nomes das partes do processo:
              - Nome completo do RECLAMANTE (autor da aÃ§Ã£o)
              - Nomes completos de todas as RECLAMADAS (rÃ©s)

              FORMATO DO TÃTULO DOS TÃ“PICOS (v1.32.23):
              Use o formato "PEDIDO - CAUSA DE PEDIR" quando a causa de pedir for especÃ­fica e distintiva.
              Exemplos com causa especÃ­fica:
              â€¢ RESCISÃƒO INDIRETA - ASSÃ‰DIO MORAL (nÃ£o apenas "RESCISÃƒO INDIRETA")
              â€¢ ADICIONAL DE PERICULOSIDADE - ELETRICIDADE (nÃ£o apenas "ADICIONAL DE PERICULOSIDADE")
              â€¢ HORAS EXTRAS - NULIDADE DOS CARTÃ•ES DE PONTO
              â€¢ DANO MORAL - ACIDENTE DE TRABALHO
              â€¢ VÃNCULO EMPREGATÃCIO - FRAUDE Ã€ CLT (PJ)
              Exemplos que NÃƒO precisam de complemento (causa Ã³bvia ou Ãºnica):
              â€¢ FÃ‰RIAS, DÃ‰CIMO TERCEIRO SALÃRIO (verbas simples)
              â€¢ INÃ‰PCIA DA INICIAL, GRATUIDADE DE JUSTIÃ‡A (preliminares genÃ©ricas)

              Responda APENAS com um JSON vÃ¡lido, sem markdown, no seguinte formato:
              {
                "partes": {
                  "reclamante": "Nome completo do reclamante",
                  "reclamadas": ["Nome da primeira reclamada", "Nome da segunda reclamada"]
                },
                "topics": [
                  {
                    "title": "PEDIDO - CAUSA ESPECÃFICA (quando relevante)",
                    "category": "QUESTÃƒO PROCESSUAL | PRELIMINAR | PREJUDICIAL | MÃ‰RITO"
                  }
                ]
              }

              IMPORTANTE: Retorne APENAS tÃ­tulo e categoria de cada tÃ³pico. NÃƒO inclua o campo "relatorio" - os mini-relatÃ³rios serÃ£o gerados separadamente para cada tÃ³pico.`
      });

      const messages: AIMessage[] = [
        {
          role: 'user' as const,
          content: contentArray as AIMessageContent[]
        }
      ];

      setAnalysisProgress('ğŸ§  Aguardando anÃ¡lise da IA (isso pode levar alguns minutos)...');

      // v1.21.26: Parametros para analise critica (fidelidade ao documento)
      const data = await aiIntegration.callAI(messages, {
        maxTokens: 16000,
        useInstructions: true,
        extractText: false, // Retornar data bruto para validaÃ§Ãµes customizadas
        temperature: 0.2,
        topP: 0.85,
        topK: 40
      });

      // Verificar se a resposta foi truncada por limite de tokens (provider-aware)
      const provider = aiIntegration.aiSettings.provider || 'claude';
      const isTruncated = provider === 'gemini'
        ? data.candidates?.[0]?.finishReason === 'MAX_TOKENS'
        : data.stop_reason === 'max_tokens';

      if (isTruncated) {
        throw new Error('O documento Ã© muito extenso e a anÃ¡lise foi truncada. Tente: 1) Dividir o PDF em partes menores, 2) Usar documentos com menos pÃ¡ginas, ou 3) Colar apenas trechos relevantes do texto.');
      }

      const textContent = aiIntegration.extractResponseText(data, provider);
      
      if (!textContent) {
        throw new Error('Nenhum conteÃºdo de texto encontrado na resposta da API');
      }
      
      setAnalysisProgress('ğŸ” Extraindo tÃ³picos identificados...');
      await new Promise(resolve => setTimeout(resolve, 300));

      // Limpar markdown e espaÃ§os
      let cleanText = textContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

      let parsed;
      try {
        // Tentar parse normal
        parsed = JSON.parse(cleanText);
      } catch (parseError) {

        // Tentar extrair JSON de dentro do texto (caso tenha texto antes/depois)
        const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          try {
            parsed = JSON.parse(jsonMatch[0]);
          } catch (matchError) {

            // Ãšltima tentativa: tentar corrigir strings nÃ£o terminadas
            let fixedText = jsonMatch[0];

            // Encontrar a Ãºltima string aberta e fechÃ¡-la
            const lastQuote = fixedText.lastIndexOf('"');
            const lastBrace = fixedText.lastIndexOf('}');

            if (lastQuote > lastBrace) {
              // HÃ¡ uma string nÃ£o fechada
              fixedText = fixedText.substring(0, lastQuote + 1) + '"}]}';

              try {
                parsed = JSON.parse(fixedText);
              } catch (fixError) {
                throw new Error(`Erro ao parsear resposta da IA. Resposta pode estar incompleta ou mal formatada. Detalhes: ${(parseError as Error).message}`);
              }
            } else {
              throw new Error(`Erro ao parsear resposta da IA. Resposta pode estar incompleta ou mal formatada. Detalhes: ${(parseError as Error).message}`);
            }
          }
        } else {
          throw new Error(`NÃ£o foi possÃ­vel encontrar JSON vÃ¡lido na resposta da IA. Detalhes: ${(parseError as Error).message}`);
        }
      }

      let topics = parsed.topics || [];

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // v1.36.50: DOUBLE CHECK - VerificaÃ§Ã£o secundÃ¡ria da extraÃ§Ã£o de tÃ³picos
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (aiIntegration.aiSettings.doubleCheck?.enabled &&
          aiIntegration.aiSettings.doubleCheck?.operations.topicExtraction) {

        setAnalysisProgress('ğŸ”„ Verificando extraÃ§Ã£o com Double Check...');
        await new Promise(resolve => setTimeout(resolve, 300));

        // Reconstruir contexto dos documentos para verificaÃ§Ã£o
        const contextParts: string[] = [];
        peticoesTextFinal.forEach((doc, idx) => {
          contextParts.push(`PETIÃ‡ÃƒO ${idx + 1}:\n${doc.text?.substring(0, 3000) || ''}`);
        });
        contestacoesTextFinal.forEach((doc, idx) => {
          contextParts.push(`CONTESTAÃ‡ÃƒO ${idx + 1}:\n${doc.text?.substring(0, 3000) || ''}`);
        });
        pastedPeticaoTexts.forEach((doc, idx) => {
          contextParts.push(`PETIÃ‡ÃƒO COLADA ${idx + 1}:\n${doc.text?.substring(0, 3000) || ''}`);
        });
        pastedContestacaoTexts.forEach((doc, idx) => {
          contextParts.push(`CONTESTAÃ‡ÃƒO COLADA ${idx + 1}:\n${doc.text?.substring(0, 3000) || ''}`);
        });

        const documentContext = contextParts.join('\n\n---\n\n');

        try {
          const { verified, corrections, summary } = await aiIntegration.performDoubleCheck(
            'topicExtraction',
            JSON.stringify(topics),
            documentContext,
            setAnalysisProgress
          );

          if (corrections.length > 0) {
            // Parsear tÃ³picos verificados
            const verifiedTopics = JSON.parse(verified);
            topics = verifiedTopics;

            // Notificar sobre correÃ§Ãµes
            showToast(`ğŸ”„ Double Check: ${corrections.length} correÃ§Ã£o(Ãµes) - ${summary}`, 'info');
            console.log('[DoubleCheck] CorreÃ§Ãµes aplicadas:', corrections);
          } else {
            console.log('[DoubleCheck] Nenhuma correÃ§Ã£o necessÃ¡ria');
          }
        } catch (dcError) {
          console.error('[DoubleCheck] Erro na verificaÃ§Ã£o:', dcError);
          // Continuar com tÃ³picos originais em caso de erro
        }
      }

      // Armazenar informaÃ§Ãµes das partes se disponÃ­veis
      if (parsed.partes) {
        setPartesProcesso({
          reclamante: parsed.partes.reclamante || '',
          reclamadas: parsed.partes.reclamadas || []
        });
      }

      // v1.14.3: Reordenar tÃ³picos via LLM (processuais â†’ preliminares â†’ prejudiciais â†’ mÃ©rito)
      setAnalysisProgress('ğŸ“‹ Ordenando tÃ³picos por categoria processual...');
      await new Promise(resolve => setTimeout(resolve, 300));
      topics = await reorderTopicsViaLLM(topics);

      setAnalysisProgress(`âœ… ${topics.length} tÃ³pico${topics.length !== 1 ? 's' : ''} identificado${topics.length !== 1 ? 's' : ''}! Revisando...`);
      await new Promise(resolve => setTimeout(resolve, 300));

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // v1.35.30: PAUSA PARA CURADORIA DE TÃ“PICOS
      // Permite ao usuÃ¡rio revisar, reordenar, mesclar, separar e apagar tÃ³picos
      // ANTES de gastar tokens com a geraÃ§Ã£o de mini-relatÃ³rios
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // Criar contentArray para o relatÃ³rio (serÃ¡ usado apÃ³s confirmaÃ§Ã£o)
      const relatorioContentArray: AIMessageContent[] = [];

      // Usar textos extraÃ­dos de petiÃ§Ãµes se disponÃ­veis, senÃ£o usar PDFs
      if (peticoesTextFinal.length > 0) {
        peticoesTextFinal.forEach((doc, idx) => {
          relatorioContentArray.push({
            type: 'text' as const,
            text: `${doc.name?.toUpperCase() || `PETIÃ‡ÃƒO ${idx + 1}`}:\n\n${doc.text}`
          });
        });
      }
      if (peticoesBase64.length > 0) {
        peticoesBase64.forEach((base64) => {
          relatorioContentArray.push({
            type: 'document' as const,
            source: { type: 'base64' as const, media_type: 'application/pdf' as const, data: base64 }
          });
        });
      }

      // Adicionar contestaÃ§Ãµes (texto extraÃ­do ou PDF)
      contestacoesTextFinal.forEach((contestacao, index) => {
        relatorioContentArray.push({
          type: 'text' as const,
          text: `CONTESTAÃ‡ÃƒO ${index + 1}:\n\n${contestacao.text}`
        });
      });

      contestacoesBase64.forEach((base64) => {
        relatorioContentArray.push({
          type: 'document' as const,
          source: { type: 'base64' as const, media_type: 'application/pdf' as const, data: base64 }
        });
      });

      // Adicionar documentos complementares (texto extraÃ­do ou PDF)
      complementaresTextFinal.forEach((doc, index) => {
        relatorioContentArray.push({
          type: 'text' as const,
          text: `DOCUMENTO COMPLEMENTAR ${index + 1}:\n\n${doc.text}`
        });
      });

      complementaryBase64.forEach((base64) => {
        relatorioContentArray.push({
          type: 'document' as const,
          source: { type: 'base64' as const, media_type: 'application/pdf' as const, data: base64 }
        });
      });

      // Separar textos extraÃ­dos de PDFs (novos) dos textos jÃ¡ colados (existentes)
      const contestacoesExtraidasDePDF_pre = contestacoesTextFinal.filter(c =>
        !pastedContestacaoTexts.some(p => p.text === c.text)
      );
      const contestacoesJaColadas_pre = contestacoesTextFinal.filter(c =>
        pastedContestacaoTexts.some(p => p.text === c.text)
      );

      const complementaresExtraidasDePDF_pre = complementaresTextFinal.filter(c =>
        !pastedComplementaryTexts.some(p => p.text === c.text)
      );
      const complementaresJaColadas_pre = complementaresTextFinal.filter(c =>
        pastedComplementaryTexts.some(p => p.text === c.text)
      );

      // Separar petiÃ§Ãµes extraÃ­das de PDF vs coladas
      const peticoesExtraidasDePDF_pre = peticoesTextFinal.filter(p =>
        !pastedPeticaoTexts.some(pt => pt.text === p.text)
      );
      const peticoesJaColadas_pre = peticoesTextFinal.filter(p =>
        pastedPeticaoTexts.some(pt => pt.text === p.text)
      );

      // Preparar dados para o modal de curadoria
      const curationData = {
        topics: topics,
        partes: parsed.partes || { reclamante: '', reclamadas: [] },
        relatorioContentArray: relatorioContentArray,
        documents: {
          peticoesText: peticoesTextFinal,
          contestacoesText: contestacoesTextFinal,
          complementaresText: complementaresTextFinal,
          peticoesBase64,
          contestacoesBase64,
          complementaryBase64,
          // Textos separados por origem
          contestacoesExtraidasDePDF: contestacoesExtraidasDePDF_pre,
          contestacoesJaColadas: contestacoesJaColadas_pre,
          complementaresExtraidasDePDF: complementaresExtraidasDePDF_pre,
          complementaresJaColadas: complementaresJaColadas_pre,
          peticoesExtraidasDePDF: peticoesExtraidasDePDF_pre,
          peticoesJaColadas: peticoesJaColadas_pre
        }
      };

      // Salvar dados e abrir modal de curadoria
      setPendingCurationData(curationData);
      setShowTopicCurationModal(true);
      setAnalyzing(false);
      setAnalysisProgress('');

      // PAUSA: O fluxo continua em handleCurationConfirm() apÃ³s o usuÃ¡rio confirmar
      return;

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CÃ“DIGO ABAIXO NÃƒO Ã‰ MAIS EXECUTADO DIRETAMENTE
      // Foi movido para handleCurationConfirm()
      // Mantido aqui apenas como referÃªncia (serÃ¡ removido apÃ³s testes)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const relatorioProcessual = await generateRelatorioProcessual(relatorioContentArray)

      // Normalizar espaÃ§amento para remover linhas em branco entre tags HTML
      const relatorioHtml = normalizeHTMLSpacing(relatorioProcessual.trim());

      // Buscar tÃ³picos complementares configurados pelo usuÃ¡rio
      const topicosComplementaresConfig = aiIntegration.aiSettings?.topicosComplementares || [];
      const topicosComplementaresAtivos = topicosComplementaresConfig
        .filter(t => t.enabled)
        .sort((a, b) => a.ordem - b.ordem);

      // Gerar tÃ³picos complementares baseados na configuraÃ§Ã£o
      const topicosComplementares = topicosComplementaresAtivos.map((config, idx) => ({
        title: config.title,
        category: config.category,
        relatorio: config.descricao || '', // v1.20.6: Vazio se nÃ£o houver descriÃ§Ã£o configurada
        editedContent: '',
        order: topics.length + idx + 1,
        isComplementar: true // Marcador para identificar tÃ³picos complementares
      }));
      
      // Filtrar tÃ³picos para remover qualquer "RELATÃ“RIO" que possa ter sido gerado pela IA
      const topicsSemRelatorio = topics.filter((topic: Topic) =>
        !topic.title || topic.title.toUpperCase() !== 'RELATÃ“RIO'
      );

      // ========== CONSTRUIR OBJETO DE DOCUMENTOS ==========
      // Separar textos extraÃ­dos de PDFs (novos) dos textos jÃ¡ colados (existentes)
      const contestacoesExtraidasDePDF = contestacoesTextFinal.filter(c =>
        !pastedContestacaoTexts.some(p => p.text === c.text)
      );
      const contestacoesJaColadas = contestacoesTextFinal.filter(c =>
        pastedContestacaoTexts.some(p => p.text === c.text)
      );

      const complementaresExtraidasDePDF = complementaresTextFinal.filter(c =>
        !pastedComplementaryTexts.some(p => p.text === c.text)
      );
      const complementaresJaColadas = complementaresTextFinal.filter(c =>
        pastedComplementaryTexts.some(p => p.text === c.text)
      );

      // Separar petiÃ§Ãµes extraÃ­das de PDF vs coladas
      const peticoesExtraidasDePDF = peticoesTextFinal.filter(p =>
        !pastedPeticaoTexts.some(pt => pt.text === p.text)
      );
      const peticoesJaColadas = peticoesTextFinal.filter(p =>
        pastedPeticaoTexts.some(pt => pt.text === p.text)
      );

      // Construir objeto de documentos (usado diretamente E salvo no estado)
      const documentsForBatch = {
        peticoes: peticoesBase64,
        peticoesText: [...peticoesExtraidasDePDF, ...peticoesJaColadas],
        contestacoes: contestacoesBase64,
        contestacoesText: [...contestacoesExtraidasDePDF, ...contestacoesJaColadas],
        complementares: complementaryBase64,
        complementaresText: [...complementaresExtraidasDePDF, ...complementaresJaColadas]
      };

      // Salvar no estado (para regeneraÃ§Ãµes futuras, apÃ³s React atualizar)
      setAnalyzedDocuments(documentsForBatch);
      // ========== FIM: Documentos construÃ­dos ==========

      // ========== GERAÃ‡ÃƒO HÃBRIDA DE MINI-RELATÃ“RIOS (v1.15) ==========
      // Gerar mini-relatÃ³rios em batches de 3 requisiÃ§Ãµes paralelas
      let topicsComRelatorios = topicsSemRelatorio;

      if (topicsSemRelatorio.length > 0) {
        setAnalysisProgress(`ğŸ“ Gerando mini-relatÃ³rios... 0/${topicsSemRelatorio.length}`);

        // CRÃTICO: Passar documentsForBatch diretamente (nÃ£o depende do estado React)
        const { results, errors } = await generateMiniReportsBatch(
          topicsSemRelatorio.map((t: Topic) => ({
            title: t.title,
            category: t.category,
            isInitialGeneration: true,
            includeComplementares: false,
            documentsOverride: documentsForBatch
          })),
          {
            batchSize: aiIntegration.aiSettings.parallelRequests || 5,
            delayBetweenBatches: 1000,
            onProgress: (current: number, total: number, batchNum: number, totalBatches: number) => {
              setAnalysisProgress(`ğŸ“ Gerando mini-relatÃ³rios... ${current}/${total} (Lote ${batchNum}/${totalBatches})`);
            }
          }
        );

        // Mesclar resultados com os tÃ³picos originais
        topicsComRelatorios = topicsSemRelatorio.map((topic: Topic) => {
          const resultado = results.find((r: { title: string; relatorio?: string }) => r.title === topic.title);
          if (resultado && resultado.relatorio) {
            return { ...topic, relatorio: resultado.relatorio };
          }
          // Se falhou, usar placeholder
          const erro = errors.find((e: { title: string; error?: string }) => e.title === topic.title);
          return {
            ...topic,
            relatorio: `<p>Erro ao gerar mini-relatÃ³rio${erro ? `: ${erro.error}` : ''}. Use "Gerar com IA" para tentar novamente.</p>`
          };
        });

        if (errors.length > 0) {
          showToast(`${errors.length} tÃ³pico(s) falharam na geraÃ§Ã£o. VocÃª pode regenerÃ¡-los individualmente.`, 'warning');
        }

        setAnalysisProgress(`âœ… Mini-relatÃ³rios gerados! ${results.length}/${topicsSemRelatorio.length} com sucesso`);
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      // ========== FIM DA GERAÃ‡ÃƒO HÃBRIDA ==========

      // v1.19.2: Filtrar complementares que jÃ¡ existem nos tÃ³picos gerados (case-insensitive)
      const titulosGeradosUpper = new Set(
        topicsComRelatorios.map((t: Topic) => (t.title || '').toUpperCase().trim())
      );
      const topicosComplementaresUnicos = topicosComplementares.filter(
        t => !titulosGeradosUpper.has((t.title || '').toUpperCase().trim())
      );

      // Adicionar relatÃ³rio como primeiro tÃ³pico, depois os tÃ³picos analisados, depois os complementares
      const allTopics = [
        {
          title: 'RELATÃ“RIO',
          category: 'RELATÃ“RIO',
          relatorio: relatorioHtml,
          editedFundamentacao: relatorioHtml,
          order: 0
        },
        ...topicsComRelatorios.map((topic: Topic, index: number) => ({ ...topic, order: index + 1 })),
        ...topicosComplementaresUnicos
      ];

      setExtractedTopics(allTopics);

      // Selecionar apenas RELATÃ“RIO e os tÃ³picos analisados (nÃ£o os complementares)
      const topicosInicialmenteSelecionados = allTopics.filter((topic, index) => index < topicsComRelatorios.length + 1);
      setSelectedTopics(topicosInicialmenteSelecionados);

      // Limpar PDFs originais apÃ³s extraÃ§Ã£o de texto (textos vÃ£o para analyzedDocuments)
      if (peticoesTextFinal.length > 0 && peticaoFiles.length > 0) {
        setPeticaoFiles([]);
      }

      if (contestacoesExtraidasDePDF.length > 0) {
        setContestacaoFiles([]);
      }

      if (complementaresExtraidasDePDF.length > 0) {
        setComplementaryFiles([]);
      }

      closeModal('analysis');
      setActiveTab('topics');
    } catch (err) {
      setError('Erro ao analisar documentos: ' + (err as Error).message);
      closeModal('analysis');
    } finally {
      setAnalyzing(false);
    }
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // v1.35.30: HANDLERS DE CURADORIA DE TÃ“PICOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Continua o fluxo de anÃ¡lise apÃ³s o usuÃ¡rio confirmar a curadoria de tÃ³picos
   * @param {Array} curatedTopics - TÃ³picos apÃ³s ediÃ§Ã£o do usuÃ¡rio (reordenados, mesclados, etc.)
   */
  const handleCurationConfirm = async (curatedTopics: Topic[]) => {
    if (!pendingCurationData) {
      console.error('[handleCurationConfirm] pendingCurationData is null');
      return;
    }

    try {
      setShowTopicCurationModal(false);
      setAnalyzing(true);
      openModal('analysis');

      const { relatorioContentArray, documents, partes } = pendingCurationData;

      // Gerar relatÃ³rio processual
      setAnalysisProgress('ğŸ“‹ Gerando relatÃ³rio processual...');
      await new Promise(resolve => setTimeout(resolve, 300));

      const relatorioProcessual = await generateRelatorioProcessual(relatorioContentArray);
      const relatorioHtml = normalizeHTMLSpacing(relatorioProcessual.trim());

      // Buscar tÃ³picos complementares configurados pelo usuÃ¡rio
      const topicosComplementaresConfig = aiIntegration.aiSettings?.topicosComplementares || [];
      const topicosComplementaresAtivos = topicosComplementaresConfig
        .filter(t => t.enabled)
        .sort((a, b) => a.ordem - b.ordem);

      // Gerar tÃ³picos complementares baseados na configuraÃ§Ã£o
      const topicosComplementares = topicosComplementaresAtivos.map((config, idx) => ({
        title: config.title,
        category: config.category,
        relatorio: config.descricao || '',
        editedContent: '',
        order: curatedTopics.length + idx + 1,
        isComplementar: true
      }));

      // Filtrar tÃ³picos para remover qualquer "RELATÃ“RIO" que possa ter sido incluÃ­do
      const topicsSemRelatorio = curatedTopics.filter((topic: Topic) =>
        !topic.title || topic.title.toUpperCase() !== 'RELATÃ“RIO'
      );

      // Construir objeto de documentos
      const documentsForBatch = {
        peticoes: documents.peticoesBase64,
        peticoesText: [...documents.peticoesExtraidasDePDF, ...documents.peticoesJaColadas],
        contestacoes: documents.contestacoesBase64,
        contestacoesText: [...documents.contestacoesExtraidasDePDF, ...documents.contestacoesJaColadas],
        complementares: documents.complementaryBase64,
        complementaresText: [...documents.complementaresExtraidasDePDF, ...documents.complementaresJaColadas]
      };

      // Salvar no estado
      setAnalyzedDocuments(documentsForBatch);

      // Gerar mini-relatÃ³rios em batches
      let topicsComRelatorios = topicsSemRelatorio;

      if (topicsSemRelatorio.length > 0) {
        setAnalysisProgress(`ğŸ“ Gerando mini-relatÃ³rios... 0/${topicsSemRelatorio.length}`);

        const { results, errors } = await generateMiniReportsBatch(
          topicsSemRelatorio.map((t: Topic) => ({
            title: t.title,
            category: t.category,
            isInitialGeneration: true,
            includeComplementares: false,
            documentsOverride: documentsForBatch
          })),
          {
            batchSize: aiIntegration.aiSettings.parallelRequests || 5,
            delayBetweenBatches: 1000,
            onProgress: (current: number, total: number, batchNum: number, totalBatches: number) => {
              setAnalysisProgress(`ğŸ“ Gerando mini-relatÃ³rios... ${current}/${total} (Lote ${batchNum}/${totalBatches})`);
            }
          }
        );

        // Mesclar resultados com os tÃ³picos
        topicsComRelatorios = topicsSemRelatorio.map((topic: Topic) => {
          const resultado = results.find((r: { title: string; relatorio?: string }) => r.title === topic.title);
          if (resultado && resultado.relatorio) {
            return { ...topic, relatorio: resultado.relatorio };
          }
          const erro = errors.find((e: { title: string; error?: string }) => e.title === topic.title);
          return {
            ...topic,
            relatorio: `<p>Erro ao gerar mini-relatÃ³rio${erro ? `: ${erro.error}` : ''}. Use "Gerar com IA" para tentar novamente.</p>`
          };
        });

        if (errors.length > 0) {
          showToast(`${errors.length} tÃ³pico(s) falharam na geraÃ§Ã£o. VocÃª pode regenerÃ¡-los individualmente.`, 'warning');
        }

        setAnalysisProgress(`âœ… Mini-relatÃ³rios gerados! ${results.length}/${topicsSemRelatorio.length} com sucesso`);
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      // Filtrar complementares que jÃ¡ existem nos tÃ³picos gerados
      const titulosGeradosUpper = new Set(
        topicsComRelatorios.map((t: Topic) => (t.title || '').toUpperCase().trim())
      );
      const topicosComplementaresUnicos = topicosComplementares.filter(
        (t: { title: string }) => !titulosGeradosUpper.has((t.title || '').toUpperCase().trim())
      );

      // Montar lista final de tÃ³picos
      const allTopics: Topic[] = [
        {
          title: 'RELATÃ“RIO',
          category: 'RELATÃ“RIO' as const,
          relatorio: relatorioHtml,
          editedFundamentacao: relatorioHtml,
          order: 0
        },
        ...topicsComRelatorios.map((topic: Topic, index: number) => ({ ...topic, order: index + 1 })),
        ...topicosComplementaresUnicos
      ];

      setExtractedTopics(allTopics);

      // Selecionar apenas RELATÃ“RIO e os tÃ³picos analisados
      const topicosInicialmenteSelecionados = allTopics.filter((_, index) => index < topicsComRelatorios.length + 1);
      setSelectedTopics(topicosInicialmenteSelecionados);

      // Atualizar partes do processo se disponÃ­veis
      if (partes) {
        setPartesProcesso({
          reclamante: partes.reclamante || '',
          reclamadas: partes.reclamadas || []
        });
      }

      // Limpar PDFs originais apÃ³s extraÃ§Ã£o
      if (documents.peticoesText?.length > 0 && peticaoFiles.length > 0) {
        setPeticaoFiles([]);
      }
      if (documents.contestacoesExtraidasDePDF?.length > 0) {
        setContestacaoFiles([]);
      }
      if (documents.complementaresExtraidasDePDF?.length > 0) {
        setComplementaryFiles([]);
      }

      // Limpar dados pendentes
      setPendingCurationData(null);

      closeModal('analysis');
      setActiveTab('topics');
      showToast('âœ… AnÃ¡lise concluÃ­da com sucesso!', 'success');

    } catch (err) {
      setError('Erro ao processar tÃ³picos: ' + (err as Error).message);
      closeModal('analysis');
    } finally {
      setAnalyzing(false);
    }
  };

  /**
   * Cancela a curadoria e volta ao estado inicial
   */
  const handleCurationCancel = () => {
    setShowTopicCurationModal(false);
    setPendingCurationData(null);
    setAnalysisProgress('');
    showToast('AnÃ¡lise cancelada. VocÃª pode reiniciar quando quiser.', 'info');
  };

  // v1.20.1: Usar storage.fileToBase64 com cache LRU (economia de memÃ³ria)
  // A funÃ§Ã£o storage.fileToBase64 jÃ¡ tem cache e evita reconversÃµes


  // ğŸ” FUNÃ‡Ã•ES: Sistema de Provas

  const analyzeProof = async (proof: Proof, analysisType: string, customInstructions = '', useOnlyMiniRelatorios = false, includeLinkedTopics = false) => {
    const proofId = String(proof.id);
    try {
      proofManager.addAnalyzingProof(proofId);
      setError('');

      // v1.16.2: AnonimizaÃ§Ã£o de provas (ProcessingModeSelector jÃ¡ forÃ§a PDF.js quando ativo)
      // v1.21.3: Adicionado nomesUsuario para anonimizar nomes customizados
      const anonConfig = aiIntegration?.aiSettings?.anonymization;
      const shouldAnonymize = anonConfig?.enabled;
      const nomesParaAnonimizar = anonConfig?.nomesUsuario || [];
      const maybeAnonymize = (text: string) => shouldAnonymize ? anonymizeText(text, anonConfig, nomesParaAnonimizar) : text;

      // Preparar conteÃºdo da prova
      let contentArray: AIMessageContent[] = [];

      // v1.36.28: VerificaÃ§Ã£o robusta - usa type === 'pdf' para compatibilidade com provas existentes
      if (proof.type === 'pdf' || proof.isPdf) {
        // Prova em PDF - v1.21.2: Respeita modo de processamento escolhido
        const proofMode = proofManager.proofProcessingModes?.[proofId] || 'pdfjs';

        if (proofMode === 'pdf-puro') {
          // UsuÃ¡rio escolheu PDF puro explicitamente
          if (shouldAnonymize) {
            // v1.21.9: Fallback para texto extraÃ­do quando anonimizaÃ§Ã£o ativa
            const extractedText = proofManager.extractedProofTexts[proofId];
            if (extractedText) {
              contentArray.push({
                type: 'text' as const,
                text: `PROVA (texto extraÃ­do do PDF):\n\n${maybeAnonymize(extractedText)}`
              });
            } else {
              proofManager.removeAnalyzingProof(proofId);
              showToast('âŒ AnonimizaÃ§Ã£o ativa: extraia o texto primeiro.', 'error');
              return;
            }
          } else {
            if (!proof.file) {
              proofManager.removeAnalyzingProof(proofId);
              showToast('âŒ Arquivo PDF nÃ£o encontrado.', 'error');
              return;
            }
            const base64 = await storage.fileToBase64(proof.file);
            contentArray.push({
              type: 'document' as const,
              source: { type: 'base64' as const, media_type: 'application/pdf' as const, data: base64 }
            });
          }
        } else {
          // UsuÃ¡rio escolheu modo de extraÃ§Ã£o (pdfjs ou claude-vision)
          const extractedText = proofManager.extractedProofTexts[proofId];
          if (extractedText) {
            contentArray.push({
              type: 'text' as const,
              text: `PROVA (texto extraÃ­do do PDF):\n\n${maybeAnonymize(extractedText)}`
            });
          } else {
            proofManager.removeAnalyzingProof(proofId);
            showToast('âŒ Texto nÃ£o extraÃ­do. Extraia o texto da prova antes de analisar.', 'error');
            return;
          }
        }
      } else {
        // Prova em texto
        contentArray.push({
          type: 'text' as const,
          text: `PROVA:\n\n${maybeAnonymize(proof.text || '')}`
        });
      }

      // Buscar tÃ³picos vinculados a esta prova
      const linkedTopicTitles = proofManager.proofTopicLinks[proofId] || [];
      const linkedTopics = selectedTopics.filter(t => linkedTopicTitles.includes(t.title));

      // Preparar prompt baseado no tipo de anÃ¡lise
      let prompt = '';

      if (analysisType === 'livre') {
        if (includeLinkedTopics && linkedTopics.length > 0) {
          // Adicionar tÃ³picos vinculados e mini-relatÃ³rios ao contexto
          const topicsContext = linkedTopics.map((topic, idx) =>
            `ğŸ“‹ TÃ“PICO ${idx + 1}: ${topic.title} (${topic.category})\n\n${topic.relatorio || 'Mini-relatÃ³rio nÃ£o disponÃ­vel'}`
          ).join('\n\n---\n\n');

          contentArray.push({
            type: 'text' as const,
            text: `ğŸ“š TÃ“PICOS VINCULADOS:\n\n${topicsContext}`
          });

          prompt = customInstructions
            ? `Analise a prova a seguir considerando os tÃ³picos vinculados fornecidos.\n\nInstruÃ§Ãµes do usuÃ¡rio:\n${customInstructions}`
            : `Analise a prova a seguir considerando os tÃ³picos vinculados fornecidos. Seja objetivo e direto.`;
        } else {
          // AnÃ¡lise livre simples - apenas prova + instruÃ§Ãµes
          prompt = customInstructions
            ? `Analise a prova a seguir conforme estas instruÃ§Ãµes:\n\n${customInstructions}`
            : `Analise a prova a seguir e forneÃ§a insights relevantes. Seja objetivo e direto.`;
        }
      } else {
        // AnÃ¡lise contextual - Escolher entre documentos completos ou apenas mini-relatÃ³rios

        // Se useOnlyMiniRelatorios estiver ativado E houver tÃ³picos vinculados, usar apenas mini-relatÃ³rios
        if (useOnlyMiniRelatorios && linkedTopics.length > 0) {
          // Adicionar apenas mini-relatÃ³rios dos tÃ³picos vinculados
          const miniRelatoriosText = linkedTopics.map((topic, idx) =>
            `ğŸ“‹ TÃ“PICO ${idx + 1}: ${topic.title} (${topic.category})\n\n${topic.relatorio || 'Mini-relatÃ³rio nÃ£o disponÃ­vel'}`
          ).join('\n\n---\n\n');

          contentArray.push({
            type: 'text' as const,
            text: `ğŸ“š CONTEXTO DOS PEDIDOS VINCULADOS:\n\n${miniRelatoriosText}`
          });
        } else {
          // Comportamento padrÃ£o: usar helper para documentos (evita duplicaÃ§Ã£o)
          const docsArray = buildDocumentContentArray({ includeComplementares: true });
          contentArray.push(...docsArray);
        }

        // Construir resumo do contexto para o prompt
        const totalPeticoes = (analyzedDocuments.peticoes?.length || 0) + (analyzedDocuments.peticoesText?.length || 0);
        const peticaoSummary = useOnlyMiniRelatorios && linkedTopics.length > 0 ?
          'NÃ£o enviado (usando apenas mini-relatÃ³rios)' :
          (totalPeticoes > 0 ?
            `${totalPeticoes} documento${totalPeticoes > 1 ? 's' : ''} do autor fornecido${totalPeticoes > 1 ? 's' : ''} (veja acima)` :
            'PetiÃ§Ã£o inicial nÃ£o disponÃ­vel');

        const totalContestacoes = (analyzedDocuments.contestacoes?.length || 0) + (analyzedDocuments.contestacoesText?.length || 0);
        const contestacoesSummary = useOnlyMiniRelatorios && linkedTopics.length > 0 ?
          'NÃ£o enviado (usando apenas mini-relatÃ³rios)' :
          (totalContestacoes > 0 ?
            `${totalContestacoes} contestaÃ§Ã£o${totalContestacoes > 1 ? 'Ãµes' : ''} fornecida${totalContestacoes > 1 ? 's' : ''} (veja acima)` :
            'Nenhuma contestaÃ§Ã£o disponÃ­vel');

        const totalComplementares = (analyzedDocuments.complementares?.length || 0) + (analyzedDocuments.complementaresText?.length || 0);
        const complementaresSummary = useOnlyMiniRelatorios && linkedTopics.length > 0 ?
          'NÃ£o enviado (usando apenas mini-relatÃ³rios)' :
          (totalComplementares > 0 ?
            `${totalComplementares} documento${totalComplementares > 1 ? 's' : ''} complementar${totalComplementares > 1 ? 'es' : ''} fornecido${totalComplementares > 1 ? 's' : ''} (veja acima)` :
            'Nenhum documento complementar disponÃ­vel');

        prompt = `${customInstructions ? `**INSTRUÃ‡Ã•ES ESPECÃFICAS PARA ESTA PROVA:**\n${customInstructions}\n\n` : ''}VocÃª estÃ¡ analisando uma prova no contexto de um processo trabalhista.

CONTEXTO DO PROCESSO:
- PetiÃ§Ã£o inicial: ${peticaoSummary}
- ContestaÃ§Ãµes: ${contestacoesSummary}
- Documentos complementares: ${complementaresSummary}

${linkedTopics.length > 0 ? `
ğŸ¯ **PEDIDOS ESPECÃFICOS VINCULADOS A ESTA PROVA:**

Esta prova foi vinculada aos seguintes pedidos/tÃ³picos do processo:

${linkedTopics.map((topic, idx) => `
${idx + 1}. **${topic.title}** (${topic.category})

   O que as partes alegaram sobre este pedido:
   ${topic.relatorio || 'Mini-relatÃ³rio nÃ£o disponÃ­vel - verifique a petiÃ§Ã£o e contestaÃ§Ã£o acima'}

   ${topic.editedContent ? `FundamentaÃ§Ã£o parcial jÃ¡ escrita (considere ao analisar):
   ${topic.editedContent}
   ` : 'FundamentaÃ§Ã£o ainda nÃ£o iniciada para este pedido'}
   Resultado parcial: ${topic.resultado || 'Ainda nÃ£o definido'}
`).join('\n---\n')}

**IMPORTANTE:** Ao analisar esta prova no contexto do processo, PRIORIZE sua relaÃ§Ã£o com os pedidos vinculados acima.

Para cada pedido vinculado, indique ESPECIFICAMENTE:
- Como esta prova impacta este pedido em particular
- Se a prova favorece o autor ou rÃ©u neste ponto especÃ­fico
- Qual conclusÃ£o a prova sugere para este pedido

` : `
âš ï¸ Esta prova nÃ£o foi vinculada a nenhum pedido especÃ­fico. A anÃ¡lise serÃ¡ genÃ©rica em relaÃ§Ã£o a todo o processo.

`}
Analise a prova fornecida e responda:

1. **O que esta prova demonstra?** Descreva objetivamente o conteÃºdo probatÃ³rio
2. **RelaÃ§Ã£o com alegaÃ§Ãµes do autor**: Esta prova confirma, refuta ou Ã© neutra em relaÃ§Ã£o Ã s alegaÃ§Ãµes da petiÃ§Ã£o inicial?
3. **RelaÃ§Ã£o com defesa**: Esta prova confirma, refuta ou Ã© neutra em relaÃ§Ã£o aos argumentos de defesa?
4. **ForÃ§a probatÃ³ria**: Avalie a qualidade e relevÃ¢ncia desta prova para o deslinde do feito
5. **ConclusÃ£o**: De forma resumida, qual a contribuiÃ§Ã£o desta prova para a formaÃ§Ã£o do convencimento?

Seja objetivo, tÃ©cnico e imparcial. Base-se exclusivamente no conteÃºdo da prova.

Formato da resposta (use quebras de linha entre seÃ§Ãµes):

CONTEÃšDO DA PROVA:
[descreva o que a prova demonstra]

RELAÃ‡ÃƒO COM ALEGAÃ‡Ã•ES DO AUTOR:
[anÃ¡lise]

RELAÃ‡ÃƒO COM A DEFESA:
[anÃ¡lise]

FORÃ‡A PROBATÃ“RIA:
[avaliaÃ§Ã£o]

CONCLUSÃƒO:
[sÃ­ntese]`;
      }

      contentArray.push({
        type: 'text' as const,
        text: prompt
      });

      // Fazer chamada Ã  API
      // v1.21.26: Parametros para analise critica de provas
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 20000,
        useInstructions: true,
        temperature: 0.3,
        topP: 0.9,
        topK: 50
      });

      // Armazenar resultado
      proofManager.setProofAnalysisResults(prev => ({
        ...prev,
        [proofId]: {
          type: analysisType as 'contextual' | 'livre',
          result: textContent.trim()
        }
      }));

    } catch (err) {
      setError('Erro ao analisar prova: ' + (err as Error).message);
    } finally {
      proofManager.removeAnalyzingProof(proofId);
    }
  };

  const generateRelatorioProcessual = async (contentArray: AIMessageContent[]) => {
    try {
      // Verificar se hÃ¡ modelo personalizado configurado
      const modeloPersonalizado = aiIntegration.aiSettings?.modeloTopicoRelatorio?.trim();

      // Definir o modelo a ser usado
      const modeloBase = modeloPersonalizado || AI_PROMPTS.instrucoesRelatorioPadrao;

      contentArray.push({
        type: 'text' as const,
        text: `Analise todos os documentos fornecidos (petiÃ§Ã£o inicial, contestaÃ§Ãµes e documentos complementares, se houver) e gere um RELATÃ“RIO PROCESSUAL completo seguindo o modelo abaixo.

${modeloPersonalizado ? 'MODELO PERSONALIZADO DO USUÃRIO:' : 'MODELO BASE:'}
${modeloBase}

INSTRUÃ‡Ã•ES IMPORTANTES:

1. ADAPTE o modelo conforme as informaÃ§Ãµes REAIS encontradas nos documentos
2. Se uma informaÃ§Ã£o NÃƒO existir nos documentos, NÃƒO a inclua no relatÃ³rio
3. Se houver informaÃ§Ãµes nos documentos que nÃ£o estÃ£o no modelo, adicione-as de forma apropriada
4. Mantenha a estrutura e formataÃ§Ã£o do modelo
5. Use primeira pessoa quando apropriado
6. Seja objetivo e factual
7. Extraia informaÃ§Ãµes precisas:
   - Nomes completos das partes
   - PerÃ­odo de trabalho (datas)
   - FunÃ§Ã£o exercida
   - RemuneraÃ§Ã£o
   - Valor da causa
   - Pedidos principais
   - Defesas apresentadas
   - Provas produzidas (perÃ­cias, testemunhas, documentos)
   - AudiÃªncias realizadas
   - Tentativas de conciliaÃ§Ã£o

8. Se houver mÃºltiplas reclamadas, adapte o texto (primeira reclamada, segunda reclamada, etc.)
9. Se nÃ£o houver contestaÃ§Ã£o, adapte o texto correspondente
10. Se nÃ£o houver prova pericial, omita esse parÃ¡grafo
11. Se nÃ£o houver testemunhas, adapte o texto
12. Mantenha sempre "DECIDE-SE." no final

${AI_PROMPTS.numeracaoReclamadas}

${AI_PROMPTS.formatacaoHTML("<strong>JOÃƒO DA SILVA</strong>, qualificado na inicial...")}

${AI_PROMPTS.formatacaoParagrafos("<p>JOÃƒO DA SILVA, qualificado na inicial...</p><p>Em defesa, a reclamada...</p>")}

${AI_PROMPTS.estiloRedacao}

${AI_PROMPTS.preservarAnonimizacao}

Responda APENAS com o texto do relatÃ³rio formatado em HTML, pronto para ser inserido na sentenÃ§a. NÃ£o adicione explicaÃ§Ãµes ou comentÃ¡rios.`
      });

      // v1.21.26: Parametros para texto juridico (balanceado)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 8000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.4,
        topP: 0.9,
        topK: 60
      });

      // Normalizar espaÃ§amento para evitar linhas em branco duplicadas
      return normalizeHTMLSpacing(textContent.trim());
    } catch (err) {
      return `SENTENÃ‡A

I - RELATÃ“RIO

RelatÃ³rio processual nÃ£o pÃ´de ser gerado automaticamente. Por favor, edite este tÃ³pico manualmente.

DECIDE-SE.`;
    }
  };

  // v1.19.2: Normalizar comparaÃ§Ãµes case-insensitive
  const toggleTopicSelection = (topic: Topic) => {
    const topicTitleUpper = (topic.title || '').toUpperCase().trim();
    const exists = selectedTopics.find(t => (t.title || '').toUpperCase().trim() === topicTitleUpper);
    if (exists) {
      // Remover tÃ³pico se jÃ¡ estÃ¡ selecionado
      setSelectedTopics(selectedTopics.filter(t => (t.title || '').toUpperCase().trim() !== topicTitleUpper));
    } else {
      // Adicionar tÃ³pico
      const newTopic = { ...topic, order: selectedTopics.length };
      
      // Se for RELATÃ“RIO, adicionar no inÃ­cio
      if (isRelatorio(topic)) {
        setSelectedTopics([newTopic, ...selectedTopics]);
        return;
      }

      // Se for DISPOSITIVO, adicionar no final
      if (isDispositivo(topic)) {
        setSelectedTopics([...selectedTopics, newTopic]);
        return;
      }

      // Para qualquer outro tÃ³pico, inserir antes do DISPOSITIVO
      const dispositivoIndex = selectedTopics.findIndex((t: Topic) => isDispositivo(t));
      
      if (dispositivoIndex !== -1) {
        // DISPOSITIVO existe - inserir antes dele
        const newTopics = [...selectedTopics];
        newTopics.splice(dispositivoIndex, 0, newTopic);
        setSelectedTopics(newTopics);
      } else {
        // DISPOSITIVO nÃ£o existe - adicionar no final
        setSelectedTopics([...selectedTopics, newTopic]);
      }
    }
  };

  const deleteTopic = (topicToDelete: Topic) => {
    setTopicToDelete(topicToDelete);
    openModal('deleteTopic');
  };

  const confirmDeleteTopic = () => {
    if (topicToDelete) {
      // Remove dos tÃ³picos extraÃ­dos
      setExtractedTopics(extractedTopics.filter(t => t.title !== topicToDelete.title));
      // Remove dos tÃ³picos selecionados caso esteja lÃ¡
      setSelectedTopics(selectedTopics.filter(t => t.title !== topicToDelete.title));
      // Remove dos tÃ³picos para mesclar caso esteja lÃ¡
      setTopicsToMerge(topicsToMerge.filter((t: Topic) => t.title !== topicToDelete.title));
    }
    closeModal('deleteTopic');
    setTopicToDelete(null);
  };

  const moveTopicUp = (index: number) => {
    if (index === 0) return;
    
    // Bloquear movimento de RELATÃ“RIO e DISPOSITIVO
    const topic = selectedTopics[index];
    const targetTopic = selectedTopics[index - 1];
    
    if (isSpecialTopic(topic)) {
      return;
    }

    if (isSpecialTopic(targetTopic)) {
      return;
    }

    const newTopics = [...selectedTopics];
    [newTopics[index - 1], newTopics[index]] = [newTopics[index], newTopics[index - 1]];
    setSelectedTopics(newTopics);
  };

  const moveTopicDown = (index: number) => {
    if (index === selectedTopics.length - 1) return;

    // Bloquear movimento de RELATÃ“RIO e DISPOSITIVO
    const topic = selectedTopics[index];
    const targetTopic = selectedTopics[index + 1];

    if (isSpecialTopic(topic)) {
      return;
    }

    if (isSpecialTopic(targetTopic)) {
      return;
    }

    const newTopics = [...selectedTopics];
    [newTopics[index], newTopics[index + 1]] = [newTopics[index + 1], newTopics[index]];
    setSelectedTopics(newTopics);
  };

  const moveTopicToPosition = (currentIndex: number, newPosition: number) => {
    if (newPosition < 1 || newPosition > selectedTopics.length) return;
    const newIndex = newPosition - 1;
    if (currentIndex === newIndex) return;

    // Bloquear movimento de RELATÃ“RIO e DISPOSITIVO
    const topic = selectedTopics[currentIndex];
    const targetTopic = selectedTopics[newIndex];

    if (isSpecialTopic(topic)) {
      return;
    }

    if (isSpecialTopic(targetTopic)) {
      return;
    }

    const newTopics = [...selectedTopics];
    const [movedTopic] = newTopics.splice(currentIndex, 1);
    newTopics.splice(newIndex, 0, movedTopic);
    setSelectedTopics(newTopics);
  };

  // Lista de stopwords para filtrar
  const STOPWORDS = new Set([
    'de', 'da', 'do', 'dos', 'das', 'para', 'com', 'sem', 'por', 'pelo', 'pela',
    'em', 'no', 'na', 'nos', 'nas', 'ao', 'aos', 'Ã ', 'Ã s', 'um', 'uma', 'uns', 'umas',
    'o', 'a', 'os', 'as', 'e', 'ou', 'mas', 'que', 'qual', 'quando', 'onde', 'como'
  ]);

  // Sistema de pontuaÃ§Ã£o local para filtrar candidatos
  const scoreModel = (model: Model, topicTitle: string, topicCategory: string, topicRelatorio: string) => {
    let score = 0;

    const titleLower = topicTitle.toLowerCase();
    const modelTitleLower = model.title.toLowerCase();

    // Remover stopwords e pegar palavras relevantes
    const titleWords = titleLower.split(/\s+/)
      .filter((w: string) => w.length > 2 && !STOPWORDS.has(w));
    const modelWords = modelTitleLower.split(/\s+/)
      .filter((w: string) => w.length > 2 && !STOPWORDS.has(w));

    // 1. CorrespondÃªncia exata de palavras (peso 10)
    titleWords.forEach((titleWord: string) => {
      if (modelWords.includes(titleWord)) {
        score += 10;
      }
    });

    // 2. CorrespondÃªncia parcial de palavras (peso 5)
    titleWords.forEach((titleWord: string) => {
      modelWords.forEach((modelWord: string) => {
        if (titleWord !== modelWord && (titleWord.includes(modelWord) || modelWord.includes(titleWord))) {
          score += 5;
        }
      });
    });

    // 3. Keywords (peso 12 - mais importante)
    if (model.keywords) {
      const kwStr = Array.isArray(model.keywords) ? model.keywords.join(',') : model.keywords;
      const keywords = kwStr.toLowerCase().split(',')
        .map((k: string) => k.trim())
        .filter((k: string) => k.length > 0);

      keywords.forEach((keyword: string) => {
        if (titleLower.includes(keyword) || keyword.includes(titleLower.replace(/\s+/g, ''))) {
          score += 12;
        }

        // Verificar tambÃ©m no mini-relatÃ³rio
        if (topicRelatorio && topicRelatorio.toLowerCase().includes(keyword)) {
          score += 3;
        }
      });
    }

    // 4. Palavras do tÃ­tulo do modelo aparecem no mini-relatÃ³rio (peso 2)
    if (topicRelatorio) {
      const relatorioLower = topicRelatorio.toLowerCase();
      modelWords.forEach((word: string) => {
        if (relatorioLower.includes(word)) {
          score += 2;
        }
      });
    }

    return score;
  };

  // Refinamento semÃ¢ntico com IA (para top candidatos)
  // v1.35.8: useCallback para evitar re-criaÃ§Ã£o a cada render (causa lag no textarea)
  const refineWithAI = React.useCallback(async (topCandidates: Model[], topicTitle: string, topicCategory: string, topicRelatorio: string) => {
    if (topCandidates.length === 0) return [];

    try {
      const prompt = `${AI_PROMPTS.roles.relevancia}

CONTEXTO DO TÃ“PICO:
TÃ­tulo: ${topicTitle}
Categoria: ${topicCategory || 'NÃ£o especificada'}
Mini-relatÃ³rio: ${topicRelatorio || 'NÃ£o disponÃ­vel'}

MODELOS CANDIDATOS:
${topCandidates.map((m: Model, i: number) => `${i + 1}. [ID: ${m.id}] ${m.title}
   Categoria: ${m.category || 'N/A'}
   Keywords: ${m.keywords || 'N/A'}
   Resumo: ${m.content || 'N/A'}`).join('\n\n')}

TAREFA:
Analise semanticamente qual desses modelos Ã© mais relevante para o tÃ³pico em questÃ£o.
Considere:
1. Similaridade temÃ¡tica entre tÃ­tulo do tÃ³pico e tÃ­tulo do modelo
2. RelevÃ¢ncia das keywords com o contexto do mini-relatÃ³rio
3. Categoria compatÃ­vel
4. Aplicabilidade do conteÃºdo do modelo ao contexto do tÃ³pico

Responda APENAS com um array JSON contendo os IDs dos modelos ordenados por relevÃ¢ncia (do mais relevante ao menos relevante).
Formato: ["id1", "id2", "id3", ...]

Inclua APENAS modelos que sejam realmente relevantes. Se nenhum for relevante, retorne array vazio: []`;

      // Usar Sonnet 4.5 (modelo padrÃ£o) para recomendaÃ§Ã£o de modelos
      const apiRequest = aiIntegration.buildApiRequest([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], 1000);

      // Sobrescrever modelo para Sonnet 4.5 (modelo padrÃ£o recomendado)
      apiRequest.model = 'claude-sonnet-4-20250514';

      let textContent;
      try {
        // v1.21.26: Parametros deterministicos para ranking de modelos
        // v1.30: Removido model explÃ­cito - usa provider/modelo das configuraÃ§Ãµes
        textContent = await aiIntegration.callAI(apiRequest.messages as AIMessage[], {
          maxTokens: 300,
          useInstructions: false,
          disableThinking: true,
          logMetrics: true,
          temperature: 0.0,
          topP: 0.9,
          topK: 40
        });
      } catch (err) {
        return topCandidates; // Retorna candidatos sem reordenar
      }

      // Extrair array JSON da resposta
      const jsonMatch = textContent.match(/\[[\s\S]*?\]/);
      if (!jsonMatch) {
        return topCandidates;
      }

      const rankedIds = JSON.parse(jsonMatch[0]);

      // Reordenar modelos baseado no ranking da IA
      const ranked: Model[] = [];
      rankedIds.forEach((id: string) => {
        const model = topCandidates.find((m: Model) => m.id === id);
        if (model) ranked.push(model);
      });

      // Adicionar modelos que nÃ£o foram ranqueados pela IA (se houver)
      topCandidates.forEach((m: Model) => {
        if (!ranked.find((r: Model) => r.id === m.id)) {
          ranked.push(m);
        }
      });

      return ranked;

    } catch (error) {
      return topCandidates; // Retorna candidatos sem reordenar em caso de erro
    }
  }, [aiIntegration.buildApiRequest, aiIntegration.callAI]);

  // ğŸš€ v1.8.2: FunÃ§Ã£o principal de busca de sugestÃµes (hÃ­brida - COM CACHE)
  // v1.28.02: Suporte a IA Local via embeddings
  // v1.35.8: useCallback para evitar re-criaÃ§Ã£o a cada render (causa lag no textarea de "regenerar com IA")
  const findSuggestions = React.useCallback(async (topic: Topic) => {
    // v1.29.05: NÃ£o gerar sugestÃµes para tÃ³picos especiais (RELATÃ“RIO e DISPOSITIVO)
    if (isSpecialTopic(topic)) return { suggestions: [], source: null };
    // v1.28.02: IA Local para sugestÃµes (sem API Claude)
    // v1.35.74: Usa aiSettings unificado
    if (aiIntegration.aiSettings.useLocalAIForSuggestions && searchModelReady && modelLibrary.models.some(m => m.embedding?.length === 768)) {
      if (!topic?.title || topic.title.length < 3) return { suggestions: [], source: null }; // v1.28.05
      // v1.32.22: Usar apenas tÃ­tulo para query mais focada (categoria e relatÃ³rio diluem relevÃ¢ncia)
      const topicText = topic.title;
      const cacheKey = `suggestions_local_${topicText}`;
      const cached = apiCache.get(cacheKey);
      if (cached && typeof cached === 'string') return JSON.parse(cached); // v1.28.05: cache jÃ¡ tem formato { suggestions, source }
      try {
        await new Promise(r => setTimeout(r, 0)); // v1.28.03: Yield para UI nÃ£o congelar
        // v1.32.20: toLowerCase para E5 case-sensitive
        const qEmb = await AIModelService.getEmbedding(topicText.toLowerCase(), 'query');
        const threshold = (aiIntegration.aiSettings.modelSemanticThreshold || 60) / 100;
        const results = modelLibrary.models
          .filter(m => m.embedding?.length === 768)
          .map(m => ({ ...m, similarity: AIModelService.cosineSimilarity(qEmb, m.embedding || []) }))
          .filter(m => m.similarity >= threshold)
          .sort((a, b) => b.similarity - a.similarity)
          .slice(0, 5);
        const result = { suggestions: results, source: 'local' }; // v1.28.05
        apiCache.set(cacheKey, JSON.stringify(result));
        return result;
      } catch { /* fallback para sistema atual */ }
    }

    if (!topic || !topic.title || topic.title.length < 3) return { suggestions: [], source: null };
    if (modelLibrary.models.length === 0) return { suggestions: [], source: null };

    const topicTitle = topic.title;
    const topicCategory = topic.category;
    const topicRelatorio = topic.relatorio || topic.editedRelatorio || '';

    // ğŸš€ v1.8.2: Cache key baseado em tÃ­tulo + categoria + relatÃ³rio do tÃ³pico
    const cacheKey = `suggestions_${topicTitle}_${topicCategory}_${topicRelatorio}`;

    // ğŸš€ v1.8.2: Verificar cache antes de processar
    const cachedResult = apiCache.get(cacheKey);
    if (cachedResult && typeof cachedResult === 'string') {
      return JSON.parse(cachedResult); // v1.28.04: jÃ¡ inclui { suggestions, source }
    }

    // PASSO 1: PontuaÃ§Ã£o local
    const scoredModels = modelLibrary.models.map(model => ({
      model,
      score: scoreModel(model, topicTitle, topicCategory, topicRelatorio)
    })).filter(item => item.score > 0); // Filtrar apenas com alguma relevÃ¢ncia

    // Ordenar por score
    scoredModels.sort((a, b) => b.score - a.score);

    // Pegar top 10 candidatos para refinamento com IA
    const topCandidates = scoredModels.slice(0, 10).map(item => item.model);

    if (topCandidates.length === 0) return { suggestions: [], source: null };

    // PASSO 2: Refinamento semÃ¢ntico com IA (apenas para top candidatos)
    const refinedModels = await refineWithAI(topCandidates, topicTitle, topicCategory, topicRelatorio);

    // Retornar top 5 modelos mais relevantes
    const topSuggestions = refinedModels.slice(0, 5);
    const result = { suggestions: topSuggestions, source: 'api' }; // v1.28.04

    // ğŸš€ v1.8.2: Cachear sugestÃµes refinadas
    apiCache.set(cacheKey, JSON.stringify(result));

    return result;
  }, [aiIntegration.aiSettings.useLocalAIForSuggestions, searchModelReady, modelLibrary.models, aiIntegration.aiSettings.modelSemanticThreshold, apiCache, refineWithAI]);

  const startEditing = async (topic: Topic) => {
    const topicCopy = {
      ...topic,
      editedFundamentacao: topic.editedFundamentacao || topic.fundamentacao || '',
      editedRelatorio: topic.editedRelatorio || topic.relatorio || ''
    };
    setEditingTopic(topicCopy);
    modelLibrary.setSuggestions([]); // Limpar sugestÃµes antigas primeiro
    modelLibrary.setLoadingSuggestions(true); // Indicar que estÃ¡ carregando
    setActiveTab('editor');

    // Scroll suave para o inÃ­cio da Ã¡rea de ediÃ§Ã£o
    setTimeout(() => {
      if (editorContainerRef.current) {
        editorContainerRef.current.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    }, 100);

    // Buscar sugestÃµes de forma assÃ­ncrona (nÃ£o bloqueia a abertura do editor)
    try {
      const { suggestions, source } = await findSuggestions(topicCopy); // v1.28.04
      modelLibrary.setSuggestions(suggestions);
      modelLibrary.setSuggestionsSource(source);
    } catch (error) {
      modelLibrary.setSuggestions([]);
      modelLibrary.setSuggestionsSource(null);
    } finally {
      modelLibrary.setLoadingSuggestions(false);
    }
  };

  const insertModelContent = (content: string) => {
    if (editorRef.current && editingTopic) {
      const quill = editorRef.current;

      // Obter posiÃ§Ã£o do cursor (ou fim do documento se nÃ£o houver seleÃ§Ã£o)
      const range = quill.getSelection();
      const position = range ? range.index : quill.getLength() - 1;

      // Sanitizar conteÃºdo antes de inserir
      const sanitizedContent = sanitizeHTML(content);

      // Inserir quebras de linha antes do conteÃºdo
      quill.insertText(position, '\n\n');

      // Inserir HTML na posiÃ§Ã£o do cursor + 2 (apÃ³s as quebras)
      quill.clipboard.dangerouslyPasteHTML(position + 2, sanitizedContent);

      // Mover cursor para o final do conteÃºdo inserido
      try {
        const delta = quill.clipboard.convert(sanitizedContent) as QuillDelta | null;
        // QuillDelta.length() Ã© um mÃ©todo - calcular manualmente
        let insertedLength = 0;
        if (delta?.ops) {
          for (const op of delta.ops) {
            if (typeof op.insert === 'string') {
              insertedLength += op.insert.length;
            } else if (op.insert) {
              insertedLength += 1;
            }
          }
        }
        quill.setSelection(position + 2 + insertedLength);
      } catch {
        // Fallback: mover para o final
        quill.setSelection(quill.getLength());
      }

      // Atualizar estado com o novo HTML
      const newHTML = sanitizeHTML(quill.root.innerHTML);
      setEditingTopic({
        ...editingTopic,
        editedFundamentacao: newHTML
      });
    }
  };

  // FunÃ§Ã£o para detectar automaticamente o resultado do julgamento usando IA
  const detectResultadoAutomatico = async (topicTitle: string, decisionText: string, topicCategory: string) => {
    // NÃ£o detectar para RELATÃ“RIO e DISPOSITIVO
    if (topicTitle.toUpperCase() === 'RELATÃ“RIO' || topicTitle.toUpperCase() === 'DISPOSITIVO') {
      return null;
    }

    // Se nÃ£o hÃ¡ texto de decisÃ£o, nÃ£o detectar
    if (!decisionText || decisionText.trim() === '') {
      return null;
    }

    try {
      const plainText = htmlToPlainText(decisionText);

      const prompt = `${AI_PROMPTS.roles.classificacao}

TÃ“PICO SENDO ANALISADO:
TÃ­tulo: ${topicTitle}
Categoria: ${topicCategory || 'NÃ£o especificada'}

TEXTO DA DECISÃƒO ESCRITA PELO USUÃRIO:
${plainText}

TAREFA:
Analise o texto da decisÃ£o e identifique o resultado do julgamento.

OPÃ‡Ã•ES POSSÃVEIS (escolha UMA):
1. PROCEDENTE - quando o pedido foi totalmente deferido/acolhido
2. IMPROCEDENTE - quando o pedido foi totalmente indeferido/rejeitado
3. PARCIALMENTE PROCEDENTE - quando o pedido foi parcialmente deferido
4. ACOLHIDO - quando uma preliminar, exceÃ§Ã£o ou questÃ£o processual foi acolhida
5. REJEITADO - quando uma preliminar, exceÃ§Ã£o ou questÃ£o processual foi rejeitada
6. SEM RESULTADO - para tÃ³picos administrativos/acessÃ³rios sem julgamento de mÃ©rito
7. INDEFINIDO - quando o texto nÃ£o deixa claro o resultado ou estÃ¡ incompleto

CRITÃ‰RIOS DE ANÃLISE:
- Procure por palavras-chave como: "defiro", "indefiro", "julgo procedente", "julgo improcedente", "parcialmente", "acolho", "rejeito"
- Considere o contexto geral do texto
- Se a categoria for PRELIMINAR, prefira ACOLHIDO/REJEITADO
- Se a categoria for MÃ‰RITO, prefira PROCEDENTE/IMPROCEDENTE/PARCIALMENTE PROCEDENTE
- Se o tÃ³pico tratar de deduÃ§Ãµes previdenciÃ¡rias, prazos e condiÃ§Ãµes para cumprimento da decisÃ£o, juros ou correÃ§Ã£o monetÃ¡ria, retorne SEM RESULTADO
- Se houver dÃºvida ou o texto estiver incompleto, retorne INDEFINIDO

Responda APENAS com uma das palavras: PROCEDENTE, IMPROCEDENTE, PARCIALMENTE PROCEDENTE, ACOLHIDO, REJEITADO, SEM RESULTADO ou INDEFINIDO.
NÃ£o adicione explicaÃ§Ãµes, pontos finais ou outros caracteres. Apenas a palavra.`;

      // v1.21.26: Parametros deterministicos para classificacao
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: [{ type: 'text', text: prompt }]
      }], {
        maxTokens: 500,
        useInstructions: false,
        logMetrics: true,
        temperature: 0.0,
        topP: 0.9,
        topK: 20
      });

      const resultado = textContent.toUpperCase();

      // Validar resultado
      const resultadosValidos = ['PROCEDENTE', 'IMPROCEDENTE', 'PARCIALMENTE PROCEDENTE', 'ACOLHIDO', 'REJEITADO', 'SEM RESULTADO', 'INDEFINIDO'];

      if (resultadosValidos.includes(resultado)) {
        // Se for INDEFINIDO, retornar null para nÃ£o sobrescrever escolha manual do usuÃ¡rio
        return resultado === 'INDEFINIDO' ? null : resultado;
      } else {
        return null;
      }

    } catch (error) {
      return null;
    }
  };

  const saveTopicEdit = async () => {
    if (!editingTopic) return;
    setSavingTopic(true);
    try {
      const isRelatorio = editingTopic.title.toUpperCase() === 'RELATÃ“RIO';
      const isDispositivo = editingTopic.title.toUpperCase() === 'DISPOSITIVO';

      // Validar refs baseado no tipo de tÃ³pico
      if (isRelatorio && !relatorioRef.current) return;
      if (isDispositivo && !editorRef.current) return;
      if (!isRelatorio && !isDispositivo && (!editorRef.current || !relatorioRef.current)) return;

      // Capturar conteÃºdo dos editores (apenas os que existem)
            const content = editorRef.current ? sanitizeHTML(editorRef.current.root.innerHTML) : '';
            const relatorio = relatorioRef.current ? sanitizeHTML(relatorioRef.current.root.innerHTML) : '';

      let updatedTopic = {
        ...editingTopic,
        editedRelatorio: relatorio,
        relatorio: htmlToPlainText(relatorio)
      };

            if (isDispositivo) {
        updatedTopic.editedContent = content;
      } else if (!isRelatorio) {
        // Apenas tÃ³picos normais (nÃ£o RELATÃ“RIO, nÃ£o DISPOSITIVO) usam editedFundamentacao
        updatedTopic.editedFundamentacao = content;
      }

      // Detectar resultado automaticamente APENAS se nÃ£o foi escolha manual do usuÃ¡rio
      // Isso permite re-detecÃ§Ã£o quando o usuÃ¡rio muda o texto da decisÃ£o
      if (!updatedTopic.resultadoManual) {
        const resultadoDetectado = await detectResultadoAutomatico(
          updatedTopic.title || '',
          content,
          updatedTopic.category || ''
        );

        if (resultadoDetectado) {
          updatedTopic.resultado = resultadoDetectado;
        }
      }

      const updatedTopics = selectedTopics.map(t =>
        t.title === editingTopic.title ? updatedTopic : t
      );
      setSelectedTopics(updatedTopics);

      // Atualizar tambÃ©m em extractedTopics
      const extractedIndex = extractedTopics.findIndex((t: Topic) => t.title === editingTopic.title);
      if (extractedIndex !== -1) {
        const newExtracted = [...extractedTopics];
        newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], resultado: updatedTopic.resultado };
        setExtractedTopics(newExtracted);
      }

      setLastEditedTopicTitle(editingTopic.title);
      setEditingTopic(null);
      modelLibrary.setSuggestions([]);
      setActiveTab('topics');
    } finally {
      setSavingTopic(false);
    }
  };

  const saveTopicEditWithoutClosing = async () => {
    if (!editingTopic) return;
    setSavingTopic(true);
    try {
      const isRelatorio = editingTopic.title.toUpperCase() === 'RELATÃ“RIO';
      const isDispositivo = editingTopic.title.toUpperCase() === 'DISPOSITIVO';

      // Validar refs baseado no tipo de tÃ³pico
      if (isRelatorio && !relatorioRef.current) return;
      if (isDispositivo && !editorRef.current) return;
      if (!isRelatorio && !isDispositivo && (!editorRef.current || !relatorioRef.current)) return;

      // Capturar conteÃºdo dos editores (apenas os que existem)
            const content = editorRef.current ? sanitizeHTML(editorRef.current.root.innerHTML) : '';
            const relatorio = relatorioRef.current ? sanitizeHTML(relatorioRef.current.root.innerHTML) : '';

      let updatedTopic = {
        ...editingTopic,
        editedRelatorio: relatorio,
        relatorio: htmlToPlainText(relatorio)
      };

            if (isDispositivo) {
        updatedTopic.editedContent = content;
      } else if (!isRelatorio) {
        // Apenas tÃ³picos normais (nÃ£o RELATÃ“RIO, nÃ£o DISPOSITIVO) usam editedFundamentacao
        updatedTopic.editedFundamentacao = content;
      }

      // BotÃ£o "Salvar e Fechar" (saveTopicEdit) continua com detecÃ§Ã£o automÃ¡tica

      const updatedTopics = selectedTopics.map(t =>
        t.title === editingTopic.title ? updatedTopic : t
      );
      setSelectedTopics(updatedTopics);

      // Atualizar tambÃ©m em extractedTopics
      const extractedIndex = extractedTopics.findIndex((t: Topic) => t.title === editingTopic.title);
      if (extractedIndex !== -1) {
        const newExtracted = [...extractedTopics];
        newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], resultado: updatedTopic.resultado };
        setExtractedTopics(newExtracted);
      }

      // Atualizar tambÃ©m o editingTopic com os dados salvos
      setEditingTopic(updatedTopic);

      setLastEditedTopicTitle(editingTopic.title);

      // Feedback visual simples (sem detecÃ§Ã£o de resultado)
      const successMsg = document.createElement('div');
      successMsg.className = 'fixed top-4 left-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-pulse';
      successMsg.innerHTML = '<span>âœ“</span> Salvo!';

      document.body.appendChild(successMsg);
      setTimeout(() => successMsg.remove(), 3000);
    } finally {
      setSavingTopic(false);
    }
  };

  const exportDecision = async () => {
    if (selectedTopics.length === 0) {
      setError('Nenhum tÃ³pico selecionado para exportar');
      return;
    }

    setError('');
    
    try {
      let plainText = 'SENTENÃ‡A\n\n';

      // HTML otimizado para Google Docs e Word
      let htmlText = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
  body { 
    font-family: 'Times New Roman', Times, serif; 
    font-size: 12pt; 
    line-height: 1.5; 
    margin: 2.54cm;
  }
  h1 { 
    text-align: center; 
    font-size: 14pt; 
    font-weight: bold; 
    margin-bottom: 20px;
    text-transform: uppercase;
  }
  h2 { 
    font-size: 12pt; 
    font-weight: bold; 
    margin-top: 20px; 
    margin-bottom: 10px;
    text-transform: uppercase;
  }
  p { 
    margin: 0 0 12px 0; 
    text-align: justify; 
    text-indent: 0;
  }
  ul, ol { 
    margin: 10px 0; 
    padding-left: 40px; 
  }
  li { 
    margin-bottom: 6px; 
  }
  b, strong { 
    font-weight: bold; 
  }
  i, em { 
    font-style: italic; 
  }
  u { 
    text-decoration: underline; 
  }
  .section { 
    margin-bottom: 30px; 
  }
  .fundamentacao-header {
    text-align: left;
    font-weight: bold;
    font-size: 12pt;
    margin: 30px 0 20px 0;
    text-transform: uppercase;
  }
</style>
</head>
<body>
<h1 style="${EXPORT_STYLES.h1}">SENTENÃ‡A</h1>
`;

      selectedTopics.forEach((topic, index) => {
        // Remover numeraÃ§Ã£o romana do tÃ­tulo
        let topicTitle = topic.title.toUpperCase();
        topicTitle = topicTitle.replace(/^I\s*[-â€“]\s*/i, '');
        topicTitle = topicTitle.replace(/^II\s*[-â€“]\s*/i, '');
        topicTitle = topicTitle.replace(/^III\s*[-â€“]\s*/i, '');
        topicTitle = topicTitle.replace(/^IV\s*[-â€“]\s*/i, '');
        topicTitle = topicTitle.replace(/^V\s*[-â€“]\s*/i, '');

        plainText += `\n${topicTitle}\n\n`;

        htmlText += `<div style="${EXPORT_STYLES.section}">`;
        htmlText += `<h2 style="${EXPORT_STYLES.h2}">${topicTitle}</h2>`;
        
                const isRelatorio = topic.title.toUpperCase() === 'RELATÃ“RIO';
        const isDispositivo = topic.title.toUpperCase() === 'DISPOSITIVO';

        if (isRelatorio) {
          // RELATÃ“RIO: apenas editedRelatorio
          const relatorioHtml = topic.editedRelatorio || topic.relatorio || '';
          if (relatorioHtml) {
            htmlText += cleanHtmlForExport(relatorioHtml);
            plainText += htmlToFormattedText(relatorioHtml) + '\n\n';
          }
        } else if (isDispositivo) {
          // DISPOSITIVO: apenas editedContent
          if (topic.editedContent) {
            htmlText += cleanHtmlForExport(topic.editedContent);
            plainText += htmlToFormattedText(topic.editedContent) + '\n\n';
          }
        } else {
          // TÃ³picos normais: mini-relatÃ³rio + fundamentaÃ§Ã£o
          const relatorioHtml = topic.editedRelatorio || topic.relatorio || '';
          if (relatorioHtml) {
            htmlText += cleanHtmlForExport(relatorioHtml);
            plainText += htmlToFormattedText(relatorioHtml) + '\n\n';
          }
          if (topic.editedFundamentacao) {
            htmlText += cleanHtmlForExport(topic.editedFundamentacao);
            plainText += htmlToFormattedText(topic.editedFundamentacao) + '\n\n';
          }
        }
        
        htmlText += `</div>`;
        
        // Adicionar "FUNDAMENTAÃ‡ÃƒO" apÃ³s o primeiro tÃ³pico (RELATÃ“RIO)
        if (index === 0) {
          plainText += '\nFUNDAMENTAÃ‡ÃƒO\n\n';
          htmlText += `<div style="${EXPORT_STYLES.fundamentacaoHeader}">FUNDAMENTAÃ‡ÃƒO</div>`;
        }
      });

      htmlText += `
</body>
</html>`;

      setExportedText(plainText);
      setExportedHtml(htmlText);
      openModal('export');
      
      try {
        // Tentar copiar com formataÃ§Ã£o rica
        const htmlBlob = new Blob([htmlText], { type: 'text/html' });
        const textBlob = new Blob([plainText], { type: 'text/plain' });
        
        await navigator.clipboard.write([
          new ClipboardItem({
            'text/html': htmlBlob,
            'text/plain': textBlob
          })
        ]);
        
        if (copyTimeoutRef.current) clearTimeout(copyTimeoutRef.current);
        setCopySuccess(true);
        copyTimeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
      } catch (clipErr) {
        // Fallback: formato rico falhou, tentar texto simples
        try {
          await navigator.clipboard.writeText(plainText);
          if (copyTimeoutRef.current) clearTimeout(copyTimeoutRef.current);
          setCopySuccess(true);
          copyTimeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
        } catch (err2) {
          setError('NÃ£o foi possÃ­vel copiar automaticamente. Use o botÃ£o "Copiar Novamente" no modal.');
        }
      }
    } catch (err) {
      setError('Erro ao exportar decisÃ£o: ' + (err as Error).message);
    }
  };

  const generateDispositivo = async () => {
    if (selectedTopics.length === 0) {
      setError('Nenhum tÃ³pico selecionado. Adicione e preencha os tÃ³picos antes de gerar o dispositivo.');
      return;
    }

    // ğŸš€ v1.14.1: Cache removido - dispositivo sempre deve refletir dados atuais

    // Verificar se hÃ¡ tÃ³picos decididos sem resultado selecionado (exceto RELATÃ“RIO, DISPOSITIVO e complementares)
    const topicsWithoutResult = selectedTopics.filter(t =>
      isTopicDecidido(t) &&
      !t.resultado &&
      t.title.toUpperCase() !== 'RELATÃ“RIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO' &&
      !t.isComplementar // Ignora tÃ³picos complementares
    );
    
    if (topicsWithoutResult.length > 0) {
      const titulosFaltando = topicsWithoutResult.map(t => `"${t.title}"`).join(', ');
      setError(`Os seguintes tÃ³picos estÃ£o decididos mas sem resultado selecionado: ${titulosFaltando}. Por favor, selecione o resultado (Procedente/Improcedente/etc) antes de gerar o dispositivo.`);
      return;
    }

    aiIntegration.setGeneratingDispositivo(true);
    setError('');

    try {
      // Preparar resumo de cada tÃ³pico com sua decisÃ£o

      // Filtrar o tÃ³pico RELATÃ“RIO (nÃ£o Ã© um pedido) - usando valor memoizado
      const topicsSummary = topicsParaDispositivo.map(topic => {
        const relatorio = topic.editedRelatorio ? htmlToFormattedText(topic.editedRelatorio) : (topic.relatorio || '');

                const isDispositivo = topic.title.toUpperCase() === 'DISPOSITIVO';
        const decisao = isDispositivo
          ? (topic.editedContent ? htmlToFormattedText(topic.editedContent) : '')
          : (topic.editedFundamentacao ? htmlToFormattedText(topic.editedFundamentacao) : '');

        // Marcar explicitamente tÃ³picos sem decisÃ£o
        const temDecisao = decisao && decisao.trim() !== '' && decisao.trim() !== 'Sem decisÃ£o preenchida';

        // Usar o resultado SELECIONADO PELO USUÃRIO (nÃ£o extrair do texto)
        const resultadoSelecionado = topic.resultado || 'NÃƒO DEFINIDO';

        return {
          titulo: topic.title,
          categoria: topic.category,
          relatorio: relatorio || '',
          decisao: temDecisao ? (decisao || '') : 'SEM DECISÃƒO PREENCHIDA',
          resultado: resultadoSelecionado,
          temDecisao: temDecisao
        };
      });

      const topicosComDecisao = topicsSummary.filter(t => t.temDecisao);
      const topicosSemDecisao = topicsSummary.filter(t => !t.temDecisao);

      const topicoRelatorio = selectedTopics.find(isRelatorio);
      let primeiroParagrafoRelatorio = '';

      if (topicoRelatorio) {
        const relatorioCompleto = topicoRelatorio.editedRelatorio
          ? htmlToFormattedText(topicoRelatorio.editedRelatorio)
          : (topicoRelatorio.relatorio || '');

        // Divide em linhas e remove vazias
        const linhas = relatorioCompleto.split('\n').map(l => l.trim()).filter(l => l.length > 0);

        // Procura primeiro parÃ¡grafo substancial (ignora tÃ­tulos curtos sem pontuaÃ§Ã£o interna)
        let paragrafoEncontrado = '';
        for (const linha of linhas) {
          // Ignora se for muito curto (< 50 chars) ou se nÃ£o contÃ©m vÃ­rgula/ponto (provavelmente Ã© tÃ­tulo)
          const ehTitulo = linha.length < 50 || (!linha.includes(',') && !linha.includes('. '));

          if (!ehTitulo) {
            // Achou o primeiro parÃ¡grafo substancial
            paragrafoEncontrado = linha;
            break;
          }
        }

        // Se nÃ£o achou nenhum parÃ¡grafo substancial, usa o primeiro nÃ£o-vazio
        primeiroParagrafoRelatorio = paragrafoEncontrado || (linhas[0] || '');

        if (!primeiroParagrafoRelatorio) {
          setError('Aviso: Primeiro parÃ¡grafo do RELATÃ“RIO estÃ¡ vazio. Os placeholders podem nÃ£o funcionar corretamente.');
        }
      } else {
        setError('Erro: TÃ³pico RELATÃ“RIO nÃ£o encontrado. Crie um tÃ³pico chamado "RELATÃ“RIO" com os nomes das partes no primeiro parÃ¡grafo.');
      }

      // Preparar prompt com contexto dos tÃ³picos (SEM documentos processuais)
      const promptText = `${AI_PROMPTS.roles.redacao}

Com base nos tÃ³picos decididos abaixo, gere um DISPOSITIVO completo.

ATENÃ‡ÃƒO CRÃTICA: O usuÃ¡rio SELECIONOU EXPLICITAMENTE o resultado de cada decisÃ£o. Use EXATAMENTE o resultado fornecido, sem interpretaÃ§Ã£o.

Com base nos tÃ³picos e resultados fornecidos abaixo, gere um DISPOSITIVO completo e bem estruturado para uma sentenÃ§a trabalhista.

${AI_PROMPTS.buildPartesDoProcesso(primeiroParagrafoRelatorio)}

${AI_PROMPTS.buildTopicosSection(topicosComDecisao, topicosSemDecisao)}

INSTRUÃ‡Ã•ES PARA O DISPOSITIVO:

${AI_PROMPTS.regraFundamentalDispositivo}

${AI_PROMPTS.estiloRedacao}

${aiIntegration.aiSettings.modeloDispositivo ? `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MODELO PERSONALIZADO DO USUÃRIO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use o seguinte modelo como referÃªncia para estruturar o dispositivo:

${aiIntegration.aiSettings.modeloDispositivo}

âš ï¸ INSTRUÃ‡Ã•ES PARA PLACEHOLDERS:
Se o modelo personalizado contiver placeholders como [RECLAMANTE], [RECLAMADA], [PRIMEIRA RECLAMADA], [SEGUNDA RECLAMADA], etc., substitua-os pelos nomes reais extraÃ­dos da seÃ§Ã£o "PARTES DO PROCESSO" acima.

Importante: Use o RESULTADO SELECIONADO PELO USUÃRIO para cada tÃ³pico.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
` : AI_PROMPTS.instrucoesDispositivoPadrao}

IMPORTANTE:
- Use linguagem formal e tÃ©cnico-jurÃ­dica adequada
- Mantenha primeira pessoa do singular (DECIDO, julgo, reconheÃ§o, etc.)
- Seja objetivo e claro em cada item
- **NUNCA USE NUMERAÃ‡ÃƒO ROMANA (I, II, III, IV)** - use apenas hÃ­fens (-) ou bullets
- **NÃƒO INCLUA JUSTIFICATIVAS OU FUNDAMENTOS** - apenas o resultado
- **USE O "RESULTADO SELECIONADO PELO USUÃRIO"** - foi escolhido manualmente
- **NÃƒO INVERTA OS RESULTADOS** - se diz IMPROCEDENTE, escreva IMPROCEDENTE
- Organize os itens de forma lÃ³gica (questÃµes processuais primeiro, depois mÃ©rito, pedidos nÃ£o decididos por Ãºltimo)
- Para resultados "NÃƒO DEFINIDO", deixe MUITO CLARO que nÃ£o foram apreciados

${AI_PROMPTS.formatacaoHTML("<strong>JULGAR PROCEDENTE</strong> o pedido de...")}

${AI_PROMPTS.formatacaoParagrafos("<p>Ante o exposto...</p><p>REJEITAR a preliminar...</p>")}

${AI_PROMPTS.numeracaoReclamadas}

CHECKLIST DE VERIFICAÃ‡ÃƒO FINAL:
1. âœ“ Usei o "RESULTADO SELECIONADO PELO USUÃRIO" para cada tÃ³pico?
2. âœ“ Se diz "IMPROCEDENTE", escrevi "IMPROCEDENTE" (nÃ£o "PROCEDENTE")?
3. âœ“ Se diz "PROCEDENTE", escrevi "PROCEDENTE" (nÃ£o "IMPROCEDENTE")?
4. âœ“ NÃ£o inverti nenhum resultado escolhido pelo usuÃ¡rio?
5. âœ“ Omiti justificativas e incluÃ­ apenas o resultado?
6. âœ“ NÃƒO usei numeraÃ§Ã£o romana (I, II, III, IV)?
7. âœ“ Usei HTML (<strong>, <em>, <br>) ao invÃ©s de markdown (**, *, ##)?

Responda APENAS com o texto completo do dispositivo em HTML, sem explicaÃ§Ãµes adicionais.`;

      // Preparar contentArray APENAS com o prompt (sem documentos processuais)
      const contentArray: AIMessageContent[] = [{
        type: 'text' as const,
        text: promptText
      }];

      // v1.21.26: Parametros para dispositivo (mais restrito)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 8000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.3,
        topP: 0.9,
        topK: 50
      });

      // Normalizar espaÃ§amento para evitar linhas em branco duplicadas
      let dispositivoFinal = normalizeHTMLSpacing(textContent.trim());

      // v1.14.1: Cache removido - dispositivo sempre deve refletir dados atuais

      // v1.36.56: Double Check do Dispositivo
      if (aiIntegration.aiSettings.doubleCheck?.enabled &&
          aiIntegration.aiSettings.doubleCheck?.operations.dispositivo) {

        // Preparar contexto da fundamentaÃ§Ã£o para verificaÃ§Ã£o
        const fundamentacaoContext = topicsSummary.map(t =>
          `${t.titulo} (${t.categoria})\nResultado: ${t.resultado}\nDecisÃ£o: ${t.decisao}`
        ).join('\n\n---\n\n');

        try {
          const { verified, corrections, summary } = await aiIntegration.performDoubleCheck(
            'dispositivo',
            dispositivoFinal,
            fundamentacaoContext
          );

          if (corrections.length > 0) {
            dispositivoFinal = verified;
            showToast(`ğŸ”„ Double Check: ${corrections.length} correÃ§Ã£o(Ãµes) - ${summary}`, 'info');
            console.log('[DoubleCheck Dispositivo] CorreÃ§Ãµes aplicadas:', corrections);
          } else {
            console.log('[DoubleCheck Dispositivo] Nenhuma correÃ§Ã£o necessÃ¡ria');
          }
        } catch (dcError) {
          console.error('[DoubleCheck Dispositivo] Erro:', dcError);
          // Continuar com dispositivo original em caso de erro
        }
      }

      aiIntegration.setDispositivoText(dispositivoFinal);
      openModal('dispositivo');
      aiIntegration.setGeneratingDispositivo(false);
    } catch (err) {
      setError('Erro ao gerar dispositivo: ' + (err as Error).message);
      aiIntegration.setGeneratingDispositivo(false);
    }
  };

  const regenerateDispositivoWithInstruction = async () => {
    if (!editingTopic || editingTopic.title.toUpperCase() !== 'DISPOSITIVO') {
      setError('Esta funÃ§Ã£o sÃ³ pode ser usada para o tÃ³pico DISPOSITIVO');
      return;
    }

    // Validar que hÃ¡ tÃ³picos decididos
    if (selectedTopics.length === 0) {
      setError('Nenhum tÃ³pico selecionado. Adicione e preencha os tÃ³picos antes de regenerar o dispositivo.');
      return;
    }

    const topicsWithoutResult = selectedTopics.filter(t =>
      isTopicDecidido(t) &&
      !t.resultado &&
      t.title.toUpperCase() !== 'RELATÃ“RIO' &&
      t.title.toUpperCase() !== 'DISPOSITIVO' &&
      !t.isComplementar
    );

    if (topicsWithoutResult.length > 0) {
      const titulosFaltando = topicsWithoutResult.map(t => `"${t.title}"`).join(', ');
      setError(`Os seguintes tÃ³picos estÃ£o decididos mas sem resultado selecionado: ${titulosFaltando}. Por favor, selecione o resultado (Procedente/Improcedente/etc) antes de regenerar o dispositivo.`);
      return;
    }

    aiIntegration.setRegeneratingDispositivo(true);
    setAnalysisProgress('ğŸ”„ Regenerando DISPOSITIVO...');

    try {
      // Preparar resumo dos tÃ³picos com decisÃµes (SEM documentos processuais)
      const topicsSummary = topicsParaDispositivo.map(topic => {
        const relatorio = topic.editedRelatorio ? htmlToFormattedText(topic.editedRelatorio) : (topic.relatorio || '');
        const decisao = topic.editedFundamentacao ? htmlToFormattedText(topic.editedFundamentacao) : '';
        const temDecisao = decisao && decisao.trim() !== '' && decisao.trim() !== 'Sem decisÃ£o preenchida';

        return {
          titulo: topic.title,
          categoria: topic.category,
          relatorio: relatorio || '',
          decisao: temDecisao ? (decisao || '') : 'SEM DECISÃƒO PREENCHIDA',
          resultado: topic.resultado || 'NÃƒO DEFINIDO',
          temDecisao: temDecisao
        };
      });

      // Extrair primeiro parÃ¡grafo do RELATÃ“RIO para placeholders
      const topicoRelatorio = selectedTopics.find(isRelatorio);
      let primeiroParagrafoRelatorio = '';
      if (topicoRelatorio) {
        const relatorioCompleto = htmlToFormattedText(topicoRelatorio.editedRelatorio || topicoRelatorio.relatorio || '');
        const linhas = relatorioCompleto.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        for (const linha of linhas) {
          const ehTitulo = linha.length < 50 || (!linha.includes(',') && !linha.includes('. '));
          if (!ehTitulo) {
            primeiroParagrafoRelatorio = linha;
            break;
          }
        }
        primeiroParagrafoRelatorio = primeiroParagrafoRelatorio || (linhas[0] || '');
      }

      // Construir prompt completo (SEM documentos processuais)
      const topicosComDecisao = topicsSummary.filter(t => t.temDecisao);
      const topicosSemDecisao = topicsSummary.filter(t => !t.temDecisao);

      // InstruÃ§Ã£o customizada do usuÃ¡rio
      const instrucaoCustomizada = aiIntegration.dispositivoInstruction?.trim() || '';

      const promptText = `${AI_PROMPTS.roles.redacao}

Com base nos tÃ³picos decididos abaixo, gere um DISPOSITIVO completo.

${instrucaoCustomizada ? `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ INSTRUÃ‡ÃƒO CUSTOMIZADA DO USUÃRIO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

${instrucaoCustomizada}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
` : ''}

ATENÃ‡ÃƒO CRÃTICA: O usuÃ¡rio SELECIONOU EXPLICITAMENTE o resultado de cada decisÃ£o. Use EXATAMENTE o resultado fornecido, sem interpretaÃ§Ã£o.

Com base nos tÃ³picos e resultados fornecidos abaixo, gere um DISPOSITIVO completo e bem estruturado para uma sentenÃ§a trabalhista.

${AI_PROMPTS.buildPartesDoProcesso(primeiroParagrafoRelatorio)}

${AI_PROMPTS.buildTopicosSection(topicosComDecisao, topicosSemDecisao)}

INSTRUÃ‡Ã•ES PARA O DISPOSITIVO:

${AI_PROMPTS.regraFundamentalDispositivo}

${AI_PROMPTS.estiloRedacao}

${aiIntegration.aiSettings.modeloDispositivo ? `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MODELO PERSONALIZADO DO USUÃRIO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use o seguinte modelo como referÃªncia para estruturar o dispositivo:

${aiIntegration.aiSettings.modeloDispositivo}

âš ï¸ INSTRUÃ‡Ã•ES PARA PLACEHOLDERS:
Se o modelo personalizado contiver placeholders como [RECLAMANTE], [RECLAMADA], [PRIMEIRA RECLAMADA], [SEGUNDA RECLAMADA], etc., substitua-os pelos nomes reais extraÃ­dos da seÃ§Ã£o "PARTES DO PROCESSO" acima.

Importante: Use o RESULTADO SELECIONADO PELO USUÃRIO para cada tÃ³pico.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
` : AI_PROMPTS.instrucoesDispositivoPadrao}${(aiIntegration.dispositivoInstruction || '').trim() ? `

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ INSTRUÃ‡ÃƒO ADICIONAL DO USUÃRIO (v1.5.8c):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

${(aiIntegration.dispositivoInstruction || '').trim()}

Por favor, considere esta instruÃ§Ã£o adicional ao gerar o dispositivo, mantendo todas as demais regras e estruturas definidas acima.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
` : ''}

IMPORTANTE:
- Use linguagem formal e tÃ©cnico-jurÃ­dica adequada
- Mantenha primeira pessoa do singular (DECIDO, julgo, reconheÃ§o, etc.)
- Seja objetivo e claro em cada item
- **NUNCA USE NUMERAÃ‡ÃƒO ROMANA (I, II, III, IV)** - use apenas hÃ­fens (-) ou bullets
- **NÃƒO INCLUA JUSTIFICATIVAS OU FUNDAMENTOS** - apenas o resultado
- **USE O "RESULTADO SELECIONADO PELO USUÃRIO"** - foi escolhido manualmente
- **NÃƒO INVERTA OS RESULTADOS** - se diz IMPROCEDENTE, escreva IMPROCEDENTE
- Organize os itens de forma lÃ³gica (questÃµes processuais primeiro, depois mÃ©rito, pedidos nÃ£o decididos por Ãºltimo)
- Para resultados "NÃƒO DEFINIDO", deixe MUITO CLARO que nÃ£o foram apreciados

${AI_PROMPTS.formatacaoHTML("<strong>JULGAR PROCEDENTE</strong> o pedido de...")}

${AI_PROMPTS.formatacaoParagrafos("<p>Ante o exposto...</p><p>REJEITAR a preliminar...</p>")}

${AI_PROMPTS.numeracaoReclamadas}

CHECKLIST DE VERIFICAÃ‡ÃƒO FINAL:
1. âœ“ Usei o "RESULTADO SELECIONADO PELO USUÃRIO" para cada tÃ³pico?
2. âœ“ Se diz "IMPROCEDENTE", escrevi "IMPROCEDENTE" (nÃ£o "PROCEDENTE")?
3. âœ“ Se diz "PROCEDENTE", escrevi "PROCEDENTE" (nÃ£o "IMPROCEDENTE")?
4. âœ“ NÃ£o inverti nenhum resultado escolhido pelo usuÃ¡rio?
5. âœ“ Omiti justificativas e incluÃ­ apenas o resultado?
6. âœ“ NÃƒO usei numeraÃ§Ã£o romana (I, II, III, IV)?
7. âœ“ Usei HTML (<strong>, <em>, <br>) ao invÃ©s de markdown (**, *, ##)?

Responda APENAS com o texto completo do dispositivo em HTML, sem explicaÃ§Ãµes adicionais.`;

      // Preparar contentArray APENAS com o prompt (sem documentos processuais)
      const contentArray: AIMessageContent[] = [{
        type: 'text' as const,
        text: promptText
      }];

      // Fazer chamada Ã  API
      // v1.21.26: Parametros para dispositivo (mais restrito)
      const textContent = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 8000,
        useInstructions: true,
        logMetrics: true,
        temperature: 0.3,
        topP: 0.9,
        topK: 50
      });

      if (!textContent || textContent.trim() === '') {
        throw new Error('Dispositivo gerado estÃ¡ vazio');
      }

            // Normalizar espaÃ§amento para evitar linhas em branco duplicadas
      const htmlContent = normalizeHTMLSpacing(textContent.trim());

      // Atualizar o editingTopic
      const updatedTopic = {
        ...editingTopic,
        editedContent: htmlContent
      };
      setEditingTopic(updatedTopic);

            if (editorRef.current) {
        editorRef.current.root.innerHTML = sanitizeHTML(htmlContent);
      }

      // Atualizar os arrays de tÃ³picos
      setSelectedTopics(selectedTopics.map(t =>
        t.title === editingTopic.title ? updatedTopic : t
      ));
      setExtractedTopics(extractedTopics.map(t =>
        t.title === editingTopic.title ? updatedTopic : t
      ));

      setAnalysisProgress('');
      aiIntegration.setDispositivoInstruction('');
      showToast('âœ… DISPOSITIVO regenerado com sucesso!', 'success');

    } catch (err) {
      setError('Erro ao regenerar DISPOSITIVO: ' + (err as Error).message);
      setAnalysisProgress('');
    } finally {
      aiIntegration.setRegeneratingDispositivo(false);
    }
  };

  // v1.21.21: FunÃ§Ã£o para montar texto completo da decisÃ£o (RELATÃ“RIO + TÃ“PICOS + DISPOSITIVO)
  const buildDecisionText = React.useCallback(() => {
    const parts = [];

    // RELATÃ“RIO
    const relatorio = selectedTopics.find(isRelatorio);
    if (relatorio) {
      parts.push('=== RELATÃ“RIO ===\n\n' +
        htmlToFormattedText(relatorio.editedRelatorio || relatorio.relatorio || ''));
    }

    // TÃ“PICOS (exceto RELATÃ“RIO e DISPOSITIVO)
    parts.push('\n\n=== FUNDAMENTAÃ‡ÃƒO ===\n');
    selectedTopics
      .filter(t => !isRelatorio(t) && !isDispositivo(t))
      .forEach(topic => {
        const miniRelatorio = htmlToFormattedText(topic.editedRelatorio || topic.relatorio || '');
        const decisao = htmlToFormattedText(topic.editedFundamentacao || '');
        parts.push(`\n### ${topic.title.toUpperCase()} (${topic.category || 'Sem categoria'})\nResultado: ${topic.resultado || 'NÃƒO DEFINIDO'}\n\nMini-relatÃ³rio:\n${miniRelatorio || 'NÃ£o preenchido'}\n\nDecisÃ£o:\n${decisao || 'NÃ£o preenchida'}`);
      });

    // DISPOSITIVO
    const dispositivo = selectedTopics.find(isDispositivo);
    if (dispositivo?.editedContent) {
      parts.push('\n\n=== DISPOSITIVO ===\n\n' +
        htmlToFormattedText(dispositivo.editedContent));
    }

    return parts.join('');
  }, [selectedTopics]);

  // v1.21.21: FunÃ§Ã£o para revisar sentenÃ§a buscando omissÃµes, contradiÃ§Ãµes e obscuridades
  // v1.36.57: Cache persistente para revisÃ£o de sentenÃ§a
  const reviewSentence = async () => {
    if (!canGenerateDispositivo.enabled) {
      setError('Complete todos os tÃ³picos antes de revisar a sentenÃ§a.');
      return;
    }

    setGeneratingReview(true);
    setError('');

    try {
      // v1.36.57: Verificar cache primeiro
      const cachedReview = await sentenceReviewCache.getReview(reviewScope);
      if (cachedReview) {
        setReviewResult(cachedReview);
        setReviewFromCache(true);
        closeModal('sentenceReview');
        openModal('sentenceReviewResult');
        setGeneratingReview(false);
        return;
      }

      // NÃ£o hÃ¡ cache, gerar com IA
      setReviewFromCache(false);
      const contentArray: AIMessageContent[] = [];

      // Se escopo inclui documentos, usar buildDocumentContentArray existente
      if (reviewScope === 'decisionWithDocs') {
        const docsArray = buildDocumentContentArray({ includeComplementares: true });
        contentArray.push(...docsArray);
      }

      // Adicionar decisÃ£o completa
      contentArray.push({
        type: 'text' as const,
        text: `DECISÃƒO PARA REVISÃƒO:\n\n${buildDecisionText()}`
      });

      // v1.21.25: Parametros especificos para revisao critica (mais rigoroso, menos criativo)
      const result = await aiIntegration.callAI([{
        role: 'user',
        content: contentArray
      }], {
        maxTokens: 8192,
        systemPrompt: AI_PROMPTS.revisaoSentenca(reviewScope === 'decisionWithDocs'),
        useInstructions: false,
        logMetrics: true,
        temperature: 0.2,
        topP: 0.9,
        topK: 40
      });

      let reviewFinal = normalizeHTMLSpacing(result.trim());

      // v1.36.56: Double Check da RevisÃ£o de SentenÃ§a
      if (aiIntegration.aiSettings.doubleCheck?.enabled &&
          aiIntegration.aiSettings.doubleCheck?.operations.sentenceReview) {

        try {
          const { verified, corrections, summary } = await aiIntegration.performDoubleCheck(
            'sentenceReview',
            reviewFinal,
            buildDecisionText()  // Contexto: a decisÃ£o completa
          );

          if (corrections.length > 0) {
            reviewFinal = verified;
            showToast(`ğŸ”„ Double Check: ${corrections.length} correÃ§Ã£o(Ãµes) - ${summary}`, 'info');
            console.log('[DoubleCheck Review] CorreÃ§Ãµes aplicadas:', corrections);
          } else {
            console.log('[DoubleCheck Review] Nenhuma correÃ§Ã£o necessÃ¡ria');
          }
        } catch (dcError) {
          console.error('[DoubleCheck Review] Erro:', dcError);
          // Continuar com revisÃ£o original em caso de erro
        }
      }

      // v1.36.57: Salvar no cache apÃ³s gerar
      await sentenceReviewCache.saveReview(reviewScope, reviewFinal);

      setReviewResult(reviewFinal);
      closeModal('sentenceReview');
      openModal('sentenceReviewResult');
    } catch (err) {
      setError('Erro ao revisar sentenÃ§a: ' + (err as Error).message);
    } finally {
      setGeneratingReview(false);
    }
  };

  // ğŸš€ OTIMIZAÃ‡ÃƒO v1.15.0: Busca inteligente unificada com sinÃ´nimos e normalizaÃ§Ã£o
  const filteredModels = React.useMemo(() => {
    let results = modelLibrary.models;

    // Aplicar busca inteligente se houver termo
    if (modelLibrary.searchTerm.trim()) {
      results = searchModelsInLibrary(results, modelLibrary.searchTerm, {
        includeContent: true,
        limit: null
      });
    }

    // Aplicar filtros adicionais (categoria, favoritos e propriedade)
    return results.filter(m => {
      const matchesCategory = modelLibrary.selectedCategory === 'all' || m.category === modelLibrary.selectedCategory;
      const matchesFavorite = !modelLibrary.showFavoritesOnly || m.favorite;
      // v1.35.0: Filtro de propriedade (todos/meus/compartilhados)
      const matchesOwnership =
        modelLibrary.ownershipFilter === 'all' ||
        (modelLibrary.ownershipFilter === 'mine' && !m.isShared) ||
        (modelLibrary.ownershipFilter === 'shared' && m.isShared);
      return matchesCategory && matchesFavorite && matchesOwnership;
    });
  }, [modelLibrary.models, modelLibrary.searchTerm, modelLibrary.selectedCategory, modelLibrary.showFavoritesOnly, modelLibrary.ownershipFilter]);

  // ğŸš€ OTIMIZAÃ‡ÃƒO v1.4.1: Memoizar paginaÃ§Ã£o para evitar recÃ¡lculo e slice desnecessÃ¡rios
  const { currentModels, totalModelPages, indexOfFirstModel, indexOfLastModel } = React.useMemo(() => {
    const totalPages = Math.ceil(filteredModels.length / modelLibrary.modelsPerPage);
    const lastIdx = modelLibrary.currentModelPage * modelLibrary.modelsPerPage;
    const firstIdx = lastIdx - modelLibrary.modelsPerPage;
    const paginatedModels = filteredModels.slice(firstIdx, lastIdx);
    return {
      currentModels: paginatedModels,
      totalModelPages: totalPages,
      indexOfFirstModel: firstIdx,
      indexOfLastModel: lastIdx
    };
  }, [filteredModels, modelLibrary.currentModelPage, modelLibrary.modelsPerPage]);

  // ğŸš€ v1.4.3: Memoizar cÃ¡lculo de provas vinculadas (evita recÃ¡lculo durante digitaÃ§Ã£o)
  const linkedProofs = React.useMemo(() => {
    if (!editingTopic) return [];

    const linkedProofIds = Object.keys(proofManager.proofTopicLinks).filter(proofId =>
      proofManager.proofTopicLinks[proofId]?.includes(editingTopic.title)
    );

    return [
      ...proofManager.proofFiles.filter((p: ProofFile) => linkedProofIds.includes(String(p.id))).map((p: ProofFile) => ({ ...p, isPdf: true })),
      ...proofManager.proofTexts.filter((p: ProofText) => linkedProofIds.includes(String(p.id))).map((p: ProofText) => ({ ...p, isPdf: false }))
    ];
  }, [editingTopic?.title, proofManager.proofTopicLinks]);

  // ğŸ“¦ v1.27.01: Contagem de modelos com embedding e estados de busca semÃ¢ntica
  const modelEmbeddingsCount = React.useMemo(() =>
    modelLibrary.models.filter(m => m.embedding?.length === 768).length,
    [modelLibrary.models]
  );
  // v1.28.01: Usa toggle global como padrÃ£o se nÃ£o houver valor no localStorage
  // v1.35.74: Usa aiSettings unificado
  const [useModelSemanticSearch, setUseModelSemanticSearch] = React.useState(() => {
    try {
      const stored = localStorage.getItem('modelSemanticMode');
      if (stored !== null) return stored === 'true';
      return aiIntegration.aiSettings.modelSemanticEnabled; // Usa toggle global como fallback
    } catch { return false; }
  });
  const [modelSemanticResults, setModelSemanticResults] = React.useState<Model[] | null>(null);
  const [searchingModelSemantics, setSearchingModelSemantics] = React.useState(false);

  // Busca semÃ¢ntica de modelos disponÃ­vel se: toggle global ativo + modelo pronto + modelos com embedding
  const modelSemanticAvailable = aiIntegration.aiSettings.modelSemanticEnabled && searchModelReady && modelEmbeddingsCount > 0;

  // Handler para busca semÃ¢ntica de modelos
  // v1.35.74: Usa aiSettings unificado
  const performModelSemanticSearch = React.useCallback(async (query: string) => {
    if (!query || query.length < 3 || !modelSemanticAvailable) {
      setModelSemanticResults(null);
      return;
    }
    setSearchingModelSemantics(true);
    try {
      const threshold = (aiIntegration.aiSettings.modelSemanticThreshold ?? 75) / 100;
      const results = await searchModelsBySimilarity(modelLibrary.models, query, { threshold, limit: 30 });
      setModelSemanticResults(results);
    } catch (err) {
      console.error('[Model Semantic] Erro na busca:', err);
      setModelSemanticResults(null);
    } finally {
      setSearchingModelSemantics(false);
    }
  }, [modelSemanticAvailable, aiIntegration.aiSettings.modelSemanticThreshold, modelLibrary.models]);

  // Debounce para busca semÃ¢ntica de modelos
  const modelSemanticSearchTimeoutRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);
  React.useEffect(() => {
    if (useModelSemanticSearch && modelSemanticAvailable && modelLibrary.searchTerm) {
      if (modelSemanticSearchTimeoutRef.current) clearTimeout(modelSemanticSearchTimeoutRef.current);
      modelSemanticSearchTimeoutRef.current = setTimeout(() => {
        performModelSemanticSearch(modelLibrary.searchTerm);
      }, 500);
    } else {
      setModelSemanticResults(null);
    }
    return () => {
      if (modelSemanticSearchTimeoutRef.current) {
        clearTimeout(modelSemanticSearchTimeoutRef.current);
      }
    };
  }, [modelLibrary.searchTerm, useModelSemanticSearch, modelSemanticAvailable, performModelSemanticSearch]);

  // ğŸš€ v1.4.3: PrÃ©-calcular categorias e contagens (1 loop em vez de N+2)
  const { categories, categoryCounts } = React.useMemo(() => {
    const cats = new Set<string>();
    const counts: Record<string, number> = {};
    let withoutCategory = 0;
    let favorites = 0;

    modelLibrary.models.forEach(m => {
      if (m.category) {
        cats.add(m.category);
        counts[m.category] = (counts[m.category] || 0) + 1;
      } else {
        withoutCategory++;
      }
      if (m.favorite) favorites++;
    });

    return {
      categories: Array.from(cats).sort(),
      categoryCounts: { counts, withoutCategory, favorites }
    };
  }, [modelLibrary.models]);

  // ğŸ¨ JSX: RENDERIZAÃ‡ÃƒO DO COMPONENTE

  return (
    <>
      <GlobalHoverStyles />
      <ThemeStyles />
      <div className="min-h-screen theme-gradient-app theme-text-primary">
      <div className="container mx-auto p-6 max-w-7xl">
        <div className="theme-bg-primary rounded-lg shadow-2xl border theme-border-secondary" style={{ backgroundColor: 'var(--bg-primary)', opacity: 0.95 }}>
          <div className={CSS.modalHeader}>
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent">
                  SENTENCIFY.AI
                </h1>

                {/* Campo de NÃºmero do Processo (v1.3.5.1) */}
                <div className="mt-2 mb-1">
                  <input
                    type="text"
                    value={processoNumero}
                    onChange={(e) => setProcessoNumero(e.target.value)}
                    placeholder="NÂº do Processo (ex: ATOrd 0000313-98.2025.5.08.0110)"
                    className="w-full max-w-md px-3 py-1.5 rounded text-sm font-mono theme-bg-secondary border theme-border-primary theme-text-secondary theme-placeholder focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all theme-hover-bg"
                    style={{ transition: 'all 0.2s ease' }}
                  />
                </div>

                <p className="theme-text-muted mt-1">Ferramenta integrada com IA para auxÃ­lio na minuta de sentenÃ§as trabalhistas</p>
              </div>
              <div className="text-right">
                <div className="flex items-center justify-end gap-2 mb-2">
                  <p className="text-xs theme-text-disabled">
                    <button onClick={() => setShowChangelogModal(true)} className="hover:text-blue-400 transition-colors cursor-pointer" title="Ver histÃ³rico de alteraÃ§Ãµes">
                      VersÃ£o {APP_VERSION}
                    </button>
                    {' '}- <span className="text-amber-500 font-semibold">PROTÃ“TIPO</span> (nÃ£o utilizar com processos reais)
                  </p>
                </div>
                <p className="text-xs theme-text-muted mt-1">Made by <span className="text-blue-400">Rodrigo Nohlack CorrÃªa Cesar</span></p>
                <p className="text-xs theme-text-disabled">Juiz do Trabalho no TRT8</p>

                <div className="mt-2 flex gap-2 justify-end flex-wrap">
                  {/* ğŸ“– v1.32.11: BotÃ£o Manual do UsuÃ¡rio */}
                  <button
                    onClick={() => window.open('/MANUAL_USUARIO_AVANCADO.html', '_blank')}
                    className="px-2 py-1 rounded text-base flex items-center justify-center theme-btn-secondary transition-colors duration-200"
                    title="Manual do UsuÃ¡rio AvanÃ§ado"
                  >
                    ğŸ“–
                  </button>
                  {/* ğŸ¨ v1.9.13: Toggle Tema Claro/Escuro */}
                  <button
                    onClick={toggleAppTheme}
                    className="px-2 py-1 rounded text-base flex items-center justify-center theme-btn-secondary transition-colors duration-200"
                    title={appTheme === 'dark' ? 'Mudar para Tema Claro' : 'Mudar para Tema Escuro'}
                  >
                    {appTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'}
                  </button>
                  <button
                    onClick={() => openModal('settings')}
                    className="px-3 py-1 rounded text-xs flex items-center gap-1 theme-btn-secondary transition-colors duration-200"
                  >
                    âš™ï¸ ConfiguraÃ§Ãµes IA
                  </button>
                  {/* â˜ï¸ v1.35.40: Google Drive */}
                  <GoogleDriveButton
                    isConnected={googleDrive.isConnected}
                    isLoading={googleDrive.isLoading}
                    userEmail={googleDrive.userEmail}
                    userPhoto={googleDrive.userPhoto}
                    onConnect={googleDrive.connect}
                    onDisconnect={googleDrive.disconnect}
                    onSave={async () => {
                      try {
                        const allStatesWithAI = {
                          processoNumero,
                          pastedPeticaoTexts,
                          pastedContestacaoTexts,
                          pastedComplementaryTexts,
                          extractedTopics,
                          selectedTopics,
                          partesProcesso,
                          activeTab,
                          analyzedDocuments,
                          proofFiles: proofManager.proofFiles,
                          proofTexts: proofManager.proofTexts,
                          proofUsePdfMode: proofManager.proofUsePdfMode,
                          extractedProofTexts: proofManager.extractedProofTexts,
                          proofExtractionFailed: proofManager.proofExtractionFailed,
                          proofTopicLinks: proofManager.proofTopicLinks,
                          proofAnalysisResults: proofManager.proofAnalysisResults,
                          proofConclusions: proofManager.proofConclusions,
                          aiSettings: aiIntegration.aiSettings,
                          peticaoFiles,
                          contestacaoFiles,
                          complementaryFiles,
                          extractedTexts,
                          documentProcessingModes,
                          tokenMetrics: aiIntegration.tokenMetrics
                        };
                        // Converter PDFs para base64 para salvar no Drive
                        const projectJson = await storage.buildProjectJson(allStatesWithAI);
                        const fileName = `sentencify-${processoNumero || 'projeto'}-${new Date().toISOString().split('T')[0]}.json`;
                        await googleDrive.saveFile(fileName, projectJson);
                        setError({ type: 'success', message: `Projeto salvo no Google Drive: ${fileName}` });
                      } catch (err) {
                        setError({ type: 'error', message: `Erro ao salvar no Drive: ${(err as Error).message}` });
                      }
                    }}
                    onLoadClick={async () => {
                      try {
                        const files = await googleDrive.listFiles();
                        setDriveFiles(files);
                        setDriveFilesModalOpen(true);
                      } catch (err) {
                        setError({ type: 'error', message: `Erro ao listar arquivos: ${(err as Error).message}` });
                      }
                    }}
                    // v1.35.51: Props para salvar/carregar local (consolidado no dropdown)
                    onSaveLocal={() => {
                      const allStatesWithAI = {
                        processoNumero,
                        pastedPeticaoTexts,
                        pastedContestacaoTexts,
                        pastedComplementaryTexts,
                        extractedTopics,
                        selectedTopics,
                        partesProcesso,
                        activeTab,
                        analyzedDocuments,
                        proofFiles: proofManager.proofFiles,
                        proofTexts: proofManager.proofTexts,
                        proofUsePdfMode: proofManager.proofUsePdfMode,
                        extractedProofTexts: proofManager.extractedProofTexts,
                        proofExtractionFailed: proofManager.proofExtractionFailed,
                        proofTopicLinks: proofManager.proofTopicLinks,
                        proofAnalysisResults: proofManager.proofAnalysisResults,
                        proofConclusions: proofManager.proofConclusions,
                        aiSettings: aiIntegration.aiSettings,
                        peticaoFiles,
                        contestacaoFiles,
                        complementaryFiles,
                        extractedTexts,
                        documentProcessingModes,
                        tokenMetrics: aiIntegration.tokenMetrics
                      };
                      storage.exportProject(allStatesWithAI, (err: string | null) => setError(err || ''));
                    }}
                    onLoadLocal={(e) => {
                      const callbacks = {
                        setPastedPeticaoTexts,
                        setPastedContestacaoTexts,
                        setPastedComplementaryTexts,
                        setExtractedTopics,
                        setSelectedTopics,
                        setPartesProcesso,
                        setAnalyzedDocuments,
                        setProofFiles: proofManager.setProofFiles,
                        setProofTexts: proofManager.setProofTexts,
                        setProofUsePdfMode: proofManager.setProofUsePdfMode,
                        setExtractedProofTexts: proofManager.setExtractedProofTexts,
                        setProofExtractionFailed: proofManager.setProofExtractionFailed,
                        setProofTopicLinks: proofManager.setProofTopicLinks,
                        setProofAnalysisResults: proofManager.setProofAnalysisResults,
                        setProofConclusions: proofManager.setProofConclusions,
                        setProofSendFullContent: proofManager.setProofSendFullContent,
                        setActiveTab,
                        setAiSettings: aiIntegration.setAiSettings,
                        setError,
                        setProcessoNumero,
                        setPeticaoFiles,
                        setContestacaoFiles,
                        setComplementaryFiles,
                        setExtractedTexts,
                        setDocumentProcessingModes,
                        setTokenMetrics: aiIntegration.setTokenMetrics
                      };

                      const autoSaveFn = (states: SessionState, setErrorFn: (err: string | null) => void, immediate: boolean) => {
                        return storage.autoSaveSession(states, setErrorFn, immediate);
                      };

                      storage.importProject(e, callbacks, autoSaveFn);
                    }}
                    // v1.35.52: Limpar projeto consolidado no dropdown
                    onClear={() => openModal('clearProject')}
                    isDarkMode={appTheme === 'dark'}
                  />
                  {/* ğŸ”„ v1.35.57: BotÃ£o Sair na mesma linha */}
                  {cloudSync?.isAuthenticated && (
                    <button
                      onClick={() => openModal('logout')}
                      className="px-3 py-1 rounded text-xs flex items-center gap-1 bg-red-600/20 hover:bg-red-600/40 text-red-400 border border-red-500/30 transition-colors duration-200"
                      title="Sair do sistema"
                    >
                      <LogOut className="w-3 h-3" />
                      Sair
                    </button>
                  )}
                </div>
              </div>
            </div>
            
            {/* Aviso sobre responsabilidade */}
            <div className="mt-4 p-3 theme-bg-amber-accent border border-amber-500/30 rounded-lg">
              <div className="flex items-start gap-2">
                <span className="theme-text-amber text-lg flex-shrink-0">âš ï¸</span>
                <div className="text-xs theme-text-amber-muted">
                  <span className="font-semibold">Aviso Importante:</span> Esta ferramenta utiliza InteligÃªncia Artificial para auxiliar na redaÃ§Ã£o de sentenÃ§as.
                  A IA pode cometer erros, omitir informaÃ§Ãµes relevantes ou gerar conteÃºdo impreciso.
                  <span className="block mt-1 font-semibold theme-text-amber">Ã‰ responsabilidade do usuÃ¡rio revisar, verificar e validar todas as informaÃ§Ãµes geradas antes de utilizÃ¡-las.</span>
                  <span className="block mt-1 theme-text-amber-muted">Sua revisÃ£o Ã© fundamental, na forma estabelecida pela <span className="font-semibold">ResoluÃ§Ã£o 615/2025 do CNJ</span>.</span>
                </div>
              </div>
            </div>
          </div>

          {error && (
            <div className={`mx-6 mt-4 p-4 rounded-lg flex items-start gap-3 ${
              typeof error === 'object' && error.type === 'success'
                ? 'bg-green-500/10 border border-green-500/50'
                : 'bg-red-500/10 border border-red-500/50'
            }`}>
              <AlertCircle className={`w-5 h-5 flex-shrink-0 mt-0.5 ${
                typeof error === 'object' && error.type === 'success' ? 'text-green-400' : 'text-red-400'
              }`} />
              <p className="theme-text-primary flex-1">
                {typeof error === 'object' ? error.message : error}
              </p>
              <button onClick={() => setError('')} className={`p-1 rounded transition-colors error-close-btn ${
                typeof error === 'object' && error.type === 'success' ? 'text-green-400' : 'text-red-400'
              }`}>
                <X className="w-4 h-4" />
              </button>
            </div>
          )}

          <div className="border-b theme-border-secondary">
            {/* v1.20.5: Flex-wrap para quebrar linha em telas estreitas */}
            <div className="flex flex-wrap gap-2 p-2">
              {[
                { id: 'upload', label: 'Upload & AnÃ¡lise', icon: Upload },
                { id: 'topics', label: 'TÃ³picos', icon: FileText },
                { id: 'proofs', label: 'Provas', icon: Scale },
                { id: 'jurisprudencia', label: 'JurisprudÃªncia', icon: BookOpen },
                { id: 'legislacao', label: 'LegislaÃ§Ã£o', icon: Book },
                { id: 'editor', label: 'Editor', icon: FileText },
                { id: 'models', label: 'Modelos', icon: Save }
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${
                    activeTab === tab.id
                      ? 'bg-blue-600 text-white shadow-lg hover-blue-700-from-600'
                      : 'theme-text-tertiary hover-tab-inactive'
                  }`}
                >
                  <tab.icon className="w-4 h-4" />
                  {tab.label}
                </button>
              ))}
            </div>
          </div>

          <div className="p-6">
            {activeTab === 'upload' && (
              <div className="space-y-6">
                {/* v1.36.36: Aviso removido - bloqueio visual no seletor Ã© suficiente */}

                <div className="space-y-6">
                  <div className="space-y-3">
                    <label className="block text-sm font-medium theme-text-tertiary">
                      PetiÃ§Ã£o Inicial / Emendas Ã  PetiÃ§Ã£o * (mÃºltiplos)
                    </label>
                    <div
                      style={{ borderColor: '#475569', transition: 'border-color 0.3s ease' }}
                      className="border-2 border-dashed rounded-lg p-8 text-center hover-border-blue-500"
                    >
                      <input
                        type="file"
                        accept=".pdf"
                        multiple
                        onChange={async (e) => {
                          const files = Array.from(e.target.files || []);
                          if (files.length === 0) return;

                          handleUploadPeticao(files);

                          const defaultMode = getDefaultProcessingMode();
                          setDocumentProcessingModes(prev => ({
                            ...prev,
                            peticoes: [...(prev.peticoes || []), ...files.map(() => defaultMode)]
                          }));

                          if (!processoNumero) {
                            try {
                              const numeroDetectado = await documentServices.autoDetectProcessoNumero({
                                peticao: files[0],
                                contestacoes: contestacaoFiles.map(f => f.file),
                                complementares: complementaryFiles.map(f => f.file)
                              });
                              if (numeroDetectado) {
                                setProcessoNumero(numeroDetectado);
                              }
                            } catch { }
                          }
                        }}
                        className="hidden"
                        id="peticao"
                      />
                      <label htmlFor="peticao" className="cursor-pointer">
                        <Upload className="w-12 h-12 mx-auto mb-3 theme-text-muted" />
                        <p className="theme-text-tertiary font-medium">
                          {peticaoFiles.length > 0 || pastedPeticaoTexts.length > 0 ||
                           analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0
                            ? `${peticaoFiles.length + (pastedPeticaoTexts?.length || 0) + (analyzedDocuments.peticoes?.length || 0) + (analyzedDocuments.peticoesText?.length || 0)} documento(s) carregado(s)`
                            : 'Clique para fazer upload (mÃºltiplos)'}
                        </p>
                        <p className="theme-text-disabled text-sm mt-1">
                          PDFs atÃ© 10MB cada | PetiÃ§Ã£o Inicial + Emendas
                        </p>
                      </label>
                    </div>

                    {/* Lista de arquivos de petiÃ§Ã£o */}
                    {(peticaoFiles.length > 0 || pastedPeticaoTexts.length > 0 ||
                      analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0) && (
                      <div className="theme-bg-secondary-30 rounded-lg p-3 space-y-2">
                        <p className="text-xs theme-text-muted font-medium mb-2">Documentos do Autor:</p>

                        {/* Arquivos PDF novos */}
                        {peticaoFiles.map((fileObj, idx) => (
                          <div key={`peticao-file-${fileObj.id || idx}`} className="flex items-center justify-between text-sm bg-blue-900/20 p-2 rounded">
                            <span className="theme-text-tertiary truncate flex-1 flex items-center gap-2">
                              <FileText className="w-3 h-3 text-blue-400 flex-shrink-0" />
                              {idx + 1}. {idx === 0 ? 'PetiÃ§Ã£o Inicial' : (fileObj.file?.name || fileObj.name)}
                            </span>
                            <ProcessingModeSelector
                              value={documentProcessingModes.peticoes?.[idx] || 'pdfjs'}
                              onChange={(mode: ProcessingMode) => setPeticaoMode(idx, mode)}
                              anonymizationEnabled={aiIntegration.aiSettings?.anonymization?.enabled}
                              grokEnabled={aiIntegration.aiSettings?.provider === 'grok'}
                            />
                            <button
                              onClick={() => removePeticaoFile(idx)}
                              className="ml-2 hover-text-red-400-from-300"
                              title="Remover"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}

                        {/* PDFs importados (jÃ¡ processados) */}
                        {peticaoFiles.length === 0 && analyzedDocuments.peticoes?.map((_, idx) => (
                          <div key={`peticao-imported-${idx}`} className="flex items-center justify-between text-sm bg-blue-900/20 p-2 rounded">
                            <span className="theme-text-blue truncate flex-1 flex items-center gap-2">
                              <FileText className="w-3 h-3 text-blue-400 flex-shrink-0" />
                              {idx + 1}. {idx === 0 ? 'PetiÃ§Ã£o Inicial' : `Documento ${idx + 1}`} (PDF importado)
                            </span>
                            <button
                              onClick={() => setAnalyzedDocuments(prev => ({
                                ...prev,
                                peticoes: prev.peticoes.filter((_, i: number) => i !== idx)
                              }))}
                              className="ml-2 hover-text-red-400-from-300"
                              title="Remover"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}

                        {/* Textos colados - v1.21.16: clicÃ¡vel para preview */}
                        {pastedPeticaoTexts.map((doc, idx) => (
                          <div key={`peticao-pasted-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 p-2 rounded">
                            <span
                              className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                              onClick={() => setTextPreview({ isOpen: true, title: doc.name, text: doc.text })}
                            >
                              <FileText className="w-3 h-3 text-green-400 flex-shrink-0" />
                              {doc.name} ({doc.text.length.toLocaleString()} caracteres)
                            </span>
                            <button
                              onClick={() => removePastedText('peticao', idx)}
                              className="ml-2 hover-text-red-400-from-300"
                              title="Remover"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}

                        {/* Textos extraÃ­dos/importados - v1.21.16: clicÃ¡vel para preview */}
                        {analyzedDocuments.peticoesText?.map((doc, idx) => (
                          <div key={`peticao-text-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 p-2 rounded">
                            <span
                              className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                              onClick={() => setTextPreview({ isOpen: true, title: doc.name, text: doc.text })}
                            >
                              <FileText className="w-3 h-3 text-green-400 flex-shrink-0" />
                              {doc.name} (Texto - {doc.text.length.toLocaleString()} caracteres)
                            </span>
                            <button
                              onClick={() => setAnalyzedDocuments(prev => ({
                                ...prev,
                                peticoesText: prev.peticoesText.filter((_, i: number) => i !== idx)
                              }))}
                              className="ml-2 hover-text-red-400-from-300"
                              title="Remover"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                      </div>
                    )}

                    {/* OpÃ§Ã£o de colar texto */}
                    <div className="text-center">
                      <p className="theme-text-disabled text-xs mb-2">â€” OU â€”</p>
                      {!showPasteArea.peticao ? (
                        <button
                          onClick={() => setShowPasteArea({ ...showPasteArea, peticao: true })}
                          className="text-sm flex items-center gap-2 mx-auto hover-text-blue-400-from-300"
                        >
                          <FileText className="w-4 h-4" />
                          Colar texto (Ctrl+V)
                        </button>
                      ) : (
                        <div className="theme-bg-secondary-30 rounded-lg p-4">
                          <p className="text-xs theme-text-muted mb-2">Cole o texto da petiÃ§Ã£o/emenda abaixo:</p>
                          <textarea
                            className="w-full h-32 theme-bg-primary border theme-border-input rounded p-2 text-sm theme-text-secondary resize-none focus:border-blue-500 focus:outline-none"
                            placeholder="Cole o texto aqui (Ctrl+V)..."
                            onPaste={(e) => {
                              const text = e.clipboardData.getData('text');
                              handlePastedText(text, 'peticao');
                            }}
                            onKeyDown={(e) => {
                              if (e.ctrlKey && e.key === 'Enter') {
                                const text = (e.target as HTMLTextAreaElement).value;
                                handlePastedText(text, 'peticao');
                              }
                            }}
                          />
                          <div className="flex gap-2 mt-2">
                            <button
                              onClick={(e) => {
                                const textarea = (e.target as Element).closest('.theme-bg-secondary-30')?.querySelector('textarea');
                                if (textarea) handlePastedText(textarea.value, 'peticao');
                              }}
                              className="hover-blue-700 flex-1 py-2 rounded text-sm bg-blue-600 text-white"
                            >
                              Confirmar
                            </button>
                            <button
                              onClick={() => setShowPasteArea({ ...showPasteArea, peticao: false })}
                              className="px-4 py-2 rounded text-sm theme-bg-tertiary hover-slate-700-from-600"
                            >
                              Cancelar
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="space-y-3">
                    <label className="block text-sm font-medium theme-text-tertiary">
                      ContestaÃ§Ãµes (Opcional - mÃºltiplas)
                    </label>
                    <div
                      style={{ borderColor: '#475569', transition: 'border-color 0.3s ease' }}
                      className="border-2 border-dashed rounded-lg p-8 text-center hover-border-blue-500"
                    >
                      <input
                        type="file"
                        accept=".pdf"
                        multiple
                        onChange={async (e) => {
                          const files = Array.from(e.target.files || []);
                          if (files.length === 0) return;

                          // v1.13.7: Usar handleUploadContestacao para salvar no IndexedDB
                          handleUploadContestacao(files);

                          // v1.12.18: Definir modos de processamento padrÃ£o para contestaÃ§Ãµes
                          const defaultMode = getDefaultProcessingMode();
                          setDocumentProcessingModes(prev => ({
                            ...prev,
                            contestacoes: files.map(() => defaultMode)
                          }));

                          if (!processoNumero) {
                            try {
                              const numeroDetectado = await documentServices.autoDetectProcessoNumero({
                                peticao: peticaoFiles[0]?.file || peticaoFiles[0],
                                contestacoes: files,
                                complementares: complementaryFiles.map(f => f.file || f)
                              });

                              if (numeroDetectado) {
                                setProcessoNumero(numeroDetectado);
                              }
                            } catch (err) {
                              // Silencioso - nÃ£o bloqueia upload se falhar
                            }
                          }
                        }}
                        className="hidden"
                        id="contestacao"
                      />
                      <label htmlFor="contestacao" className="cursor-pointer">
                        <Upload className="w-12 h-12 mx-auto mb-3 theme-text-muted" />
                        <p className="theme-text-tertiary font-medium">
                          {contestacaoFiles.length > 0
                            ? `${contestacaoFiles.length} arquivo${contestacaoFiles.length > 1 ? 's' : ''} selecionado${contestacaoFiles.length > 1 ? 's' : ''}`
                            : (analyzedDocuments.contestacoes?.length > 0 || pastedContestacaoTexts.length > 0)
                            ? `âœ“ ${(analyzedDocuments.contestacoes?.length || 0) + pastedContestacaoTexts.length} importado${((analyzedDocuments.contestacoes?.length || 0) + pastedContestacaoTexts.length) > 1 ? 's' : ''}`
                            : 'Clique para fazer upload'}
                        </p>
                        <p className="theme-text-disabled text-sm mt-1">MÃºltiplos PDFs atÃ© 10MB cada</p>
                      </label>
                    </div>
                    
                    {/* OpÃ§Ã£o de colar texto */}
                    <div className="text-center mt-3">
                      <p className="theme-text-disabled text-xs mb-2">â€” OU â€”</p>
                      {!showPasteArea.contestacao ? (
                        <button
                          onClick={() => setShowPasteArea({ ...showPasteArea, contestacao: true })}
                          className="text-sm flex items-center gap-2 mx-auto hover-text-blue-400-from-300"
                        >
                          <FileText className="w-4 h-4" />
                          Colar texto de contestaÃ§Ã£o (Ctrl+V)
                        </button>
                      ) : (
                        <div className="theme-bg-secondary-30 rounded-lg p-4">
                          <p className="text-xs theme-text-muted mb-2">Cole o texto da contestaÃ§Ã£o abaixo:</p>
                          <textarea
                            className="w-full h-32 theme-bg-primary border theme-border-input rounded p-2 text-sm theme-text-secondary resize-none focus:border-blue-500 focus:outline-none"
                            placeholder="Cole o texto aqui (Ctrl+V)..."
                            onPaste={(e) => {
                              const text = e.clipboardData.getData('text');
                              handlePastedText(text, 'contestacao');
                            }}
                            onKeyDown={(e) => {
                              if (e.ctrlKey && e.key === 'Enter') {
                                const text = (e.target as HTMLTextAreaElement).value;
                                handlePastedText(text, 'contestacao');
                              }
                            }}
                          />
                          <div className="flex gap-2 mt-2">
                            <button
                              onClick={(e) => {
                                const textarea = (e.target as Element).closest('.theme-bg-secondary\\/30')?.querySelector('textarea');
                                if (textarea) handlePastedText(textarea.value, 'contestacao');
                              }}
                              className="hover-blue-700 flex-1 py-2 rounded text-sm bg-blue-600 text-white"
                            >
                              Confirmar
                            </button>
                            <button
                              onClick={() => setShowPasteArea({ ...showPasteArea, contestacao: false })}
                              className="px-4 py-2 rounded text-sm theme-bg-tertiary hover-slate-700-from-600"
                            >
                              Cancelar
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    {(contestacaoFiles.length > 0 || pastedContestacaoTexts.length > 0 || analyzedDocuments.contestacoes?.length > 0 || analyzedDocuments.contestacoesText?.length > 0) && (
                      <div className="theme-bg-secondary-30 rounded-lg p-3 space-y-2 mt-3">
                        <p className="text-xs theme-text-muted font-medium">ContestaÃ§Ãµes:</p>
                        {/* v1.12.16: ContestaÃ§Ãµes com indicador de status - respeita config */}
                        {contestacaoFiles.map((fileObj, idx) => (
                          <div key={`file-${fileObj.id || idx}`} className="flex items-center justify-between text-sm theme-bg-primary-50 p-2 rounded">
                            <span className="theme-text-tertiary truncate flex-1 flex items-center gap-2">
                              <FileText className="w-3 h-3 text-blue-400" />
                              {idx + 1}. {fileObj.file?.name || fileObj.name}
                            </span>
                            {/* v1.14.1: Seletor sempre visÃ­vel */}
                            <ProcessingModeSelector
                              value={documentProcessingModes.contestacoes?.[idx] || 'pdfjs'}
                              onChange={(mode: ProcessingMode) => setContestacaoMode(idx, mode)}
                              className="mx-2"
                              anonymizationEnabled={aiIntegration.aiSettings?.anonymization?.enabled}
                              grokEnabled={aiIntegration.aiSettings?.provider === 'grok'}
                            />
                            <button
                              onClick={async () => {
                                const fileToRemove = contestacaoFiles[idx];
                                if (fileToRemove?.id) {
                                  try { await removePdfFromIndexedDB(`upload-contestacao-${fileToRemove.id}`); } catch {}
                                }
                                setContestacaoFiles(prev => prev.filter((_, i: number) => i !== idx));
                                setDocumentProcessingModes(prev => ({
                                  ...prev,
                                  contestacoes: (prev.contestacoes || []).filter((_, i: number) => i !== idx)
                                }));
                              }}
                              className="text-red-400 hover-text-red-300"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                        {/* v1.12.17: SÃ³ mostra PDFs importados se nÃ£o houver contestacaoFiles (evita duplicaÃ§Ã£o) */}
                        {contestacaoFiles.length === 0 && analyzedDocuments.contestacoes?.map((_, idx) => (
                          <div key={`imported-pdf-${idx}`} className="flex items-center justify-between text-sm bg-blue-900/20 p-2 rounded border border-blue-500/30">
                            <span className="theme-text-blue truncate flex-1 flex items-center gap-2">
                              <FileText className="w-3 h-3 text-blue-400" />
                              {idx + 1}. ContestaÃ§Ã£o {idx + 1} (PDF importado)
                            </span>
                            <button
                              onClick={() => {
                                const newDocs = { ...analyzedDocuments };
                                newDocs.contestacoes = newDocs.contestacoes.filter((_, i: number) => i !== idx);
                                setAnalyzedDocuments(newDocs);
                              }}
                              className="ml-2 text-red-400 hover-text-red-300"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                        {pastedContestacaoTexts.map((contestacao, idx) => (
                          <div key={`text-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 p-2 rounded border border-green-500/30">
                            <span
                              className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                              onClick={() => setTextPreview({ isOpen: true, title: contestacao.name, text: contestacao.text })}
                            >
                              <FileText className="w-3 h-3 text-green-400" />
                              {contestacaoFiles.length + (analyzedDocuments.contestacoes?.length || 0) + idx + 1}. {contestacao.name} (Texto - {contestacao.text.length.toLocaleString()} caracteres)
                            </span>
                            <button
                              onClick={() => removePastedText('contestacao', idx)}
                              className="ml-2 text-red-400 hover-text-red-300"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                        {analyzedDocuments.contestacoesText?.map((doc, idx) => (
                          <div key={`imported-text-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 p-2 rounded border border-green-500/30">
                            <span
                              className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                              onClick={() => setTextPreview({ isOpen: true, title: doc.name, text: doc.text })}
                            >
                              <FileText className="w-3 h-3 text-green-400" />
                              {contestacaoFiles.length + (analyzedDocuments.contestacoes?.length || 0) + pastedContestacaoTexts.length + idx + 1}. {doc.name} (Texto importado - {doc.text.length.toLocaleString()} caracteres)
                            </span>
                            <button
                              onClick={() => {
                                const newDocs = { ...analyzedDocuments };
                                newDocs.contestacoesText = newDocs.contestacoesText.filter((_, i: number) => i !== idx);
                                setAnalyzedDocuments(newDocs);
                              }}
                              className="ml-2 text-red-400 hover-text-red-300"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>

                {/* SeÃ§Ã£o de Documentos Complementares */}
                <div className="border-t theme-border-secondary pt-6">
                  <div className="mb-4">
                    <h3 className="text-lg font-semibold theme-text-secondary mb-1">
                      ğŸ“ Documentos Complementares (Opcional)
                    </h3>
                    <p className={CSS.textMuted}>
                      Atas de audiÃªncia, transcriÃ§Ãµes, impugnaÃ§Ãµes, provas, etc. Estes documentos NÃƒO sÃ£o usados nos mini-relatÃ³rios automÃ¡ticos, mas podem ser consultados pela IA quando vocÃª solicitar durante a redaÃ§Ã£o.
                    </p>
                  </div>
                  
                  <div
                    style={{ borderColor: '#475569', transition: 'border-color 0.3s ease' }}
                    className="border-2 border-dashed rounded-lg p-6 text-center hover-border-purple-500"
                  >
                    <input
                      type="file"
                      accept=".pdf"
                      multiple
                      onChange={async (e) => {
                        const files = Array.from(e.target.files || []);
                        if (files.length === 0) return;

                        // v1.13.7: Usar handleUploadComplementary para salvar no IndexedDB
                        handleUploadComplementary(files);

                        // v1.12.18: Definir modos de processamento padrÃ£o para complementares
                        const defaultMode = getDefaultProcessingMode();
                        setDocumentProcessingModes(prev => ({
                          ...prev,
                          complementares: files.map(() => defaultMode)
                        }));

                        if (!processoNumero) {
                          try {
                            const numeroDetectado = await documentServices.autoDetectProcessoNumero({
                              peticao: peticaoFiles[0]?.file || peticaoFiles[0],
                              contestacoes: contestacaoFiles.map(f => f.file || f),
                              complementares: files
                            });

                            if (numeroDetectado) {
                              setProcessoNumero(numeroDetectado);
                            }
                          } catch (err) {
                            // Silencioso - nÃ£o bloqueia upload se falhar
                          }
                        }
                      }}
                      className="hidden"
                      id="complementary"
                    />
                    <label htmlFor="complementary" className="cursor-pointer">
                      <Upload className="w-10 h-10 mx-auto mb-2 theme-text-muted" />
                      <p className="theme-text-tertiary font-medium">
                        {complementaryFiles.length > 0
                          ? `${complementaryFiles.length} documento${complementaryFiles.length > 1 ? 's' : ''} complementar${complementaryFiles.length > 1 ? 'es' : ''}`
                          : (analyzedDocuments.complementares?.length > 0 || pastedComplementaryTexts.length > 0)
                          ? `âœ“ ${(analyzedDocuments.complementares?.length || 0) + pastedComplementaryTexts.length} importado${((analyzedDocuments.complementares?.length || 0) + pastedComplementaryTexts.length) > 1 ? 's' : ''}`
                          : 'Clique para adicionar documentos complementares'}
                      </p>
                      <p className="theme-text-disabled text-sm mt-1">MÃºltiplos PDFs atÃ© 10MB cada</p>
                    </label>
                  </div>
                  
                  {/* OpÃ§Ã£o de colar texto */}
                  <div className="text-center mt-3">
                    <p className="theme-text-disabled text-xs mb-2">â€” OU â€”</p>
                    {!showPasteArea.complementary ? (
                      <button
                        onClick={() => setShowPasteArea({ ...showPasteArea, complementary: true })}
                        className="text-sm flex items-center gap-2 mx-auto hover-text-purple-400-from-400"
                      >
                        <FileText className="w-4 h-4" />
                        Colar texto de documento complementar (Ctrl+V)
                      </button>
                    ) : (
                      <div className="theme-bg-secondary-30 rounded-lg p-4">
                        <p className="text-xs theme-text-muted mb-2">Cole o texto do documento complementar abaixo:</p>
                        <textarea
                          className="w-full h-32 theme-bg-primary border theme-border-input rounded p-2 text-sm theme-text-secondary resize-none focus:border-purple-500 focus:outline-none"
                          placeholder="Cole o texto aqui (Ctrl+V)..."
                          onPaste={(e) => {
                            const text = e.clipboardData.getData('text');
                            handlePastedText(text, 'complementary');
                          }}
                          onKeyDown={(e) => {
                            if (e.ctrlKey && e.key === 'Enter') {
                              const text = (e.target as HTMLTextAreaElement).value;
                              handlePastedText(text, 'complementary');
                            }
                          }}
                        />
                        <div className="flex gap-2 mt-2">
                          <button
                            onClick={(e) => {
                              const textarea = (e.target as Element).closest('.theme-bg-secondary\\/30')?.querySelector('textarea');
                              if (textarea) handlePastedText(textarea.value, 'complementary');
                            }}
                            className="hover-purple-700 flex-1 py-2 rounded text-sm bg-purple-600 text-white"
                          >
                            Confirmar
                          </button>
                          <button
                            onClick={() => setShowPasteArea({ ...showPasteArea, complementary: false })}
                            className="px-4 py-2 theme-bg-tertiary rounded hover-slate-700 text-sm"
                          >
                            Cancelar
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  {(complementaryFiles.length > 0 || pastedComplementaryTexts.length > 0 || analyzedDocuments.complementares?.length > 0 || analyzedDocuments.complementaresText?.length > 0) && (
                    <div className="mt-3 bg-purple-900/20 border border-purple-500/30 rounded-lg p-4 space-y-2">
                      <p className="text-xs theme-text-purple font-medium flex items-center gap-2">
                        <FileText className="w-4 h-4" />
                        Documentos complementares anexados:
                      </p>
                      {/* v1.12.18: Complementares com seletor de modo de processamento */}
                      {complementaryFiles.map((fileObj, idx) => (
                        <div key={`file-${fileObj.id || idx}`} className="flex items-center justify-between text-sm theme-bg-primary-50 rounded p-2">
                          <span className="theme-text-tertiary truncate flex-1 flex items-center gap-2">
                            <FileText className="w-3 h-3 text-purple-400" />
                            {idx + 1}. {fileObj.file?.name || fileObj.name}
                          </span>
                          {/* v1.14.1: Seletor sempre visÃ­vel */}
                          <ProcessingModeSelector
                            value={documentProcessingModes.complementares?.[idx] || 'pdfjs'}
                            onChange={(mode: ProcessingMode) => setComplementarMode(idx, mode)}
                            className="mx-2"
                            anonymizationEnabled={aiIntegration.aiSettings?.anonymization?.enabled}
                            grokEnabled={aiIntegration.aiSettings?.provider === 'grok'}
                          />
                          <button
                            onClick={async () => {
                              const fileToRemove = complementaryFiles[idx];
                              if (fileToRemove?.id) {
                                try { await removePdfFromIndexedDB(`upload-complementar-${fileToRemove.id}`); } catch {}
                              }
                              setComplementaryFiles(prev => prev.filter((_, i: number) => i !== idx));
                              setDocumentProcessingModes(prev => ({
                                ...prev,
                                complementares: (prev.complementares || []).filter((_, i: number) => i !== idx)
                              }));
                            }}
                            className="hover-text-red-400-from-300"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                      {/* v1.12.17: SÃ³ mostra PDFs importados se nÃ£o houver complementaryFiles (evita duplicaÃ§Ã£o) */}
                      {complementaryFiles.length === 0 && analyzedDocuments.complementares?.map((_, idx) => (
                        <div key={`imported-pdf-${idx}`} className="flex items-center justify-between text-sm bg-purple-900/20 rounded p-2 border border-purple-500/30">
                          <span className="theme-text-purple truncate flex-1 flex items-center gap-2">
                            <FileText className="w-3 h-3 text-purple-400" />
                            {idx + 1}. Documento complementar {idx + 1} (PDF importado)
                          </span>
                          <button
                            onClick={() => {
                              const newDocs = { ...analyzedDocuments };
                              newDocs.complementares = newDocs.complementares.filter((_, i: number) => i !== idx);
                              setAnalyzedDocuments(newDocs);
                            }}
                            className="ml-2 hover-text-red-400-from-300"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                      {pastedComplementaryTexts.map((doc, idx) => (
                        <div key={`text-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 rounded p-2 border border-green-500/30">
                          <span
                            className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                            onClick={() => setTextPreview({ isOpen: true, title: doc.name, text: doc.text })}
                          >
                            <FileText className="w-3 h-3 text-green-400" />
                            {complementaryFiles.length + (analyzedDocuments.complementares?.length || 0) + idx + 1}. {doc.name} (Texto - {doc.text.length.toLocaleString()} caracteres)
                          </span>
                          <button
                            onClick={() => removePastedText('complementary', idx)}
                            className="ml-2 hover-text-red-400-from-300"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                      {analyzedDocuments.complementaresText?.map((doc, idx) => (
                        <div key={`imported-text-${idx}`} className="flex items-center justify-between text-sm bg-green-900/20 rounded p-2 border border-green-500/30">
                          <span
                            className="theme-text-green truncate flex-1 flex items-center gap-2 cursor-pointer hover:underline"
                            onClick={() => setTextPreview({ isOpen: true, title: doc.name, text: doc.text })}
                          >
                            <FileText className="w-3 h-3 text-green-400" />
                            {complementaryFiles.length + (analyzedDocuments.complementares?.length || 0) + pastedComplementaryTexts.length + idx + 1}. {doc.name} (Texto importado - {doc.text.length.toLocaleString()} caracteres)
                          </span>
                          <button
                            onClick={() => {
                              const newDocs = { ...analyzedDocuments };
                              newDocs.complementaresText = newDocs.complementaresText.filter((_, i: number) => i !== idx);
                              setAnalyzedDocuments(newDocs);
                            }}
                            className="ml-2 hover-text-red-400-from-300"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <button
                  onClick={handleAnalyzeDocuments}
                  disabled={analyzing || (peticaoFiles.length === 0 && pastedPeticaoTexts.length === 0)}
                  className="w-full py-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg bg-gradient-to-r from-blue-600 to-purple-600 text-white hover-gradient-blue-purple"
                >
                  {analyzing ? 'Analisando documentos...' : 'Analisar Documentos'}
                </button>
              </div>
            )}

            {activeTab === 'topics' && (
              <div className="space-y-6">
                {extractedTopics.length === 0 ? (
                  <div className="text-center py-12 theme-text-muted">
                    <FileText className="w-16 h-16 mx-auto mb-4 opacity-50" />
                    <p>Nenhum tÃ³pico extraÃ­do ainda. FaÃ§a upload e anÃ¡lise dos documentos.</p>
                  </div>
                ) : (
                  <>
                    <div>
                      <div className="mb-4 space-y-3">
                        {/* Linha 1: TÃ­tulo e BotÃµes */}
                        <div className="flex items-start justify-between gap-4">
                          <div>
                            <h3 className="text-xl font-bold text-blue-400">
                              Gerenciar TÃ³picos {selectedTopics.length > 0 && `(${selectedTopics.length} selecionados)`}
                            </h3>
                            <p className="text-xs theme-text-muted mt-1 flex items-center gap-2">
                              Clique para selecionar â€¢ <GripVertical className="w-3 h-3" /> Arraste para reordenar â€¢ Use setas e nÃºmeros
                            </p>
                          </div>
                          <div className="flex gap-2 flex-nowrap overflow-x-auto">
                            {topicsToMerge.length >= 2 && (
                              <button
                                onClick={() => openModal('merge')}
                                disabled={aiIntegration.regenerating}
                                className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm disabled:opacity-50 hover-amber-700-from-600 bg-amber-600 text-white transition-colors duration-300"
                              >
                                <Merge className="w-4 h-4" />
                                Unir {topicsToMerge.length} Selecionados
                              </button>
                            )}
                            <button
                              onClick={() => openModal('newTopic')}
                              className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm hover-green-700-from-600 bg-emerald-600 text-white transition-colors duration-300"
                            >
                              <PlusCircle className="w-4 h-4" />
                              Novo TÃ³pico
                            </button>
                            {/* v1.11.0: BotÃ£o de EdiÃ§Ã£o Global */}
                            {selectedTopics.length > 0 && (
                              <button
                                onClick={() => openModal('globalEditor')}
                                className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm hover-cyan-700-from-600 bg-cyan-600 text-white transition-colors duration-300"
                              >
                                <Edit className="w-4 h-4" />
                                EdiÃ§Ã£o Global
                              </button>
                            )}
                            {selectedTopics.length > 0 && (
                              <>
                                {/* v1.21.21: BotÃ£o Revisar SentenÃ§a */}
                                <div className="relative group">
                                  <button
                                    onClick={() => openModal('sentenceReview')}
                                    disabled={!canGenerateDispositivo.enabled || generatingReview}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm text-white transition-all ${
                                      !canGenerateDispositivo.enabled || generatingReview
                                        ? 'opacity-50 cursor-not-allowed'
                                        : 'hover-amber-700-from-600'
                                    }`}
                                    style={{
                                      backgroundColor: canGenerateDispositivo.enabled && !generatingReview ? '#d97706' : '#6b7280',
                                      transition: 'background-color 0.3s ease'
                                    }}
                                  >
                                    {generatingReview ? (
                                      <>
                                        <div className={CSS.spinner}></div>
                                        <span>Revisando...</span>
                                      </>
                                    ) : (
                                      <>
                                        <Scale className="w-4 h-4" />
                                        Revisar SentenÃ§a
                                      </>
                                    )}
                                  </button>
                                  {/* Tooltip quando desabilitado */}
                                  {!canGenerateDispositivo.enabled && !generatingReview && (
                                    <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 theme-bg-primary text-white text-xs rounded-lg shadow-lg border border-amber-500/50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 max-w-xs">
                                      <div className="flex items-start gap-2">
                                        <span className="text-xl flex-shrink-0">âš ï¸</span>
                                        <span>{canGenerateDispositivo.reason}</span>
                                      </div>
                                      <div className="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-amber-500/50"></div>
                                    </div>
                                  )}
                                </div>
                                {/* v1.5.14: BotÃ£o com validaÃ§Ã£o e tooltip */}
                                <div className="relative group">
                                  <button
                                    onClick={generateDispositivo}
                                    disabled={!canGenerateDispositivo.enabled || aiIntegration.generatingDispositivo}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm text-white transition-all ${
                                      !canGenerateDispositivo.enabled || aiIntegration.generatingDispositivo
                                        ? 'opacity-50 cursor-not-allowed'
                                        : 'hover-purple-700-from-600'
                                    }`}
                                    style={{
                                      backgroundColor: canGenerateDispositivo.enabled && !aiIntegration.generatingDispositivo ? '#9333ea' : '#6b7280',
                                      transition: 'background-color 0.3s ease'
                                    }}
                                  >
                                    {aiIntegration.generatingDispositivo ? (
                                      <>
                                        <div className={CSS.spinner}></div>
                                        <span>Gerando...</span>
                                      </>
                                    ) : (
                                      <>
                                        <Sparkles className="w-4 h-4" />
                                        Gerar Dispositivo
                                      </>
                                    )}
                                  </button>

                                  {/* Tooltip explicativo quando desabilitado - v1.5.14: Otimizado para mÃºltiplos tÃ³picos */}
                                  {!canGenerateDispositivo.enabled && !aiIntegration.generatingDispositivo && (
                                    <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 theme-bg-primary text-white text-xs rounded-lg shadow-lg border border-amber-500/50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 max-w-xs">
                                      <div className="flex items-start gap-2">
                                        <span className="text-xl flex-shrink-0">âš ï¸</span>
                                        <span>{canGenerateDispositivo.reason}</span>
                                      </div>
                                      <div className="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-amber-500/50"></div>
                                    </div>
                                  )}
                                </div>
                                <button
                                  onClick={exportDecision}
                                  className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm hover-blue-700-from-600 bg-blue-600 text-white transition-colors duration-300"
                                >
                                  <Download className="w-4 h-4" />
                                  Exportar Minuta Completa
                                </button>
                              </>
                            )}
                          </div>
                        </div>
                        
                        {/* Linha 2: Contadores de Status */}
                        <div className="flex items-center gap-3 flex-wrap">
                          <div className="flex items-center gap-2 px-3 py-1.5 theme-bg-green-accent rounded-lg border border-green-500/30">
                            <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                            <span className="text-xs theme-text-green font-medium">
                              {topicsDecididos} Decididos
                            </span>
                          </div>
                          <div className="flex items-center gap-2 px-3 py-1.5 theme-bg-amber-accent rounded-lg border border-amber-500/30">
                            <span className="w-2 h-2 bg-amber-500 rounded-full"></span>
                            <span className="text-xs theme-text-amber font-medium">
                              {topicsPendentes} Pendentes
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* Aviso sobre mini-relatÃ³rios gerados por IA */}
                      <div className="mb-4 p-3 theme-bg-blue-accent border border-blue-500/30 rounded-lg">
                        <div className="flex items-start gap-2">
                          <span className="theme-text-blue text-sm">â„¹ï¸</span>
                          <div className="text-xs theme-text-blue-muted">
                            <p>Os mini-relatÃ³rios foram gerados automaticamente por IA. Revise-os e complemente com informaÃ§Ãµes relevantes antes de decidir.</p>
                            <p className="mt-1 theme-text-blue-muted">Sua revisÃ£o Ã© fundamental, na forma estabelecida pela <span className="font-semibold">ResoluÃ§Ã£o 615/2025 do CNJ</span>.</p>
                          </div>
                        </div>
                      </div>
                      
                      <div className="space-y-2">
                        {/* v1.33.59: DndContext com collision detection customizado (ignora RELATÃ“RIO/DISPOSITIVO) */}
                        <DndContext
                          sensors={dndSensors}
                          collisionDetection={customCollisionDetection}
                          onDragEnd={handleDndDragEnd}
                        >
                          <SortableContext
                            items={selectedTopics.map(t => t.id || t.title)}
                            strategy={verticalListSortingStrategy}
                          >
                            {/* Renderizar tÃ³picos selecionados primeiro (na ordem correta) - v1.33.58: SortableTopicCard */}
                            {selectedTopics.map((topic, selectedIdx) => (
                              <SortableTopicCard
                                key={topic.id || topic.title}
                                id={String(topic.id || topic.title)}
                                topic={topic}
                                selectedIdx={selectedIdx}
                                topicRefs={topicRefs}
                                lastEditedTopicTitle={lastEditedTopicTitle}
                                selectedTopics={selectedTopics}
                                extractedTopics={extractedTopics}
                                topicsToMerge={topicsToMerge}
                                toggleTopicSelection={toggleTopicSelection}
                                moveTopicUp={moveTopicUp}
                                moveTopicDown={moveTopicDown}
                                moveTopicToPosition={moveTopicToPosition}
                                setSelectedTopics={setSelectedTopics}
                                setExtractedTopics={setExtractedTopics}
                                startEditing={startEditing}
                                setTopicToRename={setTopicToRename}
                                setNewTopicName={setNewTopicName}
                                openModal={openModal}
                                setTopicToSplit={setTopicToSplit}
                                setTopicsToMerge={setTopicsToMerge}
                              />
                            ))}
                          </SortableContext>
                        </DndContext>

                        {/* Renderizar tÃ³picos NÃƒO selecionados por Ãºltimo */}
                        {/* v1.4.6.2: OPT-01 - Memoizado no corpo do componente (linha 10546) */}
                        {unselectedTopics.map((topic, idx) => {
                            const isRelatorioOrDispositivo = isSpecialTopic(topic);
                            
                            return (
                          <div
                            key={topic.title}
                            className="p-4 rounded-lg border-2 transition-all theme-bg-secondary-30 theme-border-input hover-theme-border hover-slate-700/50"
                          >
                            <div className="flex items-start justify-between gap-4">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2 flex-wrap">
                                  {/* Seletor de categoria - editÃ¡vel (nÃ£o mostrar para RELATÃ“RIO e DISPOSITIVO) */}
                                  {!isRelatorioOrDispositivo && (
                                    <select
                                      value={topic.category || 'MÃ‰RITO'}
                                      onChange={(e) => {
                                        e.stopPropagation();
                                        const newExtracted = [...extractedTopics];
                                        const extractedIndex = extractedTopics.findIndex((t: Topic) => t.title === topic.title);
                                        if (extractedIndex !== -1) {
                                          newExtracted[extractedIndex] = { ...newExtracted[extractedIndex], category: e.target.value as TopicCategory };
                                          setExtractedTopics(newExtracted);
                                        }
                                      }}
                                      onClick={(e) => e.stopPropagation()}
                                      className="text-xs px-2 py-1 rounded cursor-pointer font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 border-2 theme-border theme-text-secondary hover-category-select"
                                      title="Clique para alterar a categoria"
                                    >
                                      <option value="PRELIMINAR">ğŸ“‹ Preliminar</option>
                                      <option value="PREJUDICIAL">âš ï¸ Prejudicial</option>
                                      <option value="MÃ‰RITO">âš–ï¸ MÃ©rito</option>
                                      <option value="PROCESSUAL">ğŸ“ Processual</option>
                                    </select>
                                  )}
                                  
                                  <h4 
                                    className="font-semibold theme-text-primary cursor-pointer"
                                    onClick={() => toggleTopicSelection(topic)}
                                  >
                                    {topic.title.toUpperCase()}
                                  </h4>
                                  {/* Indicador de status de decisÃ£o - nÃ£o mostrar para RELATÃ“RIO e DISPOSITIVO */}
                                  {topic.title.toUpperCase() !== 'RELATÃ“RIO' && topic.title.toUpperCase() !== 'DISPOSITIVO' && (
                                    isTopicDecidido(topic) ? (
                                      <span className="flex items-center gap-1 text-xs theme-bg-green-accent theme-text-green px-2 py-1 rounded border border-green-500/30">
                                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                        Decidido
                                      </span>
                                    ) : (
                                      <span className="flex items-center gap-1 text-xs theme-bg-amber-accent theme-text-amber px-2 py-1 rounded border border-amber-500/30">
                                        <span className="w-2 h-2 bg-amber-500 rounded-full"></span>
                                        Pendente
                                      </span>
                                    )
                                  )}
                                </div>
                              </div>
                              <div className={CSS.flexGap2}>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    deleteTopic(topic);
                                  }}
                                  className="p-2 rounded hover-delete-topic"
                                  title="Excluir tÃ³pico"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                                <div className="flex flex-col items-center gap-1">
                                  <span className="text-xs theme-text-disabled">Clique para selecionar</span>
                                  <input
                                    type="checkbox"
                                    checked={false}
                                    onChange={(e) => {
                                      e.stopPropagation();
                                      toggleTopicSelection(topic);
                                    }}
                                    className="w-5 h-5 rounded cursor-pointer"
                                  />
                                </div>
                              </div>
                            </div>
                          </div>
                          );
                        })}
                      </div>
                    </div>
                  </>
                )}
              </div>
            )}

            {activeTab === 'proofs' && (
              <div className="space-y-6">
                {/* v1.36.36: Aviso removido - bloqueio visual no seletor Ã© suficiente */}

                <div className="theme-gradient-card-50 rounded-lg p-6 border theme-border-secondary">
                  <div className="flex items-start justify-between mb-6">
                    <div>
                      <h3 className="text-xl font-bold text-blue-400 mb-2">GestÃ£o de Provas</h3>
                      <p className="text-sm theme-text-muted">
                        FaÃ§a upload de documentos probatÃ³rios, analise com IA e vincule aos tÃ³picos da decisÃ£o
                      </p>
                    </div>
                    <Scale className="w-8 h-8 text-blue-400 opacity-50" />
                  </div>

                  {/* SeÃ§Ã£o de Upload */}
                  <div className="space-y-4 mb-8">
                    <h4 className="text-lg font-semibold theme-text-secondary flex items-center gap-2">
                      <Upload className="w-5 h-5" />
                      Upload de Provas
                    </h4>

                    {/* Upload de PDF */}
                    <div className="border-2 border-dashed theme-border-input rounded-lg p-6 hover-border-blue-500 transition-colors">
                      <input
                        type="file"
                        accept="application/pdf"
                        multiple
                        onChange={(e) => {
                          const files = Array.from(e.target.files || []);
                          if (files.length > 0) {
                            proofManager.handleUploadProofPdf(files);
                          }
                          e.target.value = '';
                        }}
                        className="hidden"
                        id="proof-pdf-upload"
                      />
                      <label
                        htmlFor="proof-pdf-upload"
                        className="flex flex-col items-center cursor-pointer"
                      >
                        <Upload className="w-12 h-12 theme-text-muted mb-3" />
                        <p className="theme-text-tertiary font-medium mb-1">Clique para fazer upload de PDFs</p>
                        <p className="text-sm theme-text-disabled">Suporta mÃºltiplos arquivos PDF</p>
                      </label>
                    </div>

                    {/* Ãrea para colar texto */}
                    <div className="space-y-2">
                      <button
                        onClick={() => {
                          proofManager.setNewProofTextData({ name: '', text: '' });
                          openModal('addProofText');
                        }}
                        className="w-full py-3 theme-bg-secondary rounded-lg hover-slate-600 transition-colors flex items-center justify-center gap-2"
                      >
                        <FileText className="w-4 h-4" />
                        Colar Texto como Prova
                      </button>
                    </div>
                  </div>

                  {/* Lista de Provas */}
                  <div className="space-y-4">
                    <h4 className="text-lg font-semibold theme-text-secondary flex items-center gap-2">
                      <FileText className="w-5 h-5" />
                      Provas Enviadas ({proofManager.proofFiles.length + proofManager.proofTexts.length})
                    </h4>

                    {proofManager.proofFiles.length === 0 && proofManager.proofTexts.length === 0 ? (
                      <div className="text-center py-12 theme-text-muted border border-dashed theme-border-input rounded-lg">
                        <Scale className="w-16 h-16 mx-auto mb-4 opacity-30" />
                        <p>Nenhuma prova enviada ainda</p>
                        <p className="text-sm mt-2">FaÃ§a upload de PDFs ou cole textos acima</p>
                      </div>
                    ) : extractedTopics.length === 0 ? (
                      <div className="bg-amber-900/20 border border-amber-500/30 rounded-lg p-4">
                        <p className="text-sm theme-text-amber flex items-start gap-2">
                          <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                          <span>
                            <strong>AtenÃ§Ã£o:</strong> Para vincular provas a tÃ³picos, primeiro analise os documentos na aba "Upload & AnÃ¡lise".
                          </span>
                        </p>
                      </div>
                    ) : (
                      <div className="space-y-3">
                        {/* ğŸš€ v1.8.2: Componentizado com ProofCard - PROVAS EM PDF */}
                        {proofManager.proofFiles.map((proof: Proof) => (
                          <ProofCard
                            key={proof.id}
                            proof={proof}
                            isPdf={true}
                            proofManager={proofManager}
                            openModal={openModal}
                            setError={setError}
                            extractTextFromPDFWithMode={documentServices.extractTextFromPDFWithMode}
                            anonymizationEnabled={aiIntegration.aiSettings?.anonymization?.enabled}
                            grokEnabled={aiIntegration.aiSettings?.provider === 'grok'}
                            anonConfig={aiIntegration.aiSettings?.anonymization}
                            nomesParaAnonimizar={aiIntegration.aiSettings?.anonymization?.nomesUsuario || []}
                            editorTheme={appTheme as 'dark' | 'light' | undefined}
                            setTextPreview={setTextPreview}
                          />
                        ))}

                        {/* ğŸš€ v1.8.2: Componentizado com ProofCard - PROVAS EM TEXTO */}
                        {proofManager.proofTexts.map((proof: Proof) => (
                          <ProofCard
                            key={proof.id}
                            proof={proof}
                            isPdf={false}
                            proofManager={proofManager}
                            openModal={openModal}
                            setError={setError}
                            extractTextFromPDFWithMode={documentServices.extractTextFromPDFWithMode}
                            anonymizationEnabled={aiIntegration.aiSettings?.anonymization?.enabled}
                            grokEnabled={aiIntegration.aiSettings?.provider === 'grok'}
                            anonConfig={aiIntegration.aiSettings?.anonymization}
                            nomesParaAnonimizar={aiIntegration.aiSettings?.anonymization?.nomesUsuario || []}
                            editorTheme={appTheme as 'dark' | 'light' | undefined}
                            setTextPreview={setTextPreview}
                          />
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'editor' && (
              <div ref={editorContainerRef} className="space-y-6">
                {!editingTopic ? (
                  <div className="text-center py-12 theme-text-muted">
                    <FileText className="w-16 h-16 mx-auto mb-4 opacity-50" />
                    <p>Selecione um tÃ³pico na aba "TÃ³picos" para editar</p>
                  </div>
                ) : (
                  <div className="relative grid lg:grid-cols-3 gap-6">
                    {/* v1.32.00: Overlay removido - IA roda em worker */}
                    <div className="lg:col-span-2">
                      {/* Componente ExtraÃƒÂ­do - DecisionEditorContainer */}
                      <DecisionEditorContainer
                        ref={editorContainerRef}
                        editorRef={editorRef}
                        relatorioRef={relatorioRef}
                        topic={editingTopic}
                        onSave={saveTopicEdit}
                        onCancel={() => {
                          setLastEditedTopicTitle(editingTopic.title);
                          setEditingTopic(null);
                          modelLibrary.setSuggestions([]);
                          setActiveTab('topics');
                        }}
                        onSaveWithoutClosing={saveTopicEditWithoutClosing}
                        onCategoryChange={handleCategoryChange}
                        onFundamentacaoChange={handleFundamentacaoChange}
                        onRelatorioChange={handleRelatorioChange}
                        onOpenAIAssistant={() => openModal('aiAssistant')}
                        onOpenJurisModal={() => openModal('jurisIndividual')}
                        onExtractModel={confirmExtractModel}
                        onSaveAsModel={saveAsModel}
                        onRegenerateRelatorio={
                          isRelatorio(editingTopic)
                            ? regenerateRelatorioProcessual
                            : regenerateRelatorioWithInstruction
                        }
                        savingTopic={savingTopic}
                        extractingModel={modelLibrary.extractingModelFromDecision}
                        showExtractButton={modelLibrary.showExtractModelButton}
                        regeneratingRelatorio={aiIntegration.regeneratingRelatorio}
                        relatorioInstruction={aiIntegration.relatorioInstruction}
                        onInstructionChange={aiIntegration.setRelatorioInstruction}
                        sanitizeHTML={sanitizeHTML}
                        selectedTopics={selectedTopics}
                        setSelectedTopics={setSelectedTopics}
                        extractedTopics={extractedTopics}
                        setExtractedTopics={setExtractedTopics}
                                              getTopicEditorConfig={getTopicEditorConfig}
                                              quillReady={quillReady}
                        quillError={quillError}
                                              onRegenerateDispositivo={regenerateDispositivoWithInstruction}
                        dispositivoInstruction={aiIntegration.dispositivoInstruction}
                        onDispositivoInstructionChange={aiIntegration.setDispositivoInstruction}
                        regeneratingDispositivo={aiIntegration.regeneratingDispositivo}
                        editorTheme={editorTheme as 'dark' | 'light' | undefined}
                        toggleEditorTheme={toggleEditorTheme}
                        models={modelLibrary.models}
                        onInsertModel={insertModelContent}
                        onPreviewModel={modelPreview.openPreview}
                        findSuggestions={findSuggestions}
                        onSlashCommand={openSlashMenu}
                        isDirty={isIndividualDirty}
                        versioning={fieldVersioning}
                        onOpenFactsComparison={editingTopic?.title?.toUpperCase() !== 'DISPOSITIVO' && editingTopic?.title?.toUpperCase() !== 'RELATÃ“RIO' ? handleOpenFactsComparisonIndividual : null}
                      />
                    </div>

                    <div className="space-y-4">
                          {/* Painel de Provas Vinculadas */}
                          {linkedProofs.length > 0 && (
                          <div className="theme-bg-green-accent rounded-lg border border-green-500/30 overflow-hidden">
                            <div
                              className="p-4 border-b border-green-500/30 flex items-center justify-between cursor-pointer hover-proof-panel"
                              onClick={() => proofManager.setShowProofPanel(!proofManager.showProofPanel)}
                            >
                              <div className={CSS.flexGap2}>
                                <Scale className="w-5 h-5 theme-text-green" />
                                <h4 className="font-bold theme-text-green">
                                  Provas Vinculadas ({linkedProofs.length})
                                </h4>
                              </div>
                              <button className="theme-text-green hover-text-green-300">
                                {proofManager.showProofPanel ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
                              </button>
                            </div>

                            {proofManager.showProofPanel && (
                              <div className="p-4 space-y-3 max-h-96 overflow-y-auto">
                                {linkedProofs.map((proof: Proof) => (
                                  <div
                                    key={proof.id}
                                    className="theme-bg-secondary-50 rounded-lg p-3 border theme-border-input"
                                  >
                                    <div className="flex items-center gap-2 mb-2">
                                      <FileText className="w-4 h-4 text-blue-400 flex-shrink-0" />
                                      <h5 className="font-medium theme-text-secondary text-sm flex-1 truncate">{proof.name}</h5>
                                      <span className={`px-2 py-0.5 text-xs rounded ${
                                        (proof.isPdf && proofManager.proofUsePdfMode[proof.id] !== false)
                                          ? 'theme-bg-red-accent theme-text-red'
                                          : 'theme-bg-blue-accent theme-text-blue'
                                      }`}>
                                        {(proof.isPdf && proofManager.proofUsePdfMode[proof.id] !== false) ? 'PDF' : 'TEXTO'}
                                      </span>
                                    </div>

                                    {/* AnÃ¡lise IA */}
                                    {proofManager.proofAnalysisResults[proof.id] && (
                                      <div className="mb-2 p-2 theme-bg-blue-accent border border-blue-500/30 rounded text-xs">
                                        <div className="flex items-center gap-1 mb-1">
                                          <Sparkles className="w-3 h-3 theme-text-blue" />
                                          <span className="font-medium theme-text-blue">
                                            {proofManager.proofAnalysisResults[proof.id].type === 'livre' ? 'AnÃ¡lise Livre' : 'AnÃ¡lise Contextual'}
                                          </span>
                                        </div>
                                        <div className="max-h-32 overflow-y-auto">
                                          <p className="theme-text-tertiary whitespace-pre-wrap">
                                            {proofManager.proofAnalysisResults[proof.id].result}
                                          </p>
                                        </div>
                                      </div>
                                    )}

                                    {/* ConclusÃµes Manuais */}
                                    {proofManager.proofConclusions[proof.id] && (
                                      <div className="p-2 theme-bg-green-accent border border-green-500/30 rounded text-xs">
                                        <div className="flex items-center gap-1 mb-1">
                                          <Edit className="w-3 h-3 theme-text-green" />
                                          <span className="font-medium theme-text-green">Minhas ConclusÃµes</span>
                                        </div>
                                        <div className="max-h-24 overflow-y-auto">
                                          <p className="theme-text-tertiary whitespace-pre-wrap">
                                            {proofManager.proofConclusions[proof.id]}
                                          </p>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                          )}

                          <h4 className="font-bold text-purple-400">ğŸ’¡ SugestÃµes de Modelos</h4>

                      {/* Campo de busca manual */}
                      <div className="theme-bg-secondary-30 rounded-lg p-3 border theme-border-input">
                        <label className={CSS.label}>
                          ğŸ” Busca Manual
                        </label>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={modelLibrary.manualSearchTerm}
                            onChange={(e) => {
                              modelLibrary.setManualSearchTerm(e.target.value);
                              // v1.33.19: SÃ³ faz busca textual se nÃ£o estiver em modo semÃ¢ntico
                              if (!useSemanticManualSearch) {
                                modelLibrary.debouncedManualSearch(e.target.value);
                              }
                            }}
                            placeholder={useSemanticManualSearch ? "Busca por significado..." : "Digite para buscar modelos por tÃ­tulo, palavras-chave ou conteÃºdo..."}
                            className="flex-1 px-3 py-2 theme-bg-primary border theme-border-input rounded-lg theme-text-primary text-sm theme-placeholder focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all"
                          />
                          {modelLibrary.manualSearchTerm && (
                            <button
                              onClick={() => {
                                modelLibrary.setManualSearchTerm('');
                                modelLibrary.setManualSearchResults([]);
                                setSemanticManualSearchResults(null);
                              }}
                              className="px-3 py-2 theme-bg-tertiary rounded-lg hover-slate-700 transition-colors text-sm"
                              title="Limpar busca"
                            >
                              âœ•
                            </button>
                          )}
                          {/* v1.33.19: Toggle busca semÃ¢ntica/textual */}
                          {searchModelReady && (
                            <button
                              onClick={() => {
                                setUseSemanticManualSearch(prev => !prev);
                                // Limpar resultados ao alternar modo
                                modelLibrary.setManualSearchResults([]);
                                setSemanticManualSearchResults(null);
                              }}
                              className={`px-2 py-1 rounded text-sm transition-colors ${
                                useSemanticManualSearch
                                  ? 'bg-purple-600 text-white hover:bg-purple-700'
                                  : 'theme-bg-tertiary theme-text-secondary hover:bg-slate-600'
                              }`}
                              title={useSemanticManualSearch ? 'Busca semÃ¢ntica (por significado)' : 'Busca textual (por palavras)'}
                            >
                              {useSemanticManualSearch ? 'ğŸ§ ' : 'ğŸ”¤'}
                            </button>
                          )}
                        </div>
                        {semanticManualSearching && (
                          <p className="text-xs text-purple-400 mt-2 flex items-center gap-1">
                            <span className="animate-spin inline-block w-3 h-3 border border-purple-400 border-t-transparent rounded-full"></span>
                            Buscando por significado...
                          </p>
                        )}
                        {!semanticManualSearching && modelLibrary.manualSearchTerm && modelLibrary.manualSearchResults.length > 0 && (
                          <p className="text-xs theme-text-muted mt-2">
                            {modelLibrary.manualSearchResults.length} modelo{modelLibrary.manualSearchResults.length > 1 ? 's' : ''} encontrado{modelLibrary.manualSearchResults.length > 1 ? 's' : ''}
                            {useSemanticManualSearch && <span className="ml-1 text-purple-400">(semÃ¢ntica)</span>}
                          </p>
                        )}
                      </div>

                      {/* Resultados da busca manual */}
                      {modelLibrary.manualSearchResults.length > 0 ? (
                        <div className="space-y-3">
                          <p className="text-sm text-blue-400 font-medium">Resultados da Busca:</p>
                          {modelLibrary.manualSearchResults.map((model, idx) => (
                            <SuggestionCard
                              key={model.id || `manual-${idx}`}
                              model={model}
                              similarity={model.similarity}
                              index={idx}
                              totalSuggestions={modelLibrary.manualSearchResults.length}
                              onPreview={modelPreview.openPreview}
                              onInsert={insertModelContent}
                              sanitizeHTML={sanitizeHTML}
                              showRanking={false}
                            />
                          ))}
                        </div>
                      ) : modelLibrary.manualSearchTerm && modelLibrary.manualSearchResults.length === 0 ? (
                        <p className="theme-text-muted text-sm">Nenhum modelo encontrado para "{modelLibrary.manualSearchTerm}"</p>
                      ) : (
                        <>
                          {/* SugestÃµes automÃ¡ticas */}
                          <div className="border-t theme-border-input pt-4">
                            <p className="text-sm theme-text-muted font-medium mb-3 flex items-center gap-2">SugestÃµes AutomÃ¡ticas:{modelLibrary.suggestionsSource === 'local' && <span className="bg-purple-600 text-white px-1.5 py-0.5 rounded text-[10px]">ğŸ¤– IA Local</span>}</p>
                            {modelLibrary.loadingSuggestions ? (
                              <div className="flex flex-col items-center justify-center py-8 space-y-3">
                                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400"></div>
                                <p className="theme-text-muted text-sm text-center">
                                  Analisando modelos relevantes com IA...
                                </p>
                              </div>
                            ) : modelLibrary.suggestions.length === 0 ? (
                              <p className="theme-text-muted text-sm">Nenhum modelo sugerido automaticamente</p>
                            ) : (
                              <div className="space-y-3">
                                {modelLibrary.suggestions.map((model, idx) => (
                                  <SuggestionCard
                                    key={model.id || idx}
                                    model={model}
                                    similarity={model.similarity}
                                    index={idx}
                                    totalSuggestions={modelLibrary.suggestions.length}
                                    onPreview={modelPreview.openPreview}
                                    onInsert={insertModelContent}
                                    sanitizeHTML={sanitizeHTML}
                                    showRanking={true}
                                  />
                                ))}
                              </div>
                              )
                            }
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'jurisprudencia' && (
              <JurisprudenciaTab
                openModal={openModal}
                closeModal={closeModal}
                modals={modals}
                isReadOnly={!primaryTabLock.isPrimaryTab}
                jurisSemanticEnabled={aiIntegration.aiSettings.jurisSemanticEnabled}
                searchModelReady={searchModelReady}
                jurisEmbeddingsCount={jurisEmbeddingsCount}
                jurisSemanticThreshold={aiIntegration.aiSettings.jurisSemanticThreshold}
              />
            )}

            {activeTab === 'legislacao' && (
              <LegislacaoTab
                openModal={openModal}
                closeModal={closeModal}
                modals={modals}
                isReadOnly={!primaryTabLock.isPrimaryTab}
                semanticSearchEnabled={aiIntegration.aiSettings.semanticSearchEnabled}
                searchModelReady={searchModelReady}
                embeddingsCount={embeddingsCount}
                semanticThreshold={aiIntegration.aiSettings.semanticThreshold}
              />
            )}

            {activeTab === 'models' && (
              <div className="space-y-6">
                {/* v1.6.1: Banner de aviso - Apenas quando hÃ¡ mudanÃ§as nÃ£o exportadas */}
                {modelLibrary.hasUnsavedChanges && modelLibrary.models.length > 0 && (
                  <div className="theme-warning-box p-4 flex items-start gap-3">
                    <svg className="w-6 h-6 text-yellow-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <div className="flex-1">
                      <h4 className="theme-text-primary font-semibold mb-1">âš ï¸ VocÃª tem mudanÃ§as nÃ£o exportadas</h4>
                      <p className="theme-text-secondary text-sm mb-2">
                        HÃ¡ alteraÃ§Ãµes em seus modelos que ainda nÃ£o foram exportadas.
                        Para fazer backup do seu trabalho, <strong>exporte seus modelos antes de sair</strong>.
                      </p>
                      <button
                        onClick={exportModels}
                        className="hover-warning-yellow-btn px-4 py-2 rounded-lg font-semibold shadow-lg"
                        style={{
                          color: '#000',
                          transform: 'scale(1)'
                        }}
                      >
                        ğŸ’¾ Exportar Modelos Agora
                      </button>
                    </div>
                  </div>
                )}

                <div className="flex items-center justify-between flex-wrap gap-4">
                  <div className="flex items-center gap-3 flex-wrap">
                    <h3 className="text-xl font-bold text-purple-400">Banco de Modelos</h3>
                    {/* ğŸ”„ v1.35.55: Bloco de sync movido do header */}
                    {cloudSync?.isAuthenticated && (
                      <div className="flex items-center gap-2">
                        <SyncStatusIndicator
                          status={cloudSync.syncStatus}
                          pendingCount={cloudSync.pendingCount}
                          lastSyncAt={cloudSync.lastSyncAt}
                          onSync={() => {
                            const initialPushDone = localStorage.getItem('sentencify-initial-push-done');
                            if (!initialPushDone && modelLibrary.models.length > 0) {
                              cloudSync.pushAllModels(modelLibrary.models).then((result: { success: boolean }) => {
                                if (result.success) {
                                  localStorage.setItem('sentencify-initial-push-done', 'true');
                                }
                              });
                            } else {
                              cloudSync.sync();
                            }
                          }}
                        />
                        {cloudSync.user?.email && (
                          <span className="text-slate-400 text-xs" title={cloudSync.user.email}>
                            {cloudSync.user.email.length > 25 ? cloudSync.user.email.slice(0, 22) + '...' : cloudSync.user.email}
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                  <div className="flex gap-2 flex-wrap">
                    <button
                      onClick={() => openModal('bulkModal')}
                      className="hover-gradient-blue-purple flex items-center gap-2 px-4 py-2 rounded-lg shadow-lg text-white"
                      style={{
                        backgroundImage: 'linear-gradient(to right, #2563eb, #9333ea)'
                      }}
                      title="Criar mÃºltiplos modelos automaticamente a partir de arquivos usando IA"
                    >
                      <Sparkles className="w-4 h-4" />
                      <Upload className="w-4 h-4" />
                      Criar de Arquivos
                    </button>
                    <button
                      onClick={() => fileInputRef.current?.click()}
                      className="flex items-center gap-2 px-4 py-2 rounded-lg hover-green-700-from-600 bg-emerald-600 text-white transition-colors duration-300"
                      title="Carregar modelos de um arquivo JSON previamente exportado"
                    >
                      <Upload className="w-4 h-4" />
                      Importar
                    </button>
                    <input
                      ref={fileInputRef}
                      type="file"
                      accept=".json"
                      onChange={importModels}
                      className="hidden"
                    />
                    <button
                      onClick={exportModels}
                      className="flex items-center gap-2 px-4 py-2 rounded-lg hover-purple-700-from-600 bg-purple-600 text-white transition-colors duration-300"
                      title="Salvar todos os modelos em um arquivo JSON (necessÃ¡rio para backup)"
                    >
                      <Download className="w-4 h-4" />
                      Exportar
                    </button>
                    <button
                      onClick={() => {
                        if (modals.modelForm) {
                          closeModal('modelForm');
                          modelLibrary.setNewModel({ title: '', content: '', keywords: '', category: '' });
                          modelLibrary.setEditingModel(null);
                          if (modelEditorRef.current?.root) {
                            modelEditorRef.current.root.innerHTML = '';
                          }
                        } else {
                          modelLibrary.setNewModel({ title: '', content: '', keywords: '', category: '' });
                          modelLibrary.setEditingModel(null);
                          openModal('modelForm');

                          // Scroll suave para o topo da pÃ¡gina
                          window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                          });

                          setTimeout(() => {
                            if (modelEditorRef.current?.root) {
                              modelEditorRef.current.root.innerHTML = '';
                              modelEditorRef.current.focus();
                            }
                          }, 50);
                        }
                      }}
                      className="flex items-center gap-2 px-4 py-2 rounded-lg hover-blue-700-from-600 bg-blue-600 text-white transition-colors duration-300"
                    >
                      <Plus className="w-4 h-4" />
                      Novo Modelo
                    </button>

                    {/* v1.35.0: BotÃ£o para compartilhar biblioteca */}
                    {cloudSync.isAuthenticated && (
                      <button
                        onClick={() => openModal('shareLibrary')}
                        className="flex items-center gap-2 px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white transition-colors duration-300"
                        title="Compartilhar biblioteca de modelos"
                      >
                        <Share2 className="w-4 h-4" />
                        Compartilhar
                      </button>
                    )}

                    {/* BotÃ£o minimalista para excluir todos os modelos */}
                    {modelLibrary.models.length > 0 && (
                      <button
                        onClick={() => openModal('deleteAllModels')}
                        className="p-2 rounded hover-delete-all"
                        title="Excluir todos os modelos"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    )}
                  </div>
                </div>

                {/* FormulÃ¡rio de Modelo ExtraÃ­do */}
                <ModelFormModal
                  ref={modelFormRef}
                  isOpen={modals.modelForm}
                  editingModel={modelLibrary.editingModel}
                  newModel={modelLibrary.newModel}
                  setNewModel={modelLibrary.setNewModel}
                  models={modelLibrary.models}
                  onSave={saveModel}
                  onCancel={() => {
                    closeModal('modelForm');
                    modelLibrary.setNewModel({ title: '', content: '', keywords: '', category: '' });
                    modelLibrary.setEditingModel(null);
                    if (modelEditorRef.current?.root) {
                      modelEditorRef.current.root.innerHTML = '';
                    }
                    setModelSaved(false);
                  }}
                  onGenerateKeywords={generateKeywordsWithAI}
                  generatingKeywords={aiIntegration.generatingKeywords}
                  onGenerateTitle={generateTitleWithAI}
                  generatingTitle={aiIntegration.generatingTitle}
                  onSaveWithoutClosing={saveModelWithoutClosing}
                  onOpenAIAssistant={() => openModal('aiAssistantModel')}
                  sanitizeHTML={sanitizeHTML}
                  modelEditorRef={modelEditorRef}
                  quillReady={quillReady}
                  quillError={quillError}
                  editorTheme={editorTheme}
                  toggleEditorTheme={toggleEditorTheme}
                  modelSaved={modelSaved}
                  savingModel={savingModel}
                />

                <div>
                      <div className="grid md:grid-cols-2 gap-4 mb-4">
                        <div className="relative flex items-center gap-2">
                          <div className="relative flex-1">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 theme-text-muted" />
                            <input
                              type="text"
                              value={modelLibrary.searchTerm}
                              onChange={(e) => modelLibrary.setSearchTerm(e.target.value)}
                              onKeyDown={(e) => e.key === 'Escape' && modelLibrary.setSearchTerm('')}
                              className="w-full theme-bg-primary border theme-border-input rounded-lg pl-10 pr-10 py-3 theme-text-primary focus:border-blue-500"
                              placeholder={useModelSemanticSearch ? "Buscar por significado..." : "Buscar modelos..."}
                            />
                            {modelLibrary.searchTerm && (
                              <button onClick={() => modelLibrary.setSearchTerm('')} className="absolute right-3 top-1/2 -translate-y-1/2 p-0.5 theme-text-muted hover-text-primary" title="Limpar (Esc)">
                                <X className="w-4 h-4" />
                              </button>
                            )}
                          </div>
                          {/* v1.27.01: Toggle busca semÃ¢ntica */}
                          {modelSemanticAvailable && (
                            <button
                              onClick={() => {
                                setUseModelSemanticSearch(prev => !prev);
                                setModelSemanticResults(null);
                              }}
                              className={`px-3 py-3 rounded-lg text-lg transition-colors ${
                                useModelSemanticSearch
                                  ? 'bg-purple-600 text-white hover:bg-purple-700'
                                  : 'theme-bg-secondary theme-text-secondary hover-slate-600'
                              }`}
                              title={useModelSemanticSearch ? 'Busca semÃ¢ntica (por significado)' : 'Busca textual (por palavras)'}
                            >
                              {useModelSemanticSearch ? 'ğŸ§ ' : 'ğŸ”¤'}
                            </button>
                          )}
                        </div>
                        <div>
                          <select
                            value={modelLibrary.selectedCategory}
                            onChange={(e) => modelLibrary.setSelectedCategory(e.target.value)}
                            className="w-full theme-bg-primary border theme-border-input rounded-lg px-4 py-3 theme-text-primary focus:border-blue-500"
                          >
                            <option value="all">Todas as categorias ({modelLibrary.models.length})</option>
                            {categories.map((cat, idx) => (
                              <option key={idx} value={cat}>
                                {cat} ({categoryCounts.counts[cat] || 0})
                              </option>
                            ))}
                            <option value="">Sem categoria ({categoryCounts.withoutCategory})</option>
                      </select>
                    </div>
                  </div>
                  
                  {/* Controles de visualizaÃ§Ã£o e favoritos */}
                  <div className="flex items-center justify-between mb-4 gap-4 flex-wrap">
                    <div className={CSS.flexGap2}>
                      <button
                        onClick={() => modelLibrary.setShowFavoritesOnly(!modelLibrary.showFavoritesOnly)}
                        className={`flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${
                          modelLibrary.showFavoritesOnly
                            ? 'bg-yellow-600 hover-yellow-600'
                            : 'theme-bg-secondary hover-slate-600'
                        }`}
                        title="Mostrar apenas favoritos"
                      >
                        <span className="text-lg">{modelLibrary.showFavoritesOnly ? 'â­' : 'â˜†'}</span>
                        <span className="text-sm">
                          {modelLibrary.showFavoritesOnly ? 'Favoritos' : 'Todos'}
                          {modelLibrary.showFavoritesOnly && ` (${categoryCounts.favorites})`}
                        </span>
                      </button>

                      {/* v1.35.0: Filtro de propriedade (Meus/Compartilhados) */}
                      <div className="flex items-center theme-bg-primary rounded-lg p-1">
                        <button
                          onClick={() => modelLibrary.setOwnershipFilter('all')}
                          className={`px-3 py-1.5 rounded text-sm transition-colors ${
                            modelLibrary.ownershipFilter === 'all'
                              ? 'bg-purple-600 text-white'
                              : 'theme-text-muted hover-theme-text-secondary'
                          }`}
                          title="Mostrar todos os modelos"
                        >
                          Todos
                        </button>
                        <button
                          onClick={() => modelLibrary.setOwnershipFilter('mine')}
                          className={`px-3 py-1.5 rounded text-sm transition-colors ${
                            modelLibrary.ownershipFilter === 'mine'
                              ? 'bg-purple-600 text-white'
                              : 'theme-text-muted hover-theme-text-secondary'
                          }`}
                          title="Mostrar apenas meus modelos"
                        >
                          Meus
                        </button>
                        <button
                          onClick={() => modelLibrary.setOwnershipFilter('shared')}
                          className={`px-3 py-1.5 rounded text-sm transition-colors flex items-center gap-1 ${
                            modelLibrary.ownershipFilter === 'shared'
                              ? 'bg-purple-600 text-white'
                              : 'theme-text-muted hover-theme-text-secondary'
                          }`}
                          title="Mostrar apenas modelos compartilhados"
                        >
                          <Users className="w-3 h-3" />
                          Compartilhados
                        </button>
                      </div>

                      <span className={CSS.textMuted}>
                        {filteredModels.length} modelo{filteredModels.length !== 1 ? 's' : ''}
                      </span>
                    </div>
                    
                    <div className="flex items-center gap-2 theme-bg-primary rounded-lg p-1">
                      <button
                        onClick={() => modelLibrary.setModelViewMode('cards')}
                        className={`px-3 py-1.5 rounded transition-colors text-sm ${
                          modelLibrary.modelViewMode === 'cards'
                            ? 'bg-blue-600 text-white'
                            : 'theme-text-muted hover-theme-text-secondary'
                        }`}
                        title="VisualizaÃ§Ã£o em cards"
                      >
                        ğŸ“‡ Cards
                      </button>
                      <button
                        onClick={() => modelLibrary.setModelViewMode('list')}
                        className={`px-3 py-1.5 rounded transition-colors text-sm ${
                          modelLibrary.modelViewMode === 'list'
                            ? 'bg-blue-600 text-white'
                            : 'theme-text-muted hover-theme-text-secondary'
                        }`}
                        title="VisualizaÃ§Ã£o em lista"
                      >
                        ğŸ“‹ Lista
                      </button>
                    </div>
                  </div>

                  {/* v1.27.01: Resultados semÃ¢nticos - v1.33.4: Usando ModelCard para UI consistente */}
                  {useModelSemanticSearch && modelSemanticResults && modelSemanticResults.length > 0 ? (
                    <div className="space-y-3">
                      <div className="flex items-center gap-2 mb-3 text-sm theme-text-muted">
                        <span className="text-purple-400">ğŸ§ </span>
                        <span>{modelSemanticResults.length} resultado(s) semÃ¢ntico(s)</span>
                        {searchingModelSemantics && <RefreshCw className="w-4 h-4 animate-spin" />}
                      </div>
                      {/* v1.33.5: 1 card por linha na busca semÃ¢ntica */}
                      {modelLibrary.modelViewMode === 'cards' ? (
                        <div className="grid grid-cols-1 gap-4">
                          {modelSemanticResults.map((model: Model) => (
                            <ModelCard
                              key={model.id}
                              model={model}
                              viewMode="cards"
                              onEdit={startEditingModel}
                              onToggleFavorite={toggleFavorite}
                              onDuplicate={duplicateModel}
                              onDelete={confirmDeleteModel}
                              sanitizeHTML={sanitizeHTML}
                              isShared={model.isShared}
                              ownerEmail={model.ownerEmail}
                              sharedPermission={model.sharedPermission}
                            />
                          ))}
                        </div>
                      ) : (
                        <div className="space-y-1">
                          {modelSemanticResults.map((model: Model) => (
                            <ModelCard
                              key={model.id}
                              model={model}
                              viewMode="list"
                              onEdit={startEditingModel}
                              onToggleFavorite={toggleFavorite}
                              onDuplicate={duplicateModel}
                              onDelete={confirmDeleteModel}
                              sanitizeHTML={sanitizeHTML}
                              isShared={model.isShared}
                              ownerEmail={model.ownerEmail}
                              sharedPermission={model.sharedPermission}
                            />
                          ))}
                        </div>
                      )}
                    </div>
                  ) : useModelSemanticSearch && modelSemanticResults && modelSemanticResults.length === 0 ? (
                    <div className="text-center py-12 theme-text-muted">
                      <Search className="w-12 h-12 mx-auto mb-3 opacity-30" />
                      <p className="text-sm">Nenhum resultado semÃ¢ntico encontrado</p>
                      <p className="text-xs mt-1">Tente reduzir o threshold nas configuraÃ§Ãµes</p>
                    </div>
                  ) : filteredModels.length === 0 ? (
                    <div className="text-center py-12 theme-text-muted">
                      <Save className="w-16 h-16 mx-auto mb-4 opacity-50" />
                      <p>Nenhum modelo {modelLibrary.showFavoritesOnly ? 'favorito' : 'cadastrado'} ainda</p>
                    </div>
                  ) : modelLibrary.modelViewMode === 'cards' ? (
                    /* VisualizaÃ§Ã£o em CARDS - v1.2.7: Componentizado (mantÃ©m paginaÃ§Ã£o) */
                    /* v1.33.6: 1 card por linha */
                    <>
                      <div className="grid grid-cols-1 gap-4">
                        {currentModels.map((model: Model) => (
                          <ModelCard
                            key={model.id}
                            model={model}
                            viewMode="cards"
                            onEdit={startEditingModel}
                            onToggleFavorite={toggleFavorite}
                            onDuplicate={duplicateModel}
                            onDelete={confirmDeleteModel}
                            sanitizeHTML={sanitizeHTML}
                            isShared={model.isShared}
                            ownerEmail={model.ownerEmail}
                            sharedPermission={model.sharedPermission}
                          />
                        ))}
                      </div>

                      {/* PaginaÃ§Ã£o apenas no modo CARDS */}
                      {filteredModels.length > modelLibrary.modelsPerPage && (() => {
                        // Helper: Gera array de pÃ¡ginas truncado com elipse (null = "...")
                        const getPaginationRange = (current: number, total: number) => {
                          if (total <= 7) {
                            return Array.from({ length: total }, (_, i: number) => i + 1);
                          }
                          const pages = new Set([1, total]);
                          for (let i = Math.max(2, current - 2); i <= Math.min(total - 1, current + 2); i++) {
                            pages.add(i);
                          }
                          const sorted = Array.from(pages).sort((a, b) => a - b);
                          const result = [];
                          for (let i = 0; i < sorted.length; i++) {
                            if (i > 0 && sorted[i] - sorted[i - 1] > 1) {
                              result.push(null);
                            }
                            result.push(sorted[i]);
                          }
                          return result;
                        };

                        const paginationRange = getPaginationRange(modelLibrary.currentModelPage, totalModelPages);

                        return (
                          <div className="mt-6 flex items-center justify-between border-t theme-border-input pt-4">
                            <div className="text-sm theme-text-muted">
                              Mostrando {indexOfFirstModel + 1}-{Math.min(indexOfLastModel, filteredModels.length)} de {filteredModels.length} modelos
                            </div>
                            <div className={CSS.flexGap2}>
                              <button
                                onClick={() => modelLibrary.setCurrentModelPage(prev => Math.max(prev - 1, 1))}
                                disabled={modelLibrary.currentModelPage === 1}
                                className="px-3 py-2 rounded-lg disabled:theme-bg-primary disabled:theme-text-disabled disabled:cursor-not-allowed flex items-center justify-center hover-pagination-btn"
                                title="PÃ¡gina anterior"
                              >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                </svg>
                              </button>
                              <div className="flex items-center gap-1">
                                {paginationRange.map((pageNum, idx) => (
                                  pageNum === null ? (
                                    <span key={`ellipsis-${idx}`} className="px-2 theme-text-muted select-none">...</span>
                                  ) : (
                                    <button
                                      key={pageNum}
                                      onClick={() => modelLibrary.setCurrentModelPage(pageNum)}
                                      data-active={modelLibrary.currentModelPage === pageNum ? "true" : undefined}
                                      className={`px-3 py-2 rounded-lg text-white min-w-[40px] ${
                                        modelLibrary.currentModelPage === pageNum
                                          ? 'bg-gradient-to-r from-blue-600 to-purple-600'
                                          : 'theme-bg-secondary hover-pagination-page'
                                      }`}
                                    >
                                      {pageNum}
                                    </button>
                                  )
                                ))}
                              </div>
                              <button
                                onClick={() => modelLibrary.setCurrentModelPage(prev => Math.min(prev + 1, totalModelPages))}
                                disabled={modelLibrary.currentModelPage === totalModelPages}
                                className="px-3 py-2 rounded-lg disabled:theme-bg-primary disabled:theme-text-disabled disabled:cursor-not-allowed flex items-center justify-center hover-pagination-btn"
                                title="PrÃ³xima pÃ¡gina"
                              >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                </svg>
                              </button>
                            </div>
                          </div>
                        );
                      })()}
                    </>
                  ) : (
                    /* ğŸš€ VisualizaÃ§Ã£o em LISTA - v1.7 FASE 1.4: Virtual Scrolling */
                    <VirtualList<Model>
                      items={filteredModels}
                      itemHeight={90}
                      renderItem={(model) => (
                        <ModelCard
                          key={model.id}
                          model={model}
                          viewMode="list"
                          onEdit={startEditingModel}
                          onToggleFavorite={toggleFavorite}
                          onDuplicate={duplicateModel}
                          onDelete={confirmDeleteModel}
                          sanitizeHTML={sanitizeHTML}
                          isShared={model.isShared}
                          ownerEmail={model.ownerEmail}
                          sharedPermission={model.sharedPermission}
                        />
                      )}
                      className="space-y-1"
                    />
                  )}
                </div>
              </div>
            )}
          </div>
        </div>

        <div className="mt-6 text-center">
          <div className="inline-block theme-bg-primary/90 rounded-lg px-6 py-3 border theme-border-secondary">
            <p className="text-sm theme-text-muted">
              <span className="bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent font-semibold">SENTENCIFY.AI</span>
              {' '}- VersÃ£o {APP_VERSION} - <span className="text-amber-500 font-semibold">PROTÃ“TIPO</span>
            </p>
            <p className="text-xs theme-text-disabled mt-1">
              Desenvolvido por <span className="text-blue-400 font-medium">Rodrigo Nohlack CorrÃªa Cesar</span>, Juiz do Trabalho no TRT8
            </p>
          </div>
        </div>
      </div>

      <ExportModal
        isOpen={modals.export}
        onClose={() => closeModal('export')}
        exportedText={exportedText}
        exportedHtml={exportedHtml}
        copySuccess={copySuccess}
        setCopySuccess={setCopySuccess}
        setError={setError}
      />

      <DispositivoModal
        isOpen={modals.dispositivo}
        onClose={() => closeModal('dispositivo')}
        dispositivoText={aiIntegration.dispositivoText}
        setDispositivoText={aiIntegration.setDispositivoText}
        copySuccess={copySuccess}
        setCopySuccess={setCopySuccess}
        setError={setError}
        extractedTopics={extractedTopics}
        setExtractedTopics={setExtractedTopics}
        selectedTopics={selectedTopics}
        setSelectedTopics={setSelectedTopics}
        sanitizeHTML={sanitizeHTML}
      />

      {/* v1.21.21: Modal de opÃ§Ãµes para revisÃ£o de sentenÃ§a */}
      {modals.sentenceReview && (
        <div className={CSS.modalOverlay}>
          <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-lg`}>
            <div className={CSS.modalHeader}>
              <div className="flex items-center justify-between w-full">
                <div className="flex items-center gap-3">
                  <div className="p-3 rounded-xl bg-amber-500/20">
                    <Scale className="w-6 h-6 text-amber-400" />
                  </div>
                  <h3 className="text-lg font-semibold theme-text-primary">Revisar SentenÃ§a</h3>
                </div>
                <button
                  onClick={() => closeModal('sentenceReview')}
                  className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
                  title="Fechar"
                >
                  <X className="w-5 h-5 theme-text-tertiary" />
                </button>
              </div>
            </div>
            <div className="p-6 space-y-4">
              <p className="text-sm theme-text-tertiary mb-4">
                AnÃ¡lise crÃ­tica da decisÃ£o buscando omissÃµes, contradiÃ§Ãµes e obscuridades que poderiam fundamentar embargos de declaraÃ§Ã£o.
              </p>
              {/* Radio 1: Apenas decisÃ£o */}
              <label className={`flex items-start gap-3 p-4 rounded-lg border cursor-pointer transition-all ${
                reviewScope === 'decisionOnly' ? 'border-amber-500 bg-amber-500/10' : 'theme-border-input theme-bg-secondary-30'
              }`}>
                <input
                  type="radio"
                  name="reviewScope"
                  checked={reviewScope === 'decisionOnly'}
                  onChange={() => setReviewScope('decisionOnly')}
                  className="w-4 h-4 text-amber-600 mt-1"
                />
                <div>
                  <span className="text-sm font-medium theme-text-primary">Apenas a decisÃ£o completa</span>
                  <p className="text-xs theme-text-muted mt-1">RELATÃ“RIO + todos os tÃ³picos (mini-relatÃ³rios + decisÃµes) + DISPOSITIVO</p>
                </div>
              </label>
              {/* Radio 2: DecisÃ£o + documentos */}
              <label className={`flex items-start gap-3 p-4 rounded-lg border cursor-pointer transition-all ${
                reviewScope === 'decisionWithDocs' ? 'border-amber-500 bg-amber-500/10' : 'theme-border-input theme-bg-secondary-30'
              } ${!(analyzedDocuments?.peticoesText?.length > 0 || analyzedDocuments?.contestacoesText?.length > 0) ? 'opacity-50 cursor-not-allowed' : ''}`}>
                <input
                  type="radio"
                  name="reviewScope"
                  disabled={!(analyzedDocuments?.peticoesText?.length > 0 || analyzedDocuments?.contestacoesText?.length > 0)}
                  checked={reviewScope === 'decisionWithDocs'}
                  onChange={() => (analyzedDocuments?.peticoesText?.length > 0 || analyzedDocuments?.contestacoesText?.length > 0) && setReviewScope('decisionWithDocs')}
                  className="w-4 h-4 text-amber-600 mt-1"
                />
                <div>
                  <span className="text-sm font-medium theme-text-primary">DecisÃ£o + peÃ§as processuais</span>
                  <p className="text-xs theme-text-muted mt-1">Inclui petiÃ§Ã£o inicial, contestaÃ§Ãµes e documentos complementares</p>
                  {!(analyzedDocuments?.peticoesText?.length > 0 || analyzedDocuments?.contestacoesText?.length > 0) && (
                    <p className="text-xs text-red-400 mt-1">Nenhum documento extraÃ­do disponÃ­vel</p>
                  )}
                </div>
              </label>
            </div>
            <div className={CSS.modalFooter}>
              <button onClick={() => closeModal('sentenceReview')} disabled={generatingReview} className={CSS.btnSecondary}>
                Cancelar
              </button>
              <button
                onClick={reviewSentence}
                disabled={generatingReview}
                className="flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover-amber-700 disabled:opacity-50"
              >
                {generatingReview ? (
                  <>
                    <div className={CSS.spinner}></div>
                    Analisando...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-4 h-4" />
                    Iniciar RevisÃ£o
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* v1.21.21: Modal de resultado da revisÃ£o de sentenÃ§a */}
      {modals.sentenceReviewResult && reviewResult && (
        <div className={`${CSS.modalOverlay} overflow-auto`}>
          <div className={`${CSS.modalContainer} max-w-5xl w-full max-h-[95vh] flex flex-col my-auto`}>
            <div className={`${CSS.modalHeader} flex-shrink-0`}>
              <div className="flex items-center justify-between w-full">
                <div className="flex items-center gap-3">
                  <Scale className="w-6 h-6 text-amber-400" />
                  <div>
                    <h3 className="text-xl font-bold text-amber-400">RevisÃ£o CrÃ­tica da SentenÃ§a</h3>
                    <div className="flex items-center gap-2">
                      <p className="text-sm theme-text-muted">AnÃ¡lise detalhada por IA - revise os apontamentos abaixo</p>
                      {/* v1.36.57: Badge de cache */}
                      {reviewFromCache && (
                        <span className="text-xs bg-green-500/20 text-green-400 px-2 py-0.5 rounded">
                          ğŸ“¦ Cache
                        </span>
                      )}
                    </div>
                  </div>
                </div>
                <button onClick={() => closeModal('sentenceReviewResult')} className="p-2 rounded-lg hover-slate-700">
                  <X className="w-5 h-5 theme-text-muted" />
                </button>
              </div>
            </div>
            {/* Aviso */}
            <div className="mx-6 mt-4 p-4 bg-amber-500/15 border border-amber-500/30 rounded-lg flex-shrink-0">
              <div className="flex items-start gap-3">
                <AlertTriangle className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" />
                <div className="text-sm">
                  <p className="font-medium text-amber-400 mb-1">REVISÃƒO POR IA - AVALIE CRITICAMENTE</p>
                  <p className="text-xs theme-text-muted">Esta anÃ¡lise foi gerada por inteligÃªncia artificial e pode conter falsos positivos ou nÃ£o identificar todos os problemas. Use como ferramenta de apoio, nÃ£o como decisÃ£o final.</p>
                </div>
              </div>
            </div>
            {/* ConteÃºdo com scroll */}
            <div className="flex-1 overflow-y-auto px-6 py-4">
              <div
                className="prose prose-sm max-w-none theme-text-secondary dark:prose-invert"
                dangerouslySetInnerHTML={{ __html: sanitizeHTML(reviewResult) }}
              />
            </div>
            {/* Footer */}
            <div className={`${CSS.modalFooter} flex-shrink-0`}>
              <button
                onClick={async () => {
                  try {
                    // v1.25.18: Usar helper ao invÃ©s de DOM (memory leak fix)
                    const plainText = extractPlainText(reviewResult);
                    await navigator.clipboard.writeText(plainText);
                    if (copyTimeoutRef.current) clearTimeout(copyTimeoutRef.current);
                    setCopySuccess(true);
                    copyTimeoutRef.current = setTimeout(() => setCopySuccess(false), 3000);
                  } catch (err) {
                    setError('Erro ao copiar: ' + (err as Error).message);
                  }
                }}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg ${copySuccess ? 'bg-green-600 text-white' : 'theme-bg-secondary hover-slate-600'}`}
              >
                {copySuccess ? (
                  <><Check className="w-4 h-4" /> Copiado!</>
                ) : (
                  <><Copy className="w-4 h-4" /> Copiar Texto</>
                )}
              </button>
              {/* v1.36.57: BotÃ£o Regenerar (limpa cache e gera novamente) */}
              <button
                onClick={async () => {
                  await sentenceReviewCache.deleteReview(reviewScope);
                  closeModal('sentenceReviewResult');
                  openModal('sentenceReview');
                }}
                className="flex items-center gap-2 px-4 py-2 theme-bg-secondary hover-slate-600 rounded-lg"
                title="Limpar cache e gerar nova revisÃ£o"
              >
                <RotateCcw className="w-4 h-4" /> Regenerar
              </button>
              <button
                onClick={() => closeModal('sentenceReviewResult')}
                className="px-6 py-2 bg-amber-600 text-white rounded-lg hover-amber-700"
              >
                Fechar
              </button>
            </div>
          </div>
        </div>
      )}

      <RenameTopicModal
        isOpen={modals.rename}
        onClose={() => closeModal('rename')}
        topicToRename={topicToRename}
        setTopicToRename={setTopicToRename}
        newTopicName={newTopicName}
        setNewTopicName={setNewTopicName}
        handleRenameTopic={handleRenameTopic}
        isRegenerating={aiIntegration.regenerating}
        hasDocuments={!!(analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0)}
      />

      <DeleteTopicModal
        isOpen={modals.deleteTopic}
        onClose={() => closeModal('deleteTopic')}
        topicToDelete={topicToDelete}
        setTopicToDelete={setTopicToDelete}
        onConfirmDelete={confirmDeleteTopic}
      />

      <MergeTopicsModal
        isOpen={modals.merge}
        onClose={() => closeModal('merge')}
        topicsToMerge={topicsToMerge}
        onConfirmMerge={handleMergeTopics}
        isRegenerating={aiIntegration.regenerating}
        hasDocuments={!!(analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0)}
      />

      <SplitTopicModal
        isOpen={modals.split}
        onClose={() => closeModal('split')}
        topicToSplit={topicToSplit}
        setTopicToSplit={setTopicToSplit}
        splitNames={splitNames}
        setSplitNames={setSplitNames}
        onConfirmSplit={handleSplitTopic}
        isRegenerating={aiIntegration.regenerating}
        hasDocuments={!!(analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0)}
      />

      <NewTopicModal
        isOpen={modals.newTopic}
        onClose={() => closeModal('newTopic')}
        newTopicData={newTopicData}
        setNewTopicData={setNewTopicData}
        onConfirmCreate={handleCreateNewTopic}
        isRegenerating={aiIntegration.regenerating}
        hasDocuments={!!(analyzedDocuments.peticoes?.length > 0 || analyzedDocuments.peticoesText?.length > 0)}
      />

      <AIAssistantModal
        isOpen={modals.aiAssistant}
        onClose={() => {
          closeModal('aiAssistant');
          chatAssistant.clear();
        }}
        contextScope={topicContextScope}
        setContextScope={setTopicContextScope}
        topicTitle={editingTopic?.title}
        chatHistory={chatAssistant.history}
        onSendMessage={handleSendChatMessage}
        onInsertResponse={handleInsertChatResponse}
        generating={chatAssistant.generating}
        onClear={chatAssistant.clear}
        lastResponse={chatAssistant.lastResponse}
        sanitizeHTML={sanitizeHTML}
        quickPrompts={aiIntegration.aiSettings.quickPrompts}
        proofManager={proofManager}
      />

      {/* v1.20.0: Modal de JurisprudÃªncia (editor individual) */}
      {/* v1.32.18: Props para busca semÃ¢ntica */}
      {/* v1.33.16: jurisSemanticEnabled para toggle interno */}
      <JurisprudenciaModal
        isOpen={modals.jurisIndividual}
        onClose={() => closeModal('jurisIndividual')}
        topicTitle={editingTopic?.title}
        topicRelatorio={editingTopic?.relatorio || editingTopic?.editedRelatorio}
        callAI={aiIntegration?.callAI}
        useLocalAI={aiIntegration.aiSettings.useLocalAIForJuris && searchModelReady && jurisEmbeddingsCount > 0}
        jurisSemanticThreshold={aiIntegration.aiSettings.jurisSemanticThreshold}
        jurisSemanticEnabled={searchModelReady && jurisEmbeddingsCount > 0}
      />

      {/* v1.36.21: Modal Confronto de Fatos (editor individual) */}
      <BaseModal
        isOpen={modals.factsComparisonIndividual}
        onClose={() => {
          closeModal('factsComparisonIndividual');
          setFactsComparisonResultIndividual(null);
          setFactsComparisonErrorIndividual(null);
        }}
        title="Confronto de Fatos"
        subtitle={editingTopic?.title || ''}
        icon={<Scale />}
        iconColor="yellow"
        size="xl"
        preventClose={generatingFactsComparisonIndividual}
      >
        <FactsComparisonModalContent
          topicTitle={editingTopic?.title || ''}
          topicRelatorio={editingTopic?.editedRelatorio || editingTopic?.relatorio || ''}
          hasPeticao={!!(analyzedDocuments?.peticoesText?.length)}
          hasContestacao={!!(analyzedDocuments?.contestacoesText?.length)}
          onGenerate={handleGenerateFactsComparisonIndividual}
          cachedResult={factsComparisonResultIndividual}
          isGenerating={generatingFactsComparisonIndividual}
          error={factsComparisonErrorIndividual}
        />
      </BaseModal>

      <AIAssistantModelModal
        isOpen={modals.aiAssistantModel}
        onClose={() => {
          closeModal('aiAssistantModel');
          aiIntegration.setAiInstructionModel('');
          aiIntegration.setAiGeneratedTextModel('');
        }}
        aiInstructionModel={aiIntegration.aiInstructionModel}
        setAiInstructionModel={aiIntegration.setAiInstructionModel}
        generatingAiModel={aiIntegration.generatingAiModel}
        aiGeneratedTextModel={aiIntegration.aiGeneratedTextModel}
        setAiGeneratedTextModel={aiIntegration.setAiGeneratedTextModel}
        onGenerateText={generateAiTextForModel}
        onInsertText={insertAiTextModel}
        sanitizeHTML={sanitizeHTML}
      />

      <AnalysisModal
        isOpen={modals.analysis}
        analysisProgress={analysisProgress}
        peticaoFiles={peticaoFiles}
        pastedPeticaoTexts={pastedPeticaoTexts}
        contestacaoFiles={contestacaoFiles}
        pastedContestacaoTexts={pastedContestacaoTexts}
        complementaryFiles={complementaryFiles}
        pastedComplementaryTexts={pastedComplementaryTexts}
      />

      {/* v1.35.30: Modal de Curadoria de TÃ³picos */}
      <TopicCurationModal
        isOpen={showTopicCurationModal}
        onConfirm={handleCurationConfirm}
        onCancel={handleCurationCancel}
        initialTopics={pendingCurationData?.topics || []}
        model={
          aiIntegration.aiSettings?.provider === 'gemini'
            ? (aiIntegration.aiSettings?.geminiModel || 'gemini-3-flash-preview')
            : aiIntegration.aiSettings?.provider === 'openai'
              ? (aiIntegration.aiSettings?.openaiModel || 'gpt-5.2-chat-latest')
              : aiIntegration.aiSettings?.provider === 'grok'
                ? (aiIntegration.aiSettings?.grokModel || 'grok-4-1-fast-reasoning')
                : (aiIntegration.aiSettings?.model || 'claude-sonnet-4-20250514')
        }
        parallelRequests={aiIntegration.aiSettings?.parallelRequests || 5}
        isDarkMode={appTheme === 'dark'}
        provider={aiIntegration.aiSettings?.provider || 'claude'}
        thinkingBudget={aiIntegration.aiSettings?.thinkingBudget || '10000'}
        useExtendedThinking={aiIntegration.aiSettings?.useExtendedThinking ?? true}
        geminiThinkingLevel={aiIntegration.aiSettings?.geminiThinkingLevel || 'high'}
        topicsPerRequest={aiIntegration.aiSettings?.topicsPerRequest || 1}
      />

      {/* v1.35.40: Modal de arquivos do Google Drive */}
      <DriveFilesModal
        isOpen={driveFilesModalOpen}
        onClose={() => setDriveFilesModalOpen(false)}
        files={driveFiles}
        isLoading={googleDrive.isLoading}
        onLoad={async (file: DriveFile) => {
          try {
            const projectData = await googleDrive.loadFile(file.id);
            // Simular evento de importaÃ§Ã£o de arquivo
            const callbacks = {
              setPastedPeticaoTexts,
              setPastedContestacaoTexts,
              setPastedComplementaryTexts,
              setExtractedTopics,
              setSelectedTopics,
              setPartesProcesso,
              setAnalyzedDocuments,
              setProofFiles: proofManager.setProofFiles,
              setProofTexts: proofManager.setProofTexts,
              setProofUsePdfMode: proofManager.setProofUsePdfMode,
              setExtractedProofTexts: proofManager.setExtractedProofTexts,
              setProofExtractionFailed: proofManager.setProofExtractionFailed,
              setProofTopicLinks: proofManager.setProofTopicLinks,
              setProofAnalysisResults: proofManager.setProofAnalysisResults,
              setProofConclusions: proofManager.setProofConclusions,
              setProofSendFullContent: proofManager.setProofSendFullContent,
              setActiveTab,
              setAiSettings: aiIntegration.setAiSettings,
              setError,
              setProcessoNumero,
              setPeticaoFiles,
              setContestacaoFiles,
              setComplementaryFiles,
              setExtractedTexts,
              setDocumentProcessingModes,
              setTokenMetrics: aiIntegration.setTokenMetrics
            };
            await storage.importProjectFromJson(projectData as ImportedProject, callbacks, async (allStates) => {
              await storage.autoSaveSession(allStates, (err) => err && setError(err), true);
            });
            setDriveFilesModalOpen(false);
            setError({ type: 'success', message: `Projeto carregado do Google Drive: ${file.name}` });
          } catch (err) {
            setError({ type: 'error', message: `Erro ao carregar projeto: ${(err as Error).message}` });
          }
        }}
        onDelete={async (file: DriveFile) => {
          try {
            await googleDrive.deleteFile(file.id);
            setDriveFiles(prev => prev.filter(f => f.id !== file.id));
            setError({ type: 'success', message: `Arquivo excluÃ­do: ${file.name}` });
          } catch (err) {
            setError({ type: 'error', message: `Erro ao excluir: ${(err as Error).message}` });
          }
        }}
        onShare={async (fileId, email, role) => {
          try {
            await googleDrive.shareFile(fileId, email, role as 'writer' | 'reader');
            const roleText = role === 'writer' ? 'ediÃ§Ã£o' : 'visualizaÃ§Ã£o';
            setError({ type: 'success', message: `Compartilhado com ${email} (${roleText})` });
          } catch (err) {
            setError({ type: 'error', message: `Erro ao compartilhar: ${(err as Error).message}` });
          }
        }}
        onRefresh={async () => {
          try {
            const files = await googleDrive.listFiles();
            setDriveFiles(files);
          } catch (err) {
            setError({ type: 'error', message: `Erro ao atualizar: ${(err as Error).message}` });
          }
        }}
        onGetPermissions={googleDrive.getPermissions}
        onRemovePermission={googleDrive.removePermission}
        userEmail={googleDrive.userEmail}
        isDarkMode={appTheme === 'dark'}
      />

      {/* v1.35.69: Modal de GeraÃ§Ã£o de Modelo a partir de Exemplos */}
      <ModelGeneratorModal
        isOpen={modelGeneratorModal.isOpen}
        onClose={closeModelGenerator}
        targetField={modelGeneratorModal.targetField}
        onSave={handleModelGenerated}
        callAI={aiIntegration.callAI}
        hardcodedPrompt={modelGeneratorModal.targetField ? getHardcodedPrompt(modelGeneratorModal.targetField) : ''}
      />

      {modals.settings && (
        <div className={`${CSS.modalOverlay} overflow-auto`}>
          <div className={`${CSS.modalContainer} theme-border-modal theme-modal-glow animate-modal max-w-2xl w-full my-auto`}>
            <div className={CSS.modalHeader}>
              <div className="flex items-center justify-between w-full">
                <div className="flex items-center gap-3">
                  <div className="p-3 rounded-xl bg-blue-500/20">
                    <Zap className="w-6 h-6 text-blue-400" />
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold theme-text-primary">ConfiguraÃ§Ãµes de IA</h3>
                    <p className="text-sm theme-text-muted">Escolha o modelo e as configuraÃ§Ãµes para anÃ¡lise de documentos</p>
                  </div>
                </div>
                <button
                  onClick={() => closeModal('settings')}
                  className="p-2 rounded-xl theme-bg-secondary-50 theme-hover-bg transition-colors"
                  title="Fechar"
                >
                  <X className="w-5 h-5 theme-text-tertiary" />
                </button>
              </div>
            </div>
            
            <div className="p-6 space-y-6 max-h-[60vh] overflow-y-auto">
              {/* v1.30: Provider Selection (v1.35.97: +OpenAI +Grok) */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">Provedor de IA</label>
                <div className="grid grid-cols-4 gap-2">
                  <button
                    onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, provider: 'claude' })}
                    className={`p-3 rounded-lg border-2 transition-all text-left ${
                      aiIntegration.aiSettings.provider === 'claude'
                        ? 'bg-purple-600/20 border-purple-500'
                        : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      <span className="text-lg">ğŸŸ£</span>
                      <div>
                        <div className="font-semibold theme-text-primary text-sm">Claude</div>
                        <div className="text-xs theme-text-muted">Anthropic</div>
                      </div>
                    </div>
                  </button>
                  <button
                    onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, provider: 'gemini' })}
                    className={`p-3 rounded-lg border-2 transition-all text-left ${
                      aiIntegration.aiSettings.provider === 'gemini'
                        ? 'bg-blue-600/20 border-blue-500'
                        : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      <span className="text-lg">ğŸ”µ</span>
                      <div>
                        <div className="font-semibold theme-text-primary text-sm">Gemini</div>
                        <div className="text-xs theme-text-muted">Google</div>
                      </div>
                    </div>
                  </button>
                  <button
                    onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, provider: 'openai' })}
                    className={`p-3 rounded-lg border-2 transition-all text-left ${
                      aiIntegration.aiSettings.provider === 'openai'
                        ? 'bg-emerald-600/20 border-emerald-500'
                        : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      <span className="text-lg">ğŸŸ¢</span>
                      <div>
                        <div className="font-semibold theme-text-primary text-sm">OpenAI</div>
                        <div className="text-xs theme-text-muted">GPT-5.2</div>
                      </div>
                    </div>
                  </button>
                  <button
                    onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, provider: 'grok' })}
                    className={`p-3 rounded-lg border-2 transition-all text-left ${
                      aiIntegration.aiSettings.provider === 'grok'
                        ? 'bg-gray-600/20 border-gray-400'
                        : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      <span className="text-lg">ğ•</span>
                      <div>
                        <div className="font-semibold theme-text-primary text-sm">Grok</div>
                        <div className="text-xs theme-text-muted">xAI</div>
                      </div>
                    </div>
                  </button>
                </div>

                {/* Model Selection based on provider */}
                <div className="mt-3">
                  <label className="block text-xs theme-text-muted mb-1">
                    Modelo {aiIntegration.aiSettings.provider === 'claude' ? 'Claude' :
                           aiIntegration.aiSettings.provider === 'gemini' ? 'Gemini' :
                           aiIntegration.aiSettings.provider === 'openai' ? 'OpenAI' : 'Grok'}:
                  </label>
                  {aiIntegration.aiSettings.provider === 'claude' && (
                    <select
                      value={aiIntegration.aiSettings.claudeModel || 'claude-sonnet-4-20250514'}
                      onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, claudeModel: e.target.value, model: e.target.value })}
                      className="w-full px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                    >
                      <option value="claude-sonnet-4-20250514">Sonnet 4.5 ($3/$15 por 1M)</option>
                      <option value="claude-opus-4-5-20251101">Opus 4.5 ($15/$75 por 1M)</option>
                    </select>
                  )}
                  {aiIntegration.aiSettings.provider === 'gemini' && (
                    <select
                      value={aiIntegration.aiSettings.geminiModel || 'gemini-3-flash-preview'}
                      onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, geminiModel: e.target.value })}
                      className="w-full px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                    >
                      {/* v1.32.36: Removido Gemini 2.5, apenas Gemini 3 */}
                      <option value="gemini-3-flash-preview">Gemini 3 Flash ($0.50/$3.00 por 1M)</option>
                      <option value="gemini-3-pro-preview">Gemini 3 Pro ($2.00/$12 por 1M)</option>
                    </select>
                  )}
                  {/* v1.35.97: OpenAI Model Selection */}
                  {aiIntegration.aiSettings.provider === 'openai' && (
                    <select
                      value={aiIntegration.aiSettings.openaiModel || 'gpt-5.2-chat-latest'}
                      onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, openaiModel: e.target.value as 'gpt-5.2' | 'gpt-5.2-chat-latest' })}
                      className="w-full px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                    >
                      <option value="gpt-5.2-chat-latest">GPT-5.2 Instant ($1.75/$14 por 1M)</option>
                      <option value="gpt-5.2">GPT-5.2 Thinking - com Reasoning ($1.75/$14 por 1M)</option>
                    </select>
                  )}
                  {/* v1.35.97: Grok Model Selection */}
                  {aiIntegration.aiSettings.provider === 'grok' && (
                    <select
                      value={aiIntegration.aiSettings.grokModel || 'grok-4-1-fast-reasoning'}
                      onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, grokModel: e.target.value as 'grok-4-1-fast-reasoning' | 'grok-4-1-fast-non-reasoning' })}
                      className="w-full px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                    >
                      <option value="grok-4-1-fast-reasoning">Grok 4.1 Fast ($0.20/$0.50 por 1M) - 2M contexto</option>
                      <option value="grok-4-1-fast-non-reasoning">Grok 4.1 Instant ($0.20/$0.50 por 1M) - sem thinking</option>
                    </select>
                  )}
                </div>
              </div>

              {/* v1.30: API Keys */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Chaves API <span className="text-xs font-normal theme-text-muted">(armazenadas localmente)</span>
                </label>
                <div className="space-y-3">
                  {/* Claude API Key */}
                  <div>
                    <label className="block text-xs theme-text-muted mb-1">Anthropic (Claude):</label>
                    <div className="flex gap-2">
                      <input
                        type="password"
                        value={aiIntegration.aiSettings.apiKeys?.claude || ''}
                        onChange={(e) => aiIntegration.setAiSettings({
                          ...aiIntegration.aiSettings,
                          apiKeys: { ...aiIntegration.aiSettings.apiKeys, claude: e.target.value }
                        })}
                        placeholder="sk-ant-..."
                        className="flex-1 px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                      />
                      <button
                        onClick={async () => {
                          setClaudeTestStatus('testing');
                          try {
                            const resp = await fetch(`${API_BASE}/api/claude/messages`, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json', 'x-api-key': aiIntegration.aiSettings.apiKeys?.claude || '' },
                              body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 10, messages: [{ role: 'user', content: 'OlÃ¡' }] })
                            });
                            setClaudeTestStatus(resp.ok ? 'ok' : 'error');
                          } catch { setClaudeTestStatus('error'); }
                          setTimeout(() => setClaudeTestStatus(null), 2000);
                        }}
                        disabled={claudeTestStatus === 'testing'}
                        className={`px-3 py-2 text-white rounded text-sm min-w-[60px] transition-colors ${
                          claudeTestStatus === 'ok' ? 'bg-green-600' :
                          claudeTestStatus === 'error' ? 'bg-red-600' :
                          'bg-purple-600 hover:bg-purple-700'
                        }`}
                      >
                        {claudeTestStatus === 'testing' ? '...' :
                         claudeTestStatus === 'ok' ? 'âœ“' :
                         claudeTestStatus === 'error' ? 'âœ—' : 'Testar'}
                      </button>
                    </div>
                  </div>
                  {/* Gemini API Key */}
                  <div>
                    <label className="block text-xs theme-text-muted mb-1">Google (Gemini):</label>
                    <div className="flex gap-2">
                      <input
                        type="password"
                        value={aiIntegration.aiSettings.apiKeys?.gemini || ''}
                        onChange={(e) => aiIntegration.setAiSettings({
                          ...aiIntegration.aiSettings,
                          apiKeys: { ...aiIntegration.aiSettings.apiKeys, gemini: e.target.value }
                        })}
                        placeholder="AIza..."
                        className="flex-1 px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                      />
                      <button
                        onClick={async () => {
                          setGeminiTestStatus('testing');
                          try {
                            const resp = await fetch(`${API_BASE}/api/gemini/generate`, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                model: 'gemini-3-flash-preview',
                                apiKey: aiIntegration.aiSettings.apiKeys?.gemini || '',
                                request: { contents: [{ role: 'user', parts: [{ text: 'OlÃ¡' }] }], generationConfig: { maxOutputTokens: 100, thinking_config: { thinking_level: 'minimal' } } }
                              })
                            });
                            setGeminiTestStatus(resp.ok ? 'ok' : 'error');
                          } catch { setGeminiTestStatus('error'); }
                          setTimeout(() => setGeminiTestStatus(null), 2000);
                        }}
                        disabled={geminiTestStatus === 'testing'}
                        className={`px-3 py-2 text-white rounded text-sm min-w-[60px] transition-colors ${
                          geminiTestStatus === 'ok' ? 'bg-green-600' :
                          geminiTestStatus === 'error' ? 'bg-red-600' :
                          'bg-blue-600 hover:bg-blue-700'
                        }`}
                      >
                        {geminiTestStatus === 'testing' ? '...' :
                         geminiTestStatus === 'ok' ? 'âœ“' :
                         geminiTestStatus === 'error' ? 'âœ—' : 'Testar'}
                      </button>
                    </div>
                  </div>
                  {/* v1.35.97: OpenAI API Key */}
                  <div>
                    <label className="block text-xs theme-text-muted mb-1">OpenAI (GPT):</label>
                    <div className="flex gap-2">
                      <input
                        type="password"
                        value={aiIntegration.aiSettings.apiKeys?.openai || ''}
                        onChange={(e) => aiIntegration.setAiSettings({
                          ...aiIntegration.aiSettings,
                          apiKeys: { ...aiIntegration.aiSettings.apiKeys, openai: e.target.value }
                        })}
                        placeholder="sk-..."
                        className="flex-1 px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                      />
                      <button
                        onClick={async () => {
                          setOpenaiTestStatus('testing');
                          try {
                            const resp = await fetch(`${API_BASE}/api/openai/chat`, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json', 'x-api-key': aiIntegration.aiSettings.apiKeys?.openai || '' },
                              body: JSON.stringify({
                                model: 'gpt-5.2-chat-latest',
                                max_tokens: 10,
                                messages: [{ role: 'user', content: 'OlÃ¡' }]
                              })
                            });
                            setOpenaiTestStatus(resp.ok ? 'ok' : 'error');
                          } catch { setOpenaiTestStatus('error'); }
                          setTimeout(() => setOpenaiTestStatus(null), 2000);
                        }}
                        disabled={openaiTestStatus === 'testing'}
                        className={`px-3 py-2 text-white rounded text-sm min-w-[60px] transition-colors ${
                          openaiTestStatus === 'ok' ? 'bg-green-600' :
                          openaiTestStatus === 'error' ? 'bg-red-600' :
                          'bg-emerald-600 hover:bg-emerald-700'
                        }`}
                      >
                        {openaiTestStatus === 'testing' ? '...' :
                         openaiTestStatus === 'ok' ? 'âœ“' :
                         openaiTestStatus === 'error' ? 'âœ—' : 'Testar'}
                      </button>
                    </div>
                  </div>
                  {/* v1.35.97: xAI Grok API Key */}
                  <div>
                    <label className="block text-xs theme-text-muted mb-1">xAI (Grok):</label>
                    <div className="flex gap-2">
                      <input
                        type="password"
                        value={aiIntegration.aiSettings.apiKeys?.grok || ''}
                        onChange={(e) => aiIntegration.setAiSettings({
                          ...aiIntegration.aiSettings,
                          apiKeys: { ...aiIntegration.aiSettings.apiKeys, grok: e.target.value }
                        })}
                        placeholder="xai-..."
                        className="flex-1 px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                      />
                      <button
                        onClick={async () => {
                          setGrokTestStatus('testing');
                          try {
                            const resp = await fetch(`${API_BASE}/api/grok/chat`, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json', 'x-api-key': aiIntegration.aiSettings.apiKeys?.grok || '' },
                              body: JSON.stringify({
                                model: 'grok-4-1-fast-non-reasoning',
                                max_tokens: 10,
                                messages: [{ role: 'user', content: 'OlÃ¡' }]
                              })
                            });
                            setGrokTestStatus(resp.ok ? 'ok' : 'error');
                          } catch { setGrokTestStatus('error'); }
                          setTimeout(() => setGrokTestStatus(null), 2000);
                        }}
                        disabled={grokTestStatus === 'testing'}
                        className={`px-3 py-2 text-white rounded text-sm min-w-[60px] transition-colors ${
                          grokTestStatus === 'ok' ? 'bg-green-600' :
                          grokTestStatus === 'error' ? 'bg-red-600' :
                          'bg-gray-600 hover:bg-gray-700'
                        }`}
                      >
                        {grokTestStatus === 'testing' ? '...' :
                         grokTestStatus === 'ok' ? 'âœ“' :
                         grokTestStatus === 'error' ? 'âœ—' : 'Testar'}
                      </button>
                    </div>
                  </div>
                </div>
                <p className="text-xs theme-text-muted mt-2">
                  As chaves sÃ£o armazenadas apenas no seu navegador (localStorage). Nunca sÃ£o enviadas para servidores externos.
                </p>
              </div>

              {/* Pensamento Prolongado - ADAPTADO POR PROVIDER */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Pensamento Prolongado (Extended Thinking)
                </label>

                {/* v1.32.36: CLAUDE: Toggle + Budget numÃ©rico */}
                {aiIntegration.aiSettings.provider === 'claude' && (
                  <>
                    <button
                      onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, useExtendedThinking: !aiIntegration.aiSettings.useExtendedThinking })}
                      className={`w-full p-4 rounded-lg border-2 transition-all text-left ${
                        aiIntegration.aiSettings.useExtendedThinking
                          ? 'bg-purple-600/20 border-purple-500'
                          : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className={CSS.flexGap2}>
                            <span className="font-semibold theme-text-primary">
                              {aiIntegration.aiSettings.useExtendedThinking ? 'âœ“ Ativado' : 'Desativado'}
                            </span>
                            {aiIntegration.aiSettings.useExtendedThinking && (
                              <span className="text-xs bg-purple-500 text-white px-2 py-0.5 rounded">+{parseInt(aiIntegration.aiSettings.thinkingBudget || '10000')/1000}k tokens</span>
                            )}
                          </div>
                          <p className="text-xs theme-text-muted mt-1">
                            {aiIntegration.aiSettings.useExtendedThinking
                              ? `A IA usarÃ¡ atÃ© ${(parseInt(aiIntegration.aiSettings.thinkingBudget || '10000')/1000).toFixed(0)}K tokens extras para pensar antes de responder.`
                              : 'A IA responderÃ¡ mais rapidamente, com anÃ¡lise padrÃ£o.'
                            }
                          </p>
                        </div>
                        <div className={`w-12 h-6 rounded-full transition-colors relative ${
                          aiIntegration.aiSettings.useExtendedThinking ? 'bg-purple-500' : 'theme-bg-tertiary'
                        }`}>
                          <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${
                            aiIntegration.aiSettings.useExtendedThinking ? 'translate-x-7' : 'translate-x-1'
                          }`}></div>
                        </div>
                      </div>
                    </button>

                    {aiIntegration.aiSettings.useExtendedThinking && (
                      <div className="mt-3 pl-4">
                        <label className="block text-xs theme-text-muted mb-1">Budget de Pensamento:</label>
                        <select
                          value={aiIntegration.aiSettings.thinkingBudget || '10000'}
                          onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, thinkingBudget: e.target.value })}
                          className="w-full px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                        >
                          {/* v1.32.32: OpÃ§Ãµes dinÃ¢micas por modelo Claude */}
                          {(aiIntegration.aiSettings.claudeModel || aiIntegration.aiSettings.model)?.includes('opus') ? (
                            <>
                              <option value="10000">10K tokens (PadrÃ£o)</option>
                              <option value="20000">20K tokens (Recomendado)</option>
                              <option value="30000">30K tokens (MÃ¡ximo Opus)</option>
                            </>
                          ) : (
                            <>
                              <option value="10000">10K tokens (PadrÃ£o)</option>
                              <option value="20000">20K tokens (Recomendado)</option>
                              <option value="40000">40K tokens (Alta qualidade)</option>
                              <option value="62000">62K tokens (MÃ¡ximo Sonnet)</option>
                            </>
                          )}
                        </select>
                        {/* v1.32.33: Warning para budgets altos (timeout aumentado para 5 min) */}
                        {parseInt(aiIntegration.aiSettings.thinkingBudget || '10000') >= 40000 && (
                          <p className="text-xs text-amber-400 mt-1">
                            âš ï¸ Respostas podem demorar mais com budgets altos
                          </p>
                        )}
                      </div>
                    )}
                  </>
                )}

                {/* v1.32.36: GEMINI 3: Dropdown de thinking_level (sempre ativo, nÃ£o pode desativar) */}
                {aiIntegration.aiSettings.provider === 'gemini' && (
                  <div className="p-4 rounded-lg border-2 border-amber-500/50 bg-amber-500/10">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-amber-400">âš ï¸</span>
                      <span className="font-semibold theme-text-primary">Gemini 3 sempre usa Thinking</span>
                    </div>
                    <p className="text-xs theme-text-muted mb-3">
                      O Gemini 3 nÃ£o permite desativar o pensamento prolongado. Escolha o nÃ­vel de profundidade:
                    </p>
                    <select
                      value={aiIntegration.aiSettings.geminiThinkingLevel || 'high'}
                      onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, geminiThinkingLevel: e.target.value as GeminiThinkingLevel })}
                      className="w-full px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                    >
                      {aiIntegration.aiSettings.geminiModel?.includes('flash') && (
                        <option value="minimal">Minimal (mais rÃ¡pido, menos preciso)</option>
                      )}
                      <option value="low">Low (equilÃ­brio velocidade/qualidade)</option>
                      {aiIntegration.aiSettings.geminiModel?.includes('flash') && (
                        <option value="medium">Medium (recomendado)</option>
                      )}
                      <option value="high">High (mais lento, mais preciso)</option>
                    </select>
                    <p className="text-xs theme-text-muted mt-2">
                      {aiIntegration.aiSettings.geminiModel?.includes('pro')
                        ? 'ğŸ’¡ Gemini 3 Pro suporta apenas Low e High'
                        : 'ğŸ’¡ Gemini 3 Flash suporta todos os nÃ­veis'
                      }
                    </p>
                  </div>
                )}

                {/* v1.35.97: OPENAI: Reasoning Config (sÃ³ para gpt-5.2) */}
                {aiIntegration.aiSettings.provider === 'openai' && aiIntegration.aiSettings.openaiModel === 'gpt-5.2' && (
                  <div className="p-4 rounded-lg border-2 border-emerald-500/50 bg-emerald-500/10">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-emerald-400">ğŸ§ </span>
                      <span className="font-semibold theme-text-primary">GPT-5.2 Reasoning</span>
                    </div>
                    <p className="text-xs theme-text-muted mb-3">
                      O modelo pensa passo-a-passo antes de responder. NÃ­veis mais altos produzem respostas mais elaboradas, mas custam mais tokens.
                    </p>
                    <select
                      value={aiIntegration.aiSettings.openaiReasoningLevel || 'medium'}
                      onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, openaiReasoningLevel: e.target.value as 'low' | 'medium' | 'high' | 'xhigh' })}
                      className="w-full px-3 py-2 theme-bg-secondary border theme-border-input rounded text-sm theme-text-secondary"
                    >
                      <option value="low">Low - RÃ¡pido, menos detalhado</option>
                      <option value="medium">Medium - Balanceado (Recomendado)</option>
                      <option value="high">High - Mais detalhado</option>
                      <option value="xhigh">Extra High - MÃ¡xima qualidade (lento)</option>
                    </select>
                    {aiIntegration.aiSettings.openaiReasoningLevel === 'xhigh' && (
                      <p className="text-xs text-amber-400 mt-2">
                        âš ï¸ NÃ­vel xhigh pode demorar vÃ¡rios minutos. Timeout aumentado para 5 min.
                      </p>
                    )}
                  </div>
                )}

                {/* v1.35.97: OPENAI: Info para modo Instant */}
                {aiIntegration.aiSettings.provider === 'openai' && aiIntegration.aiSettings.openaiModel === 'gpt-5.2-chat-latest' && (
                  <div className="p-4 rounded-lg border-2 border-emerald-500/30 bg-emerald-500/5">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-emerald-400">âš¡</span>
                      <span className="font-semibold theme-text-primary">GPT-5.2 Instant</span>
                    </div>
                    <p className="text-xs theme-text-muted">
                      Modelo rÃ¡pido sem reasoning. Ideal para tarefas simples e respostas imediatas.
                      NÃ£o suporta thinking/reasoning.
                    </p>
                  </div>
                )}

                {/* v1.36.11: GROK Thinking: Info sobre modelos com indicador visual claro */}
                {aiIntegration.aiSettings.provider === 'grok' && aiIntegration.aiSettings.grokModel === 'grok-4-1-fast-reasoning' && (
                  <div className="p-4 rounded-lg border-2 border-purple-500/50 bg-purple-500/10">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-purple-400">ğŸ§ </span>
                      <span className="font-semibold theme-text-primary">Grok 4.1 Fast Thinking</span>
                      <span className="text-xs bg-purple-500 text-white px-2 py-0.5 rounded">Thinking Embutido</span>
                    </div>
                    <p className="text-xs theme-text-muted">
                      Modelo da xAI com 2M de contexto e raciocÃ­nio integrado. O thinking Ã© automÃ¡tico e nÃ£o configurÃ¡vel.
                    </p>
                    <p className="text-xs text-emerald-400 mt-2">
                      ğŸ’° $0.20/1M input + $0.50/1M output = ~$0.35/1M total (96% mais barato que Claude)
                    </p>
                  </div>
                )}

                {/* v1.36.11: GROK Instant: Sem suporte a thinking */}
                {aiIntegration.aiSettings.provider === 'grok' && aiIntegration.aiSettings.grokModel === 'grok-4-1-fast-non-reasoning' && (
                  <div className="p-4 rounded-lg border-2 border-amber-500/50 bg-amber-500/10">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-amber-400">âš¡</span>
                      <span className="font-semibold theme-text-primary">Grok 4.1 Fast Instant</span>
                      <span className="text-xs bg-amber-500 text-white px-2 py-0.5 rounded">Sem Thinking</span>
                    </div>
                    <p className="text-xs theme-text-muted">
                      Modelo da xAI com 2M de contexto, modo instant para respostas rÃ¡pidas. Este modelo nÃ£o suporta pensamento prolongado.
                    </p>
                    <p className="text-xs text-emerald-400 mt-2">
                      ğŸ’° $0.20/1M input + $0.50/1M output = ~$0.35/1M total (96% mais barato que Claude)
                    </p>
                  </div>
                )}

                {/* v1.36.49: Log Thinking - desabilitado para modelos sem reasoning (Grok, GPT-5.2 Instant) */}
                {(() => {
                  const isDisabled = aiIntegration.aiSettings.provider === 'grok' ||
                    (aiIntegration.aiSettings.provider === 'openai' && aiIntegration.aiSettings.openaiModel === 'gpt-5.2-chat-latest');
                  return (
                    <label className={`flex items-center gap-3 p-3 mt-4 rounded-lg theme-bg-secondary-30 border theme-border-input transition-colors ${
                      isDisabled ? 'cursor-not-allowed opacity-50' : 'cursor-pointer hover:theme-bg-secondary'
                    }`}>
                      <input
                        type="checkbox"
                        checked={aiIntegration.aiSettings.logThinking || false}
                        onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, logThinking: e.target.checked })}
                        disabled={isDisabled}
                        className="w-4 h-4 rounded border-gray-300 text-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                      />
                      <div className="flex-1">
                        <span className="font-medium theme-text-primary text-sm">Log thinking no console</span>
                        <p className="text-xs theme-text-muted mt-0.5">
                          Exibe o raciocÃ­nio da IA no console (F12).
                          {isDisabled && <span className="text-amber-400"> Este modelo nÃ£o expÃµe reasoning.</span>}
                        </p>
                      </div>
                    </label>
                  );
                })()}
              </div>

              {/* v1.36.50: Double Check de Respostas */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  ğŸ”„ Double Check de Respostas
                </label>

                {/* Toggle principal */}
                <button
                  onClick={() => {
                    const current = aiIntegration.aiSettings.doubleCheck || {
                      enabled: false,
                      provider: 'claude' as AIProvider,
                      model: 'claude-sonnet-4-20250514',
                      operations: { topicExtraction: false, dispositivo: false, sentenceReview: false, factsComparison: false }
                    };
                    aiIntegration.setAiSettings({
                      ...aiIntegration.aiSettings,
                      doubleCheck: { ...current, enabled: !current.enabled }
                    });
                  }}
                  className={`w-full p-4 rounded-lg border-2 transition-all text-left ${
                    aiIntegration.aiSettings.doubleCheck?.enabled
                      ? 'bg-purple-600/20 border-purple-500'
                      : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                  }`}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className={CSS.flexGap2}>
                        <span className="font-semibold theme-text-primary">
                          {aiIntegration.aiSettings.doubleCheck?.enabled ? 'âœ“ Ativado' : 'Desativado'}
                        </span>
                        {aiIntegration.aiSettings.doubleCheck?.enabled && (
                          <span className="text-xs bg-purple-500 text-white px-2 py-0.5 rounded">VerificaÃ§Ã£o Dupla</span>
                        )}
                      </div>
                      <p className="text-xs theme-text-muted mt-1">
                        Reanalisa respostas da IA para detectar falhas, omissÃµes e falsos positivos.
                      </p>
                    </div>
                    <div className={`w-12 h-6 rounded-full transition-colors relative ${
                      aiIntegration.aiSettings.doubleCheck?.enabled ? 'bg-purple-500' : 'theme-bg-tertiary'
                    }`}>
                      <div className={`absolute w-5 h-5 rounded-full bg-white shadow top-0.5 transition-all ${
                        aiIntegration.aiSettings.doubleCheck?.enabled ? 'right-0.5' : 'left-0.5'
                      }`} />
                    </div>
                  </div>
                </button>

                {/* OpÃ§Ãµes expandidas quando ativado */}
                {aiIntegration.aiSettings.doubleCheck?.enabled && (
                  <div className="mt-4 space-y-4 p-4 rounded-lg theme-bg-secondary-30 border theme-border-input">
                    {/* Seletor de Provider */}
                    <div>
                      <label className="block text-xs font-medium theme-text-tertiary mb-2">
                        Provider para verificaÃ§Ã£o
                      </label>
                      <select
                        value={aiIntegration.aiSettings.doubleCheck?.provider || 'claude'}
                        onChange={(e) => {
                          const provider = e.target.value as AIProvider;
                          const defaultModels: Record<AIProvider, string> = {
                            claude: 'claude-sonnet-4-20250514',
                            gemini: 'gemini-3-flash-preview',
                            openai: 'gpt-5.2-chat-latest',
                            grok: 'grok-4-1-fast-reasoning'
                          };
                          aiIntegration.setAiSettings({
                            ...aiIntegration.aiSettings,
                            doubleCheck: {
                              ...aiIntegration.aiSettings.doubleCheck!,
                              provider,
                              model: defaultModels[provider]
                            }
                          });
                        }}
                        className="w-full p-2 rounded-lg theme-bg-secondary border theme-border-input theme-text-primary text-sm"
                      >
                        <option value="claude">Claude (Anthropic)</option>
                        <option value="gemini">Gemini (Google)</option>
                        <option value="openai">GPT (OpenAI)</option>
                        <option value="grok">Grok (xAI)</option>
                      </select>
                    </div>

                    {/* Seletor de Modelo (dinÃ¢mico baseado no provider) */}
                    <div>
                      <label className="block text-xs font-medium theme-text-tertiary mb-2">
                        Modelo para verificaÃ§Ã£o
                      </label>
                      <select
                        value={aiIntegration.aiSettings.doubleCheck?.model || 'claude-sonnet-4-20250514'}
                        onChange={(e) => {
                          aiIntegration.setAiSettings({
                            ...aiIntegration.aiSettings,
                            doubleCheck: {
                              ...aiIntegration.aiSettings.doubleCheck!,
                              model: e.target.value
                            }
                          });
                        }}
                        className="w-full p-2 rounded-lg theme-bg-secondary border theme-border-input theme-text-primary text-sm"
                      >
                        {aiIntegration.aiSettings.doubleCheck?.provider === 'claude' && (
                          <>
                            <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                            <option value="claude-opus-4-5-20251101">Claude Opus 4.5</option>
                          </>
                        )}
                        {aiIntegration.aiSettings.doubleCheck?.provider === 'gemini' && (
                          <>
                            <option value="gemini-3-flash-preview">Gemini 3 Flash</option>
                            <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
                          </>
                        )}
                        {aiIntegration.aiSettings.doubleCheck?.provider === 'openai' && (
                          <>
                            <option value="gpt-5.2-chat-latest">GPT-5.2 Instant</option>
                            <option value="gpt-5.2">GPT-5.2 Thinking</option>
                          </>
                        )}
                        {aiIntegration.aiSettings.doubleCheck?.provider === 'grok' && (
                          <>
                            <option value="grok-4-1-fast-reasoning">Grok 4.1 Fast Thinking</option>
                            <option value="grok-4-1-fast-non-reasoning">Grok 4.1 Fast Instant</option>
                          </>
                        )}
                      </select>
                    </div>

                    {/* v1.36.56: Thinking Config especÃ­fico para Double Check */}
                    {aiIntegration.aiSettings.doubleCheck?.provider === 'claude' && (
                      <div>
                        <label className="block text-xs font-medium theme-text-tertiary mb-2">
                          Extended Thinking Budget
                        </label>
                        <select
                          value={aiIntegration.aiSettings.doubleCheck?.claudeThinkingBudget || 0}
                          onChange={(e) => {
                            aiIntegration.setAiSettings({
                              ...aiIntegration.aiSettings,
                              doubleCheck: {
                                ...aiIntegration.aiSettings.doubleCheck!,
                                claudeThinkingBudget: parseInt(e.target.value)
                              }
                            });
                          }}
                          className="w-full p-2 rounded-lg theme-bg-secondary border theme-border-input theme-text-primary text-sm"
                        >
                          <option value="0">Desativado</option>
                          {aiIntegration.aiSettings.doubleCheck?.model?.includes('opus') ? (
                            <>
                              <option value="10000">10K tokens (PadrÃ£o)</option>
                              <option value="20000">20K tokens (Recomendado)</option>
                              <option value="30000">30K tokens (MÃ¡ximo Opus)</option>
                            </>
                          ) : (
                            <>
                              <option value="10000">10K tokens (PadrÃ£o)</option>
                              <option value="20000">20K tokens (Recomendado)</option>
                              <option value="40000">40K tokens (Alta qualidade)</option>
                              <option value="62000">62K tokens (MÃ¡ximo Sonnet)</option>
                            </>
                          )}
                        </select>
                        {(aiIntegration.aiSettings.doubleCheck?.claudeThinkingBudget || 0) >= 40000 && (
                          <p className="text-xs text-amber-400 mt-1">
                            âš ï¸ VerificaÃ§Ã£o pode demorar mais com budgets altos
                          </p>
                        )}
                      </div>
                    )}

                    {aiIntegration.aiSettings.doubleCheck?.provider === 'gemini' && (
                      <div>
                        <label className="block text-xs font-medium theme-text-tertiary mb-2">
                          Thinking Level
                        </label>
                        <p className="text-xs theme-text-muted mb-2">
                          Gemini 3 nÃ£o permite desativar thinking
                        </p>
                        <select
                          value={aiIntegration.aiSettings.doubleCheck?.geminiThinkingLevel || 'low'}
                          onChange={(e) => {
                            aiIntegration.setAiSettings({
                              ...aiIntegration.aiSettings,
                              doubleCheck: {
                                ...aiIntegration.aiSettings.doubleCheck!,
                                geminiThinkingLevel: e.target.value as GeminiThinkingLevel
                              }
                            });
                          }}
                          className="w-full p-2 rounded-lg theme-bg-secondary border theme-border-input theme-text-primary text-sm"
                        >
                          {aiIntegration.aiSettings.doubleCheck?.model?.includes('flash') && (
                            <option value="minimal">Minimal (mais rÃ¡pido)</option>
                          )}
                          <option value="low">Low (equilÃ­brio)</option>
                          {aiIntegration.aiSettings.doubleCheck?.model?.includes('flash') && (
                            <option value="medium">Medium (recomendado)</option>
                          )}
                          <option value="high">High (mais preciso)</option>
                        </select>
                        <p className="text-xs theme-text-muted mt-1">
                          {aiIntegration.aiSettings.doubleCheck?.model?.includes('pro')
                            ? 'ğŸ’¡ Gemini 3 Pro suporta apenas Low e High'
                            : 'ğŸ’¡ Gemini 3 Flash suporta todos os nÃ­veis'}
                        </p>
                      </div>
                    )}

                    {aiIntegration.aiSettings.doubleCheck?.provider === 'openai' &&
                     aiIntegration.aiSettings.doubleCheck?.model === 'gpt-5.2' && (
                      <div>
                        <label className="block text-xs font-medium theme-text-tertiary mb-2">
                          Reasoning Level
                        </label>
                        <select
                          value={aiIntegration.aiSettings.doubleCheck?.openaiReasoningLevel || 'medium'}
                          onChange={(e) => {
                            aiIntegration.setAiSettings({
                              ...aiIntegration.aiSettings,
                              doubleCheck: {
                                ...aiIntegration.aiSettings.doubleCheck!,
                                openaiReasoningLevel: e.target.value as 'low' | 'medium' | 'high' | 'xhigh'
                              }
                            });
                          }}
                          className="w-full p-2 rounded-lg theme-bg-secondary border theme-border-input theme-text-primary text-sm"
                        >
                          <option value="low">Low - RÃ¡pido</option>
                          <option value="medium">Medium - Balanceado (Recomendado)</option>
                          <option value="high">High - Mais detalhado</option>
                          <option value="xhigh">Extra High - MÃ¡xima qualidade (lento)</option>
                        </select>
                        {aiIntegration.aiSettings.doubleCheck?.openaiReasoningLevel === 'xhigh' && (
                          <p className="text-xs text-amber-400 mt-1">
                            âš ï¸ NÃ­vel xhigh pode demorar vÃ¡rios minutos
                          </p>
                        )}
                      </div>
                    )}

                    {aiIntegration.aiSettings.doubleCheck?.provider === 'openai' &&
                     aiIntegration.aiSettings.doubleCheck?.model === 'gpt-5.2-chat-latest' && (
                      <p className="text-xs theme-text-muted p-2 rounded bg-gray-500/10">
                        âš¡ GPT-5.2 Instant nÃ£o suporta thinking/reasoning
                      </p>
                    )}

                    {aiIntegration.aiSettings.doubleCheck?.provider === 'grok' &&
                     aiIntegration.aiSettings.doubleCheck?.model?.includes('reasoning') && (
                      <div className="p-3 rounded-lg border border-purple-500/30 bg-purple-500/10">
                        <div className="flex items-center gap-2">
                          <span className="text-purple-400">ğŸ§ </span>
                          <span className="text-sm theme-text-primary">Grok 4.1 Fast Thinking</span>
                        </div>
                        <p className="text-xs theme-text-muted mt-1">
                          Thinking Ã© automÃ¡tico e nÃ£o configurÃ¡vel
                        </p>
                      </div>
                    )}

                    {aiIntegration.aiSettings.doubleCheck?.provider === 'grok' &&
                     aiIntegration.aiSettings.doubleCheck?.model?.includes('non-reasoning') && (
                      <p className="text-xs theme-text-muted p-2 rounded bg-gray-500/10">
                        âš¡ Grok 4.1 Fast Instant nÃ£o suporta thinking
                      </p>
                    )}

                    {/* OperaÃ§Ãµes que usam Double Check */}
                    <div>
                      <label className="block text-xs font-medium theme-text-tertiary mb-2">
                        OperaÃ§Ãµes com verificaÃ§Ã£o
                      </label>
                      <div className="space-y-2">
                        <label className="flex items-center gap-3 p-2 rounded-lg hover:theme-bg-secondary cursor-pointer">
                          <input
                            type="checkbox"
                            checked={aiIntegration.aiSettings.doubleCheck?.operations.topicExtraction || false}
                            onChange={(e) => {
                              aiIntegration.setAiSettings({
                                ...aiIntegration.aiSettings,
                                doubleCheck: {
                                  ...aiIntegration.aiSettings.doubleCheck!,
                                  operations: {
                                    ...aiIntegration.aiSettings.doubleCheck!.operations,
                                    topicExtraction: e.target.checked
                                  }
                                }
                              });
                            }}
                            className="w-4 h-4 rounded border-gray-300 text-purple-500 focus:ring-purple-500"
                          />
                          <div className="flex-1">
                            <span className="text-sm theme-text-primary">ExtraÃ§Ã£o de tÃ³picos</span>
                            <p className="text-xs theme-text-muted">
                              Verifica falsos positivos, omissÃµes e categorizaÃ§Ã£o incorreta
                            </p>
                          </div>
                        </label>
                        {/* v1.36.56: Dispositivo */}
                        <label className="flex items-center gap-3 p-2 rounded-lg hover:theme-bg-secondary cursor-pointer">
                          <input
                            type="checkbox"
                            checked={aiIntegration.aiSettings.doubleCheck?.operations.dispositivo || false}
                            onChange={(e) => {
                              aiIntegration.setAiSettings({
                                ...aiIntegration.aiSettings,
                                doubleCheck: {
                                  ...aiIntegration.aiSettings.doubleCheck!,
                                  operations: {
                                    ...aiIntegration.aiSettings.doubleCheck!.operations,
                                    dispositivo: e.target.checked
                                  }
                                }
                              });
                            }}
                            className="w-4 h-4 rounded border-gray-300 text-purple-500 focus:ring-purple-500"
                          />
                          <div className="flex-1">
                            <span className="text-sm theme-text-primary">Dispositivo</span>
                            <p className="text-xs theme-text-muted">
                              Verifica omissÃµes de pedidos e contradiÃ§Ãµes com fundamentaÃ§Ã£o
                            </p>
                          </div>
                        </label>
                        {/* v1.36.56: Revisar SentenÃ§a */}
                        <label className="flex items-center gap-3 p-2 rounded-lg hover:theme-bg-secondary cursor-pointer">
                          <input
                            type="checkbox"
                            checked={aiIntegration.aiSettings.doubleCheck?.operations.sentenceReview || false}
                            onChange={(e) => {
                              aiIntegration.setAiSettings({
                                ...aiIntegration.aiSettings,
                                doubleCheck: {
                                  ...aiIntegration.aiSettings.doubleCheck!,
                                  operations: {
                                    ...aiIntegration.aiSettings.doubleCheck!.operations,
                                    sentenceReview: e.target.checked
                                  }
                                }
                              });
                            }}
                            className="w-4 h-4 rounded border-gray-300 text-purple-500 focus:ring-purple-500"
                          />
                          <div className="flex-1">
                            <span className="text-sm theme-text-primary">Revisar sentenÃ§a</span>
                            <p className="text-xs theme-text-muted">
                              Valida anÃ¡lise de omissÃµes, contradiÃ§Ãµes e obscuridades
                            </p>
                          </div>
                        </label>
                        {/* v1.36.58: Confronto de Fatos */}
                        <label className="flex items-center gap-3 p-2 rounded-lg hover:theme-bg-secondary cursor-pointer">
                          <input
                            type="checkbox"
                            checked={aiIntegration.aiSettings.doubleCheck?.operations.factsComparison || false}
                            onChange={(e) => {
                              aiIntegration.setAiSettings({
                                ...aiIntegration.aiSettings,
                                doubleCheck: {
                                  ...aiIntegration.aiSettings.doubleCheck!,
                                  operations: {
                                    ...aiIntegration.aiSettings.doubleCheck!.operations,
                                    factsComparison: e.target.checked
                                  }
                                }
                              });
                            }}
                            className="w-4 h-4 rounded border-gray-300 text-purple-500 focus:ring-purple-500"
                          />
                          <div className="flex-1">
                            <span className="text-sm theme-text-primary">Confronto de fatos</span>
                            <p className="text-xs theme-text-muted">
                              Verifica completude, classificaÃ§Ã£o e correÃ§Ã£o das alegaÃ§Ãµes
                            </p>
                          </div>
                        </label>
                      </div>
                    </div>

                    {/* Aviso de custo */}
                    <div className="p-3 rounded-lg bg-amber-500/10 border border-amber-500/30">
                      <div className="flex items-start gap-2">
                        <span className="text-amber-400">âš ï¸</span>
                        <p className="text-xs text-amber-700 dark:text-amber-200">
                          Double Check <strong>dobra o custo e tempo</strong> de cada operaÃ§Ã£o selecionada.
                          Use apenas quando a precisÃ£o for crÃ­tica.
                        </p>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* NÃ­vel de Detalhe nos Mini-RelatÃ³rios */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">NÃ­vel de Detalhe nos Mini-RelatÃ³rios</label>
                <button
                  onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, detailedMiniReports: !aiIntegration.aiSettings.detailedMiniReports })}
                  className={`w-full p-4 rounded-lg border-2 transition-all text-left ${
                    aiIntegration.aiSettings.detailedMiniReports
                      ? 'bg-green-600/20 border-green-500'
                      : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                  }`}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className={CSS.flexGap2}>
                        <span className="font-semibold theme-text-primary">
                          {aiIntegration.aiSettings.detailedMiniReports ? 'âœ“ Ativado' : 'Desativado'}
                        </span>
                        {aiIntegration.aiSettings.detailedMiniReports && (
                          <span className="text-xs bg-green-500 text-white px-2 py-0.5 rounded">Alto Detalhe</span>
                        )}
                      </div>
                      <p className="text-xs theme-text-muted mt-1">
                        {aiIntegration.aiSettings.detailedMiniReports
                          ? 'Os mini-relatÃ³rios serÃ£o gerados com descriÃ§Ã£o fÃ¡tica detalhada, incluindo mais informaÃ§Ãµes sobre os fatos alegados pelas partes (postulatÃ³rios e defensivos).'
                          : 'Os mini-relatÃ³rios serÃ£o gerados com nÃ­vel de detalhe padrÃ£o. Recomendado para a maioria dos casos.'
                        }
                      </p>
                    </div>
                    <div className={`w-12 h-6 rounded-full transition-colors relative ${
                      aiIntegration.aiSettings.detailedMiniReports ? 'bg-green-500' : 'theme-bg-tertiary'
                    }`}>
                      <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${
                        aiIntegration.aiSettings.detailedMiniReports ? 'translate-x-7' : 'translate-x-1'
                      }`}></div>
                    </div>
                  </div>
                </button>
              </div>

              {/* v1.14.1: TÃ³picos por RequisiÃ§Ã£o */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">TÃ³picos por RequisiÃ§Ã£o</label>
                <div className="flex items-center justify-between p-4 rounded-lg theme-bg-secondary-30 theme-border-input border-2">
                  <div className="flex-1">
                    <p className="text-sm theme-text-primary font-medium">Quantos mini-relatÃ³rios gerar por chamada Ã  API</p>
                    <p className="text-xs theme-text-muted mt-1">
                      Mais tÃ³picos = menos chamadas = mais rÃ¡pido. "Todos" usa 1 requisiÃ§Ã£o com limite maior (48K tokens).
                    </p>
                  </div>
                  <select
                    value={aiIntegration.aiSettings.topicsPerRequest || 1}
                    onChange={(e) => {
                      const val = e.target.value;
                      aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, topicsPerRequest: val === 'all' ? 'all' : parseInt(val) });
                    }}
                    className="ml-4 px-3 py-2 rounded-lg theme-bg-primary theme-text-primary theme-border-input border text-sm font-medium"
                  >
                    <option value={1}>1 (padrÃ£o)</option>
                    <option value={3}>3 tÃ³picos</option>
                    <option value={5}>5 tÃ³picos</option>
                    <option value="all">Todos (1 requisiÃ§Ã£o)</option>
                  </select>
                </div>
              </div>

              {/* v1.33.11: RequisiÃ§Ãµes Paralelas */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">RequisiÃ§Ãµes Paralelas</label>
                <div className="flex items-center justify-between p-4 rounded-lg theme-bg-secondary-30 theme-border-input border-2">
                  <div className="flex-1">
                    <p className="text-sm theme-text-primary font-medium">Quantas requisiÃ§Ãµes enviar simultaneamente</p>
                    <p className="text-xs theme-text-muted mt-1">
                      Mais paralelas = mais rÃ¡pido, mas pode causar erro 429 se exceder limite da API.
                    </p>
                  </div>
                  <select
                    value={aiIntegration.aiSettings.parallelRequests || 5}
                    onChange={(e) => {
                      aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, parallelRequests: parseInt(e.target.value) });
                    }}
                    className="ml-4 px-3 py-2 rounded-lg theme-bg-primary theme-text-primary theme-border-input border text-sm font-medium"
                  >
                    <option value={3}>3 (Conservador)</option>
                    <option value={5}>5 (PadrÃ£o)</option>
                    <option value={10}>10 (RÃ¡pido)</option>
                    <option value={15}>15 (Alto volume)</option>
                    <option value={20}>20 (MÃ¡ximo)</option>
                  </select>
                </div>
                {/* Texto explicativo com limites */}
                <div className="mt-2 p-3 rounded-lg theme-bg-tertiary text-xs theme-text-muted">
                  <p className="font-semibold theme-text-secondary mb-1">Limites por API (RPM = requisiÃ§Ãµes/minuto):</p>
                  <div className="grid grid-cols-2 lg:grid-cols-4 gap-2">
                    <div>
                      <span className="text-purple-400 font-medium">Claude:</span>
                      <ul className="ml-2 mt-0.5 space-y-0.5">
                        <li>â€¢ Tier 1 ($5): 50 RPM â†’ usar 3-5</li>
                        <li>â€¢ Tier 2+ ($40+): 1000+ RPM â†’ 10-15</li>
                      </ul>
                    </div>
                    <div>
                      <span className="text-blue-400 font-medium">Gemini:</span>
                      <ul className="ml-2 mt-0.5 space-y-0.5">
                        <li>â€¢ Free: 5-10 RPM â†’ usar 3</li>
                        <li>â€¢ Pago: 300+ RPM â†’ 10-20</li>
                      </ul>
                    </div>
                    {/* v1.36.12: OpenAI e Grok */}
                    <div>
                      <span className="text-green-400 font-medium">OpenAI:</span>
                      <ul className="ml-2 mt-0.5 space-y-0.5">
                        <li>â€¢ Tier 1: ~1000 RPM â†’ 10-15</li>
                        <li>â€¢ Tier 2+: 2000+ RPM â†’ 15-20</li>
                      </ul>
                    </div>
                    <div>
                      <span className="text-gray-400 font-medium">Grok:</span>
                      <ul className="ml-2 mt-0.5 space-y-0.5">
                        <li>â€¢ Pay-as-you-go: 480 RPM</li>
                        <li>â€¢ Recomendado: 10-20</li>
                      </ul>
                    </div>
                  </div>
                  <p className="mt-2 text-orange-600 dark:text-orange-300 font-medium">âš ï¸ Erro 429 = limite excedido. Reduza o valor.</p>
                </div>
              </div>

              {/* v1.12.25: Modo de Processamento de PDF (PDF Puro | Extrair Texto â†’ PDF.js | Claude Vision) */}
              {/* Nota: "ExtraÃ§Ã£o AutomÃ¡tica de Texto de PDFs" foi removido por ser redundante */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Modo de Processamento de PDF
                </label>
                <div className="space-y-3">
                  {/* OpÃ§Ã£o 1: PDF Puro */}
                  <button
                    onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, ocrEngine: 'pdf-puro' })}
                    className={`w-full p-3 rounded-lg border-2 transition-all text-left ${
                      aiIntegration.aiSettings.ocrEngine === 'pdf-puro'
                        ? 'bg-stone-600/20 border-stone-500'
                        : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                    }`}
                  >
                    <div className="flex items-start gap-3">
                      <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                        aiIntegration.aiSettings.ocrEngine === 'pdf-puro'
                          ? 'border-stone-500 bg-stone-500'
                          : 'theme-border'
                      }`}>
                        {aiIntegration.aiSettings.ocrEngine === 'pdf-puro' && (
                          <div className="w-2 h-2 bg-white rounded-full"></div>
                        )}
                      </div>
                      <div className="flex-1">
                        <span className="font-semibold theme-text-primary text-sm">PDF Puro (BinÃ¡rio)</span>
                        <p className="text-xs theme-text-muted mt-1">
                          Envia o PDF como arquivo binÃ¡rio, sem extraÃ§Ã£o de texto. Usa mais tokens mas preserva 100% do documento.
                        </p>
                      </div>
                    </div>
                  </button>

                  {/* OpÃ§Ã£o 2: Extrair Texto */}
                  <button
                    onClick={() => {
                      // Se nÃ£o estava em modo extraÃ§Ã£o, muda para pdfjs (padrÃ£o)
                      if (aiIntegration.aiSettings.ocrEngine === 'pdf-puro') {
                        aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, ocrEngine: 'pdfjs' });
                      }
                    }}
                    className={`w-full p-3 rounded-lg border-2 transition-all text-left ${
                      ['pdfjs', 'tesseract', 'claude-vision'].includes(aiIntegration.aiSettings.ocrEngine)
                        ? 'bg-blue-600/20 border-blue-500'
                        : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                    }`}
                  >
                    <div className="flex items-start gap-3">
                      <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                        ['pdfjs', 'tesseract', 'claude-vision'].includes(aiIntegration.aiSettings.ocrEngine)
                          ? 'border-blue-500 bg-blue-500'
                          : 'theme-border'
                      }`}>
                        {['pdfjs', 'tesseract', 'claude-vision'].includes(aiIntegration.aiSettings.ocrEngine) && (
                          <div className="w-2 h-2 bg-white rounded-full"></div>
                        )}
                      </div>
                      <div className="flex-1">
                        <div className={CSS.flexGap2}>
                          <span className="font-semibold theme-text-primary text-sm">Extrair Texto</span>
                          <span className="text-xs bg-green-500 text-white px-2 py-0.5 rounded">Recomendado</span>
                        </div>
                        <p className="text-xs theme-text-muted mt-1">
                          Extrai o texto do PDF antes de enviar. Economiza tokens e permite busca no texto.
                        </p>
                      </div>
                    </div>
                  </button>

                  {/* Sub-opÃ§Ãµes de extraÃ§Ã£o (sÃ³ aparece se "Extrair Texto" selecionado) */}
                  {['pdfjs', 'tesseract', 'claude-vision'].includes(aiIntegration.aiSettings.ocrEngine) && (
                    <div className="ml-4 border-l-2 border-blue-500/30 pl-4 space-y-3">
                      <p className="text-xs font-semibold theme-text-blue mb-2">MÃ©todo de extraÃ§Ã£o:</p>

                      {/* Sub-opÃ§Ã£o: PDF.js */}
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, ocrEngine: 'pdfjs' })}
                        className={`w-full p-3 rounded-lg border-2 transition-all text-left ${
                          aiIntegration.aiSettings.ocrEngine === 'pdfjs'
                            ? 'bg-green-600/20 border-green-500'
                            : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                        }`}
                      >
                        <div className="flex items-start gap-3">
                          <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                            aiIntegration.aiSettings.ocrEngine === 'pdfjs'
                              ? 'border-green-500 bg-green-500'
                              : 'theme-border'
                          }`}>
                            {aiIntegration.aiSettings.ocrEngine === 'pdfjs' && (
                              <div className="w-2 h-2 bg-white rounded-full"></div>
                            )}
                          </div>
                          <div className="flex-1">
                            <div className={CSS.flexGap2}>
                              <span className="font-semibold theme-text-primary text-sm">PDF.js - PadrÃ£o</span>
                              <span className="text-xs bg-green-500 text-white px-2 py-0.5 rounded">Gratuito</span>
                            </div>
                            <p className="text-xs theme-text-muted mt-1">
                              âœ… RÃ¡pido e gratuito | âš ï¸ NÃ£o funciona com PDFs escaneados (imagens)
                            </p>
                          </div>
                        </div>
                      </button>

                      {/* Sub-opÃ§Ã£o: Tesseract OCR */}
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, ocrEngine: 'tesseract' })}
                        className={`w-full p-3 rounded-lg border-2 transition-all text-left ${
                          aiIntegration.aiSettings.ocrEngine === 'tesseract'
                            ? 'bg-cyan-600/20 border-cyan-500'
                            : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                        }`}
                      >
                        <div className="flex items-start gap-3">
                          <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                            aiIntegration.aiSettings.ocrEngine === 'tesseract'
                              ? 'border-cyan-500 bg-cyan-500'
                              : 'theme-border'
                          }`}>
                            {aiIntegration.aiSettings.ocrEngine === 'tesseract' && (
                              <div className="w-2 h-2 bg-white rounded-full"></div>
                            )}
                          </div>
                          <div className="flex-1">
                            <div className={CSS.flexGap2}>
                              <span className="font-semibold theme-text-primary text-sm">Tesseract OCR - Offline</span>
                              <span className="text-xs bg-cyan-500 text-white px-2 py-0.5 rounded">Gratuito</span>
                            </div>
                            <p className="text-xs theme-text-muted mt-1">
                              âœ… 100% offline e gratuito | âœ… Funciona com PDFs escaneados | â±ï¸ ~15-30s por pÃ¡gina
                            </p>
                          </div>
                        </div>
                      </button>

                      {/* Sub-opÃ§Ã£o: Claude Vision */}
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, ocrEngine: 'claude-vision' })}
                        className={`w-full p-3 rounded-lg border-2 transition-all text-left ${
                          aiIntegration.aiSettings.ocrEngine === 'claude-vision'
                            ? 'bg-purple-600/20 border-purple-500'
                            : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                        }`}
                      >
                        <div className="flex items-start gap-3">
                          <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                            aiIntegration.aiSettings.ocrEngine === 'claude-vision'
                              ? 'border-purple-500 bg-purple-500'
                              : 'theme-border'
                          }`}>
                            {aiIntegration.aiSettings.ocrEngine === 'claude-vision' && (
                              <div className="w-2 h-2 bg-white rounded-full"></div>
                            )}
                          </div>
                          <div className="flex-1">
                            <div className={CSS.flexGap2}>
                              <span className="font-semibold theme-text-primary text-sm">Claude Vision - OCR AvanÃ§ado</span>
                              <span className="text-xs bg-yellow-500 text-stone-900 px-2 py-0.5 rounded">API</span>
                            </div>
                            <p className="text-xs theme-text-muted mt-1">
                              ğŸ’° ~$0.04/10 pÃ¡ginas | âœ… Funciona com PDFs escaneados | â±ï¸ ~3-8s por pÃ¡gina
                            </p>
                          </div>
                        </div>
                      </button>

                      {/* Aviso de custo para Claude Vision */}
                      {aiIntegration.aiSettings.ocrEngine === 'claude-vision' && (
                        <div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3">
                          <div className="flex items-start gap-2">
                            <AlertCircle className="w-4 h-4 text-yellow-500 flex-shrink-0 mt-0.5" />
                            <div className="flex-1">
                              <p className="text-xs font-semibold text-yellow-500 mb-1">AtenÃ§Ã£o: Consumo de Tokens</p>
                              <ul className="text-xs theme-text-tertiary space-y-1">
                                <li>â€¢ ~100-500 tokens/pÃ¡gina (entrada) + ~100-300 tokens/pÃ¡gina (saÃ­da)</li>
                                <li>â€¢ Estimativa: ~$0.04 USD para 10 pÃ¡ginas</li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* v1.16.0: AnonimizaÃ§Ã£o de Documentos */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">AnonimizaÃ§Ã£o de Documentos</label>
                {!['pdfjs', 'tesseract'].includes(aiIntegration.aiSettings.ocrEngine) ? (
                  <div className="p-4 rounded-lg bg-stone-700/30 border border-stone-600/50">
                    <div className="flex items-start gap-3">
                      <span className="text-xl">ğŸ”’</span>
                      <div>
                        <p className="text-sm font-medium theme-text-muted">IndisponÃ­vel com o mÃ©todo atual</p>
                        <p className="text-xs theme-text-muted mt-1">
                          A anonimizaÃ§Ã£o sÃ³ funciona com extraÃ§Ã£o via PDF.js ou Tesseract. Com "{aiIntegration.aiSettings.ocrEngine === 'pdf-puro' ? 'PDF Puro' : 'Claude Vision'}", o documento jÃ¡ Ã© enviado Ã  IA antes da anonimizaÃ§Ã£o.
                        </p>
                      </div>
                    </div>
                  </div>
                ) : (
                  <>
                    <button
                      onClick={() => aiIntegration.setAiSettings({
                        ...aiIntegration.aiSettings,
                        anonymization: { ...aiIntegration.aiSettings.anonymization, enabled: !aiIntegration.aiSettings.anonymization?.enabled }
                      })}
                      className={`w-full p-4 rounded-lg border-2 transition-all text-left ${
                        aiIntegration.aiSettings.anonymization?.enabled
                          ? 'bg-amber-600/20 border-amber-500'
                          : 'theme-bg-secondary-30 theme-border-input hover-theme-border'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className={CSS.flexGap2}>
                            <span className="text-xl">ğŸ”’</span>
                            <span className="font-semibold theme-text-primary">
                              {aiIntegration.aiSettings.anonymization?.enabled ? 'âœ“ Ativada' : 'Desativada'}
                            </span>
                          </div>
                          <p className="text-xs theme-text-muted mt-1">
                            {aiIntegration.aiSettings.anonymization?.enabled
                              ? 'Dados sensÃ­veis serÃ£o removidos do texto antes do envio Ã  IA (CPF, RG, telefones, etc.)'
                              : 'O texto serÃ¡ enviado Ã  IA sem modificaÃ§Ãµes.'
                            }
                          </p>
                        </div>
                        <div className={`w-12 h-6 rounded-full transition-colors relative ${
                          aiIntegration.aiSettings.anonymization?.enabled ? 'bg-amber-500' : 'theme-bg-tertiary'
                        }`}>
                          <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${
                            aiIntegration.aiSettings.anonymization?.enabled ? 'translate-x-7' : 'translate-x-1'
                          }`}></div>
                        </div>
                      </div>
                    </button>

                    {aiIntegration.aiSettings.anonymization?.enabled && (
                      <div className="mt-3 p-4 rounded-lg theme-bg-secondary-30 border theme-border-input">
                        <p className="text-xs font-semibold theme-text-muted mb-3">Tipos de dados a anonimizar:</p>
                        <div className="grid grid-cols-2 gap-2">
                          {[
                            { key: 'cpf', label: 'CPF' },
                            { key: 'rg', label: 'RG' },
                            { key: 'pis', label: 'PIS/PASEP' },
                            { key: 'ctps', label: 'CTPS' },
                            { key: 'telefone', label: 'Telefones' },
                            { key: 'email', label: 'E-mails' },
                            { key: 'contaBancaria', label: 'Dados BancÃ¡rios' },
                            { key: 'processo', label: 'NÂº Processo (CNJ)' },
                            { key: 'valores', label: 'Valores (R$)' },
                            { key: 'nomes', label: 'Nomes das Partes' }
                          ].map(({ key, label }) => (
                            <label key={key} className="flex items-center gap-2 text-xs theme-text-secondary cursor-pointer">
                              <input
                                type="checkbox"
                                checked={(aiIntegration.aiSettings.anonymization as unknown as Record<string, boolean | undefined> | null)?.[key] !== false}
                                onChange={(e) => aiIntegration.setAiSettings({
                                  ...aiIntegration.aiSettings,
                                  anonymization: { ...aiIntegration.aiSettings.anonymization, [key]: e.target.checked }
                                })}
                                className="w-4 h-4 rounded border-gray-500 text-amber-500 focus:ring-amber-500"
                              />
                              {label}
                            </label>
                          ))}
                        </div>
                        <p className="text-xs theme-text-muted mt-3 italic">
                          Valores (R$) estÃ¡ desativado por padrÃ£o pois sÃ£o relevantes para anÃ¡lise de pedidos.
                        </p>

                        {/* v1.32.00: IA Local - DetecÃ§Ã£o de Nomes (NER) - Simplificado (download automÃ¡tico) */}
                        <div className="border-t theme-border-secondary pt-4 mt-4">
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <span className="text-sm font-medium theme-text-primary">ğŸ§  DetecÃ§Ã£o AutomÃ¡tica de Nomes</span>
                              <span className="text-xs bg-purple-500/20 text-purple-600 dark:text-purple-400 px-2 py-0.5 rounded">IA Local</span>
                            </div>
                            <div
                              className={`toggle-switch ${nerEnabled ? 'active' : ''}`}
                              onClick={async () => {
                                const newVal = !nerEnabled;
                                setNerEnabled(newVal);
                                localStorage.setItem('nerEnabled', JSON.stringify(newVal));
                                // v1.32.17: NER agora Ã© carregado sob demanda (ao clicar "Detectar Nomes")
                                // Removido auto-init para economizar ~2GB de RAM
                                if (!newVal && nerModelReady) {
                                  // Descarregar ao desativar
                                  await AIModelService.unload('ner');
                                  setNerModelReady(false);
                                }
                              }}
                            >
                              <div className="toggle-knob"></div>
                            </div>
                          </div>

                          {nerEnabled && (
                            <div className="theme-bg-tertiary rounded-lg p-3 border theme-border-input">
                              <p className="text-xs theme-text-muted mb-3">
                                Modelo NER multilÃ­ngue - baixado automaticamente do HuggingFace (~150MB).
                              </p>
                              <div className="space-y-2 mb-3">
                                <div className="flex items-center justify-between">
                                  <div className="flex items-center gap-2">
                                    {nerModelReady ? (
                                      <span className="flex items-center gap-1.5 text-xs text-green-600 dark:text-green-400">
                                        <Check className="w-4 h-4" />
                                        <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                                        Pronto
                                      </span>
                                    ) : nerInitializing ? (
                                      <span className="flex items-center gap-1.5 text-xs text-blue-400">
                                        <RefreshCw className="w-4 h-4 animate-spin" />
                                        Baixando modelo... {nerDownloadProgress > 0 && `${nerDownloadProgress}%`}
                                      </span>
                                    ) : (
                                      <button
                                        onClick={initNerModel}
                                        className="flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-xs font-medium"
                                      >
                                        <Download className="w-3 h-3" />
                                        Baixar Agora (~150MB)
                                      </button>
                                    )}
                                  </div>
                                  {nerModelReady && (
                                    <button
                                      onClick={() => AIModelService.unload('ner').then(() => setNerModelReady(false))}
                                      className="text-xs text-red-400 hover:text-red-300"
                                      title="Descarregar modelo da memÃ³ria"
                                    >
                                      <X className="w-4 h-4" />
                                    </button>
                                  )}
                                </div>
                                {nerInitializing && nerDownloadProgress > 0 && (
                                  <div className="h-1.5 bg-gray-600 rounded-full overflow-hidden">
                                    <div className="h-full bg-purple-500 transition-all duration-300" style={{ width: `${nerDownloadProgress}%` }} />
                                  </div>
                                )}
                              </div>

                              {/* v1.29: Toggle para incluir empresas (ORG) */}
                              <div className="pt-3 border-t theme-border-secondary">
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <div
                                    className={`toggle-switch ${nerIncludeOrg ? 'active' : ''}`}
                                    onClick={() => {
                                      const newVal = !nerIncludeOrg;
                                      setNerIncludeOrg(newVal);
                                      localStorage.setItem('nerIncludeOrg', JSON.stringify(newVal));
                                    }}
                                  >
                                    <div className="toggle-knob"></div>
                                  </div>
                                  <span className="text-xs theme-text-secondary">
                                    Incluir empresas (reclamadas)
                                  </span>
                                </label>
                                <p className="text-xs theme-text-muted mt-1 ml-10">
                                  Detecta nomes de empresas (ORG) com score â‰¥ 90%. Filtra tribunais e Ã³rgÃ£os pÃºblicos.
                                </p>
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </>
                )}
              </div>

              {/* v1.33.61: Base de Dados - LegislaÃ§Ã£o e JurisprudÃªncia */}
              <div className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input">
                <div className="flex items-center justify-between">
                  <label className="flex items-center gap-2 text-sm font-medium theme-text-tertiary">
                    ğŸ“š Base de Dados
                    <span className="text-xs theme-text-muted">
                      ({legislacao.artigos?.length || 0} artigos, {jurisprudencia.precedentes?.length || 0} precedentes)
                    </span>
                  </label>
                  <button
                    onClick={async () => {
                      // Re-verificar IndexedDB diretamente (nÃ£o usar cache)
                      const legNeeded = await EmbeddingsCDNService.needsDataDownload('legislacao');
                      const jurisNeeded = await EmbeddingsCDNService.needsDataDownload('jurisprudencia');
                      setDataDownloadStatus({
                        legislacao: { needed: legNeeded, downloading: false, progress: 0, error: null, completed: false },
                        jurisprudencia: { needed: jurisNeeded, downloading: false, progress: 0, error: null, completed: false }
                      });
                      localStorage.removeItem('dismissedDataPrompt');
                      setShowDataDownloadModal(true);
                    }}
                    className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors"
                  >
                    <Download className="w-3 h-3" /> Baixar/Atualizar
                  </button>
                </div>
              </div>

              {/* v1.28.00: Busca SemÃ¢ntica - Toggle MASTER + Sub-toggles independentes */}
              <div className="space-y-4">
                {/* Toggle Master - Controla carregamento do modelo E5 */}
                <div className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input">
                  <div className="flex items-center justify-between mb-3">
                    <label className="flex items-center gap-2 text-sm font-medium theme-text-tertiary">
                      ğŸ§  IA Local (Busca SemÃ¢ntica)
                      <span className="text-xs bg-blue-500/20 text-blue-600 dark:text-blue-400 px-2 py-0.5 rounded">E5-base</span>
                    </label>
                    <div
                      className={`toggle-switch ${searchEnabled ? 'active' : ''}`}
                      onClick={() => handleSearchToggle(!searchEnabled)}
                    >
                      <div className="toggle-knob"></div>
                    </div>
                  </div>

                  {searchEnabled && (
                    <div className="space-y-3">
                      <p className="text-xs theme-text-muted">
                        Modelo E5-base multilingual - baixado automaticamente do HuggingFace na primeira vez (~400MB)
                      </p>

                      {/* v1.32.00: Status do modelo E5 */}
                      <div className="theme-bg-tertiary rounded-lg p-3 border theme-border-input space-y-2">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            {searchModelReady ? (
                              <span className="flex items-center gap-1.5 text-xs text-green-600 dark:text-green-400">
                                <Check className="w-4 h-4" />
                                <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                                Modelo Pronto
                              </span>
                            ) : searchInitializing ? (
                              <span className="flex items-center gap-1.5 text-xs text-blue-400">
                                <RefreshCw className="w-4 h-4 animate-spin" />
                                Baixando modelo... {searchDownloadProgress > 0 && `${searchDownloadProgress}%`}
                              </span>
                            ) : (
                              <button
                                onClick={initSearchModel}
                                className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors"
                              >
                                <Download className="w-3 h-3" />
                                Baixar Agora (~400MB)
                              </button>
                            )}
                          </div>
                          {searchModelReady && (
                            <button
                              onClick={() => AIModelService.unload('search').then(() => setSearchModelReady(false))}
                              className="text-xs text-red-400 hover:text-red-300"
                              title="Descarregar modelo da memÃ³ria"
                            >
                              <X className="w-4 h-4" />
                            </button>
                          )}
                        </div>
                        {searchInitializing && searchDownloadProgress > 0 && (
                          <div className="h-1.5 bg-gray-600 rounded-full overflow-hidden">
                            <div className="h-full bg-blue-500 transition-all duration-300" style={{ width: `${searchDownloadProgress}%` }} />
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                {/* Sub-toggles - SÃ³ aparecem quando modelo E5 carregado */}
                {searchEnabled && searchModelReady && (
                  <div className="space-y-3 pl-4 border-l-2 border-blue-500/30">
                    {/* ğŸ“œ LegislaÃ§Ã£o */}
                    <div className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input">
                      <div className="flex items-center justify-between mb-2">
                        <label className="flex items-center gap-2 text-sm font-medium theme-text-tertiary">
                          ğŸ“œ LegislaÃ§Ã£o
                          <span className="text-xs theme-text-muted">({embeddingsCount} embeddings)</span>
                        </label>
                        <div className={`toggle-switch ${aiIntegration.aiSettings.semanticSearchEnabled ? 'active' : ''}`} onClick={() => handleLegislacaoToggle(!aiIntegration.aiSettings.semanticSearchEnabled)}>
                          <div className="toggle-knob"></div>
                        </div>
                      </div>

                      {aiIntegration.aiSettings.semanticSearchEnabled && (
                        <div className="space-y-3 pt-2 border-t theme-border-subtle">
                          <div className="flex items-center gap-2 flex-wrap">
                            {embeddingsCount === 0 ? (
                              <button onClick={() => setShowEmbeddingsDownloadModal(true)}
                                className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                                <Download className="w-3 h-3" /> Baixar do CDN
                              </button>
                            ) : (
                              <span className="text-xs text-green-500 flex items-center gap-1"><Check className="w-3 h-3" /> Instalado</span>
                            )}
                            {embeddingsCount > 0 && (<button onClick={clearEmbeddings} className="px-2 py-1.5 text-red-500 dark:text-red-400 text-xs"><Trash2 className="w-3 h-3" /></button>)}
                          </div>
                          <div className="flex items-center gap-3">
                            <span className="text-xs theme-text-muted">Threshold:</span>
                            <input type="range" min="20" max="80" value={aiIntegration.aiSettings.semanticThreshold} onChange={(e) => aiIntegration.setAiSettings(prev => ({ ...prev, semanticThreshold: Number(e.target.value) }))} className="flex-1 h-1.5 bg-gray-600 rounded-lg appearance-none cursor-pointer" />
                            <span className="text-xs theme-text-primary w-10 text-right">{aiIntegration.aiSettings.semanticThreshold}%</span>
                          </div>
                        </div>
                      )}
                    </div>

                    {/* ğŸ“š JurisprudÃªncia */}
                    <div className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input">
                      <div className="flex items-center justify-between mb-2">
                        <label className="flex items-center gap-2 text-sm font-medium theme-text-tertiary">
                          ğŸ“š JurisprudÃªncia
                          <span className="text-xs theme-text-muted">({jurisEmbeddingsCount} embeddings)</span>
                        </label>
                        <div className={`toggle-switch ${aiIntegration.aiSettings.jurisSemanticEnabled ? 'active' : ''}`} onClick={() => handleJurisToggle(!aiIntegration.aiSettings.jurisSemanticEnabled)}>
                          <div className="toggle-knob"></div>
                        </div>
                      </div>

                      {aiIntegration.aiSettings.jurisSemanticEnabled && (
                        <div className="space-y-3 pt-2 border-t theme-border-subtle">
                          <div className="flex items-center gap-2 flex-wrap">
                            {jurisEmbeddingsCount === 0 ? (
                              <button onClick={() => setShowEmbeddingsDownloadModal(true)}
                                className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                                <Download className="w-3 h-3" /> Baixar do CDN
                              </button>
                            ) : (
                              <span className="text-xs text-green-500 flex items-center gap-1"><Check className="w-3 h-3" /> Instalado</span>
                            )}
                            {jurisEmbeddingsCount > 0 && (<button onClick={clearJurisEmbeddings} className="px-2 py-1.5 text-red-500 dark:text-red-400 text-xs"><Trash2 className="w-3 h-3" /></button>)}
                          </div>
                          <div className="flex items-center gap-3">
                            <span className="text-xs theme-text-muted">Threshold:</span>
                            <input type="range" min="20" max="80" value={aiIntegration.aiSettings.jurisSemanticThreshold} onChange={(e) => aiIntegration.setAiSettings(prev => ({ ...prev, jurisSemanticThreshold: Number(e.target.value) }))} className="flex-1 h-1.5 bg-gray-600 rounded-lg appearance-none cursor-pointer" />
                            <span className="text-xs theme-text-primary w-10 text-right">{aiIntegration.aiSettings.jurisSemanticThreshold}%</span>
                          </div>
                          {/* v1.32.18: Toggle para usar IA Local nos editores */}
                          {jurisEmbeddingsCount > 0 && searchModelReady && (
                            <div className="flex items-center justify-between mt-3 pt-3 border-t theme-border-subtle">
                              <label className="text-xs theme-text-muted">ğŸ¤– JurisprudÃªncia via IA Local<span className="block opacity-70">Busca semÃ¢ntica nos editores</span></label>
                              <div className={`toggle-switch ${aiIntegration.aiSettings.useLocalAIForJuris ? 'active' : ''}`}
                                   onClick={() => aiIntegration.setAiSettings(prev => ({ ...prev, useLocalAIForJuris: !prev.useLocalAIForJuris }))}>
                                <div className="toggle-knob"></div>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>

                    {/* ğŸ“¦ Modelos */}
                    <div className="theme-bg-secondary-50 rounded-lg p-4 border theme-border-input">
                      <div className="flex items-center justify-between mb-2">
                        <label className="flex items-center gap-2 text-sm font-medium theme-text-tertiary">
                          ğŸ“¦ Modelos
                          <span className="text-xs theme-text-muted">({modelEmbeddingsCount}/{modelLibrary.models.length})</span>
                        </label>
                        <div className={`toggle-switch ${aiIntegration.aiSettings.modelSemanticEnabled ? 'active' : ''}`} onClick={() => handleModelToggle(!aiIntegration.aiSettings.modelSemanticEnabled)}>
                          <div className="toggle-knob"></div>
                        </div>
                      </div>

                      {aiIntegration.aiSettings.modelSemanticEnabled && (
                        <div className="space-y-3 pt-2 border-t theme-border-subtle">
                          <div className="flex items-center gap-2 flex-wrap">
                            <button onClick={generateModelEmbeddings} disabled={generatingModelEmbeddings}
                              className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${!generatingModelEmbeddings ? 'bg-purple-600 text-white hover-purple-700' : 'bg-gray-400 dark:bg-gray-600 text-gray-600 dark:text-gray-400 cursor-not-allowed'}`}>
                              {generatingModelEmbeddings ? (<><RefreshCw className="w-3 h-3 animate-spin" /> Gerando... {modelEmbeddingsProgress.current}/{modelEmbeddingsProgress.total}</>) : (<><Sparkles className="w-3 h-3" /> Gerar Embeddings</>)}
                            </button>
                            {modelEmbeddingsCount > 0 && (<button onClick={clearModelEmbeddings} className="px-2 py-1.5 text-red-500 dark:text-red-400 text-xs"><Trash2 className="w-3 h-3" /></button>)}
                          </div>
                          {generatingModelEmbeddings && modelEmbeddingsProgress.total > 0 && (
                            <div className="h-1.5 bg-gray-600 rounded-full overflow-hidden">
                              <div className="h-full bg-purple-500 transition-all duration-300" style={{ width: `${(modelEmbeddingsProgress.current / modelEmbeddingsProgress.total) * 100}%` }} />
                            </div>
                          )}
                          <div className="flex items-center gap-3">
                            <span className="text-xs theme-text-muted">Threshold:</span>
                            <input type="range" min="20" max="80" value={aiIntegration.aiSettings.modelSemanticThreshold} onChange={(e) => aiIntegration.setAiSettings(prev => ({ ...prev, modelSemanticThreshold: Number(e.target.value) }))} className="flex-1 h-1.5 bg-gray-600 rounded-lg appearance-none cursor-pointer" />
                            <span className="text-xs theme-text-primary w-10 text-right">{aiIntegration.aiSettings.modelSemanticThreshold}%</span>
                          </div>
                          {modelEmbeddingsCount > 0 && searchModelReady && (
                            <div className="flex items-center justify-between mt-3 pt-3 border-t theme-border-subtle">
                              <label className="text-xs theme-text-muted">ğŸ¤– SugestÃµes via IA Local<span className="block opacity-70">Busca semÃ¢ntica instantÃ¢nea</span></label>
                              <div className={`toggle-switch ${aiIntegration.aiSettings.useLocalAIForSuggestions ? 'active' : ''}`}
                                   onClick={() => aiIntegration.setAiSettings(prev => ({ ...prev, useLocalAIForSuggestions: !prev.useLocalAIForSuggestions }))}>
                                <div className="toggle-knob"></div>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>

              {/* Modelo de Mini-RelatÃ³rio */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Modelo de Mini-RelatÃ³rio (Opcional)
                </label>
                <div className="space-y-3">
                  <textarea
                    value={aiIntegration.aiSettings.modeloRelatorio || ''}
                    onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloRelatorio: e.target.value })}
                    placeholder="Ex: O reclamante sustenta que [fatos]. Alega [argumentos]. Requer [pedido]. A reclamada, por sua vez, defende que [argumentos da defesa]."
                    className="w-full h-32 theme-bg-secondary-50 border-2 theme-border-input rounded-lg p-3 theme-text-primary text-sm focus:border-blue-500 focus:outline-none resize-none"
                  />
                  {/* v1.35.69: BotÃ£o Gerar a partir de exemplos */}
                  <button
                    onClick={() => openModelGenerator('modeloRelatorio')}
                    className="flex items-center gap-2 px-3 py-1.5 text-xs bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 rounded-lg transition-colors"
                  >
                    <Wand2 className="w-3.5 h-3.5" />
                    Gerar a partir de exemplos
                  </button>
                  <p className="text-xs theme-text-muted flex items-start gap-2">
                    <FileText className="w-4 h-4 flex-shrink-0 mt-0.5 text-blue-400" />
                    <span>
                      Defina um modelo personalizado para os mini-relatÃ³rios gerados automaticamente.
                      Se deixar vazio, serÃ¡ usado o modelo padrÃ£o do sistema.
                    </span>
                  </p>
                  {aiIntegration.aiSettings.modeloRelatorio && (
                    <div className="flex items-center justify-between bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                      <div className="flex items-center gap-2 text-xs theme-text-green">
                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                        Modelo personalizado ativo ({aiIntegration.aiSettings.modeloRelatorio.length} caracteres)
                      </div>
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloRelatorio: '' })}
                        className="text-xs text-red-400 hover-text-red-300 underline"
                      >
                        Limpar
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Modelo de Dispositivo */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Modelo de Dispositivo (Opcional)
                </label>
                <div className="space-y-3">
                  <textarea
                    value={aiIntegration.aiSettings.modeloDispositivo || ''}
                    onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloDispositivo: e.target.value })}
                    placeholder="Ex: Ante o exposto, DECIDO: a) Julgar [resultado] o pedido de [tÃ³pico]; b) Deferir/Indeferir [especificaÃ§Ã£o]..."
                    className="w-full h-32 theme-bg-secondary-50 border-2 theme-border-input rounded-lg p-3 theme-text-primary text-sm focus:border-blue-500 focus:outline-none resize-none"
                  />
                  {/* v1.35.69: BotÃ£o Gerar a partir de exemplos */}
                  <button
                    onClick={() => openModelGenerator('modeloDispositivo')}
                    className="flex items-center gap-2 px-3 py-1.5 text-xs bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 rounded-lg transition-colors"
                  >
                    <Wand2 className="w-3.5 h-3.5" />
                    Gerar a partir de exemplos
                  </button>
                  <p className="text-xs theme-text-muted flex items-start gap-2">
                    <Scale className="w-4 h-4 flex-shrink-0 mt-0.5 text-purple-400" />
                    <span>
                      Defina um modelo personalizado para o dispositivo da sentenÃ§a.
                      Se deixar vazio, serÃ¡ usado o modelo padrÃ£o do sistema.
                    </span>
                  </p>
                  {aiIntegration.aiSettings.modeloDispositivo && (
                    <div className="flex items-center justify-between bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                      <div className="flex items-center gap-2 text-xs theme-text-green">
                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                        Modelo personalizado ativo ({aiIntegration.aiSettings.modeloDispositivo.length} caracteres)
                      </div>
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloDispositivo: '' })}
                        className="text-xs text-red-400 hover-text-red-300 underline"
                      >
                        Limpar
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Modelo do TÃ³pico RELATÃ“RIO */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Modelo do TÃ³pico RELATÃ“RIO (Opcional)
                </label>
                <div className="space-y-3">
                  <textarea
                    value={aiIntegration.aiSettings.modeloTopicoRelatorio || ''}
                    onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloTopicoRelatorio: e.target.value })}
                    placeholder='Ex: A presente reclamaÃ§Ã£o foi ajuizada em [data]. Realizou-se audiÃªncia em [data]. Foram juntados [documentos]. O processo encontra-se [situaÃ§Ã£o].'
                    className="w-full h-32 theme-bg-secondary-50 border-2 theme-border-input rounded-lg p-3 theme-text-primary text-sm focus:border-blue-500 focus:outline-none resize-none"
                  />
                  {/* v1.35.69: BotÃ£o Gerar a partir de exemplos */}
                  <button
                    onClick={() => openModelGenerator('modeloTopicoRelatorio')}
                    className="flex items-center gap-2 px-3 py-1.5 text-xs bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 rounded-lg transition-colors"
                  >
                    <Wand2 className="w-3.5 h-3.5" />
                    Gerar a partir de exemplos
                  </button>
                  <p className="text-xs theme-text-muted flex items-start gap-2">
                    <BookOpen className="w-4 h-4 flex-shrink-0 mt-0.5 text-green-400" />
                    <span>
                      Defina um modelo personalizado para o tÃ³pico especial "RELATÃ“RIO" que resume o histÃ³rico processual. 
                      Se deixar vazio, serÃ¡ usado o modelo padrÃ£o do sistema.
                    </span>
                  </p>
                  {aiIntegration.aiSettings.modeloTopicoRelatorio && (
                    <div className="flex items-center justify-between bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                      <div className="flex items-center gap-2 text-xs theme-text-green">
                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                        Modelo personalizado ativo ({aiIntegration.aiSettings.modeloTopicoRelatorio.length} caracteres)
                      </div>
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, modeloTopicoRelatorio: '' })}
                        className="text-xs text-red-400 hover-text-red-300 underline"
                      >
                        Limpar
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Prompt Personalizado */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  Estilo de RedaÃ§Ã£o Personalizado (Opcional)
                </label>
                <div className="space-y-3">
                  <textarea
                    value={aiIntegration.aiSettings.customPrompt || ''}
                    onChange={(e) => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, customPrompt: e.target.value })}
                    placeholder="Ex: Use linguagem mais coloquial, evite termos tÃ©cnicos em excesso, seja mais direto e objetivo, etc."
                    className="w-full h-32 theme-bg-secondary-50 border-2 theme-border-input rounded-lg p-3 theme-text-primary text-sm focus:border-blue-500 focus:outline-none resize-none"
                  />
                  {/* v1.35.77: BotÃ£o Gerar a partir de exemplos para Estilo de RedaÃ§Ã£o */}
                  <button
                    onClick={() => openModelGenerator('estiloRedacao')}
                    className="flex items-center gap-2 px-3 py-1.5 text-xs bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 rounded-lg transition-colors"
                  >
                    <Wand2 className="w-3.5 h-3.5" />
                    Gerar a partir de exemplos
                  </button>
                  <p className="text-xs theme-text-muted flex items-start gap-2">
                    <Sparkles className="w-4 h-4 flex-shrink-0 mt-0.5 text-purple-400" />
                    <span>
                      Defina instruÃ§Ãµes adicionais para personalizar o estilo de redaÃ§Ã£o da IA.
                      Estas instruÃ§Ãµes SUBSTITUEM o estilo padrÃ£o do sistema, permitindo personalizaÃ§Ã£o completa.
                    </span>
                  </p>
                  {aiIntegration.aiSettings.customPrompt && (
                    <div className="flex items-center justify-between bg-green-900/20 border border-green-500/30 rounded-lg p-3">
                      <div className="flex items-center gap-2 text-xs theme-text-green">
                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                        Estilo personalizado ativo ({aiIntegration.aiSettings.customPrompt.length} caracteres)
                      </div>
                      <button
                        onClick={() => aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, customPrompt: '' })}
                        className="text-xs text-red-400 hover-text-red-300 underline"
                      >
                        Limpar
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* v1.20.0: Prompts RÃ¡pidos */}
              <div className="mt-6">
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  âš¡ Prompts RÃ¡pidos
                </label>
                <p className="text-xs theme-text-muted mb-3">
                  Atalhos para perguntas frequentes ao assistente IA. Clique para enviar instantaneamente.
                </p>
                <div className="space-y-2 mb-3">
                  {(aiIntegration.aiSettings.quickPrompts || []).map((qp, idx) => (
                    <div key={qp.id} className="flex items-start gap-2 p-2 theme-bg-secondary rounded-lg">
                      <input
                        value={qp.icon}
                        onChange={(e) => {
                          const updated = [...aiIntegration.aiSettings.quickPrompts];
                          updated[idx] = { ...updated[idx], icon: e.target.value };
                          aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, quickPrompts: updated });
                        }}
                        className="w-10 text-center theme-bg-app border theme-border-input rounded p-1 text-sm"
                        maxLength={2}
                        placeholder="ğŸ“"
                      />
                      <input
                        value={qp.label}
                        onChange={(e) => {
                          const updated = [...aiIntegration.aiSettings.quickPrompts];
                          updated[idx] = { ...updated[idx], label: e.target.value };
                          aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, quickPrompts: updated });
                        }}
                        className="w-28 theme-bg-app border theme-border-input rounded p-1 text-sm"
                        placeholder="Nome"
                      />
                      <textarea
                        value={qp.prompt}
                        onChange={(e) => {
                          const updated = [...aiIntegration.aiSettings.quickPrompts];
                          updated[idx] = { ...updated[idx], prompt: e.target.value };
                          aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, quickPrompts: updated });
                        }}
                        className="flex-1 theme-bg-app border theme-border-input rounded p-1 text-xs resize-none"
                        rows={2}
                        placeholder="Texto do prompt..."
                      />
                      <button
                        onClick={() => {
                          const updated = aiIntegration.aiSettings.quickPrompts.filter((_, i: number) => i !== idx);
                          aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, quickPrompts: updated });
                        }}
                        className="p-1 text-red-500 hover-text-red-400"
                        title="Remover"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  ))}
                </div>
                <button
                  onClick={() => {
                    const newPrompt: QuickPrompt = {
                      id: `qp-${Date.now()}`,
                      label: '',
                      prompt: '',
                      icon: 'ğŸ“'
                    };
                    const updated = [...(aiIntegration.aiSettings.quickPrompts || []), newPrompt];
                    aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, quickPrompts: updated });
                  }}
                  className="text-sm text-blue-600 dark:text-blue-400 hover-blue-700"
                >
                  + Adicionar Prompt RÃ¡pido
                </button>
              </div>

              {/* v1.20.4: Uso de Tokens - SeÃ§Ã£o de mÃ©tricas */}
              {(() => {
                const tokenMetrics = aiIntegration.tokenMetrics || {};
                const totalTokens = (tokenMetrics.totalInput || 0) + (tokenMetrics.totalOutput || 0) +
                                    (tokenMetrics.totalCacheRead || 0) + (tokenMetrics.totalCacheCreation || 0);
                const cacheRate = totalTokens > 0
                  ? Math.round(((tokenMetrics.totalCacheRead || 0) / totalTokens) * 100)
                  : 0;
                const formatNumber = (n: number) => {
                  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
                  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
                  return (n || 0).toString();
                };
                const calculateCost = (m: { totalInput?: number; totalCacheCreation?: number; totalCacheRead?: number; totalOutput?: number }, prices: { input: number; cacheWrite: number; cacheRead: number; output: number }) => {
                  const inputCost = ((m.totalInput || 0) / 1000000) * prices.input;
                  const cacheWriteCost = ((m.totalCacheCreation || 0) / 1000000) * prices.cacheWrite;
                  const cacheReadCost = ((m.totalCacheRead || 0) / 1000000) * prices.cacheRead;
                  const outputCost = ((m.totalOutput || 0) / 1000000) * prices.output;
                  return inputCost + cacheWriteCost + cacheReadCost + outputCost;
                };
                const sonnetPrices = { input: 3.00, output: 15.00, cacheWrite: 3.75, cacheRead: 0.30 };
                const opusPrices = { input: 5.00, output: 25.00, cacheWrite: 6.25, cacheRead: 0.50 };
                const geminiPrices = { input: 2.00, output: 12.00, cacheWrite: 2.50, cacheRead: 0.20 };
                const geminiFlashPrices = { input: 0.50, output: 3.00, cacheWrite: 0.625, cacheRead: 0.05 };
                // v1.36.12: OpenAI e Grok
                const openaiPrices = { input: 1.75, output: 14.00, cacheWrite: 1.75, cacheRead: 0.175 };
                const grokPrices = { input: 0.20, output: 0.50, cacheWrite: 0.20, cacheRead: 0.05 };

                return (
                  <div className="border-t theme-border-secondary pt-4 mt-4">
                    <label className="block text-sm font-medium theme-text-tertiary mb-3">
                      ğŸ“Š Uso de Tokens (Projeto Atual)
                    </label>

                    {(tokenMetrics.requestCount ?? 0) > 0 ? (
                      <div className="theme-bg-secondary-30 rounded-lg p-4 border theme-border-input space-y-3">
                        <div className="flex justify-between items-center">
                          <span className="theme-text-secondary text-sm">Total de Tokens:</span>
                          <span className="font-mono font-semibold theme-text-primary">{formatNumber(totalTokens)}</span>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="theme-text-secondary text-sm">RequisiÃ§Ãµes:</span>
                          <span className="font-mono theme-text-primary">{tokenMetrics.requestCount}</span>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="theme-text-secondary text-sm">Taxa de Cache:</span>
                          <span className="font-mono text-green-400">{cacheRate}%</span>
                        </div>

                        <div className="border-t theme-border-secondary pt-3 mt-3 space-y-2 text-sm">
                          <div className="flex justify-between">
                            <span className="theme-text-muted">ğŸ“¥ Input:</span>
                            <span className="font-mono theme-text-secondary">{formatNumber(tokenMetrics.totalInput ?? 0)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="theme-text-muted">ğŸ“¤ Output:</span>
                            <span className="font-mono theme-text-secondary">{formatNumber(tokenMetrics.totalOutput ?? 0)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-green-400">ğŸ’¾ Cache Read:</span>
                            <span className="font-mono text-green-400">{formatNumber(tokenMetrics.totalCacheRead ?? 0)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-yellow-400">ğŸ†• Cache Write:</span>
                            <span className="font-mono text-yellow-400">{formatNumber(tokenMetrics.totalCacheCreation ?? 0)}</span>
                          </div>
                        </div>

                        <div className="border-t theme-border-secondary pt-3 mt-3 space-y-2">
                          <span className="theme-text-secondary text-sm block mb-2">ğŸ’° Custo Estimado:</span>
                          <div className="flex justify-between items-center">
                            <span className="text-xs theme-text-muted">Sonnet 4/4.5:</span>
                            <span className="font-mono text-sm text-blue-400">${calculateCost(tokenMetrics, sonnetPrices).toFixed(4)}</span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-xs theme-text-muted">Opus 4.5:</span>
                            <span className="font-mono text-sm text-purple-400">${calculateCost(tokenMetrics, opusPrices).toFixed(4)}</span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-xs theme-text-muted">Gemini 3 Pro:</span>
                            <span className="font-mono text-sm text-emerald-400">${calculateCost(tokenMetrics, geminiPrices).toFixed(4)}</span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-xs theme-text-muted">Gemini 3 Flash:</span>
                            <span className="font-mono text-sm text-cyan-400">${calculateCost(tokenMetrics, geminiFlashPrices).toFixed(4)}</span>
                          </div>
                          {/* v1.36.12: OpenAI e Grok */}
                          <div className="flex justify-between items-center">
                            <span className="text-xs theme-text-muted">OpenAI GPT-5.2:</span>
                            <span className="font-mono text-sm text-green-400">${calculateCost(tokenMetrics, openaiPrices).toFixed(4)}</span>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-xs theme-text-muted">Grok 4.1 Fast:</span>
                            <span className="font-mono text-sm text-gray-400">${calculateCost(tokenMetrics, grokPrices).toFixed(4)}</span>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <p className="theme-text-muted text-sm">Nenhuma requisiÃ§Ã£o realizada ainda neste projeto.</p>
                    )}
                  </div>
                );
              })()}

              {/* TÃ³picos Complementares AutomÃ¡ticos - dentro da Ã¡rea scrollÃ¡vel */}
              <div>
                <label className="block text-sm font-medium theme-text-tertiary mb-3">
                  ğŸ“‹ TÃ³picos Complementares AutomÃ¡ticos
                </label>
                <div className="theme-bg-secondary-30 rounded-lg p-4 border theme-border-input">
                  <p className="text-xs theme-text-muted mb-3">
                    TÃ³picos que serÃ£o adicionados automaticamente ao final da anÃ¡lise de documentos (nÃ£o selecionados por padrÃ£o).
                    <br />
                    <span className="text-blue-400">ğŸ’¡ Dica: Arraste os tÃ³picos para reordenÃ¡-los</span>
                  </p>

                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {(aiIntegration.aiSettings.topicosComplementares || []).map((topico, idx) => (
                      <div
                        key={topico.id}
                        draggable
                        onDragStart={(e) => handleComplementaryDragStart(e, idx)}
                        onDragEnd={handleComplementaryDragEnd}
                        onDragOver={(e) => handleComplementaryDragOver(e, idx)}
                        onDragLeave={handleComplementaryDragLeave}
                        onDrop={(e) => handleComplementaryDrop(e, idx)}
                        className={`flex items-center gap-3 p-3 rounded-lg border transition-colors cursor-move ${
                          topico.enabled
                            ? 'theme-bg-tertiary-30 theme-border'
                            : 'theme-bg-secondary/20 theme-border-input opacity-60'
                        } ${
                          draggedComplementaryIndex === idx
                            ? 'opacity-50 border-blue-500'
                            : ''
                        } ${
                          dragOverComplementaryIndex === idx
                            ? 'border-green-500 border-2 scale-105'
                            : ''
                        }`}
                      >
                        <div className="cursor-grab active:cursor-grabbing theme-text-disabled hover-theme-text-tertiary transition-colors" title="Arrastar para reordenar">
                          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M7 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 2zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 14zm6-8a2 2 0 1 0-.001-4.001A2 2 0 0 0 13 6zm0 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 14z"></path>
                          </svg>
                        </div>
                        <input
                          type="checkbox"
                          checked={topico.enabled}
                          onChange={(e) => {
                            const updated = [...(aiIntegration.aiSettings.topicosComplementares || [])];
                            updated[idx] = { ...updated[idx], enabled: e.target.checked };
                            aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, topicosComplementares: updated });
                          }}
                          className="w-4 h-4 rounded theme-border text-blue-500 focus:ring-blue-500 focus:ring-offset-0"
                        />
                        <div className="flex-1 min-w-0">
                          <div className="text-sm theme-text-primary font-medium truncate">{topico.title}</div>
                          <div className={CSS.textMuted}>{topico.category}</div>
                        </div>
                        <button
                          onClick={() => {
                            const updated = (aiIntegration.aiSettings.topicosComplementares || []).filter((_, i: number) => i !== idx);
                            aiIntegration.setAiSettings({ ...aiIntegration.aiSettings, topicosComplementares: updated });
                          }}
                          className="text-red-400 hover-text-red-300 transition-colors p-1"
                          title="Remover tÃ³pico"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                  </div>

                  {(aiIntegration.aiSettings.topicosComplementares || []).length === 0 && (
                    <p className="text-xs theme-text-disabled text-center py-4">
                      Nenhum tÃ³pico complementar configurado
                    </p>
                  )}

                  <div className="mt-3 pt-3 border-t theme-border-input">
                    <p className="text-xs theme-text-muted mb-2">Adicionar novo tÃ³pico:</p>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        placeholder="TÃ­tulo do tÃ³pico..."
                        id="newComplementaryTitle"
                        className="flex-1 px-3 py-2 theme-bg-primary border theme-border-input rounded text-sm theme-text-primary theme-placeholder focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <select
                        id="newComplementaryCategory"
                        defaultValue="MÃ‰RITO"
                        className="px-3 py-2 theme-bg-primary border theme-border-input rounded text-sm theme-text-primary focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="PRELIMINAR">Preliminar</option>
                        <option value="MÃ‰RITO">MÃ©rito</option>
                        <option value="PEDIDOS">Pedidos</option>
                        <option value="OUTROS">Outros</option>
                      </select>
                      <button
                        onClick={() => {
                          const titleInput = document.getElementById('newComplementaryTitle') as HTMLInputElement | null;
                          const categorySelect = document.getElementById('newComplementaryCategory') as HTMLSelectElement | null;
                          const title = titleInput?.value.trim();

                          if (title && titleInput && categorySelect) {
                            const complementares = aiIntegration.aiSettings.topicosComplementares || [];
                            const newId = Math.max(0, ...complementares.map(t => t.id)) + 1;
                            const newOrdem = complementares.length + 1;
                            const newTopico: TopicoComplementar = {
                              id: newId,
                              title: title,
                              category: categorySelect.value as TopicCategory,
                              enabled: true,
                              ordem: newOrdem
                            };

                            aiIntegration.setAiSettings({
                              ...aiIntegration.aiSettings,
                              topicosComplementares: [...complementares, newTopico]
                            });

                            titleInput.value = '';
                            showToast('TÃ³pico complementar adicionado!', 'success');
                          } else {
                            showToast('Digite um tÃ­tulo para o tÃ³pico', 'error');
                          }
                        }}
                        className="px-4 py-2 bg-green-600 text-white rounded hover-green-700 transition-colors text-sm font-medium"
                      >
                        <Plus className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Footer fixo com botÃµes */}
            <div className="p-6 border-t theme-border-secondary space-y-4">
              {/* BotÃµes de Exportar/Importar ConfiguraÃ§Ãµes */}
              <div className="flex gap-3">
                <button
                  onClick={exportAiSettings}
                  className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover-green-700 transition-colors text-sm font-medium"
                >
                  <Download className="w-4 h-4" />
                  Exportar ConfiguraÃ§Ãµes
                </button>
                <label className="flex-1">
                  <input
                    type="file"
                    accept=".json"
                    onChange={importAiSettings}
                    className="hidden"
                  />
                  <div className="flex items-center justify-center gap-2 px-4 py-2 bg-amber-600 rounded-lg hover-amber-700 transition-colors text-sm font-medium cursor-pointer">
                    <Upload className="w-4 h-4" />
                    Importar ConfiguraÃ§Ãµes
                  </div>
                </label>
              </div>

              <div className="flex justify-between items-center">
                <div className="text-xs theme-text-muted space-y-1">
                  <div>
                    Modelo atual: <span className="theme-text-secondary font-medium">
                      {aiIntegration.aiSettings.provider === 'gemini'
                        ? aiIntegration.getModelDisplayName(aiIntegration.aiSettings.geminiModel || '')
                        : aiIntegration.aiSettings.provider === 'openai'
                        ? aiIntegration.getModelDisplayName(aiIntegration.aiSettings.openaiModel || 'gpt-5.2-chat-latest')
                        : aiIntegration.aiSettings.provider === 'grok'
                        ? aiIntegration.getModelDisplayName(aiIntegration.aiSettings.grokModel || 'grok-4-1-fast-reasoning')
                        : aiIntegration.getModelDisplayName(aiIntegration.aiSettings.claudeModel || aiIntegration.aiSettings.model || '')}
                    </span>
                    {aiIntegration.aiSettings.useExtendedThinking && <span className="ml-2 text-purple-400">â€¢ Pensamento prolongado ativo</span>}
                    {aiIntegration.aiSettings.provider === 'gemini' && aiIntegration.aiSettings.geminiThinkingLevel && (
                      <span className="ml-2 text-blue-400">â€¢ Thinking: {aiIntegration.aiSettings.geminiThinkingLevel}</span>
                    )}
                  </div>
                  {aiIntegration.aiSettings.customPrompt && (
                    <div className="flex items-center gap-2 text-green-400">
                      <Sparkles className="w-3 h-3" />
                      <span>Estilo personalizado configurado</span>
                    </div>
                  )}
                </div>
                <button
                  onClick={() => closeModal('settings')}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg hover-blue-700 transition-colors font-medium"
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* v1.32.24: Modal de Changelog - v1.33.51: migrado para BaseModal */}
      <BaseModal
        isOpen={showChangelogModal}
        onClose={() => setShowChangelogModal(false)}
        title="HistÃ³rico de AlteraÃ§Ãµes"
        icon={<Clock />}
        iconColor="blue"
        size="md"
      >
        <div className="p-4 overflow-y-auto max-h-[60vh]">
          {CHANGELOG.map((item, i: number) => (
            <div key={i} className="mb-3 pb-3 border-b theme-border-secondary last:border-0">
              <span className="text-blue-400 font-mono text-sm font-semibold">v{item.version}</span>
              <p className="theme-text-secondary text-sm mt-1">{item.feature}</p>
            </div>
          ))}
        </div>
      </BaseModal>

      {/* ğŸ“¥ v1.33.61: Modal de Download de Dados Essenciais (legislaÃ§Ã£o e jurisprudÃªncia) - v1.35.67: migrado para BaseModal */}
      <BaseModal
        isOpen={showDataDownloadModal}
        onClose={handleDismissDataPrompt}
        title="Baixar Base de Dados"
        icon={<Download />}
        iconColor="blue"
        size="md"
        footer={
          <div className="flex justify-end gap-2">
            <button
              onClick={handleDismissDataPrompt}
              disabled={dataDownloadStatus.legislacao.downloading || dataDownloadStatus.jurisprudencia.downloading}
              className="px-4 py-2 text-sm theme-text-secondary hover:theme-text-primary disabled:opacity-50"
            >
              Depois
            </button>
            <button
              onClick={handleStartDataDownload}
              disabled={dataDownloadStatus.legislacao.downloading || dataDownloadStatus.jurisprudencia.downloading ||
                       (!dataDownloadStatus.legislacao.needed && !dataDownloadStatus.jurisprudencia.needed)}
              className="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
            >
              {(dataDownloadStatus.legislacao.downloading || dataDownloadStatus.jurisprudencia.downloading) ? (
                <><RefreshCw className="w-4 h-4 animate-spin" /> Baixando...</>
              ) : (
                <><Download className="w-4 h-4" /> Baixar Agora</>
              )}
            </button>
          </div>
        }
      >
        <div className="p-4 space-y-4">
          <p className="text-sm theme-text-secondary">
            Para usar o Sentencify, Ã© necessÃ¡rio baixar a base de dados de legislaÃ§Ã£o e jurisprudÃªncia (~5 MB total, download Ãºnico e rÃ¡pido).
          </p>

          {/* LegislaÃ§Ã£o */}
          {dataDownloadStatus.legislacao.needed && (
            <div className="p-3 rounded-lg theme-bg-secondary border theme-border-input">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium theme-text-primary">ğŸ“œ LegislaÃ§Ã£o (~3 MB)</span>
                {dataDownloadStatus.legislacao.downloading && (
                  <span className="text-xs theme-text-muted">
                    {Math.round(dataDownloadStatus.legislacao.progress * 100)}%
                  </span>
                )}
                {dataDownloadStatus.legislacao.completed && (
                  <span className="text-xs text-green-500">âœ“ ConcluÃ­do</span>
                )}
              </div>
              {dataDownloadStatus.legislacao.downloading && (
                <div className="h-2 bg-gray-600 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-blue-500 transition-all duration-300"
                    style={{ width: `${dataDownloadStatus.legislacao.progress * 100}%` }}
                  />
                </div>
              )}
              {dataDownloadStatus.legislacao.error && (
                <p className="text-xs text-red-400 mt-1">{dataDownloadStatus.legislacao.error}</p>
              )}
            </div>
          )}

          {/* JurisprudÃªncia */}
          {dataDownloadStatus.jurisprudencia.needed && (
            <div className="p-3 rounded-lg theme-bg-secondary border theme-border-input">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium theme-text-primary">âš–ï¸ JurisprudÃªncia (~2 MB)</span>
                {dataDownloadStatus.jurisprudencia.downloading && (
                  <span className="text-xs theme-text-muted">
                    {Math.round(dataDownloadStatus.jurisprudencia.progress * 100)}%
                  </span>
                )}
                {dataDownloadStatus.jurisprudencia.completed && (
                  <span className="text-xs text-green-500">âœ“ ConcluÃ­do</span>
                )}
              </div>
              {dataDownloadStatus.jurisprudencia.downloading && (
                <div className="h-2 bg-gray-600 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-green-500 transition-all duration-300"
                    style={{ width: `${dataDownloadStatus.jurisprudencia.progress * 100}%` }}
                  />
                </div>
              )}
              {dataDownloadStatus.jurisprudencia.error && (
                <p className="text-xs text-red-400 mt-1">{dataDownloadStatus.jurisprudencia.error}</p>
              )}
            </div>
          )}

          {/* Mensagem se ambos jÃ¡ foram baixados */}
          {!dataDownloadStatus.legislacao.needed && !dataDownloadStatus.jurisprudencia.needed && (
            <div className="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
              <p className="text-sm text-green-400 flex items-center gap-2">
                <Check className="w-4 h-4" /> Base de dados instalada!
              </p>
            </div>
          )}
        </div>
      </BaseModal>

      {/* ğŸŒ v1.33.0: Modal de Download de Embeddings do CDN - v1.35.67: migrado para BaseModal */}
      <BaseModal
        isOpen={showEmbeddingsDownloadModal}
        onClose={handleDismissEmbeddingsPrompt}
        title="Baixar Dados para Busca SemÃ¢ntica"
        icon={<Download />}
        iconColor="blue"
        size="md"
        footer={
          <div className="flex justify-end gap-2">
            <button
              onClick={handleDismissEmbeddingsPrompt}
              disabled={embeddingsDownloadStatus.legislacao.downloading || embeddingsDownloadStatus.jurisprudencia.downloading}
              className="px-4 py-2 text-sm theme-text-secondary hover:theme-text-primary disabled:opacity-50"
            >
              Depois
            </button>
            <button
              onClick={handleStartEmbeddingsDownload}
              disabled={embeddingsDownloadStatus.legislacao.downloading || embeddingsDownloadStatus.jurisprudencia.downloading ||
                       (!embeddingsDownloadStatus.legislacao.needed && !embeddingsDownloadStatus.jurisprudencia.needed)}
              className="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
            >
              {(embeddingsDownloadStatus.legislacao.downloading || embeddingsDownloadStatus.jurisprudencia.downloading) ? (
                <><RefreshCw className="w-4 h-4 animate-spin" /> Baixando...</>
              ) : (
                <><Download className="w-4 h-4" /> Baixar Agora</>
              )}
            </button>
          </div>
        }
      >
        <div className="p-4 space-y-4">
          <p className="text-sm theme-text-secondary">
            Para usar a busca semÃ¢ntica de legislaÃ§Ã£o e jurisprudÃªncia, Ã© necessÃ¡rio baixar os dados de embeddings (~250 MB total, download Ãºnico).
          </p>

          {/* LegislaÃ§Ã£o */}
          {embeddingsDownloadStatus.legislacao.needed && (
            <div className="p-3 rounded-lg theme-bg-secondary border theme-border-input">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium theme-text-primary">ğŸ“œ LegislaÃ§Ã£o (~211 MB)</span>
                {embeddingsDownloadStatus.legislacao.downloading && (
                  <span className="text-xs theme-text-muted">
                    {Math.round(embeddingsDownloadStatus.legislacao.progress * 100)}%
                  </span>
                )}
                {!embeddingsDownloadStatus.legislacao.needed && embeddingsDownloadStatus.legislacao.progress === 1 && (
                  <span className="text-xs text-green-500">âœ“ ConcluÃ­do</span>
                )}
              </div>
              {embeddingsDownloadStatus.legislacao.downloading && (
                <div className="h-2 bg-gray-600 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-blue-500 transition-all duration-300"
                    style={{ width: `${embeddingsDownloadStatus.legislacao.progress * 100}%` }}
                  />
                </div>
              )}
              {embeddingsDownloadStatus.legislacao.error && (
                <p className="text-xs text-red-400 mt-1">{embeddingsDownloadStatus.legislacao.error}</p>
              )}
            </div>
          )}

          {/* JurisprudÃªncia */}
          {embeddingsDownloadStatus.jurisprudencia.needed && (
            <div className="p-3 rounded-lg theme-bg-secondary border theme-border-input">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium theme-text-primary">ğŸ“š JurisprudÃªncia (~38 MB)</span>
                {embeddingsDownloadStatus.jurisprudencia.downloading && (
                  <span className="text-xs theme-text-muted">
                    {Math.round(embeddingsDownloadStatus.jurisprudencia.progress * 100)}%
                  </span>
                )}
                {!embeddingsDownloadStatus.jurisprudencia.needed && embeddingsDownloadStatus.jurisprudencia.progress === 1 && (
                  <span className="text-xs text-green-500">âœ“ ConcluÃ­do</span>
                )}
              </div>
              {embeddingsDownloadStatus.jurisprudencia.downloading && (
                <div className="h-2 bg-gray-600 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-green-500 transition-all duration-300"
                    style={{ width: `${embeddingsDownloadStatus.jurisprudencia.progress * 100}%` }}
                  />
                </div>
              )}
              {embeddingsDownloadStatus.jurisprudencia.error && (
                <p className="text-xs text-red-400 mt-1">{embeddingsDownloadStatus.jurisprudencia.error}</p>
              )}
            </div>
          )}

          {/* Mensagem se ambos jÃ¡ foram baixados */}
          {!embeddingsDownloadStatus.legislacao.needed && !embeddingsDownloadStatus.jurisprudencia.needed && (
            <div className="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
              <p className="text-sm text-green-400 flex items-center gap-2">
                <Check className="w-4 h-4" /> Todos os embeddings jÃ¡ estÃ£o instalados!
              </p>
            </div>
          )}
        </div>
      </BaseModal>

      {/* Modal de Restaurar SessÃ£o */}
      <RestoreSessionModal
        isOpen={modals.restoreSession}
        onClose={() => closeModal('restoreSession')}
        sessionLastSaved={storage.sessionLastSaved}
        onRestoreSession={() => {
          const callbacks = {
            setPastedPeticaoTexts,
            setPastedContestacaoTexts,
            setPastedComplementaryTexts,
            setExtractedTopics,
            setSelectedTopics,
            setPartesProcesso,
            setAnalyzedDocuments,
            // v1.13.7: Adicionar setters de arquivos de Upload para restaurar PDFs do IndexedDB
            setPeticaoFiles,
            setContestacaoFiles,
            setComplementaryFiles,
            setExtractedTexts,
            setDocumentProcessingModes,
            setProofFiles: proofManager.setProofFiles,
            setProofTexts: proofManager.setProofTexts,
            setProofUsePdfMode: proofManager.setProofUsePdfMode,
            setExtractedProofTexts: proofManager.setExtractedProofTexts,
            setProofExtractionFailed: proofManager.setProofExtractionFailed,
            setProofTopicLinks: proofManager.setProofTopicLinks,
            setProofAnalysisResults: proofManager.setProofAnalysisResults,
            setProofConclusions: proofManager.setProofConclusions,
            setProofSendFullContent: proofManager.setProofSendFullContent,
            setActiveTab,
            closeModal,
            setError,
            setProcessoNumero,
            setTokenMetrics: aiIntegration.setTokenMetrics // v1.20.3: Contador de tokens
          };
          storage.restoreSession(callbacks);
        }}
        onStartNew={() => {
          closeModal('restoreSession');
          openModal('clearProject');
        }}
      />

      {/* Modal de ConfirmaÃ§Ã£o de Limpeza de Projeto */}
      <ClearProjectModal
        isOpen={modals.clearProject}
        onClose={() => {
          closeModal('clearProject');
          openModal('restoreSession');
        }}
        onConfirmClear={() => {
          const callbacks = {
            // Callbacks de restauraÃ§Ã£o
            setPastedPeticaoTexts,
            setPastedContestacaoTexts,
            setPastedComplementaryTexts,
            setExtractedTopics,
            setSelectedTopics,
            setPartesProcesso,
            setAnalyzedDocuments,
            setProofFiles: proofManager.setProofFiles,
            setProofTexts: proofManager.setProofTexts,
            setProofUsePdfMode: proofManager.setProofUsePdfMode,
            setExtractedProofTexts: proofManager.setExtractedProofTexts,
            setProofExtractionFailed: proofManager.setProofExtractionFailed,
            setProofTopicLinks: proofManager.setProofTopicLinks,
            setProofAnalysisResults: proofManager.setProofAnalysisResults,
            setProofConclusions: proofManager.setProofConclusions,
            setProofSendFullContent: proofManager.setProofSendFullContent,
            setActiveTab,
            closeModal,
            setError,
            setProcessoNumero,
            // Callbacks adicionais para limpeza (mÃºltiplos)
            setPeticaoFiles,
            setContestacaoFiles,
            setComplementaryFiles,
            // v1.13.7: Adicionar setters de textos extraÃ­dos e modos de processamento
            setExtractedTexts,
            setDocumentProcessingModes,
            setProofToDelete: proofManager.setProofToDelete,
            setProofToLink: proofManager.setProofToLink,
            setProofToAnalyze: proofManager.setProofToAnalyze,
            clearAnalyzingProofs: proofManager.clearAnalyzingProofs,
            setShowProofPanel: proofManager.setShowProofPanel,
            setNewProofTextData: proofManager.setNewProofTextData,
            setTokenMetrics: aiIntegration.setTokenMetrics // v1.20.3: Contador de tokens
          };
          storage.clearProject(callbacks);
          // v1.25.19: Limpar nomes de anonimizaÃ§Ã£o ao limpar projeto
          aiIntegration.setAiSettings(prev => ({
            ...prev,
            anonymization: { ...prev.anonymization, nomesUsuario: [] }
          }));
          setAnonymizationNamesText('');
        }}
      />

      {/* v1.33.57: Modal de ConfirmaÃ§Ã£o de Logout */}
      {onLogout && (
        <LogoutConfirmModal
          isOpen={modals.logout}
          onClose={() => closeModal('logout')}
          onConfirm={() => {
            closeModal('logout');
            onLogout();
            window.location.reload();
          }}
        />
      )}

      {/* v1.35.0: Modal de Compartilhamento de Biblioteca */}
      <ShareLibraryModal
        isOpen={modals.shareLibrary}
        onClose={() => closeModal('shareLibrary')}
        user={cloudSync?.user}
        onRemoveSharedModels={(ownerId: string) => {
          // v1.35.23: Remover modelos compartilhados desse owner ao remover acesso
          modelLibrary.setModels((prev: Model[]) => {
            const filtered = prev.filter((m: Model) => !(m.isShared && m.ownerId === ownerId));
            console.log(`[Share] Removidos ${prev.length - filtered.length} modelos do owner ${ownerId}`);
            saveToIndexedDB(filtered);
            return filtered;
          });
        }}
      />

      {/* Modal de Nomes para AnonimizaÃ§Ã£o - v1.17.0 (v1.25: + NER) */}
      <AnonymizationNamesModal
        isOpen={showAnonymizationModal}
        onClose={() => setShowAnonymizationModal(false)}
        onConfirm={handleAnonymizationConfirm}
        nomesTexto={anonymizationNamesText}
        setNomesTexto={setAnonymizationNamesText}
        nerEnabled={nerEnabled}
        detectingNames={detectingNames}
        onDetectNames={detectarNomesAutomaticamente}
        onOpenAiSettings={() => { setShowAnonymizationModal(false); openModal('settings'); }}
      />

      {/* Modal de ConfirmaÃ§Ã£o de ExclusÃ£o de Modelo */}
      <DeleteModelModal
        isOpen={modals.deleteModel}
        onClose={() => closeModal('deleteModel')}
        modelToDelete={modelLibrary.modelToDelete}
        setModelToDelete={modelLibrary.setModelToDelete}
        onConfirmDelete={executeDeleteModel}
      />

      {/* ============= MODAIS DE GERAÃ‡ÃƒO EM MASSA ============= */}

      {/* Modal 1: Upload de Arquivos */}
      {/* Modal de Upload/Processamento em Lote */}
      <BulkUploadModal
        isOpen={modals.bulkModal}
        onClose={() => {
          closeModal('bulkModal');
          modelLibrary.setBulkFiles([]);
        }}
        isProcessing={modelLibrary.bulkProcessing}
        isReviewOpen={modals.bulkReview}
        bulkFiles={modelLibrary.bulkFiles}
        bulkFileInputRef={bulkFileInputRef}
        onFileUpload={handleBulkFileUpload}
        onRemoveFile={modelLibrary.removeBulkFile}
        onProcess={processBulkFiles}
        currentFileIndex={modelLibrary.bulkCurrentFileIndex}
        processedFiles={modelLibrary.bulkProcessedFiles}
        bulkStaggerDelay={modelLibrary.bulkStaggerDelay}
        setBulkStaggerDelay={modelLibrary.setBulkStaggerDelay}
        bulkCancelController={modelLibrary.bulkCancelController}
        generatedModels={modelLibrary.bulkGeneratedModels}
        bulkCurrentBatch={modelLibrary.bulkCurrentBatch}
        bulkBatchSize={aiIntegration.aiSettings.parallelRequests || 5}
        openModal={openModal}
      />

      {/* ğŸ” v1.13.1: Modal de Aviso de Similaridade */}
      <SimilarityWarningModal
        warning={modelLibrary.similarityWarning}
        saving={savingFromSimilarity}
        onCancel={handleSimilarityCancel}
        onSaveNew={handleSimilaritySaveNew}
        onReplace={handleSimilarityReplace}
        sanitizeHTML={sanitizeHTML}
      />

      {/* Modal 3: RevisÃ£o de Modelos Gerados */}
      {/* Modal de RevisÃ£o de Modelos Gerados em Lote */}
      <BulkReviewModal
        isOpen={modals.bulkReview}
        onClose={() => closeModal('bulkReview')}
        bulkReviewModels={modelLibrary.bulkReviewModels}
        bulkFiles={modelLibrary.bulkFiles}
        bulkGeneratedModels={modelLibrary.bulkGeneratedModels}
        bulkErrors={modelLibrary.bulkErrors}
        onRemoveModel={removeBulkReviewModel}
        onDiscard={() => {
          closeModal('bulkReview');
          openModal('bulkDiscardConfirm');
        }}
        onSave={saveBulkModels}
        sanitizeHTML={sanitizeHTML}
      />

      {/* Modal de ConfirmaÃ§Ã£o - Descartar Modelos Gerados */}
      <BulkDiscardConfirmModal
        isOpen={modals.bulkDiscardConfirm}
        onClose={() => {
          closeModal('bulkDiscardConfirm');
          openModal('bulkReview'); // Reabre o modal de revisÃ£o se cancelar
        }}
        totalModels={modelLibrary.bulkReviewModels.length}
        onConfirm={() => {
          closeModal('bulkDiscardConfirm');
          closeModal('bulkModal');
          modelLibrary.resetBulkState();
        }}
      />

      {/* v1.5.15: Modal de ConfirmaÃ§Ã£o - Cancelar Processamento */}
      <ConfirmBulkCancelModal
        isOpen={modals.confirmBulkCancel}
        onClose={() => closeModal('confirmBulkCancel')}
        filesInProgress={getBulkPendingFilesCount()}
        onConfirm={handleConfirmBulkCancel}
      />

      {/* ============= FIM DOS MODAIS DE GERAÃ‡ÃƒO EM MASSA ============= */}

      {/* Modal de ConfirmaÃ§Ã£o de ExclusÃ£o em Massa */}
      <DeleteAllModelsModal
        isOpen={modals.deleteAllModels}
        onClose={() => closeModal('deleteAllModels')}
        totalModels={modelLibrary.models.length}
        confirmText={modelLibrary.deleteAllConfirmText}
        setConfirmText={modelLibrary.setDeleteAllConfirmText}
        onConfirmDelete={deleteAllModels}
      />


      {/* Modal de ConfirmaÃ§Ã£o - Extrair Modelo */}
      <ExtractModelConfirmModal
        isOpen={modals.extractModelConfirm}
        onClose={() => closeModal('extractModelConfirm')}
        editingTopic={editingTopic}
        editorRef={editorRef}
        onConfirmExtract={extractModelFromDecisionText}
      />

      {/* Modal de Preview/EdiÃ§Ã£o - Modelo ExtraÃ­do */}
      <ExtractedModelPreviewModal
        isOpen={modals.extractedModelPreview}
        onClose={() => closeModal('extractedModelPreview')}
        extractedModel={modelLibrary.extractedModelPreview}
        setExtractedModel={modelLibrary.setExtractedModelPreview}
        onSave={saveExtractedModel}
        onCancel={cancelExtractedModel}
        sanitizeHTML={sanitizeHTML}
      />

      {/* v1.15.3: Modal de "Salvar como Novo Modelo" (reutiliza ExtractedModelPreviewModal) */}
      <ExtractedModelPreviewModal
        isOpen={modelPreview.saveAsNewData !== null}
        onClose={() => modelPreview.closeSaveAsNew()}
        extractedModel={modelPreview.saveAsNewData}
        setExtractedModel={(data) => modelPreview.setSaveAsNewData(data)}
        onSave={confirmSaveAsNew}
        onCancel={() => modelPreview.closeSaveAsNew()}
        sanitizeHTML={sanitizeHTML}
      />

      {/* v1.11.0: Modal de EdiÃ§Ã£o Global */}
      <GlobalEditorModal
        isOpen={modals.globalEditor}
        onClose={() => closeModal('globalEditor')}
        selectedTopics={selectedTopics}
        setSelectedTopics={setSelectedTopics}
        setExtractedTopics={setExtractedTopics}
        models={modelLibrary.models}
        findSuggestions={findSuggestions}
        sanitizeHTML={sanitizeHTML}
        showToast={showToast}
        fontSize={fontSize}
        spacing={spacing}
        setFontSize={setFontSize}
        setSpacing={setSpacing}
        editorTheme={appTheme}
        quillReady={quillReady}
        quillError={quillError}
        modelPreview={modelPreview}
        analyzedDocuments={analyzedDocuments}
        proofManager={proofManager}
        aiIntegration={aiIntegration}
        detectResultadoAutomatico={detectResultadoAutomatico}
        onSlashCommand={openSlashMenu}
        fileToBase64={storage.fileToBase64}
        openModal={openModal}
        closeModal={closeModal}
        useLocalAIForSuggestions={aiIntegration.aiSettings.useLocalAIForSuggestions}
        useLocalAIForJuris={aiIntegration.aiSettings.useLocalAIForJuris}
        jurisSemanticThreshold={aiIntegration.aiSettings.jurisSemanticThreshold}
        searchModelReady={searchModelReady}
        jurisEmbeddingsCount={jurisEmbeddingsCount}
        searchModelsBySimilarity={searchModelsBySimilarity}
        modelSemanticEnabled={aiIntegration.aiSettings.modelSemanticEnabled}
      />

      {/* Modal de Preview de Modelo (SugestÃµes) - GLOBAL (v1.12.2: movido para depois do GlobalEditorModal) */}
      {/* v1.15.2: Usa funÃ§Ã£o contextual se disponÃ­vel (ex: GlobalEditorModal) */}
      <ModelPreviewModal
        isOpen={modelPreview.isPreviewOpen}
        model={modelPreview.previewingModel}
        onInsert={modelPreview.contextualInsertFnRef?.current || insertModelContent}
        onClose={modelPreview.closePreview}
        sanitizeHTML={sanitizeHTML}
        showToast={showToast}
        // Props para Quick Edit
        isEditing={modelPreview.isEditing}
        editedContent={modelPreview.editedContent}
        onStartEditing={modelPreview.startEditing}
        onCancelEditing={modelPreview.cancelEditing}
        onSaveEdit={saveQuickEdit}
        onContentChange={modelPreview.setEditedContent}
        quillReady={quillReady}
        quillError={quillError}
        // Props para configuraÃ§Ãµes globais de editor
        fontSize={fontSize}
        spacing={spacing}
        editorTheme={appTheme}
        // Prop para exclusÃ£o de modelo
        onDelete={confirmDeleteModel}
        // Prop para favoritar modelo
        onToggleFavorite={toggleFavorite}
        // v1.15.3: Prop para "Salvar como Novo Modelo"
        onOpenSaveAsNew={modelPreview.openSaveAsNew}
      />

      {/* v1.15.3: Slash Command Menu - Acesso rÃ¡pido a modelos com / */}
      {/* v1.33.8: Adicionado suporte a busca semÃ¢ntica e tooltip preview */}
      <SlashCommandMenu
        isOpen={slashMenu.isOpen}
        position={slashMenu.position}
        models={modelLibrary.models}
        searchTerm={slashMenu.searchTerm}
        selectedIndex={slashMenu.selectedIndex}
        onSelect={selectModelFromSlash}
        onClose={() => closeSlashMenu(true)}
        onSearchChange={updateSlashSearchTerm}
        onNavigate={navigateSlashMenu}
        semanticAvailable={modelSemanticAvailable}
        searchModelsBySimilarity={searchModelsBySimilarity}
      />

      {/* Toast Notification */}
      {toast.show && (
        <div className="fixed top-4 left-4 z-[9999] animate-slide-in-right">
          <div className={`
            rounded-lg shadow-2xl border p-4 min-w-[320px] max-w-md
            ${toast.type === 'success' ? 'theme-toast-success' : ''}
            ${toast.type === 'error' ? 'theme-toast-error' : ''}
            ${toast.type === 'info' ? 'theme-toast-info' : ''}
            ${toast.type === 'warning' ? 'theme-toast-warning' : ''}
          `}>
            <div className="flex items-start gap-3">
              <div className="flex-shrink-0 text-2xl">
                {toast.type === 'success' && 'âœ…'}
                {toast.type === 'error' && 'âŒ'}
                {toast.type === 'info' && 'â„¹ï¸'}
                {toast.type === 'warning' && 'âš ï¸'}
              </div>
              <div className="flex-1">
                <p className="text-sm theme-text-primary whitespace-pre-line">{toast.message}</p>
              </div>
              <button
                onClick={() => setToast({ show: false, message: '', type: 'success' })}
                className="flex-shrink-0 text-white/60 hover-text-white transition-colors"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      )}

      {/* v1.4.6: Removido Mini-toolbar flutuante (76 linhas) */}
      {/* v1.4.8: Removido Toolbar Fixa no Topo (82 linhas) - nÃ£o mais necessÃ¡ria com editor de altura fixa */}

      {/* Modal: Adicionar Prova (Texto) */}
      <AddProofTextModal
        isOpen={modals.addProofText}
        onClose={() => closeModal('addProofText')}
        newProofData={proofManager.newProofTextData}
        setNewProofData={proofManager.setNewProofTextData}
        onAddProof={() => {
          if (proofManager.newProofTextData.text.trim()) {
            const anonConfig = aiIntegration?.aiSettings?.anonymization;
            const anonymizationEnabled = anonConfig?.enabled;

            // v1.21.3: Se anonimizaÃ§Ã£o ativa, abrir modal para confirmar nomes
            if (anonymizationEnabled) {
              proofManager.setPendingProofText({
                name: proofManager.newProofTextData.name.trim() || 'Prova (texto)',
                text: proofManager.newProofTextData.text.trim()
              });
              closeModal('addProofText');
              openModal('proofTextAnonymization');
            } else {
              // Salvar diretamente sem anonimizaÃ§Ã£o
              const id = Date.now() + Math.random();
              const name = proofManager.newProofTextData.name.trim() || 'Prova (texto)';
              proofManager.setProofTexts(prev => [...prev, {
                id,
                text: proofManager.newProofTextData.text.trim(),
                name,
                type: 'text',
                uploadDate: new Date().toISOString()
              }]);
              closeModal('addProofText');
              proofManager.setNewProofTextData({ name: '', text: '' });
            }
          }
        }}
      />

      {/* v1.21.3: Modal de Nomes para AnonimizaÃ§Ã£o de Prova de Texto */}
      <AnonymizationNamesModal
        isOpen={modals.proofTextAnonymization}
        onClose={() => {
          closeModal('proofTextAnonymization');
          proofManager.setPendingProofText(null);
          proofManager.setNewProofTextData({ name: '', text: '' });
        }}
        onConfirm={(nomes: string[]) => {
          if (proofManager.pendingProofText) {
            const anonConfig = aiIntegration?.aiSettings?.anonymization;
            // Persistir nomes para uso futuro
            aiIntegration.setAiSettings((prev: AISettings) => ({
              ...prev,
              anonymization: {
                ...prev.anonymization,
                nomesUsuario: nomes
              }
            }));
            // Anonimizar e salvar prova
            const pendingProof = proofManager.pendingProofText;
            if (!pendingProof) return;
            const id = Date.now() + Math.random();
            const anonText = anonymizeText(pendingProof.text, anonConfig, nomes);
            proofManager.setProofTexts((prev: ProofText[]) => [...prev, {
              id,
              text: anonText,
              name: pendingProof.name,
              type: 'text',
              uploadDate: new Date().toISOString()
            }]);
            closeModal('proofTextAnonymization');
            proofManager.setPendingProofText(null);
            proofManager.setNewProofTextData({ name: '', text: '' });
            showToast('âœ… Prova de texto adicionada com anonimizaÃ§Ã£o', 'success');
          }
        }}
        nomesTexto={anonymizationNamesText}
        setNomesTexto={setAnonymizationNamesText}
        nerEnabled={nerEnabled}
        detectingNames={detectingNames}
        onDetectNames={async () => {
          setDetectingNames(true);
          try { await detectarNomesAutomaticamente(proofManager.pendingProofText?.text, true); }
          catch { setDetectingNames(false); }
        }}
        onOpenAiSettings={() => { closeModal('proofTextAnonymization'); openModal('settings'); }}
      />

      {/* v1.21.5: Modal de Nomes para AnonimizaÃ§Ã£o de ExtraÃ§Ã£o de PDF */}
      <AnonymizationNamesModal
        isOpen={modals.proofExtractionAnonymization}
        onClose={() => {
          closeModal('proofExtractionAnonymization');
          proofManager.setPendingExtraction(null);
        }}
        onConfirm={(nomes: string[]) => {
          if (proofManager.pendingExtraction) {
            // Persistir nomes para uso futuro
            aiIntegration.setAiSettings((prev: AISettings) => ({
              ...prev,
              anonymization: {
                ...prev.anonymization,
                nomesUsuario: nomes
              }
            }));
            // Executar extraÃ§Ã£o com nomes confirmados
            proofManager.pendingExtraction?.executeExtraction?.(nomes);
            closeModal('proofExtractionAnonymization');
            proofManager.setPendingExtraction(null);
            showToast('ğŸ“ Extraindo texto com anonimizaÃ§Ã£o...', 'info');
          }
        }}
        nomesTexto={anonymizationNamesText}
        setNomesTexto={setAnonymizationNamesText}
        nerEnabled={nerEnabled}
        detectingNames={detectingNames}
        onDetectNames={async () => {
          // v1.36.40: Fix - usar extractTextFromPDFWithMode com modo selecionado (Tesseract, etc.)
          setDetectingNames(true);
          try {
            const proofId = proofManager.pendingExtraction?.proofId;
            const proof = proofManager.pendingExtraction?.proof as ProofFile | undefined;

            if (!proof || !proof.file) {
              showToast('Prova nÃ£o encontrada ou arquivo indisponÃ­vel', 'error');
              setDetectingNames(false);
              return;
            }

            // Usar o modo de extraÃ§Ã£o selecionado pelo usuÃ¡rio
            const userMode = proofManager.proofProcessingModes[proofId as string] || 'pdfjs';
            // Bloquear modos binÃ¡rios (anonimizaÃ§Ã£o sempre exige texto)
            const blockedModes = ['claude-vision', 'pdf-puro'];
            const selectedMode = blockedModes.includes(userMode) ? 'pdfjs' : userMode;

            // Extrair texto com o modo correto (PDF.js ou Tesseract)
            const extractedText = await documentServices.extractTextFromPDFWithMode(proof.file, selectedMode, null);

            if (extractedText && extractedText.trim().length > 50) {
              await detectarNomesAutomaticamente(extractedText, true);
            } else {
              showToast('PDF sem texto extraÃ­vel. Tente modo Tesseract OCR.', 'error');
              setDetectingNames(false);
            }
          } catch (err) {
            console.error('[NER] Erro ao extrair PDF para NER:', err);
            showToast('Erro ao extrair texto do PDF', 'error');
            setDetectingNames(false);
          }
        }}
        onOpenAiSettings={() => { closeModal('proofExtractionAnonymization'); openModal('settings'); }}
      />

      {/* v1.21.16: Modal de Preview de Texto ExtraÃ­do */}
      <TextPreviewModal
        isOpen={textPreview.isOpen}
        onClose={() => setTextPreview({ isOpen: false, title: '', text: '' })}
        title={textPreview.title}
        text={textPreview.text}
      />

      {/* Modal: SeleÃ§Ã£o de Tipo de AnÃ¡lise de Prova */}
      <ProofAnalysisModal
        isOpen={modals.proofAnalysis}
        onClose={() => {
          closeModal('proofAnalysis');
          proofManager.setProofToAnalyze(null);
          proofManager.setProofAnalysisCustomInstructions('');
          proofManager.setUseOnlyMiniRelatorios(false);
          proofManager.setIncludeLinkedTopicsInFree(false);
        }}
        proofToAnalyze={proofManager.proofToAnalyze}
        customInstructions={proofManager.proofAnalysisCustomInstructions}
        setCustomInstructions={proofManager.setProofAnalysisCustomInstructions}
        useOnlyMiniRelatorios={proofManager.useOnlyMiniRelatorios}
        setUseOnlyMiniRelatorios={proofManager.setUseOnlyMiniRelatorios}
        includeLinkedTopicsInFree={proofManager.includeLinkedTopicsInFree}
        setIncludeLinkedTopicsInFree={proofManager.setIncludeLinkedTopicsInFree}
        proofTopicLinks={proofManager.proofTopicLinks}
        editorTheme={editorTheme}
        onAnalyzeContextual={async () => {
          closeModal('proofAnalysis');
          if (proofManager.proofToAnalyze) {
            await analyzeProof(proofManager.proofToAnalyze, 'contextual', proofManager.proofAnalysisCustomInstructions, proofManager.useOnlyMiniRelatorios, false);
          }
          proofManager.setProofToAnalyze(null);
          proofManager.setProofAnalysisCustomInstructions('');
          proofManager.setUseOnlyMiniRelatorios(false);
          proofManager.setIncludeLinkedTopicsInFree(false);
        }}
        onAnalyzeFree={async () => {
          closeModal('proofAnalysis');
          if (proofManager.proofToAnalyze) {
            await analyzeProof(proofManager.proofToAnalyze, 'livre', proofManager.proofAnalysisCustomInstructions, false, proofManager.includeLinkedTopicsInFree);
          }
          proofManager.setProofToAnalyze(null);
          proofManager.setProofAnalysisCustomInstructions('');
          proofManager.setUseOnlyMiniRelatorios(false);
          proofManager.setIncludeLinkedTopicsInFree(false);
        }}
      />

      {/* Modal: Vincular Prova a TÃ³picos */}
      <LinkProofModal
        isOpen={modals.linkProof}
        onClose={() => {
          closeModal('linkProof');
          proofManager.setProofToLink(null);
        }}
        proofToLink={proofManager.proofToLink}
        extractedTopics={extractedTopics}
        proofTopicLinks={proofManager.proofTopicLinks}
        setProofTopicLinks={proofManager.setProofTopicLinks}
      />

      {/* Modal: Confirmar ExclusÃ£o de Prova */}
      <DeleteProofModal
        isOpen={modals.deleteProof}
        onClose={() => {
          closeModal('deleteProof');
          proofManager.setProofToDelete(null);
        }}
        proofToDelete={proofManager.proofToDelete}
        onConfirmDelete={async () => {
          const proofToDelete = proofManager.proofToDelete;
          if (!proofToDelete) return;

          // v1.36.32: Limpar IndexedDB se for PDF
          if (proofToDelete.isPdf || ('type' in proofToDelete && proofToDelete.type === 'pdf')) {
            try {
              await removePdfFromIndexedDB(`proof-${proofToDelete.id}`);
            } catch (err) { }
          }

          // v1.36.32: Usar handler existente do hook (tipagem correta, limpa todos os estados)
          proofManager.handleDeleteProof(proofToDelete);

          closeModal('deleteProof');
          proofManager.setProofToDelete(null);
        }}
      />

      {/* Ãcone de Auto-Save Discreto */}
      {storage.showAutoSaveIndicator && (
        <div className="fixed bottom-4 right-4 z-[9999] animate-in fade-in duration-300">
          <div className="theme-autosave p-2 rounded-full shadow-lg border">
            <svg className="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
          </div>
        </div>
      )}

      {/* v1.9.5: Overlay para abas bloqueadas (nÃ£o-primÃ¡rias) */}
      <LockedTabOverlay
        isPrimaryTab={primaryTabLock.isPrimaryTab}
        activeTab={activeTab}
        setActiveTab={setActiveTab}
      />
    </div>
    </>
  );
};

// ğŸ”’ DOCUMENTAÃ‡ÃƒO DE SEGURANÃ‡A - DOMPURIFY
/*
SANITIZAÃ‡ÃƒO DE HTML IMPLEMENTADA COM DOMPURIFY

âœ… ImplementaÃ§Ã£o concluÃ­da em: 2025-11-12
ğŸ“¦ Biblioteca: DOMPurify 3.0.6 (carregada via CDN)
ğŸ¯ Objetivo: Prevenir ataques XSS (Cross-Site Scripting)

LOCAIS PROTEGIDOS:
1. âœ… Editores de tÃ³picos (editorRef, relatorioRef) - Linhas 884-885
2. âœ… Editor de modelos (modelEditorRef) - Linha 1218
3. âœ… RegeneraÃ§Ã£o de relatÃ³rios - Linha 1554
4. âœ… InserÃ§Ã£o de texto gerado por IA (decisÃµes) - Linhas 2580-2586
5. âœ… InserÃ§Ã£o de texto gerado por IA (modelos) - Linhas 2716-2722
6. âœ… ConversÃ£o HTML para texto plano - Linha 2781
7. âœ… InserÃ§Ã£o de conteÃºdo de modelos - Linha 5107
8. âœ… Mensagens de feedback com interpolaÃ§Ã£o - Linhas 5315-5317

CONFIGURAÃ‡ÃƒO DE SANITIZAÃ‡ÃƒO (linha 503-522):
- Tags permitidas: p, br, div, span, strong, b, em, i, u, ul, ol, li, h1-h6
- Atributos permitidos: class, id, style (limitado)
- Estilos permitidos: font-weight, font-style, text-decoration
- Remove scripts, eventos onclick, e outros vetores de ataque

CASOS NÃƒO SANITIZADOS (seguros):
- innerHTML = '' (limpeza de editores) - Linhas 1142, 7517, 7532, 8014
- innerHTML com texto estÃ¡tico (mensagens) - Linhas 1188, 5319

TESTES SUGERIDOS:
1. Tentar inserir <script>alert('XSS')</script> em editor
2. Tentar inserir <img src=x onerror=alert('XSS')>
3. Verificar que formataÃ§Ã£o bÃ¡sica (negrito, itÃ¡lico) continua funcionando
4. Confirmar que links e estilos maliciosos sÃ£o removidos

COMPORTAMENTO EM CASO DE FALHA:
- Se DOMPurify nÃ£o carregar: retorna string vazia (seguro por padrÃ£o)
- Console mostra avisos quando DOMPurify nÃ£o estÃ¡ pronto
- Loading assÃ­ncrono nÃ£o bloqueia inicializaÃ§Ã£o da aplicaÃ§Ã£o

DEPENDÃŠNCIAS:
- CDN: https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js
- Carregamento: useEffect na linha 250-276
- Estado: domPurifyReady (linha 247)
*/

// ğŸ¨ CSS GLOBAL - HOVER EFFECTS (v1.9.13 - Theme-aware)
// SoluÃ§Ã£o: CSS :hover em vez de onMouseEnter/onMouseLeave (elimina re-renders)
const GlobalHoverStyles = () => (
  <style>{`
    /* SPINNER ANIMATION */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-spin { animation: spin 1s linear infinite; }

    /* TOGGLE SWITCH */
    .toggle-switch {
      position: relative;
      width: 36px;
      height: 20px;
      background-color: #4b5563;
      border-radius: 9999px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .toggle-switch.active {
      background-color: #2563eb;
    }
    .toggle-switch .toggle-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background-color: white;
      border-radius: 9999px;
      transition: transform 0.2s;
    }
    .toggle-switch.active .toggle-knob {
      transform: translateX(16px);
    }

    /* HOVER CLASSES - Theme-aware */
    .hover-slate-600:hover:not(:disabled) { background-color: var(--hover-slate-600) !important; }

    /* Accent colors (cores fixas) */
    .hover-blue-700:hover:not(:disabled) { background-color: #1d4ed8 !important; }
    .hover-blue-500:hover:not(:disabled) { background-color: #3b82f6 !important; }
    .hover-purple-700:hover:not(:disabled) { background-color: #7e22ce !important; }
    .hover-green-700:hover:not(:disabled) { background-color: #15803d !important; }
    .hover-red-700:hover:not(:disabled) { background-color: #b91c1c !important; }
    .hover-amber-700:hover:not(:disabled) { background-color: #b45309 !important; }
    .hover-yellow-600:hover:not(:disabled) { background-color: #ca8a04 !important; }
    /* Slate hovers - theme-aware */
    .hover-slate-700:hover:not(:disabled) { background-color: var(--hover-slate-700) !important; }
    .hover-slate-800:hover:not(:disabled) { background-color: var(--hover-slate-800) !important; }
    .hover-orange-700:hover:not(:disabled) { background-color: #c2410c !important; }
    .hover-slate-500:hover:not(:disabled) { background-color: var(--hover-slate-500) !important; }

    /* BACKGROUND HOVERS */
    .hover-red-alpha-20:hover:not(:disabled) { background-color: rgba(239, 68, 68, 0.2) !important; }
    .hover-green-900-alpha-40:hover:not(:disabled) { background-color: rgba(20, 83, 45, 0.4) !important; }

    /* TEXT COLOR HOVERS */
    .hover-text-red-300:hover:not(:disabled) { color: #fca5a5 !important; }
    .hover-text-red-400:hover:not(:disabled) { color: #f87171 !important; }
    .error-close-btn:hover { color: #fca5a5 !important; background-color: rgba(239, 68, 68, 0.2) !important; }
    .hover-theme-text-secondary:hover:not(:disabled) { color: #e2e8f0 !important; }
    .hover-theme-text-tertiary:hover:not(:disabled) { color: #cbd5e1 !important; }
    .hover-text-green-300:hover:not(:disabled) { color: #86efac !important; }
    .hover-text-white:hover:not(:disabled) { color: #ffffff !important; }

    /* v1.20.0: Quick Prompt Buttons */
    .hover-quick-prompt:hover:not(:disabled) {
      background-color: #dbeafe !important;
      border-color: #60a5fa !important;
    }
    .dark .hover-quick-prompt:hover:not(:disabled) {
      background-color: rgba(59, 130, 246, 0.2) !important;
      border-color: #3b82f6 !important;
    }

    /* BACKGROUND HOVERS - Theme-aware */
    .hover-theme-bg-secondary:hover:not(:disabled) { background-color: var(--bg-secondary) !important; }
    .hover-theme-bg-tertiary:hover:not(:disabled) { background-color: var(--bg-tertiary) !important; }

    /* Tab inactive hover - alto contraste */
    .hover-tab-inactive {
      background-color: var(--bg-secondary);
      transition: background-color 0.2s ease;
    }
    .hover-tab-inactive:hover:not(:disabled) {
      background-color: var(--bg-tertiary) !important;
    }

    /* BORDER HOVERS */
    .hover-theme-border:hover { border-color: var(--hover-slate-500) !important; }
    .hover-border-blue-500:hover { border-color: #3b82f6 !important; }
    .hover-border-purple-alpha-30:hover { border-color: rgba(168, 85, 247, 0.3) !important; }

    /* Input com hover - theme-aware */
    .hover-input-slate:hover {
      background-color: var(--bg-hover) !important;
    }

    /* Transform scale hover */
    .hover-scale:hover {
      transform: scale(1.05) !important;
    }

    /* Hover com bases nÃ£o-transparentes */
    .hover-green-700-from-600:hover {
      background-color: #047857 !important;
    }
    .hover-green-600-from-700:hover {
      background-color: #16a34a !important;
    }
    .hover-blue-600-from-700:hover {
      background-color: #2563eb !important;
    }
    .hover-red-600-from-700:hover {
      background-color: #dc2626 !important;
    }
    .hover-amber-700-from-600:hover {
      background-color: #b45309 !important;
    }
    .hover-purple-700-from-600:hover {
      background-color: #7e22ce !important;
    }
    .hover-blue-alpha-3-from-2:hover:not(:disabled) {
      background-color: rgba(37, 99, 235, 0.3) !important;
    }
    .hover-purple-alpha-3-from-2:hover {
      background-color: rgba(147, 51, 234, 0.3) !important;
    }
    .hover-blue-700-from-600:hover {
      background-color: #1d4ed8 !important;
    }
    .hover-slate-600-from-700:hover {
      background-color: var(--hover-slate-600) !important;
    }

    /* BACKGROUND COLORS - Cores SÃ³lidas Adicionais */
    .hover-pink-700:hover:not(:disabled) { background-color: #be185d !important; }
    .hover-blue-alpha-10:hover:not(:disabled) { background-color: rgba(59, 130, 246, 0.1) !important; }
    .hover-slate-alpha-30:hover:not(:disabled) { background-color: rgba(71, 85, 105, 0.3) !important; }
    .hover-purple-400:hover:not(:disabled) { color: #c084fc !important; }
    .hover-yellow-alpha:hover:not(:disabled) { background-color: rgba(234, 179, 8, 0.15) !important; }
    .hover-green-500:hover:not(:disabled) { background-color: #22c55e !important; }

    /* GRADIENTS - Linear Gradient Hovers */
    .hover-gradient-purple-pink:hover:not(:disabled) {
      background-image: linear-gradient(to right, #7e22ce, #db2777) !important;
    }
    .hover-gradient-purple-blue:hover:not(:disabled) {
      background-image: linear-gradient(to right, #7e22ce, #1d4ed8) !important;
    }
    .hover-gradient-blue-purple:hover:not(:disabled) {
      background-image: linear-gradient(to right, #1d4ed8, #7e22ce) !important;
    }
    .hover-gradient-green:hover:not(:disabled) {
      background-image: linear-gradient(to right, #15803d, #047857) !important;
    }

    /* BORDERS - Additional Border Colors */
    .hover-border-purple-500:hover { border-color: #a855f7 !important; }
    .hover-border-purple-alpha-50:hover { border-color: rgba(168, 85, 247, 0.5) !important; }

    /* TRANSFORMS - Scale Effects */
    .hover-scale-125:hover:not(:disabled) {
      transform: scale(1.25) !important;
    }

    /* NESTED HOVERS - Parent:hover Child Effect */
    .hover-label-text-blue:hover span {
      color: #bfdbfe !important;
    }

    .hover-button-contextual {
      background-color: rgba(51, 65, 85, 0.5);
      border-color: #475569;
      transition: all 0.3s ease;
    }
    .hover-button-contextual:hover {
      background-color: rgba(147, 51, 234, 0.2) !important;
      border-color: #a855f7 !important;
    }
    .hover-button-contextual:hover .icon-wrapper {
      background-color: rgba(147, 51, 234, 0.3) !important;
    }

    /* v1.10.9: BotÃ£o AnÃ¡lise Livre */
    .hover-button-free {
      background-color: rgba(51, 65, 85, 0.5);
      border-color: #475569;
      transition: all 0.3s ease;
    }
    .hover-button-free:hover {
      background-color: rgba(34, 197, 94, 0.2) !important;
      border-color: #22c55e !important;
    }
    .hover-button-free:hover .icon-wrapper {
      background-color: rgba(34, 197, 94, 0.3) !important;
    }

    /* v1.21.16: Tema claro - BotÃ£o AnÃ¡lise Contextual */
    .hover-button-contextual-light {
      background-color: rgba(147, 51, 234, 0.08);
      border: 1px solid rgba(147, 51, 234, 0.2);
      transition: all 0.3s ease;
    }
    .hover-button-contextual-light:hover {
      background-color: rgba(147, 51, 234, 0.15) !important;
      border-color: #a855f7 !important;
    }
    .hover-button-contextual-light:hover .icon-wrapper {
      background-color: rgba(147, 51, 234, 0.25) !important;
    }

    /* v1.21.16: Tema claro - BotÃ£o AnÃ¡lise Livre */
    .hover-button-free-light {
      background-color: rgba(34, 197, 94, 0.08);
      border: 1px solid rgba(34, 197, 94, 0.2);
      transition: all 0.3s ease;
    }
    .hover-button-free-light:hover {
      background-color: rgba(34, 197, 94, 0.15) !important;
      border-color: #22c55e !important;
    }
    .hover-button-free-light:hover .icon-wrapper {
      background-color: rgba(34, 197, 94, 0.25) !important;
    }

    /* v1.10.9: Label hover para checkbox purple */
    .hover-label-text-purple:hover span {
      color: #a855f7 !important;
    }

    /* v1.10.10: Label hover para checkbox green */
    .hover-label-text-green:hover span {
      color: #22c55e !important;
    }

    .hover-category-select {
      background-color: var(--hover-slate-600);
      transition: background-color 0.3s ease;
    }
    .hover-category-select:hover:not(:disabled) {
      background-color: var(--hover-slate-500) !important;
    }

    .hover-delete-topic {
      color: #f87171;
      transition: all 0.3s ease;
    }
    .hover-delete-topic:hover:not(:disabled) {
      color: #fca5a5 !important;
      background-color: rgba(127, 29, 29, 0.2) !important;
    }

    .hover-delete-proof {
      transition: background-color 0.3s ease;
    }
    .hover-delete-proof:hover:not(:disabled) {
      background-color: rgba(239, 68, 68, 0.2) !important;
    }

    .hover-proof-panel {
      background-color: rgba(20, 83, 45, 0.3);
      transition: background-color 0.3s ease;
    }
    .hover-proof-panel:hover {
      background-color: rgba(20, 83, 45, 0.4) !important;
    }

    .hover-delete-all {
      color: #94a3b8;
      transition: all 0.3s ease;
    }
    .hover-delete-all:hover:not(:disabled) {
      color: #f87171 !important;
      background-color: rgba(127, 29, 29, 0.2) !important;
    }

    /* BACKGROUNDS - From Transparent (theme-aware) */
    .hover-slate-600-from-transparent:hover:not(:disabled) {
      background-color: var(--hover-slate-600) !important;
    }
    .hover-slate-700-from-transparent:hover:not(:disabled) {
      background-color: var(--hover-slate-700) !important;
    }

    /* BORDERS with Background Combo */
    .hover-border-blue-from-slate {
      transition: all 0.3s ease;
    }
    .hover-border-blue-from-slate:hover {
      border-color: #3b82f6 !important;
    }

    /* TEXT COLORS */
    .hover-text-blue-300:hover:not(:disabled) {
      color: #93c5fd !important;
    }
    .hover-text-purple-400:hover:not(:disabled) {
      color: #c084fc !important;
    }

    /* COMPLEX NESTED - Specific Components */
    .hover-pagination-prev:hover:not(:disabled) {
      background-color: var(--hover-slate-600) !important;
    }
    .hover-pagination-next:hover:not(:disabled) {
      background-color: var(--hover-slate-600) !important;
    }

    /* RED DELETE BUTTONS - From red-600 to red-700 */
    .hover-red-700-from-600 {
      background-color: #dc2626;
      transition: background-color 0.3s ease;
    }
    .hover-red-700-from-600:hover:not(:disabled) {
      background-color: #b91c1c !important;
    }

    /* BORDER COLORS - Model Cards (theme-aware) */
    .hover-theme-border-from-600 {
      border-color: var(--hover-slate-600);
      transition: border-color 0.3s ease;
    }
    .hover-theme-border-from-600:hover {
      border-color: var(--hover-slate-500) !important;
    }

    /* TEXT COLORS - Proof Elements */
    .hover-text-blue-400-from-300 {
      color: #60a5fa;
      transition: color 0.3s ease;
    }
    .hover-text-blue-400-from-300:hover:not(:disabled) {
      color: #93c5fd !important;
    }

    .hover-text-red-400-from-300 {
      color: #f87171;
      transition: color 0.3s ease;
    }
    .hover-text-red-400-from-300:hover:not(:disabled) {
      color: #fca5a5 !important;
    }

    .hover-text-purple-400-from-400 {
      color: #c084fc;
      transition: color 0.3s ease;
    }
    .hover-text-purple-400-from-400:hover:not(:disabled) {
      color: #e9d5ff !important;
    }

    .hover-text-white-from-slate {
      color: #94a3b8;
      transition: color 0.3s ease;
    }
    .hover-text-white-from-slate:hover:not(:disabled) {
      color: #ffffff !important;
    }

    /* SLATE BACKGROUNDS (theme-aware) */
    .hover-slate-700-from-600 {
      background-color: var(--hover-slate-600);
      transition: background-color 0.3s ease;
    }
    .hover-slate-700-from-600:hover:not(:disabled) {
      background-color: var(--hover-slate-700) !important;
    }

    /* ALPHA BACKGROUNDS - From Transparent */
    .hover-blue-alpha-10-from-transparent {
      background-color: transparent;
      transition: all 0.2s ease;
    }
    .hover-blue-alpha-10-from-transparent:hover:not(:disabled) {
      background-color: rgba(59, 130, 246, 0.1) !important;
    }

    .hover-slate-alpha-30-from-transparent {
      background-color: transparent;
      transition: background-color 0.3s ease;
    }
    .hover-slate-alpha-30-from-transparent:hover:not(:disabled) {
      background-color: var(--bg-hover) !important;
      opacity: 0.3;
    }

    /* SuggestionCard insert button */
    .hover-suggestion-insert {
      background-color: #2563eb;
      transition: all 0.3s ease;
    }
    .hover-suggestion-insert:hover:not(:disabled) {
      background-color: #3b82f6 !important;
      transform: scale(1.02) !important;
    }

    /* 2. TopicCard drag area - bg rgba with subtle change */
    .hover-topic-drag-area {
      background-color: rgba(37, 99, 235, 0.1);
      transition: background-color 0.2s ease;
    }
    .hover-topic-drag-area:hover {
      background-color: rgba(37, 99, 235, 0.15) !important;
    }

    /* 3. Merge confirm button - green bg + scale */
    .hover-merge-confirm-btn {
      background-color: #059669;
      transition: all 0.3s ease;
    }
    .hover-merge-confirm-btn:hover:not(:disabled) {
      background-color: #10b981 !important;
      transform: scale(1.05) !important;
    }

    /* 4. Merge cancel button - red bg + scale */
    .hover-merge-cancel-btn {
      background-color: #dc2626;
      transition: all 0.3s ease;
    }
    .hover-merge-cancel-btn:hover:not(:disabled) {
      background-color: #ef4444 !important;
      transform: scale(1.05) !important;
    }

    /* 5. Icon hover blue - bg alpha + scale 1.1 */
    .hover-icon-blue-scale {
      background-color: transparent;
      transition: all 0.3s ease;
    }
    .hover-icon-blue-scale:hover:not(:disabled) {
      background-color: rgba(59, 130, 246, 0.3) !important;
      transform: scale(1.1) !important;
    }

    /* 6. Icon hover green - bg alpha + scale 1.1 */
    .hover-icon-green-scale {
      background-color: transparent;
      transition: all 0.3s ease;
    }
    .hover-icon-green-scale:hover:not(:disabled) {
      background-color: rgba(34, 197, 94, 0.3) !important;
      transform: scale(1.1) !important;
    }

    /* 7. Icon hover red - bg alpha + scale 1.1 */
    .hover-icon-red-scale {
      background-color: transparent;
      transition: all 0.3s ease;
    }
    .hover-icon-red-scale:hover:not(:disabled) {
      background-color: rgba(239, 68, 68, 0.3) !important;
      transform: scale(1.1) !important;
    }

    .hover-bg-red-alpha {
      transition: background-color 0.3s ease;
    }
    .hover-bg-red-alpha:hover:not(:disabled) {
      background-color: rgba(239, 68, 68, 0.2) !important;
    }

    /* 8. Bulk upload drop area - border + bg combo */
    .hover-bulk-upload-area {
      border-color: #475569;
      background-color: transparent;
      transition: all 0.3s ease;
    }
    .hover-bulk-upload-area:hover {
      border-color: #a855f7 !important;
      background-color: rgba(51, 65, 85, 0.3) !important;
    }

    /* 9. Warning button (yellow) - bg + scale */
    .hover-warning-yellow-btn {
      background-color: #eab308;
      transition: all 0.3s ease;
    }
    .hover-warning-yellow-btn:hover:not(:disabled) {
      background-color: #facc15 !important;
      transform: scale(1.05) !important;
    }

    /* AnimaÃ§Ã£o pulse */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.05);
      }
    }

    /* Classes para hovers simples */
    .hover-slate-600-from-slate-500 {
      background-color: #64748b;
      transition: background-color 0.3s ease;
    }
    .hover-slate-600-from-slate-500:hover:not(:disabled) {
      background-color: #475569 !important;
    }

    .hover-orange-700-from-600 {
      background-color: #ea580c;
      transition: background-color 0.3s ease;
    }
    .hover-orange-700-from-600:hover:not(:disabled) {
      background-color: #c2410c !important;
    }

    /* FASE 4-5: Classes para gradientes com hover mais escuro */
    .hover-gradient-purple-pink-darker {
      background-image: linear-gradient(to right, #9333ea, #ec4899);
      transition: background-image 0.3s ease;
    }
    .hover-gradient-purple-pink-darker:hover:not(:disabled) {
      background-image: linear-gradient(to right, #7e22ce, #db2777) !important;
    }

    .hover-gradient-purple-blue-darker {
      background-image: linear-gradient(to right, #9333ea, #2563eb);
      transition: background-image 0.3s ease;
    }
    .hover-gradient-purple-blue-darker:hover:not(:disabled) {
      background-image: linear-gradient(to right, #7e22ce, #1d4ed8) !important;
    }

    /* FASE 6: Classes para botÃµes condicionais */
    .hover-extract-model {
      background-color: #db2777;
      transition: background-color 0.3s ease;
    }
    .hover-extract-model:hover:not(:disabled) {
      background-color: #be185d !important;
    }
    .hover-extract-model.disabled {
      background-color: #9ca3af !important;
      cursor: not-allowed;
    }

    .hover-regenerate-btn {
      background-color: #9333ea;
      transition: background-color 0.3s ease;
    }
    .hover-regenerate-btn:hover:not(:disabled) {
      background-color: #7e22ce !important;
    }
    .hover-regenerate-btn.disabled {
      background-color: #6b7280 !important;
      cursor: not-allowed;
    }

    /* FASE 9: Classes para paginaÃ§Ã£o (theme-aware) */
    .hover-pagination-btn {
      background-color: var(--hover-slate-700);
      transition: background-color 0.3s ease;
    }
    .hover-pagination-btn:hover:not(:disabled) {
      background-color: var(--hover-slate-600) !important;
    }

    .hover-pagination-page {
      transition: background-color 0.3s ease;
    }
    .hover-pagination-page:hover:not([data-active]) {
      background-color: var(--hover-slate-600) !important;
    }

    /* ModelPreviewModal - Performance Otimizado */
    .model-preview-content {
      color: var(--text-tertiary);
      line-height: 1.75;
      font-size: 1rem;
      user-select: text;
      -webkit-user-select: text;
    }
    .model-preview-content p {
      margin-bottom: 1em;
      color: var(--text-tertiary);
    }
    /* SeleÃ§Ã£o otimizada - cor sÃ³lida sem transparÃªncia */
    .model-preview-content ::selection {
      background-color: var(--selection-bg);
      color: var(--selection-text);
    }
    .model-preview-content ::-moz-selection {
      background-color: var(--selection-bg);
      color: var(--selection-text);
    }
    .model-preview-content strong {
      font-weight: 600;
      color: var(--text-primary);
    }
    .model-preview-content em {
      font-style: italic;
    }
    .model-preview-content ul,
    .model-preview-content ol {
      margin-left: 1.5em;
      margin-bottom: 1em;
      padding-left: 0.5em;
    }
    .model-preview-content li {
      margin-bottom: 0.5em;
      color: var(--text-tertiary);
    }
    .model-preview-content h1,
    .model-preview-content h2,
    .model-preview-content h3,
    .model-preview-content h4 {
      font-weight: 700;
      color: var(--text-primary);
      margin-top: 1.5em;
      margin-bottom: 0.75em;
      line-height: 1.3;
    }
    .model-preview-content h1 { font-size: 1.875rem; }
    .model-preview-content h2 { font-size: 1.5rem; }
    .model-preview-content h3 { font-size: 1.25rem; }
    .model-preview-content h4 { font-size: 1.125rem; }
    .model-preview-content blockquote {
      margin: 1.5em 0;
      padding-left: 1em;
      border-left: 4px solid var(--border-primary);
      color: var(--text-muted);
      font-style: italic;
    }

    /* GLOBAL EDITOR */
    .hover-cyan-700-from-600:hover:not(:disabled) {
      background-color: #0e7490 !important;
    }

    /* SeÃ§Ãµes do Editor Global */
    .global-section {
      margin: 1.5rem 0;
      border-radius: 0.5rem;
      border: 1px solid var(--border-secondary);
      background-color: var(--bg-secondary);
    }

    .global-section:first-child {
      margin-top: 0;
    }

    .section-header {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), transparent);
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-secondary);
      border-radius: 0.5rem 0.5rem 0 0;
      user-select: none;
      pointer-events: none;
    }

    .section-header[contenteditable="false"] {
      cursor: default;
    }

    .section-title {
      font-weight: 700;
      font-size: 1rem;
      color: #60a5fa;
    }

    .section-category {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-left: 0.5rem;
    }

    .section-content {
      padding: 1rem;
      min-height: 80px;
    }

    .section-content:focus {
      outline: none;
    }

    .subsection {
      margin: 0.75rem 0;
      padding-left: 0.5rem;
      border-left: 3px solid var(--border-secondary);
    }

    .subsection-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
      user-select: none;
      pointer-events: none;
    }

    .subsection-label[contenteditable="false"] {
      cursor: default;
    }

    /* Container do editor global (v1.11.2 - altura 100%) */
    .global-editor-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .global-editor-container .ql-toolbar {
      flex-shrink: 0;
    }

    .global-editor-container .ql-container {
      flex: 1;
      overflow-y: auto;
      min-height: 0; /* Importante para flexbox */
    }

    .global-editor-container .ql-editor {
      min-height: 100%;
    }

    /* v1.12.1: FieldEditor - Fix dupla scrollbar */
    .field-editor-content .ql-container {
      border: none !important;
    }

    .field-editor-content .ql-editor {
      max-height: 400px;
      overflow-y: auto;
      padding: 0.75rem;
    }

    .field-editor-content .ql-editor:focus {
      outline: none;
    }

  `}</style>
);

// ğŸ¨ THEME STYLES - CSS Variables para Tema Claro/Escuro
const ThemeStyles = () => (
  <style>{`
    /* DARK THEME (Default) */
    :root {

      /* Backgrounds */
      --bg-app: #0f172a;
      --bg-primary: #1e293b;
      --bg-secondary: #334155;
      --bg-tertiary: #475569;
      --bg-input: #334155;
      --bg-hover: #475569;
      --bg-card: rgba(51, 65, 85, 0.3);
      --bg-card-solid: #334155;

      /* Text */
      --text-primary: #ffffff;
      --text-secondary: #e2e8f0;
      --text-tertiary: #cbd5e1;
      --text-muted: #94a3b8;
      --text-disabled: #64748b;

      /* Borders */
      --border-primary: #475569;
      --border-secondary: #334155;
      --border-input: #475569;

      /* Modal/Overlay */
      --overlay-bg: rgba(0, 0, 0, 0.8);
      --modal-bg: #1e293b;
      --modal-border: #334155;
      --modal-glow: 0 0 40px rgba(139, 92, 246, 0.15), 0 0 80px rgba(59, 130, 246, 0.1);

      /* Gradients */
      --gradient-app-from: #0f172a;
      --gradient-app-via: #1e293b;
      --gradient-app-to: #0f172a;

      /* Hover state colors (for GlobalHoverStyles) */
      --hover-slate-500: #64748b;
      --hover-slate-600: #475569;
      --hover-slate-700: #334155;
      --hover-slate-800: #1e293b;

      /* Semi-transparent backgrounds */
      --bg-app-50: rgba(15, 23, 42, 0.5);
      --bg-primary-50: rgba(30, 41, 59, 0.5);
      --bg-secondary-50: rgba(51, 65, 85, 0.5);
      --bg-secondary-30: rgba(51, 65, 85, 0.3);
      --bg-tertiary-50: rgba(71, 85, 105, 0.5);
      --bg-tertiary-30: rgba(71, 85, 105, 0.3);

      /* Accent Colors - Dark Theme */
      --accent-amber: #fbbf24;
      --accent-amber-muted: #fcd34d;
      --accent-blue: #60a5fa;
      --accent-blue-muted: #93c5fd;
      --accent-purple: #c084fc;
      --accent-green: #4ade80;
      --accent-red: #f87171;

      /* Accent Backgrounds - Dark Theme */
      --accent-amber-bg: rgba(251, 191, 36, 0.15);
      --accent-blue-bg: rgba(96, 165, 250, 0.15);
      --accent-purple-bg: rgba(192, 132, 252, 0.15);
      --accent-green-bg: rgba(74, 222, 128, 0.15);
      --accent-red-bg: rgba(248, 113, 113, 0.15);

      /* Result Dropdown Colors - Dark Theme (light text on dark bg) */
      --result-green: #d1fae5;
      --result-red: #fee2e2;
      --result-amber: #fef3c7;
      --result-muted: #94a3b8;

      /* Special */
      --shadow-color: rgba(0, 0, 0, 0.5);
      --selection-bg: #3b82f6;
      --selection-text: #ffffff;
    }

    /* LIGHT THEME */
    [data-theme="light"] {
      /* Backgrounds */
      --bg-app: #f5f3ef;
      --bg-primary: #fefcf3;
      --bg-secondary: #e8e6e1;
      --bg-tertiary: #d4d2cd;
      --bg-input: #fefcf3;
      --bg-hover: #d4d2cd;
      --bg-card: rgba(254, 252, 243, 0.9);
      --bg-card-solid: #fefcf3;

      /* Text - Stone (warm gray) */
      --text-primary: #1c1917;
      --text-secondary: #292524;
      --text-tertiary: #44403c;
      --text-muted: #78716c;
      --text-disabled: #a8a29e;

      /* Borders - Stone (warm gray) */
      --border-primary: #a8a29e;
      --border-secondary: #d6d3d1;
      --border-input: #a8a29e;

      /* Modal/Overlay */
      --overlay-bg: rgba(0, 0, 0, 0.5);
      --modal-bg: #fefcf3;
      --modal-border: #d4d2cd;
      --modal-glow: 0 0 30px rgba(0, 0, 0, 0.1), 0 0 60px rgba(0, 0, 0, 0.05);

      /* Gradients */
      --gradient-app-from: #f5f3ef;
      --gradient-app-via: #fefcf3;
      --gradient-app-to: #f5f3ef;

      /* Hover state colors - Stone (warm gray) */
      --hover-slate-500: #78716c;
      --hover-slate-600: #a8a29e;
      --hover-slate-700: #d6d3d1;
      --hover-slate-800: #e7e5e3;

      /* Semi-transparent backgrounds - Stone (warm gray) */
      --bg-app-50: rgba(245, 243, 239, 0.5);
      --bg-primary-50: rgba(254, 252, 243, 0.5);
      --bg-secondary-50: rgba(214, 211, 209, 0.5);
      --bg-secondary-30: rgba(214, 211, 209, 0.3);
      --bg-tertiary-50: rgba(168, 162, 158, 0.5);
      --bg-tertiary-30: rgba(168, 162, 158, 0.3);

      /* Accent Colors - Light Theme (DARKER for contrast) */
      --accent-amber: #b45309;
      --accent-amber-muted: #d97706;
      --accent-blue: #1d4ed8;
      --accent-blue-muted: #2563eb;
      --accent-purple: #7c3aed;
      --accent-green: #15803d;
      --accent-red: #b91c1c;

      /* Accent Backgrounds - Light Theme (more visible) */
      --accent-amber-bg: rgba(251, 191, 36, 0.25);
      --accent-blue-bg: rgba(96, 165, 250, 0.25);
      --accent-purple-bg: rgba(192, 132, 252, 0.25);
      --accent-green-bg: rgba(74, 222, 128, 0.25);
      --accent-red-bg: rgba(248, 113, 113, 0.25);

      /* Result Dropdown Colors - Light Theme (DARKER for contrast) */
      --result-green: #047857;
      --result-red: #b91c1c;
      --result-amber: #b45309;
      --result-muted: #475569;

      /* Special */
      --shadow-color: rgba(0, 0, 0, 0.1);
      --selection-bg: #3b82f6;
      --selection-text: #ffffff;
    }

    /* UTILITY CLASSES - Backgrounds */
    .theme-bg-app { background-color: var(--bg-app); }
    .theme-bg-primary { background-color: var(--bg-primary); }
    .theme-bg-secondary { background-color: var(--bg-secondary); }
    .theme-bg-tertiary { background-color: var(--bg-tertiary); }
    .theme-bg-input { background-color: var(--bg-input); }
    .theme-bg-card { background-color: var(--bg-card); }
    .theme-bg-card-solid { background-color: var(--bg-card-solid); }
    .theme-bg-modal { background-color: var(--modal-bg); }
    .theme-bg-overlay { background-color: var(--overlay-bg); }
    .theme-bg-app-50 { background-color: var(--bg-app-50); }
    .theme-bg-primary-50 { background-color: var(--bg-primary-50); }
    .theme-bg-secondary-50 { background-color: var(--bg-secondary-50); }
    .theme-bg-secondary-30 { background-color: var(--bg-secondary-30); }
    .theme-bg-tertiary-50 { background-color: var(--bg-tertiary-50); }
    .theme-bg-tertiary-30 { background-color: var(--bg-tertiary-30); }

    /* Text */
    .theme-text-primary { color: var(--text-primary); }
    .theme-text-secondary { color: var(--text-secondary); }
    .theme-text-tertiary { color: var(--text-tertiary); }
    .theme-text-muted { color: var(--text-muted); }
    .theme-text-disabled { color: var(--text-disabled); }

    /* Accent Text (theme-aware) */
    .theme-text-amber { color: var(--accent-amber); }
    .theme-text-amber-muted { color: var(--accent-amber-muted); }
    .theme-text-blue { color: var(--accent-blue); }
    .theme-text-blue-muted { color: var(--accent-blue-muted); }
    .theme-text-purple { color: var(--accent-purple); }
    .theme-text-green { color: var(--accent-green); }
    .theme-text-red { color: var(--accent-red); }

    /* Accent Backgrounds (theme-aware) */
    .theme-bg-amber-accent { background-color: var(--accent-amber-bg); }
    .theme-bg-blue-accent { background-color: var(--accent-blue-bg); }
    .theme-bg-purple-accent { background-color: var(--accent-purple-bg); }
    .theme-bg-green-accent { background-color: var(--accent-green-bg); }
    .theme-bg-red-accent { background-color: var(--accent-red-bg); }

    /* Borders */
    .theme-border { border-color: var(--border-primary); }
    .theme-border-primary { border-color: var(--border-primary); }
    .theme-border-secondary { border-color: var(--border-secondary); }
    .theme-border-input { border-color: var(--border-input); }
    .theme-border-modal { border-color: var(--modal-border); }

    /* Dividers */
    .theme-divide { border-color: var(--border-secondary); }

    /* Placeholders */
    .theme-placeholder::placeholder { color: var(--text-muted); }

    /* Gradients */
    .theme-gradient-app {
      background: linear-gradient(to bottom right, var(--gradient-app-from), var(--gradient-app-via), var(--gradient-app-to));
    }
    .theme-gradient-card-50 {
      background: linear-gradient(to bottom right, var(--bg-primary-50), var(--bg-app-50));
    }

    /* Selection */
    .theme-selection::selection {
      background-color: var(--selection-bg);
      color: var(--selection-text);
    }

    /* Shadows */
    .theme-shadow {
      box-shadow: 0 25px 50px -12px var(--shadow-color);
    }

    /* Combined utility classes for common patterns */
    .theme-modal-overlay {
      background-color: var(--overlay-bg);
    }

    .theme-modal-container {
      background-color: var(--modal-bg);
      border-color: var(--modal-border);
    }

    .theme-input {
      background-color: var(--bg-input);
      border-color: var(--border-input);
      color: var(--text-primary);
    }
    .theme-input::placeholder {
      color: var(--text-muted);
    }

    .theme-card {
      background-color: var(--bg-card);
      border-color: var(--border-primary);
    }

    /* Hover utilities using CSS variables */
    .theme-hover-bg:hover:not(:disabled) {
      background-color: var(--bg-hover) !important;
    }

    .theme-hover-border:hover {
      border-color: var(--border-primary) !important;
    }

    /* Theme-aware button base (for slate buttons) */
    .theme-btn-secondary {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-primary);
    }
    .theme-btn-secondary:hover:not(:disabled) {
      background-color: var(--bg-tertiary) !important;
    }

    /* Theme-aware tabs */
    .theme-tab {
      background-color: var(--bg-card);
      color: var(--text-tertiary);
      border-color: var(--border-secondary);
    }
    .theme-tab-active {
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    /* Info box base styles (dark theme default) */
    .theme-info-box {
      background-color: rgba(30, 58, 138, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 0.5rem;
      padding: 0.75rem;
    }
    .theme-warning-box {
      background-color: rgba(120, 53, 15, 0.2);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 0.5rem;
      padding: 0.75rem;
    }
    .theme-error-box {
      background-color: rgba(127, 29, 29, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 0.5rem;
      padding: 0.75rem;
    }
    .theme-success-box {
      background-color: rgba(20, 83, 45, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 0.5rem;
      padding: 0.75rem;
    }

    /* Info box variants for light theme */
    [data-theme="light"] .theme-info-box {
      background-color: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
    }
    [data-theme="light"] .theme-warning-box {
      background-color: rgba(245, 158, 11, 0.1);
      border-color: rgba(245, 158, 11, 0.3);
    }
    [data-theme="light"] .theme-error-box {
      background-color: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
    }
    [data-theme="light"] .theme-success-box {
      background-color: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.3);
    }

    /* v1.22.02: Badge variants for status tags - dark theme default */
    .theme-badge-success {
      background-color: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }
    .theme-badge-error {
      background-color: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    .theme-badge-purple {
      background-color: rgba(168, 85, 247, 0.2);
      color: #a855f7;
    }
    .theme-badge-blue {
      background-color: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    /* Light theme badge adjustments */
    [data-theme="light"] .theme-badge-success {
      background-color: rgba(22, 163, 74, 0.15);
      color: #15803d;
    }
    [data-theme="light"] .theme-badge-error {
      background-color: rgba(220, 38, 38, 0.15);
      color: #b91c1c;
    }
    [data-theme="light"] .theme-badge-purple {
      background-color: rgba(147, 51, 234, 0.15);
      color: #7c3aed;
    }
    [data-theme="light"] .theme-badge-blue {
      background-color: rgba(37, 99, 235, 0.15);
      color: #1d4ed8;
    }

    /* Toast notification styles - dark theme default */
    .theme-toast-success {
      background-color: rgba(20, 83, 45, 0.95);
      border-color: rgba(34, 197, 94, 0.5);
      color: white;
    }
    .theme-toast-error {
      background-color: rgba(127, 29, 29, 0.95);
      border-color: rgba(239, 68, 68, 0.5);
      color: white;
    }
    .theme-toast-info {
      background-color: rgba(30, 58, 138, 0.95);
      border-color: rgba(59, 130, 246, 0.5);
      color: white;
    }
    .theme-toast-warning {
      background-color: rgba(120, 53, 15, 0.95);
      border-color: rgba(245, 158, 11, 0.5);
      color: white;
    }
    .theme-autosave {
      background-color: rgba(22, 101, 52, 0.95);
      border-color: rgba(34, 197, 94, 0.3);
      color: white;
    }

    /* Toast notification styles - light theme */
    [data-theme="light"] .theme-toast-success {
      background-color: rgba(34, 197, 94, 0.95);
      border-color: rgba(22, 101, 52, 0.5);
      color: white;
    }
    [data-theme="light"] .theme-toast-error {
      background-color: rgba(239, 68, 68, 0.95);
      border-color: rgba(185, 28, 28, 0.5);
      color: white;
    }
    [data-theme="light"] .theme-toast-info {
      background-color: rgba(59, 130, 246, 0.95);
      border-color: rgba(30, 64, 175, 0.5);
      color: white;
    }
    [data-theme="light"] .theme-toast-warning {
      background-color: rgba(254, 243, 199, 0.98);
      border-color: rgba(245, 158, 11, 0.5);
      color: #78350f;
    }
    [data-theme="light"] .theme-autosave {
      background-color: rgba(34, 197, 94, 0.95);
      border-color: rgba(22, 101, 52, 0.3);
      color: white;
    }

    /* v1.9.20: Fullscreen Editor - v1.9.31: SEM padding para eliminar gap */
    .editor-fullscreen {
      position: fixed !important;
      inset: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 9999 !important;
      background: var(--bg-primary) !important;
      padding: 0.5rem !important;
      margin: 0 !important;
      display: flex !important;
      flex-direction: column !important;
      overflow: hidden !important;
      box-sizing: border-box !important;
    }
    /* v1.9.31: Garantir altura total do fullscreen - NÃƒO afeta split-divider */
    .editor-fullscreen > .split-editor-pane,
    .editor-fullscreen > div:first-child:not(.split-divider) {
      flex: 1 1 0% !important;
      min-height: 0 !important;
      display: flex !important;
      flex-direction: column !important;
      margin: 0 !important;
    }
    /* v1.9.31: Sem gap no inÃ­cio */
    .editor-fullscreen > div:first-child > *:first-child {
      margin-top: 0 !important;
    }
    /* v1.9.32: Removido override de .split-divider - a regra original Ã© suficiente */
    /* v1.9.27: CSS simplificado para fullscreen (Quill recriado via key) */
    /* v1.9.32: CSS LIMPO - removido > * que afetava toolbar */
    .fullscreen-editor-wrapper {
      flex: 1 1 0% !important;
      display: flex !important;
      flex-direction: column !important;
      min-height: 0 !important;
      max-height: none !important;
      height: 100% !important;
      overflow: hidden !important;
    }
    /* v1.9.32: Regra especÃ­fica para ql-container (nÃ£o usa > * wildcard) */
    .fullscreen-editor-wrapper .ql-container {
      flex: 1 1 0% !important;
      min-height: 0 !important;
      overflow: hidden !important;
    }
    .fullscreen-editor-wrapper .ql-editor {
      height: 100% !important;
      max-height: 100% !important;
      overflow-y: auto !important;
    }

    /* v1.9.28/v1.9.31: ForÃ§ar altura 100% no QuillEditorBase em fullscreen */
    .fullscreen-quill-fill {
      flex: 1 1 0% !important;
      display: flex !important;
      flex-direction: column !important;
      min-height: 0 !important;
      max-height: 100% !important;
      height: 100% !important;
      overflow: hidden !important;
    }
    /* v1.9.32: Toolbar NÃƒO expande - usa flex shorthand */
    .fullscreen-quill-fill .ql-toolbar {
      flex: 0 0 auto !important;
    }
    .fullscreen-quill-fill .ql-container {
      flex: 1 1 0% !important;
      min-height: 0 !important;
      max-height: 100% !important;
      height: 100% !important;
      overflow: hidden !important;
    }
    .fullscreen-quill-fill .ql-editor {
      height: 100% !important;
      overflow-y: auto !important;
    }

    /* v1.10.13: Quick Edit no ModelPreviewModal - forÃ§a scroll interno no editor */
    .quick-edit-wrapper {
      display: flex !important;
      flex-direction: column !important;
    }
    .quick-edit-wrapper .ql-toolbar {
      flex: 0 0 auto !important;
    }
    .quick-edit-wrapper .ql-container {
      flex: 1 1 0% !important;
      display: flex !important;
      flex-direction: column !important;
      min-height: 0 !important;
      overflow: hidden !important;
    }
    .quick-edit-wrapper .ql-editor {
      flex: 1 1 0% !important;
      overflow-y: auto !important;
      min-height: 0 !important;
    }

    /* v1.9.22: Esconder tooltip do Quill (link removido) */
    .ql-tooltip {
      display: none !important;
    }

    /* v1.9.21: Split Window */
    .editor-fullscreen-split {
      display: flex !important;
      flex-direction: row !important;
    }
    .split-editor-pane {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }
    /* v1.9.34: Permitir width controlar tamanho em split mode (override flex: 1) */
    .editor-fullscreen.editor-fullscreen-split > .split-editor-pane {
      flex: none !important;
    }
    /* v1.9.33: Garantir interatividade do divider */
    .split-divider {
      width: 8px;
      background: var(--bg-secondary);
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background-color 0.2s;
      z-index: 10;
      position: relative;
      pointer-events: auto !important;
      user-select: none;
    }
    .split-divider:hover {
      background: var(--bg-tertiary);
    }
    .split-divider-handle {
      color: var(--text-muted);
      opacity: 0.5;
    }
    .split-divider:hover .split-divider-handle {
      opacity: 1;
    }
    .model-search-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--bg-primary);
      border-left: 1px solid var(--border-primary);
    }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  `}</style>
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ›¡ï¸ SEÃ‡ÃƒO 9: ERROR BOUNDARY & EXPORT
// Tratamento de erros com fallback, wrapper SentencifyAI, export default
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸ›¡ï¸ ERROR BOUNDARY (v1.8.5) - Previne tela branca em erros
class ErrorBoundary extends React.Component<ErrorBoundaryProps, ErrorBoundaryState> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = {
      hasError: false,
      error: null,
      errorInfo: null
    };
  }

  static getDerivedStateFromError(error: Error) {
    return { hasError: true };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {

    this.setState({ error, errorInfo });

    // Salvar log de erro
    try {
      const errorLog = {
        timestamp: new Date().toISOString(),
        error: error.toString(),
        stack: error.stack,
        componentStack: errorInfo.componentStack,
        userAgent: navigator.userAgent
      };
      localStorage.setItem('sentencify-last-error', JSON.stringify(errorLog));
    } catch (e) {
    }
  }

  exportEmergencyData = () => {
    try {
      const session = localStorage.getItem('sentencifySession');
      const aiSettings = localStorage.getItem('sentencify-ai-settings');
      const models = localStorage.getItem('sentencify-models');

      const emergencyData = {
        exportDate: new Date().toISOString(),
        session: session ? JSON.parse(session) : null,
        aiSettings: aiSettings ? JSON.parse(aiSettings) : null,
        models: models ? JSON.parse(models) : null,
        error: {
          message: this.state.error?.toString(),
          stack: this.state.error?.stack,
          componentStack: this.state.errorInfo?.componentStack
        }
      };

      const blob = new Blob([JSON.stringify(emergencyData, null, 2)], {
        type: 'application/json'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sentencify-emergency-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert('âœ… Dados exportados! Verifique seus downloads.');
    } catch (e) {
      alert('âŒ Erro ao exportar: ' + (e as Error).message);
    }
  };

  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen bg-gray-900 text-white p-8 flex items-center justify-center">
          <div className="max-w-2xl w-full bg-gray-800 rounded-lg p-6 shadow-2xl border border-red-500/30">

            {/* Header */}
            <div className="flex items-center gap-3 mb-4">
              <AlertCircle className="w-10 h-10 text-red-400" />
              <div>
                <h1 className="text-2xl font-bold text-red-400">Erro na AplicaÃ§Ã£o</h1>
                <p className="text-gray-400 text-sm">Algo inesperado aconteceu</p>
              </div>
            </div>

            {/* Mensagem */}
            <div className="bg-gray-700/50 rounded p-4 mb-4 border border-gray-600">
              <p className="theme-text-secondary mb-2">
                <strong className="text-green-400">Boa notÃ­cia:</strong> Seus dados estÃ£o seguros.
              </p>
              <p className="theme-text-muted text-sm">
                Todas suas informaÃ§Ãµes foram salvas automaticamente no navegador.
              </p>
            </div>

            {/* BotÃµes */}
            <div className="flex gap-3 mb-4">
              <button
                onClick={() => window.location.reload()}
                className="flex-1 bg-blue-600 hover:bg-blue-500 text-white px-4 py-3 rounded font-semibold flex items-center justify-center gap-2 transition-colors"
              >
                <RefreshCw className="w-4 h-4" />
                Recarregar
              </button>

              <button
                onClick={this.exportEmergencyData}
                className="flex-1 bg-green-600 hover:bg-green-500 text-white px-4 py-3 rounded font-semibold flex items-center justify-center gap-2 transition-colors"
              >
                <Download className="w-4 h-4" />
                Exportar Backup
              </button>
            </div>

            {/* InstruÃ§Ãµes */}
            <div className="theme-info-box mb-4">
              <h3 className="font-semibold theme-text-blue mb-1 flex items-center gap-2 text-sm">
                <Info className="w-4 h-4" />
                O que fazer:
              </h3>
              <ol className="theme-text-muted text-sm ml-5 list-decimal space-y-1">
                <li>Clique em "Recarregar"</li>
                <li>Se persistir, exporte o backup</li>
                <li>Recarregue o navegador (F5)</li>
              </ol>
            </div>

            {/* Stack trace */}
            <details className="bg-gray-900/50 rounded border border-gray-700">
              <summary className="cursor-pointer p-3 hover:bg-gray-700/30 flex items-center gap-2 font-semibold text-sm">
                <Code className="w-4 h-4 text-yellow-400" />
                Detalhes TÃ©cnicos
              </summary>
              <div className="p-3 border-t border-gray-700">
                <pre className="text-xs theme-text-red bg-gray-950 p-2 rounded overflow-auto max-h-48">
                  {this.state.error?.toString()}
                  {this.state.error?.stack && '\n\n' + this.state.error.stack}
                  {this.state.errorInfo?.componentStack && '\n\nComponent Stack:' + this.state.errorInfo.componentStack}
                </pre>
              </div>
            </details>

            {/* Footer */}
            <div className="mt-4 text-center text-gray-500 text-xs">
              <p>SentencifyAI v{APP_VERSION} - <span className="text-amber-500">PROTÃ“TIPO</span></p>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

// ğŸ“¤ EXPORT
// v1.34.4: Cloud Sync + Admin Panel
const SentencifyAI = () => {
  // v1.34.4: Rota /admin abre painel de administraÃ§Ã£o
  if (window.location.pathname === '/admin') {
    return <AdminPanel />;
  }

  // v1.35.0: Rota /share/:token abre pÃ¡gina de aceite de compartilhamento
  const shareMatch = window.location.pathname.match(/^\/share\/([a-f0-9]+)$/i);

  // v1.34.1: Estado para modelos recebidos do servidor (para merge)
  const [receivedModels, setReceivedModels] = React.useState<Model[] | null>(null);
  // v1.35.24: Lista de bibliotecas compartilhadas ativas (para filtrar modelos de owners revogados)
  const [activeSharedLibraries, setActiveSharedLibraries] = React.useState<Array<{ ownerId: string; ownerEmail: string }> | null>(null);

  // v1.35.1: Memoizar callbacks para evitar re-criaÃ§Ã£o de pull/sync a cada render
  // v1.35.24: Receber sharedLibraries junto com models
  const handleModelsReceived = React.useCallback((models: Model[], sharedLibraries: Array<{ ownerId: string; ownerEmail: string }>) => {
    setReceivedModels(models);
    setActiveSharedLibraries(sharedLibraries || []);
  }, []);
  const clearReceivedModels = React.useCallback(() => {
    setReceivedModels(null);
    setActiveSharedLibraries(null);
  }, []);

  const cloudSync = useCloudSync({
    onModelsReceived: handleModelsReceived
  });

  // Fallback para auth legada durante transiÃ§Ã£o
  const legacyAuth = useAuth();

  // Mostrar loading enquanto verifica auth
  if (cloudSync.authLoading || legacyAuth.isLoading) {
    return (
      <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center gap-6">
        {/* Spinner Neon + Ripple - v1.33.50 */}
        <div className="spinner-neon-ripple">
          <div className="ripple"></div>
          <div className="ripple"></div>
          <div className="ripple"></div>
          <div className="core">
            <div className="outer"></div>
            <div className="inner"></div>
          </div>
        </div>
        <span className="text-slate-400 animate-pulse">Carregando...</span>
      </div>
    );
  }

  // v1.35.0: Se estiver em rota de compartilhamento
  if (shareMatch) {
    const shareToken = shareMatch[1];

    // Se nÃ£o autenticado, mostrar login primeiro (apÃ³s login volta para a mesma URL)
    if (!cloudSync.isAuthenticated) {
      return (
        <div className="min-h-screen bg-slate-900">
          <LoginMagicModal
            isOpen={true}
            onClose={() => {}}
            onRequestLink={cloudSync.requestMagicLink}
            onVerify={cloudSync.verifyToken}
            devLink={cloudSync.devLink ?? undefined}
          />
        </div>
      );
    }

    // UsuÃ¡rio autenticado, mostrar pÃ¡gina de aceite
    return <AcceptSharePage token={shareToken} />;
  }

  // v1.34.0: Mostrar modal de login Magic Link se nÃ£o autenticado
  if (!cloudSync.isAuthenticated) {
    return (
      <div className="min-h-screen bg-slate-900">
        <LoginMagicModal
          isOpen={true}
          onClose={() => {}} // Modal nÃ£o pode ser fechado sem autenticar
          onRequestLink={cloudSync.requestMagicLink}
          onVerify={cloudSync.verifyToken}
          devLink={cloudSync.devLink ?? undefined}
        />
      </div>
    );
  }

  // App normal com ErrorBoundary
  return (
    <ErrorBoundary>
      <LegalDecisionEditor
        onLogout={cloudSync.logout}
        cloudSync={cloudSync}
        receivedModels={receivedModels}
        activeSharedLibraries={activeSharedLibraries}
        clearReceivedModels={clearReceivedModels}
      />
    </ErrorBoundary>
  );
};

// v1.35.40: Wrapper com GoogleOAuthProvider para integraÃ§Ã£o com Google Drive
const SentencifyAIWithGoogleDrive = () => (
  <GoogleOAuthProvider clientId={GOOGLE_CLIENT_ID}>
    <SentencifyAI />
  </GoogleOAuthProvider>
);

export default SentencifyAIWithGoogleDrive;
